<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hyperv › hyperv_net.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hyperv_net.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011, Microsoft Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Haiyang Zhang &lt;haiyangz@microsoft.com&gt;</span>
<span class="cm"> *   Hank Janssen  &lt;hjanssen@microsoft.com&gt;</span>
<span class="cm"> *   K. Y. Srinivasan &lt;kys@microsoft.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _HYPERV_NET_H</span>
<span class="cp">#define _HYPERV_NET_H</span>

<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/hyperv.h&gt;</span>
<span class="cp">#include &lt;linux/rndis.h&gt;</span>

<span class="cm">/* Fwd declaration */</span>
<span class="k">struct</span> <span class="n">hv_netvsc_packet</span><span class="p">;</span>

<span class="cm">/* Represent the xfer page packet which contains 1 or more netvsc packet */</span>
<span class="k">struct</span> <span class="n">xferpage_packet</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_ent</span><span class="p">;</span>

	<span class="cm">/* # of netvsc packets this xfer packet contains */</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Represent netvsc packet which contains 1 RNDIS and 1 ethernet frame</span>
<span class="cm"> * within the RNDIS</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="p">{</span>
	<span class="cm">/* Bookkeeping stuff */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_ent</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_data_pkt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tci</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Valid only for receives when we break a xfer page packet</span>
<span class="cm">	 * into multiple netvsc packets</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">xferpage_packet</span> <span class="o">*</span><span class="n">xfer_page_pkt</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">recv_completion_tid</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">recv_completion_ctx</span><span class="p">;</span>
			<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">recv_completion</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
		<span class="p">}</span> <span class="n">recv</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">send_completion_tid</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">send_completion_ctx</span><span class="p">;</span>
			<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">send_completion</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
		<span class="p">}</span> <span class="n">send</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">completion</span><span class="p">;</span>

	<span class="cm">/* This points to the memory after page_buf */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">extension</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">total_data_buflen</span><span class="p">;</span>
	<span class="cm">/* Points to the send/receive buffer where the ethernet frame is */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">page_buf_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hv_page_buffer</span> <span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">netvsc_device_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mac_adr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">link_state</span><span class="p">;</span>	<span class="cm">/* 0 - link up, 1 - link down */</span>
	<span class="kt">int</span>  <span class="n">ring_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rndis_device_state</span> <span class="p">{</span>
	<span class="n">RNDIS_DEV_UNINITIALIZED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RNDIS_DEV_INITIALIZING</span><span class="p">,</span>
	<span class="n">RNDIS_DEV_INITIALIZED</span><span class="p">,</span>
	<span class="n">RNDIS_DEV_DATAINITIALIZED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rndis_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">rndis_device_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link_state</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">new_req_id</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">request_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">req_list</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hw_mac_adr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/* Interface */</span>
<span class="kt">int</span> <span class="n">netvsc_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">additional_info</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">netvsc_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">netvsc_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">netvsc_linkstatus_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">device_obj</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">netvsc_recv_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">device_obj</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rndis_filter_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rndis_filter_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rndis_filter_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">additional_info</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rndis_filter_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rndis_filter_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>



<span class="kt">int</span> <span class="n">rndis_filter_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">rndis_filter_set_packet_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_filter</span><span class="p">);</span>


<span class="cp">#define NVSP_INVALID_PROTOCOL_VERSION	((u32)0xFFFFFFFF)</span>

<span class="cp">#define NVSP_PROTOCOL_VERSION_1		2</span>
<span class="cp">#define NVSP_PROTOCOL_VERSION_2		0x30002</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NVSP_MSG_TYPE_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

	<span class="cm">/* Init Messages */</span>
	<span class="n">NVSP_MSG_TYPE_INIT</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">NVSP_MSG_TYPE_INIT_COMPLETE</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

	<span class="n">NVSP_VERSION_MSG_START</span>			<span class="o">=</span> <span class="mi">100</span><span class="p">,</span>

	<span class="cm">/* Version 1 Messages */</span>
	<span class="n">NVSP_MSG1_TYPE_SEND_NDIS_VER</span>		<span class="o">=</span> <span class="n">NVSP_VERSION_MSG_START</span><span class="p">,</span>

	<span class="n">NVSP_MSG1_TYPE_SEND_RECV_BUF</span><span class="p">,</span>
	<span class="n">NVSP_MSG1_TYPE_SEND_RECV_BUF_COMPLETE</span><span class="p">,</span>
	<span class="n">NVSP_MSG1_TYPE_REVOKE_RECV_BUF</span><span class="p">,</span>

	<span class="n">NVSP_MSG1_TYPE_SEND_SEND_BUF</span><span class="p">,</span>
	<span class="n">NVSP_MSG1_TYPE_SEND_SEND_BUF_COMPLETE</span><span class="p">,</span>
	<span class="n">NVSP_MSG1_TYPE_REVOKE_SEND_BUF</span><span class="p">,</span>

	<span class="n">NVSP_MSG1_TYPE_SEND_RNDIS_PKT</span><span class="p">,</span>
	<span class="n">NVSP_MSG1_TYPE_SEND_RNDIS_PKT_COMPLETE</span><span class="p">,</span>

	<span class="cm">/* Version 2 messages */</span>
	<span class="n">NVSP_MSG2_TYPE_SEND_CHIMNEY_DELEGATED_BUF</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_SEND_CHIMNEY_DELEGATED_BUF_COMP</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_REVOKE_CHIMNEY_DELEGATED_BUF</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_RESUME_CHIMNEY_RX_INDICATION</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_TERMINATE_CHIMNEY</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_TERMINATE_CHIMNEY_COMP</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_INDICATE_CHIMNEY_EVENT</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_SEND_CHIMNEY_PKT</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_SEND_CHIMNEY_PKT_COMP</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_POST_CHIMNEY_RECV_REQ</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_POST_CHIMNEY_RECV_REQ_COMP</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_ALLOC_RXBUF</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_ALLOC_RXBUF_COMP</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_FREE_RXBUF</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_SEND_VMQ_RNDIS_PKT</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_SEND_VMQ_RNDIS_PKT_COMP</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_SEND_NDIS_CONFIG</span><span class="p">,</span>

	<span class="n">NVSP_MSG2_TYPE_ALLOC_CHIMNEY_HANDLE</span><span class="p">,</span>
	<span class="n">NVSP_MSG2_TYPE_ALLOC_CHIMNEY_HANDLE_COMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NVSP_STAT_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">NVSP_STAT_SUCCESS</span><span class="p">,</span>
	<span class="n">NVSP_STAT_FAIL</span><span class="p">,</span>
	<span class="n">NVSP_STAT_PROTOCOL_TOO_NEW</span><span class="p">,</span>
	<span class="n">NVSP_STAT_PROTOCOL_TOO_OLD</span><span class="p">,</span>
	<span class="n">NVSP_STAT_INVALID_RNDIS_PKT</span><span class="p">,</span>
	<span class="n">NVSP_STAT_BUSY</span><span class="p">,</span>
	<span class="n">NVSP_STAT_PROTOCOL_UNSUPPORTED</span><span class="p">,</span>
	<span class="n">NVSP_STAT_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nvsp_message_header</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Init Messages */</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSC to initialize the channel after the channels</span>
<span class="cm"> * has been opened. This message should never include anything other then</span>
<span class="cm"> * versioning (i.e. this message will be the same for ever).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_message_init</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">min_protocol_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_protocol_ver</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSP to complete the initialization of the</span>
<span class="cm"> * channel. This message should never include anything other then versioning</span>
<span class="cm"> * (i.e. this message will be the same for ever).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_message_init_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">negotiated_protocol_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_mdl_chain_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">union</span> <span class="n">nvsp_message_init_uber</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvsp_message_init</span> <span class="n">init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_message_init_complete</span> <span class="n">init_complete</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Version 1 Messages */</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSC to send the NDIS version to the VSP. The VSP</span>
<span class="cm"> * can use this information when handling OIDs sent by the VSC.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_ndis_version</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ndis_major_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ndis_minor_ver</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSC to send a receive buffer to the VSP. The VSP</span>
<span class="cm"> * can then use the receive buffer to send data to the VSC.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_receive_buffer</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpadl_handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nvsp_1_receive_buffer_section</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sub_alloc_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_sub_allocs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">end_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSP to acknowledge a receive buffer send by the</span>
<span class="cm"> * VSC. This message must be sent by the VSP before the VSP uses the receive</span>
<span class="cm"> * buffer.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_receive_buffer_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_sections</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The receive buffer is split into two parts, a large suballocation</span>
<span class="cm">	 * section and a small suballocation section. These sections are then</span>
<span class="cm">	 * suballocated by a certain size.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * For example, the following break up of the receive buffer has 6</span>
<span class="cm">	 * large suballocations and 10 small suballocations.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * |            Large Section          |  |   Small Section   |</span>
<span class="cm">	 * ------------------------------------------------------------</span>
<span class="cm">	 * |     |     |     |     |     |     |  | | | | | | | | | | |</span>
<span class="cm">	 * |                                      |</span>
<span class="cm">	 *  LargeOffset                            SmallOffset</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">nvsp_1_receive_buffer_section</span> <span class="n">sections</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is sent by the VSC to revoke the receive buffer.  After the VSP</span>
<span class="cm"> * completes this transaction, the vsp should never use the receive buffer</span>
<span class="cm"> * again.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_revoke_receive_buffer</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSC to send a send buffer to the VSP. The VSC</span>
<span class="cm"> * can then use the send buffer to send data to the VSP.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_send_buffer</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpadl_handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by the VSP to acknowledge a send buffer sent by the</span>
<span class="cm"> * VSC. This message must be sent by the VSP before the VSP uses the sent</span>
<span class="cm"> * buffer.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_send_buffer_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The VSC gets to choose the size of the send buffer and the VSP gets</span>
<span class="cm">	 * to choose the sections size of the buffer.  This was done to enable</span>
<span class="cm">	 * dynamic reconfigurations when the cost of GPA-direct buffers</span>
<span class="cm">	 * decreases.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">section_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is sent by the VSC to revoke the send buffer.  After the VSP</span>
<span class="cm"> * completes this transaction, the vsp should never use the send buffer again.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_revoke_send_buffer</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by both the VSP and the VSC to send a RNDIS message to</span>
<span class="cm"> * the opposite channel endpoint.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_rndis_packet</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This field is specified by RNIDS. They assume there&#39;s two different</span>
<span class="cm">	 * channels of communication. However, the Network VSP only has one.</span>
<span class="cm">	 * Therefore, the channel travels with the RNDIS packet.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">channel_type</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This field is used to send part or all of the data through a send</span>
<span class="cm">	 * buffer. This values specifies an index into the send buffer. If the</span>
<span class="cm">	 * index is 0xFFFFFFFF, then the send buffer is not being used and all</span>
<span class="cm">	 * of the data was sent through other VMBus mechanisms.</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">send_buf_section_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">send_buf_section_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This message is used by both the VSP and the VSC to complete a RNDIS message</span>
<span class="cm"> * to the opposite channel endpoint. At this point, the initiator of this</span>
<span class="cm"> * message cannot use any resources associated with the original RNDIS packet.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_1_message_send_rndis_packet_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">nvsp_1_message_uber</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvsp_1_message_send_ndis_version</span> <span class="n">send_ndis_ver</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">nvsp_1_message_send_receive_buffer</span> <span class="n">send_recv_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_1_message_send_receive_buffer_complete</span>
						<span class="n">send_recv_buf_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_1_message_revoke_receive_buffer</span> <span class="n">revoke_recv_buf</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">nvsp_1_message_send_send_buffer</span> <span class="n">send_send_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_1_message_send_send_buffer_complete</span> <span class="n">send_send_buf_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_1_message_revoke_send_buffer</span> <span class="n">revoke_send_buf</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">nvsp_1_message_send_rndis_packet</span> <span class="n">send_rndis_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_1_message_send_rndis_packet_complete</span>
						<span class="n">send_rndis_pkt_complete</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Network VSP protocol version 2 messages:</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">nvsp_2_vsc_capability</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">vmq</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">chimney</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">sriov</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">ieee8021q</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">correlation_id</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nvsp_2_send_ndis_config</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_2_vsc_capability</span> <span class="n">capability</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Allocate receive buffer */</span>
<span class="k">struct</span> <span class="n">nvsp_2_alloc_rxbuf</span> <span class="p">{</span>
	<span class="cm">/* Allocation ID to match the allocation request and response */</span>
	<span class="n">u32</span> <span class="n">alloc_id</span><span class="p">;</span>

	<span class="cm">/* Length of the VM shared memory receive buffer that needs to</span>
<span class="cm">	 * be allocated</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Allocate receive buffer complete */</span>
<span class="k">struct</span> <span class="n">nvsp_2_alloc_rxbuf_comp</span> <span class="p">{</span>
	<span class="cm">/* The NDIS_STATUS code for buffer allocation */</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">alloc_id</span><span class="p">;</span>

	<span class="cm">/* GPADL handle for the allocated receive buffer */</span>
	<span class="n">u32</span> <span class="n">gpadl_handle</span><span class="p">;</span>

	<span class="cm">/* Receive buffer ID */</span>
	<span class="n">u64</span> <span class="n">recv_buf_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nvsp_2_free_rxbuf</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">recv_buf_id</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">union</span> <span class="n">nvsp_2_message_uber</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvsp_2_send_ndis_config</span> <span class="n">send_ndis_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_2_alloc_rxbuf</span> <span class="n">alloc_rxbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_2_alloc_rxbuf_comp</span> <span class="n">alloc_rxbuf_comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_2_free_rxbuf</span> <span class="n">free_rxbuf</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">union</span> <span class="n">nvsp_all_messages</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">nvsp_message_init_uber</span> <span class="n">init_msg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nvsp_1_message_uber</span> <span class="n">v1_msg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nvsp_2_message_uber</span> <span class="n">v2_msg</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* ALL Messages */</span>
<span class="k">struct</span> <span class="n">nvsp_message</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nvsp_message_header</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">nvsp_all_messages</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>


<span class="cp">#define NETVSC_MTU 65536</span>

<span class="cp">#define NETVSC_RECEIVE_BUFFER_SIZE		(1024*1024*2)	</span><span class="cm">/* 2MB */</span><span class="cp"></span>

<span class="cp">#define NETVSC_RECEIVE_BUFFER_ID		0xcafe</span>

<span class="cp">#define NETVSC_RECEIVE_SG_COUNT			1</span>

<span class="cm">/* Preallocated receive packets */</span>
<span class="cp">#define NETVSC_RECEIVE_PACKETLIST_COUNT		256</span>

<span class="cp">#define NETVSC_PACKET_SIZE                      2048</span>

<span class="cm">/* Per netvsc channel-specific */</span>
<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">nvsp_version</span><span class="p">;</span>

	<span class="n">atomic_t</span> <span class="n">num_outstanding_sends</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait_drain</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">start_remove</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">destroy</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * List of free preallocated hv_netvsc_packet to represent receive</span>
<span class="cm">	 * packet</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">recv_pkt_list</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">recv_pkt_list_lock</span><span class="p">;</span>

	<span class="cm">/* Receive buffer allocated by us but manages by NetVSP */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">recv_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recv_buf_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recv_buf_gpadl_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">recv_section_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_1_receive_buffer_section</span> <span class="o">*</span><span class="n">recv_section</span><span class="p">;</span>

	<span class="cm">/* Used for NetVSP initialization protocol */</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">channel_init_wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nvsp_message</span> <span class="n">channel_init_pkt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">nvsp_message</span> <span class="n">revoke_packet</span><span class="p">;</span>
	<span class="cm">/* unsigned char HwMacAddr[HW_MACADDR_LEN]; */</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="cm">/* Holds rndis device info */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">extension</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisInitialize message */</span>
<span class="k">struct</span> <span class="n">rndis_initialize_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">major_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minor_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_xfer_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to NdisInitialize */</span>
<span class="k">struct</span> <span class="n">rndis_initialize_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">major_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minor_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">medium</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_pkt_per_msg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_xfer_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pkt_alignment_factor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">af_list_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">af_list_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Call manager devices only: Information about an address family */</span>
<span class="cm">/* supported by the device is appended to the response to NdisInitialize. */</span>
<span class="k">struct</span> <span class="n">rndis_co_address_family</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">address_family</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">major_ver</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minor_ver</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisHalt message */</span>
<span class="k">struct</span> <span class="n">rndis_halt_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisQueryRequest message */</span>
<span class="k">struct</span> <span class="n">rndis_query_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buf_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to NdisQueryRequest */</span>
<span class="k">struct</span> <span class="n">rndis_query_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buf_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisSetRequest message */</span>
<span class="k">struct</span> <span class="n">rndis_set_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buf_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to NdisSetRequest */</span>
<span class="k">struct</span> <span class="n">rndis_set_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisReset message */</span>
<span class="k">struct</span> <span class="n">rndis_reset_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to NdisReset */</span>
<span class="k">struct</span> <span class="n">rndis_reset_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addressing_reset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisMIndicateStatus message */</span>
<span class="k">struct</span> <span class="n">rndis_indicate_status</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_buf_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Diagnostic information passed as the status buffer in */</span>
<span class="cm">/* struct rndis_indicate_status messages signifying error conditions. */</span>
<span class="k">struct</span> <span class="n">rndis_diagnostic_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">diag_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* NdisKeepAlive message */</span>
<span class="k">struct</span> <span class="n">rndis_keepalive_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to NdisKeepAlive */</span>
<span class="k">struct</span> <span class="n">rndis_keepalive_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Data message. All Offset fields contain byte offsets from the beginning of</span>
<span class="cm"> * struct rndis_packet. All Length fields are in bytes.  VcHandle is set</span>
<span class="cm"> * to 0 for connectionless data, otherwise it contains the VC handle.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rndis_packet</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oob_data_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oob_data_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_oob_data_elements</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">per_pkt_info_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">per_pkt_info_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vc_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Optional Out of Band data associated with a Data message. */</span>
<span class="k">struct</span> <span class="n">rndis_oobd</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class_info_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Packet extension field contents associated with a Data message. */</span>
<span class="k">struct</span> <span class="n">rndis_per_packet_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ppi_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_per_pkt_info_type</span> <span class="p">{</span>
	<span class="n">TCPIP_CHKSUM_PKTINFO</span><span class="p">,</span>
	<span class="n">IPSEC_PKTINFO</span><span class="p">,</span>
	<span class="n">TCP_LARGESEND_PKTINFO</span><span class="p">,</span>
	<span class="n">CLASSIFICATION_HANDLE_PKTINFO</span><span class="p">,</span>
	<span class="n">NDIS_RESERVED</span><span class="p">,</span>
	<span class="n">SG_LIST_PKTINFO</span><span class="p">,</span>
	<span class="n">IEEE_8021Q_INFO</span><span class="p">,</span>
	<span class="n">ORIGINAL_PKTINFO</span><span class="p">,</span>
	<span class="n">PACKET_CANCEL_ID</span><span class="p">,</span>
	<span class="n">ORIGINAL_NET_BUFLIST</span><span class="p">,</span>
	<span class="n">CACHED_NET_BUFLIST</span><span class="p">,</span>
	<span class="n">SHORT_PKT_PADINFO</span><span class="p">,</span>
	<span class="n">MAX_PER_PKT_INFO</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ndis_pkt_8021q_info</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pri</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span> <span class="cm">/* User Priority */</span>
			<span class="n">u32</span> <span class="n">cfi</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Canonical Format ID */</span>
			<span class="n">u32</span> <span class="n">vlanid</span><span class="o">:</span><span class="mi">12</span><span class="p">;</span> <span class="cm">/* VLAN ID */</span>
			<span class="n">u32</span> <span class="n">reserved</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cp">#define NDIS_VLAN_PPI_SIZE (sizeof(struct rndis_per_packet_info) + \</span>
<span class="cp">		sizeof(struct ndis_pkt_8021q_info))</span>

<span class="cm">/* Format of Information buffer passed in a SetRequest for the OID */</span>
<span class="cm">/* OID_GEN_RNDIS_CONFIG_PARAMETER. */</span>
<span class="k">struct</span> <span class="n">rndis_config_parameter_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">parameter_name_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parameter_name_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parameter_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parameter_value_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parameter_value_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Values for ParameterType in struct rndis_config_parameter_info */</span>
<span class="cp">#define RNDIS_CONFIG_PARAM_TYPE_INTEGER     0</span>
<span class="cp">#define RNDIS_CONFIG_PARAM_TYPE_STRING      2</span>

<span class="cm">/* CONDIS Miniport messages for connection oriented devices */</span>
<span class="cm">/* that do not implement a call manager. */</span>

<span class="cm">/* CoNdisMiniportCreateVc message */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_create_vc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ndis_vc_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to CoNdisMiniportCreateVc */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_create_vc_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CoNdisMiniportDeleteVc message */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_delete_vc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to CoNdisMiniportDeleteVc */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_delete_vc_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CoNdisMiniportQueryRequest message */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_query_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">request_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buf_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CoNdisMiniportSetRequest message */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_set_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">request_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">info_buf_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CoNdisIndicateStatus message */</span>
<span class="k">struct</span> <span class="n">rcondis_indicate_status</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ndis_vc_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_buflen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status_buf_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CONDIS Call/VC parameters */</span>
<span class="k">struct</span> <span class="n">rcondis_specific_parameters</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">parameter_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parameter_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parameter_lffset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rcondis_media_parameters</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_specific_parameters</span> <span class="n">media_specific</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rndis_flowspec</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">token_rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">token_bucket_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">peak_bandwidth</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">latency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delay_variation</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">service_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_sdu_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minimum_policed_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rcondis_call_manager_parameters</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_flowspec</span> <span class="n">transmit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_flowspec</span> <span class="n">receive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_specific_parameters</span> <span class="n">call_mgr_specific</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CoNdisMiniportActivateVc message */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_activate_vc_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">media_params_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">media_params_length</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">call_mgr_params_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">call_mgr_params_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to CoNdisMiniportActivateVc */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_activate_vc_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CoNdisMiniportDeactivateVc message */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_deactivate_vc_request</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dev_vc_handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Response to CoNdisMiniportDeactivateVc */</span>
<span class="k">struct</span> <span class="n">rcondis_mp_deactivate_vc_complete</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* union with all of the RNDIS messages */</span>
<span class="k">union</span> <span class="n">rndis_message_container</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_packet</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_initialize_request</span> <span class="n">init_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_halt_request</span> <span class="n">halt_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_query_request</span> <span class="n">query_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_set_request</span> <span class="n">set_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_reset_request</span> <span class="n">reset_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_keepalive_request</span> <span class="n">keep_alive_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_indicate_status</span> <span class="n">indicate_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_initialize_complete</span> <span class="n">init_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_query_complete</span> <span class="n">query_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_set_complete</span> <span class="n">set_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_reset_complete</span> <span class="n">reset_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_keepalive_complete</span> <span class="n">keep_alive_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_create_vc</span> <span class="n">co_miniport_create_vc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_delete_vc</span> <span class="n">co_miniport_delete_vc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_indicate_status</span> <span class="n">co_indicate_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_activate_vc_request</span> <span class="n">co_miniport_activate_vc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_deactivate_vc_request</span> <span class="n">co_miniport_deactivate_vc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_create_vc_complete</span> <span class="n">co_miniport_create_vc_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_delete_vc_complete</span> <span class="n">co_miniport_delete_vc_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_activate_vc_complete</span> <span class="n">co_miniport_activate_vc_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcondis_mp_deactivate_vc_complete</span>
		<span class="n">co_miniport_deactivate_vc_complete</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Remote NDIS message format */</span>
<span class="k">struct</span> <span class="n">rndis_message</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ndis_msg_type</span><span class="p">;</span>

	<span class="cm">/* Total length of this message, from the beginning */</span>
	<span class="cm">/* of the sruct rndis_message, in bytes. */</span>
	<span class="n">u32</span> <span class="n">msg_len</span><span class="p">;</span>

	<span class="cm">/* Actual message */</span>
	<span class="k">union</span> <span class="n">rndis_message_container</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">rndis_filter_packet</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">completion_ctx</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">completion</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_message</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Handy macros */</span>

<span class="cm">/* get the size of an RNDIS message. Pass in the message type, */</span>
<span class="cm">/* struct rndis_set_request, struct rndis_packet for example */</span>
<span class="cp">#define RNDIS_MESSAGE_SIZE(msg)				\</span>
<span class="cp">	(sizeof(msg) + (sizeof(struct rndis_message) -	\</span>
<span class="cp">	 sizeof(union rndis_message_container)))</span>

<span class="cm">/* get pointer to info buffer with message pointer */</span>
<span class="cp">#define MESSAGE_TO_INFO_BUFFER(msg)				\</span>
<span class="cp">	(((unsigned char *)(msg)) + msg-&gt;info_buf_offset)</span>

<span class="cm">/* get pointer to status buffer with message pointer */</span>
<span class="cp">#define MESSAGE_TO_STATUS_BUFFER(msg)			\</span>
<span class="cp">	(((unsigned char *)(msg)) + msg-&gt;status_buf_offset)</span>

<span class="cm">/* get pointer to OOBD buffer with message pointer */</span>
<span class="cp">#define MESSAGE_TO_OOBD_BUFFER(msg)				\</span>
<span class="cp">	(((unsigned char *)(msg)) + msg-&gt;oob_data_offset)</span>

<span class="cm">/* get pointer to data buffer with message pointer */</span>
<span class="cp">#define MESSAGE_TO_DATA_BUFFER(msg)				\</span>
<span class="cp">	(((unsigned char *)(msg)) + msg-&gt;per_pkt_info_offset)</span>

<span class="cm">/* get pointer to contained message from NDIS_MESSAGE pointer */</span>
<span class="cp">#define RNDIS_MESSAGE_PTR_TO_MESSAGE_PTR(rndis_msg)		\</span>
<span class="cp">	((void *) &amp;rndis_msg-&gt;msg)</span>

<span class="cm">/* get pointer to contained message from NDIS_MESSAGE pointer */</span>
<span class="cp">#define RNDIS_MESSAGE_RAW_PTR_TO_MESSAGE_PTR(rndis_msg)	\</span>
<span class="cp">	((void *) rndis_msg)</span>


<span class="cp">#define __struct_bcount(x)</span>



<span class="cp">#define RNDIS_HEADER_SIZE	(sizeof(struct rndis_message) - \</span>
<span class="cp">				 sizeof(union rndis_message_container))</span>

<span class="cp">#define NDIS_PACKET_TYPE_DIRECTED	0x00000001</span>
<span class="cp">#define NDIS_PACKET_TYPE_MULTICAST	0x00000002</span>
<span class="cp">#define NDIS_PACKET_TYPE_ALL_MULTICAST	0x00000004</span>
<span class="cp">#define NDIS_PACKET_TYPE_BROADCAST	0x00000008</span>
<span class="cp">#define NDIS_PACKET_TYPE_SOURCE_ROUTING	0x00000010</span>
<span class="cp">#define NDIS_PACKET_TYPE_PROMISCUOUS	0x00000020</span>
<span class="cp">#define NDIS_PACKET_TYPE_SMT		0x00000040</span>
<span class="cp">#define NDIS_PACKET_TYPE_ALL_LOCAL	0x00000080</span>
<span class="cp">#define NDIS_PACKET_TYPE_GROUP		0x00000100</span>
<span class="cp">#define NDIS_PACKET_TYPE_ALL_FUNCTIONAL	0x00000200</span>
<span class="cp">#define NDIS_PACKET_TYPE_FUNCTIONAL	0x00000400</span>
<span class="cp">#define NDIS_PACKET_TYPE_MAC_FRAME	0x00000800</span>



<span class="cp">#endif </span><span class="cm">/* _HYPERV_NET_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
