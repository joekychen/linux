<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › s6gmac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s6gmac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Ethernet driver for S6105 on chip network device</span>
<span class="cm"> * (c)2008 emlix GmbH http://www.emlix.com</span>
<span class="cm"> * Authors:	Oskar Schirmer &lt;oskar@scara.com&gt;</span>
<span class="cm"> *		Daniel Gloeckner &lt;dg@emlix.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;variant/hardware.h&gt;</span>
<span class="cp">#include &lt;variant/dmac.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;s6gmac&quot;</span>
<span class="cp">#define DRV_PRMT DRV_NAME &quot;: &quot;</span>


<span class="cm">/* register declarations */</span>

<span class="cp">#define S6_GMAC_MACCONF1	0x000</span>
<span class="cp">#define S6_GMAC_MACCONF1_TXENA		0</span>
<span class="cp">#define S6_GMAC_MACCONF1_SYNCTX		1</span>
<span class="cp">#define S6_GMAC_MACCONF1_RXENA		2</span>
<span class="cp">#define S6_GMAC_MACCONF1_SYNCRX		3</span>
<span class="cp">#define S6_GMAC_MACCONF1_TXFLOWCTRL	4</span>
<span class="cp">#define S6_GMAC_MACCONF1_RXFLOWCTRL	5</span>
<span class="cp">#define S6_GMAC_MACCONF1_LOOPBACK	8</span>
<span class="cp">#define S6_GMAC_MACCONF1_RESTXFUNC	16</span>
<span class="cp">#define S6_GMAC_MACCONF1_RESRXFUNC	17</span>
<span class="cp">#define S6_GMAC_MACCONF1_RESTXMACCTRL	18</span>
<span class="cp">#define S6_GMAC_MACCONF1_RESRXMACCTRL	19</span>
<span class="cp">#define S6_GMAC_MACCONF1_SIMULRES	30</span>
<span class="cp">#define S6_GMAC_MACCONF1_SOFTRES	31</span>
<span class="cp">#define S6_GMAC_MACCONF2	0x004</span>
<span class="cp">#define S6_GMAC_MACCONF2_FULL		0</span>
<span class="cp">#define S6_GMAC_MACCONF2_CRCENA		1</span>
<span class="cp">#define S6_GMAC_MACCONF2_PADCRCENA	2</span>
<span class="cp">#define S6_GMAC_MACCONF2_LENGTHFCHK	4</span>
<span class="cp">#define S6_GMAC_MACCONF2_HUGEFRAMENA	5</span>
<span class="cp">#define S6_GMAC_MACCONF2_IFMODE		8</span>
<span class="cp">#define S6_GMAC_MACCONF2_IFMODE_NIBBLE		1</span>
<span class="cp">#define S6_GMAC_MACCONF2_IFMODE_BYTE		2</span>
<span class="cp">#define S6_GMAC_MACCONF2_IFMODE_MASK		3</span>
<span class="cp">#define S6_GMAC_MACCONF2_PREAMBLELEN	12</span>
<span class="cp">#define S6_GMAC_MACCONF2_PREAMBLELEN_MASK	0x0F</span>
<span class="cp">#define S6_GMAC_MACIPGIFG	0x008</span>
<span class="cp">#define S6_GMAC_MACIPGIFG_B2BINTERPGAP	0</span>
<span class="cp">#define S6_GMAC_MACIPGIFG_B2BINTERPGAP_MASK	0x7F</span>
<span class="cp">#define S6_GMAC_MACIPGIFG_MINIFGENFORCE	8</span>
<span class="cp">#define S6_GMAC_MACIPGIFG_B2BINTERPGAP2	16</span>
<span class="cp">#define S6_GMAC_MACIPGIFG_B2BINTERPGAP1	24</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX	0x00C</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_COLLISWIN	0</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_COLLISWIN_MASK	0x3F</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_RETXMAX	12</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_RETXMAX_MASK	0x0F</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_EXCESSDEF	16</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_NOBACKOFF	17</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_BPNOBCKOF	18</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_ALTBEBENA	19</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_ALTBEBTRN	20</span>
<span class="cp">#define S6_GMAC_MACHALFDUPLEX_ALTBEBTR_MASK	0x0F</span>
<span class="cp">#define S6_GMAC_MACMAXFRAMELEN	0x010</span>
<span class="cp">#define S6_GMAC_MACMIICONF	0x020</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL		0</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV10		0</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV12		1</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV14		2</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV18		3</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV24		4</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV34		5</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV68		6</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_DIV168		7</span>
<span class="cp">#define S6_GMAC_MACMIICONF_CSEL_MASK		7</span>
<span class="cp">#define S6_GMAC_MACMIICONF_PREAMBLESUPR	4</span>
<span class="cp">#define S6_GMAC_MACMIICONF_SCANAUTOINCR	5</span>
<span class="cp">#define S6_GMAC_MACMIICMD	0x024</span>
<span class="cp">#define S6_GMAC_MACMIICMD_READ		0</span>
<span class="cp">#define S6_GMAC_MACMIICMD_SCAN		1</span>
<span class="cp">#define S6_GMAC_MACMIIADDR	0x028</span>
<span class="cp">#define S6_GMAC_MACMIIADDR_REG		0</span>
<span class="cp">#define S6_GMAC_MACMIIADDR_REG_MASK		0x1F</span>
<span class="cp">#define S6_GMAC_MACMIIADDR_PHY		8</span>
<span class="cp">#define S6_GMAC_MACMIIADDR_PHY_MASK		0x1F</span>
<span class="cp">#define S6_GMAC_MACMIICTRL	0x02C</span>
<span class="cp">#define S6_GMAC_MACMIISTAT	0x030</span>
<span class="cp">#define S6_GMAC_MACMIIINDI	0x034</span>
<span class="cp">#define S6_GMAC_MACMIIINDI_BUSY		0</span>
<span class="cp">#define S6_GMAC_MACMIIINDI_SCAN		1</span>
<span class="cp">#define S6_GMAC_MACMIIINDI_INVAL	2</span>
<span class="cp">#define S6_GMAC_MACINTERFSTAT	0x03C</span>
<span class="cp">#define S6_GMAC_MACINTERFSTAT_LINKFAIL	3</span>
<span class="cp">#define S6_GMAC_MACINTERFSTAT_EXCESSDEF	9</span>
<span class="cp">#define S6_GMAC_MACSTATADDR1	0x040</span>
<span class="cp">#define S6_GMAC_MACSTATADDR2	0x044</span>

<span class="cp">#define S6_GMAC_FIFOCONF0	0x048</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_HSTRSTWT	0</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_HSTRSTSR	1</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_HSTRSTFR	2</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_HSTRSTST	3</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_HSTRSTFT	4</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_WTMENREQ	8</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_SRFENREQ	9</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_FRFENREQ	10</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_STFENREQ	11</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_FTFENREQ	12</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_WTMENRPLY	16</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_SRFENRPLY	17</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_FRFENRPLY	18</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_STFENRPLY	19</span>
<span class="cp">#define S6_GMAC_FIFOCONF0_FTFENRPLY	20</span>
<span class="cp">#define S6_GMAC_FIFOCONF1	0x04C</span>
<span class="cp">#define S6_GMAC_FIFOCONF2	0x050</span>
<span class="cp">#define S6_GMAC_FIFOCONF2_CFGLWM	0</span>
<span class="cp">#define S6_GMAC_FIFOCONF2_CFGHWM	16</span>
<span class="cp">#define S6_GMAC_FIFOCONF3	0x054</span>
<span class="cp">#define S6_GMAC_FIFOCONF3_CFGFTTH	0</span>
<span class="cp">#define S6_GMAC_FIFOCONF3_CFGHWMFT	16</span>
<span class="cp">#define S6_GMAC_FIFOCONF4	0x058</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_PREVDROP	0</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_RUNT	1</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_FALSECAR	2</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_CODEERR	3</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_CRCERR	4</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_LENGTHERR	5</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_LENRANGE	6</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_OK		7</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_MULTICAST	8</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_BROADCAST	9</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_DRIBBLE	10</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_CTRLFRAME	11</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_PAUSECTRL	12</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_UNOPCODE	13</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_VLANTAG	14</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_LONGEVENT	15</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_TRUNCATED	16</span>
<span class="cp">#define S6_GMAC_FIFOCONF_RSV_MASK		0x3FFFF</span>
<span class="cp">#define S6_GMAC_FIFOCONF5	0x05C</span>
<span class="cp">#define S6_GMAC_FIFOCONF5_DROPLT64	18</span>
<span class="cp">#define S6_GMAC_FIFOCONF5_CFGBYTM	19</span>
<span class="cp">#define S6_GMAC_FIFOCONF5_RXDROPSIZE	20</span>
<span class="cp">#define S6_GMAC_FIFOCONF5_RXDROPSIZE_MASK	0xF</span>

<span class="cp">#define S6_GMAC_STAT_REGS	0x080</span>
<span class="cp">#define S6_GMAC_STAT_SIZE_MIN		12</span>
<span class="cp">#define S6_GMAC_STATTR64	0x080</span>
<span class="cp">#define S6_GMAC_STATTR64_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTR127	0x084</span>
<span class="cp">#define S6_GMAC_STATTR127_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTR255	0x088</span>
<span class="cp">#define S6_GMAC_STATTR255_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTR511	0x08C</span>
<span class="cp">#define S6_GMAC_STATTR511_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTR1K	0x090</span>
<span class="cp">#define S6_GMAC_STATTR1K_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTRMAX	0x094</span>
<span class="cp">#define S6_GMAC_STATTRMAX_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTRMGV	0x098</span>
<span class="cp">#define S6_GMAC_STATTRMGV_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATRBYT	0x09C</span>
<span class="cp">#define S6_GMAC_STATRBYT_SIZE		24</span>
<span class="cp">#define S6_GMAC_STATRPKT	0x0A0</span>
<span class="cp">#define S6_GMAC_STATRPKT_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATRFCS	0x0A4</span>
<span class="cp">#define S6_GMAC_STATRFCS_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRMCA	0x0A8</span>
<span class="cp">#define S6_GMAC_STATRMCA_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATRBCA	0x0AC</span>
<span class="cp">#define S6_GMAC_STATRBCA_SIZE		22</span>
<span class="cp">#define S6_GMAC_STATRXCF	0x0B0</span>
<span class="cp">#define S6_GMAC_STATRXCF_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATRXPF	0x0B4</span>
<span class="cp">#define S6_GMAC_STATRXPF_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRXUO	0x0B8</span>
<span class="cp">#define S6_GMAC_STATRXUO_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRALN	0x0BC</span>
<span class="cp">#define S6_GMAC_STATRALN_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRFLR	0x0C0</span>
<span class="cp">#define S6_GMAC_STATRFLR_SIZE		16</span>
<span class="cp">#define S6_GMAC_STATRCDE	0x0C4</span>
<span class="cp">#define S6_GMAC_STATRCDE_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRCSE	0x0C8</span>
<span class="cp">#define S6_GMAC_STATRCSE_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRUND	0x0CC</span>
<span class="cp">#define S6_GMAC_STATRUND_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATROVR	0x0D0</span>
<span class="cp">#define S6_GMAC_STATROVR_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRFRG	0x0D4</span>
<span class="cp">#define S6_GMAC_STATRFRG_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRJBR	0x0D8</span>
<span class="cp">#define S6_GMAC_STATRJBR_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATRDRP	0x0DC</span>
<span class="cp">#define S6_GMAC_STATRDRP_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTBYT	0x0E0</span>
<span class="cp">#define S6_GMAC_STATTBYT_SIZE		24</span>
<span class="cp">#define S6_GMAC_STATTPKT	0x0E4</span>
<span class="cp">#define S6_GMAC_STATTPKT_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTMCA	0x0E8</span>
<span class="cp">#define S6_GMAC_STATTMCA_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTBCA	0x0EC</span>
<span class="cp">#define S6_GMAC_STATTBCA_SIZE		18</span>
<span class="cp">#define S6_GMAC_STATTXPF	0x0F0</span>
<span class="cp">#define S6_GMAC_STATTXPF_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTDFR	0x0F4</span>
<span class="cp">#define S6_GMAC_STATTDFR_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTEDF	0x0F8</span>
<span class="cp">#define S6_GMAC_STATTEDF_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTSCL	0x0FC</span>
<span class="cp">#define S6_GMAC_STATTSCL_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTMCL	0x100</span>
<span class="cp">#define S6_GMAC_STATTMCL_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTLCL	0x104</span>
<span class="cp">#define S6_GMAC_STATTLCL_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTXCL	0x108</span>
<span class="cp">#define S6_GMAC_STATTXCL_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTNCL	0x10C</span>
<span class="cp">#define S6_GMAC_STATTNCL_SIZE		13</span>
<span class="cp">#define S6_GMAC_STATTPFH	0x110</span>
<span class="cp">#define S6_GMAC_STATTPFH_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTDRP	0x114</span>
<span class="cp">#define S6_GMAC_STATTDRP_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTJBR	0x118</span>
<span class="cp">#define S6_GMAC_STATTJBR_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTFCS	0x11C</span>
<span class="cp">#define S6_GMAC_STATTFCS_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTXCF	0x120</span>
<span class="cp">#define S6_GMAC_STATTXCF_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTOVR	0x124</span>
<span class="cp">#define S6_GMAC_STATTOVR_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTUND	0x128</span>
<span class="cp">#define S6_GMAC_STATTUND_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATTFRG	0x12C</span>
<span class="cp">#define S6_GMAC_STATTFRG_SIZE		12</span>
<span class="cp">#define S6_GMAC_STATCARRY(n)	(0x130 + 4*(n))</span>
<span class="cp">#define S6_GMAC_STATCARRYMSK(n)	(0x138 + 4*(n))</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RDRP		0</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RJBR		1</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RFRG		2</span>
<span class="cp">#define S6_GMAC_STATCARRY1_ROVR		3</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RUND		4</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RCSE		5</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RCDE		6</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RFLR		7</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RALN		8</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RXUO		9</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RXPF		10</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RXCF		11</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RBCA		12</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RMCA		13</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RFCS		14</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RPKT		15</span>
<span class="cp">#define S6_GMAC_STATCARRY1_RBYT		16</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TRMGV	25</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TRMAX	26</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TR1K		27</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TR511	28</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TR255	29</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TR127	30</span>
<span class="cp">#define S6_GMAC_STATCARRY1_TR64		31</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TDRP		0</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TPFH		1</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TNCL		2</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TXCL		3</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TLCL		4</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TMCL		5</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TSCL		6</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TEDF		7</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TDFR		8</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TXPF		9</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TBCA		10</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TMCA		11</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TPKT		12</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TBYT		13</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TFRG		14</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TUND		15</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TOVR		16</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TXCF		17</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TFCS		18</span>
<span class="cp">#define S6_GMAC_STATCARRY2_TJBR		19</span>

<span class="cp">#define S6_GMAC_HOST_PBLKCTRL	0x140</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_TXENA	0</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_RXENA	1</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_TXSRES	2</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_RXSRES	3</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_TXBSIZ	8</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_RXBSIZ	12</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_SIZ_16		4</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_SIZ_32		5</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_SIZ_64		6</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_SIZ_128		7</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_SIZ_MASK		0xF</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_STATENA	16</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_STATAUTOZ	17</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_STATCLEAR	18</span>
<span class="cp">#define S6_GMAC_HOST_PBLKCTRL_RGMII	19</span>
<span class="cp">#define S6_GMAC_HOST_INTMASK	0x144</span>
<span class="cp">#define S6_GMAC_HOST_INTSTAT	0x148</span>
<span class="cp">#define S6_GMAC_HOST_INT_TXBURSTOVER	3</span>
<span class="cp">#define S6_GMAC_HOST_INT_TXPREWOVER	4</span>
<span class="cp">#define S6_GMAC_HOST_INT_RXBURSTUNDER	5</span>
<span class="cp">#define S6_GMAC_HOST_INT_RXPOSTRFULL	6</span>
<span class="cp">#define S6_GMAC_HOST_INT_RXPOSTRUNDER	7</span>
<span class="cp">#define S6_GMAC_HOST_RXFIFOHWM	0x14C</span>
<span class="cp">#define S6_GMAC_HOST_CTRLFRAMXP	0x150</span>
<span class="cp">#define S6_GMAC_HOST_DSTADDRLO(n) (0x160 + 8*(n))</span>
<span class="cp">#define S6_GMAC_HOST_DSTADDRHI(n) (0x164 + 8*(n))</span>
<span class="cp">#define S6_GMAC_HOST_DSTMASKLO(n) (0x180 + 8*(n))</span>
<span class="cp">#define S6_GMAC_HOST_DSTMASKHI(n) (0x184 + 8*(n))</span>

<span class="cp">#define S6_GMAC_BURST_PREWR	0x1B0</span>
<span class="cp">#define S6_GMAC_BURST_PREWR_LEN		0</span>
<span class="cp">#define S6_GMAC_BURST_PREWR_LEN_MASK		((1 &lt;&lt; 20) - 1)</span>
<span class="cp">#define S6_GMAC_BURST_PREWR_CFE		20</span>
<span class="cp">#define S6_GMAC_BURST_PREWR_PPE		21</span>
<span class="cp">#define S6_GMAC_BURST_PREWR_FCS		22</span>
<span class="cp">#define S6_GMAC_BURST_PREWR_PAD		23</span>
<span class="cp">#define S6_GMAC_BURST_POSTRD	0x1D0</span>
<span class="cp">#define S6_GMAC_BURST_POSTRD_LEN	0</span>
<span class="cp">#define S6_GMAC_BURST_POSTRD_LEN_MASK		((1 &lt;&lt; 20) - 1)</span>
<span class="cp">#define S6_GMAC_BURST_POSTRD_DROP	20</span>


<span class="cm">/* data handling */</span>

<span class="cp">#define S6_NUM_TX_SKB	8	</span><span class="cm">/* must be larger than TX fifo size */</span><span class="cp"></span>
<span class="cp">#define S6_NUM_RX_SKB	16</span>
<span class="cp">#define S6_MAX_FRLEN	1536</span>

<span class="k">struct</span> <span class="n">s6gmac</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">io</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_chan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_chan</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_skb_i</span><span class="p">,</span> <span class="n">tx_skb_o</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_skb_i</span><span class="p">,</span> <span class="n">rx_skb_o</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">S6_NUM_TX_SKB</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">S6_NUM_RX_SKB</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">carry</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stats</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">PHY_MAX_ADDR</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">mii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mbit</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">giga</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">isup</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">full</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">link</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_rx_fillfifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((((</span><span class="n">u8</span><span class="p">)(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_i</span> <span class="o">-</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_o</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">S6_NUM_RX_SKB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="o">!</span><span class="n">s6dmac_fifo_full</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">S6_MAX_FRLEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_i</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">S6_NUM_RX_SKB</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">s6dmac_put_fifo_cache</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">S6_MAX_FRLEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pfx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">u8</span><span class="p">)(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_i</span> <span class="o">-</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_o</span><span class="p">))</span> <span class="o">&gt;</span>
			<span class="n">s6dmac_pending_count</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_o</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">S6_NUM_RX_SKB</span><span class="p">];</span>
		<span class="n">pfx</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_BURST_POSTRD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_BURST_POSTRD_DROP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">pfx</span> <span class="o">&gt;&gt;</span> <span class="n">S6_GMAC_BURST_POSTRD_LEN</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="n">S6_GMAC_BURST_POSTRD_LEN_MASK</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_tx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">u8</span><span class="p">)(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_i</span> <span class="o">-</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_o</span><span class="p">))</span> <span class="o">&gt;</span>
			<span class="n">s6dmac_pending_count</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_o</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">S6_NUM_TX_SKB</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s6dmac_fifo_full</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">s6gmac_statinf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">reg_size</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 0: unused */</span>
	<span class="kt">unsigned</span> <span class="n">reg_off</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">net_index</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define S6_STATS_B (8 * sizeof(u32))</span>
<span class="cp">#define S6_STATS_C(b, r, f) [b] = { \</span>
<span class="cp">	BUILD_BUG_ON_ZERO(r##_SIZE &lt; S6_GMAC_STAT_SIZE_MIN) + \</span>
<span class="cp">	BUILD_BUG_ON_ZERO((r##_SIZE - (S6_GMAC_STAT_SIZE_MIN - 1)) \</span>
<span class="cp">			&gt;= (1&lt;&lt;4)) + \</span>
<span class="cp">	r##_SIZE - (S6_GMAC_STAT_SIZE_MIN - 1), \</span>
<span class="cp">	BUILD_BUG_ON_ZERO(((unsigned)((r - S6_GMAC_STAT_REGS) / sizeof(u32))) \</span>
<span class="cp">			&gt;= ((1&lt;&lt;6)-1)) + \</span>
<span class="cp">	(r - S6_GMAC_STAT_REGS) / sizeof(u32), \</span>
<span class="cp">	BUILD_BUG_ON_ZERO((offsetof(struct net_device_stats, f)) \</span>
<span class="cp">			% sizeof(unsigned long)) + \</span>
<span class="cp">	BUILD_BUG_ON_ZERO((((unsigned)(offsetof(struct net_device_stats, f)) \</span>
<span class="cp">			/ sizeof(unsigned long)) &gt;= (1&lt;&lt;6))) + \</span>
<span class="cp">	BUILD_BUG_ON_ZERO((sizeof(((struct net_device_stats *)0)-&gt;f) \</span>
<span class="cp">			!= sizeof(unsigned long))) + \</span>
<span class="cp">	(offsetof(struct net_device_stats, f)) / sizeof(unsigned long)},</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">s6gmac_statinf</span> <span class="n">statinf</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">S6_STATS_B</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RBYT</span><span class="p">,</span> <span class="n">S6_GMAC_STATRBYT</span><span class="p">,</span> <span class="n">rx_bytes</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RPKT</span><span class="p">,</span> <span class="n">S6_GMAC_STATRPKT</span><span class="p">,</span> <span class="n">rx_packets</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RFCS</span><span class="p">,</span> <span class="n">S6_GMAC_STATRFCS</span><span class="p">,</span> <span class="n">rx_crc_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RMCA</span><span class="p">,</span> <span class="n">S6_GMAC_STATRMCA</span><span class="p">,</span> <span class="n">multicast</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RALN</span><span class="p">,</span> <span class="n">S6_GMAC_STATRALN</span><span class="p">,</span> <span class="n">rx_frame_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RFLR</span><span class="p">,</span> <span class="n">S6_GMAC_STATRFLR</span><span class="p">,</span> <span class="n">rx_length_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RCDE</span><span class="p">,</span> <span class="n">S6_GMAC_STATRCDE</span><span class="p">,</span> <span class="n">rx_missed_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RUND</span><span class="p">,</span> <span class="n">S6_GMAC_STATRUND</span><span class="p">,</span> <span class="n">rx_length_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_ROVR</span><span class="p">,</span> <span class="n">S6_GMAC_STATROVR</span><span class="p">,</span> <span class="n">rx_length_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RFRG</span><span class="p">,</span> <span class="n">S6_GMAC_STATRFRG</span><span class="p">,</span> <span class="n">rx_crc_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RJBR</span><span class="p">,</span> <span class="n">S6_GMAC_STATRJBR</span><span class="p">,</span> <span class="n">rx_crc_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY1_RDRP</span><span class="p">,</span> <span class="n">S6_GMAC_STATRDRP</span><span class="p">,</span> <span class="n">rx_dropped</span><span class="p">)</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TBYT</span><span class="p">,</span> <span class="n">S6_GMAC_STATTBYT</span><span class="p">,</span> <span class="n">tx_bytes</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TPKT</span><span class="p">,</span> <span class="n">S6_GMAC_STATTPKT</span><span class="p">,</span> <span class="n">tx_packets</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TEDF</span><span class="p">,</span> <span class="n">S6_GMAC_STATTEDF</span><span class="p">,</span> <span class="n">tx_aborted_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TXCL</span><span class="p">,</span> <span class="n">S6_GMAC_STATTXCL</span><span class="p">,</span> <span class="n">tx_aborted_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TNCL</span><span class="p">,</span> <span class="n">S6_GMAC_STATTNCL</span><span class="p">,</span> <span class="n">collisions</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TDRP</span><span class="p">,</span> <span class="n">S6_GMAC_STATTDRP</span><span class="p">,</span> <span class="n">tx_dropped</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TJBR</span><span class="p">,</span> <span class="n">S6_GMAC_STATTJBR</span><span class="p">,</span> <span class="n">tx_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TFCS</span><span class="p">,</span> <span class="n">S6_GMAC_STATTFCS</span><span class="p">,</span> <span class="n">tx_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TOVR</span><span class="p">,</span> <span class="n">S6_GMAC_STATTOVR</span><span class="p">,</span> <span class="n">tx_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TUND</span><span class="p">,</span> <span class="n">S6_GMAC_STATTUND</span><span class="p">,</span> <span class="n">tx_errors</span><span class="p">)</span>
	<span class="n">S6_STATS_C</span><span class="p">(</span><span class="n">S6_GMAC_STATCARRY2_TFRG</span><span class="p">,</span> <span class="n">S6_GMAC_STATTFRG</span><span class="p">,</span> <span class="n">tx_errors</span><span class="p">)</span>
<span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_stats_collect</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">s6gmac_statinf</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">S6_STATS_B</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">reg_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">inf</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">net_index</span><span class="p">]</span> <span class="o">+=</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STAT_REGS</span>
					<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">inf</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">reg_off</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_stats_carry</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">s6gmac_statinf</span> <span class="o">*</span><span class="n">inf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">carry</span><span class="p">[</span><span class="n">inf</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">net_index</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">inf</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">reg_size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">s6gmac_stats_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">carry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRY</span><span class="p">(</span><span class="n">carry</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRYMSK</span><span class="p">(</span><span class="n">carry</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_stats_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">carry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">s6gmac_stats_pending</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">carry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRY</span><span class="p">(</span><span class="n">carry</span><span class="p">));</span>
		<span class="n">s6gmac_stats_carry</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statinf</span><span class="p">[</span><span class="n">carry</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s6gmac_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6dmac_termcnt_irq</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">))</span>
		<span class="n">s6gmac_rx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6gmac_rx_fillfifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6dmac_termcnt_irq</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">))</span>
		<span class="n">s6gmac_tx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6gmac_stats_interrupt</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">s6gmac_stats_interrupt</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_set_dstaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">addrlo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addrhi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">masklo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">maskhi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addrlo</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_DSTADDRLO</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addrhi</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_DSTADDRHI</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">masklo</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_DSTMASKLO</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">maskhi</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_DSTMASKHI</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_stop_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_rgmii</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span>
		<span class="o">&amp;</span> <span class="p">(</span><span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	writel(1 &lt;&lt; S6_GMAC_MACCONF1_SYNCTX |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_SYNCRX |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_TXFLOWCTRL |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_RXFLOWCTRL |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_RESTXFUNC |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_RESRXFUNC |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_RESTXMACCTRL |</span>
<span class="c">		1 &lt;&lt; S6_GMAC_MACCONF1_RESRXMACCTRL,</span>
<span class="c">		pd-&gt;reg + S6_GMAC_MACCONF1);</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_SOFTRES</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_TXENA</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_RXENA</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_TXSRES</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_RXSRES</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_PBLKCTRL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">S6_GMAC_HOST_PBLKCTRL_SIZ_128</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_TXBSIZ</span> <span class="o">|</span>
		<span class="n">S6_GMAC_HOST_PBLKCTRL_SIZ_128</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_RXBSIZ</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_STATENA</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_STATCLEAR</span> <span class="o">|</span>
		<span class="n">is_rgmii</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_RGMII</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_PBLKCTRL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_TXENA</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_RXENA</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_LOOPBACK</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_LOOPBACK</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">S6_MAX_FRLEN</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="o">-</span><span class="n">ETH_FCS_LEN</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="o">+</span><span class="n">ETH_HLEN</span><span class="o">+</span><span class="n">ETH_FCS_LEN</span> <span class="o">:</span> <span class="n">S6_MAX_FRLEN</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMAXFRAMELEN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">full</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_FULL</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_PADCRCENA</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_LENGTHFCHK</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">giga</span> <span class="o">?</span>
			<span class="n">S6_GMAC_MACCONF2_IFMODE_BYTE</span> <span class="o">:</span>
			<span class="n">S6_GMAC_MACCONF2_IFMODE_NIBBLE</span><span class="p">)</span>
			<span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_IFMODE</span> <span class="o">|</span>
		<span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_PREAMBLELEN</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACSTATADDR1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACSTATADDR2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF0_WTMENREQ</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF0_SRFENREQ</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF0_FRFENREQ</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF0_STFENREQ</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF0_FTFENREQ</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_FIFOCONF0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF3_CFGFTTH</span> <span class="o">|</span>
		<span class="mi">128</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF3_CFGHWMFT</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_FIFOCONF3</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">S6_GMAC_FIFOCONF_RSV_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_RUNT</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_CRCERR</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_OK</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_DRIBBLE</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_CTRLFRAME</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_PAUSECTRL</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_UNOPCODE</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_TRUNCATED</span><span class="p">))</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF5_DROPLT64</span> <span class="o">|</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">giga</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF5_CFGBYTM</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF5_RXDROPSIZE</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_FIFOCONF5</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_RUNT</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_CRCERR</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_DRIBBLE</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_CTRLFRAME</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_PAUSECTRL</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_UNOPCODE</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF_RSV_TRUNCATED</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_FIFOCONF4</span><span class="p">);</span>
	<span class="n">s6gmac_set_dstaddr</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="n">s6gmac_set_dstaddr</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
		<span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="n">s6gmac_set_dstaddr</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
	<span class="n">s6gmac_set_dstaddr</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_TXENA</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_RXENA</span> <span class="o">|</span>
		<span class="n">S6_GMAC_HOST_PBLKCTRL_SIZ_128</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_TXBSIZ</span> <span class="o">|</span>
		<span class="n">S6_GMAC_HOST_PBLKCTRL_SIZ_128</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_RXBSIZ</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_STATENA</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_STATCLEAR</span> <span class="o">|</span>
		<span class="n">is_rgmii</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_PBLKCTRL_RGMII</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_PBLKCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6mii_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF1</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF1_SOFTRES</span><span class="p">),</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIICONF</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">S6_GMAC_MACMIICONF_CSEL_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIICONF_CSEL</span><span class="p">))</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">S6_GMAC_MACMIICONF_CSEL_DIV168</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIICONF_CSEL</span><span class="p">),</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIICONF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6mii_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tmo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIIINDI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">tmo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6mii_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s6mii_enable</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6mii_busy</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIIADDR_PHY</span> <span class="o">|</span>
		<span class="n">regnum</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIIADDR_REG</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIIADDR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIICMD_READ</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIICMD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIICMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6mii_busy</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIISTAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6mii_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s6mii_enable</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6mii_busy</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">phy_addr</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIIADDR_PHY</span> <span class="o">|</span>
		<span class="n">regnum</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACMIIADDR_REG</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIIADDR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACMIICTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6mii_busy</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6mii_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s6mii_enable</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6mii_busy</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">PHY_INIT_TIMEOUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_set_rgmii_txclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pllsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">S6_REG_GREG1</span> <span class="o">+</span> <span class="n">S6_GREG1_PLLSEL</span><span class="p">);</span>
	<span class="n">pllsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S6_GREG1_PLLSEL_GMAC_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GREG1_PLLSEL_GMAC</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">mbit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">pllsel</span> <span class="o">|=</span> <span class="n">S6_GREG1_PLLSEL_GMAC_2500KHZ</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GREG1_PLLSEL_GMAC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">100</span>:
		<span class="n">pllsel</span> <span class="o">|=</span> <span class="n">S6_GREG1_PLLSEL_GMAC_25MHZ</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GREG1_PLLSEL_GMAC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1000</span>:
		<span class="n">pllsel</span> <span class="o">|=</span> <span class="n">S6_GREG1_PLLSEL_GMAC_125MHZ</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GREG1_PLLSEL_GMAC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pllsel</span><span class="p">,</span> <span class="n">S6_REG_GREG1</span> <span class="o">+</span> <span class="n">S6_GREG1_PLLSEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_linkisup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>

	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">full</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">giga</span> <span class="o">=</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">mbit</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">mbit</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">s6gmac_set_rgmii_txclock</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">isup</span> <span class="o">=</span> <span class="n">isup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isup</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_print_status</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_adjust_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">isup</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">mbit</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">full</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">isup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">phy_print_status</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">isup</span> <span class="o">&amp;&amp;</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">full</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">maccfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">)</span>
				<span class="n">maccfg</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_FULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">maccfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_FULL</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">maccfg</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">giga</span> <span class="o">!=</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">fifocfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_FIFOCONF5</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">maccfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF2</span><span class="p">);</span>
			<span class="n">maccfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">S6_GMAC_MACCONF2_IFMODE_MASK</span>
				     <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_IFMODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fifocfg</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF5_CFGBYTM</span><span class="p">;</span>
				<span class="n">maccfg</span> <span class="o">|=</span> <span class="n">S6_GMAC_MACCONF2_IFMODE_BYTE</span>
					   <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_IFMODE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fifocfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_FIFOCONF5_CFGBYTM</span><span class="p">);</span>
				<span class="n">maccfg</span> <span class="o">|=</span> <span class="n">S6_GMAC_MACCONF2_IFMODE_NIBBLE</span>
					   <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_MACCONF2_IFMODE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">fifocfg</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_FIFOCONF5</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">maccfg</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_MACCONF2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s6dmac_fifo_full</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">s6gmac_linkisup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">s6gmac_phy_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">phy_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">s6gmac_adjust_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">PHY_INTERFACE_MODE_RGMII</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Could not attach to PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="n">PHY_GBIT_FEATURES</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_init_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span>	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RDRP</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RJBR</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RFRG</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_ROVR</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RUND</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RCDE</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RFLR</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RALN</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RMCA</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RFCS</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RPKT</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY1_RBYT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRY</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRYMSK</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">mask</span> <span class="o">=</span>	<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TDRP</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TNCL</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TXCL</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TEDF</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TPKT</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TBYT</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TFRG</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TUND</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TOVR</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TFCS</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_STATCARRY2_TJBR</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRY</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_STATCARRYMSK</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s6gmac_init_dmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6dmac_disable_chan</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">);</span>
	<span class="n">s6dmac_disable_chan</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">);</span>
	<span class="n">s6dmac_disable_error_irqs</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_HIFDMA_GMACTX</span><span class="p">);</span>
	<span class="n">s6dmac_disable_error_irqs</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_HIFDMA_GMACRX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6gmac_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_BURST_PREWR_LEN</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_BURST_PREWR_CFE</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_BURST_PREWR_PPE</span> <span class="o">|</span>
		<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_BURST_PREWR_FCS</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_BURST_PREWR_PAD</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_BURST_PREWR</span><span class="p">);</span>
	<span class="n">s6dmac_put_fifo_cache</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s6dmac_fifo_full</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">u8</span><span class="p">)(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_i</span> <span class="o">-</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_o</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">S6_NUM_TX_SKB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GMAC BUG: skb tx ring overflow [%x, %x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_o</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_i</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_i</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">S6_NUM_TX_SKB</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s6gmac_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s6gmac_tx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6gmac_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">phy_read_status</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">mbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s6gmac_linkisup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">s6gmac_init_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6gmac_init_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6gmac_init_dmac</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6gmac_rx_fillfifo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6dmac_enable_chan</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span><span class="p">,</span>
		<span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">s6dmac_enable_chan</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span><span class="p">,</span>
		<span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_INT_TXBURSTOVER</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_INT_TXPREWOVER</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_INT_RXBURSTUNDER</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_INT_RXPOSTRFULL</span> <span class="o">|</span>
		<span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">S6_GMAC_HOST_INT_RXPOSTRUNDER</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">S6_GMAC_HOST_INTMASK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">phy_start</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s6gmac_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy_stop</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">phydev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s6gmac_init_dmac</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s6gmac_stop_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_i</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_o</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_skb_o</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">S6_NUM_TX_SKB</span><span class="p">]);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_i</span> <span class="o">!=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_o</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_skb_o</span><span class="o">++</span><span class="p">)</span> <span class="o">%</span> <span class="n">S6_NUM_RX_SKB</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">s6gmac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">carry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">S6_GMAC_STAT_SIZE_MIN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">s6gmac_stats_collect</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statinf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">s6gmac_stats_collect</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statinf</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">s6gmac_stats_pending</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">s6gmac_stats_pending</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">+</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">+</span>
			<span class="n">st</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">st</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">s6gmac_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">s6gmac_open</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">s6gmac_stop</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_start_xmit</span> <span class="o">=</span> <span class="n">s6gmac_tx</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="n">s6gmac_tx_timeout</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_stats</span> <span class="o">=</span> <span class="n">s6gmac_stats</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pd</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">=</span> <span class="n">DMA_MASK_DMAC</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">tx_chan</span> <span class="o">=</span> <span class="n">DMA_INDEX_CHNL</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_DMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">=</span> <span class="n">DMA_MASK_DMAC</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">rx_chan</span> <span class="o">=</span> <span class="n">DMA_INDEX_CHNL</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s6gmac_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_PRMT</span> <span class="s">&quot;irq request failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errirq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_PRMT</span> <span class="s">&quot;error registering device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="n">mdiobus_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRV_PRMT</span> <span class="s">&quot;error allocating mii bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errmii</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;s6gmac_mii&quot;</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">s6mii_read</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">s6mii_write</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">s6mii_reset</span><span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MII_BUS_ID_SIZE</span><span class="p">,</span> <span class="s">&quot;%s-%x&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">phy_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">PHY_POLL</span><span class="p">;</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mdiobus_register</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
	<span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">mb</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">s6gmac_phy_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">errmii:</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">errdev:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">errirq:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">s6gmac_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">s6gmac</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">s6gmac_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">s6gmac_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">s6gmac_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;s6gmac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">s6gmac_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRV_PRMT</span> <span class="s">&quot;S6 GMAC ethernet driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s6gmac_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">s6gmac_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s6gmac_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">s6gmac_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">s6gmac_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;S6105 on chip Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Oskar Schirmer &lt;oskar@scara.com&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
