<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › neterion › s2io.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>s2io.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/************************************************************************</span>
<span class="cm"> * s2io.c: A Linux PCI-X Ethernet driver for Neterion 10GbE Server NIC</span>
<span class="cm"> * Copyright(c) 2002-2010 Exar Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms of</span>
<span class="cm"> * the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm"> * Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm"> * retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm"> * a complete program and may only be used when the entire operating</span>
<span class="cm"> * system is licensed under the GPL.</span>
<span class="cm"> * See the file COPYING in this distribution for more information.</span>
<span class="cm"> *</span>
<span class="cm"> * Credits:</span>
<span class="cm"> * Jeff Garzik		: For pointing out the improper error condition</span>
<span class="cm"> *			  check in the s2io_xmit routine and also some</span>
<span class="cm"> *			  issues in the Tx watch dog function. Also for</span>
<span class="cm"> *			  patiently answering all those innumerable</span>
<span class="cm"> *			  questions regaring the 2.6 porting issues.</span>
<span class="cm"> * Stephen Hemminger	: Providing proper 2.6 porting mechanism for some</span>
<span class="cm"> *			  macros available only in 2.6 Kernel.</span>
<span class="cm"> * Francois Romieu	: For pointing out all code part that were</span>
<span class="cm"> *			  deprecated and also styling related comments.</span>
<span class="cm"> * Grant Grundler	: For helping me get rid of some Architecture</span>
<span class="cm"> *			  dependent code.</span>
<span class="cm"> * Christopher Hellwig	: Some more 2.6 specific issues in the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * The module loadable parameters that are supported by the driver and a brief</span>
<span class="cm"> * explanation of all the variables.</span>
<span class="cm"> *</span>
<span class="cm"> * rx_ring_num : This can be used to program the number of receive rings used</span>
<span class="cm"> * in the driver.</span>
<span class="cm"> * rx_ring_sz: This defines the number of receive blocks each ring can have.</span>
<span class="cm"> *     This is also an array of size 8.</span>
<span class="cm"> * rx_ring_mode: This defines the operation mode of all 8 rings. The valid</span>
<span class="cm"> *		values are 1, 2.</span>
<span class="cm"> * tx_fifo_num: This defines the number of Tx FIFOs thats used int the driver.</span>
<span class="cm"> * tx_fifo_len: This too is an array of 8. Each element defines the number of</span>
<span class="cm"> * Tx descriptors that can be associated with each corresponding FIFO.</span>
<span class="cm"> * intr_type: This defines the type of interrupt. The values can be 0(INTA),</span>
<span class="cm"> *     2(MSI_X). Default value is &#39;2(MSI_X)&#39;</span>
<span class="cm"> * lro_max_pkts: This parameter defines maximum number of packets can be</span>
<span class="cm"> *     aggregated as a single large packet</span>
<span class="cm"> * napi: This parameter used to enable/disable NAPI (polling Rx)</span>
<span class="cm"> *     Possible values &#39;1&#39; for enable and &#39;0&#39; for disable. Default is &#39;1&#39;</span>
<span class="cm"> * ufo: This parameter used to enable/disable UDP Fragmentation Offload(UFO)</span>
<span class="cm"> *      Possible values &#39;1&#39; for enable and &#39;0&#39; for disable. Default is &#39;0&#39;</span>
<span class="cm"> * vlan_tag_strip: This can be used to enable or disable vlan stripping.</span>
<span class="cm"> *                 Possible values &#39;1&#39; for enable , &#39;0&#39; for disable.</span>
<span class="cm"> *                 Default is &#39;2&#39; - which means disable in promisc mode</span>
<span class="cm"> *                 and enable in non-promiscuous mode.</span>
<span class="cm"> * multiq: This parameter used to enable/disable MULTIQUEUE support.</span>
<span class="cm"> *      Possible values &#39;1&#39; for enable and &#39;0&#39; for disable. Default is &#39;0&#39;</span>
<span class="cm"> ************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/mdio.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/timex.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>

<span class="cp">#include &lt;asm/div64.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cm">/* local include */</span>
<span class="cp">#include &quot;s2io.h&quot;</span>
<span class="cp">#include &quot;s2io-regs.h&quot;</span>

<span class="cp">#define DRV_VERSION &quot;2.0.26.28&quot;</span>

<span class="cm">/* S2io Driver name &amp; version. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">s2io_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Neterion&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">s2io_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_VERSION</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rxd_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rxd_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">127</span><span class="p">,</span> <span class="mi">85</span><span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">RXD_IS_UP2DT</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">RXD_OWN_XENA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">GET_RXD_MARKER</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">THE_RXD_MARK</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cards with following subsystem_id have a link state indication</span>
<span class="cm"> * problem, 600B, 600C, 600D, 640B, 640C and 640D.</span>
<span class="cm"> * macro below identifies these cards given the subsystem_id.</span>
<span class="cm"> */</span>
<span class="cp">#define CARDS_WITH_FAULTY_LINK_INDICATORS(dev_type, subid)		\</span>
<span class="cp">	(dev_type == XFRAME_I_DEVICE) ?					\</span>
<span class="cp">	((((subid &gt;= 0x600B) &amp;&amp; (subid &lt;= 0x600D)) ||			\</span>
<span class="cp">	  ((subid &gt;= 0x640B) &amp;&amp; (subid &lt;= 0x640D))) ? 1 : 0) : 0</span>

<span class="cp">#define LINK_IS_UP(val64) (!(val64 &amp; (ADAPTER_STATUS_RMAC_REMOTE_FAULT | \</span>
<span class="cp">				      ADAPTER_STATUS_RMAC_LOCAL_FAULT)))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_s2io_card_up</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Ethtool related variables and Macros. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">s2io_gstrings</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Register test</span><span class="se">\t</span><span class="s">(offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Eeprom test</span><span class="se">\t</span><span class="s">(offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Link test</span><span class="se">\t</span><span class="s">(online)&quot;</span><span class="p">,</span>
	<span class="s">&quot;RLDRAM test</span><span class="se">\t</span><span class="s">(offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;BIST Test</span><span class="se">\t</span><span class="s">(offline)&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ethtool_xena_stats_keys</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;tmac_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_data_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_drop_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_mcst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_bcst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_pause_ctrl_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_ttl_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_ucst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_nucst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_any_err_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_ttl_less_fb_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_vld_ip_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_vld_ip&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_drop_ip&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_icmp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_rst_tcp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_tcp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tmac_udp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_vld_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_data_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_fcs_err_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_drop_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_vld_mcst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_vld_bcst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_in_rng_len_err_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_out_rng_len_err_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_long_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_pause_ctrl_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_unsup_ctrl_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_accepted_ucst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_accepted_nucst_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_discarded_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_drop_events&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_less_fb_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_usized_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_osized_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frag_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_jabber_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_64_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_65_127_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_128_255_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_256_511_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_512_1023_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_1024_1518_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ip&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ip_octets&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_hdr_err_ip&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_drop_ip&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_icmp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_tcp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_udp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_err_drp_udp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_xgmii_err_sym&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q6&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_frms_q7&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q0&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q5&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q6&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_full_q7&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_pause_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_xgmii_data_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_xgmii_ctrl_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_accepted_ip&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_err_tcp&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rd_req_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;new_rd_req_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;new_rd_req_rtry_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rd_rtry_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wr_rtry_rd_ack_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wr_req_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;new_wr_req_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;new_wr_req_rtry_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wr_rtry_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wr_disc_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rd_rtry_wr_ack_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;txp_wr_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;txd_rd_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;txd_wr_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rxd_rd_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rxd_wr_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;txf_rd_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rxf_wr_cnt&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ethtool_enhanced_stats_keys</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_1519_4095_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_4096_8191_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_8192_max_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ttl_gt_max_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_osized_alt_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_jabber_alt_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_gt_max_alt_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_vlan_frms&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_len_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_fcs_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_pf_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_da_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_red_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_rts_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rmac_ingm_full_discard&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;link_fault_cnt&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ethtool_driver_stats_keys</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> DRIVER STATISTICS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;single_bit_ecc_errs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;double_bit_ecc_errs&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;parity_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;serious_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;soft_reset_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;fifo_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_0_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_1_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_2_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_3_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_4_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_5_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_6_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ring_7_full_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;alarm_transceiver_temp_high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;alarm_transceiver_temp_low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;alarm_laser_bias_current_high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;alarm_laser_bias_current_low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;alarm_laser_output_power_high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;alarm_laser_output_power_low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;warn_transceiver_temp_high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;warn_transceiver_temp_low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;warn_laser_bias_current_high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;warn_laser_bias_current_low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;warn_laser_output_power_high&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;warn_laser_output_power_low&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;lro_aggregated_pkts&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;lro_flush_both_count&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;lro_out_of_sequence_pkts&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;lro_flush_due_to_max_pkts&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;lro_avg_aggr_pkts&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mem_alloc_fail_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pci_map_fail_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;watchdog_timer_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mem_allocated&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mem_freed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;link_up_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;link_down_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;link_up_time&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;link_down_time&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_tcode_buf_abort_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_tcode_desc_abort_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_tcode_parity_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_tcode_link_loss_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_tcode_list_proc_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_parity_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_abort_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_parity_abort_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_rda_fail_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_unkn_prot_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_fcs_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_buf_size_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_rxd_corrupt_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_tcode_unkn_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tda_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pfc_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;pcc_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tti_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tpa_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;sm_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;lso_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mac_tmac_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mac_rmac_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;xgxs_txgxs_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;xgxs_rxgxs_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rc_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;prc_pcix_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rpa_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rda_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rti_err_cnt&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;mc_err_cnt&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define S2IO_XENA_STAT_LEN	ARRAY_SIZE(ethtool_xena_stats_keys)</span>
<span class="cp">#define S2IO_ENHANCED_STAT_LEN	ARRAY_SIZE(ethtool_enhanced_stats_keys)</span>
<span class="cp">#define S2IO_DRIVER_STAT_LEN	ARRAY_SIZE(ethtool_driver_stats_keys)</span>

<span class="cp">#define XFRAME_I_STAT_LEN (S2IO_XENA_STAT_LEN + S2IO_DRIVER_STAT_LEN)</span>
<span class="cp">#define XFRAME_II_STAT_LEN (XFRAME_I_STAT_LEN + S2IO_ENHANCED_STAT_LEN)</span>

<span class="cp">#define XFRAME_I_STAT_STRINGS_LEN (XFRAME_I_STAT_LEN * ETH_GSTRING_LEN)</span>
<span class="cp">#define XFRAME_II_STAT_STRINGS_LEN (XFRAME_II_STAT_LEN * ETH_GSTRING_LEN)</span>

<span class="cp">#define S2IO_TEST_LEN	ARRAY_SIZE(s2io_gstrings)</span>
<span class="cp">#define S2IO_STRINGS_LEN	(S2IO_TEST_LEN * ETH_GSTRING_LEN)</span>

<span class="cp">#define S2IO_TIMER_CONF(timer, handle, arg, exp)	\</span>
<span class="cp">	init_timer(&amp;timer);				\</span>
<span class="cp">	timer.function = handle;			\</span>
<span class="cp">	timer.data = (unsigned long)arg;		\</span>
<span class="cp">	mod_timer(&amp;timer, (jiffies + exp))		\</span>

<span class="cm">/* copy mac addr to def_mac_addr array */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_s2io_copy_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Constants to be programmed into the Xena&#39;s registers, to configure</span>
<span class="cm"> * the XAUI.</span>
<span class="cm"> */</span>

<span class="cp">#define	END_SIGN	0x0</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">herc_act_dtx_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x8000051536750000ULL</span><span class="p">,</span> <span class="mh">0x80000515367500E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x8000051536750004ULL</span><span class="p">,</span> <span class="mh">0x80000515367500E4ULL</span><span class="p">,</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x80010515003F0000ULL</span><span class="p">,</span> <span class="mh">0x80010515003F00E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x80010515003F0004ULL</span><span class="p">,</span> <span class="mh">0x80010515003F00E4ULL</span><span class="p">,</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x801205150D440000ULL</span><span class="p">,</span> <span class="mh">0x801205150D4400E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x801205150D440004ULL</span><span class="p">,</span> <span class="mh">0x801205150D4400E4ULL</span><span class="p">,</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x80020515F2100000ULL</span><span class="p">,</span> <span class="mh">0x80020515F21000E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x80020515F2100004ULL</span><span class="p">,</span> <span class="mh">0x80020515F21000E4ULL</span><span class="p">,</span>
	<span class="cm">/* Done */</span>
	<span class="n">END_SIGN</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">xena_dtx_cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x8000051500000000ULL</span><span class="p">,</span> <span class="mh">0x80000515000000E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x80000515D9350004ULL</span><span class="p">,</span> <span class="mh">0x80000515D93500E4ULL</span><span class="p">,</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x8001051500000000ULL</span><span class="p">,</span> <span class="mh">0x80010515000000E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x80010515001E0004ULL</span><span class="p">,</span> <span class="mh">0x80010515001E00E4ULL</span><span class="p">,</span>
	<span class="cm">/* Set address */</span>
	<span class="mh">0x8002051500000000ULL</span><span class="p">,</span> <span class="mh">0x80020515000000E0ULL</span><span class="p">,</span>
	<span class="cm">/* Write data */</span>
	<span class="mh">0x80020515F2100004ULL</span><span class="p">,</span> <span class="mh">0x80020515F21000E4ULL</span><span class="p">,</span>
	<span class="n">END_SIGN</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Constants for Fixing the MacAddress problem seen mostly on</span>
<span class="cm"> * Alpha machines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">fix_mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0060000000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0040600000000000ULL</span><span class="p">,</span> <span class="mh">0x0000600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0020600000000000ULL</span><span class="p">,</span> <span class="mh">0x0000600000000000ULL</span><span class="p">,</span>
	<span class="mh">0x0040600000000000ULL</span><span class="p">,</span> <span class="mh">0x0060600000000000ULL</span><span class="p">,</span>
	<span class="n">END_SIGN</span>
<span class="p">};</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>


<span class="cm">/* Module Loadable parameters. */</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">tx_fifo_num</span><span class="p">,</span> <span class="n">FIFO_DEFAULT_NUM</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">rx_ring_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">multiq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">rx_ring_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">use_continuous_tx_intrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">rmac_pause_time</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">mc_pause_threshold_q0q3</span><span class="p">,</span> <span class="mi">187</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">mc_pause_threshold_q4q7</span><span class="p">,</span> <span class="mi">187</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">shared_splits</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">tmac_util_period</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">rmac_util_period</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">l3l4hdr_size</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="cm">/* 0 is no steering, 1 is Priority steering, 2 is Default steering */</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">tx_steering_type</span><span class="p">,</span> <span class="n">TX_DEFAULT_STEERING</span><span class="p">);</span>
<span class="cm">/* Frequency of Rx desc syncs expressed as power of 2 */</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">rxsync_frequency</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="cm">/* Interrupt type. Values can be 0(INTA), 2(MSI_X) */</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">intr_type</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="cm">/* Large receive offload feature */</span>

<span class="cm">/* Max pkts to be aggregated by LRO at one time. If not specified,</span>
<span class="cm"> * aggregation happens until we hit max IP pkt size(64K)</span>
<span class="cm"> */</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">lro_max_pkts</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">indicate_max_pkts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">ufo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">S2IO_PARM_INT</span><span class="p">(</span><span class="n">vlan_tag_strip</span><span class="p">,</span> <span class="n">NO_STRIP_IN_PROMISC</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_fifo_len</span><span class="p">[</span><span class="n">MAX_TX_FIFOS</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="n">DEFAULT_FIFO_0_LEN</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="p">...(</span><span class="n">MAX_TX_FIFOS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DEFAULT_FIFO_1_7_LEN</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_ring_sz</span><span class="p">[</span><span class="n">MAX_RX_RINGS</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{[</span><span class="mi">0</span> <span class="p">...(</span><span class="n">MAX_RX_RINGS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">SMALL_BLK_CNT</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rts_frm_len</span><span class="p">[</span><span class="n">MAX_RX_RINGS</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{[</span><span class="mi">0</span> <span class="p">...(</span><span class="n">MAX_RX_RINGS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">tx_fifo_len</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rx_ring_sz</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rts_frm_len</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * S2IO device table.</span>
<span class="cm"> * This table lists all the devices that this driver supports.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">s2io_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S2IO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_S2IO_WIN</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S2IO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_S2IO_UNI</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S2IO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HERC_WIN</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S2IO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_HERC_UNI</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">s2io_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">s2io_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">s2io_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">s2io_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">s2io_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">s2io_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;S2IO&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">s2io_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">s2io_init_nic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">s2io_rem_nic</span><span class="p">),</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s2io_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* A simplifier macro used both by init and free shared_mem Fns(). */</span>
<span class="cp">#define TXD_MEM_PAGE_CNT(len, per_each) ((len+per_each - 1) / per_each)</span>

<span class="cm">/* netqueue manipulation helper functions */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">queue_state</span> <span class="o">=</span> <span class="n">FIFO_QUEUE_STOP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s2io_stop_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">fifos</span><span class="p">[</span><span class="n">fifo_no</span><span class="p">].</span><span class="n">queue_state</span> <span class="o">=</span>
			<span class="n">FIFO_QUEUE_STOP</span><span class="p">;</span>

	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s2io_start_all_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">queue_state</span> <span class="o">=</span> <span class="n">FIFO_QUEUE_START</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s2io_start_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_no</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">fifos</span><span class="p">[</span><span class="n">fifo_no</span><span class="p">].</span><span class="n">queue_state</span> <span class="o">=</span>
			<span class="n">FIFO_QUEUE_START</span><span class="p">;</span>

	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s2io_wake_all_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">queue_state</span> <span class="o">=</span> <span class="n">FIFO_QUEUE_START</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">s2io_wake_tx_queue</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">multiq</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">multiq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">__netif_subqueue_stopped</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">))</span>
			<span class="n">netif_wake_subqueue</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">queue_state</span> <span class="o">==</span> <span class="n">FIFO_QUEUE_STOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">queue_state</span> <span class="o">=</span> <span class="n">FIFO_QUEUE_START</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * init_shared_mem - Allocation and Initialization of Memory</span>
<span class="cm"> * @nic: Device private variable.</span>
<span class="cm"> * Description: The function allocates all the memory areas shared</span>
<span class="cm"> * between the NIC and the driver. This includes Tx descriptors,</span>
<span class="cm"> * Rx descriptors and the statistics block.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_shared_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmp_v_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_v_addr_next</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tmp_p_addr</span><span class="p">,</span> <span class="n">tmp_p_addr_next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD_block</span> <span class="o">*</span><span class="n">pre_rxd_blk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">blk_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lst_size</span><span class="p">,</span> <span class="n">lst_per_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="n">ba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">mem_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocation and initialization of TXDLs in FIFOs */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">size</span> <span class="o">+=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_AVAILABLE_TXDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;Too many TxDs requested: %d, max supported: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">size</span><span class="p">,</span> <span class="n">MAX_AVAILABLE_TXDS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Legal values are from 2 to 8192</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Fifo %d: Invalid length (%d) - &quot;</span>
				  <span class="s">&quot;Valid lengths are 2 through 8192</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lst_size</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxD</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_txds</span><span class="p">);</span>
	<span class="n">lst_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">lst_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">fifo_len</span> <span class="o">=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">list_holder_size</span> <span class="o">=</span> <span class="n">fifo_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_info_hold</span><span class="p">);</span>

		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">list_holder_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;Malloc failed for list_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">list_holder_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">page_num</span> <span class="o">=</span> <span class="n">TXD_MEM_PAGE_CNT</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo_len</span><span class="p">,</span>
						<span class="n">lst_per_page</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">fifo_len</span> <span class="o">=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_get_info</span><span class="p">.</span><span class="n">fifo_len</span> <span class="o">=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">nic</span> <span class="o">=</span> <span class="n">nic</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">max_txds</span> <span class="o">=</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">page_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">tmp_p</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">tmp_v</span><span class="p">;</span>
			<span class="n">tmp_v</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						     <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_v</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
					  <span class="s">&quot;pci_alloc_consistent failed for TxDL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* If we got a zero DMA address(can happen on</span>
<span class="cm">			 * certain platforms like PPC), reallocate.</span>
<span class="cm">			 * Store virtual address of page we don&#39;t want,</span>
<span class="cm">			 * to be freed later.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_p</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">zerodma_virt_addr</span> <span class="o">=</span> <span class="n">tmp_v</span><span class="p">;</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span>
					  <span class="s">&quot;%s: Zero DMA address for TxDL. &quot;</span>
					  <span class="s">&quot;Virtual address %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp_v</span><span class="p">);</span>
				<span class="n">tmp_v</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							     <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_v</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
						  <span class="s">&quot;pci_alloc_consistent failed for TxDL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">lst_per_page</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">lst_per_page</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">list_virt_addr</span> <span class="o">=</span>
					<span class="n">tmp_v</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">lst_size</span><span class="p">);</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">list_phy_addr</span> <span class="o">=</span>
					<span class="n">tmp_p</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">lst_size</span><span class="p">);</span>
				<span class="n">k</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Allocation and initialization of RXDs in Rings */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">%</span> <span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Ring%d RxD count is not a &quot;</span>
				  <span class="s">&quot;multiple of RxDs per Block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">block_count</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">/</span>
			<span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkt_cnt</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span><span class="p">)));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">ring_len</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">ring_len</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">nic</span> <span class="o">=</span> <span class="n">nic</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_no</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">/</span> <span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*  Allocating all the Rx blocks */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blk_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_block_info</span> <span class="o">*</span><span class="n">rx_blocks</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

			<span class="n">rx_blocks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">SIZE_OF_BLOCK</span><span class="p">;</span>	<span class="cm">/* size is always page size */</span>
			<span class="n">tmp_v_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">tmp_p_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_v_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * In case of failure, free_shared_mem()</span>
<span class="cm">				 * is called, which should free any</span>
<span class="cm">				 * memory that was alloced till the</span>
<span class="cm">				 * failure happened.</span>
<span class="cm">				 */</span>
				<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">block_virt_addr</span> <span class="o">=</span> <span class="n">tmp_v_addr</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tmp_v_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxd_info</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">];</span>
			<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">block_virt_addr</span> <span class="o">=</span> <span class="n">tmp_v_addr</span><span class="p">;</span>
			<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">block_dma_addr</span> <span class="o">=</span> <span class="n">tmp_p_addr</span><span class="p">;</span>
			<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">rxds</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span>  <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">rxds</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">];</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">rxds</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">virt_addr</span> <span class="o">=</span>
					<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">block_virt_addr</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">rxd_size</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">*</span> <span class="n">l</span><span class="p">);</span>
				<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">rxds</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">dma_addr</span> <span class="o">=</span>
					<span class="n">rx_blocks</span><span class="o">-&gt;</span><span class="n">block_dma_addr</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">rxd_size</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">*</span> <span class="n">l</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Interlinking all Rx Blocks */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blk_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">blk_cnt</span><span class="p">;</span>
			<span class="n">tmp_v_addr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">block_virt_addr</span><span class="p">;</span>
			<span class="n">tmp_v_addr_next</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">block_virt_addr</span><span class="p">;</span>
			<span class="n">tmp_p_addr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">block_dma_addr</span><span class="p">;</span>
			<span class="n">tmp_p_addr_next</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">next</span><span class="p">].</span><span class="n">block_dma_addr</span><span class="p">;</span>

			<span class="n">pre_rxd_blk</span> <span class="o">=</span> <span class="n">tmp_v_addr</span><span class="p">;</span>
			<span class="n">pre_rxd_blk</span><span class="o">-&gt;</span><span class="n">reserved_2_pNext_RxD_block</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tmp_v_addr_next</span><span class="p">;</span>
			<span class="n">pre_rxd_blk</span><span class="o">-&gt;</span><span class="n">pNext_RxD_Blk_physical</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">tmp_p_addr_next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocation of Storages for buffer addresses in 2BUFF mode</span>
<span class="cm">		 * and the buffers as well.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">blk_cnt</span><span class="p">;</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blk_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffAdd</span><span class="p">)</span> <span class="o">*</span>
					<span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">ba</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">];</span>
					<span class="n">size</span> <span class="o">=</span> <span class="n">BUF0_LEN</span> <span class="o">+</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
					<span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0_org</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0_org</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0_org</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ALIGN_SIZE</span><span class="p">);</span>
					<span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>

					<span class="n">size</span> <span class="o">=</span> <span class="n">BUF1_LEN</span> <span class="o">+</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
					<span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1_org</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1_org</span><span class="p">)</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1_org</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
					<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ALIGN_SIZE</span><span class="p">);</span>
					<span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
					<span class="n">k</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Allocation and initialization of Statistics block */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stat_block</span><span class="p">);</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem</span> <span class="o">=</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem_phy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * In case of failure, free_shared_mem() is called, which</span>
<span class="cm">		 * should free any memory that was alloced till the</span>
<span class="cm">		 * failure happened.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem_sz</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">tmp_v_addr</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem</span><span class="p">;</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span> <span class="o">=</span> <span class="n">tmp_v_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tmp_v_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Ring Mem PHY: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tmp_p_addr</span><span class="p">);</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">.</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">mem_allocated</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * free_shared_mem - Free the allocated Memory</span>
<span class="cm"> * @nic:  Device private variable.</span>
<span class="cm"> * Description: This function is to free all memory locations allocated by</span>
<span class="cm"> * the init_shared_mem() function and return it to the kernel.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_shared_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmp_v_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tmp_p_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lst_size</span><span class="p">,</span> <span class="n">lst_per_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">lst_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxD</span><span class="p">)</span> <span class="o">*</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_txds</span><span class="p">;</span>
	<span class="n">lst_per_page</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">lst_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">page_num</span> <span class="o">=</span> <span class="n">TXD_MEM_PAGE_CNT</span><span class="p">(</span><span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">,</span> <span class="n">lst_per_page</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">page_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mem_blks</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">lst_per_page</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">list_info_hold</span> <span class="o">*</span><span class="n">fli</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">fli</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">mem_blks</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fli</span><span class="o">-&gt;</span><span class="n">list_virt_addr</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="n">fli</span><span class="o">-&gt;</span><span class="n">list_virt_addr</span><span class="p">,</span>
					    <span class="n">fli</span><span class="o">-&gt;</span><span class="n">list_phy_addr</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If we got a zero DMA address during allocation,</span>
<span class="cm">		 * free the page now</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">zerodma_virt_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">zerodma_virt_addr</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span>
				  <span class="s">&quot;%s: Freeing TxDL with zero DMA address. &quot;</span>
				  <span class="s">&quot;Virtual address %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">zerodma_virt_addr</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_info_hold</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">SIZE_OF_BLOCK</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blk_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_v_addr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">block_virt_addr</span><span class="p">;</span>
			<span class="n">tmp_p_addr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">block_dma_addr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_v_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					    <span class="n">tmp_v_addr</span><span class="p">,</span> <span class="n">tmp_p_addr</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rxds</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxd_info</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Freeing buffer storage addresses in 2BUFF mode. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blk_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="n">ba</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">];</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0_org</span><span class="p">);</span>
					<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span>
						<span class="n">BUF0_LEN</span> <span class="o">+</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1_org</span><span class="p">);</span>
					<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span>
						<span class="n">BUF1_LEN</span> <span class="o">+</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
					<span class="n">k</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffAdd</span><span class="p">)</span> <span class="o">*</span>
					<span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">blk_cnt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem_sz</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem_sz</span><span class="p">,</span>
				    <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem</span><span class="p">,</span>
				    <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem_phy</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_verify_pci_mode -</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_verify_pci_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>     <span class="n">mode</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pci_mode</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">GET_PCI_MODE</span><span class="p">(</span><span class="n">val64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">PCI_MODE_UNKNOWN_MODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>      <span class="cm">/* Unknown PCI mode */</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NEC_VENID   0x1033</span>
<span class="cp">#define NEC_DEVID   0x0125</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_on_nec_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">s2io_pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">tdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">tdev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">NEC_VENID</span> <span class="o">&amp;&amp;</span> <span class="n">tdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">NEC_DEVID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="n">s2io_pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">tdev</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bus_speed</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">33</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">266</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">266</span><span class="p">};</span>
<span class="cm">/**</span>
<span class="cm"> * s2io_print_pci_mode -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_print_pci_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcimode</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pci_mode</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">GET_PCI_MODE</span><span class="p">(</span><span class="n">val64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">PCI_MODE_UNKNOWN_MODE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Unknown PCI mode */</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">bus_speed</span> <span class="o">=</span> <span class="n">bus_speed</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_on_nec_bridge</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Device is on PCI-E bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCI_33</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;33MHz PCI bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCI_66</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;66MHz PCI bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCIX_M1_66</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;66MHz PCIX(M1) bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCIX_M1_100</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;100MHz PCIX(M1) bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCIX_M1_133</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;133MHz PCIX(M1) bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCIX_M2_66</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;133MHz PCIX(M2) bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCIX_M2_100</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;200MHz PCIX(M2) bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_MODE_PCIX_M2_133</span>:
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;266MHz PCIX(M2) bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pcimode</span> <span class="o">=</span> <span class="s">&quot;unsupported bus!&quot;</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Device is on %d bit %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">val64</span> <span class="o">&amp;</span> <span class="n">PCI_MODE_32_BITS</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">64</span><span class="p">,</span> <span class="n">pcimode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  init_tti - Initialization transmit traffic interrupt scheme</span>
<span class="cm"> *  @nic: device private variable</span>
<span class="cm"> *  @link: link status (UP/DOWN) used to enable/disable continuous</span>
<span class="cm"> *  transmit interrupts</span>
<span class="cm"> *  Description: The function configures transmit traffic interrupts</span>
<span class="cm"> *  Return Value:  SUCCESS on success and</span>
<span class="cm"> *  &#39;-1&#39; on failure</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_tti</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TTI Initialization. Default Tx timer gets us about</span>
<span class="cm">		 * 250 interrupts per sec. Continuous interrupts are enabled</span>
<span class="cm">		 * by default.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">bus_speed</span> <span class="o">*</span> <span class="mi">125</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">TTI_DATA1_MEM_TX_TIMER_VAL</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">TTI_DATA1_MEM_TX_TIMER_VAL</span><span class="p">(</span><span class="mh">0x2078</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">|=</span> <span class="n">TTI_DATA1_MEM_TX_URNG_A</span><span class="p">(</span><span class="mh">0xA</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">TTI_DATA1_MEM_TX_URNG_B</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">TTI_DATA1_MEM_TX_URNG_C</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">TTI_DATA1_MEM_TX_TIMER_AC_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_continuous_tx_intrs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">link</span> <span class="o">==</span> <span class="n">LINK_UP</span><span class="p">))</span>
				<span class="n">val64</span> <span class="o">|=</span> <span class="n">TTI_DATA1_MEM_TX_TIMER_CI_EN</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_data1_mem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">TTI_DATA2_MEM_TX_UFC_A</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">TTI_DATA2_MEM_TX_UFC_B</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">TTI_DATA2_MEM_TX_UFC_C</span><span class="p">(</span><span class="mh">0x200</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">TTI_DATA2_MEM_TX_UFC_D</span><span class="p">(</span><span class="mh">0x300</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">==</span>
			     <span class="n">TX_DEFAULT_STEERING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">udp_fifo_idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">udp_fifo_idx</span> <span class="o">+</span>
				  <span class="n">nic</span><span class="o">-&gt;</span><span class="n">total_udp_fifos</span><span class="p">)))</span>
				<span class="n">val64</span> <span class="o">=</span> <span class="n">TTI_DATA2_MEM_TX_UFC_A</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">TTI_DATA2_MEM_TX_UFC_B</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">TTI_DATA2_MEM_TX_UFC_C</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">TTI_DATA2_MEM_TX_UFC_D</span><span class="p">(</span><span class="mh">0x120</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">val64</span> <span class="o">=</span> <span class="n">TTI_DATA2_MEM_TX_UFC_A</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">TTI_DATA2_MEM_TX_UFC_B</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">TTI_DATA2_MEM_TX_UFC_C</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">TTI_DATA2_MEM_TX_UFC_D</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_data2_mem</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">TTI_CMD_MEM_WE</span> <span class="o">|</span>
			<span class="n">TTI_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
			<span class="n">TTI_CMD_MEM_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_command_mem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_command_mem</span><span class="p">,</span>
					  <span class="n">TTI_CMD_MEM_STROBE_NEW_CMD</span><span class="p">,</span>
					  <span class="n">S2IO_BIT_RESET</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  init_nic - Initialization of hardware</span>
<span class="cm"> *  @nic: device private variable</span>
<span class="cm"> *  Description: The function sequentially configures every block</span>
<span class="cm"> *  of the H/W from their reset values.</span>
<span class="cm"> *  Return Value:  SUCCESS on success and</span>
<span class="cm"> *  &#39;-1&#39; on failure (endian settings incorrect).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">add</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dtx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">mem_share</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mem_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="cm">/* to set the swapper controle on the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_set_swapper</span><span class="p">(</span><span class="n">nic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;ERROR: Setting Swapper failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Herc requires EOI to be removed from reset before XGXS, so..</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0xA500000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sw_reset</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sw_reset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Remove XGXS from reset state */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sw_reset</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sw_reset</span><span class="p">);</span>

	<span class="cm">/* Ensure that it&#39;s safe to access registers by checking</span>
<span class="cm">	 * RIC_RUNNING bit is reset. Check is valid only for XframeII.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RIC_RUNNING</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Enable Receiving broadcasts */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">MAC_RMAC_BCAST_ENABLE</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">val64</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* Read registers in all blocks */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_int_mask</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_int_mask</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_int_mask</span><span class="p">);</span>

	<span class="cm">/*  Set MTU */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">vBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_max_pyld_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">herc_act_dtx_cfg</span><span class="p">[</span><span class="n">dtx_cnt</span><span class="p">]</span> <span class="o">!=</span> <span class="n">END_SIGN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">herc_act_dtx_cfg</span><span class="p">[</span><span class="n">dtx_cnt</span><span class="p">],</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">dtx_control</span><span class="p">,</span> <span class="n">UF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dtx_cnt</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* Necessary!! */</span>
			<span class="n">dtx_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">xena_dtx_cfg</span><span class="p">[</span><span class="n">dtx_cnt</span><span class="p">]</span> <span class="o">!=</span> <span class="n">END_SIGN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">xena_dtx_cfg</span><span class="p">[</span><span class="n">dtx_cnt</span><span class="p">],</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">dtx_control</span><span class="p">,</span> <span class="n">UF</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">dtx_control</span><span class="p">);</span>
			<span class="n">dtx_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Tx DMA Initialization */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_0</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_1</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_2</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_3</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">val64</span> <span class="o">|=</span> <span class="n">vBIT</span><span class="p">(</span><span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">j</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">19</span><span class="p">),</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">vBIT</span><span class="p">(</span><span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_priority</span><span class="p">,</span> <span class="p">((</span><span class="n">j</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_0</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_1</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_2</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_3</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable 4 PCCs for Xena1, 2 and 3 as per H/W bug</span>
<span class="cm">	 * SXE-008 TRANSMIT DMA ARBITRATION ISSUE.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">PCC_ENABLE_FOUR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pcc_enable</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_0</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;Fifo partition at: 0x%p is: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialization of Tx_PA_CONFIG register to ignore packet</span>
<span class="cm">	 * integrity checking.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_pa_cfg</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">TX_PA_CFG_IGNORE_FRM_ERR</span> <span class="o">|</span>
		<span class="n">TX_PA_CFG_IGNORE_SNAP_OUI</span> <span class="o">|</span>
		<span class="n">TX_PA_CFG_IGNORE_LLC_CTRL</span> <span class="o">|</span>
		<span class="n">TX_PA_CFG_IGNORE_L2_ERR</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_pa_cfg</span><span class="p">);</span>

	<span class="cm">/* Rx DMA intialization. */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">val64</span> <span class="o">|=</span> <span class="n">vBIT</span><span class="p">(</span><span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">ring_priority</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_queue_priority</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocating equal share of memory to all the</span>
<span class="cm">	 * configured Rings.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span>
		<span class="n">mem_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mem_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="o">+</span>
				     <span class="n">mem_size</span> <span class="o">%</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q0_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q1_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q2_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q3_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q4_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q5_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q6_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">mem_share</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem_size</span> <span class="o">/</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_QUEUE_CFG_Q7_SZ</span><span class="p">(</span><span class="n">mem_share</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_queue_cfg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Filling Tx round robin registers</span>
<span class="cm">	 * as per the number of FIFOs for equal scheduling priority</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001000100010001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001000100000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020001020001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0200010200010200ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0102000102000102ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020001020001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0200010200000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020300010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020300000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304000102ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0304000102030400ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0102030400010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0400010203040001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040500010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0405000102030405ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040500000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050600ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0102030405060001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040506000102ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0304050600010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0405060000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050607ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020300000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_w_round_robin_4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable all configured Tx FIFO partitions */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_0</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TX_FIFO_PARTITION_EN</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_fifo_partition_0</span><span class="p">);</span>

	<span class="cm">/* Filling the Rx round robin registers as per the</span>
<span class="cm">	 * number of Rings and steering based on QoS with</span>
<span class="cm">	 * equal priority.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080808080808080ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001000100010001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001000100000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080808040404040ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020001020001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0200010200010200ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0102000102000102ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020001020001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0200010200000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080804040402020ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020300010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020300000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080404020201010ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304000102ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0304000102030400ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0102030400010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0400010203040001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080404020201008ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040500010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0405000102030405ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040500000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080404020100804ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050600ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0102030405060001ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0203040506000102ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0304050600010203ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0405060000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8080402010080402ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020304050607ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_0</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_2</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_3</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0001020300000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_w_round_robin_4</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x8040201008040201ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_qos_steering</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* UDP Fix */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_frm_len_n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Set the default rts frame length for the rings configured */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">MAC_RTS_FRM_LEN_SET</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="o">+</span><span class="mi">22</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_frm_len_n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Set the frame length for the configured rings</span>
<span class="cm">	 * desired by the user</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If rts_frm_len[i] == 0 then it is assumed that user not</span>
<span class="cm">		 * specified frame length steering.</span>
<span class="cm">		 * If the user provides the frame length then program</span>
<span class="cm">		 * the rts_frm_len register for those values or else</span>
<span class="cm">		 * leave it as it is.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rts_frm_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">MAC_RTS_FRM_LEN_SET</span><span class="p">(</span><span class="n">rts_frm_len</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_frm_len_n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable differentiated services steering logic */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rts_ds_steer</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;%s: rts_ds_steer failed on codepoint %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Program statistics memory */</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_mem_phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">stat_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">STAT_BC</span><span class="p">(</span><span class="mh">0x320</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">stat_byte_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initializing the sampling rate for the device to calculate the</span>
<span class="cm">	 * bandwidth utilization.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">MAC_TX_LINK_UTIL_VAL</span><span class="p">(</span><span class="n">tmac_util_period</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MAC_RX_LINK_UTIL_VAL</span><span class="p">(</span><span class="n">rmac_util_period</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_link_util</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initializing the Transmit and Receive Traffic Interrupt</span>
<span class="cm">	 * Scheme.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Initialize TTI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SUCCESS</span> <span class="o">!=</span> <span class="n">init_tti</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">last_link_state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* RTI Initialization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Programmed to generate Apprx 500 Intrs per</span>
<span class="cm">		 * second</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">bus_speed</span> <span class="o">*</span> <span class="mi">125</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">RTI_DATA1_MEM_RX_TIMER_VAL</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">RTI_DATA1_MEM_RX_TIMER_VAL</span><span class="p">(</span><span class="mh">0xFFF</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">RTI_DATA1_MEM_RX_URNG_A</span><span class="p">(</span><span class="mh">0xA</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RTI_DATA1_MEM_RX_URNG_B</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RTI_DATA1_MEM_RX_URNG_C</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RTI_DATA1_MEM_RX_TIMER_AC_EN</span><span class="p">;</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_data1_mem</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">RTI_DATA2_MEM_RX_UFC_A</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RTI_DATA2_MEM_RX_UFC_B</span><span class="p">(</span><span class="mh">0x2</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RTI_DATA2_MEM_RX_UFC_C</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">RTI_DATA2_MEM_RX_UFC_D</span><span class="p">(</span><span class="mh">0x40</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RTI_DATA2_MEM_RX_UFC_C</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">RTI_DATA2_MEM_RX_UFC_D</span><span class="p">(</span><span class="mh">0x80</span><span class="p">));</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_data2_mem</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">RTI_CMD_MEM_WE</span> <span class="o">|</span>
			<span class="n">RTI_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
			<span class="n">RTI_CMD_MEM_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_command_mem</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Once the operation completes, the Strobe bit of the</span>
<span class="cm">		 * command register will be reset. We poll for this</span>
<span class="cm">		 * particular condition. We wait for a maximum of 500ms</span>
<span class="cm">		 * for the operation to complete, if it&#39;s not complete</span>
<span class="cm">		 * by then we return error.</span>
<span class="cm">		 */</span>
		<span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_command_mem</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RTI_CMD_MEM_STROBE_NEW_CMD</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: RTI init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">time</span><span class="o">++</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initializing proper values as Pause threshold into all</span>
<span class="cm">	 * the 8 Queues on Rx side.</span>
<span class="cm">	 */</span>
	<span class="n">writeq</span><span class="p">(</span><span class="mh">0xffbbffbbffbbffbbULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_pause_thresh_q0q3</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="mh">0xffbbffbbffbbffbbULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_pause_thresh_q4q7</span><span class="p">);</span>

	<span class="cm">/* Disable RMAC PAD STRIPPING */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MAC_CFG_RMAC_STRIP_PAD</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span><span class="p">),</span> <span class="n">add</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>

	<span class="cm">/* Enable FCS stripping by adapter */</span>
	<span class="n">add</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">MAC_CFG_RMAC_STRIP_FCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span><span class="p">),</span> <span class="n">add</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the time value to be inserted in the pause frame</span>
<span class="cm">	 * generated by xena.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_pause_cfg</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RMAC_PAUSE_HG_PTIME</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">));</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">RMAC_PAUSE_HG_PTIME</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">rmac_pause_time</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_pause_cfg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the Threshold Limit for Generating the pause frame</span>
<span class="cm">	 * If the amount of data in any Queue exceeds ratio of</span>
<span class="cm">	 * (mac_control.mc_pause_threshold_q0q3 or q4q7)/256</span>
<span class="cm">	 * pause frame is generated</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xFF00</span> <span class="o">|</span>
			   <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">mc_pause_threshold_q0q3</span><span class="p">)</span>
			  <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_pause_thresh_q0q3</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="mh">0xFF00</span> <span class="o">|</span>
			   <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">mc_pause_threshold_q4q7</span><span class="p">)</span>
			  <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_pause_thresh_q4q7</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TxDMA will stop Read request if the number of read split has</span>
<span class="cm">	 * exceeded the limit pointed by shared_splits</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">PIC_CNTL_SHARED_SPLITS</span><span class="p">(</span><span class="n">shared_splits</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">bus_speed</span> <span class="o">==</span> <span class="mi">266</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">TXREQTO_VAL</span><span class="p">(</span><span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXREQTO_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">txreqtimeout</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">read_retry_delay</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">write_retry_delay</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Programming the Herc to split every write transaction</span>
<span class="cm">	 * that does not start on an ADB to reduce disconnects.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">FAULT_BEHAVIOUR</span> <span class="o">|</span> <span class="n">EXT_REQ_EN</span> <span class="o">|</span>
			<span class="n">MISC_LINK_STABILITY_PRD</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">misc_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_control2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">s2BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">|</span><span class="n">s2BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">|</span><span class="n">s2BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">));</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_control2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="s">&quot;CX4&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">TMAC_AVG_IPG</span><span class="p">(</span><span class="mh">0x17</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tmac_avg_ipg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define LINK_UP_DOWN_INTERRUPT		1</span>
<span class="cp">#define MAC_RMAC_ERR_TIMER		2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_link_fault_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">LINK_UP_DOWN_INTERRUPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">MAC_RMAC_ERR_TIMER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  do_s2io_write_bits -  update alarm bits in alarm register</span>
<span class="cm"> *  @value: alarm bits</span>
<span class="cm"> *  @flag: interrupt status</span>
<span class="cm"> *  @addr: address value</span>
<span class="cm"> *  Description: update alarm bits in alarm register</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  NONE.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_s2io_write_bits</span><span class="p">(</span><span class="n">u64</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">temp64</span><span class="p">;</span>

	<span class="n">temp64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">ENABLE_INTRS</span><span class="p">)</span>
		<span class="n">temp64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">temp64</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">temp64</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">en_dis_err_alarms</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">gen_int_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">interruptible</span><span class="p">;</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">DISABLE_ALL_INTRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">TX_DMA_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">TXDMA_INT_M</span><span class="p">;</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">TXDMA_TDA_INT</span> <span class="o">|</span> <span class="n">TXDMA_PFC_INT</span> <span class="o">|</span>
				   <span class="n">TXDMA_PCC_INT</span> <span class="o">|</span> <span class="n">TXDMA_TTI_INT</span> <span class="o">|</span>
				   <span class="n">TXDMA_LSO_INT</span> <span class="o">|</span> <span class="n">TXDMA_TPA_INT</span> <span class="o">|</span>
				   <span class="n">TXDMA_SM_INT</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">txdma_int_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">PFC_ECC_DB_ERR</span> <span class="o">|</span> <span class="n">PFC_SM_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">PFC_MISC_0_ERR</span> <span class="o">|</span> <span class="n">PFC_MISC_1_ERR</span> <span class="o">|</span>
				   <span class="n">PFC_PCIX_ERR</span> <span class="o">|</span> <span class="n">PFC_ECC_SG_ERR</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pfc_err_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">TDA_Fn_ECC_DB_ERR</span> <span class="o">|</span> <span class="n">TDA_SM0_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">TDA_SM1_ERR_ALARM</span> <span class="o">|</span> <span class="n">TDA_Fn_ECC_SG_ERR</span> <span class="o">|</span>
				   <span class="n">TDA_PCIX_ERR</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tda_err_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">PCC_FB_ECC_DB_ERR</span> <span class="o">|</span> <span class="n">PCC_TXB_ECC_DB_ERR</span> <span class="o">|</span>
				   <span class="n">PCC_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">PCC_WR_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">PCC_N_SERR</span> <span class="o">|</span> <span class="n">PCC_6_COF_OV_ERR</span> <span class="o">|</span>
				   <span class="n">PCC_7_COF_OV_ERR</span> <span class="o">|</span> <span class="n">PCC_6_LSO_OV_ERR</span> <span class="o">|</span>
				   <span class="n">PCC_7_LSO_OV_ERR</span> <span class="o">|</span> <span class="n">PCC_FB_ECC_SG_ERR</span> <span class="o">|</span>
				   <span class="n">PCC_TXB_ECC_SG_ERR</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pcc_err_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">TTI_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">TTI_ECC_SG_ERR</span> <span class="o">|</span>
				   <span class="n">TTI_ECC_DB_ERR</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_err_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">LSO6_ABORT</span> <span class="o">|</span> <span class="n">LSO7_ABORT</span> <span class="o">|</span>
				   <span class="n">LSO6_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">LSO7_SM_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">LSO6_SEND_OFLOW</span> <span class="o">|</span> <span class="n">LSO7_SEND_OFLOW</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">lso_err_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">TPA_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">TPA_TX_FRM_DROP</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tpa_err_mask</span><span class="p">);</span>

		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">SM_SM_ERR_ALARM</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sm_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">TX_MAC_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">TXMAC_INT_M</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">MAC_INT_STATUS_TMAC_INT</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_int_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">TMAC_TX_BUF_OVRN</span> <span class="o">|</span> <span class="n">TMAC_TX_SM_ERR</span> <span class="o">|</span>
				   <span class="n">TMAC_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TMAC_ECC_DB_ERR</span> <span class="o">|</span>
				   <span class="n">TMAC_DESC_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TMAC_DESC_ECC_DB_ERR</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_tmac_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">TX_XGXS_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">TXXGXS_INT_M</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">XGXS_INT_STATUS_TXGXS</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_int_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">TXGXS_ESTORE_UFLOW</span> <span class="o">|</span> <span class="n">TXGXS_TX_SM_ERR</span> <span class="o">|</span>
				   <span class="n">TXGXS_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TXGXS_ECC_DB_ERR</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_txgxs_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">RX_DMA_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">RXDMA_INT_M</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">RXDMA_INT_RC_INT_M</span> <span class="o">|</span> <span class="n">RXDMA_INT_RPA_INT_M</span> <span class="o">|</span>
				   <span class="n">RXDMA_INT_RDA_INT_M</span> <span class="o">|</span> <span class="n">RXDMA_INT_RTI_INT_M</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rxdma_int_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">RC_PRCn_ECC_DB_ERR</span> <span class="o">|</span> <span class="n">RC_FTC_ECC_DB_ERR</span> <span class="o">|</span>
				   <span class="n">RC_PRCn_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">RC_FTC_SM_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">RC_PRCn_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">RC_FTC_ECC_SG_ERR</span> <span class="o">|</span>
				   <span class="n">RC_RDA_FAIL_WR_Rn</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rc_err_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">PRC_PCI_AB_RD_Rn</span> <span class="o">|</span> <span class="n">PRC_PCI_AB_WR_Rn</span> <span class="o">|</span>
				   <span class="n">PRC_PCI_AB_F_WR_Rn</span> <span class="o">|</span> <span class="n">PRC_PCI_DP_RD_Rn</span> <span class="o">|</span>
				   <span class="n">PRC_PCI_DP_WR_Rn</span> <span class="o">|</span> <span class="n">PRC_PCI_DP_F_WR_Rn</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">prc_pcix_err_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">RPA_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">RPA_CREDIT_ERR</span> <span class="o">|</span>
				   <span class="n">RPA_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">RPA_ECC_DB_ERR</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rpa_err_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">RDA_RXDn_ECC_DB_ERR</span> <span class="o">|</span> <span class="n">RDA_FRM_ECC_DB_N_AERR</span> <span class="o">|</span>
				   <span class="n">RDA_SM1_ERR_ALARM</span> <span class="o">|</span> <span class="n">RDA_SM0_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">RDA_RXD_ECC_DB_SERR</span> <span class="o">|</span> <span class="n">RDA_RXDn_ECC_SG_ERR</span> <span class="o">|</span>
				   <span class="n">RDA_FRM_ECC_SG_ERR</span> <span class="o">|</span>
				   <span class="n">RDA_MISC_ERR</span><span class="o">|</span><span class="n">RDA_PCIX_ERR</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rda_err_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">RTI_SM_ERR_ALARM</span> <span class="o">|</span>
				   <span class="n">RTI_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">RTI_ECC_DB_ERR</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">RX_MAC_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">RXMAC_INT_M</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">MAC_INT_STATUS_RMAC_INT</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_int_mask</span><span class="p">);</span>
		<span class="n">interruptible</span> <span class="o">=</span> <span class="p">(</span><span class="n">RMAC_RX_BUFF_OVRN</span> <span class="o">|</span> <span class="n">RMAC_RX_SM_ERR</span> <span class="o">|</span>
				 <span class="n">RMAC_UNUSED_INT</span> <span class="o">|</span> <span class="n">RMAC_SINGLE_ECC_ERR</span> <span class="o">|</span>
				 <span class="n">RMAC_DOUBLE_ECC_ERR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_link_fault_indication</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="o">==</span> <span class="n">MAC_RMAC_ERR_TIMER</span><span class="p">)</span>
			<span class="n">interruptible</span> <span class="o">|=</span> <span class="n">RMAC_LINK_STATE_CHANGE_INT</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">interruptible</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">RX_XGXS_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">RXXGXS_INT_M</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">XGXS_INT_STATUS_RXGXS</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_int_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">RXGXS_ESTORE_OFLOW</span> <span class="o">|</span> <span class="n">RXGXS_RX_SM_ERR</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_rxgxs_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MC_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gen_int_mask</span> <span class="o">|=</span> <span class="n">MC_INT_M</span><span class="p">;</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">MC_INT_MASK_MC_INT</span><span class="p">,</span>
				   <span class="n">flag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_int_mask</span><span class="p">);</span>
		<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">MC_ERR_REG_SM_ERR</span> <span class="o">|</span> <span class="n">MC_ERR_REG_ECC_ALL_SNG</span> <span class="o">|</span>
				   <span class="n">MC_ERR_REG_ECC_ALL_DBL</span> <span class="o">|</span> <span class="n">PLL_LOCK_N</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_err_mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">general_int_mask</span> <span class="o">=</span> <span class="n">gen_int_mask</span><span class="p">;</span>

	<span class="cm">/* Remove this line when alarm interrupts are enabled */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">general_int_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  en_dis_able_nic_intrs - Enable or Disable the interrupts</span>
<span class="cm"> *  @nic: device private variable,</span>
<span class="cm"> *  @mask: A mask indicating which Intr block must be modified and,</span>
<span class="cm"> *  @flag: A flag indicating whether to enable or disable the Intrs.</span>
<span class="cm"> *  Description: This function will either disable or enable the interrupts</span>
<span class="cm"> *  depending on the flag argument. The mask argument can be used to</span>
<span class="cm"> *  enable/disable any Intr block.</span>
<span class="cm"> *  Return Value: NONE.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">en_dis_able_nic_intrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">temp64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intr_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intr_mask</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">;</span>

	<span class="cm">/*  Top level interrupt classification */</span>
	<span class="cm">/*  PIC Interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">TX_PIC_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Enable PIC Intrs in the general intr mask register */</span>
		<span class="n">intr_mask</span> <span class="o">|=</span> <span class="n">TXPIC_INT_M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">ENABLE_INTRS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If Hercules adapter enable GPIO otherwise</span>
<span class="cm">			 * disable all PCIX, Flash, MDIO, IIC and GPIO</span>
<span class="cm">			 * interrupts for now.</span>
<span class="cm">			 * TODO</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s2io_link_fault_indication</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">LINK_UP_DOWN_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">PIC_INT_GPIO</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_int_mask</span><span class="p">);</span>
				<span class="n">do_s2io_write_bits</span><span class="p">(</span><span class="n">GPIO_INT_MASK_LINK_UP</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">writeq</span><span class="p">(</span><span class="n">DISABLE_ALL_INTRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_int_mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">DISABLE_INTRS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Disable PIC Intrs in the general</span>
<span class="cm">			 * intr mask register</span>
<span class="cm">			 */</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">DISABLE_ALL_INTRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_int_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Tx traffic interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">TX_TRAFFIC_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intr_mask</span> <span class="o">|=</span> <span class="n">TXTRAFFIC_INT_M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">ENABLE_INTRS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Enable all the Tx side interrupts</span>
<span class="cm">			 * writing 0 Enables all 64 TX interrupt levels</span>
<span class="cm">			 */</span>
			<span class="n">writeq</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_traffic_mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">DISABLE_INTRS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Disable Tx Traffic Intrs in the general intr mask</span>
<span class="cm">			 * register.</span>
<span class="cm">			 */</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">DISABLE_ALL_INTRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_traffic_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Rx traffic interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">RX_TRAFFIC_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intr_mask</span> <span class="o">|=</span> <span class="n">RXTRAFFIC_INT_M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">ENABLE_INTRS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* writing 0 Enables all 8 RX interrupt levels */</span>
			<span class="n">writeq</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">DISABLE_INTRS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Disable Rx Traffic Intrs in the general intr mask</span>
<span class="cm">			 * register.</span>
<span class="cm">			 */</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">DISABLE_ALL_INTRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">temp64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="n">ENABLE_INTRS</span><span class="p">)</span>
		<span class="n">temp64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">intr_mask</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">temp64</span> <span class="o">=</span> <span class="n">DISABLE_ALL_INTRS</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">temp64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">general_int_mask</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  verify_pcc_quiescent- Checks for PCC quiescent state</span>
<span class="cm"> *  Return: 1 If PCC is quiescence</span>
<span class="cm"> *          0 If PCC is not quiescence</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_pcc_quiescent</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">herc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>

	<span class="n">herc</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">herc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span> <span class="o">||</span> <span class="n">herc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RMAC_PCC_IDLE</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RMAC_PCC_FOUR_IDLE</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">herc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span> <span class="o">||</span> <span class="n">herc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RMAC_PCC_IDLE</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">ADAPTER_STATUS_RMAC_PCC_IDLE</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RMAC_PCC_FOUR_IDLE</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">ADAPTER_STATUS_RMAC_PCC_FOUR_IDLE</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> *  verify_xena_quiescence - Checks whether the H/W is ready</span>
<span class="cm"> *  Description: Returns whether the H/W is ready to go or not. Depending</span>
<span class="cm"> *  on whether adapter enable bit was written or not the comparison</span>
<span class="cm"> *  differs and the calling function passes the input argument flag to</span>
<span class="cm"> *  indicate this.</span>
<span class="cm"> *  Return: 1 If xena is quiescence</span>
<span class="cm"> *          0 If Xena is not quiescence</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_xena_quiescence</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">s2io_verify_pci_mode</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_TDMA_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;TDMA is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RDMA_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;RDMA is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_PFC_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;PFC is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_TMAC_BUF_EMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;TMAC BUF is not empty!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_PIC_QUIESCENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;PIC is not QUIESCENT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_MC_DRAM_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;MC_DRAM is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_MC_QUEUES_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;MC_QUEUES is not ready!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_M_PLL_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;M_PLL is not locked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In PCI 33 mode, the P_PLL is not used, and therefore,</span>
<span class="cm">	 * the the P_PLL_LOCK bit in the adapter_status register will</span>
<span class="cm">	 * not be asserted.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_P_PLL_LOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mode</span> <span class="o">!=</span> <span class="n">PCI_MODE_PCI_33</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;P_PLL is not locked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_STATUS_RC_PRC_QUIESCENT</span><span class="p">)</span> <span class="o">==</span>
	      <span class="n">ADAPTER_STATUS_RC_PRC_QUIESCENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;RC_PRC is not QUIESCENT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fix_mac_address -  Fix for Mac addr problem on Alpha platforms</span>
<span class="cm"> * @sp: Pointer to device specifc structure</span>
<span class="cm"> * Description :</span>
<span class="cm"> * New procedure to clear mac address reading  problems on Alpha platforms</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">fix_mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">END_SIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">fix_mac</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  start_nic - Turns the device on</span>
<span class="cm"> *  @nic : device private variable.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function actually turns the device on. Before this  function is</span>
<span class="cm"> *  called,all Registers are configured from their reset states</span>
<span class="cm"> *  and shared memory is allocated but the NIC is still quiescent. On</span>
<span class="cm"> *  calling this function, the device interrupts are cleared and the NIC is</span>
<span class="cm"> *  literally switched on by writing into the adapter control register.</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  SUCCESS on success and -1 on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subid</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="cm">/*  PRC Initialization and configuration */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">writeq</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">block_dma_addr</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">prc_rxd0_n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">prc_ctrl_n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">PRC_CTRL_RC_ENABLED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">PRC_CTRL_RC_ENABLED</span> <span class="o">|</span> <span class="n">PRC_CTRL_RING_MODE_3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">PRC_CTRL_GROUP_READS</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRC_CTRL_RXD_BACKOFF_INTERVAL</span><span class="p">(</span><span class="mh">0xFFFFFF</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">PRC_CTRL_RXD_BACKOFF_INTERVAL</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">prc_ctrl_n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enabling 2 buffer mode by writing into Rx_pa_cfg reg. */</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_PA_CFG_IGNORE_L2_ERR</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tag_strip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_PA_CFG_STRIP_VLAN_TAG</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enabling MC-RLDRAM. After enabling the device, we timeout</span>
<span class="cm">	 * for around 100ms, which is approximately the time required</span>
<span class="cm">	 * for the device to be ready for operation.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_mrs</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">MC_RLDRAM_QUEUE_SIZE_ENABLE</span> <span class="o">|</span> <span class="n">MC_RLDRAM_MRS_ENABLE</span><span class="p">;</span>
	<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_mrs</span><span class="p">,</span> <span class="n">UF</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_mrs</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>	<span class="cm">/* Delay by around 100 ms. */</span>

	<span class="cm">/* Enabling ECC Protection. */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADAPTER_ECC_EN</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify if the device is ready to be enabled, if so enable</span>
<span class="cm">	 * it.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verify_xena_quiescence</span><span class="p">(</span><span class="n">nic</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: device is not ready, &quot;</span>
			  <span class="s">&quot;Adapter status reads: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * With some switches, link might be already up at this point.</span>
<span class="cm">	 * Because of this weird behavior, when we enable laser,</span>
<span class="cm">	 * we may not get link. We need to handle this. We cannot</span>
<span class="cm">	 * figure out which switch is misbehaving. So we are forced to</span>
<span class="cm">	 * make a global change.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enabling Laser. */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_EOI_TX_ON</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_link_fault_indication</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="o">==</span> <span class="n">MAC_RMAC_ERR_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Dont see link state interrupts initially on some switches,</span>
<span class="cm">		 * so directly scheduling the link state task here.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">set_link_task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* SXE-002: Initialize link and activity LED */</span>
	<span class="n">subid</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">subid</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="mh">0x0000800000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0411040400000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bar0</span> <span class="o">+</span> <span class="mh">0x2700</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * s2io_txdl_getskb - Get the skb from txdl, unmap and return skb</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">s2io_txdl_getskb</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo_data</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">TxD</span> <span class="o">*</span><span class="n">txdlp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">get_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxD</span> <span class="o">*</span><span class="n">txds</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">j</span><span class="p">,</span> <span class="n">frg_cnt</span><span class="p">;</span>

	<span class="n">txds</span> <span class="o">=</span> <span class="n">txdlp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txds</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">==</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">txds</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">txds</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">txds</span><span class="o">-&gt;</span><span class="n">Host_Control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">txdlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxD</span><span class="p">)</span> <span class="o">*</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">max_txds</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">txds</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span><span class="p">,</span>
			 <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">frg_cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frg_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txds</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">frg_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">txds</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txds</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">txds</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span><span class="p">,</span>
				       <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txdlp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxD</span><span class="p">)</span> <span class="o">*</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">max_txds</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  free_tx_buffers - Free all queued Tx buffers</span>
<span class="cm"> *  @nic : device private variable.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  Free all queued Tx buffers.</span>
<span class="cm"> *  Return Value: void</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_tx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxD</span> <span class="o">*</span><span class="n">txdp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txdp</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">list_virt_addr</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">s2io_txdl_getskb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">txdp</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INTR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: forcibly freeing %d skbs on FIFO%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *   stop_nic -  To stop the nic</span>
<span class="cm"> *   @nic ; device private variable.</span>
<span class="cm"> *   Description:</span>
<span class="cm"> *   This function does exactly the opposite of what the start_nic()</span>
<span class="cm"> *   function does. This function is called to stop the device.</span>
<span class="cm"> *   Return Value:</span>
<span class="cm"> *   void.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">interruptible</span><span class="p">;</span>

	<span class="cm">/*  Disable all interrupts */</span>
	<span class="n">en_dis_err_alarms</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ENA_ALL_INTRS</span><span class="p">,</span> <span class="n">DISABLE_INTRS</span><span class="p">);</span>
	<span class="n">interruptible</span> <span class="o">=</span> <span class="n">TX_TRAFFIC_INTR</span> <span class="o">|</span> <span class="n">RX_TRAFFIC_INTR</span><span class="p">;</span>
	<span class="n">interruptible</span> <span class="o">|=</span> <span class="n">TX_PIC_INTR</span><span class="p">;</span>
	<span class="n">en_dis_able_nic_intrs</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">,</span> <span class="n">DISABLE_INTRS</span><span class="p">);</span>

	<span class="cm">/* Clearing Adapter_En bit of ADAPTER_CONTROL Register */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADAPTER_CNTL_EN</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  fill_rx_buffers - Allocates the Rx side skbs</span>
<span class="cm"> *  @ring_info: per ring structure</span>
<span class="cm"> *  @from_card_up: If this is true, we will map the buffer to get</span>
<span class="cm"> *     the dma address for buf0 and buf1 to give it to the card.</span>
<span class="cm"> *     Else we will sync the already mapped buffer to give it to the card.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  The function allocates Rx side skbs and puts the physical</span>
<span class="cm"> *  address of these buffers into the RxD buffer pointers, so that the NIC</span>
<span class="cm"> *  can DMA the received frame into these locations.</span>
<span class="cm"> *  The NIC supports 3 receive modes, viz</span>
<span class="cm"> *  1. single buffer,</span>
<span class="cm"> *  2. three buffer and</span>
<span class="cm"> *  3. Five buffer modes.</span>
<span class="cm"> *  Each mode defines how many fragments the received frame will be split</span>
<span class="cm"> *  up into by the NIC. The frame is split into L3 header, L4 Header,</span>
<span class="cm"> *  L4 payload in three buffer mode and in 5 buffer mode, L4 payload itself</span>
<span class="cm"> *  is split into 3 fragments. As of now only single buffer mode is</span>
<span class="cm"> *  supported.</span>
<span class="cm"> *   Return Value:</span>
<span class="cm"> *  SUCCESS on success or an appropriate -ve value on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">from_card_up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">block_no</span><span class="p">,</span> <span class="n">block_no1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alloc_tab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alloc_cnt</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="n">ba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">first_rxdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Buffer1_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="n">rxdp1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="n">rxdp3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">alloc_cnt</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkt_cnt</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_bufs_left</span><span class="p">;</span>

	<span class="n">block_no1</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">block_index</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">alloc_tab</span> <span class="o">&lt;</span> <span class="n">alloc_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">block_no</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span><span class="p">;</span>

		<span class="n">off</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">rxdp</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">block_no</span><span class="p">].</span><span class="n">rxds</span><span class="p">[</span><span class="n">off</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">;</span>

		<span class="n">rxd_index</span> <span class="o">=</span> <span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block_no</span><span class="p">)</span>
			<span class="n">rxd_index</span> <span class="o">+=</span> <span class="p">(</span><span class="n">block_no</span> <span class="o">*</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">block_no</span> <span class="o">==</span> <span class="n">block_no1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INTR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Get and Put info equated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">==</span>
			    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">)</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">block_no</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span><span class="p">;</span>
			<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
			<span class="n">rxdp</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">block_no</span><span class="p">].</span><span class="n">block_virt_addr</span><span class="p">;</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INTR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Next block at: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rxdp</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">RXD_OWN_XENA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">&amp;</span> <span class="n">s2BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* calculate size of skb based on ring mode */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
			<span class="n">HEADER_ETHERNET_II_802_3_SIZE</span> <span class="o">+</span>
			<span class="n">HEADER_802_2_SIZE</span> <span class="o">+</span> <span class="n">HEADER_SNAP_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ALIGN_SIZE</span> <span class="o">+</span> <span class="n">BUF0_LEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* allocate skb */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Could not allocate skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_rxdp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wmb</span><span class="p">();</span>
				<span class="n">first_rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">RXD_OWN_XENA</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="o">++</span><span class="p">;</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 1 buffer mode - normal operation mode */</span>
			<span class="n">rxdp1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">rxdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span><span class="p">));</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
			<span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					       <span class="n">size</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">,</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">pci_map_failed</span><span class="p">;</span>

			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">=</span>
				<span class="n">SET_BUFFER0_SIZE_1</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * 2 buffer mode -</span>
<span class="cm">			 * 2 buffer mode provides 128</span>
<span class="cm">			 * byte aligned receive buffers.</span>
<span class="cm">			 */</span>

			<span class="n">rxdp3</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
			<span class="cm">/* save buffer pointers to avoid frequent dma mapping */</span>
			<span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">;</span>
			<span class="n">Buffer1_ptr</span> <span class="o">=</span> <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">rxdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span><span class="p">));</span>
			<span class="cm">/* restore the buffer pointers for dma sync*/</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="n">Buffer0_ptr</span><span class="p">;</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span> <span class="o">=</span> <span class="n">Buffer1_ptr</span><span class="p">;</span>

			<span class="n">ba</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">block_no</span><span class="p">][</span><span class="n">off</span><span class="p">];</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">BUF0_LEN</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">+=</span> <span class="n">ALIGN_SIZE</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ALIGN_SIZE</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
			<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">from_card_up</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span>
					<span class="n">pci_map_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0</span><span class="p">,</span>
						       <span class="n">BUF0_LEN</span><span class="p">,</span>
						       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							  <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">pci_map_failed</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							       <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">,</span>
							       <span class="n">BUF0_LEN</span><span class="p">,</span>
							       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">=</span> <span class="n">SET_BUFFER0_SIZE_3</span><span class="p">(</span><span class="n">BUF0_LEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Two buffer mode */</span>

				<span class="cm">/*</span>
<span class="cm">				 * Buffer2 will have L3/L4 header plus</span>
<span class="cm">				 * L4 payload</span>
<span class="cm">				 */</span>
				<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
								    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
								    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
								    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							  <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">pci_map_failed</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">from_card_up</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span> <span class="o">=</span>
						<span class="n">pci_map_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
							       <span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1</span><span class="p">,</span>
							       <span class="n">BUF1_LEN</span><span class="p">,</span>
							       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
								  <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
								 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
								 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
								 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
								 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
						<span class="k">goto</span> <span class="n">pci_map_failed</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">SET_BUFFER1_SIZE_3</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">SET_BUFFER2_SIZE_3</span>
					<span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">s2BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alloc_tab</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxsync_frequency</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">RXD_OWN_XENA</span><span class="p">;</span>
		<span class="n">off</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>

		<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">SET_RXD_MARKER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">alloc_tab</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rxsync_frequency</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first_rxdp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wmb</span><span class="p">();</span>
				<span class="n">first_rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">RXD_OWN_XENA</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">first_rxdp</span> <span class="o">=</span> <span class="n">rxdp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_bufs_left</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">alloc_tab</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="cm">/* Transfer ownership of first descriptor to adapter just before</span>
<span class="cm">	 * exiting. Before that, use memory barrier so that ownership</span>
<span class="cm">	 * and other fields are seen by adapter correctly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_rxdp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">first_rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">RXD_OWN_XENA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

<span class="nl">pci_map_failed:</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">pci_map_fail_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rxd_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ring_no</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="n">rxdp1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="n">rxdp3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxdp</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">ring_no</span><span class="p">].</span>
			<span class="n">rx_blocks</span><span class="p">[</span><span class="n">blk</span><span class="p">].</span><span class="n">rxds</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxdp1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
					 <span class="n">HEADER_ETHERNET_II_802_3_SIZE</span> <span class="o">+</span>
					 <span class="n">HEADER_802_2_SIZE</span> <span class="o">+</span> <span class="n">HEADER_SNAP_SIZE</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">rxdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxdp3</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">,</span>
					 <span class="n">BUF0_LEN</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span><span class="p">,</span>
					 <span class="n">BUF1_LEN</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">rxdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">ring_no</span><span class="p">].</span><span class="n">rx_bufs_left</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  free_rx_buffers - Frees all Rx buffers</span>
<span class="cm"> *  @sp: device private variable.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function will free all Rx buffers allocated by host.</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  NONE.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">blk</span> <span class="o">&lt;</span> <span class="n">rx_ring_sz</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">blk</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_rxd_blk</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">blk</span><span class="p">);</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_bufs_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Freed 0x%x Rx Buffers on ring%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_chk_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx_buffers</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Out of memory in Rx Intr!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_poll - Rx interrupt handler for NAPI support</span>
<span class="cm"> * @napi : pointer to the napi structure.</span>
<span class="cm"> * @budget : The number of packets that were budgeted to be processed</span>
<span class="cm"> * during  one pass through the &#39;Poll&quot; function.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Comes into picture only if NAPI support has been incorporated. It does</span>
<span class="cm"> * the same thing that rx_intr_handler does, but not in a interrupt context</span>
<span class="cm"> * also It will process only a given number of packets.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 0 on success and 1 if there are No Rx packets to be processed.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_poll_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_info</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkts_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">budget_org</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pkts_processed</span> <span class="o">=</span> <span class="n">rx_intr_handler</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="n">s2io_chk_rx_buffers</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkts_processed</span> <span class="o">&lt;</span> <span class="n">budget_org</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/*Re Enable MSI-Rx Vector*/</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_mask_reg</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_no</span><span class="p">;</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x3f</span> <span class="o">:</span> <span class="mh">0xbf</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">val8</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pkts_processed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_poll_inta</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2io_nic</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pkts_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring_pkts_processed</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">budget_org</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ring_pkts_processed</span> <span class="o">=</span> <span class="n">rx_intr_handler</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
		<span class="n">s2io_chk_rx_buffers</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="n">pkts_processed</span> <span class="o">+=</span> <span class="n">ring_pkts_processed</span><span class="p">;</span>
		<span class="n">budget</span> <span class="o">-=</span> <span class="n">ring_pkts_processed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkts_processed</span> <span class="o">&lt;</span> <span class="n">budget_org</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/* Re enable the Rx interrupts for the ring */</span>
		<span class="n">writeq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_mask</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_mask</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pkts_processed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/**</span>
<span class="cm"> * s2io_netpoll - netpoll event handler entry point</span>
<span class="cm"> * @dev : pointer to the device structure.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * 	This function will be called by upper layer to check for events on the</span>
<span class="cm"> * interface in situations where interrupts are disabled. It is used for</span>
<span class="cm"> * specific in-kernel networking tasks, such as remote consoles and kernel</span>
<span class="cm"> * debugging over the network (example netdump in RedHat).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFFFFULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_int</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_traffic_int</span><span class="p">);</span>

	<span class="cm">/* we need to free up the transmitted skbufs or else netpoll will</span>
<span class="cm">	 * run out of skbs and will fail and eventually netpoll application such</span>
<span class="cm">	 * as netdump will fail.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tx_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* check for received packet and indicate up to network */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rx_intr_handler</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx_buffers</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
				  <span class="s">&quot;%s: Out of memory in Rx Netpoll!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> *  rx_intr_handler - Rx interrupt handler</span>
<span class="cm"> *  @ring_info: per ring structure.</span>
<span class="cm"> *  @budget: budget for napi processing.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  If the interrupt is because of a received frame or if the</span>
<span class="cm"> *  receive ring contains fresh as yet un-processed frames,this function is</span>
<span class="cm"> *  called. It picks out the RxD at which place the last Rx processing had</span>
<span class="cm"> *  stopped and sends the skb to the OSM&#39;s Rx handler and then increments</span>
<span class="cm"> *  the offset.</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  No. of napi packets processed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">get_block</span><span class="p">,</span> <span class="n">put_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_curr_get_info</span> <span class="n">get_info</span><span class="p">,</span> <span class="n">put_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">napi_pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="n">rxdp1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="n">rxdp3</span><span class="p">;</span>

	<span class="n">get_info</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">;</span>
	<span class="n">get_block</span> <span class="o">=</span> <span class="n">get_info</span><span class="p">.</span><span class="n">block_index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">put_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_put_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">put_info</span><span class="p">));</span>
	<span class="n">put_block</span> <span class="o">=</span> <span class="n">put_info</span><span class="p">.</span><span class="n">block_index</span><span class="p">;</span>
	<span class="n">rxdp</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">get_block</span><span class="p">].</span><span class="n">rxds</span><span class="p">[</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">RXD_IS_UP2DT</span><span class="p">(</span><span class="n">rxdp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If your are next to put index then it&#39;s</span>
<span class="cm">		 * FIFO full condition</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">get_block</span> <span class="o">==</span> <span class="n">put_block</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">put_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INTR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Ring Full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: NULL skb in Rx Intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxdp1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span>
					 <span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">,</span>
					 <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
					 <span class="n">HEADER_ETHERNET_II_802_3_SIZE</span> <span class="o">+</span>
					 <span class="n">HEADER_802_2_SIZE</span> <span class="o">+</span>
					 <span class="n">HEADER_SNAP_SIZE</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxdp3</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">,</span>
						    <span class="n">BUF0_LEN</span><span class="p">,</span>
						    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span><span class="p">,</span>
					 <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">rx_osm_handler</span><span class="p">(</span><span class="n">ring_data</span><span class="p">,</span> <span class="n">rxdp</span><span class="p">);</span>
		<span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">rxdp</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">get_block</span><span class="p">].</span>
			<span class="n">rxds</span><span class="p">[</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">get_block</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_block</span> <span class="o">==</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">block_count</span><span class="p">)</span>
				<span class="n">get_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">block_index</span> <span class="o">=</span> <span class="n">get_block</span><span class="p">;</span>
			<span class="n">rxdp</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">get_block</span><span class="p">].</span><span class="n">block_virt_addr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">budget</span><span class="o">--</span><span class="p">;</span>
			<span class="n">napi_pkts</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">budget</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pkt_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">indicate_max_pkts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_cnt</span> <span class="o">&gt;</span> <span class="n">indicate_max_pkts</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear all LRO sessions before exiting */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LRO_SESSIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro0_n</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">update_L3L4_header</span><span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">,</span> <span class="n">lro</span><span class="p">);</span>
				<span class="n">queue_rx_frame</span><span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>
				<span class="n">clear_lro_session</span><span class="p">(</span><span class="n">lro</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">napi_pkts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  tx_intr_handler - Transmit interrupt handler</span>
<span class="cm"> *  @nic : device private variable</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  If an interrupt was raised to indicate DMA complete of the</span>
<span class="cm"> *  Tx packet, this function is called. It identifies the last TxD</span>
<span class="cm"> *  whose buffer was freed and frees all skbs whose data have already</span>
<span class="cm"> *  DMA&#39;ed into the NICs internal memory.</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  NONE</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_intr_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_curr_get_info</span> <span class="n">get_info</span><span class="p">,</span> <span class="n">put_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxD</span> <span class="o">*</span><span class="n">txdlp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">get_info</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">tx_curr_get_info</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">put_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">put_info</span><span class="p">));</span>
	<span class="n">txdlp</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">].</span><span class="n">list_virt_addr</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">txdlp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">TXD_LIST_OWN_XENA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">put_info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">txdlp</span><span class="o">-&gt;</span><span class="n">Host_Control</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check for TxD errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txdlp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">TXD_T_CODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">txdlp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">TXD_T_CODE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">parity_err_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* update t_code statistics */</span>
			<span class="n">err_mask</span> <span class="o">=</span> <span class="n">err</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_buf_abort_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_desc_abort_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_parity_err_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_link_loss_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mi">15</span>:
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_list_proc_err_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">s2io_txdl_getskb</span><span class="p">(</span><span class="n">fifo_data</span><span class="p">,</span> <span class="n">txdlp</span><span class="p">,</span> <span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: NULL skb in Tx Free Intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pkt_cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Updating the statistics block */</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">get_info</span><span class="p">.</span><span class="n">fifo_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txdlp</span> <span class="o">=</span> <span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">].</span><span class="n">list_virt_addr</span><span class="p">;</span>
		<span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">tx_curr_get_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s2io_wake_tx_queue</span><span class="p">(</span><span class="n">fifo_data</span><span class="p">,</span> <span class="n">pkt_cnt</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo_data</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_mdio_write - Function to write in to MDIO registers</span>
<span class="cm"> *  @mmd_type : MMD type value (PMA/PMD/WIS/PCS/PHYXS)</span>
<span class="cm"> *  @addr     : address value</span>
<span class="cm"> *  @value    : data value</span>
<span class="cm"> *  @dev      : pointer to net_device structure</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is used to write values to the MDIO registers</span>
<span class="cm"> *  NONE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_mdio_write</span><span class="p">(</span><span class="n">u32</span> <span class="n">mmd_type</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="cm">/* address transaction */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">MDIO_MMD_INDX_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMD_DEV_ADDR</span><span class="p">(</span><span class="n">mmd_type</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMS_PRT_ADDR</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">|</span> <span class="n">MDIO_CTRL_START_TRANS</span><span class="p">(</span><span class="mh">0xE</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Data transaction */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">MDIO_MMD_INDX_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMD_DEV_ADDR</span><span class="p">(</span><span class="n">mmd_type</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMS_PRT_ADDR</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MDIO_DATA</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_OP</span><span class="p">(</span><span class="n">MDIO_OP_WRITE_TRANS</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">|</span> <span class="n">MDIO_CTRL_START_TRANS</span><span class="p">(</span><span class="mh">0xE</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">MDIO_MMD_INDX_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMD_DEV_ADDR</span><span class="p">(</span><span class="n">mmd_type</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMS_PRT_ADDR</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_OP</span><span class="p">(</span><span class="n">MDIO_OP_READ_TRANS</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">|</span> <span class="n">MDIO_CTRL_START_TRANS</span><span class="p">(</span><span class="mh">0xE</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_mdio_read - Function to write in to MDIO registers</span>
<span class="cm"> *  @mmd_type : MMD type value (PMA/PMD/WIS/PCS/PHYXS)</span>
<span class="cm"> *  @addr     : address value</span>
<span class="cm"> *  @dev      : pointer to net_device structure</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is used to read values to the MDIO registers</span>
<span class="cm"> *  NONE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">s2io_mdio_read</span><span class="p">(</span><span class="n">u32</span> <span class="n">mmd_type</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rval64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="cm">/* address transaction */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">|</span> <span class="p">(</span><span class="n">MDIO_MMD_INDX_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
			 <span class="o">|</span> <span class="n">MDIO_MMD_DEV_ADDR</span><span class="p">(</span><span class="n">mmd_type</span><span class="p">)</span>
			 <span class="o">|</span> <span class="n">MDIO_MMS_PRT_ADDR</span><span class="p">(</span><span class="mh">0x0</span><span class="p">));</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">|</span> <span class="n">MDIO_CTRL_START_TRANS</span><span class="p">(</span><span class="mh">0xE</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Data transaction */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">MDIO_MMD_INDX_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMD_DEV_ADDR</span><span class="p">(</span><span class="n">mmd_type</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_MMS_PRT_ADDR</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">MDIO_OP</span><span class="p">(</span><span class="n">MDIO_OP_READ_TRANS</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">|</span> <span class="n">MDIO_CTRL_START_TRANS</span><span class="p">(</span><span class="mh">0xE</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Read the value from regs */</span>
	<span class="n">rval64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mdio_control</span><span class="p">);</span>
	<span class="n">rval64</span> <span class="o">=</span> <span class="n">rval64</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">;</span>
	<span class="n">rval64</span> <span class="o">=</span> <span class="n">rval64</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rval64</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_chk_xpak_counter - Function to check the status of the xpak counters</span>
<span class="cm"> *  @counter      : counter value to be updated</span>
<span class="cm"> *  @flag         : flag to indicate the status</span>
<span class="cm"> *  @type         : counter type</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is to check the status of the xpak counters value</span>
<span class="cm"> *  NONE</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_chk_xpak_counter</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">counter</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span> <span class="n">regs_stat</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">flag</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="o">*</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="o">*</span><span class="n">regs_stat</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;Take Xframe NIC out of service.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
<span class="s">&quot;Excessive temperatures may result in premature transceiver failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;Take Xframe NIC out of service.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
<span class="s">&quot;Excessive bias currents may indicate imminent laser diode failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;Take Xframe NIC out of service.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
<span class="s">&quot;Excessive laser output power may saturate far-end receiver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;Incorrect XPAK Alarm type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">regs_stat</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">regs_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">val64</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">regs_stat</span> <span class="o">=</span> <span class="o">*</span><span class="n">regs_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_updt_xpak_counter - Function to update the xpak counters</span>
<span class="cm"> *  @dev         : pointer to net_device struct</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is to upate the status of the xpak counters value</span>
<span class="cm"> *  NONE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_updt_xpak_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flag</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpakStat</span> <span class="o">*</span><span class="n">xstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">xpak_stat</span><span class="p">;</span>

	<span class="cm">/* Check the communication with the MDIO slave */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">MDIO_CTRL1</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">s2io_mdio_read</span><span class="p">(</span><span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val64</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val64</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;ERR: MDIO slave access failed - Returned %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for the expected value of control reg 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="n">MDIO_CTRL1_SPEED10G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Incorrect value at PMA address 0x0000 - &quot;</span>
			  <span class="s">&quot;Returned: %llx- Expected: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">,</span> <span class="n">MDIO_CTRL1_SPEED10G</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Loading the DOM register to MDIO register */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mh">0xA100</span><span class="p">;</span>
	<span class="n">s2io_mdio_write</span><span class="p">(</span><span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val16</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">s2io_mdio_read</span><span class="p">(</span><span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Reading the Alarm flags */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mh">0xA070</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">s2io_mdio_read</span><span class="p">(</span><span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">flag</span> <span class="o">=</span> <span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s2io_chk_xpak_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_transceiver_temp_high</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">xstats</span><span class="o">-&gt;</span><span class="n">xpak_regs_stat</span><span class="p">,</span>
			      <span class="mh">0x0</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_transceiver_temp_low</span><span class="o">++</span><span class="p">;</span>

	<span class="n">flag</span> <span class="o">=</span> <span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">s2io_chk_xpak_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_bias_current_high</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">xstats</span><span class="o">-&gt;</span><span class="n">xpak_regs_stat</span><span class="p">,</span>
			      <span class="mh">0x2</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_bias_current_low</span><span class="o">++</span><span class="p">;</span>

	<span class="n">flag</span> <span class="o">=</span> <span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">s2io_chk_xpak_counter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_output_power_high</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">xstats</span><span class="o">-&gt;</span><span class="n">xpak_regs_stat</span><span class="p">,</span>
			      <span class="mh">0x4</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_output_power_low</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Reading the Warning flags */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="mh">0xA074</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">s2io_mdio_read</span><span class="p">(</span><span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_transceiver_temp_high</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_transceiver_temp_low</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_bias_current_high</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_bias_current_low</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_output_power_high</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECKBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span>
		<span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_output_power_low</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  wait_for_cmd_complete - waits for a command to complete.</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *  s2io_nic structure.</span>
<span class="cm"> *  Description: Function that waits for a command to Write into RMAC</span>
<span class="cm"> *  ADDR DATA registers to be completed and returns either success or</span>
<span class="cm"> *  error depending on whether the command was complete or not.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *   SUCCESS on success and FAILURE on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_cmd_complete</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">busy_bit</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">bit_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">FAILURE</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bit_state</span> <span class="o">!=</span> <span class="n">S2IO_BIT_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bit_state</span> <span class="o">!=</span> <span class="n">S2IO_BIT_SET</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit_state</span> <span class="o">==</span> <span class="n">S2IO_BIT_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">busy_bit</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">busy_bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * check_pci_device_id - Checks if the device id is supported</span>
<span class="cm"> * @id : device id</span>
<span class="cm"> * Description: Function to check if the pci device id is supported by driver.</span>
<span class="cm"> * Return value: Actual device id if supported else PCI_ANY_ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">check_pci_device_id</span><span class="p">(</span><span class="n">u16</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_HERC_WIN</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_HERC_UNI</span>:
		<span class="k">return</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_S2IO_UNI</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_S2IO_WIN</span>:
		<span class="k">return</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">PCI_ANY_ID</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_reset - Resets the card.</span>
<span class="cm"> *  @sp : private member of the device structure.</span>
<span class="cm"> *  Description: Function to Reset the card. This function then also</span>
<span class="cm"> *  restores the previously saved PCI configuration space registers as</span>
<span class="cm"> *  the card reset also resets the configuration space.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  void.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subid</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">up_cnt</span><span class="p">,</span> <span class="n">down_cnt</span><span class="p">,</span> <span class="n">up_time</span><span class="p">,</span> <span class="n">down_time</span><span class="p">,</span> <span class="n">reset_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">mem_alloc_cnt</span><span class="p">,</span> <span class="n">mem_free_cnt</span><span class="p">,</span> <span class="n">watchdog_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span><span class="p">;</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Resetting XFrame card %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">__func__</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>

	<span class="cm">/* Back up  the PCI-X CMD reg, dont want to lose MMRBC, OST settings */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIX_COMMAND_REGISTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pci_cmd</span><span class="p">));</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">SW_RESET_ALL</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sw_reset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="s">&quot;CX4&quot;</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">S2IO_MAX_PCI_CONFIG_SPACE_REINIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Restore the PCI state saved during initialization. */</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_pci_device_id</span><span class="p">(</span><span class="n">val16</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">PCI_ANY_ID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_pci_device_id</span><span class="p">(</span><span class="n">val16</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">PCI_ANY_ID</span><span class="p">)</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s SW_Reset failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIX_COMMAND_REGISTER</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>

	<span class="n">s2io_init_pci</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Set swapper to enable I/O register access */</span>
	<span class="n">s2io_set_swapper</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* restore mac_addr entries */</span>
	<span class="n">do_s2io_restore_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Restore the MSIX table entries from local variables */</span>
	<span class="n">restore_xmsi_data</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Clear certain PCI/PCI-X fields after reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear &quot;detected parity error&quot; bit */</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

		<span class="cm">/* Clearing PCIX Ecc status register */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">);</span>

		<span class="cm">/* Clearing PCI_STATUS error reflected here */</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">s2BIT</span><span class="p">(</span><span class="mi">62</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">txpic_int_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset device statistics maintained by OS */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">));</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="cm">/* save link up/down time/cnt, reset/memory/watchdog cnt */</span>
	<span class="n">up_cnt</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_cnt</span><span class="p">;</span>
	<span class="n">down_cnt</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span><span class="p">;</span>
	<span class="n">up_time</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_time</span><span class="p">;</span>
	<span class="n">down_time</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_time</span><span class="p">;</span>
	<span class="n">reset_cnt</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">soft_reset_cnt</span><span class="p">;</span>
	<span class="n">mem_alloc_cnt</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span><span class="p">;</span>
	<span class="n">mem_free_cnt</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span><span class="p">;</span>
	<span class="n">watchdog_cnt</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">watchdog_timer_cnt</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stat_block</span><span class="p">));</span>

	<span class="cm">/* restore link up/down time/cnt, reset/memory/watchdog cnt */</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_cnt</span> <span class="o">=</span> <span class="n">up_cnt</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span> <span class="o">=</span> <span class="n">down_cnt</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_time</span> <span class="o">=</span> <span class="n">up_time</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_time</span> <span class="o">=</span> <span class="n">down_time</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">soft_reset_cnt</span> <span class="o">=</span> <span class="n">reset_cnt</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">=</span> <span class="n">mem_alloc_cnt</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">=</span> <span class="n">mem_free_cnt</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">watchdog_timer_cnt</span> <span class="o">=</span> <span class="n">watchdog_cnt</span><span class="p">;</span>

	<span class="cm">/* SXE-002: Configure link and activity LED to turn it off */</span>
	<span class="n">subid</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">subid</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="mh">0x0000800000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0411040400000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bar0</span> <span class="o">+</span> <span class="mh">0x2700</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear spurious ECC interrupts that would have occurred on</span>
<span class="cm">	 * XFRAME II cards after reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pcc_err_reg</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pcc_err_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_enabled_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_set_swapper - to set the swapper controle on the card</span>
<span class="cm"> *  @sp : private member of the device structure,</span>
<span class="cm"> *  pointer to the s2io_nic structure.</span>
<span class="cm"> *  Description: Function to set the swapper control on the card</span>
<span class="cm"> *  correctly depending on the &#39;endianness&#39; of the system.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  SUCCESS on success and FAILURE on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_set_swapper</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">,</span> <span class="n">valt</span><span class="p">,</span> <span class="n">valr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set proper endian settings and verify the same by reading</span>
<span class="cm">	 * the PIF Feed-back register.</span>
<span class="cm">	 */</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pif_rd_swapper_fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0x0123456789ABCDEFULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">value</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0xC30000C3C30000C3ULL</span><span class="p">,</span>	<span class="cm">/* FE=1, SE=1 */</span>
			<span class="mh">0x8100008181000081ULL</span><span class="p">,</span>	<span class="cm">/* FE=1, SE=0 */</span>
			<span class="mh">0x4200004242000042ULL</span><span class="p">,</span>	<span class="cm">/* FE=0, SE=1 */</span>
			<span class="mi">0</span>			<span class="cm">/* FE=0, SE=0 */</span>
		<span class="p">};</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pif_rd_swapper_fb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">==</span> <span class="mh">0x0123456789ABCDEFULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Endian settings are wrong, &quot;</span>
				  <span class="s">&quot;feedback read %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">valr</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">valr</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">valt</span> <span class="o">=</span> <span class="mh">0x0123456789ABCDEFULL</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">valt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_address</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="n">valt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">value</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0x00C3C30000C3C300ULL</span><span class="p">,</span>	<span class="cm">/* FE=1, SE=1 */</span>
			<span class="mh">0x0081810000818100ULL</span><span class="p">,</span>	<span class="cm">/* FE=1, SE=0 */</span>
			<span class="mh">0x0042420000424200ULL</span><span class="p">,</span>	<span class="cm">/* FE=0, SE=1 */</span>
			<span class="mi">0</span>			<span class="cm">/* FE=0, SE=0 */</span>
		<span class="p">};</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeq</span><span class="p">((</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">valr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">valt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_address</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">==</span> <span class="n">valt</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">x</span> <span class="o">=</span> <span class="n">val64</span><span class="p">;</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;Write failed, Xmsi_addr reads:0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF000000000000ULL</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/*</span>
<span class="cm">	 * The device by default set to a big endian format, so a</span>
<span class="cm">	 * big endian driver need not set anything.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SWAPPER_CTRL_TXP_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXP_SE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXD_R_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXD_W_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXF_R_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXD_R_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXD_W_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXF_W_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_XMSI_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_STATS_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_STATS_SE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">SWAPPER_CTRL_XMSI_SE</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initially we enable all bits to make it accessible by the</span>
<span class="cm">	 * driver, then we selectively enable only those bits that</span>
<span class="cm">	 * we want to set.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SWAPPER_CTRL_TXP_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXP_SE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXD_R_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXD_R_SE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXD_W_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXD_W_SE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_TXF_R_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXD_R_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXD_R_SE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXD_W_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXD_W_SE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_RXF_W_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_XMSI_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_STATS_FE</span> <span class="o">|</span>
		  <span class="n">SWAPPER_CTRL_STATS_SE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">SWAPPER_CTRL_XMSI_SE</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">swapper_ctrl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verifying if endian settings are accurate by reading a</span>
<span class="cm">	 * feedback register.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pif_rd_swapper_fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0x0123456789ABCDEFULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Endian settings are incorrect, calls for another dekko. */</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: Endian settings are wrong, feedback read %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_msix_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_access</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">s2BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;XMSI # %d Access failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restore_xmsi_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REQUESTED_MSI_X</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msix_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_address</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_data</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">s2BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">vBIT</span><span class="p">(</span><span class="n">msix_index</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_access</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_msix_trans</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: index: %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">store_xmsi_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Store and display */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REQUESTED_MSI_X</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msix_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="p">(</span><span class="n">s2BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">vBIT</span><span class="p">(</span><span class="n">msix_index</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_access</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_msix_trans</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: index: %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">,</span> <span class="n">msix_index</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_address</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_enable_msi_x</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_mat</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">msi_control</span><span class="p">;</span> <span class="cm">/* Temp variable */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">msix_indx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_msix_entry</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span>
			<span class="o">+=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="n">MSIX_FLG</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">MSIX_ALARM_TYPE</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">fifos</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_mat</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_mat</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_mat</span> <span class="o">|=</span> <span class="n">RX_MAT_SET</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">msix_indx</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">rings</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">MSIX_RING_TYPE</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="n">MSIX_FLG</span><span class="p">;</span>
		<span class="n">msix_indx</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">rx_mat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_mat</span><span class="p">);</span>
	<span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_mat</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">);</span>
	<span class="cm">/* We fail init if error or we get less vectors than min required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Enabling MSI-X failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_msix_entry</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">s2io_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * To enable MSI-X, MSI also needs to be enabled, due to a bug</span>
<span class="cm">	 * in the herc NIC. (Temp change, needs to be removed later)</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msi_control</span><span class="p">);</span>
	<span class="n">msi_control</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* Enable MSI */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">msi_control</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle software interrupt used during MSI(X) test */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s2io_test_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test interrupt path by forcing a a software IRQ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_test_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">,</span> <span class="n">saved64</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">s2io_test_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: PCI %s: cannot assign irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_wait</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">saved64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">scheduled_int_ctrl</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">SCHED_INT_CTRL_ONE_SHOT</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">SCHED_INT_CTRL_TIMER_EN</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">SCHED_INT_CTRL_INT2MSI</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">scheduled_int_ctrl</span><span class="p">);</span>

	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_wait</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_detected</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">msi_detected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* MSI(X) test failed, go back to INTx mode */</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: PCI %s: No interrupt was generated &quot;</span>
			  <span class="s">&quot;using MSI(X) during test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">saved64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">scheduled_int_ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_msix_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">msi_control</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span> <span class="o">==</span> <span class="n">MSIX_REGISTERED_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arg</span><span class="p">;</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msi_control</span><span class="p">);</span>
	<span class="n">msi_control</span> <span class="o">&amp;=</span> <span class="mh">0xFFFE</span><span class="p">;</span> <span class="cm">/* Disable MSI */</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">msi_control</span><span class="p">);</span>

	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_inta_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ********************************************************* *</span>
<span class="cm"> * Functions defined below concern the OS part of the driver *</span>
<span class="cm"> * ********************************************************* */</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_open - open entry point of the driver</span>
<span class="cm"> *  @dev : pointer to the device structure.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is the open entry point of the driver. It mainly calls a</span>
<span class="cm"> *  function to allocate Rx buffers and inserts them into the buffer</span>
<span class="cm"> *  descriptors and then enables the Rx part of the NIC.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  0 on success and an appropriate (-)ve integer as defined in errno.h</span>
<span class="cm"> *   file on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure you have link off by default every time</span>
<span class="cm">	 * Nic is initialized</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">last_link_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize H/W and enable interrupts */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: H/W initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">hw_init_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_prog_unicast</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Set Mac Address Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">hw_init_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s2io_start_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">hw_init_failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">);</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_msix_entry</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_close -close entry point of the driver</span>
<span class="cm"> *  @dev : device pointer.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This is the stop entry point of the driver. It needs to undo exactly</span>
<span class="cm"> *  whatever was done by the open entry point,thus it&#39;s usually referred to</span>
<span class="cm"> *  as the close function.Among other things this function mainly stops the</span>
<span class="cm"> *  Rx side of the NIC and frees all the Rx buffers in the Rx rings.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  0 on success and an appropriate (-)ve integer as defined in errno.h</span>
<span class="cm"> *  file on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* Return if the device is already closed               *</span>
<span class="cm">	 *  Can happen when s2io_card_up failed in change_mtu    *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="cm">/* delete all populated mac entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp64</span> <span class="o">=</span> <span class="n">do_s2io_read_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">!=</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">)</span>
			<span class="n">do_s2io_delete_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">tmp64</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_xmit - Tx entry point of te driver</span>
<span class="cm"> *  @skb : the socket buffer containing the Tx data.</span>
<span class="cm"> *  @dev : device pointer.</span>
<span class="cm"> *  Description :</span>
<span class="cm"> *  This function is the Tx entry point of the driver. S2IO NIC supports</span>
<span class="cm"> *  certain protocol assist features on Tx side, namely  CSO, S/G, LSO.</span>
<span class="cm"> *  NOTE: when device can&#39;t queue the pkt,just the trans_start variable will</span>
<span class="cm"> *  not be upadted.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  0 on success &amp; 1 on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">s2io_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">frg_cnt</span><span class="p">,</span> <span class="n">frg_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">queue_len</span><span class="p">,</span> <span class="n">put_off</span><span class="p">,</span> <span class="n">get_off</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxD</span> <span class="o">*</span><span class="n">txdp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxFIFO_element</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tx_fifo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_spin_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offload_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_per_list_interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">TX_DBG</span><span class="p">,</span> <span class="s">&quot;%s: In Neterion Tx routine</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">TX_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Buffer has no data..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">TX_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Card going down for reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">==</span> <span class="n">TX_DEFAULT_STEERING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>
			<span class="n">ip</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_is_fragment</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span>
						       <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">queue_len</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_tcp_fifos</span><span class="p">;</span>
					<span class="n">queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span>
						 <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">))</span> <span class="o">&amp;</span>
						<span class="n">sp</span><span class="o">-&gt;</span><span class="n">fifo_selector</span><span class="p">[</span><span class="n">queue_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">queue_len</span><span class="p">)</span>
						<span class="n">queue</span> <span class="o">=</span> <span class="n">queue_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">queue_len</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_udp_fifos</span><span class="p">;</span>
					<span class="n">queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span>
						 <span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">))</span> <span class="o">&amp;</span>
						<span class="n">sp</span><span class="o">-&gt;</span><span class="n">fifo_selector</span><span class="p">[</span><span class="n">queue_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">queue_len</span><span class="p">)</span>
						<span class="n">queue</span> <span class="o">=</span> <span class="n">queue_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">queue</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">udp_fifo_idx</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span>
						<span class="n">enable_per_list_interrupt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">do_spin_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">==</span> <span class="n">TX_PRIORITY_STEERING</span><span class="p">)</span>
		<span class="cm">/* get fifo number based on skb-&gt;priority value */</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fifo_mapping</span>
			<span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAX_TX_FIFOS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
	<span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_spin_lock</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_LOCKED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__netif_subqueue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">queue_state</span> <span class="o">==</span> <span class="n">FIFO_QUEUE_STOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">put_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">get_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">txdp</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">put_off</span><span class="p">].</span><span class="n">list_virt_addr</span><span class="p">;</span>

	<span class="n">queue_len</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">fifo_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Avoid &quot;put&quot; pointer going beyond &quot;get&quot; pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">put_off</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">queue_len</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">put_off</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">get_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">TX_DBG</span><span class="p">,</span> <span class="s">&quot;Error in xmit, No free TXDs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">s2io_stop_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offload_type</span> <span class="o">=</span> <span class="n">s2io_offload_type</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SKB_GSO_TCPV4</span> <span class="o">|</span> <span class="n">SKB_GSO_TCPV6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_TCP_LSO_EN</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_TCP_LSO_MSS</span><span class="p">(</span><span class="n">s2io_tcp_mss</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TXD_TX_CKO_IPV4_EN</span> <span class="o">|</span>
				    <span class="n">TXD_TX_CKO_TCP_EN</span> <span class="o">|</span>
				    <span class="n">TXD_TX_CKO_UDP_EN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_GATHER_CODE_FIRST</span><span class="p">;</span>
	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_LIST_OWN_XENA</span><span class="p">;</span>
	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">TXD_INT_NUMBER</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_per_list_interrupt</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">queue_len</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">TXD_INT_TYPE_PER_LIST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">TXD_VLAN_ENABLE</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">TXD_VLAN_TAG</span><span class="p">(</span><span class="n">vlan_tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">frg_len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span> <span class="o">==</span> <span class="n">SKB_GSO_UDP</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ufo_size</span><span class="p">;</span>

		<span class="n">ufo_size</span> <span class="o">=</span> <span class="n">s2io_udp_mss</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ufo_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_UFO_EN</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_UFO_MSS</span><span class="p">(</span><span class="n">ufo_size</span><span class="p">);</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_BUFFER0_SIZE</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="cm">/* both variants do cpu_to_be64(be32_to_cpu(...)) */</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">[</span><span class="n">put_off</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">__force</span> <span class="n">u64</span><span class="p">)</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ip6_frag_id</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">[</span><span class="n">put_off</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">__force</span> <span class="n">u64</span><span class="p">)</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ip6_frag_id</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						      <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ufo_in_band_v</span><span class="p">,</span>
						      <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
						      <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">pci_map_failed</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">frg_len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">pci_map_failed</span><span class="p">;</span>

	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_BUFFER0_SIZE</span><span class="p">(</span><span class="n">frg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span> <span class="o">==</span> <span class="n">SKB_GSO_UDP</span><span class="p">)</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_UFO_EN</span><span class="p">;</span>

	<span class="n">frg_cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="cm">/* For fragmented SKB. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frg_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* A &#39;0&#39; length fragment will be ignored */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Buffer_Pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							     <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							     <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
							     <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">=</span> <span class="n">TXD_BUFFER0_SIZE</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span> <span class="o">==</span> <span class="n">SKB_GSO_UDP</span><span class="p">)</span>
			<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_UFO_EN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">txdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">TXD_GATHER_CODE_LAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span> <span class="o">==</span> <span class="n">SKB_GSO_UDP</span><span class="p">)</span>
		<span class="n">frg_cnt</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* as Txd0 was used for inband header */</span>

	<span class="n">tx_fifo</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">tx_FIFO_start</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">list_info</span><span class="p">[</span><span class="n">put_off</span><span class="p">].</span><span class="n">list_phy_addr</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_fifo</span><span class="o">-&gt;</span><span class="n">TxDL_Pointer</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="p">(</span><span class="n">TX_FIFO_LAST_TXD_NUM</span><span class="p">(</span><span class="n">frg_cnt</span><span class="p">)</span> <span class="o">|</span> <span class="n">TX_FIFO_FIRST_LIST</span> <span class="o">|</span>
		 <span class="n">TX_FIFO_LAST_LIST</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">TX_FIFO_SPECIAL_FUNC</span><span class="p">;</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_fifo</span><span class="o">-&gt;</span><span class="n">List_Control</span><span class="p">);</span>

	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="n">put_off</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_off</span> <span class="o">==</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">fifo_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">put_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_curr_put_info</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">put_off</span><span class="p">;</span>

	<span class="cm">/* Avoid &quot;put&quot; pointer going beyond &quot;get&quot; pointer */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">put_off</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">queue_len</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">put_off</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">get_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">fifo_full_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">TX_DBG</span><span class="p">,</span>
			  <span class="s">&quot;No free TxDs for xmit, Put: 0x%x Get:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">put_off</span><span class="p">,</span> <span class="n">get_off</span><span class="p">);</span>
		<span class="n">s2io_stop_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">tx_intr_handler</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">pci_map_failed:</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">pci_map_fail_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">s2io_stop_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">fifo_no</span><span class="p">);</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">s2io_alarm_handle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">s2io_handle_errors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">alarm_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s2io_msix_ring_handle</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">val8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_mask_reg</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_no</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ring_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x7f</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">val8</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">val8</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_intr_handler</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">s2io_chk_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s2io_msix_fifo_handle</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">fifos</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reason</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">S2IO_MINUS_ONE</span><span class="p">))</span>
		<span class="cm">/* Nothing much can be done. Get out */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GEN_INTR_TXPIC</span> <span class="o">|</span> <span class="n">GEN_INTR_TXTRAFFIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">GEN_INTR_TXPIC</span><span class="p">)</span>
			<span class="n">s2io_txpic_intr_handle</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">GEN_INTR_TXTRAFFIC</span><span class="p">)</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_traffic_int</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tx_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* The interrupt was not raised by us */</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_txpic_intr_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pic_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">PIC_INT_GPIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">GPIO_INT_REG_LINK_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">GPIO_INT_REG_LINK_UP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This is unstable state so clear both up/down</span>
<span class="cm">			 * interrupt and adapter to re-evaluate the link state.</span>
<span class="cm">			 */</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">GPIO_INT_REG_LINK_DOWN</span><span class="p">;</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">GPIO_INT_REG_LINK_UP</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_reg</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GPIO_INT_MASK_LINK_UP</span> <span class="o">|</span>
				   <span class="n">GPIO_INT_MASK_LINK_DOWN</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">GPIO_INT_REG_LINK_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
			<span class="cm">/* Enable Adapter */</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_CNTL_EN</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_LED_ON</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_enabled_once</span><span class="p">)</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_enabled_once</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">s2io_link</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">LINK_UP</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * unmask link down interrupt and mask link-up</span>
<span class="cm">			 * intr</span>
<span class="cm">			 */</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_INT_MASK_LINK_DOWN</span><span class="p">;</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">GPIO_INT_MASK_LINK_UP</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">GPIO_INT_REG_LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
			<span class="n">s2io_link</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">LINK_DOWN</span><span class="p">);</span>
			<span class="cm">/* Link is down so unmaks link up interrupt */</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_INT_MASK_LINK_UP</span><span class="p">;</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">GPIO_INT_MASK_LINK_DOWN</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>

			<span class="cm">/* turn off LED */</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ADAPTER_LED_ON</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  do_s2io_chk_alarm_bit - Check for alarm and incrment the counter</span>
<span class="cm"> *  @value: alarm bits</span>
<span class="cm"> *  @addr: address value</span>
<span class="cm"> *  @cnt: counter variable</span>
<span class="cm"> *  Description: Check for alarm and increment the counter</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  1 - if alarm bit set</span>
<span class="cm"> *  0 - if alarm bit is not set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">u64</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_handle_errors - Xframe error indication handler</span>
<span class="cm"> *  @nic: device private variable</span>
<span class="cm"> *  Description: Handle alarms such as loss of link, single or</span>
<span class="cm"> *  double ECC errors, critical and serious errors.</span>
<span class="cm"> *  Return Value:</span>
<span class="cm"> *  NONE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_handle_errors</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">temp64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">sw_stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpakStat</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">xpak_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">ring_full_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">ring_full_cnt</span><span class="p">));</span>

	<span class="cm">/* Handling the XPAK counters update */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">xpak_timer_count</span> <span class="o">&lt;</span> <span class="mi">72000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* waiting for an hour */</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">xpak_timer_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s2io_updt_xpak_counter</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* reset the count to zero */</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">xpak_timer_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handling link status change error Intr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_link_fault_indication</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="n">MAC_RMAC_ERR_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_reg</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RMAC_LINK_STATE_CHANGE_INT</span><span class="p">)</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">set_link_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* In case of a serious error, the device will be Reset. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">SERR_SOURCE_ANY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">serr_source</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">serious_err_cnt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>

	<span class="cm">/* Check for data parity error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">GPIO_INT_REG_DP_ERR_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_int_reg</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">parity_err_cnt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>

	<span class="cm">/* Check for ring full counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">ring_bump_counter1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp64</span> <span class="o">=</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">vBIT</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">temp64</span> <span class="o">&gt;&gt;=</span> <span class="mi">64</span> <span class="o">-</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
			<span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">ring_full_cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp64</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">ring_bump_counter2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp64</span> <span class="o">=</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">vBIT</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">16</span><span class="p">),</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">temp64</span> <span class="o">&gt;&gt;=</span> <span class="mi">64</span> <span class="o">-</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
			<span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">ring_full_cnt</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp64</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">txdma_int_status</span><span class="p">);</span>
	<span class="cm">/*check for pfc_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_PFC_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">PFC_ECC_DB_ERR</span> <span class="o">|</span> <span class="n">PFC_SM_ERR_ALARM</span> <span class="o">|</span>
					  <span class="n">PFC_MISC_0_ERR</span> <span class="o">|</span> <span class="n">PFC_MISC_1_ERR</span> <span class="o">|</span>
					  <span class="n">PFC_PCIX_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pfc_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">pfc_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">PFC_ECC_SG_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pfc_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">pfc_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*check for tda_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_TDA_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TDA_Fn_ECC_DB_ERR</span> <span class="o">|</span>
					  <span class="n">TDA_SM0_ERR_ALARM</span> <span class="o">|</span>
					  <span class="n">TDA_SM1_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tda_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">tda_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TDA_Fn_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TDA_PCIX_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tda_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">tda_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*check for pcc_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_PCC_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">PCC_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">PCC_WR_ERR_ALARM</span> <span class="o">|</span>
					  <span class="n">PCC_N_SERR</span> <span class="o">|</span> <span class="n">PCC_6_COF_OV_ERR</span> <span class="o">|</span>
					  <span class="n">PCC_7_COF_OV_ERR</span> <span class="o">|</span> <span class="n">PCC_6_LSO_OV_ERR</span> <span class="o">|</span>
					  <span class="n">PCC_7_LSO_OV_ERR</span> <span class="o">|</span> <span class="n">PCC_FB_ECC_DB_ERR</span> <span class="o">|</span>
					  <span class="n">PCC_TXB_ECC_DB_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pcc_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">pcc_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">PCC_FB_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">PCC_TXB_ECC_SG_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pcc_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">pcc_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*check for tti_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_TTI_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TTI_SM_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">tti_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TTI_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TTI_ECC_DB_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tti_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">tti_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*check for lso_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_LSO_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">LSO6_ABORT</span> <span class="o">|</span> <span class="n">LSO7_ABORT</span> <span class="o">|</span>
					  <span class="n">LSO6_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">LSO7_SM_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">lso_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">lso_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">LSO6_SEND_OFLOW</span> <span class="o">|</span> <span class="n">LSO7_SEND_OFLOW</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">lso_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">lso_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*check for tpa_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_TPA_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TPA_SM_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tpa_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">tpa_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TPA_TX_FRM_DROP</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tpa_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">tpa_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*check for sm_err*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">TXDMA_SM_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">SM_SM_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">sm_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">sm_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MAC_INT_STATUS_TMAC_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TMAC_TX_BUF_OVRN</span> <span class="o">|</span> <span class="n">TMAC_TX_SM_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_tmac_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">mac_tmac_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TMAC_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TMAC_ECC_DB_ERR</span> <span class="o">|</span>
				      <span class="n">TMAC_DESC_ECC_SG_ERR</span> <span class="o">|</span>
				      <span class="n">TMAC_DESC_ECC_DB_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_tmac_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">mac_tmac_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">XGXS_INT_STATUS_TXGXS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TXGXS_ESTORE_UFLOW</span> <span class="o">|</span> <span class="n">TXGXS_TX_SM_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_txgxs_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">xgxs_txgxs_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">TXGXS_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">TXGXS_ECC_DB_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_txgxs_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">xgxs_txgxs_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rxdma_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RXDMA_INT_RC_INT_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RC_PRCn_ECC_DB_ERR</span> <span class="o">|</span>
					  <span class="n">RC_FTC_ECC_DB_ERR</span> <span class="o">|</span>
					  <span class="n">RC_PRCn_SM_ERR_ALARM</span> <span class="o">|</span>
					  <span class="n">RC_FTC_SM_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rc_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rc_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RC_PRCn_ECC_SG_ERR</span> <span class="o">|</span>
				      <span class="n">RC_FTC_ECC_SG_ERR</span> <span class="o">|</span>
				      <span class="n">RC_RDA_FAIL_WR_Rn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rc_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rc_err_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">PRC_PCI_AB_RD_Rn</span> <span class="o">|</span>
					  <span class="n">PRC_PCI_AB_WR_Rn</span> <span class="o">|</span>
					  <span class="n">PRC_PCI_AB_F_WR_Rn</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">prc_pcix_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">prc_pcix_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">PRC_PCI_DP_RD_Rn</span> <span class="o">|</span>
				      <span class="n">PRC_PCI_DP_WR_Rn</span> <span class="o">|</span>
				      <span class="n">PRC_PCI_DP_F_WR_Rn</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">prc_pcix_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">prc_pcix_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RXDMA_INT_RPA_INT_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RPA_SM_ERR_ALARM</span> <span class="o">|</span> <span class="n">RPA_CREDIT_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rpa_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rpa_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RPA_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">RPA_ECC_DB_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rpa_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rpa_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RXDMA_INT_RDA_INT_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RDA_RXDn_ECC_DB_ERR</span> <span class="o">|</span>
					  <span class="n">RDA_FRM_ECC_DB_N_AERR</span> <span class="o">|</span>
					  <span class="n">RDA_SM1_ERR_ALARM</span> <span class="o">|</span>
					  <span class="n">RDA_SM0_ERR_ALARM</span> <span class="o">|</span>
					  <span class="n">RDA_RXD_ECC_DB_SERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rda_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rda_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RDA_RXDn_ECC_SG_ERR</span> <span class="o">|</span>
				      <span class="n">RDA_FRM_ECC_SG_ERR</span> <span class="o">|</span>
				      <span class="n">RDA_MISC_ERR</span> <span class="o">|</span>
				      <span class="n">RDA_PCIX_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rda_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rda_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RXDMA_INT_RTI_INT_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RTI_SM_ERR_ALARM</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rti_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RTI_ECC_SG_ERR</span> <span class="o">|</span> <span class="n">RTI_ECC_DB_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rti_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">rti_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MAC_INT_STATUS_RMAC_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RMAC_RX_BUFF_OVRN</span> <span class="o">|</span> <span class="n">RMAC_RX_SM_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
		<span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RMAC_UNUSED_INT</span> <span class="o">|</span>
				      <span class="n">RMAC_SINGLE_ECC_ERR</span> <span class="o">|</span>
				      <span class="n">RMAC_DOUBLE_ECC_ERR</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_reg</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">XGXS_INT_STATUS_RXGXS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">RXGXS_ESTORE_OFLOW</span> <span class="o">|</span> <span class="n">RXGXS_RX_SM_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_rxgxs_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">xgxs_rxgxs_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_int_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MC_INT_STATUS_MC_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_chk_alarm_bit</span><span class="p">(</span><span class="n">MC_ERR_REG_SM_ERR</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_err_reg</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">mc_err_cnt</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>

		<span class="cm">/* Handling Ecc errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MC_ERR_REG_ECC_ALL_SNG</span> <span class="o">|</span> <span class="n">MC_ERR_REG_ECC_ALL_DBL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_err_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MC_ERR_REG_ECC_ALL_DBL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">double_ecc_errs</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Reset XframeI only if critical error</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span>
					    <span class="p">(</span><span class="n">MC_ERR_REG_MIRI_ECC_DB_ERR_0</span> <span class="o">|</span>
					     <span class="n">MC_ERR_REG_MIRI_ECC_DB_ERR_1</span><span class="p">))</span>
						<span class="k">goto</span> <span class="n">reset</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">single_ecc_errs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">reset:</span>
	<span class="n">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rst_timer_task</span><span class="p">);</span>
	<span class="n">sw_stat</span><span class="o">-&gt;</span><span class="n">soft_reset_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_isr - ISR handler of the device .</span>
<span class="cm"> *  @irq: the irq of the device.</span>
<span class="cm"> *  @dev_id: a void pointer to the dev structure of the NIC.</span>
<span class="cm"> *  Description:  This function is the ISR handler of the device. It</span>
<span class="cm"> *  identifies the reason for the interrupt and calls the relevant</span>
<span class="cm"> *  service routines. As a contongency measure, this ISR allocates the</span>
<span class="cm"> *  recv buffers, if their numbers are below the panic value which is</span>
<span class="cm"> *  presently set to 25% of the original number of rcv buffers allocated.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *   IRQ_HANDLED: will be returned if IRQ was handled by this routine</span>
<span class="cm"> *   IRQ_NONE: will be returned if interrupt is not from our device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">s2io_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/* Pretend we handled any irq&#39;s from a disconnected card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify the cause for interrupt and call the appropriate</span>
<span class="cm">	 * interrupt handler. Causes for the interrupt could be;</span>
<span class="cm">	 * 1. Rx of packet.</span>
<span class="cm">	 * 2. Tx complete.</span>
<span class="cm">	 * 3. Link down.</span>
<span class="cm">	 */</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">S2IO_MINUS_ONE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>	<span class="cm">/* Nothing much can be done. Get out */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">GEN_INTR_RXTRAFFIC</span> <span class="o">|</span> <span class="n">GEN_INTR_TXTRAFFIC</span> <span class="o">|</span> <span class="n">GEN_INTR_TXPIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">GEN_INTR_RXTRAFFIC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
				<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_mask</span><span class="p">);</span>
				<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_int</span><span class="p">);</span>
				<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_int</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rx_traffic_int reg is an R1 register, writing all 1&#39;s</span>
<span class="cm">			 * will ensure that the actual interrupt causing bit</span>
<span class="cm">			 * get&#39;s cleared and hence a read can be avoided.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">GEN_INTR_RXTRAFFIC</span><span class="p">)</span>
				<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_traffic_int</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="n">rx_intr_handler</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * tx_traffic_int reg is an R1 register, writing all 1&#39;s</span>
<span class="cm">		 * will ensure that the actual interrupt causing bit get&#39;s</span>
<span class="cm">		 * cleared and hence a read can be avoided.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">GEN_INTR_TXTRAFFIC</span><span class="p">)</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">S2IO_MINUS_ONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">tx_traffic_int</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tx_intr_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">GEN_INTR_TXPIC</span><span class="p">)</span>
			<span class="n">s2io_txpic_intr_handle</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reallocate the buffers from the interrupt handler itself.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

				<span class="n">s2io_chk_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_mask</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">general_int_status</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The interrupt was not raised by us */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_updt_stats -</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_updt_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Apprx 30us on a 133 MHz bus */</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">SET_UPDT_CLICKS</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">STAT_CFG_ONE_SHOT_EN</span> <span class="o">|</span> <span class="n">STAT_CFG_STAT_EN</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">stat_cfg</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">stat_cfg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">s2BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* Updt failed */</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_get_stats - Updates the device statistics structure.</span>
<span class="cm"> *  @dev : pointer to the device structure.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function updates the device statistics structure in the s2io_nic</span>
<span class="cm"> *  structure and returns a pointer to the same.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  pointer to the updated net_device_stats structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">s2io_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">delta</span><span class="p">;</span>

	<span class="cm">/* Configure Stats for immediate updt */</span>
	<span class="n">s2io_updt_stats</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* A device reset will cause the on-adapter statistics to be zero&#39;ed.</span>
<span class="cm">	 * This can be done while running by changing the MTU.  To prevent the</span>
<span class="cm">	 * system from having the stats zero&#39;ed, the driver keeps a copy of the</span>
<span class="cm">	 * last update to the system (which is also zero&#39;ed on reset).  This</span>
<span class="cm">	 * enables the driver to accurately know the delta between the last</span>
<span class="cm">	 * update and the current update.</span>
<span class="cm">	 */</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_frms</span><span class="p">))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_frms</span><span class="p">))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_data_octets_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_data_octets</span><span class="p">))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_data_octets_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_data_octets</span><span class="p">))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_frms</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_any_err_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_any_err_frms</span><span class="p">))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_frms</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_drop_frms</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="cm">/* The adapter MAC interprets pause frames as multicast packets, but</span>
<span class="cm">	 * does not pass them up.  This erroneously increases the multicast</span>
<span class="cm">	 * packet count and needs to be deducted when the multicast frame count</span>
<span class="cm">	 * is queried.</span>
<span class="cm">	 */</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_mcst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_mcst_frms</span><span class="p">);</span>
	<span class="n">delta</span> <span class="o">-=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_pause_ctrl_frms</span><span class="p">);</span>
	<span class="n">delta</span> <span class="o">-=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_usized_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_usized_frms</span><span class="p">))</span> <span class="o">+</span>
		<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_long_frms</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_fcs_err_frms</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_set_multicast - entry point for multicast address enable/disable.</span>
<span class="cm"> *  @dev : pointer to the device structure</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is a driver entry point which gets called by the kernel</span>
<span class="cm"> *  whenever multicast addresses must be enabled/disabled. This also gets</span>
<span class="cm"> *  called to set/reset promiscuous mode. Depending on the deivce flag, we</span>
<span class="cm"> *  determine, if multicast address must be enabled or if promiscuous mode</span>
<span class="cm"> *  is to be disabled etc.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  void.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">prev_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">multi_mac</span> <span class="o">=</span> <span class="mh">0x010203040506ULL</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span>
		<span class="mh">0xfeffffffffffULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dis_addr</span> <span class="o">=</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">,</span> <span class="n">mac_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">add</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Enable all Multicast addresses */</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA0_MEM_ADDR</span><span class="p">(</span><span class="n">multi_mac</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA1_MEM_MASK</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data1_mem</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">RMAC_ADDR_CMD_MEM_WE</span> <span class="o">|</span>
			<span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
			<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>
		<span class="cm">/* Wait till command completes */</span>
		<span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
				      <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
				      <span class="n">S2IO_BIT_RESET</span><span class="p">);</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">all_multi_pos</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Disable all Multicast addresses */</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA0_MEM_ADDR</span><span class="p">(</span><span class="n">dis_addr</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA1_MEM_MASK</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data1_mem</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">RMAC_ADDR_CMD_MEM_WE</span> <span class="o">|</span>
			<span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
			<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">all_multi_pos</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>
		<span class="cm">/* Wait till command completes */</span>
		<span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
				      <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
				      <span class="n">S2IO_BIT_RESET</span><span class="p">);</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">all_multi_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">promisc_flg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Put the NIC into promiscuous mode */</span>
		<span class="n">add</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">MAC_CFG_RMAC_PROM_ENABLE</span><span class="p">;</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">val64</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tag_strip</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_PA_CFG_STRIP_VLAN_TAG</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">promisc_flg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: entered promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">promisc_flg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*  Remove the NIC from promiscuous mode */</span>
		<span class="n">add</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">;</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_CFG_RMAC_PROM_ENABLE</span><span class="p">;</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">val64</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_CFG_KEY</span><span class="p">(</span><span class="mh">0x4C0D</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_cfg_key</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="n">add</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tag_strip</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">RX_PA_CFG_STRIP_VLAN_TAG</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_pa_cfg</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mac_cfg</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">promisc_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: left promiscuous mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Update individual M_CAST address list */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span> <span class="o">-</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mac_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;%s: No more Rx filters can be added - &quot;</span>
				  <span class="s">&quot;please enable ALL_MULTI instead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prev_cnt</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mc_addr_count</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mc_addr_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Clear out the previous list of Mc in the H/W. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">prev_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA0_MEM_ADDR</span><span class="p">(</span><span class="n">dis_addr</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA1_MEM_MASK</span><span class="p">(</span><span class="mi">0ULL</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data1_mem</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">RMAC_ADDR_CMD_MEM_WE</span> <span class="o">|</span>
				<span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
				<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span>
				<span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">mc_start_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>

			<span class="cm">/* Wait for command completes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
						  <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
						  <span class="n">S2IO_BIT_RESET</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;%s: Adding Multicasts failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Create the new Rx filter list and update the same in H/W. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_addr</span> <span class="o">|=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">mac_addr</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mac_addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA0_MEM_ADDR</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA1_MEM_MASK</span><span class="p">(</span><span class="mi">0ULL</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data1_mem</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">RMAC_ADDR_CMD_MEM_WE</span> <span class="o">|</span>
				<span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
				<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">mc_start_offset</span><span class="p">);</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>

			<span class="cm">/* Wait for command completes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
						  <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
						  <span class="n">S2IO_BIT_RESET</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;%s: Adding Multicasts failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read from CAM unicast &amp; multicast addresses and store it in</span>
<span class="cm"> * def_mac_addr structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_s2io_store_unicast_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mac_addr</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/* store unicast &amp; multicast mac addresses */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">do_s2io_read_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="cm">/* if read fails disable the entry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span>
			<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">;</span>
		<span class="n">do_s2io_copy_mac_addr</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* restore unicast &amp; multicast MAC to CAM from def_mac_addr structure */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_s2io_restore_unicast_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="cm">/* restore unicast mac address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mac_addr</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
		<span class="n">do_s2io_prog_unicast</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">);</span>

	<span class="cm">/* restore multicast mac address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">mc_start_offset</span><span class="p">;</span>
	     <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
		<span class="n">do_s2io_add_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* add a multicast MAC address to CAM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_s2io_add_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mac_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_addr</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">mac_addr</span> <span class="o">|=</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0ULL</span> <span class="o">==</span> <span class="n">mac_addr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">==</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="cm">/* check if the multicast mac already preset in CAM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">mc_start_offset</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp64</span><span class="p">;</span>
		<span class="n">tmp64</span> <span class="o">=</span> <span class="n">do_s2io_read_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">==</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">)</span> <span class="cm">/* CAM entry is empty */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">==</span> <span class="n">mac_addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;CAM full no space left for multicast MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Update the internal structure with this new mac address */</span>
	<span class="n">do_s2io_copy_mac_addr</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">do_s2io_add_mac</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* add MAC address to CAM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_s2io_add_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">RMAC_ADDR_DATA0_MEM_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span>	<span class="n">RMAC_ADDR_CMD_MEM_WE</span> <span class="o">|</span> <span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
		<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>

	<span class="cm">/* Wait till command completes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
				  <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
				  <span class="n">S2IO_BIT_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;do_s2io_add_mac failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* deletes a specified unicast/multicast mac entry from CAM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_s2io_delete_unicast_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dis_addr</span> <span class="o">=</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">,</span> <span class="n">tmp64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	     <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp64</span> <span class="o">=</span> <span class="n">do_s2io_read_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable the entry by writing  0xffffffffffffULL */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_s2io_add_mac</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">dis_addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">==</span>  <span class="n">FAILURE</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
			<span class="cm">/* store the new mac list from CAM */</span>
			<span class="n">do_s2io_store_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;MAC address 0x%llx not found in CAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read mac entries from CAM */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="nf">do_s2io_read_unicast_mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tmp64</span> <span class="o">=</span> <span class="mh">0xffffffffffff0000ULL</span><span class="p">,</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="cm">/* read mac addr */</span>
	<span class="n">val64</span> <span class="o">=</span>	<span class="n">RMAC_ADDR_CMD_MEM_RD</span> <span class="o">|</span> <span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
		<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>

	<span class="cm">/* Wait till command completes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
				  <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
				  <span class="n">S2IO_BIT_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;do_s2io_read_unicast_mc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tmp64</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_set_mac_addr driver entry point</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* store the MAC address in CAM */</span>
	<span class="k">return</span> <span class="n">do_s2io_prog_unicast</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> *  do_s2io_prog_unicast - Programs the Xframe mac address</span>
<span class="cm"> *  @dev : pointer to the device structure.</span>
<span class="cm"> *  @addr: a uchar pointer to the new mac address which is to be set.</span>
<span class="cm"> *  Description : This procedure will program the Xframe to receive</span>
<span class="cm"> *  frames with new Mac Address</span>
<span class="cm"> *  Return value: SUCCESS on success and an appropriate (-)ve integer</span>
<span class="cm"> *  as defined in errno.h file on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_s2io_prog_unicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">mac_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">perm_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the new MAC address as the new unicast filter and reflect this</span>
<span class="cm">	 * change on the device address registered with the OS. It will be</span>
<span class="cm">	 * at offset 0.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_addr</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">mac_addr</span> <span class="o">|=</span> <span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">perm_addr</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">perm_addr</span> <span class="o">|=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* check if the dev_addr is different than perm_addr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span> <span class="o">==</span> <span class="n">perm_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="cm">/* check if the mac already preset in CAM */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mac_addr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp64</span> <span class="o">=</span> <span class="n">do_s2io_read_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">==</span> <span class="n">S2IO_DISABLE_MAC_ENTRY</span><span class="p">)</span> <span class="cm">/* CAM entry is empty */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">==</span> <span class="n">mac_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
				  <span class="s">&quot;MAC addr:0x%llx already present in CAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mac_addr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mac_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;CAM full no space left for Unicast MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Update the internal structure with this new mac address */</span>
	<span class="n">do_s2io_copy_mac_addr</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">do_s2io_add_mac</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_ethtool_sset - Sets different link parameters.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the  * s2io_nic structure.</span>
<span class="cm"> * @info: pointer to the structure with parameters given by ethtool to set</span>
<span class="cm"> * link information.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * The function sets different link parameters provided by the user onto</span>
<span class="cm"> * the NIC.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 0 on success.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_sset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SPEED_10000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">DUPLEX_FULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">s2io_close</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">s2io_open</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_ethtol_gset - Return link specific information.</span>
<span class="cm"> * @sp : private member of the device structure, pointer to the</span>
<span class="cm"> *      s2io_nic structure.</span>
<span class="cm"> * @info : pointer to the structure with parameters given by ethtool</span>
<span class="cm"> * to return link information.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Returns link specific information like speed, duplex etc.. to ethtool.</span>
<span class="cm"> * Return value :</span>
<span class="cm"> * return 0 on success.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_gset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>

	<span class="cm">/* info-&gt;transceiver */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_EXTERNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">SPEED_10000</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_ethtool_gdrvinfo - Returns driver specific information.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> * s2io_nic structure.</span>
<span class="cm"> * @info : pointer to the structure with parameters given by ethtool to</span>
<span class="cm"> * return driver information.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Returns driver specefic information like name, version etc.. to ethtool.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *  void</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_ethtool_gdrvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">s2io_driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">s2io_driver_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="n">XENA_REG_SPACE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="n">XENA_EEPROM_SPACE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_ethtool_gregs - dumps the entire space of Xfame into the buffer.</span>
<span class="cm"> *  @sp: private member of the device structure, which is a pointer to the</span>
<span class="cm"> *  s2io_nic structure.</span>
<span class="cm"> *  @regs : pointer to the structure with parameters given by ethtool for</span>
<span class="cm"> *  dumping the registers.</span>
<span class="cm"> *  @reg_space: The input argumnet into which all the registers are dumped.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  Dumps the entire register space of xFrame NIC into the user given</span>
<span class="cm"> *  buffer area.</span>
<span class="cm"> * Return value :</span>
<span class="cm"> * void .</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_ethtool_gregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">reg_space</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">space</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">XENA_REG_SPACE</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">reg_space</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  s2io_set_led - control NIC led</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_set_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subid</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">subid</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x07</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">GPIO_CTRL_GPIO_0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_CTRL_GPIO_0</span><span class="p">;</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_LED_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADAPTER_LED_ON</span><span class="p">;</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_ethtool_set_led - To physically identify the nic on the system.</span>
<span class="cm"> * @dev : network device</span>
<span class="cm"> * @state: led setting</span>
<span class="cm"> *</span>
<span class="cm"> * Description: Used to physically identify the NIC on the system.</span>
<span class="cm"> * The Link LED will blink for a time specified by the user for</span>
<span class="cm"> * identification.</span>
<span class="cm"> * NOTE: The Link has to be Up to be able to blink the LED. Hence</span>
<span class="cm"> * identification is possible only if it&#39;s link is up.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_set_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subid</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">subid</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x07</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">ADAPTER_CNTL_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Adapter Link down, cannot blink LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">adapt_ctrl_org</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* cycle on/off once per second */</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">s2io_set_led</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">s2io_set_led</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">CARDS_WITH_FAULTY_LINK_INDICATORS</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">,</span> <span class="n">subid</span><span class="p">))</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">adapt_ctrl_org</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_ethtool_gringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx_desc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_desc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_DESC_1</span><span class="p">;</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_DESC_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_DESC_2</span><span class="p">;</span>
		<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_max_pending</span> <span class="o">=</span> <span class="n">MAX_RX_DESC_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">MAX_TX_DESC</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rx_desc_count</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_rxd</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">rx_desc_count</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span> <span class="o">=</span> <span class="n">rx_desc_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tx_desc_count</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo_len</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">tx_desc_count</span><span class="p">;</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;max txds: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">max_txds</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_ethtool_getpause_data -Pause frame frame generation and reception.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *	s2io_nic structure.</span>
<span class="cm"> * @ep : pointer to the structure with pause parameters given by ethtool.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Returns the Pause frame generation and reception capability of the NIC.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *  void</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_ethtool_getpause_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_pause_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RMAC_PAUSE_GEN_ENABLE</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">RMAC_PAUSE_RX_ENABLE</span><span class="p">)</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_ethtool_setpause_data -  set/reset pause frame generation.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *      s2io_nic structure.</span>
<span class="cm"> * @ep : pointer to the structure with pause parameters given by ethtool.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * It can be used to set or reset Pause frame generation or reception</span>
<span class="cm"> * support of the NIC.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * int, returns 0 on Success</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_setpause_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_pause_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">tx_pause</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">RMAC_PAUSE_GEN_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RMAC_PAUSE_GEN_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_pause</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">RMAC_PAUSE_RX_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RMAC_PAUSE_RX_ENABLE</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_pause_cfg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_eeprom - reads 4 bytes of data from user given offset.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *      s2io_nic structure.</span>
<span class="cm"> * @off : offset at which the data must be written</span>
<span class="cm"> * @data : Its an output parameter where the data read at the given</span>
<span class="cm"> *	offset is stored.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Will read 4 bytes of data from the user given offset and return the</span>
<span class="cm"> * read data.</span>
<span class="cm"> * NOTE: Will allow to read only part of the EEPROM visible through the</span>
<span class="cm"> *   I2C bus.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *  -1 on failure and 0 on success.</span>
<span class="cm"> */</span>

<span class="cp">#define S2IO_DEV_ID		5</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">exit_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">I2C_CONTROL_DEV_ID</span><span class="p">(</span><span class="n">S2IO_DEV_ID</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_ADDR</span><span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_BYTE_CNT</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_READ</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_CNTL_START</span><span class="p">;</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">i2c_control</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">exit_cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">i2c_control</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">I2C_CONTROL_CNTL_END</span><span class="p">(</span><span class="n">val64</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">I2C_CONTROL_GET_DATA</span><span class="p">(</span><span class="n">val64</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">exit_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">SPI_CONTROL_KEY</span><span class="p">(</span><span class="mh">0x9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPI_CONTROL_SEL1</span> <span class="o">|</span>
			<span class="n">SPI_CONTROL_BYTECNT</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SPI_CONTROL_CMD</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPI_CONTROL_ADDR</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_control</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">SPI_CONTROL_REQ</span><span class="p">;</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_control</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">exit_cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_control</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">SPI_CONTROL_NACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">SPI_CONTROL_DONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">);</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xffffff</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">exit_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  write_eeprom - actually writes the relevant part of the data value.</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *       s2io_nic structure.</span>
<span class="cm"> *  @off : offset at which the data must be written</span>
<span class="cm"> *  @data : The data that is to be written</span>
<span class="cm"> *  @cnt : Number of bytes of the data that are actually to be written into</span>
<span class="cm"> *  the Eeprom. (max of 3)</span>
<span class="cm"> * Description:</span>
<span class="cm"> *  Actually writes the relevant part of the data value into the Eeprom</span>
<span class="cm"> *  through the I2C bus.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *  0 on success, -1 on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">exit_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">I2C_CONTROL_DEV_ID</span><span class="p">(</span><span class="n">S2IO_DEV_ID</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_ADDR</span><span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_BYTE_CNT</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_SET_DATA</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">I2C_CONTROL_CNTL_START</span><span class="p">;</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">i2c_control</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">exit_cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">i2c_control</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">I2C_CONTROL_CNTL_END</span><span class="p">(</span><span class="n">val64</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">I2C_CONTROL_NACK</span><span class="p">))</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">exit_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">write_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">SPI_DATA_WRITE</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">SPI_CONTROL_KEY</span><span class="p">(</span><span class="mh">0x9</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPI_CONTROL_SEL1</span> <span class="o">|</span>
			<span class="n">SPI_CONTROL_BYTECNT</span><span class="p">(</span><span class="n">write_cnt</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SPI_CONTROL_CMD</span><span class="p">(</span><span class="mh">0x2</span><span class="p">)</span> <span class="o">|</span> <span class="n">SPI_CONTROL_ADDR</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_control</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">SPI_CONTROL_REQ</span><span class="p">;</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_control</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">exit_cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">spi_control</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">SPI_CONTROL_NACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">SPI_CONTROL_DONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">exit_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_vpd_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">vpd_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpd_addr</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="s">&quot;Xframe II 10GbE network adapter&quot;</span><span class="p">);</span>
		<span class="n">vpd_addr</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="s">&quot;Xframe I 10GbE network adapter&quot;</span><span class="p">);</span>
		<span class="n">vpd_addr</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">,</span> <span class="s">&quot;NOT AVAILABLE&quot;</span><span class="p">);</span>

	<span class="n">vpd_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpd_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">vpd_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>  <span class="p">(</span><span class="n">vpd_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">vpd_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">vpd_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Read of VPD data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>  <span class="p">(</span><span class="n">vpd_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
				      <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read serial number of adapter */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">252</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;N&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">vpd_data</span><span class="p">[</span><span class="n">cnt</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">VPD_STRING_LEN</span><span class="p">,</span> <span class="mi">256</span><span class="o">-</span><span class="n">cnt</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span>
					       <span class="n">len</span><span class="p">);</span>
					<span class="n">memset</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
					       <span class="mi">0</span><span class="p">,</span>
					       <span class="n">VPD_STRING_LEN</span><span class="o">-</span><span class="n">len</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">fail</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vpd_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">VPD_STRING_LEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">vpd_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpd_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vpd_data</span><span class="p">);</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_ethtool_geeprom  - reads the value stored in the Eeprom.</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the *       s2io_nic structure.</span>
<span class="cm"> *  @eeprom : pointer to the user level structure provided by ethtool,</span>
<span class="cm"> *  containing all relevant information.</span>
<span class="cm"> *  @data_buf : user defined value to be written into Eeprom.</span>
<span class="cm"> *  Description: Reads the values stored in the Eeprom at given offset</span>
<span class="cm"> *  for a given length. Stores these values int the input argument data</span>
<span class="cm"> *  buffer &#39;data_buf&#39; and returns these to the caller (ethtool.)</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  int  0 on success</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_geeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">valid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">|</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">XENA_EEPROM_SPACE</span><span class="p">))</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">XENA_EEPROM_SPACE</span> <span class="o">-</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Read of EEPROM failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="n">INV</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">data_buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">valid</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_ethtool_seeprom - tries to write the user provided value in Eeprom</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *  s2io_nic structure.</span>
<span class="cm"> *  @eeprom : pointer to the user level structure provided by ethtool,</span>
<span class="cm"> *  containing all relevant information.</span>
<span class="cm"> *  @data_buf ; user defined value to be written into Eeprom.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  Tries to write the user provided value in the Eeprom, at the offset</span>
<span class="cm"> *  given by the user.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  0 on success, -EFAULT on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_seeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">|</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;ETHTOOL_WRITE_EEPROM Err: &quot;</span>
			  <span class="s">&quot;Magic value is wrong, it is 0x%x should be 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">|</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)),</span>
			  <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data_buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">valid</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">),</span> <span class="n">valid</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;ETHTOOL_WRITE_EEPROM Err: &quot;</span>
				  <span class="s">&quot;Cannot write into the specified offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_register_test - reads and writes into all clock domains.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> * s2io_nic structure.</span>
<span class="cm"> * @data : variable that returns the result of each of the test conducted b</span>
<span class="cm"> * by the driver.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Read and write into all clock domains. The NIC has 3 clock domains,</span>
<span class="cm"> * see that registers in all the three regions are accessible.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 0 on success.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_register_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exp_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">pif_rd_swapper_fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0x123456789abcdefULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;Read Test level %d fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_pause_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0xc000ffff00000000ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;Read Test level %d fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rx_queue_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span>
		<span class="n">exp_val</span> <span class="o">=</span> <span class="mh">0x0404040404040404ULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">exp_val</span> <span class="o">=</span> <span class="mh">0x0808080808080808ULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="n">exp_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;Read Test level %d fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xgxs_efifo_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0x000000001923141EULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;Read Test level %d fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x5A5A5A5A5A5A5A5AULL</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_data</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0x5A5A5A5A5A5A5A5AULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Write Test level %d fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="mh">0xA5A5A5A5A5A5A5A5ULL</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_data</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">xmsi_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">!=</span> <span class="mh">0xA5A5A5A5A5A5A5A5ULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Write Test level %d fails</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_eeprom_test - to verify that EEprom in the xena can be programmed.</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> * s2io_nic structure.</span>
<span class="cm"> * @data:variable that returns the result of each of the test conducted by</span>
<span class="cm"> * the driver.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Verify that EEPROM in the xena can be programmed using I2C_CONTROL</span>
<span class="cm"> * register.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 0 on success.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_eeprom_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ret_data</span><span class="p">,</span> <span class="n">org_4F0</span><span class="p">,</span> <span class="n">org_7F0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">saved_4F0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">saved_7F0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Test Write Error at offset 0 */</span>
	<span class="cm">/* Note that SPI interface allows write access to all areas</span>
<span class="cm">	 * of EEPROM. Hence doing all negative testing only for Xframe I.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Save current values at offsets 0x4F0 and 0x7F0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x4F0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">org_4F0</span><span class="p">))</span>
		<span class="n">saved_4F0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x7F0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">org_7F0</span><span class="p">))</span>
		<span class="n">saved_7F0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Test Write at offset 4f0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x4F0</span><span class="p">,</span> <span class="mh">0x012345</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x4F0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret_data</span><span class="p">))</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_data</span> <span class="o">!=</span> <span class="mh">0x012345</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: eeprom test error at offset 0x4F0. &quot;</span>
			  <span class="s">&quot;Data written %llx Data read %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="mh">0x12345</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ret_data</span><span class="p">);</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the EEPROM data go FFFF */</span>
	<span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x4F0</span><span class="p">,</span> <span class="mh">0xFFFFFF</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Test Write Request Error at offset 0x7c */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x07C</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Test Write Request at offset 0x7f0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x7F0</span><span class="p">,</span> <span class="mh">0x012345</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x7F0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret_data</span><span class="p">))</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_data</span> <span class="o">!=</span> <span class="mh">0x012345</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: eeprom test error at offset 0x7F0. &quot;</span>
			  <span class="s">&quot;Data written %llx Data read %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="mh">0x12345</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ret_data</span><span class="p">);</span>
		<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the EEPROM data go FFFF */</span>
	<span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x7F0</span><span class="p">,</span> <span class="mh">0xFFFFFF</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Test Write Error at offset 0x80 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x080</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Test Write Error at offset 0xfc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x0FC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Test Write Error at offset 0x100 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Test Write Error at offset 4ec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x4EC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restore values at offsets 0x4F0 and 0x7F0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_4F0</span><span class="p">)</span>
		<span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x4F0</span><span class="p">,</span> <span class="n">org_4F0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_7F0</span><span class="p">)</span>
		<span class="n">write_eeprom</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mh">0x7F0</span><span class="p">,</span> <span class="n">org_7F0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_bist_test - invokes the MemBist test of the card .</span>
<span class="cm"> * @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> * s2io_nic structure.</span>
<span class="cm"> * @data:variable that returns the result of each of the test conducted by</span>
<span class="cm"> * the driver.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This invokes the MemBist test of the card. We give around</span>
<span class="cm"> * 2 secs time for the Test to complete. If it&#39;s still not complete</span>
<span class="cm"> * within this peiod, we consider that the test failed.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 0 on success and -1 on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_bist_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bist</span><span class="p">);</span>
	<span class="n">bist</span> <span class="o">|=</span> <span class="n">PCI_BIST_START</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BIST</span><span class="p">,</span> <span class="n">bist</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_BIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bist</span> <span class="o">&amp;</span> <span class="n">PCI_BIST_START</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">bist</span> <span class="o">&amp;</span> <span class="n">PCI_BIST_CODE_MASK</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io-link_test - verifies the link state of the nic</span>
<span class="cm"> * @sp ; private member of the device structure, which is a pointer to the</span>
<span class="cm"> * s2io_nic structure.</span>
<span class="cm"> * @data: variable that returns the result of each of the test conducted by</span>
<span class="cm"> * the driver.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * The function verifies the link state of the NIC and updates the input</span>
<span class="cm"> * argument &#39;data&#39; appropriately.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 0 on success.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_link_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">LINK_IS_UP</span><span class="p">(</span><span class="n">val64</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_rldram_test - offline test for access to the RldRam chip on the NIC</span>
<span class="cm"> * @sp - private member of the device structure, which is a pointer to the</span>
<span class="cm"> * s2io_nic structure.</span>
<span class="cm"> * @data - variable that returns the result of each of the test</span>
<span class="cm"> * conducted by the driver.</span>
<span class="cm"> * Description:</span>
<span class="cm"> *  This is one of the offline test that tests the read and write</span>
<span class="cm"> *  access to the RldRam chip on the NIC.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *  0 on success.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_rldram_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ADAPTER_ECC_EN</span><span class="p">;</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">MC_RLDRAM_TEST_MODE</span><span class="p">;</span>
	<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_mrs</span><span class="p">);</span>
	<span class="n">val64</span> <span class="o">|=</span> <span class="n">MC_RLDRAM_QUEUE_SIZE_ENABLE</span><span class="p">;</span>
	<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_mrs</span><span class="p">,</span> <span class="n">UF</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">|=</span> <span class="n">MC_RLDRAM_MRS_ENABLE</span><span class="p">;</span>
	<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_mrs</span><span class="p">,</span> <span class="n">UF</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x55555555aaaa0000ULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">^=</span> <span class="mh">0xFFFFFFFFFFFF0000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_d0</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0xaaaa5a5555550000ULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">^=</span> <span class="mh">0xFFFFFFFFFFFF0000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_d1</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x55aaaaaaaa5a0000ULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">val64</span> <span class="o">^=</span> <span class="mh">0xFFFFFFFFFFFF0000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_d2</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="p">(</span><span class="mh">0x0000003ffffe0100ULL</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_add</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">MC_RLDRAM_TEST_MODE</span> <span class="o">|</span>
			<span class="n">MC_RLDRAM_TEST_WRITE</span> <span class="o">|</span>
			<span class="n">MC_RLDRAM_TEST_GO</span><span class="p">;</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MC_RLDRAM_TEST_DONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">MC_RLDRAM_TEST_MODE</span> <span class="o">|</span> <span class="n">MC_RLDRAM_TEST_GO</span><span class="p">;</span>
		<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MC_RLDRAM_TEST_DONE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val64</span> <span class="o">&amp;</span> <span class="n">MC_RLDRAM_TEST_PASS</span><span class="p">))</span>
			<span class="n">test_fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">iteration</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">test_fail</span><span class="p">;</span>

	<span class="cm">/* Bring the adapter out of test mode */</span>
	<span class="n">SPECIAL_REG_WRITE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">mc_rldram_test_ctrl</span><span class="p">,</span> <span class="n">LF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">test_fail</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_ethtool_test - conducts 6 tsets to determine the health of card.</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *  s2io_nic structure.</span>
<span class="cm"> *  @ethtest : pointer to a ethtool command specific structure that will be</span>
<span class="cm"> *  returned to the user.</span>
<span class="cm"> *  @data : variable that returns the result of each of the test</span>
<span class="cm"> * conducted by the driver.</span>
<span class="cm"> * Description:</span>
<span class="cm"> *  This function conducts 6 tests ( 4 offline and 2 online) to determine</span>
<span class="cm"> *  the health of the card.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *  void</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_ethtool_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_test</span> <span class="o">*</span><span class="n">ethtest</span><span class="p">,</span>
			      <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">orig_state</span> <span class="o">=</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ethtest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Offline Tests. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orig_state</span><span class="p">)</span>
			<span class="n">s2io_close</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_register_test</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="n">ethtest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_rldram_test</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
			<span class="n">ethtest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_eeprom_test</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="n">ethtest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_bist_test</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
			<span class="n">ethtest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">orig_state</span><span class="p">)</span>
			<span class="n">s2io_open</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Online Tests. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">orig_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: is not up, cannot run test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_link_test</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
			<span class="n">ethtest</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">estats</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="o">*</span><span class="n">tmp_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">stat_block</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpakStat</span> <span class="o">*</span><span class="n">xstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">xpak_stat</span><span class="p">;</span>

	<span class="n">s2io_updt_stats</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span>  <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_data_octets_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_data_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_drop_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_mcst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_mcst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_bcst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_bcst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_pause_ctrl_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_ttl_octets_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_ttl_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_ucst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_ucst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_nucst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_nucst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_any_err_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_any_err_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_ttl_less_fb_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_vld_ip_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_vld_ip_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_vld_ip</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_drop_ip_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_drop_ip</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_icmp_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_icmp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_rst_tcp_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_rst_tcp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_tcp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_udp_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tmac_udp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_data_octets_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_data_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_fcs_err_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_mcst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_mcst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_bcst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vld_bcst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_in_rng_len_err_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_out_rng_len_err_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_long_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_pause_ctrl_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_unsup_ctrl_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_octets_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_accepted_ucst_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span>
		<span class="o">|</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_accepted_ucst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_accepted_nucst_frms_oflow</span><span class="p">)</span>
		<span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_accepted_nucst_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_discarded_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_discarded_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_events_oflow</span><span class="p">)</span>
		<span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_events</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_less_fb_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_usized_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_usized_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_osized_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_osized_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frag_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frag_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_jabber_frms_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_jabber_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_64_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_65_127_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_128_255_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_256_511_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_512_1023_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_1024_1518_frms</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ip_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ip</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ip_octets</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_hdr_err_ip</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_ip_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_drop_ip</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_icmp_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_icmp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_tcp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_udp_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_udp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_err_drp_udp_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_err_drp_udp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_xgmii_err_sym</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q0</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q1</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q2</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q3</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q4</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q5</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q6</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_frms_q7</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q0</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q1</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q2</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q3</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q4</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q5</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q6</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_full_q7</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_pause_cnt_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_pause_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_xgmii_data_err_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_xgmii_ctrl_err_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_accepted_ip_oflow</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_accepted_ip</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_err_tcp</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rd_req_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">new_rd_req_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">new_rd_req_rtry_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rd_rtry_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">wr_rtry_rd_ack_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">wr_req_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">new_wr_req_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">new_wr_req_rtry_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">wr_rtry_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">wr_disc_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rd_rtry_wr_ack_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">txp_wr_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">txd_rd_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">txd_wr_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxd_rd_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxd_wr_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">txf_rd_cnt</span><span class="p">);</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rxf_wr_cnt</span><span class="p">);</span>

	<span class="cm">/* Enhanced statistics exist only for Hercules */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_1519_4095_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_4096_8191_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_8192_max_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ttl_gt_max_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_osized_alt_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_jabber_alt_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_gt_max_alt_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_vlan_frms</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_len_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_fcs_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_pf_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_da_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_red_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_rts_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rmac_ingm_full_discard</span><span class="p">);</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">link_fault_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">single_ecc_errs</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">double_ecc_errs</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">parity_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">serious_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">soft_reset_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">fifo_full_cnt</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">MAX_RX_RINGS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">ring_full_cnt</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_transceiver_temp_high</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_transceiver_temp_low</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_bias_current_high</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_bias_current_low</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_output_power_high</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">alarm_laser_output_power_low</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_transceiver_temp_high</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_transceiver_temp_low</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_bias_current_high</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_bias_current_low</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_output_power_high</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">xstats</span><span class="o">-&gt;</span><span class="n">warn_laser_output_power_low</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">clubbed_frms_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">sending_both</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">outof_sequence_pkts</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">flush_max_pkts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swstats</span><span class="o">-&gt;</span><span class="n">num_aggregations</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">sum_avg_pkts_aggregated</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since 64-bit divide does not work on all platforms,</span>
<span class="cm">		 * do repeated subtraction.</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">num_aggregations</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">-=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">num_aggregations</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">pci_map_fail_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">watchdog_timer_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_time</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_time</span><span class="p">;</span>

	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_buf_abort_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_desc_abort_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_parity_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_link_loss_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tx_list_proc_err_cnt</span><span class="p">;</span>

	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_parity_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_abort_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_parity_abort_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_rda_fail_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_unkn_prot_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_fcs_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_buf_size_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_rxd_corrupt_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_unkn_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tda_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">pfc_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">pcc_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tti_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">tpa_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">sm_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">lso_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mac_tmac_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mac_rmac_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">xgxs_txgxs_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">xgxs_rxgxs_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rc_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">prc_pcix_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rpa_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rda_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rti_err_cnt</span><span class="p">;</span>
	<span class="n">tmp_stats</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mc_err_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ethtool_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">XENA_REG_SPACE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">XENA_EEPROM_SPACE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="k">return</span> <span class="n">S2IO_TEST_LEN</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">XFRAME_I_DEVICE</span>:
			<span class="k">return</span> <span class="n">XFRAME_I_STAT_LEN</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XFRAME_II_DEVICE</span>:
			<span class="k">return</span> <span class="n">XFRAME_II_STAT_LEN</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_ethtool_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stat_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">s2io_gstrings</span><span class="p">,</span> <span class="n">S2IO_STRINGS_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">stat_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_xena_stats_keys</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_xena_stats_keys</span><span class="p">,</span> <span class="n">stat_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">stat_size</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">ethtool_enhanced_stats_keys</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_enhanced_stats_keys</span><span class="p">));</span>
			<span class="n">stat_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_enhanced_stats_keys</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">stat_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ethtool_driver_stats_keys</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_driver_stats_keys</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span> <span class="o">^</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">s2io_start_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">netdev_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">s2io_ethtool_gset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">s2io_ethtool_sset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">s2io_ethtool_gdrvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span> <span class="o">=</span> <span class="n">s2io_ethtool_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span> <span class="o">=</span> <span class="n">s2io_ethtool_gregs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span> <span class="o">=</span> <span class="n">s2io_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span> <span class="o">=</span> <span class="n">s2io_ethtool_geeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span> <span class="o">=</span> <span class="n">s2io_ethtool_seeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span> <span class="o">=</span> <span class="n">s2io_ethtool_gringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">s2io_ethtool_getpause_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pauseparam</span> <span class="o">=</span> <span class="n">s2io_ethtool_setpause_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">self_test</span> <span class="o">=</span> <span class="n">s2io_ethtool_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span> <span class="o">=</span> <span class="n">s2io_ethtool_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span> <span class="o">=</span> <span class="n">s2io_ethtool_set_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span> <span class="o">=</span> <span class="n">s2io_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span> <span class="o">=</span> <span class="n">s2io_get_sset_count</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_ioctl - Entry point for the Ioctl</span>
<span class="cm"> *  @dev :  Device pointer.</span>
<span class="cm"> *  @ifr :  An IOCTL specefic structure, that can contain a pointer to</span>
<span class="cm"> *  a proprietary structure used to pass information to the driver.</span>
<span class="cm"> *  @cmd :  This is used to distinguish between the different commands that</span>
<span class="cm"> *  can be passed to the IOCTL functions.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  Currently there are no special functionality supported in IOCTL, hence</span>
<span class="cm"> *  function always return EOPNOTSUPPORTED</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_change_mtu - entry point to change MTU size for the device.</span>
<span class="cm"> *   @dev : device pointer.</span>
<span class="cm"> *   @new_mtu : the new MTU size for the device.</span>
<span class="cm"> *   Description: A driver entry point to change MTU size for the device.</span>
<span class="cm"> *   Before changing the MTU the device must be stopped.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *   0 on success and an appropriate (-)ve integer as defined in errno.h</span>
<span class="cm"> *   file on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">MIN_MTU</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">S2IO_JUMBO_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: MTU size is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Device bring up failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s2io_wake_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Device is down */</span>
		<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

		<span class="n">writeq</span><span class="p">(</span><span class="n">vBIT</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_max_pyld_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_set_link - Set the LInk status</span>
<span class="cm"> * @data: long pointer to device private structue</span>
<span class="cm"> * Description: Sets the link status for the adapter</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_set_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2io_nic</span><span class="p">,</span>
					    <span class="n">set_link_task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subid</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_LINK_TASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* The card is being reset, no point doing anything */</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">subid</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_link_fault_indication</span><span class="p">(</span><span class="n">nic</span><span class="p">)</span> <span class="o">==</span> <span class="n">MAC_RMAC_ERR_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allow a small delay for the NICs self initiated</span>
<span class="cm">		 * cleanup to complete.</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">LINK_IS_UP</span><span class="p">(</span><span class="n">val64</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ADAPTER_CNTL_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">verify_xena_quiescence</span><span class="p">(</span><span class="n">nic</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
				<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_CNTL_EN</span><span class="p">;</span>
				<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CARDS_WITH_FAULTY_LINK_INDICATORS</span><span class="p">(</span>
					    <span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">,</span> <span class="n">subid</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
					<span class="n">val64</span> <span class="o">|=</span> <span class="n">GPIO_CTRL_GPIO_0</span><span class="p">;</span>
					<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
					<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_LED_ON</span><span class="p">;</span>
					<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_enabled_once</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
					  <span class="s">&quot;%s: Error: device is not Quiescent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">ADAPTER_LED_ON</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="n">s2io_link</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">LINK_UP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CARDS_WITH_FAULTY_LINK_INDICATORS</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">,</span>
						      <span class="n">subid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_CTRL_GPIO_0</span><span class="p">;</span>
			<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
			<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* turn off LED */</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">val64</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">ADAPTER_LED_ON</span><span class="p">);</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_control</span><span class="p">);</span>
		<span class="n">s2io_link</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">LINK_DOWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_LINK_TASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>

<span class="nl">out_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rxd_buffer_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="n">ba</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">temp0</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">temp1</span><span class="p">,</span>
				  <span class="n">u64</span> <span class="o">*</span><span class="n">temp2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="n">rxdp1</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD1</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
		<span class="cm">/* allocate skb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;SKB is not NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * As Rx frame are not going to be processed,</span>
<span class="cm">			 * using same mapped address for the Rxd</span>
<span class="cm">			 * buffer pointer</span>
<span class="cm">			 */</span>
			<span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
					  <span class="s">&quot;%s: Out of memory to allocate %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;1 buf mode SKBs&quot;</span><span class="p">);</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
			<span class="cm">/* storing the mapped addr in a temp variable</span>
<span class="cm">			 * such it will be used for next rxd whose</span>
<span class="cm">			 * Host Control is NULL</span>
<span class="cm">			 */</span>
			<span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp0</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					       <span class="n">size</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">,</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rxdp1</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">memalloc_failed</span><span class="p">;</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="n">rxdp3</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxD3</span> <span class="o">*</span><span class="p">)</span><span class="n">rxdp</span><span class="p">;</span>
		<span class="cm">/* Two buffer Mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp2</span><span class="p">;</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp0</span><span class="p">;</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
					  <span class="s">&quot;%s: Out of memory to allocate %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					  <span class="s">&quot;2 buf mode SKBs&quot;</span><span class="p">);</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mem_alloc_fail_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mem_allocated</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp2</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">memalloc_failed</span><span class="p">;</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp0</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0</span><span class="p">,</span> <span class="n">BUF0_LEN</span><span class="p">,</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
						 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">memalloc_failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">);</span>

			<span class="cm">/* Buffer-1 will be dummy buffer not used */</span>
			<span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp1</span> <span class="o">=</span>
				<span class="n">pci_map_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_1</span><span class="p">,</span> <span class="n">BUF1_LEN</span><span class="p">,</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						  <span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer1_ptr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer0_ptr</span><span class="p">,</span>
						 <span class="n">BUF0_LEN</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span><span class="n">rxdp3</span><span class="o">-&gt;</span><span class="n">Buffer2_ptr</span><span class="p">,</span>
						 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
						 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">memalloc_failed</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">memalloc_failed:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">pci_map_fail_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rxd_buffer_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">=</span> <span class="n">SET_BUFFER0_SIZE_1</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">=</span> <span class="n">SET_BUFFER0_SIZE_3</span><span class="p">(</span><span class="n">BUF0_LEN</span><span class="p">);</span>
		<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">SET_BUFFER1_SIZE_3</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span> <span class="o">|=</span> <span class="n">SET_BUFFER2_SIZE_3</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span>  <span class="kt">int</span> <span class="nf">rxd_owner_bit_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="n">ba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">temp0_64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp1_64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp2_64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Calculate the size based on ring mode */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HEADER_ETHERNET_II_802_3_SIZE</span> <span class="o">+</span>
		<span class="n">HEADER_802_2_SIZE</span> <span class="o">+</span> <span class="n">HEADER_SNAP_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ALIGN_SIZE</span> <span class="o">+</span> <span class="n">BUF0_LEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">blk_cnt</span> <span class="o">=</span> <span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">/</span> <span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">blk_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">];</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rxdp</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_blocks</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rxds</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">virt_addr</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span>
					<span class="n">ba</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">set_rxd_buffer_pointer</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">rxdp</span><span class="p">,</span> <span class="n">ba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp0_64</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp1_64</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">temp2_64</span><span class="p">,</span>
							   <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">set_rxd_buffer_size</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">rxdp</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">wmb</span><span class="p">();</span>
				<span class="cm">/* flip the Ownership bit to Hardware */</span>
				<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">|=</span> <span class="n">RXD_OWN_XENA</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_add_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s2io_enable_msi_x</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Defaulting to INTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store the values of the MSIX table in</span>
<span class="cm">	 * the struct s2io_nic structure</span>
<span class="cm">	 */</span>
	<span class="n">store_xmsi_data</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* After proper initialization of H/W, register ISR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">msix_rx_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span> <span class="o">==</span> <span class="n">MSIX_FLG</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
				    <span class="n">MSIX_RING_TYPE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;%s:MSI-X-%d-RX&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
							  <span class="n">s2io_msix_ring_handle</span><span class="p">,</span>
							  <span class="mi">0</span><span class="p">,</span>
							  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arg</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span>
					   <span class="n">MSIX_ALARM_TYPE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;%s:MSI-X-%d-TX&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
							  <span class="n">s2io_msix_fifo_handle</span><span class="p">,</span>
							  <span class="mi">0</span><span class="p">,</span>
							  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arg</span><span class="p">);</span>

				<span class="p">}</span>
				<span class="cm">/* if either data or addr is zero print it. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">&amp;&amp;</span>
				      <span class="n">sp</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
						  <span class="s">&quot;%s @Addr:0x%llx Data:0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
						  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
						  <span class="n">ntohl</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">msix_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">msix_rx_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">remove_msix_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

					<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
						  <span class="s">&quot;%s:MSI-X-%d registration &quot;</span>
						  <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

					<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
						  <span class="s">&quot;%s: Defaulting to INTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">s2io_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span>
					<span class="n">MSIX_REGISTERED_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;MSI-X-RX %d entries enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">--</span><span class="n">msix_rx_cnt</span><span class="p">);</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span>
				  <span class="s">&quot;MSI-X-TX entries enabled through alarm vector</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s2io_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: ISR registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_rem_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">remove_msix_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">remove_inta_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_s2io_card_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">alarm_timer</span><span class="p">);</span>
	<span class="cm">/* If s2io_set_link task is executing, wait till it completes. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_LINK_TASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* Disable napi */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">==</span>  <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">off</span><span class="o">++</span><span class="p">)</span>
				<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">rings</span><span class="p">[</span><span class="n">off</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable Tx and Rx traffic on the NIC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span>
		<span class="n">stop_nic</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">s2io_rem_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* stop the tx queue, indicate link down */</span>
	<span class="n">s2io_link</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">LINK_DOWN</span><span class="p">);</span>

	<span class="cm">/* Check if the device is Quiescent and then Reset the NIC */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* As per the HW requirement we need to replenish the</span>
<span class="cm">		 * receive buffer to avoid the ring bump. Since there is</span>
<span class="cm">		 * no intention of processing the Rx frame at this pointwe are</span>
<span class="cm">		 * just setting the ownership bit of rxd in Each Rx</span>
<span class="cm">		 * ring to HW and set the appropriate buffer size</span>
<span class="cm">		 * based on the ring mode</span>
<span class="cm">		 */</span>
		<span class="n">rxd_owner_bit_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">adapter_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verify_xena_quiescence</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">verify_pcc_quiescent</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_enabled_once</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Device not Quiescent - &quot;</span>
				  <span class="s">&quot;adapter status reads 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">val64</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span>
		<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Free all Tx buffers */</span>
	<span class="n">free_tx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Free all Rx buffers */</span>
	<span class="n">free_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_LINK_TASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_card_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_card_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">interruptible</span><span class="p">;</span>

	<span class="cm">/* Initialize the H/W I/O registers */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">init_nic</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: H/W initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
			<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initializing the Rx buffers. For now we are considering only 1</span>
<span class="cm">	 * Rx ring and initializing buffers into 30 Rx blocks</span>
<span class="cm">	 */</span>
	<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">lro</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fill_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Out of memory in Open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="n">free_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;Buf in ring:%d is %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_bufs_left</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialise napi */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">==</span>  <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Maintain the state prior to the open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">promisc_flg</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">promisc_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">m_cast_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">all_multi_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setting its receive mode */</span>
	<span class="n">s2io_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Initialize max aggregatable pkts per session based on MTU */</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">lro_max_aggr_per_sess</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="cm">/* Check if we can use (if specified) user provided value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lro_max_pkts</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">lro_max_aggr_per_sess</span><span class="p">)</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">lro_max_aggr_per_sess</span> <span class="o">=</span> <span class="n">lro_max_pkts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Rx Traffic and interrupts on the NIC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_nic</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Starting NIC failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">free_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add interrupt service routine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_add_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
			<span class="n">s2io_rem_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">free_rx_buffers</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">S2IO_TIMER_CONF</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">alarm_timer</span><span class="p">,</span> <span class="n">s2io_alarm_handle</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__S2IO_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/*  Enable select interrupts */</span>
	<span class="n">en_dis_err_alarms</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">ENA_ALL_INTRS</span><span class="p">,</span> <span class="n">ENABLE_INTRS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">INTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">interruptible</span> <span class="o">=</span> <span class="n">TX_TRAFFIC_INTR</span> <span class="o">|</span> <span class="n">TX_PIC_INTR</span><span class="p">;</span>
		<span class="n">en_dis_able_nic_intrs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">,</span> <span class="n">ENABLE_INTRS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">interruptible</span> <span class="o">=</span> <span class="n">TX_TRAFFIC_INTR</span> <span class="o">|</span> <span class="n">RX_TRAFFIC_INTR</span><span class="p">;</span>
		<span class="n">interruptible</span> <span class="o">|=</span> <span class="n">TX_PIC_INTR</span><span class="p">;</span>
		<span class="n">en_dis_able_nic_intrs</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">,</span> <span class="n">ENABLE_INTRS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_restart_nic - Resets the NIC.</span>
<span class="cm"> * @data : long pointer to the device private structure</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This function is scheduled to be run by the s2io_tx_watchdog</span>
<span class="cm"> * function after 0.5 secs to reset the NIC. The idea is to reduce</span>
<span class="cm"> * the run time of the watch dog routine which is run holding a</span>
<span class="cm"> * spin lock.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_restart_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2io_nic</span><span class="p">,</span> <span class="n">rst_timer_task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Device bring up failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s2io_wake_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: was reset by Tx watchdog timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_tx_watchdog - Watchdog for transmit side.</span>
<span class="cm"> *  @dev : Pointer to net device structure</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function is triggered if the Tx Queue is stopped</span>
<span class="cm"> *  for a pre-defined amount of time when the Interface is still up.</span>
<span class="cm"> *  If the Interface is jammed in such a situation, the hardware is</span>
<span class="cm"> *  reset (by s2io_close) and restarted again (by s2io_open) to</span>
<span class="cm"> *  overcome any problem that might have been caused in the hardware.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  void</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_tx_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">watchdog_timer_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rst_timer_task</span><span class="p">);</span>
		<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">soft_reset_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *   rx_osm_handler - To perform some OS related operations on SKB.</span>
<span class="cm"> *   @sp: private member of the device structure,pointer to s2io_nic structure.</span>
<span class="cm"> *   @skb : the socket buffer pointer.</span>
<span class="cm"> *   @len : length of the packet</span>
<span class="cm"> *   @cksum : FCS checksum of the frame.</span>
<span class="cm"> *   @ring_no : the ring from which this RxD was extracted.</span>
<span class="cm"> *   Description:</span>
<span class="cm"> *   This function is called by the Rx interrupt serivce routine to perform</span>
<span class="cm"> *   some OS related operations on the SKB before passing it to the upper</span>
<span class="cm"> *   layers. It mainly checks if the checksum is OK, if so adds it to the</span>
<span class="cm"> *   SKBs cksum variable, increments the Rx packet count and passes the SKB</span>
<span class="cm"> *   to the upper layer. If the checksum is wrong, it increments the Rx</span>
<span class="cm"> *   packet error count, frees the SKB and returns error.</span>
<span class="cm"> *   Return value:</span>
<span class="cm"> *   SUCCESS on success and -1 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_osm_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span> <span class="n">rxdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">nic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ring_no</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">ring_no</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">l3_csum</span><span class="p">,</span> <span class="n">l4_csum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">RXD_T_CODE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">lro</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check for parity error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">parity_err_cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">err</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_parity_err_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_abort_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_parity_abort_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_rda_fail_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_unkn_prot_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_fcs_err_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_buf_size_err_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_rxd_corrupt_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">15</span>:
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">rx_unkn_err_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Drop the packet if bad transfer code. Exception being</span>
<span class="cm">		 * 0x5, which could be due to unsupported IPv6 extension header.</span>
<span class="cm">		 * In this case, we let stack handle the packet.</span>
<span class="cm">		 * Note that in this case, since checksum will be incorrect,</span>
<span class="cm">		 * stack will validate the same.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">!=</span> <span class="mh">0x5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Rx error Value: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span>
				<span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_bufs_left</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Host_Control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">RXD_GET_BUFFER0_SIZE_1</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span><span class="p">);</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">==</span> <span class="n">RXD_MODE_3B</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">get_block</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">block_index</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">get_off</span> <span class="o">=</span> <span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">rx_curr_get_info</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">buf0_len</span> <span class="o">=</span> <span class="n">RXD_GET_BUFFER0_SIZE_3</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">buf2_len</span> <span class="o">=</span> <span class="n">RXD_GET_BUFFER2_SIZE_3</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">buf0_len</span><span class="p">);</span>

		<span class="k">struct</span> <span class="n">buffAdd</span> <span class="o">*</span><span class="n">ba</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">ba</span><span class="p">[</span><span class="n">get_block</span><span class="p">][</span><span class="n">get_off</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">ba</span><span class="o">-&gt;</span><span class="n">ba_0</span><span class="p">,</span> <span class="n">buf0_len</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">buf2_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">TCP_OR_UDP_FRAME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">RXD_FRAME_IP_FRAG</span><span class="p">))))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l3_csum</span> <span class="o">=</span> <span class="n">RXD_GET_L3_CKSUM</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span><span class="p">);</span>
		<span class="n">l4_csum</span> <span class="o">=</span> <span class="n">RXD_GET_L4_CKSUM</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l3_csum</span> <span class="o">==</span> <span class="n">L3_CKSUM_OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l4_csum</span> <span class="o">==</span> <span class="n">L4_CKSUM_OK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * NIC verifies if the Checksum of the received</span>
<span class="cm">			 * frame is Ok or not and accordingly returns</span>
<span class="cm">			 * a flag in the RxD.</span>
<span class="cm">			 */</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">tcp_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">tcp</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">s2io_club_tcp_session</span><span class="p">(</span><span class="n">ring_data</span><span class="p">,</span>
							    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcp</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">tcp_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lro</span><span class="p">,</span>
							    <span class="n">rxdp</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* Begin anew */</span>
					<span class="n">lro</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">aggregate</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* Aggregate */</span>
					<span class="n">lro_append_pkt</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">lro</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcp_len</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">aggregate</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* Flush session */</span>
					<span class="n">lro_append_pkt</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">lro</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tcp_len</span><span class="p">);</span>
					<span class="n">queue_rx_frame</span><span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
						       <span class="n">lro</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>
					<span class="n">clear_lro_session</span><span class="p">(</span><span class="n">lro</span><span class="p">);</span>
					<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">flush_max_pkts</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">aggregate</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* Flush both */</span>
					<span class="n">lro</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">frags_len</span><span class="p">;</span>
					<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">sending_both</span><span class="o">++</span><span class="p">;</span>
					<span class="n">queue_rx_frame</span><span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span>
						       <span class="n">lro</span><span class="o">-&gt;</span><span class="n">vlan_tag</span><span class="p">);</span>
					<span class="n">clear_lro_session</span><span class="p">(</span><span class="n">lro</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">send_up</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* sessions exceeded */</span>
				<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>: <span class="cm">/* non-TCP or not L2 aggregatable */</span>
				<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/*</span>
<span class="cm">					 * First pkt in session not</span>
<span class="cm">					 * L3/L4 aggregatable</span>
<span class="cm">					 */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
						  <span class="s">&quot;%s: Samadhana!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">__func__</span><span class="p">);</span>
					<span class="n">BUG</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Packet with erroneous checksum, let the</span>
<span class="cm">			 * upper layers deal with it.</span>
<span class="cm">			 */</span>
			<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">mem_freed</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
<span class="nl">send_up:</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ring_no</span><span class="p">);</span>
	<span class="n">queue_rx_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RXD_GET_VLAN_TAG</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span><span class="p">));</span>
<span class="nl">aggregate:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">rings</span><span class="p">[</span><span class="n">ring_no</span><span class="p">].</span><span class="n">rx_bufs_left</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_link - stops/starts the Tx queue.</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *  s2io_nic structure.</span>
<span class="cm"> *  @link : inidicates whether link is UP/DOWN.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function stops/starts the Tx queue depending on whether the link</span>
<span class="cm"> *  status of the NIC is is down or up. This is called by the Alarm</span>
<span class="cm"> *  interrupt handler whenever a link change interrupt comes up.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  void.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">!=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">last_link_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_tti</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">==</span> <span class="n">LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">s2io_stop_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_cnt</span><span class="p">)</span>
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_time</span> <span class="o">=</span>
					<span class="n">jiffies</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">;</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Link Up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_cnt</span><span class="p">)</span>
				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_down_time</span> <span class="o">=</span>
					<span class="n">jiffies</span> <span class="o">-</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">;</span>
			<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">link_up_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">s2io_wake_all_tx_queue</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">last_link_state</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_init_pci -Initialization of PCI and PCI-X configuration registers .</span>
<span class="cm"> *  @sp : private member of the device structure, which is a pointer to the</span>
<span class="cm"> *  s2io_nic structure.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  This function initializes a few of the PCI and PCI-X configuration registers</span>
<span class="cm"> *  with recommended values.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  void</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_init_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pci_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pcix_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable Data Parity Error Recovery in PCI-X command register. */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIX_COMMAND_REGISTER</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="p">(</span><span class="n">pcix_cmd</span><span class="p">));</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIX_COMMAND_REGISTER</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">pcix_cmd</span> <span class="o">|</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIX_COMMAND_REGISTER</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="p">(</span><span class="n">pcix_cmd</span><span class="p">));</span>

	<span class="cm">/* Set the PErr Response bit in PCI command register. */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">pci_cmd</span> <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span><span class="p">));</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_verify_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dev_intr_type</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">dev_multiq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx_fifo_num</span> <span class="o">&gt;</span> <span class="n">MAX_TX_FIFOS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tx_fifo_num</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Requested number of tx fifos &quot;</span>
			  <span class="s">&quot;(%d) not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_fifo_num</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_fifo_num</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tx_fifo_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tx_fifo_num</span> <span class="o">=</span> <span class="n">MAX_TX_FIFOS</span><span class="p">;</span>

		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Default to %d tx fifos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_fifo_num</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">multiq</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dev_multiq</span> <span class="o">=</span> <span class="n">multiq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_steering_type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">tx_fifo_num</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_steering_type</span> <span class="o">!=</span> <span class="n">TX_DEFAULT_STEERING</span><span class="p">)</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;Tx steering is not supported with &quot;</span>
				  <span class="s">&quot;one fifo. Disabling Tx steering.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tx_steering_type</span> <span class="o">=</span> <span class="n">NO_STEERING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx_steering_type</span> <span class="o">&lt;</span> <span class="n">NO_STEERING</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tx_steering_type</span> <span class="o">&gt;</span> <span class="n">TX_DEFAULT_STEERING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;Requested transmit steering not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Disabling transmit steering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tx_steering_type</span> <span class="o">=</span> <span class="n">NO_STEERING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring_num</span> <span class="o">&gt;</span> <span class="n">MAX_RX_RINGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;Requested number of rx rings not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Default to %d rx rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">MAX_RX_RINGS</span><span class="p">);</span>
		<span class="n">rx_ring_num</span> <span class="o">=</span> <span class="n">MAX_RX_RINGS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">dev_intr_type</span> <span class="o">!=</span> <span class="n">INTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">dev_intr_type</span> <span class="o">!=</span> <span class="n">MSI_X</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Wrong intr_type requested. &quot;</span>
			  <span class="s">&quot;Defaulting to INTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dev_intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">dev_intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_HERC_WIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_HERC_UNI</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Xframe I does not support MSI_X. &quot;</span>
			  <span class="s">&quot;Defaulting to INTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dev_intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rx_ring_mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_ring_mode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Requested ring mode not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Defaulting to 1-buffer mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_ring_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RX_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring_sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_RX_BLOCKS_PER_RING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Requested rx ring size not &quot;</span>
				  <span class="s">&quot;supported</span><span class="se">\n</span><span class="s">Defaulting to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">MAX_RX_BLOCKS_PER_RING</span><span class="p">);</span>
			<span class="n">rx_ring_sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAX_RX_BLOCKS_PER_RING</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rts_ds_steer - Receive traffic steering based on IPv4 or IPv6 TOS</span>
<span class="cm"> * or Traffic class respectively.</span>
<span class="cm"> * @nic: device private variable</span>
<span class="cm"> * Description: The function configures the receive steering to</span>
<span class="cm"> * desired receive ring.</span>
<span class="cm"> * Return Value:  SUCCESS on success and</span>
<span class="cm"> * &#39;-1&#39; on failure (endian settings incorrect).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts_ds_steer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ds_codepoint</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ds_codepoint</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILURE</span><span class="p">;</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">RTS_DS_MEM_DATA</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_ds_mem_data</span><span class="p">);</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="n">RTS_DS_MEM_CTRL_WE</span> <span class="o">|</span>
		<span class="n">RTS_DS_MEM_CTRL_STROBE_NEW_CMD</span> <span class="o">|</span>
		<span class="n">RTS_DS_MEM_CTRL_OFFSET</span><span class="p">(</span><span class="n">ds_codepoint</span><span class="p">);</span>

	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_ds_mem_ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rts_ds_mem_ctrl</span><span class="p">,</span>
				     <span class="n">RTS_DS_MEM_CTRL_STROBE_CMD_BEING_EXECUTED</span><span class="p">,</span>
				     <span class="n">S2IO_BIT_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">s2io_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	        <span class="o">=</span> <span class="n">s2io_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	        <span class="o">=</span> <span class="n">s2io_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>	        <span class="o">=</span> <span class="n">s2io_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>    	<span class="o">=</span> <span class="n">s2io_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">s2io_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>	   	<span class="o">=</span> <span class="n">s2io_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">s2io_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>	   	<span class="o">=</span> <span class="n">s2io_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">s2io_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>	   	<span class="o">=</span> <span class="n">s2io_tx_watchdog</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>    <span class="o">=</span> <span class="n">s2io_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *  s2io_init_nic - Initialization of the adapter .</span>
<span class="cm"> *  @pdev : structure containing the PCI related information of the device.</span>
<span class="cm"> *  @pre: List of PCI devices supported by the driver listed in s2io_tbl.</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *  The function initializes an adapter identified by the pci_dec structure.</span>
<span class="cm"> *  All OS related initialization including memory and device structure and</span>
<span class="cm"> *  initlaization of the device private variable is done. Also the swapper</span>
<span class="cm"> *  control register is initialized to enable read and write into the I/O</span>
<span class="cm"> *  registers of the device.</span>
<span class="cm"> *  Return value:</span>
<span class="cm"> *  returns 0 on success and negative on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">s2io_init_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pre</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_up</span><span class="p">,</span> <span class="n">mac_down</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">XENA_dev_config</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">config_param</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_info</span> <span class="o">*</span><span class="n">mac_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_intr_type</span> <span class="o">=</span> <span class="n">intr_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_multiq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s2io_verify_parm</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_intr_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_multiq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: pci_enable_device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Using 64bit DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dma_flag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;Unable to obtain 64bit DMA &quot;</span>
				  <span class="s">&quot;for consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Using 32bit DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">s2io_driver_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Request Regions failed - %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_multiq</span><span class="p">)</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span><span class="p">),</span> <span class="n">tx_fifo_num</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*  Private member variable initialized to s2io NIC structure */</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">high_dma_flag</span> <span class="o">=</span> <span class="n">dma_flag</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_enabled_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">=</span> <span class="n">RXD_MODE_1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">=</span> <span class="n">RXD_MODE_3B</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">dev_intr_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_HERC_WIN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_HERC_UNI</span><span class="p">))</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">;</span>


	<span class="cm">/* Initialize some PCI/PCI-X fields of the NIC. */</span>
	<span class="n">s2io_init_pci</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setting the device configuration parameters.</span>
<span class="cm">	 * Most of these parameters can be specified by the user during</span>
<span class="cm">	 * module insertion as they are module loadable parameters. If</span>
<span class="cm">	 * these parameters are not not specified during load time, they</span>
<span class="cm">	 * are initialized with default values.</span>
<span class="cm">	 */</span>
	<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">mac_control</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">napi</span> <span class="o">=</span> <span class="n">napi</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_steering_type</span> <span class="o">=</span> <span class="n">tx_steering_type</span><span class="p">;</span>

	<span class="cm">/* Tx side parameters. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_steering_type</span> <span class="o">==</span> <span class="n">TX_PRIORITY_STEERING</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">=</span> <span class="n">MAX_TX_FIFOS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">=</span> <span class="n">tx_fifo_num</span><span class="p">;</span>

	<span class="cm">/* Initialize the fifos used for tx steering */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span>  <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_tcp_fifos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_tcp_fifos</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">udp_fifo_idx</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_udp_fifos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">other_fifo_idx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_tcp_fifos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_tcp_fifos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_fifo_num</span> <span class="o">-</span> <span class="n">FIFO_UDP_MAX_NUM</span> <span class="o">-</span>
				       <span class="n">FIFO_OTHER_MAX_NUM</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">udp_fifo_idx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_tcp_fifos</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">total_udp_fifos</span> <span class="o">=</span> <span class="n">FIFO_UDP_MAX_NUM</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">other_fifo_idx</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">udp_fifo_idx</span> <span class="o">+</span> <span class="n">FIFO_UDP_MAX_NUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">multiq</span> <span class="o">=</span> <span class="n">dev_multiq</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">=</span> <span class="n">tx_fifo_len</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_priority</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mapping the QoS priority to the configured fifos */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_TX_FIFOS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">fifo_mapping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifo_map</span><span class="p">[</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* map the hashing selector table to the configured fifos */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">fifo_selector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifo_selector</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>


	<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_intr_type</span> <span class="o">=</span> <span class="n">TXD_INT_TYPE_UTILZ</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_fifo_config</span> <span class="o">*</span><span class="n">tx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">f_no_snoop</span> <span class="o">=</span> <span class="p">(</span><span class="n">NO_SNOOP_TXD</span> <span class="o">|</span> <span class="n">NO_SNOOP_TXD_BUFFER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_cfg</span><span class="o">-&gt;</span><span class="n">fifo_len</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_intr_type</span> <span class="o">=</span> <span class="n">TXD_INT_TYPE_PER_LIST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* + 2 because one Txd for skb-&gt;data and one Txd for UFO */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">max_txds</span> <span class="o">=</span> <span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Rx side parameters. */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="o">=</span> <span class="n">rx_ring_num</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">=</span> <span class="n">rx_ring_sz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">rxd_count</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">ring_priority</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_bufs_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_mode</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rxd_count</span> <span class="o">=</span> <span class="n">rxd_count</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">];</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_ring_config</span> <span class="o">*</span><span class="n">rx_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">ring_org</span> <span class="o">=</span> <span class="n">RING_ORG_BUFF1</span><span class="p">;</span>
		<span class="n">rx_cfg</span><span class="o">-&gt;</span><span class="n">f_no_snoop</span> <span class="o">=</span> <span class="p">(</span><span class="n">NO_SNOOP_RXD</span> <span class="o">|</span> <span class="n">NO_SNOOP_RXD_BUFFER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Setting Mac Control parameters */</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rmac_pause_time</span> <span class="o">=</span> <span class="n">rmac_pause_time</span><span class="p">;</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">mc_pause_threshold_q0q3</span> <span class="o">=</span> <span class="n">mc_pause_threshold_q0q3</span><span class="p">;</span>
	<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">mc_pause_threshold_q4q7</span> <span class="o">=</span> <span class="n">mc_pause_threshold_q4q7</span><span class="p">;</span>


	<span class="cm">/*  initialize the shared memory used by the NIC and the host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_shared_mem</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Memory allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mem_alloc_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Neterion: cannot remap io mem1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bar0_remap_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar1</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Neterion: cannot remap io mem2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bar1_remap_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initializing the BAR1 address as the start of the FIFO pointer. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_TX_FIFOS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">tx_FIFO_start</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar1</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mh">0x00020000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Driver entry points */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s2io_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev_ethtool_ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
		<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_UFO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ufo</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_UFO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">high_dma_flag</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">WATCH_DOG_TIMEOUT</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rst_timer_task</span><span class="p">,</span> <span class="n">s2io_restart_nic</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">set_link_task</span><span class="p">,</span> <span class="n">s2io_set_link</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Setting swapper control on the NIC, for proper reset operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s2io_set_swapper</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: swapper settings are wrong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_swap_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify if the Herc works on the slot its placed into */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">s2io_verify_pci_mode</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Unsupported PCI bus mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_swap_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s2io_enable_msi_x</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s2io_test_msi</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="cm">/* rollback MSI-X, will re-enable during add_isr() */</span>
			<span class="n">remove_msix_isr</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
				  <span class="s">&quot;MSI-X requested but failed to enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">==</span>  <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">s2io_poll_msix</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">s2io_poll_inta</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Not needed for Herc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fix for all &quot;FFs&quot; MAC address problems observed on</span>
<span class="cm">		 * Alpha platforms</span>
<span class="cm">		 */</span>
		<span class="n">fix_mac_address</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * MAC address initialization.</span>
<span class="cm">	 * For now only one mac address will be read and used.</span>
<span class="cm">	 */</span>
	<span class="n">bar0</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">RMAC_ADDR_CMD_MEM_RD</span> <span class="o">|</span> <span class="n">RMAC_ADDR_CMD_MEM_STROBE_NEW_CMD</span> <span class="o">|</span>
		<span class="n">RMAC_ADDR_CMD_MEM_OFFSET</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="n">S2IO_MAC_ADDR_START_OFFSET</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">);</span>
	<span class="n">wait_for_cmd_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_cmd_mem</span><span class="p">,</span>
			      <span class="n">RMAC_ADDR_CMD_MEM_STROBE_CMD_EXECUTING</span><span class="p">,</span>
			      <span class="n">S2IO_BIT_RESET</span><span class="p">);</span>
	<span class="n">tmp64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">rmac_addr_data0_mem</span><span class="p">);</span>
	<span class="n">mac_down</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp64</span><span class="p">;</span>
	<span class="n">mac_up</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_up</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_up</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_up</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_up</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_down</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_down</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="cm">/*  Set the factory defined MAC address initially   */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">def_mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* initialize number of multicast &amp; unicast MAC entries variables */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_I_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span> <span class="o">=</span> <span class="n">S2IO_XENA_MAX_MC_ADDRESSES</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mac_addr</span> <span class="o">=</span> <span class="n">S2IO_XENA_MAX_MAC_ADDRESSES</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">mc_start_offset</span> <span class="o">=</span> <span class="n">S2IO_XENA_MC_ADDR_START_OFFSET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mc_addr</span> <span class="o">=</span> <span class="n">S2IO_HERC_MAX_MC_ADDRESSES</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">max_mac_addr</span> <span class="o">=</span> <span class="n">S2IO_HERC_MAX_MAC_ADDRESSES</span><span class="p">;</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">mc_start_offset</span> <span class="o">=</span> <span class="n">S2IO_HERC_MC_ADDR_START_OFFSET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* store mac addresses from CAM to s2io_nic structure */</span>
	<span class="n">do_s2io_store_unicast_mc</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/* Configure MSIX vector for number of rings configured plus one */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">))</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_ring_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Store the values of the MSIX table in the s2io_nic structure */</span>
	<span class="n">store_xmsi_data</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="cm">/* reset Nic and bring it to known state */</span>
	<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize link state flags</span>
<span class="cm">	 * and the card state parameter</span>
<span class="cm">	 */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize spinlocks */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * SXE-002: Configure link and activity LED to init state</span>
<span class="cm">	 * on driver load.</span>
<span class="cm">	 */</span>
	<span class="n">subid</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">subid</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="mh">0x0000800000000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="mh">0x0411040400000000ULL</span><span class="p">;</span>
		<span class="n">writeq</span><span class="p">(</span><span class="n">val64</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">bar0</span> <span class="o">+</span> <span class="mh">0x2700</span><span class="p">);</span>
		<span class="n">val64</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bar0</span><span class="o">-&gt;</span><span class="n">gpio_control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_csum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Rx chksum verify enabled by default */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Device registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">register_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s2io_vpd_read</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Copyright(c) 2002-2010 Exar Corp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Neterion %s (rev %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">s2io_driver_version</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: MAC Address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Serial number: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">serial_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">&amp;</span> <span class="n">XFRAME_II_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">s2io_print_pci_mode</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADSLT</span><span class="p">;</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">set_swap_failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rxd_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RXD_MODE_1</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: 1-Buffer receive mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RXD_MODE_3B</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: 2-Buffer receive mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: NAPI disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: NAPI enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Using %d Tx fifo(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">);</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Using %d Rx ring(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_ring_num</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INTA</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Interrupt type INTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSI_X</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Interrupt type MSI-X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">multiq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_fifo_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fifo_info</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_control</span><span class="o">-&gt;</span><span class="n">fifos</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">multiq</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">multiq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Multiqueue support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Multiqueue support disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NO_STEERING</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: No steering enabled for transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_PRIORITY_STEERING</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: Priority steering enabled for transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_DEFAULT_STEERING</span>:
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: Default steering enabled for transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Large receive offload enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ufo</span><span class="p">)</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: UDP Fragmentation Offload(UFO) enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* Initialize device name */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s Neterion %s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">product_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tag_strip</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make Link state as off at this point, when the Link change</span>
<span class="cm">	 * interrupt comes the state will be automatically changed to</span>
<span class="cm">	 * the right state.</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">register_failed:</span>
<span class="nl">set_swap_failed:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar1</span><span class="p">);</span>
<span class="nl">bar1_remap_failed:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">);</span>
<span class="nl">bar0_remap_failed:</span>
<span class="nl">mem_alloc_failed:</span>
	<span class="n">free_shared_mem</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_rem_nic - Free the PCI device</span>
<span class="cm"> * @pdev: structure containing the PCI related information of the device.</span>
<span class="cm"> * Description: This function is called by the Pci subsystem to release a</span>
<span class="cm"> * PCI device and free up all resource held up by the device. This could</span>
<span class="cm"> * be in response to a Hot plug event or when the driver is to be removed</span>
<span class="cm"> * from memory.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">s2io_rem_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;Driver Data is NULL!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rst_timer_task</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">set_link_task</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_shared_mem</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">bar1</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_starter - Entry point for the driver</span>
<span class="cm"> * Description: This function is the entry point for the driver. It verifies</span>
<span class="cm"> * the module loadable parameters and initializes PCI configuration space.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">s2io_starter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s2io_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_closer - Cleanup routine for the driver</span>
<span class="cm"> * Description: This function is the cleanup routine for the driver. It unregist * ers the driver.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">s2io_closer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s2io_driver</span><span class="p">);</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span> <span class="s">&quot;cleanup done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">s2io_starter</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">s2io_closer</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_L2_lro_capable</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">**</span><span class="n">ip</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">**</span><span class="n">tcp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ip_off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">l2_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&gt;&gt;</span> <span class="mi">37</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">),</span> <span class="n">ip_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">RXD_FRAME_PROTO_TCP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INIT_DBG</span><span class="p">,</span>
			  <span class="s">&quot;%s: Non-TCP frames not supported for LRO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Checking for DIX type or DIX type with VLAN */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">l2_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">l2_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ip_off</span> <span class="o">=</span> <span class="n">HEADER_ETHERNET_II_802_3_SIZE</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If vlan stripping is disabled and the frame is VLAN tagged,</span>
<span class="cm">		 * shift the offset by the VLAN header size bytes.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_1</span> <span class="o">&amp;</span> <span class="n">RXD_FRAME_VLAN_TAG</span><span class="p">))</span>
			<span class="n">ip_off</span> <span class="o">+=</span> <span class="n">HEADER_VLAN_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* LLC, SNAP etc are considered non-mergeable */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">ip_off</span><span class="p">);</span>
	<span class="n">ip_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="o">*</span><span class="n">ip</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>
	<span class="n">ip_len</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">ip</span> <span class="o">+</span> <span class="n">ip_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_for_socket_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Been here...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">!=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">dest</span> <span class="o">!=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_l4_pyld_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">initiate_new_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">l2h</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">tcp_pyld_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Been here...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">l2h</span> <span class="o">=</span> <span class="n">l2h</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcph</span> <span class="o">=</span> <span class="n">tcp</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcp_next_seq</span> <span class="o">=</span> <span class="n">tcp_pyld_len</span> <span class="o">+</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcp_ack</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">sg_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">total_len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">);</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">frags_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tag</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if we saw TCP timestamp.</span>
<span class="cm">	 * Other consistency checks have already been done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">tcp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">lro</span><span class="o">-&gt;</span><span class="n">saw_ts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lro</span><span class="o">-&gt;</span><span class="n">cur_tsval</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">lro</span><span class="o">-&gt;</span><span class="n">cur_tsecr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_L3L4_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">iph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcph</span><span class="p">;</span>
	<span class="n">__sum16</span> <span class="n">nchk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Been here...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Update L3 header */</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">total_len</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nchk</span> <span class="o">=</span> <span class="n">ip_fast_csum</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">iph</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">);</span>
	<span class="n">ip</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="n">nchk</span><span class="p">;</span>

	<span class="cm">/* Update L4 header */</span>
	<span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack_seq</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcp_ack</span><span class="p">;</span>
	<span class="n">tcp</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">;</span>

	<span class="cm">/* Update tsecr field if this session has timestamps enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">saw_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">tcp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">cur_tsecr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update counters required for calculation of</span>
<span class="cm">	 * average no. of packets aggregated.</span>
<span class="cm">	 */</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">sum_avg_pkts_aggregated</span> <span class="o">+=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">sg_num</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">num_aggregations</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aggregate_new_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">l4_pyld</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Been here...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">total_len</span> <span class="o">+=</span> <span class="n">l4_pyld</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">frags_len</span> <span class="o">+=</span> <span class="n">l4_pyld</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcp_next_seq</span> <span class="o">+=</span> <span class="n">l4_pyld</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">sg_num</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Update ack seq no. and window ad(from this pkt) in LRO object */</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">tcp_ack</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack_seq</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lro</span><span class="o">-&gt;</span><span class="n">saw_ts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="cm">/* Update tsecr and tsval from this packet */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">tcp</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">lro</span><span class="o">-&gt;</span><span class="n">cur_tsval</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">lro</span><span class="o">-&gt;</span><span class="n">cur_tsecr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_l3_l4_lro_capable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">l_lro</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tcp_pyld_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Been here...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcp_pyld_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Runt frame or a pure ack */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="cm">/* IP has options */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If we see CE codepoint in IP header, packet is not mergeable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INET_ECN_is_ce</span><span class="p">(</span><span class="n">ipv4_get_dsfield</span><span class="p">(</span><span class="n">ip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If we see ECE or CWR flags in TCP header, packet is not mergeable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">urg</span> <span class="o">||</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">psh</span> <span class="o">||</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">rst</span> <span class="o">||</span>
	    <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">syn</span> <span class="o">||</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">fin</span> <span class="o">||</span>
	    <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ece</span> <span class="o">||</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">cwr</span> <span class="o">||</span> <span class="o">!</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Currently recognize only the ack control word and</span>
<span class="cm">		 * any other control field being set would result in</span>
<span class="cm">		 * flushing the LRO session</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow only one TCP timestamp option. Don&#39;t aggregate if</span>
<span class="cm">	 * any other options are detected.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tcp</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">tcp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">TCPOPT_NOP</span><span class="p">)</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">TCPOPT_TIMESTAMP</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TCPOLEN_TIMESTAMP</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Ensure timestamp value increases monotonically */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_lro</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l_lro</span><span class="o">-&gt;</span><span class="n">cur_tsval</span> <span class="o">&gt;</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">))))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* timestamp echo reply should be non-zero */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">6</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s2io_club_tcp_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">ring_data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">**</span><span class="n">tcp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tcp_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lro</span> <span class="o">**</span><span class="n">lro</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">RxD_t</span> <span class="o">*</span><span class="n">rxdp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">tcph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_L2_lro_capable</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">**</span><span class="p">)</span><span class="n">tcp</span><span class="p">,</span>
				   <span class="n">rxdp</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;IP Saddr: %x Daddr: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>

	<span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">RXD_GET_VLAN_TAG</span><span class="p">(</span><span class="n">rxdp</span><span class="o">-&gt;</span><span class="n">Control_2</span><span class="p">);</span>
	<span class="n">tcph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">tcp</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tcp_len</span> <span class="o">=</span> <span class="n">get_l4_pyld_length</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">tcph</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LRO_SESSIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">l_lro</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro0_n</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_lro</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_for_socket_match</span><span class="p">(</span><span class="n">l_lro</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tcph</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Sock pair matched */</span>
			<span class="o">*</span><span class="n">lro</span> <span class="o">=</span> <span class="n">l_lro</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">lro</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tcp_next_seq</span> <span class="o">!=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Out of sequence. &quot;</span>
					  <span class="s">&quot;expected 0x%x, actual 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">__func__</span><span class="p">,</span>
					  <span class="p">(</span><span class="o">*</span><span class="n">lro</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tcp_next_seq</span><span class="p">,</span>
					  <span class="n">ntohl</span><span class="p">(</span><span class="n">tcph</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">));</span>

				<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">outof_sequence_pkts</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verify_l3_l4_lro_capable</span><span class="p">(</span><span class="n">l_lro</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span>
						      <span class="o">*</span><span class="n">tcp_len</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Aggregate */</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Flush both */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Before searching for available LRO objects,</span>
<span class="cm">		 * check if the pkt is L3/L4 aggregatable. If not</span>
<span class="cm">		 * don&#39;t create new LRO session. Just send this</span>
<span class="cm">		 * packet up.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verify_l3_l4_lro_capable</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="o">*</span><span class="n">tcp_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LRO_SESSIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">l_lro</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ring_data</span><span class="o">-&gt;</span><span class="n">lro0_n</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">l_lro</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">lro</span> <span class="o">=</span> <span class="n">l_lro</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* Begin anew */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* sessions exceeded */</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">INFO_DBG</span><span class="p">,</span> <span class="s">&quot;%s: All LRO sessions already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="o">*</span><span class="n">lro</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">initiate_new_session</span><span class="p">(</span><span class="o">*</span><span class="n">lro</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="o">*</span><span class="n">tcp_len</span><span class="p">,</span>
				     <span class="n">vlan_tag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">update_L3L4_header</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">lro</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">aggregate_new_rx</span><span class="p">(</span><span class="o">*</span><span class="n">lro</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tcph</span><span class="p">,</span> <span class="o">*</span><span class="n">tcp_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">lro</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sg_num</span> <span class="o">==</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">lro_max_aggr_per_sess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_L3L4_header</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">lro</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Flush the LRO */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DBG_PRINT</span><span class="p">(</span><span class="n">ERR_DBG</span><span class="p">,</span> <span class="s">&quot;%s: Don&#39;t know, can&#39;t say!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_lro_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">lro_struct_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lro</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">lro</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lro_struct_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_rx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan_tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tag</span> <span class="o">&amp;&amp;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">vlan_strip_flag</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi</span><span class="p">)</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lro_append_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lro</span> <span class="o">*</span><span class="n">lro</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tcp_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">swStat</span> <span class="o">*</span><span class="n">swstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">.</span><span class="n">stats_info</span><span class="o">-&gt;</span><span class="n">sw_stat</span><span class="p">;</span>

	<span class="n">first</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">tcp_len</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">lro</span><span class="o">-&gt;</span><span class="n">frags_len</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">tcp_len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span><span class="p">)</span>
		<span class="n">lro</span><span class="o">-&gt;</span><span class="n">last_frag</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frag_list</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">first</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">;</span>
	<span class="n">lro</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">swstats</span><span class="o">-&gt;</span><span class="n">clubbed_frms_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_io_error_detected - called when PCI error is detected</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> * @state: The current pci connection state</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called after a PCI bus error affecting</span>
<span class="cm"> * this device has been detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">s2io_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Bring down the card, while avoiding PCI I/O */</span>
		<span class="n">do_s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_io_slot_reset - called after the pci bus has been reset.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Restart the card from scratch, as if from a cold-boot.</span>
<span class="cm"> * At this point, the card has exprienced a hard reset,</span>
<span class="cm"> * followed by fixups by BIOS, and has its config space</span>
<span class="cm"> * set up identically to what it was at cold boot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">s2io_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot re-enable PCI device after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">s2io_reset</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s2io_io_resume - called when traffic can start flowing again.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called when the error recovery driver tells</span>
<span class="cm"> * us that its OK to resume normal operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s2io_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s2io_nic</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_card_up</span><span class="p">(</span><span class="n">sp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t bring device back up after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s2io_set_mac_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">FAILURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s2io_card_down</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t restore mac addr after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
