<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › neterion › vxge › vxge-main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>vxge-main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm">* This software may be used and distributed according to the terms of</span>
<span class="cm">* the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">* Drivers based on or derived from this code fall under the GPL and must</span>
<span class="cm">* retain the authorship, copyright and license notice.  This file is not</span>
<span class="cm">* a complete program and may only be used when the entire operating</span>
<span class="cm">* system is licensed under the GPL.</span>
<span class="cm">* See the file COPYING in this distribution for more information.</span>
<span class="cm">*</span>
<span class="cm">* vxge-main.c: Driver for Exar Corp&#39;s X3100 Series 10GbE PCIe I/O</span>
<span class="cm">*              Virtualized Server Adapter.</span>
<span class="cm">* Copyright(c) 2002-2010 Exar Corp.</span>
<span class="cm">*</span>
<span class="cm">* The module loadable parameters that are supported by the driver and a brief</span>
<span class="cm">* explanation of all the variables:</span>
<span class="cm">* vlan_tag_strip:</span>
<span class="cm">*	Strip VLAN Tag enable/disable. Instructs the device to remove</span>
<span class="cm">*	the VLAN tag from all received tagged frames that are not</span>
<span class="cm">*	replicated at the internal L2 switch.</span>
<span class="cm">*		0 - Do not strip the VLAN tag.</span>
<span class="cm">*		1 - Strip the VLAN tag.</span>
<span class="cm">*</span>
<span class="cm">* addr_learn_en:</span>
<span class="cm">*	Enable learning the mac address of the guest OS interface in</span>
<span class="cm">*	a virtualization environment.</span>
<span class="cm">*		0 - DISABLE</span>
<span class="cm">*		1 - ENABLE</span>
<span class="cm">*</span>
<span class="cm">* max_config_port:</span>
<span class="cm">*	Maximum number of port to be supported.</span>
<span class="cm">*		MIN -1 and MAX - 2</span>
<span class="cm">*</span>
<span class="cm">* max_config_vpath:</span>
<span class="cm">*	This configures the maximum no of VPATH configures for each</span>
<span class="cm">* 	device function.</span>
<span class="cm">*		MIN - 1 and MAX - 17</span>
<span class="cm">*</span>
<span class="cm">* max_config_dev:</span>
<span class="cm">*	This configures maximum no of Device function to be enabled.</span>
<span class="cm">*		MIN - 1 and MAX - 17</span>
<span class="cm">*</span>
<span class="cm">******************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/net_tstamp.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;vxge-main.h&quot;</span>
<span class="cp">#include &quot;vxge-reg.h&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Neterion&#39;s X3100 Series 10GbE PCIe I/O&quot;</span>
	<span class="s">&quot;Virtualized Server Adapter&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">vxge_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S2IO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TITAN_WIN</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="n">PCI_ANY_ID</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_S2IO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TITAN_UNI</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="n">PCI_ANY_ID</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">vxge_id_table</span><span class="p">);</span>

<span class="n">VXGE_MODULE_PARAM_INT</span><span class="p">(</span><span class="n">vlan_tag_strip</span><span class="p">,</span> <span class="n">VXGE_HW_VPATH_RPA_STRIP_VLAN_TAG_ENABLE</span><span class="p">);</span>
<span class="n">VXGE_MODULE_PARAM_INT</span><span class="p">(</span><span class="n">addr_learn_en</span><span class="p">,</span> <span class="n">VXGE_HW_MAC_ADDR_LEARN_DEFAULT</span><span class="p">);</span>
<span class="n">VXGE_MODULE_PARAM_INT</span><span class="p">(</span><span class="n">max_config_port</span><span class="p">,</span> <span class="n">VXGE_MAX_CONFIG_PORT</span><span class="p">);</span>
<span class="n">VXGE_MODULE_PARAM_INT</span><span class="p">(</span><span class="n">max_config_vpath</span><span class="p">,</span> <span class="n">VXGE_USE_DEFAULT</span><span class="p">);</span>
<span class="n">VXGE_MODULE_PARAM_INT</span><span class="p">(</span><span class="n">max_mac_vpath</span><span class="p">,</span> <span class="n">VXGE_MAX_MAC_ADDR_COUNT</span><span class="p">);</span>
<span class="n">VXGE_MODULE_PARAM_INT</span><span class="p">(</span><span class="n">max_config_dev</span><span class="p">,</span> <span class="n">VXGE_MAX_CONFIG_DEV</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">vpath_selector</span><span class="p">[</span><span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">31</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bw_percentage</span><span class="p">[</span><span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{[</span><span class="mi">0</span> <span class="p">...(</span><span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">bw_percentage</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vxge_drv_config</span> <span class="o">*</span><span class="n">driver_config</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_vxge_card_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">VXGE_COMPLETE_VPATH_TX</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">temp</span><span class="p">;</span>
<span class="cp">#define NR_SKB_COMPLETED 128</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">completed</span><span class="p">[</span><span class="n">NR_SKB_COMPLETED</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">more</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb_ptr</span> <span class="o">=</span> <span class="n">completed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__netif_tx_trylock</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vxge_hw_vpath_poll_tx</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb_ptr</span><span class="p">,</span>
						<span class="n">NR_SKB_COMPLETED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">more</span><span class="p">);</span>
			<span class="n">__netif_tx_unlock</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* free SKBs */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">completed</span><span class="p">;</span> <span class="n">temp</span> <span class="o">!=</span> <span class="n">skb_ptr</span><span class="p">;</span> <span class="n">temp</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="o">*</span><span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">more</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">VXGE_COMPLETE_ALL_TX</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Complete all transmits */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VXGE_COMPLETE_VPATH_TX</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">VXGE_COMPLETE_ALL_RX</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>

	<span class="cm">/* Complete all receives*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_poll_rx</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_callback_link_up</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called during interrupt context to notify link up state</span>
<span class="cm"> * change.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_callback_link_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link Up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_up</span><span class="o">++</span><span class="p">;</span>

	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d Exiting...&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_callback_link_down</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called during interrupt context to notify link down state</span>
<span class="cm"> * change.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_callback_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_down</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d Exiting...&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_rx_alloc</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate SKB.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">vxge_rx_alloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dtrh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">skb_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>    <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>       <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_rx_priv</span> <span class="o">*</span><span class="n">rx_priv</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">rx_priv</span> <span class="o">=</span> <span class="n">vxge_hw_ring_rxd_private_get</span><span class="p">(</span><span class="n">dtrh</span><span class="p">);</span>

	<span class="cm">/* try to allocate skb first. this one may fail */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb_size</span> <span class="o">+</span>
	<span class="n">VXGE_HW_HEADER_ETHERNET_II_802_3_ALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_mem</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: out of memory to allocate SKB&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">skb_alloc_fail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_mem</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d  Skb : 0x%p&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">VXGE_HW_HEADER_ETHERNET_II_802_3_ALIGN</span><span class="p">);</span>

	<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">skb_size</span><span class="p">;</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d Exiting...&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_rx_map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_rx_map</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dtrh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_rx_priv</span> <span class="o">*</span><span class="n">rx_priv</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">rx_priv</span> <span class="o">=</span> <span class="n">vxge_hw_ring_rxd_private_get</span><span class="p">(</span><span class="n">dtrh</span><span class="p">);</span>

	<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb_data</span> <span class="o">=</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb_data</span><span class="p">,</span>
				<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pci_map_fail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vxge_debug_mem</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d  1 buffer mode dma_addr = 0x%llx&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="n">vxge_hw_ring_rxd_1b_set</span><span class="p">(</span><span class="n">dtrh</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>

	<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_dma</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d Exiting...&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_rx_initial_replenish</span>
<span class="cm"> * Allocation of RxD as an initial replenish procedure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_rx_initial_replenish</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dtrh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="p">)</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_rx_priv</span> <span class="o">*</span><span class="n">rx_priv</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxge_rx_alloc</span><span class="p">(</span><span class="n">dtrh</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span>
			  <span class="n">VXGE_LL_MAX_FRAME_SIZE</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VXGE_HW_FAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxge_rx_map</span><span class="p">(</span><span class="n">dtrh</span><span class="p">,</span> <span class="n">ring</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_priv</span> <span class="o">=</span> <span class="n">vxge_hw_ring_rxd_private_get</span><span class="p">(</span><span class="n">dtrh</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">VXGE_HW_FAIL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d Exiting...&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">vxge_rx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vlan</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">pkt_length</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxge_hw_ring_rxd_info</span> <span class="o">*</span><span class="n">ext_info</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">driver_id</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frms</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PACKET_MULTICAST</span><span class="p">)</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_mcast</span><span class="o">++</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>

	<span class="n">vxge_debug_rx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d  skb protocol = %d&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext_info</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ring</span><span class="o">-&gt;</span><span class="n">vlan_tag_strip</span> <span class="o">==</span> <span class="n">VXGE_HW_VPATH_RPA_STRIP_VLAN_TAG_ENABLE</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ext_info</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">);</span>
	<span class="n">napi_gro_receive</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">napi_p</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d Exiting...&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vxge_re_pre_post</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dtr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">vxge_rx_priv</span> <span class="o">*</span><span class="n">rx_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">,</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">vxge_hw_ring_rxd_1b_set</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">,</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">vxge_hw_ring_rxd_pre_post</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vxge_post</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">first_dtr</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">post_dtr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__vxge_hw_ring</span> <span class="o">*</span><span class="n">ringh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dtr_count</span> <span class="o">=</span> <span class="o">*</span><span class="n">dtr_cnt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">dtr_cnt</span> <span class="o">%</span> <span class="n">VXGE_HW_RXSYNC_FREQ_CNT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">first_dtr</span><span class="p">)</span>
			<span class="n">vxge_hw_ring_rxd_post_post_wmb</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="o">*</span><span class="n">first_dtr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">first_dtr</span> <span class="o">=</span> <span class="n">post_dtr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vxge_hw_ring_rxd_post_post</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="n">post_dtr</span><span class="p">);</span>
	<span class="n">dtr_count</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dtr_cnt</span> <span class="o">=</span> <span class="n">dtr_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_rx_1b_compl</span>
<span class="cm"> *</span>
<span class="cm"> * If the interrupt is because of a received frame or if the receive ring</span>
<span class="cm"> * contains fresh as yet un-processed frames, this function is called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_rx_1b_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_ring</span> <span class="o">*</span><span class="n">ringh</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dtr</span><span class="p">,</span>
		 <span class="n">u8</span> <span class="n">t_code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="p">)</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_sizes</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">first_dtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dtr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_rx_priv</span> <span class="o">*</span><span class="n">rx_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_hw_ring_rxd_info</span> <span class="n">ext_info</span><span class="p">;</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prefetch</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dtr</span> <span class="o">+</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
		<span class="n">rx_priv</span> <span class="o">=</span> <span class="n">vxge_hw_ring_rxd_private_get</span><span class="p">(</span><span class="n">dtr</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">data_size</span> <span class="o">=</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
		<span class="n">data_dma</span> <span class="o">=</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">;</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb_data</span><span class="p">);</span>

		<span class="n">vxge_debug_rx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: %s:%d  skb = 0x%p&quot;</span><span class="p">,</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">vxge_hw_ring_rxd_1b_get</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_sizes</span><span class="p">);</span>
		<span class="n">pkt_length</span> <span class="o">=</span> <span class="n">dma_sizes</span><span class="p">;</span>

		<span class="n">pkt_length</span> <span class="o">-=</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

		<span class="n">vxge_debug_rx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: %s:%d  Packet Length = %d&quot;</span><span class="p">,</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pkt_length</span><span class="p">);</span>

		<span class="n">vxge_hw_ring_rxd_1b_info_get</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_info</span><span class="p">);</span>

		<span class="cm">/* check skb validity */</span>
		<span class="n">vxge_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">prefetch</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span> <span class="o">+</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">t_code</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vxge_hw_ring_handle_tcode</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">t_code</span><span class="p">)</span> <span class="o">!=</span>
				<span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">vxge_debug_rx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
					<span class="s">&quot;%s: %s :%d Rx T_code is %d&quot;</span><span class="p">,</span>
					<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">__LINE__</span><span class="p">,</span> <span class="n">t_code</span><span class="p">);</span>

				<span class="cm">/* If the t_code is not supported and if the</span>
<span class="cm">				 * t_code is other than 0x5 (unparseable packet</span>
<span class="cm">				 * such as unknown UPV6 header), Drop it !!!</span>
<span class="cm">				 */</span>
				<span class="n">vxge_re_pre_post</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">rx_priv</span><span class="p">);</span>

				<span class="n">vxge_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_dtr</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">ringh</span><span class="p">);</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_length</span> <span class="o">&gt;</span> <span class="n">VXGE_LL_RX_COPY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vxge_rx_alloc</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">data_size</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vxge_rx_map</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_length</span><span class="p">);</span>

					<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data_dma</span><span class="p">,</span>
						<span class="n">data_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

					<span class="n">vxge_hw_ring_rxd_pre_post</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
					<span class="n">vxge_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_dtr</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span>
						<span class="n">ringh</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
					<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
					<span class="n">vxge_re_pre_post</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">rx_priv</span><span class="p">);</span>

					<span class="n">vxge_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_dtr</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span>
						<span class="n">ringh</span><span class="p">);</span>
					<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vxge_re_pre_post</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">rx_priv</span><span class="p">);</span>

				<span class="n">vxge_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_dtr</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">ringh</span><span class="p">);</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_up</span><span class="p">;</span>

			<span class="n">skb_up</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_length</span> <span class="o">+</span>
				<span class="n">VXGE_HW_HEADER_ETHERNET_II_802_3_ALIGN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb_up</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb_up</span><span class="p">,</span>
				    <span class="n">VXGE_HW_HEADER_ETHERNET_II_802_3_ALIGN</span><span class="p">);</span>

				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">data_dma</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span>
					<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

				<span class="n">vxge_debug_mem</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
					<span class="s">&quot;%s: %s:%d  skb_up = %p&quot;</span><span class="p">,</span>
					<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">__LINE__</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_up</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_length</span><span class="p">);</span>

				<span class="n">vxge_re_pre_post</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">rx_priv</span><span class="p">);</span>

				<span class="n">vxge_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_dtr</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span>
					<span class="n">ringh</span><span class="p">);</span>
				<span class="cm">/* will netif_rx small SKB instead */</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_up</span><span class="p">;</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_length</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vxge_re_pre_post</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">rx_priv</span><span class="p">);</span>

				<span class="n">vxge_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dtr_cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_dtr</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">ringh</span><span class="p">);</span>
				<span class="n">vxge_debug_rx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;%s: vxge_rx_1b_compl: out of &quot;</span>
					<span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">skb_alloc_fail</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ext_info</span><span class="p">.</span><span class="n">proto</span> <span class="o">&amp;</span> <span class="n">VXGE_HW_FRAME_PROTO_TCP_OR_UDP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ext_info</span><span class="p">.</span><span class="n">proto</span> <span class="o">&amp;</span> <span class="n">VXGE_HW_FRAME_PROTO_IP_FRAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="cm">/* Offload Rx side CSUM */</span>
		    <span class="n">ext_info</span><span class="p">.</span><span class="n">l3_cksum</span> <span class="o">==</span> <span class="n">VXGE_HW_L3_CKSUM_OK</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ext_info</span><span class="p">.</span><span class="n">l4_cksum</span> <span class="o">==</span> <span class="n">VXGE_HW_L4_CKSUM_OK</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_hwts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">skb_shared_hwtstamps</span> <span class="o">*</span><span class="n">skb_hwts</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">ns</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="n">pkt_length</span><span class="p">);</span>

			<span class="n">skb_hwts</span> <span class="o">=</span> <span class="n">skb_hwtstamps</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb_hwts</span><span class="o">-&gt;</span><span class="n">hwtstamp</span> <span class="o">=</span> <span class="n">ns_to_ktime</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
			<span class="n">skb_hwts</span><span class="o">-&gt;</span><span class="n">syststamp</span><span class="p">.</span><span class="n">tv64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* rth_hash_type and rth_it_hit are non-zero regardless of</span>
<span class="cm">		 * whether rss is enabled.  Only the rth_value is zero/non-zero</span>
<span class="cm">		 * if rss is disabled/enabled, so key off of that.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_info</span><span class="p">.</span><span class="n">rth_value</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">rxhash</span> <span class="o">=</span> <span class="n">ext_info</span><span class="p">.</span><span class="n">rth_value</span><span class="p">;</span>

		<span class="n">vxge_rx_complete</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ext_info</span><span class="p">.</span><span class="n">vlan</span><span class="p">,</span>
			<span class="n">pkt_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext_info</span><span class="p">);</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">budget</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">vxge_hw_ring_rxd_next_completed</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtr</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">t_code</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_dtr</span><span class="p">)</span>
		<span class="n">vxge_hw_ring_rxd_post_post_wmb</span><span class="p">(</span><span class="n">ringh</span><span class="p">,</span> <span class="n">first_dtr</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
				<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_xmit_compl</span>
<span class="cm"> *</span>
<span class="cm"> * If an interrupt was raised to indicate DMA complete of the Tx packet,</span>
<span class="cm"> * this function is called. It identifies the last TxD whose buffer was</span>
<span class="cm"> * freed and frees all skbs whose data have already DMA&#39;ed into the NICs</span>
<span class="cm"> * internal memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_xmit_compl</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_fifo</span> <span class="o">*</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dtr</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">vxge_hw_fifo_tcode</span> <span class="n">t_code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">userdata</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">***</span><span class="n">skb_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_skb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">more</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="p">)</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">**</span><span class="n">done_skb</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d Entered....&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">frg_cnt</span><span class="p">;</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vxge_tx_priv</span> <span class="o">*</span><span class="n">txd_priv</span> <span class="o">=</span>
			<span class="n">vxge_hw_fifo_txdl_private_get</span><span class="p">(</span><span class="n">dtr</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">txd_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">frg_cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
				<span class="s">&quot;%s: %s:%d fifo_hw = %p dtr = %p &quot;</span>
				<span class="s">&quot;tcode = 0x%x&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">__LINE__</span><span class="p">,</span> <span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">t_code</span><span class="p">);</span>
		<span class="cm">/* check skb validity */</span>
		<span class="n">vxge_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: %s:%d skb = %p itxd_priv = %p frg_cnt = %d&quot;</span><span class="p">,</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">skb</span><span class="p">,</span> <span class="n">txd_priv</span><span class="p">,</span> <span class="n">frg_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">t_code</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: tx: dtr %p completed due to &quot;</span>
				<span class="s">&quot;error t_code %01x&quot;</span><span class="p">,</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">dtr</span><span class="p">,</span> <span class="n">t_code</span><span class="p">);</span>
			<span class="n">vxge_hw_fifo_handle_tcode</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">t_code</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*  for unfragmented skb */</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txd_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span>
				<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">frg_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">txd_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span>
					<span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">frag</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vxge_hw_fifo_txdl_free</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>

		<span class="cm">/* Updating the statistics block */</span>
		<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_frms</span><span class="o">++</span><span class="p">;</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>

		<span class="o">*</span><span class="n">done_skb</span><span class="o">++</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">nr_skb</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pkt_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_cnt</span> <span class="o">&gt;</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">indicate_max_pkts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">vxge_hw_fifo_txdl_next_completed</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t_code</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">);</span>

	<span class="o">*</span><span class="n">skb_ptr</span> <span class="o">=</span> <span class="n">done_skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
		<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
				<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
				<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* select a vpath to transmit the packet */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">vxge_get_vpath_no</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">queue_len</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="n">th</span><span class="p">;</span>

		<span class="n">ip</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ip_is_fragment</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

			<span class="n">queue_len</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span>
			<span class="n">counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">th</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpath_selector</span><span class="p">[</span><span class="n">queue_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">queue_len</span><span class="p">)</span>
				<span class="n">counter</span> <span class="o">=</span> <span class="n">queue_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="nf">vxge_search_mac_addr_in_list</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">,</span> <span class="n">u64</span> <span class="n">del_mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">macaddr</span> <span class="o">==</span> <span class="n">del_mac</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_mac_list_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">,</span> <span class="k">struct</span> <span class="n">macInfo</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="n">new_mac_entry</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_cnt</span> <span class="o">&gt;=</span> <span class="n">VXGE_MAX_LEARN_MAC_ADDR_CNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="n">new_mac_entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_mac_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_mem</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: memory allocation failed&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_mac_entry</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_list</span><span class="p">);</span>

	<span class="cm">/* Copy the new mac address to the list */</span>
	<span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">new_mac_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">new_mac_entry</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">))</span>
		<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mcast_addr_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add a mac address to DA table */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_add_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">macInfo</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_vpath_mac_addr_add_mode</span> <span class="n">duplicate_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">))</span>
		<span class="n">duplicate_mode</span> <span class="o">=</span> <span class="n">VXGE_HW_VPATH_MAC_ADDR_ADD_DUPLICATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">duplicate_mode</span> <span class="o">=</span> <span class="n">VXGE_HW_VPATH_MAC_ADDR_REPLACE_DUPLICATE</span><span class="p">;</span>

	<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vpath_no</span><span class="p">];</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mac_addr_add</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span>
						<span class="n">mac</span><span class="o">-&gt;</span><span class="n">macmask</span><span class="p">,</span> <span class="n">duplicate_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;DA config add entry failed for vpath:%d&quot;</span><span class="p">,</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">vxge_mac_list_add</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="n">mac</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_learn_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macInfo</span> <span class="n">mac_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mac_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vpath_vector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>

	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">mac_header</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Is this mac address already in the list? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vpath_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vxge_search_mac_addr_in_list</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">vpath_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macInfo</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">mac_header</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Any vpath has room to add mac address to its da table? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vpath_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_cnt</span> <span class="o">&lt;</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">max_mac_addr_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Add this mac address to this vpath */</span>
			<span class="n">mac_info</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
			<span class="n">mac_info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VXGE_LL_MAC_ADDR_IN_DA_TABLE</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_add_mac_addr</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">vpath_idx</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mac_info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VXGE_LL_MAC_ADDR_IN_LIST</span><span class="p">;</span>
	<span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac_info</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
	<span class="cm">/* Is the first vpath already selected as catch-basin ? */</span>
	<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vpath_idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_cnt</span> <span class="o">&gt;</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">max_mac_addr_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add this mac address to this vpath */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">vxge_mac_list_add</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">vpath_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select first vpath as catch-basin */</span>
	<span class="n">vpath_vector</span> <span class="o">=</span> <span class="n">vxge_mBIT</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
				<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
					<span class="n">rts_mgr_cbasin_cfg</span><span class="p">),</span>
				<span class="n">vpath_vector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Unable to set the vpath-%d in catch-basin mode&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FALSE</span> <span class="o">==</span> <span class="n">vxge_mac_list_add</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vpath_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_xmit</span>
<span class="cm"> * @skb : the socket buffer containing the Tx data.</span>
<span class="cm"> * @dev : device pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the Tx entry point of the driver. Neterion NIC supports</span>
<span class="cm"> * certain protocol assist features on Tx side, namely  CSO, S/G, LSO.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">vxge_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dtr_priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dtr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frg_cnt</span><span class="p">,</span> <span class="n">first_frg_len</span><span class="p">;</span>
	<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">avail</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">dma_pointer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_tx_priv</span> <span class="o">*</span><span class="n">txdl_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_fifo</span> <span class="o">*</span><span class="n">fifo_hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offload_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpath_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* A buffer with no data will be dropped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Buffer has no data..&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: vdev not initialized&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">addr_learn_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vxge_learn_mac</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpath_no</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Failed to store the mac address&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">==</span> <span class="n">TX_MULTIQ_STEERING</span><span class="p">)</span>
		<span class="n">vpath_no</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">==</span> <span class="n">TX_PORT_STEERING</span><span class="p">)</span>
		<span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vxge_get_vpath_no</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: vpath_no= %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpath_no</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpath_no</span> <span class="o">&gt;=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">)</span>
		<span class="n">vpath_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vpath_no</span><span class="p">].</span><span class="n">fifo</span><span class="p">;</span>
	<span class="n">fifo_hw</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="n">avail</span> <span class="o">=</span> <span class="n">vxge_hw_fifo_free_txdl_count_get</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: No free TXDs available&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txd_not_free</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Last TXD?  Stop tx queue to avoid dropping packets.  TX</span>
<span class="cm">	 * completion will resume the queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_fifo_txdl_reserve</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtr_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
		   <span class="s">&quot;%s: Out of descriptors .&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txd_out_of_desc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d fifo_hw = %p dtr = %p dtr_priv = %p&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">dtr_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">vxge_hw_fifo_txdl_vlan_set</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">first_frg_len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">dma_pointer</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">first_frg_len</span><span class="p">,</span>
				<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_pointer</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vxge_hw_fifo_txdl_free</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pci_map_fail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txdl_priv</span> <span class="o">=</span> <span class="n">vxge_hw_fifo_txdl_private_get</span><span class="p">(</span><span class="n">dtr</span><span class="p">);</span>
	<span class="n">txdl_priv</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">txdl_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_pointer</span><span class="p">;</span>

	<span class="n">frg_cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: %s:%d skb = %p txdl_priv = %p &quot;</span>
			<span class="s">&quot;frag_cnt = %d dma_pointer = 0x%llx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txdl_priv</span><span class="p">,</span>
			<span class="n">frg_cnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_pointer</span><span class="p">);</span>

	<span class="n">vxge_hw_fifo_txdl_buffer_set</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">dma_pointer</span><span class="p">,</span>
		<span class="n">first_frg_len</span><span class="p">);</span>

	<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frg_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore 0 length fragment */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dma_pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
						    <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_pointer</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">_exit2</span><span class="p">;</span>
		<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: %s:%d frag = %d dma_pointer = 0x%llx&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_pointer</span><span class="p">);</span>

		<span class="n">txdl_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_pointer</span><span class="p">;</span>
		<span class="n">vxge_hw_fifo_txdl_buffer_set</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">dma_pointer</span><span class="p">,</span>
					<span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="n">frag</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offload_type</span> <span class="o">=</span> <span class="n">vxge_offload_type</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offload_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SKB_GSO_TCPV4</span> <span class="o">|</span> <span class="n">SKB_GSO_TCPV6</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mss</span> <span class="o">=</span> <span class="n">vxge_tcp_mss</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mss</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d mss = %d&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">mss</span><span class="p">);</span>
			<span class="n">vxge_hw_fifo_txdl_mss_set</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span> <span class="n">mss</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vxge_assert</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">VXGE_HW_MAC_HEADER_MAX_SIZE</span><span class="p">);</span>
			<span class="n">vxge_assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">_exit1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="n">vxge_hw_fifo_txdl_cksum_set_bits</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span>
					<span class="n">VXGE_HW_FIFO_TXD_TX_CKO_IPV4_EN</span> <span class="o">|</span>
					<span class="n">VXGE_HW_FIFO_TXD_TX_CKO_TCP_EN</span> <span class="o">|</span>
					<span class="n">VXGE_HW_FIFO_TXD_TX_CKO_UDP_EN</span><span class="p">);</span>

	<span class="n">vxge_hw_fifo_txdl_post</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">_exit2:</span>
	<span class="n">vxge_debug_tx</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: pci_map_page failed&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">_exit1:</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txdl_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">],</span>
			<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txdl_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
			<span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">frag</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_hw_fifo_txdl_free</span><span class="p">(</span><span class="n">fifo_hw</span><span class="p">,</span> <span class="n">dtr</span><span class="p">);</span>
<span class="nl">_exit0:</span>
	<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_rx_term</span>
<span class="cm"> *</span>
<span class="cm"> * Function will be called by hw function to abort all outstanding receive</span>
<span class="cm"> * descriptors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vxge_rx_term</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dtrh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">vxge_hw_rxd_state</span> <span class="n">state</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="p">)</span><span class="n">userdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_rx_priv</span> <span class="o">*</span><span class="n">rx_priv</span> <span class="o">=</span>
		<span class="n">vxge_hw_ring_rxd_private_get</span><span class="p">(</span><span class="n">dtrh</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">VXGE_HW_RXD_STATE_POSTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">,</span>
		<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rx_priv</span><span class="o">-&gt;</span><span class="n">skb_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_tx_term</span>
<span class="cm"> *</span>
<span class="cm"> * Function will be called to abort all outstanding tx descriptors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vxge_tx_term</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dtrh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">vxge_hw_txdl_state</span> <span class="n">state</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">userdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="p">)</span><span class="n">userdata</span><span class="p">;</span>
	<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">frg_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_tx_priv</span> <span class="o">*</span><span class="n">txd_priv</span> <span class="o">=</span> <span class="n">vxge_hw_fifo_txdl_private_get</span><span class="p">(</span><span class="n">dtrh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">txd_priv</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">VXGE_HW_TXDL_STATE_POSTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* check skb validity */</span>
	<span class="n">vxge_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">frg_cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/*  for unfragmented skb */</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txd_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span>
		<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">frg_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">txd_priv</span><span class="o">-&gt;</span><span class="n">dma_buffers</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span>
			       <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">frag</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_mac_list_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">,</span> <span class="k">struct</span> <span class="n">macInfo</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">del_mac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">del_mac</span><span class="p">);</span>

	<span class="cm">/* Copy the mac address to delete from the list */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">macaddr</span> <span class="o">==</span> <span class="n">del_mac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_cnt</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">))</span>
				<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mcast_addr_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* delete a mac address from DA table */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_del_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">macInfo</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>

	<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vpath_no</span><span class="p">];</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mac_addr_delete</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span>
						<span class="n">mac</span><span class="o">-&gt;</span><span class="n">macmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;DA config delete entry failed for vpath:%d&quot;</span><span class="p">,</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vxge_mac_list_del</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_set_multicast</span>
<span class="cm"> * @dev: pointer to the device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Entry point for multicast address enable/disable</span>
<span class="cm"> * This function is a driver entry point which gets called by the kernel</span>
<span class="cm"> * whenever multicast addresses must be enabled/disabled. This also gets</span>
<span class="cm"> * called to set/reset promiscuous mode. Depending on the deivce flag, we</span>
<span class="cm"> * determine, if multicast address must be enabled or if promiscuous mode</span>
<span class="cm"> * is to be disabled etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mcast_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macInfo</span> <span class="n">mac_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="n">mac_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hldev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span>  <span class="o">*</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vxge_assert</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;failed to enable &quot;</span>
						<span class="s">&quot;multicast, status %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vxge_assert</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mcast_disable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;failed to disable &quot;</span>
						<span class="s">&quot;multicast, status %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">addr_learn_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vxge_assert</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_promisc_enable</span><span class="p">(</span>
					<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_promisc_disable</span><span class="p">(</span>
					<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;failed to %s promisc&quot;</span>
					<span class="s">&quot;, status %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IFF_PROMISC</span> <span class="o">?</span>
					<span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macInfo</span><span class="p">));</span>
	<span class="cm">/* Update individual M_CAST address list */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcast_cnt</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mcast_addr_cnt</span><span class="p">;</span>
		<span class="n">list_head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr_list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mac_addr_cnt</span> <span class="o">-</span> <span class="n">mcast_cnt</span><span class="p">))</span> <span class="o">&gt;</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">max_mac_addr_cnt</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">_set_all_mcast</span><span class="p">;</span>

		<span class="cm">/* Delete previous MC&#39;s */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mcast_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">;</span>
				<span class="cm">/* Copy the mac address to delete */</span>
				<span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span>
						<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span>
						<span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mac_info</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_del_mac_addr</span><span class="p">(</span>
								<span class="n">vdev</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">mac_info</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Add new ones */</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span>
					<span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_info</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
				<span class="n">mac_info</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VXGE_LL_MAC_ADDR_IN_DA_TABLE</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_add_mac_addr</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
						<span class="s">&quot;%s:%d Setting individual&quot;</span>
						<span class="s">&quot;multicast address failed&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">_set_all_mcast</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span>
<span class="nl">_set_all_mcast:</span>
		<span class="n">mcast_cnt</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mcast_addr_cnt</span><span class="p">;</span>
		<span class="cm">/* Delete previous MC&#39;s */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mcast_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">list_head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">;</span>
				<span class="cm">/* Copy the mac address to delete */</span>
				<span class="n">mac_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac_entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span>
					<span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mac_info</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_del_mac_addr</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Enable all multicast */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vxge_assert</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;%s:%d Enabling all multicasts failed&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_ALLMULTI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_set_mac_addr</span>
<span class="cm"> * @dev: pointer to the device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Update entry &quot;0&quot; (default MAC addr)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macInfo</span> <span class="n">mac_info_new</span><span class="p">,</span> <span class="n">mac_info_old</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hldev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_info_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macInfo</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_info_old</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macInfo</span><span class="p">));</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Get the old address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info_old</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* Copy the new address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info_new</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* First delete the old mac address from all the vpaths</span>
<span class="cm">	as we can&#39;t specify the index while adding new mac address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vpath_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This can happen when this interface is added/removed</span>
<span class="cm">			to the bonding interface. Delete this station address</span>
<span class="cm">			from the linked list */</span>
			<span class="n">vxge_mac_list_del</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info_old</span><span class="p">);</span>

			<span class="cm">/* Add this new address to the linked list</span>
<span class="cm">			for later restoring */</span>
			<span class="n">vxge_mac_list_add</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info_new</span><span class="p">);</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Delete the station address */</span>
		<span class="n">mac_info_old</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_del_mac_addr</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info_old</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set this mac address to all the vpaths */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_info_new</span><span class="p">.</span><span class="n">vpath_no</span> <span class="o">=</span> <span class="n">vpath_idx</span><span class="p">;</span>
		<span class="n">mac_info_new</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VXGE_LL_MAC_ADDR_IN_DA_TABLE</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_add_mac_addr</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_info_new</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_vpath_intr_enable</span>
<span class="cm"> * @vdev: pointer to vdev</span>
<span class="cm"> * @vp_id: vpath for which to enable the interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * Enables the interrupts for the vpath</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_vpath_intr_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vp_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">msix_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tim_msix_id</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">alarm_msix_id</span> <span class="o">=</span> <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">;</span>

	<span class="n">vxge_hw_vpath_intr_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span>
		<span class="n">vxge_hw_vpath_inta_unmask_tx_rx</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">vxge_hw_vpath_msix_set</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">tim_msix_id</span><span class="p">,</span>
			<span class="n">alarm_msix_id</span><span class="p">);</span>

		<span class="n">msix_id</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">*</span> <span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_msix_unmask</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span><span class="p">);</span>
		<span class="n">vxge_hw_vpath_msix_unmask</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* enable the alarm vector */</span>
		<span class="n">msix_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">hldev</span><span class="o">-&gt;</span><span class="n">first_vp_id</span> <span class="o">*</span>
			<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">)</span> <span class="o">+</span> <span class="n">alarm_msix_id</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_msix_unmask</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_vpath_intr_disable</span>
<span class="cm"> * @vdev: pointer to vdev</span>
<span class="cm"> * @vp_id: vpath for which to disable the interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * Disables the interrupts for the vpath</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_vpath_intr_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vp_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msix_id</span><span class="p">;</span>

	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">vxge_hw_vpath_wait_receive_idle</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>

	<span class="n">vxge_hw_vpath_intr_disable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span>
		<span class="n">vxge_hw_vpath_inta_mask_tx_rx</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">msix_id</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">*</span> <span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_msix_mask</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span><span class="p">);</span>
		<span class="n">vxge_hw_vpath_msix_mask</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* disable the alarm vector */</span>
		<span class="n">msix_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">hldev</span><span class="o">-&gt;</span><span class="n">first_vp_id</span> <span class="o">*</span>
			<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">)</span> <span class="o">+</span> <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_msix_mask</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* list all mac addresses from DA table */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_search_mac_addr_in_da_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">,</span> <span class="k">struct</span> <span class="n">macInfo</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">macmask</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">macaddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mac_addr_get</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				<span class="n">macaddr</span><span class="p">,</span> <span class="n">macmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;DA config list entry failed for vpath:%d&quot;</span><span class="p">,</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mac_addr_get_next</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				<span class="n">macaddr</span><span class="p">,</span> <span class="n">macmask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Store all mac addresses from the list to the DA table */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="nf">vxge_restore_vpath_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macInfo</span> <span class="n">mac_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macInfo</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac_address</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
				<span class="n">VXGE_LL_MAC_ADDR_IN_DA_TABLE</span><span class="p">;</span>
			<span class="cm">/* does this mac address already exist in da table? */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_search_mac_addr_in_da_table</span><span class="p">(</span><span class="n">vpath</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">mac_info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Add this mac address to the DA table */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mac_addr_add</span><span class="p">(</span>
					<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">mac_info</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span>
					<span class="n">mac_info</span><span class="p">.</span><span class="n">macmask</span><span class="p">,</span>
				    <span class="n">VXGE_HW_VPATH_MAC_ADDR_ADD_DUPLICATE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					    <span class="s">&quot;DA add entry failed for vpath:%d&quot;</span><span class="p">,</span>
					    <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">);</span>
					<span class="p">((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">state</span>
						<span class="o">=</span> <span class="n">VXGE_LL_MAC_ADDR_IN_LIST</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Store all vlan ids from the list to the vid table */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span>
<span class="nf">vxge_restore_vpath_vid_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_vid_add</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_reset_vpath</span>
<span class="cm"> * @vdev: pointer to vdev</span>
<span class="cm"> * @vp_id: vpath to reset</span>
<span class="cm"> *</span>
<span class="cm"> * Resets the vpath</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_reset_vpath</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vp_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check if device is down already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* is device reset already scheduled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_RESET_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vxge_hw_vpath_reset</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">vxge_hw_vpath_recover_from_reset</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span>
					<span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;vxge_hw_vpath_recover_from_reset&quot;</span>
					<span class="s">&quot;failed for vpath:%d&quot;</span><span class="p">,</span> <span class="n">vp_id</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;vxge_hw_vpath_reset failed for&quot;</span>
				<span class="s">&quot;vpath:%d&quot;</span><span class="p">,</span> <span class="n">vp_id</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">VXGE_HW_FAIL</span><span class="p">;</span>

	<span class="n">vxge_restore_vpath_mac_addr</span><span class="p">(</span><span class="n">vpath</span><span class="p">);</span>
	<span class="n">vxge_restore_vpath_vid_table</span><span class="p">(</span><span class="n">vpath</span><span class="p">);</span>

	<span class="cm">/* Enable all broadcast */</span>
	<span class="n">vxge_hw_vpath_bcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="cm">/* Enable all multicast */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s:%d Enabling multicast failed&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the interrupts */</span>
	<span class="n">vxge_vpath_intr_enable</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vp_id</span><span class="p">);</span>

	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="cm">/* Enable the flow of traffic through the vpath */</span>
	<span class="n">vxge_hw_vpath_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">vxge_hw_vpath_rx_doorbell_init</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>

	<span class="cm">/* Vpath reset done */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vp_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset</span><span class="p">);</span>

	<span class="cm">/* Start the vpath queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_tx_queue_stopped</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">txq</span><span class="p">))</span>
		<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure CI */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_config_ci_for_tti_rti</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable CI for RTI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">__vxge_hw_ring</span> <span class="o">*</span><span class="n">hw_ring</span><span class="p">;</span>

			<span class="n">hw_ring</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">vxge_hw_vpath_dynamic_rti_ci_set</span><span class="p">(</span><span class="n">hw_ring</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable CI for TTI */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">__vxge_hw_fifo</span> <span class="o">*</span><span class="n">hw_fifo</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_tti_ci_set</span><span class="p">(</span><span class="n">hw_fifo</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * For Inta (with or without napi), Set CI ON for only one</span>
<span class="cm">		 * vpath. (Have only one free running timer).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_vxge_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vp_id</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_START_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* check if device is down already */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* is reset already scheduled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_RESET_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

		<span class="cm">/* wait for all the vpath reset to complete */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vp_id</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vp_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">vp_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset</span><span class="p">))</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

		<span class="cm">/* if execution mode is set to debug, don&#39;t reset the adapter */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: execution mode is debug, returning..&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_hw_device_wait_receive_idle</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>
		<span class="n">vxge_hw_device_intr_disable</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">cric_err_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_UNKNOWN</span>:
			<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;fatal: %s: Disabling device due to&quot;</span>
				<span class="s">&quot;unknown error&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_RESET_START</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_RESET_COMPLETE</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_LINK_DOWN</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_LINK_UP</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_ALARM_CLEARED</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_ECCERR</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_MRPCIM_ECCERR</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_FIFO_ERR</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_VPATH_ERR</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_CRITICAL_ERR</span>:
			<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;fatal: %s: Disabling device due to&quot;</span>
				<span class="s">&quot;serious error&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* SOP or device reset required */</span>
			<span class="cm">/* This event is not currently used */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_SERR</span>:
			<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;fatal: %s: Disabling device due to&quot;</span>
				<span class="s">&quot;serious error&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_SRPCIM_SERR</span>:
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_MRPCIM_SERR</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_EVENT_SLOT_FREEZE</span>:
			<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;fatal: %s: Disabling device due to&quot;</span>
				<span class="s">&quot;slot freeze&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_START_RESET</span><span class="p">))</span>
		<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_reset_all_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;fatal: %s: can not reset vpaths&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_COMPL_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vxge_hw_vpath_recover_from_reset</span><span class="p">(</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">)</span>
						<span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
						<span class="s">&quot;vxge_hw_vpath_recover_&quot;</span>
						<span class="s">&quot;from_reset failed for vpath: &quot;</span>
						<span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;vxge_hw_vpath_reset failed for &quot;</span>
						<span class="s">&quot;vpath:%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_COMPL_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reprogram the DA table with populated mac addresses */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vp_id</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vp_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_restore_vpath_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">]);</span>
			<span class="n">vxge_restore_vpath_vid_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="cm">/* enable vpath interrupts */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vxge_vpath_intr_enable</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">vxge_hw_device_intr_enable</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>

		<span class="n">smp_wmb</span><span class="p">();</span>

		<span class="cm">/* Indicate card up */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* Get the traffic to flow through the vpaths */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_hw_vpath_enable</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">);</span>
			<span class="n">smp_wmb</span><span class="p">();</span>
			<span class="n">vxge_hw_vpath_rx_doorbell_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* configure CI */</span>
	<span class="n">vxge_config_ci_for_tti_rti</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Indicate reset done */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">VXGE_LL_COMPL_RESET</span><span class="p">))</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_RESET_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_reset</span>
<span class="cm"> * @vdev: pointer to ll device</span>
<span class="cm"> *</span>
<span class="cm"> * driver may reset the chip on events of serr, eccerr, etc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxgedev</span><span class="p">,</span> <span class="n">reset_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">do_vxge_reset</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_poll - Receive handler when Receive Polling is used.</span>
<span class="cm"> * @dev: pointer to the device structure.</span>
<span class="cm"> * @budget: Number of packets budgeted to be processed in this iteration.</span>
<span class="cm"> *</span>
<span class="cm"> * This function comes into picture only if Receive side is being handled</span>
<span class="cm"> * through polling (called NAPI in linux). It mostly does what the normal</span>
<span class="cm"> * Rx interrupt handler does in terms of descriptor and packet processing</span>
<span class="cm"> * but not in an interrupt context. Also it will process a specified number</span>
<span class="cm"> * of packets at most in one iteration. This value is passed down by the</span>
<span class="cm"> * kernel as the function argument &#39;budget&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_poll_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxge_ring</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pkts_processed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">budget_org</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">budget</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vxge_hw_vpath_poll_rx</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">pkts_processed</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span> <span class="o">&lt;</span> <span class="n">budget_org</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

		<span class="cm">/* Re enable the Rx interrupts for the vpath */</span>
		<span class="n">vxge_hw_channel_msix_unmask</span><span class="p">(</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_vector_no</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* We are copying and returning the local variable, in case if after</span>
<span class="cm">	 * clearing the msix interrupt above, if the interrupt fires right</span>
<span class="cm">	 * away which can preempt this NAPI thread */</span>
	<span class="k">return</span> <span class="n">pkts_processed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_poll_inta</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxgedev</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pkts_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">budget_org</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">budget</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_poll_rx</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">pkts_processed</span> <span class="o">+=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span><span class="p">;</span>
		<span class="n">budget</span> <span class="o">-=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">pkts_processed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">budget</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">VXGE_COMPLETE_ALL_TX</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkts_processed</span> <span class="o">&lt;</span> <span class="n">budget_org</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/* Re enable the Rx interrupts for the ring */</span>
		<span class="n">vxge_hw_device_unmask_all</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
		<span class="n">vxge_hw_device_flush_io</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pkts_processed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/**</span>
<span class="cm"> * vxge_netpoll - netpoll event handler entry point</span>
<span class="cm"> * @dev : pointer to the device structure.</span>
<span class="cm"> * Description:</span>
<span class="cm"> *      This function will be called by upper layer to check for events on the</span>
<span class="cm"> * interface in situations where interrupts are disabled. It is used for</span>
<span class="cm"> * specific in-kernel networking tasks, such as remote consoles and kernel</span>
<span class="cm"> * debugging over the network (example netdump in RedHat).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">vxge_hw_device_clear_tx_rx</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>

	<span class="n">vxge_hw_device_clear_tx_rx</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="n">VXGE_COMPLETE_ALL_RX</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">VXGE_COMPLETE_ALL_TX</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* RTH configuration */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="nf">vxge_rth_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_hw_rth_hash_types</span> <span class="n">hash_types</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">itable</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="cm">/* indirection table */</span>
	<span class="n">u8</span> <span class="n">mtable</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="cm">/* CPU to vpath mapping  */</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Filling</span>
<span class="cm">	 * 	- itable with bucket numbers</span>
<span class="cm">	 * 	- mtable with bucket-to-vpath mapping</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_bkt_sz</span><span class="p">);</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itable</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">mtable</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set indirection table, bucket-to-vpath mapping */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_rts_rth_itable_set</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_handles</span><span class="p">,</span>
						<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">,</span>
						<span class="n">mtable</span><span class="p">,</span> <span class="n">itable</span><span class="p">,</span>
						<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_bkt_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;RTH indirection table configuration failed &quot;</span>
			<span class="s">&quot;for vpath:%d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">device_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill RTH hash types */</span>
	<span class="n">hash_types</span><span class="p">.</span><span class="n">hash_type_tcpipv4_en</span>   <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_hash_type_tcpipv4</span><span class="p">;</span>
	<span class="n">hash_types</span><span class="p">.</span><span class="n">hash_type_ipv4_en</span>      <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_hash_type_ipv4</span><span class="p">;</span>
	<span class="n">hash_types</span><span class="p">.</span><span class="n">hash_type_tcpipv6_en</span>   <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_hash_type_tcpipv6</span><span class="p">;</span>
	<span class="n">hash_types</span><span class="p">.</span><span class="n">hash_type_ipv6_en</span>      <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_hash_type_ipv6</span><span class="p">;</span>
	<span class="n">hash_types</span><span class="p">.</span><span class="n">hash_type_tcpipv6ex_en</span> <span class="o">=</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_hash_type_tcpipv6ex</span><span class="p">;</span>
	<span class="n">hash_types</span><span class="p">.</span><span class="n">hash_type_ipv6ex_en</span>    <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_hash_type_ipv6ex</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Because the itable_set() method uses the active_table field</span>
<span class="cm">	 * for the target virtual path the RTH config should be updated</span>
<span class="cm">	 * for all VPATHs. The h/w only uses the lowest numbered VPATH</span>
<span class="cm">	 * when steering frames.</span>
<span class="cm">	 */</span>
	 <span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_rts_rth_set</span><span class="p">(</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_algorithm</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hash_types</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_bkt_sz</span><span class="p">);</span>
		 <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;RTH configuration failed for vpath:%d&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">device_id</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		 <span class="p">}</span>
	 <span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reset vpaths */</span>
<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="nf">vxge_reset_all_vpaths</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vxge_hw_vpath_reset</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">vxge_hw_vpath_recover_from_reset</span><span class="p">(</span>
						<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
						<span class="s">&quot;vxge_hw_vpath_recover_&quot;</span>
						<span class="s">&quot;from_reset failed for vpath: &quot;</span>
						<span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;vxge_hw_vpath_reset failed for &quot;</span>
					<span class="s">&quot;vpath:%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* close vpaths */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_close_vpaths</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">&amp;&amp;</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_hw_vpath_close</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vpaths_open</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* open vpaths */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_open_vpaths</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_hw_vpath_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">vxge_assert</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_configured</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">titan1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vxge_hw_vp_config</span> <span class="o">*</span><span class="n">vcfg</span><span class="p">;</span>
			<span class="n">vcfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">vp_config</span><span class="p">[</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">];</span>

			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">rti</span><span class="p">.</span><span class="n">urange_a</span> <span class="o">=</span> <span class="n">RTI_T1A_RX_URANGE_A</span><span class="p">;</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">rti</span><span class="p">.</span><span class="n">urange_b</span> <span class="o">=</span> <span class="n">RTI_T1A_RX_URANGE_B</span><span class="p">;</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">rti</span><span class="p">.</span><span class="n">urange_c</span> <span class="o">=</span> <span class="n">RTI_T1A_RX_URANGE_C</span><span class="p">;</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_a</span> <span class="o">=</span> <span class="n">TTI_T1A_TX_UFC_A</span><span class="p">;</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_b</span> <span class="o">=</span> <span class="n">TTI_T1A_TX_UFC_B</span><span class="p">;</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_c</span> <span class="o">=</span> <span class="n">TTI_T1A_TX_UFC_C</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_d</span> <span class="o">=</span> <span class="n">TTI_T1A_TX_UFC_D</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">tti</span><span class="p">.</span><span class="n">ltimer_val</span> <span class="o">=</span> <span class="n">VXGE_T1A_TTI_LTIMER_VAL</span><span class="p">;</span>
			<span class="n">vcfg</span><span class="o">-&gt;</span><span class="n">tti</span><span class="p">.</span><span class="n">rtimer_val</span> <span class="o">=</span> <span class="n">VXGE_T1A_TTI_RTIMER_VAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">attr</span><span class="p">.</span><span class="n">vp_id</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">fifo_attr</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">vxge_xmit_compl</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">fifo_attr</span><span class="p">.</span><span class="n">txdl_term</span> <span class="o">=</span> <span class="n">vxge_tx_term</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">fifo_attr</span><span class="p">.</span><span class="n">per_txdl_space</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_tx_priv</span><span class="p">);</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">fifo_attr</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">;</span>

		<span class="n">attr</span><span class="p">.</span><span class="n">ring_attr</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">vxge_rx_1b_compl</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">ring_attr</span><span class="p">.</span><span class="n">rxd_init</span> <span class="o">=</span> <span class="n">vxge_rx_initial_replenish</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">ring_attr</span><span class="p">.</span><span class="n">rxd_term</span> <span class="o">=</span> <span class="n">vxge_rx_term</span><span class="p">;</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">ring_attr</span><span class="p">.</span><span class="n">per_rxd_space</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_rx_priv</span><span class="p">);</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">ring_attr</span><span class="p">.</span><span class="n">userdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>

		<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
		<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_open</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_fifo</span> <span class="o">*</span><span class="p">)</span><span class="n">attr</span><span class="p">.</span><span class="n">fifo_attr</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_ring</span> <span class="o">*</span><span class="p">)</span><span class="n">attr</span><span class="p">.</span><span class="n">ring_attr</span><span class="p">.</span><span class="n">userdata</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">=</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span><span class="p">)</span>
				<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">txq</span> <span class="o">=</span>
					<span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">txq</span> <span class="o">=</span>
					<span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">indicate_max_pkts</span> <span class="o">=</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fifo_indicate_max_pkts</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_vector_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rx_vector_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rx_hwts</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">rx_hwts</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">vlan_tag_strip</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vlan_tag_strip</span><span class="p">;</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vpaths_open</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vpath_open_fail</span><span class="o">++</span><span class="p">;</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: vpath: %d failed to &quot;</span>
					<span class="s">&quot;open with status: %d&quot;</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span>
					<span class="n">status</span><span class="p">);</span>
			<span class="n">vxge_close_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vp_id</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">vp_id</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths_deployed</span> <span class="o">|=</span> <span class="n">vxge_mBIT</span><span class="p">(</span><span class="n">vp_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  adaptive_coalesce_tx_interrupts - Changes the interrupt coalescing</span>
<span class="cm"> *  if the interrupts are not within a range</span>
<span class="cm"> *  @fifo: pointer to transmit fifo structure</span>
<span class="cm"> *  Description: The function changes boundary timer and restriction timer</span>
<span class="cm"> *  value depends on the traffic</span>
<span class="cm"> *  Return Value: None</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adaptive_coalesce_tx_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="n">fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">interrupt_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">&gt;</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">__vxge_hw_fifo</span> <span class="o">*</span><span class="n">hw_fifo</span> <span class="o">=</span> <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">interrupt_count</span> <span class="o">&gt;</span> <span class="n">VXGE_T1A_MAX_TX_INTERRUPT_COUNT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hw_fifo</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">!=</span> <span class="n">VXGE_TTI_RTIMER_ADAPT_VAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_fifo</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">=</span> <span class="n">VXGE_TTI_RTIMER_ADAPT_VAL</span><span class="p">;</span>
			<span class="n">vxge_hw_vpath_dynamic_tti_rtimer_set</span><span class="p">(</span><span class="n">hw_fifo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_fifo</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_fifo</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vxge_hw_vpath_dynamic_tti_rtimer_set</span><span class="p">(</span><span class="n">hw_fifo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fifo</span><span class="o">-&gt;</span><span class="n">interrupt_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  adaptive_coalesce_rx_interrupts - Changes the interrupt coalescing</span>
<span class="cm"> *  if the interrupts are not within a range</span>
<span class="cm"> *  @ring: pointer to receive ring structure</span>
<span class="cm"> *  Description: The function increases of decreases the packet counts within</span>
<span class="cm"> *  the ranges of traffic utilization, if the interrupts due to this ring are</span>
<span class="cm"> *  not within a fixed range.</span>
<span class="cm"> *  Return Value: Nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">adaptive_coalesce_rx_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">interrupt_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">&gt;</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">__vxge_hw_ring</span> <span class="o">*</span><span class="n">hw_ring</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">interrupt_count</span> <span class="o">&gt;</span> <span class="n">VXGE_T1A_MAX_INTERRUPT_COUNT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hw_ring</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">!=</span> <span class="n">VXGE_RTI_RTIMER_ADAPT_VAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_ring</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">=</span> <span class="n">VXGE_RTI_RTIMER_ADAPT_VAL</span><span class="p">;</span>
			<span class="n">vxge_hw_vpath_dynamic_rti_rtimer_set</span><span class="p">(</span><span class="n">hw_ring</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_ring</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_ring</span><span class="o">-&gt;</span><span class="n">rtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vxge_hw_vpath_dynamic_rti_rtimer_set</span><span class="p">(</span><span class="n">hw_ring</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">interrupt_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  vxge_isr_napi</span>
<span class="cm"> *  @irq: the irq of the device.</span>
<span class="cm"> *  @dev_id: a void pointer to the hldev structure of the Titan device</span>
<span class="cm"> *  @ptregs: pointer to the registers pushed on the stack.</span>
<span class="cm"> *</span>
<span class="cm"> *  This function is the ISR handler of the device when napi is enabled. It</span>
<span class="cm"> *  identifies the reason for the interrupt and calls the relevant service</span>
<span class="cm"> *  routines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vxge_isr_napi</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reason</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">vxge_debug_intr</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_device_begin_irq</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reason</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_hw_device_mask_all</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span>
			<span class="n">VXGE_HW_TITAN_GENERAL_INT_STATUS_VPATH_TRAFFIC_INT</span><span class="p">(</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths_deployed</span> <span class="o">&gt;&gt;</span>
			<span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">)))</span> <span class="p">{</span>

			<span class="n">vxge_hw_device_clear_tx_rx</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
			<span class="n">vxge_debug_intr</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
				<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vxge_hw_device_unmask_all</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_ERR_VPATH</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_ERR_CRITICAL</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_ERR_FIFO</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vxge_hw_device_mask_all</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
		<span class="n">vxge_hw_device_flush_io</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_ERR_SLOT_FREEZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">vxge_debug_intr</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vxge_tx_msix_handle</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="n">fifo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_fifo</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">adaptive_coalesce_tx_interrupts</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>

	<span class="n">vxge_hw_channel_msix_mask</span><span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				  <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_vector_no</span><span class="p">);</span>

	<span class="n">vxge_hw_channel_msix_clear</span><span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				   <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_vector_no</span><span class="p">);</span>

	<span class="n">VXGE_COMPLETE_VPATH_TX</span><span class="p">(</span><span class="n">fifo</span><span class="p">);</span>

	<span class="n">vxge_hw_channel_msix_unmask</span><span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">fifo</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				    <span class="n">fifo</span><span class="o">-&gt;</span><span class="n">tx_vector_no</span><span class="p">);</span>

	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vxge_rx_msix_napi_handle</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">adaptive_coalesce_rx_interrupts</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="n">vxge_hw_channel_msix_mask</span><span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_vector_no</span><span class="p">);</span>

	<span class="n">vxge_hw_channel_msix_clear</span><span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_channel</span> <span class="o">*</span><span class="p">)</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				   <span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_vector_no</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">vxge_alarm_msix_handle</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vpath</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msix_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">vp_id</span> <span class="o">*</span>
		<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">)</span> <span class="o">+</span> <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reduce the chance of losing alarm interrupts by masking</span>
<span class="cm">		 * the vector. A pending bit will be set if an alarm is</span>
<span class="cm">		 * generated and on unmask the interrupt will be fired.</span>
<span class="cm">		 */</span>
		<span class="n">vxge_hw_vpath_msix_mask</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span><span class="p">);</span>
		<span class="n">vxge_hw_vpath_msix_clear</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span> <span class="n">msix_id</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_alarm_process</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_hw_vpath_msix_unmask</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span>
						  <span class="n">msix_id</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vxge_debug_intr</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: vxge_hw_vpath_alarm_process failed %x &quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_alloc_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msix_intr_vect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">start:</span>
	<span class="cm">/* Tx/Rx MSIX Vectors count */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Alarm MSIX Vectors count */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: memory allocation failed&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc_entries_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_msix_entry</span><span class="p">),</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: memory allocation failed&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc_vxge_entries_failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">msix_intr_vect</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">;</span>

		<span class="cm">/* Initialize the fifo vector */</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">msix_intr_vect</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">msix_intr_vect</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Initialize the ring vector */</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">msix_intr_vect</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">msix_intr_vect</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the alarm vector */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: MSI-X enable failed for %d vectors, ret: %d&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">max_config_vpath</span> <span class="o">!=</span> <span class="n">VXGE_USE_DEFAULT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">enable_msix_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* Try with less no of vector by reducing no of vpaths count */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">vxge_close_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">enable_msix_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">enable_msix_failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">);</span>
<span class="nl">alloc_vxge_entries_failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
<span class="nl">alloc_entries_failed:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* 0 - Tx, 1 - Rx  */</span>
	<span class="kt">int</span> <span class="n">tim_msix_id</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">intr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate msix vectors */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vxge_alloc_msix</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="cm">/* If fifo or ring are not enabled, the MSIX vector for</span>
<span class="cm">			 * it should be set to 0.</span>
<span class="cm">			 */</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rx_vector_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">*</span>
						<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_vector_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">*</span>
						<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">);</span>

			<span class="n">vxge_hw_vpath_msix_set</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">tim_msix_id</span><span class="p">,</span>
					       <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_rem_msix_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">intr_cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">intr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">intr_cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">intr_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">arg</span><span class="p">);</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">);</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_rem_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_rem_msix_isr</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_add_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="kt">int</span> <span class="n">vp_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">intr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msix_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_fun</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vxge_enable_msix</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Enabling MSI-X Failed&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Defaulting to INTA&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">intr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">intr_idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">*</span>
			<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">);</span> <span class="n">intr_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">msix_idx</span> <span class="o">=</span> <span class="n">intr_idx</span> <span class="o">%</span> <span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">;</span>
			<span class="n">irq_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">msix_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">snprintf</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">],</span> <span class="n">VXGE_INTR_STRLEN</span><span class="p">,</span>
				<span class="s">&quot;%s:vxge:MSI-X %d - Tx - fn:%d vpath:%d&quot;</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">entry</span><span class="p">,</span>
					<span class="n">pci_fun</span><span class="p">,</span> <span class="n">vp_idx</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span>
				    <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					<span class="n">vxge_tx_msix_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">fifo</span><span class="p">);</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">fifo</span><span class="p">;</span>
				<span class="n">irq_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">snprintf</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">],</span> <span class="n">VXGE_INTR_STRLEN</span><span class="p">,</span>
				<span class="s">&quot;%s:vxge:MSI-X %d - Rx - fn:%d vpath:%d&quot;</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">entry</span><span class="p">,</span>
					<span class="n">pci_fun</span><span class="p">,</span> <span class="n">vp_idx</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span>
				    <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					<span class="n">vxge_rx_msix_napi_handle</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">ring</span><span class="p">);</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">ring</span><span class="p">;</span>
				<span class="n">irq_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;%s: MSIX - %d  Registration failed&quot;</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">intr_cnt</span><span class="p">);</span>
				<span class="n">vxge_rem_msix_isr</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;%s: Defaulting to INTA&quot;</span>
					<span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">INTA_MODE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">irq_req</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We requested for this msix interrupt */</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">msix_idx</span> <span class="o">+=</span>  <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">device_id</span> <span class="o">*</span>
					<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">;</span>
				<span class="n">vxge_hw_vpath_msix_unmask</span><span class="p">(</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span>
					<span class="n">msix_idx</span><span class="p">);</span>
				<span class="n">intr_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Point to next vpath handler */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">intr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">vp_idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
				<span class="n">vp_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">intr_cnt</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">],</span> <span class="n">VXGE_INTR_STRLEN</span><span class="p">,</span>
			<span class="s">&quot;%s:vxge:MSI-X %d - Alarm - fn:%d&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">entry</span><span class="p">,</span>
			<span class="n">pci_fun</span><span class="p">);</span>
		<span class="cm">/* For Alarm interrupts */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					<span class="n">vxge_alarm_msix_handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: MSIX - %d Registration failed&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">intr_cnt</span><span class="p">);</span>
			<span class="n">vxge_rem_msix_isr</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Defaulting to INTA&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">INTA_MODE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msix_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">vp_id</span> <span class="o">*</span>
			<span class="n">VXGE_HW_VPATH_MSIX_ACTIVE</span><span class="p">)</span> <span class="o">+</span> <span class="n">VXGE_ALARM_MSIX_ID</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_msix_unmask</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_idx</span><span class="p">].</span><span class="n">handle</span><span class="p">,</span>
					<span class="n">msix_idx</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vxge_entries</span><span class="p">[</span><span class="n">intr_cnt</span><span class="p">].</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
<span class="nl">INTA_MODE:</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VXGE_INTR_STRLEN</span><span class="p">,</span>
			<span class="s">&quot;%s:vxge:INTA&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vxge_hw_device_set_intr_type</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
			<span class="n">VXGE_HW_INTR_MODE_IRQLINE</span><span class="p">);</span>

		<span class="n">vxge_hw_vpath_tti_ci_set</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">vxge_isr_napi</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s %s-%d: ISR registration failed&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="s">&quot;IRQ&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;new %s-%d line allocated&quot;</span><span class="p">,</span>
			<span class="s">&quot;IRQ&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_poll_vp_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vxge_reset_vpath</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">MSI_X</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vxge_hw_device_unmask_all</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>
		<span class="n">vxge_hw_device_flush_io</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_poll_vp_lockup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_frms</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">;</span>

		<span class="cm">/* Truncated to machine word size number of frames */</span>
		<span class="n">rx_frms</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frms</span><span class="p">);</span>

		<span class="cm">/* Did this vpath received any packets */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">prev_rx_frms</span> <span class="o">==</span> <span class="n">rx_frms</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_check_leak</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

			<span class="cm">/* Did it received any packets last time */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">VXGE_HW_FAIL</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">VXGE_HW_FAIL</span> <span class="o">==</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_status</span><span class="p">))</span> <span class="p">{</span>

				<span class="cm">/* schedule vpath reset */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

					<span class="cm">/* disable interrupts for this vpath */</span>
					<span class="n">vxge_vpath_intr_disable</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

					<span class="cm">/* stop the queue for this vpath */</span>
					<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">txq</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">prev_rx_frms</span> <span class="o">=</span> <span class="n">rx_frms</span><span class="p">;</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check every 1 milli second */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_lockup_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">vxge_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="cm">/* Enabling RTH requires some of the logic in vxge_device_register and a</span>
<span class="cm">	 * vpath reset.  Due to these restrictions, only allow modification</span>
<span class="cm">	 * while the interface is down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">^=</span> <span class="n">NETIF_F_RXHASH</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* !netif_running() ensured by vxge_fix_features() */</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_en</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vxge_reset_all_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">NETIF_F_RXHASH</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_en</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXHASH</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_open</span>
<span class="cm"> * @dev: pointer to the device structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the open entry point of the driver. It mainly calls a</span>
<span class="cm"> * function to allocate Rx buffers and inserts them into the buffer</span>
<span class="cm"> * descriptors and then enables the Rx part of the NIC.</span>
<span class="cm"> * Return value: &#39;0&#39; on success and an appropriate (-)ve integer as</span>
<span class="cm"> * defined in errno.h file on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">,</span> <span class="n">function_mode</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">function_mode</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">function_mode</span><span class="p">;</span>

	<span class="cm">/* make sure you have link off by default every time Nic is</span>
<span class="cm">	 * initialized */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Open VPATHs */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_open_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: fatal: Vpath open failed&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_add_isr</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: fatal: ISR add failed&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">MSI_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">vxge_poll_inta</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi_weight</span><span class="p">);</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">napi_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">napi</span><span class="p">,</span>
			    <span class="n">vxge_poll_msix</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">napi_weight</span><span class="p">);</span>
			<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">napi</span><span class="p">);</span>
			<span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">napi_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">napi</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* configure RTH */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_steering</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_rth_configure</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: fatal: RTH configuration failed&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Receive Hashing Offload %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_en</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* set initial mtu before enabling the device */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mtu_set</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: fatal: can not set new MTU&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">VXGE_DEVICE_DEBUG_LEVEL_SET</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="n">VXGE_COMPONENT_LL</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;%s: MTU is %d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>
	<span class="n">VXGE_DEVICE_DEBUG_LEVEL_SET</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="n">VXGE_COMPONENT_LL</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* Restore the DA, VID table and also multicast and promiscuous mode</span>
<span class="cm">	 * states</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">all_multi_flg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">vxge_restore_vpath_mac_addr</span><span class="p">(</span><span class="n">vpath</span><span class="p">);</span>
			<span class="n">vxge_restore_vpath_vid_table</span><span class="p">(</span><span class="n">vpath</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;%s:%d Enabling multicast failed&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable vpath to sniff all unicast/multicast traffic that not</span>
<span class="cm">	 * addressed to them. We allow promiscuous mode for PF only</span>
<span class="cm">	 */</span>

	<span class="n">val64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">val64</span> <span class="o">|=</span> <span class="n">VXGE_HW_RXMAC_AUTHORIZE_ALL_ADDR_VP</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
		<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
			<span class="n">rxmac_authorize_all_addr</span><span class="p">),</span>
		<span class="n">val64</span><span class="p">);</span>

	<span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
		<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
			<span class="n">rxmac_authorize_all_vid</span><span class="p">),</span>
		<span class="n">val64</span><span class="p">);</span>

	<span class="n">vxge_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enabling Bcast and mcast for all vpath */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_bcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s : Can not enable bcast for vpath &quot;</span>
				<span class="s">&quot;id %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">addr_learn_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_mcast_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span>
				<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
					<span class="s">&quot;%s : Can not enable mcast for vpath &quot;</span>
					<span class="s">&quot;id %d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vxge_hw_device_setpause_data</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_pause_enable</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_pause_enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">vxge_os_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset_timer</span><span class="p">,</span> <span class="n">vxge_poll_vp_reset</span><span class="p">,</span> <span class="n">vdev</span><span class="p">,</span>
			      <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* There is no need to check for RxD leak and RxD lookup on Titan1A */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">titan1</span> <span class="o">&amp;&amp;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_lockup_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">vxge_os_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_lockup_timer</span><span class="p">,</span> <span class="n">vxge_poll_vp_lockup</span><span class="p">,</span> <span class="n">vdev</span><span class="p">,</span>
			      <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxge_hw_device_link_state_get</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_HW_LINK_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link Up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_up</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_hw_device_intr_enable</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>

	<span class="n">smp_wmb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">vxge_hw_vpath_enable</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">vxge_hw_vpath_rx_doorbell_init</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* configure CI */</span>
	<span class="n">vxge_config_ci_for_tti_rti</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>

<span class="nl">out2:</span>
	<span class="n">vxge_rem_isr</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* Disable napi */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out1:</span>
	<span class="n">vxge_close_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out0:</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
				<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Loop through the mac address list and delete all the entries */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_free_mac_add_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">mac_addr_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_napi_del_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_vxge_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">,</span> <span class="n">vpath_vector</span><span class="p">;</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If vxge_handle_crit_err task is executing,</span>
<span class="cm">	 * wait till it completes. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_RESET_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Put the vpath back in normal mode */</span>
		<span class="n">vpath_vector</span> <span class="o">=</span> <span class="n">vxge_mBIT</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">device_id</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_mgmt_reg_read</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
				<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
					<span class="n">rts_mgr_cbasin_cfg</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">val64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val64</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">vpath_vector</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
					<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
						<span class="n">rts_mgr_cbasin_cfg</span><span class="p">),</span>
					<span class="n">val64</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Remove the function 0 from promiscuous mode */</span>
		<span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
			<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
				<span class="n">rxmac_authorize_all_addr</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">);</span>

		<span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">,</span>
			<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
				<span class="n">rxmac_authorize_all_vid</span><span class="p">),</span>
			<span class="mi">0</span><span class="p">);</span>

		<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">titan1</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_lockup_timer</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span>
		<span class="n">vxge_hw_device_wait_receive_idle</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* Disable napi */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">MSI_X</span><span class="p">)</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Note that at this point xmit() is stopped by upper layer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span>
		<span class="n">vxge_hw_device_intr_disable</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">);</span>

	<span class="n">vxge_rem_isr</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">vxge_napi_del_all</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_io</span><span class="p">)</span>
		<span class="n">vxge_reset_all_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">vxge_close_vpaths</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_RESET_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_close</span>
<span class="cm"> * @dev: device pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the stop entry point of the driver. It needs to undo exactly</span>
<span class="cm"> * whatever was done by the open entry point, thus it&#39;s usually referred to</span>
<span class="cm"> * as the close function.Among other things this function mainly stops the</span>
<span class="cm"> * Rx side of the NIC and frees all the Rx buffers in the Rx rings.</span>
<span class="cm"> * Return value: &#39;0&#39; on success and an appropriate (-)ve integer as</span>
<span class="cm"> * defined in errno.h file on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_vxge_close</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_change_mtu</span>
<span class="cm"> * @dev: net device pointer.</span>
<span class="cm"> * @new_mtu :the new MTU size for the device.</span>
<span class="cm"> *</span>
<span class="cm"> * A driver entry point to change MTU size for the device. Before changing</span>
<span class="cm"> * the MTU the device must be stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MIN_MTU</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">VXGE_HW_MAX_MTU</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_err</span><span class="p">,</span>
			<span class="s">&quot;%s: mtu size is invalid&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if device is down already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">is_vxge_card_up</span><span class="p">(</span><span class="n">vdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* just store new value, will use later on open() */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_err</span><span class="p">,</span>
			<span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="s">&quot;device is down on MTU change&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;trying to apply new MTU %d&quot;</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxge_close</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vxge_open</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;%s: MTU changed to %d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_get_stats64</span>
<span class="cm"> * @dev: pointer to the device structure</span>
<span class="cm"> * @stats: pointer to struct rtnl_link_stats64</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span>
<span class="nf">vxge_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">net_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="cm">/* net_stats already zeroed by caller */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vxge_ring_stats</span> <span class="o">*</span><span class="n">rxstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">stats</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vxge_fifo_stats</span> <span class="o">*</span><span class="n">txstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">stats</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">packets</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">multicast</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>

			<span class="n">packets</span>   <span class="o">=</span> <span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">rx_frms</span><span class="p">;</span>
			<span class="n">multicast</span> <span class="o">=</span> <span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">rx_mcast</span><span class="p">;</span>
			<span class="n">bytes</span>     <span class="o">=</span> <span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">+=</span> <span class="n">packets</span><span class="p">;</span>
		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">+=</span> <span class="n">multicast</span><span class="p">;</span>

		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">+=</span> <span class="n">rxstats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txstats</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>

			<span class="n">packets</span> <span class="o">=</span> <span class="n">txstats</span><span class="o">-&gt;</span><span class="n">tx_frms</span><span class="p">;</span>
			<span class="n">bytes</span>   <span class="o">=</span> <span class="n">txstats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txstats</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">packets</span><span class="p">;</span>
		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">net_stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">txstats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">net_stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="nf">vxge_timestamp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">devh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val64</span><span class="p">;</span>

	<span class="cm">/* Timestamp is passed to the driver via the FCS, therefore we</span>
<span class="cm">	 * must disable the FCS stripping by the adapter.  Since this is</span>
<span class="cm">	 * required for the driver to load (due to a hardware bug),</span>
<span class="cm">	 * there is no need to do anything special here.</span>
<span class="cm">	 */</span>
	<span class="n">val64</span> <span class="o">=</span> <span class="n">VXGE_HW_XMAC_TIMESTAMP_EN</span> <span class="o">|</span>
		<span class="n">VXGE_HW_XMAC_TIMESTAMP_USE_LINK_ID</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VXGE_HW_XMAC_TIMESTAMP_INTERVAL</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_mgmt_reg_write</span><span class="p">(</span><span class="n">devh</span><span class="p">,</span>
					<span class="n">vxge_hw_mgmt_reg_type_mrpcim</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_mrpcim_reg</span><span class="p">,</span>
						 <span class="n">xmac_timestamp</span><span class="p">),</span>
					<span class="n">val64</span><span class="p">);</span>
	<span class="n">vxge_hw_device_flush_io</span><span class="p">(</span><span class="n">devh</span><span class="p">);</span>
	<span class="n">devh</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">hwts_en</span> <span class="o">=</span> <span class="n">VXGE_HW_HWTS_ENABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_hwtstamp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwtstamp_config</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* reserved for future extensions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Transmit HW Timestamp not supported */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">tx_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_TX_OFF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_TX_ON</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_NONE</span>:
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">rx_hwts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">HWTSTAMP_FILTER_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_ALL</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_SOME</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V1_L4_DELAY_REQ</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L4_DELAY_REQ</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_L2_DELAY_REQ</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_EVENT</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_SYNC</span>:
	<span class="k">case</span> <span class="n">HWTSTAMP_FILTER_PTP_V2_DELAY_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">hwts_en</span> <span class="o">!=</span> <span class="n">VXGE_HW_HWTS_ENABLE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">rx_hwts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">config</span><span class="p">.</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">HWTSTAMP_FILTER_ALL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">rx_hwts</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">rx_hwts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_ioctl</span>
<span class="cm"> * @dev: Device pointer.</span>
<span class="cm"> * @ifr: An IOCTL specific structure, that can contain a pointer to</span>
<span class="cm"> *       a proprietary structure used to pass information to the driver.</span>
<span class="cm"> * @cmd: This is used to distinguish between the different commands that</span>
<span class="cm"> *       can be passed to the IOCTL functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Entry point for the Ioctl.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSHWTSTAMP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vxge_hwtstamp_ioctl</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_tx_watchdog</span>
<span class="cm"> * @dev: pointer to net device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Watchdog for transmit side.</span>
<span class="cm"> * This function is triggered if the Tx Queue is stopped</span>
<span class="cm"> * for a pre-defined amount of time when the Interface is still up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_tx_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">cric_err_event</span> <span class="o">=</span> <span class="n">VXGE_HW_EVENT_RESET_START</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_vlan_rx_add_vid</span>
<span class="cm"> * @dev: net device pointer.</span>
<span class="cm"> * @vid: vid</span>
<span class="cm"> *</span>
<span class="cm"> * Add the vlan id to the devices vlan id table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vxge_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vp_id</span><span class="p">;</span>

	<span class="cm">/* Add these vlan to the vid table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vp_id</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vp_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_vid_add</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_vlan_rx_add_vid</span>
<span class="cm"> * @dev: net device pointer.</span>
<span class="cm"> * @vid: vid</span>
<span class="cm"> *</span>
<span class="cm"> * Remove the vlan id from the device&#39;s vlan id table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vxge_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vp_id</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Delete this vlan from the vid table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vp_id</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vp_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vp_id</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">vxge_hw_vpath_vid_delete</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">vxge_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">vxge_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">vxge_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>        <span class="o">=</span> <span class="n">vxge_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>         <span class="o">=</span> <span class="n">vxge_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>      <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">vxge_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>           <span class="o">=</span> <span class="n">vxge_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">vxge_set_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>         <span class="o">=</span> <span class="n">vxge_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">vxge_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">vxge_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>   <span class="o">=</span> <span class="n">vxge_vlan_rx_kill_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">vxge_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>         <span class="o">=</span> <span class="n">vxge_tx_watchdog</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>    <span class="o">=</span> <span class="n">vxge_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vxge_device_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">vxge_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">high_dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_of_vpath</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">**</span><span class="n">vdev_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">VXGE_HW_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">no_of_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">stat</span><span class="p">;</span>

	<span class="o">*</span><span class="n">vdev_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_steering_type</span><span class="p">)</span>
		<span class="n">no_of_queue</span> <span class="o">=</span> <span class="n">no_of_vpath</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span><span class="p">),</span>
			<span class="n">no_of_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span>
			<span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="s">&quot;%s : device allocation failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_out0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span>
		<span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="s">&quot;%s: %s:%d  Entering...&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span><span class="p">));</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span> <span class="o">=</span> <span class="n">hldev</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_config</span><span class="p">));</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">rx_hwts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">titan1</span> <span class="o">=</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">VXGE_HW_TITAN1_PCI_REVISION</span><span class="p">);</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span>
		<span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_steering</span> <span class="o">!=</span> <span class="n">NO_STEERING</span><span class="p">)</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXHASH</span><span class="p">;</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>


	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vxge_netdev_ops</span><span class="p">;</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">VXGE_LL_WATCH_DOG_TIMEOUT</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">,</span> <span class="n">vxge_reset</span><span class="p">);</span>

	<span class="n">vxge_initialize_ethtool_ops</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Allocate memory for vpath */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_vpath</span><span class="p">))</span> <span class="o">*</span>
				<span class="n">no_of_vpath</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: vpath memory allocation failed&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="s">&quot;%s : checksuming enabled&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">high_dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
			<span class="s">&quot;%s : using High DMA&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
			<span class="s">&quot;%s: %s : device registration failed!&quot;</span><span class="p">,</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Set the factory defined MAC address initially */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

	<span class="cm">/* Make Link state as off at this point, when the Link change</span>
<span class="cm">	 * interrupt comes the state will be automatically changed to</span>
<span class="cm">	 * the right state.</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="s">&quot;%s: Ethernet device registered&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vdev_out</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>

	<span class="cm">/* Resetting the Device stats */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_mrpcim_stats_access</span><span class="p">(</span>
				<span class="n">hldev</span><span class="p">,</span>
				<span class="n">VXGE_HW_STATS_OP_CLEAR_ALL_STATS</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">VXGE_HW_ERR_PRIVILAGED_OPEARATION</span><span class="p">)</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span>
			<span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
			<span class="s">&quot;%s: device stats clear returns&quot;</span>
			<span class="s">&quot;VXGE_HW_ERR_PRIVILAGED_OPEARATION&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">_out2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">);</span>
<span class="nl">_out1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">_out0:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_device_unregister</span>
<span class="cm"> *</span>
<span class="cm"> * This function will unregister and free network device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_device_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>	<span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>

	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">reset_task</span><span class="p">);</span>

	<span class="cm">/* in 2.6 will call stop() if device is up */</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">);</span>

	<span class="cm">/* we are safe to free it now */</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span> <span class="s">&quot;%s: ethernet device unregistered&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">);</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>	<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vxge_callback_crit_err</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called by the alarm handler in interrupt context.</span>
<span class="cm"> * Driver must analyze it based on the event type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vxge_callback_crit_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">vxge_hw_event</span> <span class="n">type</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vp_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vxge_vpath</span> <span class="o">*</span><span class="n">vpath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpath_idx</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Note: This event type should be used for device wide</span>
<span class="cm">	 * indications only - Serious errors, Slot freeze and critical errors</span>
<span class="cm">	 */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">cric_err_event</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vpath_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpath_idx</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">vpath_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpath</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">vpath_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">vp_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_RESET_CARD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_SLOT_FREEZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Slot is frozen&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_SERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Encountered Serious Error&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_CRITICAL_ERR</span><span class="p">)</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Encountered Critical Error&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_SERR</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_SLOT_FREEZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_CRITICAL_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_hw_device_mask_all</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_FIFO_ERR</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">VXGE_HW_EVENT_VPATH_ERR</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__VXGE_STATE_CARD_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* check if this vpath is already set for reset */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">vpath_idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vp_reset</span><span class="p">))</span> <span class="p">{</span>

				<span class="cm">/* disable interrupts for this vpath */</span>
				<span class="n">vxge_vpath_intr_disable</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vpath_idx</span><span class="p">);</span>

				<span class="cm">/* stop the queue for this vpath */</span>
				<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">vpath</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">.</span><span class="n">txq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>
		<span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_bandwidth</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">band_width</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">equal_priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 1. If user enters 0 for some fifo, give equal priority to all */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">equal_priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">equal_priority</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2. If sum exceeds 100, give equal priority to all */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bw_percentage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">total</span> <span class="o">+=</span> <span class="n">bw_percentage</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;</span> <span class="n">VXGE_HW_VPATH_BANDWIDTH_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">equal_priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">equal_priority</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Is all the bandwidth consumed? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_VPATH_BANDWIDTH_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Split rest of bw equally among next VPs*/</span>
				<span class="n">band_width</span> <span class="o">=</span>
				  <span class="p">(</span><span class="n">VXGE_HW_VPATH_BANDWIDTH_MAX</span>  <span class="o">-</span> <span class="n">total</span><span class="p">)</span> <span class="o">/</span>
					<span class="p">(</span><span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">band_width</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* min of 2% */</span>
					<span class="n">equal_priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span>
						<span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">bw_percentage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">band_width</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">)</span>
			<span class="n">equal_priority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">equal_priority</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Assigning equal bandwidth to all the vpaths&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">bw_percentage</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">VXGE_HW_VPATH_BANDWIDTH_MAX</span> <span class="o">/</span>
					<span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">bw_percentage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bw_percentage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Vpath configuration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vxge_config_vpaths</span><span class="p">(</span>
			<span class="k">struct</span> <span class="n">vxge_hw_device_config</span> <span class="o">*</span><span class="n">device_config</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">vpath_mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vxge_config</span> <span class="o">*</span><span class="n">config_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">no_of_vpaths</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">default_no_vpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txdl_size</span><span class="p">,</span> <span class="n">txdl_per_memblock</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">==</span> <span class="n">VXGE_USE_DEFAULT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">max_config_dev</span> <span class="o">==</span> <span class="n">VXGE_MAX_CONFIG_DEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No more CPU. Return vpath number as zero.*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span><span class="p">)</span>
			<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>

		<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span><span class="p">)</span>
			<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vxge_bVALn</span><span class="p">(</span><span class="n">vpath_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">default_no_vpath</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">default_no_vpath</span> <span class="o">&lt;</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span><span class="p">)</span>
			<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">=</span> <span class="n">default_no_vpath</span><span class="p">;</span>

		<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">=</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">-</span>
				<span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Disable tx and rx steering, &quot;</span>
			<span class="s">&quot;as single vpath is configured&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">config_param</span><span class="o">-&gt;</span><span class="n">rth_steering</span> <span class="o">=</span> <span class="n">NO_STEERING</span><span class="p">;</span>
		<span class="n">config_param</span><span class="o">-&gt;</span><span class="n">tx_steering_type</span> <span class="o">=</span> <span class="n">NO_STEERING</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">rth_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* configure bandwidth */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_bandwidth</span> <span class="o">=</span> <span class="n">bw_percentage</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vp_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">VXGE_HW_DEFAULT_MTU</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">no_of_vpaths</span> <span class="o">&lt;</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vxge_bVALn</span><span class="p">(</span><span class="n">vpath_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
					<span class="s">&quot;%s: vpath: %d is not available&quot;</span><span class="p">,</span>
					<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
					<span class="s">&quot;%s: vpath: %d available&quot;</span><span class="p">,</span>
					<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">no_of_vpaths</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
				<span class="s">&quot;%s: vpath: %d is not configured, &quot;</span>
				<span class="s">&quot;max_config_vpath exceeded&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Configure Tx fifo&#39;s */</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span>
						<span class="n">VXGE_HW_FIFO_ENABLE</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">max_frags</span> <span class="o">=</span>
				<span class="n">MAX_SKB_FRAGS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">memblock_size</span> <span class="o">=</span>
			<span class="n">VXGE_HW_MIN_FIFO_MEMBLOCK_SIZE</span><span class="p">;</span>

		<span class="n">txdl_size</span> <span class="o">=</span> <span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">max_frags</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_fifo_txd</span><span class="p">);</span>
		<span class="n">txdl_per_memblock</span> <span class="o">=</span> <span class="n">VXGE_HW_MIN_FIFO_MEMBLOCK_SIZE</span> <span class="o">/</span> <span class="n">txdl_size</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_blocks</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">VXGE_DEF_FIFO_LENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">txdl_per_memblock</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">intr</span> <span class="o">=</span>
				<span class="n">VXGE_HW_FIFO_QUEUE_INTR_DISABLE</span><span class="p">;</span>

		<span class="cm">/* Configure tti properties */</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">intr_enable</span> <span class="o">=</span>
					<span class="n">VXGE_HW_TIM_INTR_ENABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">btimer_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">VXGE_TTI_BTIMER_VAL</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">272</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">timer_ac_en</span> <span class="o">=</span>
				<span class="n">VXGE_HW_TIM_TIMER_AC_ENABLE</span><span class="p">;</span>

		<span class="cm">/* For msi-x with napi (each vector has a handler of its own) -</span>
<span class="cm">		 * Set CI to OFF for all vpaths</span>
<span class="cm">		 */</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">timer_ci_en</span> <span class="o">=</span>
			<span class="n">VXGE_HW_TIM_TIMER_CI_DISABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">timer_ri_en</span> <span class="o">=</span>
				<span class="n">VXGE_HW_TIM_TIMER_RI_DISABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">util_sel</span> <span class="o">=</span>
			<span class="n">VXGE_HW_TIM_UTIL_SEL_LEGACY_TX_NET_UTIL</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">ltimer_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">VXGE_TTI_LTIMER_VAL</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">272</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">rtimer_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">VXGE_TTI_RTIMER_VAL</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">272</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">urange_a</span> <span class="o">=</span> <span class="n">TTI_TX_URANGE_A</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">urange_b</span> <span class="o">=</span> <span class="n">TTI_TX_URANGE_B</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">urange_c</span> <span class="o">=</span> <span class="n">TTI_TX_URANGE_C</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_a</span> <span class="o">=</span> <span class="n">TTI_TX_UFC_A</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_b</span> <span class="o">=</span> <span class="n">TTI_TX_UFC_B</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_c</span> <span class="o">=</span> <span class="n">TTI_TX_UFC_C</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tti</span><span class="p">.</span><span class="n">uec_d</span> <span class="o">=</span> <span class="n">TTI_TX_UFC_D</span><span class="p">;</span>

		<span class="cm">/* Configure Rx rings */</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">enable</span>  <span class="o">=</span>
						<span class="n">VXGE_HW_RING_ENABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">ring_blocks</span>  <span class="o">=</span>
						<span class="n">VXGE_HW_DEF_RING_BLOCKS</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">buffer_mode</span> <span class="o">=</span>
			<span class="n">VXGE_HW_RING_RXD_BUFFER_MODE_1</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">rxds_limit</span>  <span class="o">=</span>
				<span class="n">VXGE_HW_DEF_RING_RXDS_LIMIT</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">scatter_mode</span> <span class="o">=</span>
					<span class="n">VXGE_HW_RING_SCATTER_MODE_A</span><span class="p">;</span>

		<span class="cm">/* Configure rti properties */</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">intr_enable</span> <span class="o">=</span>
					<span class="n">VXGE_HW_TIM_INTR_ENABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">btimer_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">VXGE_RTI_BTIMER_VAL</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mi">272</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">timer_ac_en</span> <span class="o">=</span>
						<span class="n">VXGE_HW_TIM_TIMER_AC_ENABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">timer_ci_en</span> <span class="o">=</span>
						<span class="n">VXGE_HW_TIM_TIMER_CI_DISABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">timer_ri_en</span> <span class="o">=</span>
						<span class="n">VXGE_HW_TIM_TIMER_RI_DISABLE</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">util_sel</span> <span class="o">=</span>
				<span class="n">VXGE_HW_TIM_UTIL_SEL_LEGACY_RX_NET_UTIL</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">urange_a</span> <span class="o">=</span>
						<span class="n">RTI_RX_URANGE_A</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">urange_b</span> <span class="o">=</span>
						<span class="n">RTI_RX_URANGE_B</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">urange_c</span> <span class="o">=</span>
						<span class="n">RTI_RX_URANGE_C</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">uec_a</span> <span class="o">=</span> <span class="n">RTI_RX_UFC_A</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">uec_b</span> <span class="o">=</span> <span class="n">RTI_RX_UFC_B</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">uec_c</span> <span class="o">=</span> <span class="n">RTI_RX_UFC_C</span><span class="p">;</span>
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">uec_d</span> <span class="o">=</span> <span class="n">RTI_RX_UFC_D</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">rtimer_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">VXGE_RTI_RTIMER_VAL</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">272</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rti</span><span class="p">.</span><span class="n">ltimer_val</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">VXGE_RTI_LTIMER_VAL</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">272</span><span class="p">;</span>

		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rpa_strip_vlan_tag</span> <span class="o">=</span>
			<span class="n">vlan_tag_strip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">no_of_vpaths</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize device configuratrions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">vxge_device_config_init</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">vxge_hw_device_config</span> <span class="o">*</span><span class="n">device_config</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">intr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Used for CQRQ/SRQ. */</span>
	<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">dma_blockpool_initial</span> <span class="o">=</span>
			<span class="n">VXGE_HW_INITIAL_DMA_BLOCK_POOL_SIZE</span><span class="p">;</span>

	<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">dma_blockpool_max</span> <span class="o">=</span>
			<span class="n">VXGE_HW_MAX_DMA_BLOCK_POOL_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_mac_vpath</span> <span class="o">&gt;</span> <span class="n">VXGE_MAX_MAC_ADDR_COUNT</span><span class="p">)</span>
		<span class="n">max_mac_vpath</span> <span class="o">=</span> <span class="n">VXGE_MAX_MAC_ADDR_COUNT</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_PCI_MSI</span>
	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
		<span class="s">&quot;%s: This Kernel does not support &quot;</span>
		<span class="s">&quot;MSI-X. Defaulting to INTA&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
	<span class="o">*</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">INTA</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Configure whether MSI-X or IRQL. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">intr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INTA</span>:
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">intr_mode</span> <span class="o">=</span> <span class="n">VXGE_HW_INTR_MODE_IRQLINE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSI_X</span>:
		<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">intr_mode</span> <span class="o">=</span> <span class="n">VXGE_HW_INTR_MODE_MSIX_ONE_SHOT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Timer period between device poll */</span>
	<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">device_poll_millis</span> <span class="o">=</span> <span class="n">VXGE_TIMER_DELAY</span><span class="p">;</span>

	<span class="cm">/* Configure mac based steering. */</span>
	<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">rts_mac_en</span> <span class="o">=</span> <span class="n">addr_learn_en</span><span class="p">;</span>

	<span class="cm">/* Configure Vpaths */</span>
	<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">rth_it_type</span> <span class="o">=</span> <span class="n">VXGE_HW_RTH_IT_TYPE_MULTI_IT</span><span class="p">;</span>

	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s : Device Config Params &quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;intr_mode : %d&quot;</span><span class="p">,</span>
			<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">intr_mode</span><span class="p">);</span>
	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;device_poll_millis : %d&quot;</span><span class="p">,</span>
			<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">device_poll_millis</span><span class="p">);</span>
	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;rth_en : %d&quot;</span><span class="p">,</span>
			<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">rth_en</span><span class="p">);</span>
	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;rth_it_type : %d&quot;</span><span class="p">,</span>
			<span class="n">device_config</span><span class="o">-&gt;</span><span class="n">rth_it_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">vxge_print_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vpath_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: %d Vpath(s) opened&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INTA</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Interrupt type INTA&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MSI_X</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Interrupt type MSI-X&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rth_steering</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: RTH steering enabled for TCP_IPV4&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: RTH steering disabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NO_STEERING</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Tx steering disabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_PRIORITY_STEERING</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Unsupported tx steering option&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Tx steering disabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_VLAN_STEERING</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Unsupported tx steering option&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Tx steering disabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_MULTIQ_STEERING</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Tx multiqueue steering enabled&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_PORT_STEERING</span>:
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Tx port steering enabled&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Unsupported tx steering type&quot;</span><span class="p">,</span>
			<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Tx steering disabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_steering_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">addr_learn_en</span><span class="p">)</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: MAC Address learning enabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vxge_bVALn</span><span class="p">(</span><span class="n">vpath_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: MTU size - %d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span>  <span class="o">*</span><span class="p">)(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">))</span><span class="o">-&gt;</span>
				<span class="n">config</span><span class="p">.</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mtu</span><span class="p">);</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: VLAN tag stripping %s&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span>  <span class="o">*</span><span class="p">)(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">))</span><span class="o">-&gt;</span>
				<span class="n">config</span><span class="p">.</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rpa_strip_vlan_tag</span>
			<span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">);</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Max frags : %d&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">__vxge_hw_device</span>  <span class="o">*</span><span class="p">)(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">))</span><span class="o">-&gt;</span>
				<span class="n">config</span><span class="p">.</span><span class="n">vp_config</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo</span><span class="p">.</span><span class="n">max_frags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/**</span>
<span class="cm"> * vxge_pm_suspend - vxge power management suspend entry point</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_pm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * vxge_pm_resume - vxge power management resume entry point</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_pm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_io_error_detected - called when PCI error is detected</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> * @state: The current pci connection state</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called after a PCI bus error affecting</span>
<span class="cm"> * this device has been detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">vxge_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Bring down the card, while avoiding PCI I/O */</span>
		<span class="n">do_vxge_close</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_io_slot_reset - called after the pci bus has been reset.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Restart the card from scratch, as if from a cold-boot.</span>
<span class="cm"> * At this point, the card has exprienced a hard reset,</span>
<span class="cm"> * followed by fixups by BIOS, and has its config space</span>
<span class="cm"> * set up identically to what it was at cold boot.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">vxge_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot re-enable device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">do_vxge_reset</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VXGE_LL_FULL_RESET</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_io_resume - called when traffic can start flowing again.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called when the error recovery driver tells</span>
<span class="cm"> * us that its OK to resume normal operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vxge_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vxge_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
				   <span class="s">&quot;Can&#39;t bring device back up after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">vxge_get_num_vfs</span><span class="p">(</span><span class="n">u64</span> <span class="n">function_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">num_functions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">function_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MULTI_FUNCTION</span>:
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_SRIOV_8</span>:
		<span class="n">num_functions</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_SINGLE_FUNCTION</span>:
		<span class="n">num_functions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_SRIOV</span>:
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MRIOV</span>:
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MULTI_FUNCTION_17</span>:
		<span class="n">num_functions</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_SRIOV_4</span>:
		<span class="n">num_functions</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MULTI_FUNCTION_2</span>:
		<span class="n">num_functions</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MRIOV_8</span>:
		<span class="n">num_functions</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">num_functions</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vxge_fw_upgrade</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cbld</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: Firmware file &#39;%s&#39; not found&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load the new firmware onto the adapter */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_update_fw_image</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: FW image download to adapter failed &#39;%s&#39;.&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the version of the new firmware */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_upgrade_read_version</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bld</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Upgrade read version failed &#39;%s&#39;.&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmaj</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span><span class="p">;</span>
	<span class="n">cmin</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">cbld</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">build</span><span class="p">;</span>
	<span class="cm">/* It&#39;s possible the version in /lib/firmware is not the latest version.</span>
<span class="cm">	 * If so, we could get into a loop of trying to upgrade to the latest</span>
<span class="cm">	 * and flashing the older version.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cbld</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Upgrade to firmware version %d.%d.%d commencing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">);</span>

	<span class="cm">/* Flash the adapter with the new firmware */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_flash_fw</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: Upgrade commit failed &#39;%s&#39;.&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Upgrade of firmware successful!  Adapter must be &quot;</span>
	       <span class="s">&quot;hard reset before using, thus requiring a system reboot or a &quot;</span>
	       <span class="s">&quot;hotplug event.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vxge_probe_fw_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">gpxe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>

	<span class="n">maj</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span><span class="p">;</span>
	<span class="n">min</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">bld</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">build</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">)</span> <span class="o">==</span> <span class="n">VXGE_CERT_FW_VER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ignore the build number when determining if the current firmware is</span>
<span class="cm">	 * &quot;too new&quot; to load the driver</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VXGE_CERT_FW_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: Firmware newer than last known &quot;</span>
				<span class="s">&quot;version, unable to load driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Firmware 1.4.4 and older cannot be upgraded, and is too ancient to</span>
<span class="cm">	 * work with this driver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">VXGE_FW_DEAD_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: Firmware %d.%d.%d cannot be &quot;</span>
				<span class="s">&quot;upgraded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If file not specified, determine gPXE or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">VXGE_EPROM_FW_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_ROM_IMAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">devh</span><span class="o">-&gt;</span><span class="n">eprom_versions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">gpxe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpxe</span><span class="p">)</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;vxge/X3fw-pxe.ncf&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="s">&quot;vxge/X3fw.ncf&quot;</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vxge_fw_upgrade</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* -EINVAL and -ENOENT are not fatal errors for flashing firmware on</span>
<span class="cm">	 * probe, so ignore them</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">VXGE_CERT_FW_VER_MAJOR</span><span class="p">,</span> <span class="n">VXGE_CERT_FW_VER_MINOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span>
	    <span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: Firmware %d.%d.%d is too old to&quot;</span>
				<span class="s">&quot; be used with this driver.</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;Please get the latest version from &quot;</span>
				<span class="s">&quot;ftp://ftp.s2io.com/pub/X3100-Drivers/FIRMWARE&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">maj</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">bld</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">is_sriov_initialized</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_SRIOV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_SRIOV_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">PCI_SRIOV_CTRL_VFE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vxge_hw_uld_cbs</span> <span class="n">vxge_callbacks</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">link_up</span> <span class="o">=</span> <span class="n">vxge_callback_link_up</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_down</span> <span class="o">=</span> <span class="n">vxge_callback_link_down</span><span class="p">,</span>
	<span class="p">.</span><span class="n">crit_err</span> <span class="o">=</span> <span class="n">vxge_callback_crit_err</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_probe</span>
<span class="cm"> * @pdev : structure containing the PCI related information of the device.</span>
<span class="cm"> * @pre: List of PCI devices supported by the driver listed in vxge_id_table.</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This function is called when a new PCI device gets detected and initializes</span>
<span class="cm"> * it.</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * returns 0 on success and negative on failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">vxge_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pre</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">high_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vpath_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_config</span> <span class="o">*</span><span class="n">ll_config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_hw_device_config</span> <span class="o">*</span><span class="n">device_config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_hw_device_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">no_of_vpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_vpath_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">macaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxge_mac_addrs</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">bus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">host_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">vxge_hw_status</span> <span class="n">is_privileged</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">function_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_vfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* In SRIOV-17 mode, functions of the same adapter</span>
<span class="cm">	 * can be deployed on different buses</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">is_virtfn</span><span class="p">)</span>
		<span class="n">new_device</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">device</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span> <span class="o">!=</span>
			<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="p">))</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: Configured %d of %d devices&quot;</span><span class="p">,</span>
				<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span>
				<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span><span class="p">,</span>
				<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="p">);</span>
		<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now making the CPU based no of vpath calculation</span>
<span class="cm">	 * applicable for individual functions as well.</span>
<span class="cm">	 */</span>
	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">g_no_cpus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">vpath_per_dev</span> <span class="o">=</span> <span class="n">max_config_vpath</span><span class="p">;</span>

	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span> <span class="o">&gt;</span> <span class="n">max_config_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_config</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_hw_device_config</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;device_config : malloc failed %s %d&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ll_config</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ll_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;device_config : malloc failed %s %d&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">tx_steering_type</span> <span class="o">=</span> <span class="n">TX_MULTIQ_STEERING</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">MSI_X</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">napi_weight</span> <span class="o">=</span> <span class="n">NEW_NAPI_WEIGHT</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_steering</span> <span class="o">=</span> <span class="n">RTH_STEERING</span><span class="p">;</span>

	<span class="cm">/* get the default configuration parameters */</span>
	<span class="n">vxge_hw_device_config_default_get</span><span class="p">(</span><span class="n">device_config</span><span class="p">);</span>

	<span class="cm">/* initialize configuration parameters */</span>
	<span class="n">vxge_device_config_init</span><span class="p">(</span><span class="n">device_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">intr_type</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s : can not enable PCI device&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s : using 64bit DMA&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">high_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s : unable to obtain 64bit DMA for &quot;</span>
				<span class="s">&quot;consistent allocations&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">_exit1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s : using 32bit DMA&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s : request regions failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_exit1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">attr</span><span class="p">.</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attr</span><span class="p">.</span><span class="n">bar0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s : cannot remap io memory bar0&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;pci ioremap bar0: %p:0x%llx&quot;</span><span class="p">,</span>
		<span class="n">attr</span><span class="p">.</span><span class="n">bar0</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_device_hw_info_get</span><span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">bar0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Reading of hardware info failed.&quot;</span>
			<span class="s">&quot;Please try upgrading the firmware.&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vpath_mask</span> <span class="o">=</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">vpath_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpath_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: No vpaths available in device&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s:%d  Vpath mask = %llx&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">vpath_mask</span><span class="p">);</span>

	<span class="n">function_mode</span> <span class="o">=</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">function_mode</span><span class="p">;</span>
	<span class="n">host_type</span> <span class="o">=</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">host_type</span><span class="p">;</span>
	<span class="n">is_privileged</span> <span class="o">=</span> <span class="n">__vxge_hw_device_is_privilaged</span><span class="p">(</span><span class="n">host_type</span><span class="p">,</span>
		<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">func_id</span><span class="p">);</span>

	<span class="cm">/* Check how many vpaths are available */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">vpath_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">vxge_mBIT</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">max_vpath_supported</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_device</span><span class="p">)</span>
		<span class="n">num_vfs</span> <span class="o">=</span> <span class="n">vxge_get_num_vfs</span><span class="p">(</span><span class="n">function_mode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable SRIOV mode, if firmware has SRIOV support and if it is a PF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sriov</span><span class="p">(</span><span class="n">function_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_sriov_initialized</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">intr_type</span> <span class="o">!=</span> <span class="n">INTA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">num_vfs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;Failed in enabling SRIOV mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="cm">/* No need to fail out, as an error here is non-fatal */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure vpaths and get driver configured number of vpaths</span>
<span class="cm">	 * which is less than or equal to the maximum vpaths per function.</span>
<span class="cm">	 */</span>
	<span class="n">no_of_vpath</span> <span class="o">=</span> <span class="n">vxge_config_vpaths</span><span class="p">(</span><span class="n">device_config</span><span class="p">,</span> <span class="n">vpath_mask</span><span class="p">,</span> <span class="n">ll_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_of_vpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_ll_config</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: No more vpaths to configure&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setting driver callbacks */</span>
	<span class="n">attr</span><span class="p">.</span><span class="n">uld_callbacks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vxge_callbacks</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_device_initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hldev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">device_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;Failed to initialize device (%d)&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">_exit3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VXGE_FW_VER</span><span class="p">(</span><span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
			<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span>
			<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">build</span><span class="p">)</span> <span class="o">&gt;=</span>
	    <span class="n">VXGE_EPROM_FW_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">eprom_image</span> <span class="n">img</span><span class="p">[</span><span class="n">VXGE_HW_MAX_ROM_IMAGES</span><span class="p">];</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_eprom_img_ver_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">img</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: Reading of EPROM failed&quot;</span><span class="p">,</span>
					<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
			<span class="cm">/* This is a non-fatal error, continue */</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_ROM_IMAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hldev</span><span class="o">-&gt;</span><span class="n">eprom_versions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_valid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: EPROM %d, version &quot;</span>
					<span class="s">&quot;%d.%d.%d.%d&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">VXGE_EPROM_IMG_MAJOR</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">),</span>
					<span class="n">VXGE_EPROM_IMG_MINOR</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">),</span>
					<span class="n">VXGE_EPROM_IMG_FIX</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">),</span>
					<span class="n">VXGE_EPROM_IMG_BUILD</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if FCS stripping is not disabled in MAC fail driver load */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_hw_vpath_strip_fcs_check</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">vpath_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: FCS stripping is enabled in MAC&quot;</span>
				<span class="s">&quot; failing driver load&quot;</span><span class="p">,</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Always enable HWTS.  This will always cause the FCS to be invalid,</span>
<span class="cm">	 * due to the fact that HWTS is using the FCS as the location of the</span>
<span class="cm">	 * timestamp.  The HW FCS checking will still correctly determine if</span>
<span class="cm">	 * there is a valid checksum, and the FCS is being removed by the driver</span>
<span class="cm">	 * anyway.  So no fucntionality is being lost.  Since it is always</span>
<span class="cm">	 * enabled, we now simply use the ioctl call to set whether or not the</span>
<span class="cm">	 * driver should be paying attention to the HWTS.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_privileged</span> <span class="o">==</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vxge_timestamp_config</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">VXGE_HW_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span> <span class="s">&quot;%s: HWTS enable failed&quot;</span><span class="p">,</span>
					<span class="n">VXGE_DRIVER_NAME</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">_exit4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vxge_hw_device_debug_set</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">VXGE_ERR</span><span class="p">,</span> <span class="n">VXGE_COMPONENT_LL</span><span class="p">);</span>

	<span class="cm">/* set private device info */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hldev</span><span class="p">);</span>

	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">fifo_indicate_max_pkts</span> <span class="o">=</span> <span class="n">VXGE_FIFO_INDICATE_MAX_PKTS</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">addr_learn_en</span> <span class="o">=</span> <span class="n">addr_learn_en</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_algorithm</span> <span class="o">=</span> <span class="n">RTH_ALG_JENKINS</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_hash_type_tcpipv4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_hash_type_ipv4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_hash_type_tcpipv6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_hash_type_ipv6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_hash_type_tcpipv6ex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_hash_type_ipv6ex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rth_bkt_sz</span> <span class="o">=</span> <span class="n">RTH_BUCKET_SIZE</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">tx_pause_enable</span> <span class="o">=</span> <span class="n">VXGE_PAUSE_CTRL_ENABLE</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">rx_pause_enable</span> <span class="o">=</span> <span class="n">VXGE_PAUSE_CTRL_ENABLE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vxge_device_register</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">ll_config</span><span class="p">,</span> <span class="n">high_dma</span><span class="p">,</span> <span class="n">no_of_vpath</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vxge_probe_fw_update</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_exit5</span><span class="p">;</span>

	<span class="n">vxge_hw_device_debug_set</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="n">VXGE_COMPONENT_LL</span><span class="p">);</span>
	<span class="n">VXGE_COPY_DEBUG_INFO_TO_LL</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vxge_hw_device_error_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">));</span>

	<span class="cm">/* set private HW device info */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">VXGE_HW_DEFAULT_MTU</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">bar0</span> <span class="o">=</span> <span class="n">attr</span><span class="p">.</span><span class="n">bar0</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">max_vpath_supported</span> <span class="o">=</span> <span class="n">max_vpath_supported</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span> <span class="o">=</span> <span class="n">no_of_vpath</span><span class="p">;</span>

	<span class="cm">/* Virtual Path count */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VXGE_HW_MAX_VIRTUAL_PATHS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vxge_bVALn</span><span class="p">(</span><span class="n">vpath_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">is_configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ring</span><span class="p">.</span><span class="n">driver_id</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max_mac_addr_cnt</span> <span class="o">=</span> <span class="n">max_mac_vpath</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">macaddr</span><span class="p">,</span>
				<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">mac_addrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="cm">/* Initialize the mac address list header */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mac_addr_list</span><span class="p">);</span>

		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mac_addr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mcast_addr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">exec_mode</span> <span class="o">=</span> <span class="n">VXGE_EXEC_MODE_DISABLE</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">max_config_port</span> <span class="o">=</span> <span class="n">max_config_port</span><span class="p">;</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vlan_tag_strip</span> <span class="o">=</span> <span class="n">vlan_tag_strip</span><span class="p">;</span>

	<span class="cm">/* map the hashing selector table to the configured vpaths */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpath_selector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpath_selector</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">macaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">macaddr</span><span class="p">;</span>

	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">serial_number</span><span class="p">[</span><span class="n">VXGE_HW_INFO_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">product_desc</span><span class="p">[</span><span class="n">VXGE_HW_INFO_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">part_number</span><span class="p">[</span><span class="n">VXGE_HW_INFO_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: SERIAL NUMBER: %s&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">serial_number</span><span class="p">);</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: PART NUMBER: %s&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">part_number</span><span class="p">);</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: Neterion %s Server Adapter&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">product_desc</span><span class="p">);</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: MAC ADDR: %pM&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">);</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: Link Width x%d&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vxge_hw_device_link_width_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">));</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
		<span class="s">&quot;%s: Firmware version : %s Date : %s&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
		<span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_date</span><span class="p">.</span><span class="n">date</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">function_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_SINGLE_FUNCTION</span>:
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Single Function Mode Enabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MULTI_FUNCTION</span>:
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Multi Function Mode Enabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_SRIOV</span>:
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Single Root IOV Mode Enabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VXGE_HW_FUNCTION_MODE_MRIOV</span>:
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span>
			<span class="s">&quot;%s: Multi Root IOV Mode Enabled&quot;</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vxge_print_parm</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vpath_mask</span><span class="p">);</span>

	<span class="cm">/* Store the fw version for ethttool option */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">fw_version</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Copy the station mac address to the list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span>	<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_mac_addrs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
				<span class="s">&quot;%s: mac_addr_list : memory allocation failed&quot;</span><span class="p">,</span>
				<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">_exit6</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">macaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_addr_list</span><span class="p">);</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_addr_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">device_config</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * INTA is shared in multi-function mode. This is unlike the INTA</span>
<span class="cm">	 * implementation in MR mode, where each VH has its own INTA message.</span>
<span class="cm">	 * - INTA is masked (disabled) as long as at least one function sets</span>
<span class="cm">	 * its TITAN_MASK_ALL_INT.ALARM bit.</span>
<span class="cm">	 * - INTA is unmasked (enabled) when all enabled functions have cleared</span>
<span class="cm">	 * their own TITAN_MASK_ALL_INT.ALARM bit.</span>
<span class="cm">	 * The TITAN_MASK_ALL_INT ALARM &amp; TRAFFIC bits are cleared on power up.</span>
<span class="cm">	 * Though this driver leaves the top level interrupts unmasked while</span>
<span class="cm">	 * leaving the required module interrupt bits masked on exit, there</span>
<span class="cm">	 * could be a rougue driver around that does not follow this procedure</span>
<span class="cm">	 * resulting in a failure to generate interrupts. The following code is</span>
<span class="cm">	 * present to prevent such a failure.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ll_config</span><span class="o">-&gt;</span><span class="n">device_hw_info</span><span class="p">.</span><span class="n">function_mode</span> <span class="o">==</span>
		<span class="n">VXGE_HW_FUNCTION_MODE_MULTI_FUNCTION</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">intr_type</span> <span class="o">==</span> <span class="n">INTA</span><span class="p">)</span>
			<span class="n">vxge_hw_device_unmask_all</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">VXGE_TRACE</span><span class="p">,</span> <span class="s">&quot;%s: %s:%d  Exiting...&quot;</span><span class="p">,</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">vxge_hw_device_debug_set</span><span class="p">(</span><span class="n">hldev</span><span class="p">,</span> <span class="n">VXGE_ERR</span><span class="p">,</span> <span class="n">VXGE_COMPONENT_LL</span><span class="p">);</span>
	<span class="n">VXGE_COPY_DEBUG_INFO_TO_LL</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vxge_hw_device_error_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">),</span>
		<span class="n">vxge_hw_device_trace_level_get</span><span class="p">(</span><span class="n">hldev</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ll_config</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_exit6:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vxge_free_mac_add_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="nl">_exit5:</span>
	<span class="n">vxge_device_unregister</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
<span class="nl">_exit4:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">vxge_hw_device_terminate</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="n">pci_disable_sriov</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">_exit3:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">bar0</span><span class="p">);</span>
<span class="nl">_exit2:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">_exit1:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">_exit0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ll_config</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device_config</span><span class="p">);</span>
	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vxge_rem_nic - Free the PCI device</span>
<span class="cm"> * @pdev: structure containing the PCI related information of the device.</span>
<span class="cm"> * Description: This function is called by the Pci subsystem to release a</span>
<span class="cm"> * PCI device and free up all resource held up by the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">vxge_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__vxge_hw_device</span> <span class="o">*</span><span class="n">hldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vxgedev</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hldev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hldev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">hldev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>	<span class="s">&quot;%s:%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span> <span class="s">&quot;%s : removing PCI device...&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">no_of_vpath</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vxge_free_mac_add_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vpaths</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">vxge_device_unregister</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* Do not call pci_disable_sriov here, as it will break child devices */</span>
	<span class="n">vxge_hw_device_terminate</span><span class="p">(</span><span class="n">hldev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">bar0</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span> <span class="s">&quot;%s:%d Device unregistered&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="n">vxge_debug_entryexit</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">level_trace</span><span class="p">,</span>	<span class="s">&quot;%s:%d  Exiting...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			     <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">vxge_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">vxge_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">vxge_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">vxge_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">vxge_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">vxge_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">vxge_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">vxge_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">vxge_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">vxge_pm_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vxge_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">vxge_starter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Copyright(c) 2002-2010 Exar Corp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Driver version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">verify_bandwidth</span><span class="p">();</span>

	<span class="n">driver_config</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vxge_drv_config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver_config</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vxge_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">driver_config</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span> <span class="o">!=</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="p">))</span>
		<span class="n">vxge_debug_init</span><span class="p">(</span><span class="n">VXGE_ERR</span><span class="p">,</span>
			<span class="s">&quot;%s: Configured %d of %d devices&quot;</span><span class="p">,</span>
			<span class="n">VXGE_DRIVER_NAME</span><span class="p">,</span> <span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">config_dev_cnt</span><span class="p">,</span>
			<span class="n">driver_config</span><span class="o">-&gt;</span><span class="n">total_dev_cnt</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">vxge_closer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vxge_driver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">driver_config</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">vxge_starter</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vxge_closer</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
