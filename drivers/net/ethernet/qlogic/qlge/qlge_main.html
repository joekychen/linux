<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › qlogic › qlge › qlge_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>qlge_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic qlge NIC HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2008 QLogic Corporation</span>
<span class="cm"> * See LICENSE.qlge for copyright and licensing details.</span>
<span class="cm"> * Author:     Linux qlge network device driver by</span>
<span class="cm"> *                      Ron Mercer &lt;ron.mercer@qlogic.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/pagemap.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;net/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/udp.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;net/ip6_checksum.h&gt;</span>

<span class="cp">#include &quot;qlge.h&quot;</span>

<span class="kt">char</span> <span class="n">qlge_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">qlge_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_VERSION</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ron Mercer &lt;ron.mercer@qlogic.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_STRING</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">default_msg</span> <span class="o">=</span>
    <span class="n">NETIF_MSG_DRV</span> <span class="o">|</span> <span class="n">NETIF_MSG_PROBE</span> <span class="o">|</span> <span class="n">NETIF_MSG_LINK</span> <span class="o">|</span>
<span class="cm">/* NETIF_MSG_TIMER |	*/</span>
    <span class="n">NETIF_MSG_IFDOWN</span> <span class="o">|</span>
    <span class="n">NETIF_MSG_IFUP</span> <span class="o">|</span>
    <span class="n">NETIF_MSG_RX_ERR</span> <span class="o">|</span>
    <span class="n">NETIF_MSG_TX_ERR</span> <span class="o">|</span>
<span class="cm">/*  NETIF_MSG_TX_QUEUED | */</span>
<span class="cm">/*  NETIF_MSG_INTR | NETIF_MSG_TX_DONE | NETIF_MSG_RX_STATUS | */</span>
<span class="cm">/* NETIF_MSG_PKTDATA | */</span>
    <span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_WOL</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* defaults above */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0=none,...,16=all)&quot;</span><span class="p">);</span>

<span class="cp">#define MSIX_IRQ 0</span>
<span class="cp">#define MSI_IRQ 1</span>
<span class="cp">#define LEG_IRQ 2</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlge_irq_type</span> <span class="o">=</span> <span class="n">MSIX_IRQ</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlge_irq_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0664</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlge_irq_type</span><span class="p">,</span> <span class="s">&quot;0 = MSI-X, 1 = MSI, 2 = Legacy.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qlge_mpi_coredump</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlge_mpi_coredump</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlge_mpi_coredump</span><span class="p">,</span>
		<span class="s">&quot;Option to enable MPI firmware dump. &quot;</span>
		<span class="s">&quot;Default is OFF - Do Not allocate memory. &quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qlge_force_coredump</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlge_force_coredump</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlge_force_coredump</span><span class="p">,</span>
		<span class="s">&quot;Option to allow force of firmware core dump. &quot;</span>
		<span class="s">&quot;Default is OFF - Do not allow.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">qlge_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">QLGE_DEVICE_ID_8012</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">QLGE_DEVICE_ID_8000</span><span class="p">)},</span>
	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">qlge_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ql_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlge_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">);</span>

<span class="cm">/* This hardware semaphore causes exclusive access to</span>
<span class="cm"> * resources shared between the NIC driver, MPI firmware,</span>
<span class="cm"> * FCOE firmware and the FC driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_sem_trylock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sem_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sem_mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SEM_XGMAC0_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_XGMAC0_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_XGMAC1_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_XGMAC1_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_ICB_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_ICB_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_MAC_ADDR_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_MAC_ADDR_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_FLASH_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_FLASH_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_PROBE_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_PROBE_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_RT_IDX_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_RT_IDX_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEM_PROC_REG_MASK</span>:
		<span class="n">sem_bits</span> <span class="o">=</span> <span class="n">SEM_SET</span> <span class="o">&lt;&lt;</span> <span class="n">SEM_PROC_REG_SHIFT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netif_alert</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;bad Semaphore mask!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM</span><span class="p">,</span> <span class="n">sem_bits</span> <span class="o">|</span> <span class="n">sem_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sem_bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ql_sem_spinlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wait_count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql_sem_trylock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">sem_mask</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">wait_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ql_sem_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM</span><span class="p">,</span> <span class="n">sem_mask</span><span class="p">);</span>
	<span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="cm">/* This function waits for a specific bit to come ready</span>
<span class="cm"> * in a given register.  It is used mostly by the initialize</span>
<span class="cm"> * process, but is also used in kernel thread API such as</span>
<span class="cm"> * netdev-&gt;set_multi, netdev-&gt;set_mac_address, netdev-&gt;vlan_rx_add_vid.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ql_wait_reg_rdy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">,</span> <span class="n">u32</span> <span class="n">err_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">UDELAY_COUNT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* check for errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">err_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_alert</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				    <span class="s">&quot;register 0x%.08x access error, value = 0x%.08x!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">UDELAY_DELAY</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_alert</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="s">&quot;Timed out waiting for reg %x to come ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The CFG register is used to download TX and RX control blocks</span>
<span class="cm"> * to the chip. This function waits for an operation to complete.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_wait_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">UDELAY_COUNT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">CFG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">CFG_LE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">UDELAY_DELAY</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Used to issue init control blocks to hw. Maps control block,</span>
<span class="cm"> * sets address, triggers download, waits for completion.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ql_write_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bit</span><span class="p">,</span>
		 <span class="n">u16</span> <span class="n">q_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">direction</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CFG_LRQ</span> <span class="o">|</span> <span class="n">CFG_LR</span> <span class="o">|</span> <span class="n">CFG_LCQ</span><span class="p">))</span> <span class="o">?</span> <span class="n">PCI_DMA_TODEVICE</span> <span class="o">:</span>
	    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map DMA area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_ICB_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_cfg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Timed out waiting for CFG to come ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ICB_L</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">map</span><span class="p">);</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ICB_H</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">map</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">CFG_Q_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">|</span> <span class="p">(</span><span class="n">q_id</span> <span class="o">&lt;&lt;</span> <span class="n">CFG_Q_SHIFT</span><span class="p">);</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">|</span> <span class="n">value</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the bit to clear after signaling hw.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_cfg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_ICB_MASK</span><span class="p">);</span>	<span class="cm">/* does flush too */</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get a specific MAC address from the CAM.  Used for debug and reg dump. */</span>
<span class="kt">int</span> <span class="nf">ql_get_mac_addr_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_MULTI_MAC</span>:
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_CAM_MAC</span>:
		<span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* offset */</span>
				   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* index */</span>
				   <span class="n">MAC_ADDR_ADR</span> <span class="o">|</span> <span class="n">MAC_ADDR_RS</span> <span class="o">|</span> <span class="n">type</span><span class="p">);</span> <span class="cm">/* type */</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span><span class="o">++</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* offset */</span>
				   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* index */</span>
				   <span class="n">MAC_ADDR_ADR</span> <span class="o">|</span> <span class="n">MAC_ADDR_RS</span> <span class="o">|</span> <span class="n">type</span><span class="p">);</span> <span class="cm">/* type */</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span><span class="o">++</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MAC_ADDR_TYPE_CAM_MAC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
					<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
				<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* offset */</span>
					   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* index */</span>
					   <span class="n">MAC_ADDR_ADR</span> <span class="o">|</span> <span class="n">MAC_ADDR_RS</span> <span class="o">|</span> <span class="n">type</span><span class="p">);</span> <span class="cm">/* type */</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span>
						    <span class="n">MAC_ADDR_MR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
				<span class="o">*</span><span class="n">value</span><span class="o">++</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_VLAN</span>:
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_MULTI_FLTR</span>:
	<span class="nl">default:</span>
		<span class="n">netif_crit</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Address type %d not yet supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set up a MAC, multicast or VLAN address for the</span>
<span class="cm"> * inbound frame matching.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_set_mac_addr_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_MULTI_MAC</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

			<span class="n">status</span> <span class="o">=</span>
				<span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">type</span> <span class="o">|</span> <span class="n">MAC_ADDR_E</span><span class="p">);</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">,</span> <span class="n">lower</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
				<span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">type</span> <span class="o">|</span> <span class="n">MAC_ADDR_E</span><span class="p">);</span>

			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">,</span> <span class="n">upper</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
				<span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_CAM_MAC</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">cam_output</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">lower</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* offset */</span>
				   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* index */</span>
				   <span class="n">type</span><span class="p">);</span>	<span class="cm">/* type */</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">,</span> <span class="n">lower</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* offset */</span>
				   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* index */</span>
				   <span class="n">type</span><span class="p">);</span>	<span class="cm">/* type */</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">,</span> <span class="n">upper</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* offset */</span>
				   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* index */</span>
				   <span class="n">type</span><span class="p">);</span>	<span class="cm">/* type */</span>
			<span class="cm">/* This field should also include the queue id</span>
<span class="cm">			   and possibly the function id.  Right now we hardcode</span>
<span class="cm">			   the route field to NIC core.</span>
<span class="cm">			 */</span>
			<span class="n">cam_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">CAM_OUT_ROUTE_NIC</span> <span class="o">|</span>
				      <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span>
				       <span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="n">CAM_OUT_FUNC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CAM_OUT_CQ_ID_SHIFT</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
				<span class="n">cam_output</span> <span class="o">|=</span> <span class="n">CAM_OUT_RV</span><span class="p">;</span>
			<span class="cm">/* route to NIC core */</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_DATA</span><span class="p">,</span> <span class="n">cam_output</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_VLAN</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">enable_bit</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="cm">/* For VLAN, the addr actually holds a bit that</span>
<span class="cm">			 * either enables or disables the vlan id we are</span>
<span class="cm">			 * addressing. It&#39;s either MAC_ADDR_E on or off.</span>
<span class="cm">			 * That&#39;s bit-27 we&#39;re talking about.</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">MAC_ADDR_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_ADDR_IDX</span><span class="p">,</span> <span class="n">offset</span> <span class="o">|</span>	<span class="cm">/* offset */</span>
				   <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MAC_ADDR_IDX_SHIFT</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* index */</span>
				   <span class="n">type</span> <span class="o">|</span>	<span class="cm">/* type */</span>
				   <span class="n">enable_bit</span><span class="p">);</span>	<span class="cm">/* enable/disable */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">MAC_ADDR_TYPE_MULTI_FLTR</span>:
	<span class="nl">default:</span>
		<span class="n">netif_crit</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Address type %d not yet supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set or clear MAC address in hardware. We sometimes</span>
<span class="cm"> * have to clear it to prevent wrong frame routing</span>
<span class="cm"> * especially in a bonding environment.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">zero_mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Set Mac addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">zero_mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zero_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Clearing MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_mac_addr_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span>
			<span class="n">MAC_ADDR_TYPE_CAM_MAC</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">*</span> <span class="n">MAX_CQ</span><span class="p">);</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to init mac address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ql_link_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link is up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ql_set_mac_addr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ql_link_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link is down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ql_set_mac_addr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get a specific frame routing value from the CAM.</span>
<span class="cm"> * Used for debug and reg dump.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ql_get_routing_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX</span><span class="p">,</span> <span class="n">RT_IDX_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX</span><span class="p">,</span>
		   <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span> <span class="n">RT_IDX_RS</span> <span class="o">|</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX</span><span class="p">,</span> <span class="n">RT_IDX_MR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_DATA</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The NIC function for this chip has 16 routing indexes.  Each one can be used</span>
<span class="cm"> * to route different frame types to various inbound queues.  We send broadcast/</span>
<span class="cm"> * multicast/error frames to the default queue for slow handling,</span>
<span class="cm"> * and CAM hit/RSS frames to the fast handling queues.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_set_routing_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* Return error if no mask match. */</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RT_IDX_CAM_HIT</span>:
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_CAM_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_CAM_HIT_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_VALID</span>:	<span class="cm">/* Promiscuous Mode frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_PROMISCUOUS_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_ERR</span>:	<span class="cm">/* Pass up MAC,IP,TCP/UDP error frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_ALL_ERR_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_IP_CSUM_ERR</span>: <span class="cm">/* Pass up IP CSUM error frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span> <span class="cm">/* dest */</span>
				<span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span> <span class="cm">/* type */</span>
				<span class="p">(</span><span class="n">RT_IDX_IP_CSUM_ERR_SLOT</span> <span class="o">&lt;&lt;</span>
				<span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span> <span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_TU_CSUM_ERR</span>: <span class="cm">/* Pass up TCP/UDP CSUM error frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span> <span class="cm">/* dest */</span>
				<span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span> <span class="cm">/* type */</span>
				<span class="p">(</span><span class="n">RT_IDX_TCP_UDP_CSUM_ERR_SLOT</span> <span class="o">&lt;&lt;</span>
				<span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span> <span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_BCAST</span>:	<span class="cm">/* Pass up Broadcast frames to default Q. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_BCAST_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_MCAST</span>:	<span class="cm">/* Pass up All Multicast frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_ALLMULTI_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_MCAST_MATCH</span>:	<span class="cm">/* Pass up matched Multicast frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_MCAST_MATCH_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">RT_IDX_RSS_MATCH</span>:	<span class="cm">/* Pass up matched RSS frames. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_RSS</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">RT_IDX_RSS_MATCH_SLOT</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Clear the E-bit on an entry. */</span>
		<span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RT_IDX_DST_DFLT_Q</span> <span class="o">|</span>	<span class="cm">/* dest */</span>
			    <span class="n">RT_IDX_TYPE_NICQ</span> <span class="o">|</span>	<span class="cm">/* type */</span>
			    <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">RT_IDX_IDX_SHIFT</span><span class="p">);</span><span class="cm">/* index */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Mask type %d not yet supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX</span><span class="p">,</span> <span class="n">RT_IDX_MW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">enable</span> <span class="o">?</span> <span class="n">RT_IDX_E</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_DATA</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">mask</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">INTR_EN_EI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">INTR_EN_EI</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">INTR_EN_EI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* If we&#39;re running with multiple MSI-X vectors then we enable on the fly.</span>
<span class="cm"> * Otherwise, we may have multiple outstanding workers and don&#39;t want to</span>
<span class="cm"> * enable until the last one finishes. In this case, the irq_cnt gets</span>
<span class="cm"> * incremented every time we queue a worker and decremented every time</span>
<span class="cm"> * a worker finishes.  Once it hits zero we enable the interrupt.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">ql_enable_completion_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">var</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span> <span class="o">+</span> <span class="n">intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">intr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Always enable if we&#39;re MSIX multi interrupts and</span>
<span class="cm">		 * it&#39;s not the default (zeroeth) interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_EN</span><span class="p">,</span>
			   <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intr_en_mask</span><span class="p">);</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">var</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_EN</span><span class="p">,</span>
			   <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intr_en_mask</span><span class="p">);</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">var</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_disable_completion_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">var</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="cm">/* HW disables for us if we&#39;re MSIX multi interrupts and</span>
<span class="cm">	 * it&#39;s not the default (zeroeth) interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">intr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span> <span class="o">+</span> <span class="n">intr</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_EN</span><span class="p">,</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intr_dis_mask</span><span class="p">);</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">var</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_enable_all_completion_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The enable call does a atomic_dec_and_test</span>
<span class="cm">		 * and enables only if the result is zero.</span>
<span class="cm">		 * So we precharge it here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ql_enable_completion_interrupt</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_validate_flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">flash</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Invalid flash signature.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span>	<span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">flash</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Invalid flash checksum, csum = 0x%.04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csum</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">csum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_read_flash_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* wait for reg to come ready */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="n">FLASH_ADDR</span><span class="p">,</span> <span class="n">FLASH_ADDR_RDY</span><span class="p">,</span> <span class="n">FLASH_ADDR_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="cm">/* set up for reg read */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">FLASH_ADDR</span><span class="p">,</span> <span class="n">FLASH_ADDR_R</span> <span class="o">|</span> <span class="n">offset</span><span class="p">);</span>
	<span class="cm">/* wait for reg to come ready */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="n">FLASH_ADDR</span><span class="p">,</span> <span class="n">FLASH_ADDR_RDY</span><span class="p">,</span> <span class="n">FLASH_ADDR_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	 <span class="cm">/* This data is stored on flash as an array of</span>
<span class="cm">	 * __le32.  Since ql_read32() returns cpu endian</span>
<span class="cm">	 * we need to swap it back.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">FLASH_DATA</span><span class="p">));</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_8000_flash_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="cm">/* Get flash offset for function and adjust</span>
<span class="cm">	 * for dword access.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FUNC0_FLASH_OFFSET</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">FUNC1_FLASH_OFFSET</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_FLASH_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_params_8000</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_flash_word</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Error reading flash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_validate_flash</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_params_8000</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>
			<span class="s">&quot;8000&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Invalid flash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Extract either manufacturer or BOFM modified</span>
<span class="cm">	 * MAC address.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">.</span><span class="n">flash_params_8000</span><span class="p">.</span><span class="n">data_type1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">.</span><span class="n">flash_params_8000</span><span class="p">.</span><span class="n">mac_addr1</span><span class="p">,</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">,</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">.</span><span class="n">flash_params_8000</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Invalid MAC address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		<span class="n">mac_addr</span><span class="p">,</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_FLASH_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_8012_flash_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_params_8012</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="cm">/* Second function&#39;s parameters follow the first</span>
<span class="cm">	 * function&#39;s.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_FLASH_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_flash_word</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Error reading flash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_validate_flash</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">flash_params_8012</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>
			<span class="s">&quot;8012&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Invalid flash.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">.</span><span class="n">flash_params_8012</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">.</span><span class="n">flash_params_8012</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_FLASH_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xgmac register are located behind the xgmac_addr and xgmac_data</span>
<span class="cm"> * register pair.  Each read/write requires us to wait for the ready</span>
<span class="cm"> * bit before reading/writing the data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_write_xgmac_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* wait for reg to come ready */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="n">XGMAC_ADDR</span><span class="p">,</span> <span class="n">XGMAC_ADDR_RDY</span><span class="p">,</span> <span class="n">XGMAC_ADDR_XME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* write the data to the data reg */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">XGMAC_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="cm">/* trigger the write */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">XGMAC_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* xgmac register are located behind the xgmac_addr and xgmac_data</span>
<span class="cm"> * register pair.  Each read/write requires us to wait for the ready</span>
<span class="cm"> * bit before reading/writing the data.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ql_read_xgmac_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* wait for reg to come ready */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="n">XGMAC_ADDR</span><span class="p">,</span> <span class="n">XGMAC_ADDR_RDY</span><span class="p">,</span> <span class="n">XGMAC_ADDR_XME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="cm">/* set up for reg read */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">XGMAC_ADDR</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">XGMAC_ADDR_R</span><span class="p">);</span>
	<span class="cm">/* wait for reg to come ready */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="n">XGMAC_ADDR</span><span class="p">,</span> <span class="n">XGMAC_ADDR_RDY</span><span class="p">,</span> <span class="n">XGMAC_ADDR_XME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="cm">/* get the data */</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">XGMAC_DATA</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is used for reading the 64-bit statistics regs. */</span>
<span class="kt">int</span> <span class="nf">ql_read_xgmac_reg64</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">lo</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_8000_port_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Get MPI firmware version for driver banner</span>
<span class="cm">	 * and ethool info.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_mb_about_fw</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_mb_get_fw_state</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="cm">/* Wake up a worker to get/set the TX/RX frame sizes. */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_port_cfg_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Take the MAC Core out of reset.</span>
<span class="cm"> * Enable statistics counting.</span>
<span class="cm"> * Take the transmitter/receiver out of reset.</span>
<span class="cm"> * This functionality may be done in the MPI firmware at a</span>
<span class="cm"> * later date.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_8012_port_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_trylock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">xg_sem_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Another function has the semaphore, so</span>
<span class="cm">		 * wait for the port init bit to come ready.</span>
<span class="cm">		 */</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Another function has the semaphore, so wait for the port init bit to come ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_wait_reg_rdy</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_crit</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Port initialize timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Got xgmac semaphore!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Set the core reset. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">GLOBAL_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">GLOBAL_CFG_RESET</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_write_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">GLOBAL_CFG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Clear the core reset and turn on jumbo for receiver. */</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GLOBAL_CFG_RESET</span><span class="p">;</span>	<span class="cm">/* Clear core reset. */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">GLOBAL_CFG_JUMBO</span><span class="p">;</span>	<span class="cm">/* Turn on jumbo. */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">GLOBAL_CFG_TX_STAT_EN</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">GLOBAL_CFG_RX_STAT_EN</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_write_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">GLOBAL_CFG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Enable transmitter, and clear it&#39;s reset. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">TX_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CFG_RESET</span><span class="p">;</span>	<span class="cm">/* Clear the TX MAC reset. */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">TX_CFG_EN</span><span class="p">;</span>	<span class="cm">/* Enable the transmitter. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_write_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">TX_CFG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Enable receiver and clear it&#39;s reset. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RX_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_CFG_RESET</span><span class="p">;</span>	<span class="cm">/* Clear the RX MAC reset. */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">RX_CFG_EN</span><span class="p">;</span>	<span class="cm">/* Enable the receiver. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_write_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RX_CFG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Turn on jumbo. */</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">ql_write_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_TX_PARAMS</span><span class="p">,</span> <span class="n">MAC_TX_PARAMS_JUMBO</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x2580</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">ql_write_xgmac_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MAC_RX_PARAMS</span><span class="p">,</span> <span class="mh">0x2580</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Signal to the world that the port is enabled.        */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">,</span> <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_init</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_init</span><span class="p">));</span>
<span class="nl">end:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">xg_sem_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ql_lbq_block_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lbq_buf_order</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the next large buffer. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="nf">ql_get_curr_lbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">[</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_curr_idx</span><span class="p">];</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_curr_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_curr_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">)</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_curr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_free_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lbq_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="nf">ql_get_curr_lchunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_lbuf</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">lbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">,</span>
					<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="cm">/* If it&#39;s the last chunk of our master page then</span>
<span class="cm">	 * we unmap it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">)</span>
					<span class="o">==</span> <span class="n">ql_lbq_block_size</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">map</span><span class="p">,</span>
				<span class="n">ql_lbq_block_size</span><span class="p">(</span><span class="n">qdev</span><span class="p">),</span>
				<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lbq_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the next small buffer. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="nf">ql_get_curr_sbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">sbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">[</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_curr_idx</span><span class="p">];</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_curr_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_curr_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">)</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_curr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_free_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sbq_desc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update an rx ring index. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_update_cq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">curr_entry</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">curr_entry</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_cq_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_write_db_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx_db_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_next_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">map</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">__GFP_COLD</span> <span class="o">|</span> <span class="n">__GFP_COMP</span> <span class="o">|</span>
						<span class="n">GFP_ATOMIC</span><span class="p">,</span>
						<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lbq_buf_order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;page allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">ql_lbq_block_size</span><span class="p">(</span><span class="n">qdev</span><span class="p">),</span>
					<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__free_pages</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
					<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lbq_buf_order</span><span class="p">);</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;PCI mapping failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the current master pg_chunk info</span>
<span class="cm">	 * to the current descriptor.</span>
<span class="cm">	 */</span>
	<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">;</span>

	<span class="cm">/* Adjust the master page chunk for next</span>
<span class="cm">	 * buffer get.</span>
<span class="cm">	 */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span> <span class="o">==</span> <span class="n">ql_lbq_block_size</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">last_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">va</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">;</span>
		<span class="n">get_page</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
		<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">last_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Process (refill) a large buffer queue. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_update_lbq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clean_idx</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_clean_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_free_cnt</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_clean_idx</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;lbq: try cleaning clean_idx = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">clean_idx</span><span class="p">);</span>
			<span class="n">lbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">[</span><span class="n">clean_idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_get_next_chunk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">lbq_desc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_clean_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						<span class="s">&quot;Could not get a page chunk, i=%d, clean_idx =%d .</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">clean_idx</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">map</span> <span class="o">=</span> <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">map</span> <span class="o">+</span>
				<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
				<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">lbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">lbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span>
					<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">);</span>
				<span class="o">*</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>

			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span>
						<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">,</span>
						<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">clean_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clean_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">)</span>
				<span class="n">clean_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_clean_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">)</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_free_cnt</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_idx</span> <span class="o">!=</span> <span class="n">clean_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;lbq: updating prod idx = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx</span><span class="p">);</span>
		<span class="n">ql_write_db_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx</span><span class="p">,</span>
				<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx_db_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Process (refill) a small buffer queue. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_update_sbq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clean_idx</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_clean_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">sbq_desc</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_free_cnt</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_clean_idx</span> <span class="o">%</span> <span class="mi">16</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">[</span><span class="n">clean_idx</span><span class="p">];</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;sbq: try cleaning clean_idx = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">clean_idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span>
					     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					     <span class="s">&quot;sbq: getting new skb for index %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span>
				    <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						     <span class="n">SMALL_BUFFER_SIZE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						  <span class="s">&quot;Couldn&#39;t get an skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_clean_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">,</span> <span class="n">QLGE_SB_PAD</span><span class="p">);</span>
				<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						     <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_buf_size</span><span class="p">,</span>
						     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						  <span class="s">&quot;PCI mapping failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_clean_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
				<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span>
						  <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_buf_size</span><span class="p">);</span>
				<span class="o">*</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">clean_idx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clean_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">)</span>
				<span class="n">clean_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_clean_idx</span> <span class="o">=</span> <span class="n">clean_idx</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">)</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_free_cnt</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_idx</span> <span class="o">!=</span> <span class="n">clean_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;sbq: updating prod idx = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx</span><span class="p">);</span>
		<span class="n">ql_write_db_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx</span><span class="p">,</span>
				<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx_db_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_update_buffer_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_update_sbq</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">ql_update_lbq</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Unmaps tx buffers.  Can be called from send() if a pci mapping</span>
<span class="cm"> * fails at some stage, or from the interrupt when a tx completes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_unmap_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring_desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mapped</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mapped</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">mapped</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Unmap the skb-&gt;data area, or the</span>
<span class="cm">			 * external sglist (AKA the Outbound</span>
<span class="cm">			 * Address List (OAL)).</span>
<span class="cm">			 * If its the zeroeth element, then it&#39;s</span>
<span class="cm">			 * the skb-&gt;data area.  If it&#39;s the 7th</span>
<span class="cm">			 * element and there is more than 6 frags,</span>
<span class="cm">			 * then its an OAL.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span>
					     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					     <span class="s">&quot;unmapping OAL area.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							<span class="n">mapaddr</span><span class="p">),</span>
					 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						       <span class="n">maplen</span><span class="p">),</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;unmapping frag %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">mapaddr</span><span class="p">),</span>
				       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						     <span class="n">maplen</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Map the buffers for this transmit.  This will return</span>
<span class="cm"> * NETDEV_TX_BUSY or NETDEV_TX_OK based on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_map_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_idx</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">map_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_buf_desc</span> <span class="o">*</span><span class="n">tbd</span> <span class="o">=</span> <span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_cnt</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;frag_cnt = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frag_cnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Map the skb buffer first.</span>
<span class="cm">	 */</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;PCI mapping failed with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">map_idx</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This loop fills the remainder of the 8 address descriptors</span>
<span class="cm">	 * in the IOCB.  If there are more than 7 fragments, then the</span>
<span class="cm">	 * eighth address desc will point to an external list (OAL).</span>
<span class="cm">	 * When this happens, the remainder of the frags will be stored</span>
<span class="cm">	 * in this list.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">frag_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frag_idx</span> <span class="o">&lt;</span> <span class="n">frag_cnt</span><span class="p">;</span> <span class="n">frag_idx</span><span class="o">++</span><span class="p">,</span> <span class="n">map_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">frag_idx</span><span class="p">];</span>
		<span class="n">tbd</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag_idx</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">frag_cnt</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Let&#39;s tack on an sglist.</span>
<span class="cm">			 * Our control block will now</span>
<span class="cm">			 * look like this:</span>
<span class="cm">			 * iocb-&gt;seg[0] = skb-&gt;data</span>
<span class="cm">			 * iocb-&gt;seg[1] = frag[0]</span>
<span class="cm">			 * iocb-&gt;seg[2] = frag[1]</span>
<span class="cm">			 * iocb-&gt;seg[3] = frag[2]</span>
<span class="cm">			 * iocb-&gt;seg[4] = frag[3]</span>
<span class="cm">			 * iocb-&gt;seg[5] = frag[4]</span>
<span class="cm">			 * iocb-&gt;seg[6] = frag[5]</span>
<span class="cm">			 * iocb-&gt;seg[7] = ptr to OAL (external sglist)</span>
<span class="cm">			 * oal-&gt;seg[0] = frag[6]</span>
<span class="cm">			 * oal-&gt;seg[1] = frag[7]</span>
<span class="cm">			 * oal-&gt;seg[2] = frag[8]</span>
<span class="cm">			 * oal-&gt;seg[3] = frag[9]</span>
<span class="cm">			 * oal-&gt;seg[4] = frag[10]</span>
<span class="cm">			 *      etc...</span>
<span class="cm">			 */</span>
			<span class="cm">/* Tack on the OAL in the eighth segment of IOCB. */</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">oal</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">oal</span><span class="p">),</span>
					     <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;PCI mapping outbound address list with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">map_error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The length is the number of fragments</span>
<span class="cm">			 * that remain to be mapped times the length</span>
<span class="cm">			 * of our sglist (OAL).</span>
<span class="cm">			 */</span>
			<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_buf_desc</span><span class="p">)</span> <span class="o">*</span>
					 <span class="p">(</span><span class="n">frag_cnt</span> <span class="o">-</span> <span class="n">frag_idx</span><span class="p">))</span> <span class="o">|</span> <span class="n">TX_DESC_C</span><span class="p">);</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">,</span>
					   <span class="n">map</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">maplen</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">oal</span><span class="p">));</span>
			<span class="n">tbd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_buf_desc</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">oal</span><span class="p">;</span>
			<span class="n">map_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">map</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;PCI mapping frags failed with error: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">map_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_idx</span><span class="p">],</span> <span class="n">maplen</span><span class="p">,</span>
				  <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="cm">/* Save the number of segments we&#39;ve mapped. */</span>
	<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map_cnt</span> <span class="o">=</span> <span class="n">map_idx</span><span class="p">;</span>
	<span class="cm">/* Terminate the last segment. */</span>
	<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="n">TX_DESC_E</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">map_error:</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the first frag mapping failed, then i will be zero.</span>
<span class="cm">	 * This causes the unmap of the skb-&gt;data area.  Otherwise</span>
<span class="cm">	 * we pass in the number of frags that mapped successfully</span>
<span class="cm">	 * so they can be umapped.</span>
<span class="cm">	 */</span>
	<span class="n">ql_unmap_send</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_ring_desc</span><span class="p">,</span> <span class="n">map_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Process an inbound completion from an rx ring. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_rx_gro_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_lchunk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">;</span>

	<span class="n">napi</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">napi_get_frags</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Couldn&#39;t get an skb, exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">va</span><span class="p">);</span>
	<span class="n">__skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">,</span>
			     <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
			     <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
			     <span class="n">length</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="o">++</span><span class="p">;</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="n">napi_gro_frags</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process an inbound completion from an rx ring. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_rx_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_lchunk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Couldn&#39;t get an skb, need to unwind!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">va</span><span class="p">;</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>


	<span class="cm">/* Frame error, so drop the packet. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Receive error, flags2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The max framesize filter on this chip is set higher than</span>
<span class="cm">	 * MTU since FCoE uses 2k frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Segment too small, dropping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="s">&quot;%d bytes of headers and data in large. Chain page to new skb and pull tail.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">length</span><span class="p">);</span>
	<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
				<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="o">+</span><span class="n">ETH_HLEN</span><span class="p">,</span>
				<span class="n">length</span><span class="o">-</span><span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">length</span><span class="o">-</span><span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">length</span><span class="o">-</span><span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">length</span><span class="o">-</span><span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_CSUM_ERR_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TCP frame. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;TCP checksum done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_U</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Unfragmented ipv4 UDP frame. */</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">&amp;</span>
				<span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">IP_MF</span><span class="o">|</span><span class="n">IP_OFFSET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span>
					     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					     <span class="s">&quot;UDP checksum done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">)</span>
		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process an inbound completion from an rx ring. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">length</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">sbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_sbuf</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">;</span>
	<span class="cm">/* Allocate new_skb and copy */</span>
	<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;No skb available, drop the packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>

	<span class="cm">/* Frame error, so drop the packet. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Receive error, flags2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loopback self test for ethtool */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_SELFTEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_check_lb_frame</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The max framesize filter on this chip is set higher than</span>
<span class="cm">	 * MTU since FCoE uses 2k frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;%s Multicast.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">IB_MAC_IOCB_RSP_M_HASH</span> <span class="o">?</span> <span class="s">&quot;Hash&quot;</span> <span class="o">:</span>
			     <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">IB_MAC_IOCB_RSP_M_REG</span> <span class="o">?</span> <span class="s">&quot;Registered&quot;</span> <span class="o">:</span>
			     <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">IB_MAC_IOCB_RSP_M_PROM</span> <span class="o">?</span> <span class="s">&quot;Promiscuous&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_P</span><span class="p">)</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Promiscuous Packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* If rx checksum is on, and there are no</span>
<span class="cm">	 * csum or frame errors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_CSUM_ERR_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TCP frame. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;TCP checksum done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_U</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Unfragmented ipv4 UDP frame. */</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">&amp;</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">IP_MF</span><span class="o">|</span><span class="n">IP_OFFSET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span>
					     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					     <span class="s">&quot;UDP checksum done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">)</span>
		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_realign_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">temp_addr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Undo the skb_reserve(skb,32) we did before</span>
<span class="cm">	 * giving to hardware, and realign data on</span>
<span class="cm">	 * a 2-byte boundary.</span>
<span class="cm">	 */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-=</span> <span class="n">QLGE_SB_PAD</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-=</span> <span class="n">QLGE_SB_PAD</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">temp_addr</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function builds an skb for the given inbound</span>
<span class="cm"> * completion.  It will be rewritten for readability in the near</span>
<span class="cm"> * future, but for not it works well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ql_build_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">sbq_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
       <span class="n">u32</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">hdr_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle the header buffer if present.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags4</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_HV</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags4</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_HS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Header of %d bytes in small buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Headers fit nicely into a small buffer.</span>
<span class="cm">		 */</span>
		<span class="n">sbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_sbuf</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
				<span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
				<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">ql_realign_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle the data buffer(s).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Is there data too? */</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;No Data buffer in this packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_DS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags4</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_HS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Headers in small, data of %d bytes in small, combine them.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">length</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Data is less than small buffer size so it&#39;s</span>
<span class="cm">			 * stuffed in a small buffer.</span>
<span class="cm">			 * For this case we append the data</span>
<span class="cm">			 * from the &quot;data&quot; small buffer to the &quot;header&quot; small</span>
<span class="cm">			 * buffer.</span>
<span class="cm">			 */</span>
			<span class="n">sbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_sbuf</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						    <span class="n">dma_unmap_addr</span>
						    <span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
						    <span class="n">dma_unmap_len</span>
						    <span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
						    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span>
			       <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						       <span class="n">dma_unmap_addr</span>
						       <span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span>
							<span class="n">mapaddr</span><span class="p">),</span>
						       <span class="n">dma_unmap_len</span>
						       <span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span>
							<span class="n">maplen</span><span class="p">),</span>
						       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%d bytes in a single small buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">length</span><span class="p">);</span>
			<span class="n">sbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_sbuf</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">ql_realign_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span>
							<span class="n">mapaddr</span><span class="p">),</span>
					 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span>
						       <span class="n">maplen</span><span class="p">),</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_DL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags4</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_HS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Header in small, %d bytes in large. Chain large to small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">length</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The data is in a single large buffer.  We</span>
<span class="cm">			 * chain it to the header buffer&#39;s skb and let</span>
<span class="cm">			 * it rip.</span>
<span class="cm">			 */</span>
			<span class="n">lbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_lchunk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Chaining page at offset = %d, for %d bytes  to skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
						<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
						<span class="n">length</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The headers and data are in a single large buffer. We</span>
<span class="cm">			 * copy it to a new skb and let it go. This can happen with</span>
<span class="cm">			 * jumbo mtu on a non-TCP/UDP frame.</span>
<span class="cm">			 */</span>
			<span class="n">lbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_lchunk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					     <span class="s">&quot;No skb available, drop the packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">lbq_desc</span><span class="p">,</span>
						      <span class="n">mapaddr</span><span class="p">),</span>
				       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">lbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%d bytes of headers and data in large. Chain page to new skb and pull tail.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">length</span><span class="p">);</span>
			<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
						<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
						<span class="n">length</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">__pskb_pull_tail</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">VLAN_ETH_HLEN</span> <span class="o">:</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The data is in a chain of large buffers</span>
<span class="cm">		 * pointed to by a small buffer.  We loop</span>
<span class="cm">		 * thru and chain them to the our small header</span>
<span class="cm">		 * buffer&#39;s skb.</span>
<span class="cm">		 * frags:  There are 18 max frags and our small</span>
<span class="cm">		 *         buffer will hold 32 of them. The thing is,</span>
<span class="cm">		 *         we&#39;ll use 3 max for our 9000 byte jumbo</span>
<span class="cm">		 *         frames.  If the MTU goes up we could</span>
<span class="cm">		 *          eventually be in trouble.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_sbuf</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
				 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags4</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_HS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This is an non TCP/UDP IP frame, so</span>
<span class="cm">			 * the headers aren&#39;t split into a small</span>
<span class="cm">			 * buffer.  We have to use the small buffer</span>
<span class="cm">			 * that contains our sg list as our skb to</span>
<span class="cm">			 * send upstairs. Copy the sg list here to</span>
<span class="cm">			 * a local buffer and use it to find the</span>
<span class="cm">			 * pages to chain.</span>
<span class="cm">			 */</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%d bytes of headers &amp; data in chain of large.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">length</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbq_desc</span> <span class="o">=</span> <span class="n">ql_get_curr_lchunk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">)</span> <span class="o">?</span> <span class="n">length</span> <span class="o">:</span>
				<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">;</span>

			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Adding page %d to skb for %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">skb_fill_page_desc</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">,</span>
						<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
						<span class="n">size</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__pskb_pull_tail</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">VLAN_ETH_HLEN</span> <span class="o">:</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Process an inbound completion from an rx ring. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_split_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">vlan_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">QL_DUMP_IB_MAC_RSP</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ql_build_rx_skb</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;No skb available, drop packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Frame error, so drop the packet. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_ERR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Receive error, flags2 = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The max framesize filter on this chip is set higher than</span>
<span class="cm">	 * MTU since FCoE uses 2k frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loopback self test for ethtool */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_SELFTEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_check_lb_frame</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;%s Multicast.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">IB_MAC_IOCB_RSP_M_HASH</span> <span class="o">?</span> <span class="s">&quot;Hash&quot;</span> <span class="o">:</span>
			     <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">IB_MAC_IOCB_RSP_M_REG</span> <span class="o">?</span> <span class="s">&quot;Registered&quot;</span> <span class="o">:</span>
			     <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_M_MASK</span><span class="p">)</span> <span class="o">==</span>
			     <span class="n">IB_MAC_IOCB_RSP_M_PROM</span> <span class="o">?</span> <span class="s">&quot;Promiscuous&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_multicast</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_P</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Promiscuous Packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* If rx checksum is on, and there are no</span>
<span class="cm">	 * csum or frame errors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_CSUM_ERR_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TCP frame. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;TCP checksum done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_U</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V4</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Unfragmented ipv4 UDP frame. */</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">frag_off</span> <span class="o">&amp;</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">IP_MF</span><span class="o">|</span><span class="n">IP_OFFSET</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
				<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					     <span class="s">&quot;TCP checksum done!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">skb_record_rx_queue</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vlan_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">)</span>
		<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Process an inbound completion from an rx ring. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ql_process_mac_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">vlan_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_V</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">IB_MAC_IOCB_RSP_VLAN_MASK</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">QL_DUMP_IB_MAC_RSP</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags4</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_HV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The data and headers are split into</span>
<span class="cm">		 * separate buffers.</span>
<span class="cm">		 */</span>
		<span class="n">ql_process_mac_split_rx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="p">,</span>
						<span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_DS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The data fit in a single small buffer.</span>
<span class="cm">		 * Allocate a new skb, copy the data and</span>
<span class="cm">		 * return the buffer to the free pool.</span>
<span class="cm">		 */</span>
		<span class="n">ql_process_mac_rx_skb</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="p">,</span>
						<span class="n">length</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_DL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">IB_MAC_CSUM_ERR_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_T</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TCP packet in a page chunk that&#39;s been checksummed.</span>
<span class="cm">		 * Tack it on to our GRO skb and let it go.</span>
<span class="cm">		 */</span>
		<span class="n">ql_process_mac_rx_gro_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="p">,</span>
						<span class="n">length</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ib_mac_rsp</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">&amp;</span> <span class="n">IB_MAC_IOCB_RSP_DL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Non-TCP packet in a page chunk. Allocate an</span>
<span class="cm">		 * skb, tack it on frags, and send it up.</span>
<span class="cm">		 */</span>
		<span class="n">ql_process_mac_rx_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="p">,</span>
						<span class="n">length</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Non-TCP/UDP large frames that span multiple buffers</span>
<span class="cm">		 * can be processed corrrectly by the split frame logic.</span>
<span class="cm">		 */</span>
		<span class="n">ql_process_mac_split_rx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ib_mac_rsp</span><span class="p">,</span>
						<span class="n">vlan_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Process an outbound completion from an rx ring. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ob_mac_iocb_rsp</span> <span class="o">*</span><span class="n">mac_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring_desc</span><span class="p">;</span>

	<span class="n">QL_DUMP_OB_MAC_RSP</span><span class="p">(</span><span class="n">mac_rsp</span><span class="p">);</span>
	<span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">];</span>
	<span class="n">tx_ring_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">[</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">ql_unmap_send</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_ring_desc</span><span class="p">,</span> <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map_cnt</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OB_MAC_IOCB_RSP_E</span> <span class="o">|</span>
					<span class="n">OB_MAC_IOCB_RSP_S</span> <span class="o">|</span>
					<span class="n">OB_MAC_IOCB_RSP_L</span> <span class="o">|</span>
					<span class="n">OB_MAC_IOCB_RSP_P</span> <span class="o">|</span> <span class="n">OB_MAC_IOCB_RSP_B</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">OB_MAC_IOCB_RSP_E</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Total descriptor length did not match transfer length.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">OB_MAC_IOCB_RSP_S</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Frame too short to be valid, not sent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">OB_MAC_IOCB_RSP_L</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Frame too long, but sent anyway.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">&amp;</span> <span class="n">OB_MAC_IOCB_RSP_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;PCI backplane error. Frame not sent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fire up a handler to reset the MPI processor. */</span>
<span class="kt">void</span> <span class="nf">ql_queue_fw_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_link_off</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_reset_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ql_queue_asic_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_link_off</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_disable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="cm">/* Clear adapter up bit to signal the recovery</span>
<span class="cm">	 * process that it shouldn&#39;t kill the reset worker</span>
<span class="cm">	 * thread</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Set asic recovery bit to indicate reset process that we are</span>
<span class="cm">	 * in fatal error recovery process rather than normal close</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ASIC_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">asic_reset_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_chip_ae_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ib_ae_iocb_rsp</span> <span class="o">*</span><span class="n">ib_ae_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ib_ae_rsp</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGMT_ERR_EVENT</span>:
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Management Processor Fatal Error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_queue_fw_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAM_LOOKUP_ERR_EVENT</span>:
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Multiple CAM hits lookup occurred.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;This event shouldn&#39;t occur.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_queue_asic_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOFT_ECC_ERROR_EVENT</span>:
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Soft ECC error detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_queue_asic_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_ERR_ANON_BUF_RD</span>:
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;PCI error occurred when reading &quot;</span>
					<span class="s">&quot;anonymous buffers from rx_ring %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ib_ae_rsp</span><span class="o">-&gt;</span><span class="n">q_id</span><span class="p">);</span>
		<span class="n">ql_queue_asic_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Unexpected event %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ib_ae_rsp</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
		<span class="n">ql_queue_asic_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_clean_outbound_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">qdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">ql_read_sh_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ob_mac_iocb_rsp</span> <span class="o">*</span><span class="n">net_rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="cm">/* While there are entries in the completion queue. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">prod</span> <span class="o">!=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;cq_id = %d, prod = %d, cnsmr = %d.</span><span class="se">\n</span><span class="s">.&quot;</span><span class="p">,</span>
			     <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">);</span>

		<span class="n">net_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_iocb_rsp</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">curr_entry</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">OPCODE_OB_MAC_TSO_IOCB</span>:
		<span class="k">case</span> <span class="n">OPCODE_OB_MAC_IOCB</span>:
			<span class="n">ql_process_mac_tx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">net_rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Hit default case, not handled! dropping the packet, opcode = %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ql_update_cq</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="n">prod</span> <span class="o">=</span> <span class="n">ql_read_sh_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_rsp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ql_write_cq_idx</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__netif_subqueue_stopped</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_stopped</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)))</span>
			<span class="cm">/*</span>
<span class="cm">			 * The queue got stopped because the tx_ring was full.</span>
<span class="cm">			 * Wake it up, because it&#39;s now at least 25% empty.</span>
<span class="cm">			 */</span>
			<span class="n">netif_wake_subqueue</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_clean_inbound_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">qdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prod</span> <span class="o">=</span> <span class="n">ql_read_sh_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_net_rsp_iocb</span> <span class="o">*</span><span class="n">net_rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* While there are entries in the completion queue. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">prod</span> <span class="o">!=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;cq_id = %d, prod = %d, cnsmr = %d.</span><span class="se">\n</span><span class="s">.&quot;</span><span class="p">,</span>
			     <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">);</span>

		<span class="n">net_rsp</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">curr_entry</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OPCODE_IB_MAC_IOCB</span>:
			<span class="n">ql_process_mac_rx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span>
					       <span class="p">(</span><span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="p">)</span>
					       <span class="n">net_rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OPCODE_IB_AE_IOCB</span>:
			<span class="n">ql_process_chip_ae_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ib_ae_iocb_rsp</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">net_rsp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Hit default case, not handled! dropping the packet, opcode = %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ql_update_cq</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
		<span class="n">prod</span> <span class="o">=</span> <span class="n">ql_read_sh_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">budget</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_update_buffer_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">ql_write_cq_idx</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_napi_poll_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">qdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">trx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">];</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="s">&quot;Enter, NAPI POLL cq_id = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>

	<span class="cm">/* Service the TX rings first.  They start</span>
<span class="cm">	 * right after the RSS rings. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">trx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* If this TX completion ring belongs to this vector and</span>
<span class="cm">		 * it&#39;s not empty then service it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">trx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ql_read_sh_reg</span><span class="p">(</span><span class="n">trx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">trx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%s: Servicing TX completion ring %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span> <span class="n">trx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
			<span class="n">ql_clean_outbound_rx_ring</span><span class="p">(</span><span class="n">trx_ring</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now service the RSS ring if it&#39;s active.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_read_sh_reg</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;%s: Servicing RX completion ring %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
		<span class="n">work_done</span> <span class="o">=</span> <span class="n">ql_clean_inbound_rx_ring</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">ql_enable_completion_interrupt</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlge_vlan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">NIC_RCV_CFG</span><span class="p">,</span> <span class="n">NIC_RCV_CFG_VLAN_MASK</span> <span class="o">|</span>
				 <span class="n">NIC_RCV_CFG_VLAN_MATCH_AND_NON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">NIC_RCV_CFG</span><span class="p">,</span> <span class="n">NIC_RCV_CFG_VLAN_MASK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">qlge_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since there is no support for separate rx/tx vlan accel</span>
<span class="cm">	 * enable/disable make sure tx flag is always in same state as rx.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">qlge_vlan_mode</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qlge_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">enable_bit</span> <span class="o">=</span> <span class="n">MAC_ADDR_E</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_set_mac_addr_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">enable_bit</span><span class="p">,</span>
				  <span class="n">MAC_ADDR_TYPE_VLAN</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to init vlan address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__qlge_vlan_rx_add_vid</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>

	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qlge_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">enable_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_set_mac_addr_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">enable_bit</span><span class="p">,</span>
				  <span class="n">MAC_ADDR_TYPE_VLAN</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to clear vlan address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__qlge_vlan_rx_kill_vid</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>

	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlge_restore_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span>
		<span class="n">__qlge_vlan_rx_add_vid</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>

	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* MSI-X Multiple Vector Interrupt Handler for inbound completions. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlge_msix_rx_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This handles a fatal error, MPI activity, and the default</span>
<span class="cm"> * rx_ring in an MSI-X multiple vector environment.</span>
<span class="cm"> * In MSI/Legacy environment it also process the rest of</span>
<span class="cm"> * the rx_rings.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlge_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">qdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">intr_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">var</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq_cnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Shared Interrupt, Not ours!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="n">var</span> <span class="o">=</span> <span class="n">ql_disable_completion_interrupt</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for fatal error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">&amp;</span> <span class="n">STS_FE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_queue_asic_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Got fatal error, STS = %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="n">var</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ERR_STS</span><span class="p">);</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Resetting chip. &quot;</span>
					<span class="s">&quot;Error Status Register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check MPI processor activity.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span> <span class="o">&amp;</span> <span class="n">STS_PI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INTR_MASK_PI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;ve got an async event or mailbox completion.</span>
<span class="cm">		 * Handle it and clear the source of the interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Got MPI processor interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_disable_completion_interrupt</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_MASK</span><span class="p">,</span> <span class="p">(</span><span class="n">INTR_MASK_PI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">queue_delayed_work_on</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span>
				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">work_done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the bit-mask that shows the active queues for this</span>
<span class="cm">	 * pass.  Compare it to the queues that this irq services</span>
<span class="cm">	 * and call napi if there&#39;s a match.</span>
<span class="cm">	 */</span>
	<span class="n">var</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ISR1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">&amp;</span> <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Waking handler for rx_ring[0].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_disable_completion_interrupt</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">work_done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_enable_completion_interrupt</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">work_done</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_tso</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ob_mac_tso_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_header_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_OB_MAC_TSO_IOCB</span><span class="p">;</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_IC</span><span class="p">;</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">total_hdrs_len</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">net_trans_offset</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="o">&lt;&lt;</span> <span class="n">OB_MAC_TRANSPORT_HDR_SHIFT</span><span class="p">);</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">);</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_LSO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_IP4</span><span class="p">;</span>
			<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
								 <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								 <span class="n">IPPROTO_TCP</span><span class="p">,</span>
								 <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_IP6</span><span class="p">;</span>
			<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span>
			    <span class="o">~</span><span class="n">csum_ipv6_magic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span>
					     <span class="mi">0</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_hw_csum_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ob_mac_tso_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">__sum16</span> <span class="o">*</span><span class="n">check</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_OB_MAC_TSO_IOCB</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">net_trans_offset</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">OB_MAC_TRANSPORT_HDR_SHIFT</span><span class="p">);</span>

	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_IP4</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">ihl</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">check</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">);</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_TC</span><span class="p">;</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">total_hdrs_len</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">doff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">check</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">udp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">);</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">OB_MAC_TSO_IOCB_UC</span><span class="p">;</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">total_hdrs_len</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udphdr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
				    <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">iph</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">qlge_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tso</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_ring_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">;</span>

	<span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_ring_idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;%s: shutting down tx queue %d du to lack of resources.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">tx_ring_idx</span><span class="p">);</span>
		<span class="n">netif_stop_subqueue</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_stopped</span><span class="p">);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tx_ring_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">[</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span><span class="p">];</span>
	<span class="n">mac_iocb_ptr</span> <span class="o">=</span> <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">queue_entry</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mac_iocb_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">));</span>

	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_OB_MAC_IOCB</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="cm">/* We use the upper 32-bits to store the tx queue for this IO.</span>
<span class="cm">	 * When we get the completion we can use it to establish the context.</span>
<span class="cm">	 */</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">txq_idx</span> <span class="o">=</span> <span class="n">tx_ring_idx</span><span class="p">;</span>
	<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">frame_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Adding a vlan tag %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags3</span> <span class="o">|=</span> <span class="n">OB_MAC_IOCB_V</span><span class="p">;</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">tso</span> <span class="o">=</span> <span class="n">ql_tso</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_tso_iocb_req</span> <span class="o">*</span><span class="p">)</span><span class="n">mac_iocb_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tso</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">tso</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_hw_csum_setup</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
				 <span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_tso_iocb_req</span> <span class="o">*</span><span class="p">)</span><span class="n">mac_iocb_ptr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_map_send</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">mac_iocb_ptr</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_ring_desc</span><span class="p">)</span> <span class="o">!=</span>
			<span class="n">NETDEV_TX_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Could not map the segments.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">QL_DUMP_OB_MAC_IOCB</span><span class="p">(</span><span class="n">mac_iocb_ptr</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span><span class="p">)</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">ql_write_db_reg</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_db_reg</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="s">&quot;tx queued, slot %d, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_shadow_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_dma</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_dma</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_shadow_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Allocation of RX shadow space failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Allocation of TX shadow space failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_wqp_sh_area</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_wqp_sh_area:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">PAGE_SIZE</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_init_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">;</span>

	<span class="n">mac_iocb_ptr</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span><span class="p">;</span>
	<span class="n">tx_ring_desc</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">queue_entry</span> <span class="o">=</span> <span class="n">mac_iocb_ptr</span><span class="p">;</span>
		<span class="n">mac_iocb_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_ring_desc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">queue_stopped</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_size</span><span class="p">,</span>
				    <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base_dma</span><span class="p">);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_size</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base_dma</span> <span class="o">&amp;</span> <span class="n">WQ_ADDR_ALIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;tx_ring alloc failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span>
	    <span class="n">kmalloc</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_ring_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_size</span><span class="p">,</span>
			    <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_lbq_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span><span class="p">;</span>

	<span class="kt">uint32_t</span>  <span class="n">curr_idx</span><span class="p">,</span> <span class="n">clean_idx</span><span class="p">;</span>

	<span class="n">curr_idx</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_curr_idx</span><span class="p">;</span>
	<span class="n">clean_idx</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_clean_idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">curr_idx</span> <span class="o">!=</span> <span class="n">clean_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">[</span><span class="n">curr_idx</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">last_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">map</span><span class="p">,</span>
				<span class="n">ql_lbq_block_size</span><span class="p">(</span><span class="n">qdev</span><span class="p">),</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">last_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">put_page</span><span class="p">(</span><span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span><span class="p">);</span>
		<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">pg_chunk</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">curr_idx</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">)</span>
			<span class="n">curr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_sbq_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">sbq_desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbq_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;sbq_desc %d is NULL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
					 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Free all large and small rx buffers associated</span>
<span class="cm"> * with the completion queues for this device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">)</span>
			<span class="n">ql_free_lbq_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">)</span>
			<span class="n">ql_free_sbq_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_alloc_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TX_Q</span><span class="p">)</span>
			<span class="n">ql_update_buffer_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_init_lbq_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">lbq_desc</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="o">*</span><span class="n">bq</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bq_desc</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lbq_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lbq_desc</span><span class="p">));</span>
		<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">lbq_desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">bq</span><span class="p">;</span>
		<span class="n">bq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_init_sbq_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bq_desc</span> <span class="o">*</span><span class="n">sbq_desc</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="o">*</span><span class="n">bq</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bq_desc</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbq_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sbq_desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sbq_desc</span><span class="p">));</span>
		<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sbq_desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">bq</span><span class="p">;</span>
		<span class="n">bq</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Free the small buffer queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_size</span><span class="p">,</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_dma</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free the small buffer queue control blocks. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free the large buffer queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_size</span><span class="p">,</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_dma</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free the large buffer queue control blocks. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Free the rx queue. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_size</span><span class="p">,</span>
				    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base_dma</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Allocate queues and buffers for this completions queue based</span>
<span class="cm"> * on the values in the parameter structure. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the completion queue for this rx_ring.</span>
<span class="cm">	 */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_size</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base_dma</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;rx_ring alloc failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate small buffer queue.</span>
<span class="cm">		 */</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_dma</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Small buffer queue allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Allocate small buffer queue control blocks.</span>
<span class="cm">		 */</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bq_desc</span><span class="p">),</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Small buffer queue control block allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_init_sbq_ring</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate large buffer queue.</span>
<span class="cm">		 */</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_dma</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Large buffer queue allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate large buffer queue control blocks.</span>
<span class="cm">		 */</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bq_desc</span><span class="p">),</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Large buffer queue control block allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ql_init_lbq_ring</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mem:</span>
	<span class="n">ql_free_rx_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_tx_ring_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring_desc</span> <span class="o">*</span><span class="n">tx_ring_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through all queues and free</span>
<span class="cm">	 * any resources.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_ring_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring_desc</span> <span class="o">&amp;&amp;</span> <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Freeing lost SKB %p, from queue %d, index %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
					  <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">ql_unmap_send</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_ring_desc</span><span class="p">,</span>
					      <span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">map_cnt</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">tx_ring_desc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_mem_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ql_free_tx_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ql_free_rx_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">ql_free_shadow_space</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_mem_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Allocate space for our shadow registers and such. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_shadow_space</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_rx_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;RX resource allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate tx queue resources */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_tx_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;TX resource allocation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mem</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mem:</span>
	<span class="n">ql_free_mem_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set up the rx ring control block and pass it to the chip.</span>
<span class="cm"> * The control block is defined as</span>
<span class="cm"> * &quot;Completion Queue Initialization Control Block&quot;, or cqicb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_start_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cqicb</span> <span class="o">*</span><span class="n">cqicb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cqicb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">shadow_reg</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_area</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">*</span> <span class="n">RX_RING_SHADOW_SPACE</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">shadow_reg_dma</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_shadow_reg_dma</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">*</span> <span class="n">RX_RING_SHADOW_SPACE</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">doorbell_area</span> <span class="o">=</span>
	    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area</span> <span class="o">+</span> <span class="p">(</span><span class="n">DB_PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">+</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bq_len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="o">*</span><span class="n">base_indirect_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_entries</span><span class="p">;</span>

	<span class="cm">/* Set up the shadow registers for this ring. */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span> <span class="o">=</span> <span class="n">shadow_reg</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg_dma</span> <span class="o">=</span> <span class="n">shadow_reg_dma</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">shadow_reg</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="n">shadow_reg_dma</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_indirect</span> <span class="o">=</span> <span class="n">shadow_reg</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_indirect_dma</span> <span class="o">=</span> <span class="n">shadow_reg_dma</span><span class="p">;</span>
	<span class="n">shadow_reg</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_DB_PAGES_PER_BQ</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">));</span>
	<span class="n">shadow_reg_dma</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">MAX_DB_PAGES_PER_BQ</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">));</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_indirect</span> <span class="o">=</span> <span class="n">shadow_reg</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_indirect_dma</span> <span class="o">=</span> <span class="n">shadow_reg_dma</span><span class="p">;</span>

	<span class="cm">/* PCI doorbell mem area + 0x00 for consumer index register */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx_db_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">doorbell_area</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">curr_entry</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base</span><span class="p">;</span>

	<span class="cm">/* PCI doorbell mem area + 0x04 for valid register */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">valid_db_reg</span> <span class="o">=</span> <span class="n">doorbell_area</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="cm">/* PCI doorbell mem area + 0x18 for large buffer consumer */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx_db_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">doorbell_area</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>

	<span class="cm">/* PCI doorbell mem area + 0x1c */</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx_db_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">doorbell_area</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cqicb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cqicb</span><span class="p">));</span>
	<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">msix_vect</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">bq_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span> <span class="o">==</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span><span class="p">;</span>
	<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bq_len</span> <span class="o">|</span> <span class="n">LEN_V</span> <span class="o">|</span> <span class="n">LEN_CPP_CONT</span><span class="p">);</span>

	<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_base_dma</span><span class="p">);</span>

	<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">prod_idx_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_sh_reg_dma</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the control block load flags.</span>
<span class="cm">	 */</span>
	<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS_LC</span> <span class="o">|</span>	<span class="cm">/* Load queue base address */</span>
	    <span class="n">FLAGS_LV</span> <span class="o">|</span>		<span class="cm">/* Load MSI-X vector */</span>
	    <span class="n">FLAGS_LI</span><span class="p">;</span>		<span class="cm">/* Load irq delay values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_LL</span><span class="p">;</span>	<span class="cm">/* Load lbq values */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_dma</span><span class="p">;</span>
		<span class="n">base_indirect_ptr</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_indirect</span><span class="p">;</span>
		<span class="n">page_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">base_indirect_ptr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">+=</span> <span class="n">DB_PAGE_SIZE</span><span class="p">;</span>
			<span class="n">base_indirect_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">page_entries</span> <span class="o">&lt;</span> <span class="n">MAX_DB_PAGES_PER_BQ</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">));</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">lbq_addr</span> <span class="o">=</span>
		    <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_base_indirect_dma</span><span class="p">);</span>
		<span class="n">bq_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span> <span class="o">==</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span><span class="p">;</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bq_len</span><span class="p">);</span>
		<span class="n">bq_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">==</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">;</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bq_len</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_curr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_clean_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_free_cnt</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_LS</span><span class="p">;</span>	<span class="cm">/* Load sbq values */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_dma</span><span class="p">;</span>
		<span class="n">base_indirect_ptr</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_indirect</span><span class="p">;</span>
		<span class="n">page_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">base_indirect_ptr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">+=</span> <span class="n">DB_PAGE_SIZE</span><span class="p">;</span>
			<span class="n">base_indirect_ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">page_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">page_entries</span> <span class="o">&lt;</span> <span class="n">MAX_DB_PAGES_PER_BQ</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">));</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">sbq_addr</span> <span class="o">=</span>
		    <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_base_indirect_dma</span><span class="p">);</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">sbq_buf_size</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_buf_size</span><span class="p">));</span>
		<span class="n">bq_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">==</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">;</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bq_len</span><span class="p">);</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_curr_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_clean_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_free_cnt</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_Q</span>:
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">irq_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span><span class="p">);</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">pkt_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_Q</span>:
		<span class="cm">/* Inbound completion handling rx_rings run in</span>
<span class="cm">		 * separate NAPI contexts.</span>
<span class="cm">		 */</span>
		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">ql_napi_poll_msix</span><span class="p">,</span>
			       <span class="mi">64</span><span class="p">);</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">irq_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span><span class="p">);</span>
		<span class="n">cqicb</span><span class="o">-&gt;</span><span class="n">pkt_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;Invalid rx_ring-&gt;type = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_write_cfg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">cqicb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cqicb</span><span class="p">),</span>
			   <span class="n">CFG_LCQ</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to load CQICB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_start_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wqicb</span> <span class="o">*</span><span class="n">wqicb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wqicb</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">doorbell_area</span> <span class="o">=</span>
	    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area</span> <span class="o">+</span> <span class="p">(</span><span class="n">DB_PAGE_SIZE</span> <span class="o">*</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">shadow_reg</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_area</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">u64</span> <span class="n">shadow_reg_dma</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_shadow_reg_dma</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assign doorbell registers for this tx_ring.</span>
<span class="cm">	 */</span>
	<span class="cm">/* TX PCI doorbell mem area for tx producer index */</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx_db_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">doorbell_area</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">prod_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* TX PCI doorbell mem area + 0x04 */</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">valid_db_reg</span> <span class="o">=</span> <span class="n">doorbell_area</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assign shadow registers for this tx_ring.</span>
<span class="cm">	 */</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx_sh_reg</span> <span class="o">=</span> <span class="n">shadow_reg</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx_sh_reg_dma</span> <span class="o">=</span> <span class="n">shadow_reg_dma</span><span class="p">;</span>

	<span class="n">wqicb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span> <span class="o">|</span> <span class="n">Q_LEN_V</span> <span class="o">|</span> <span class="n">Q_LEN_CPP_CONT</span><span class="p">);</span>
	<span class="n">wqicb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">Q_FLAGS_LC</span> <span class="o">|</span>
				   <span class="n">Q_FLAGS_LB</span> <span class="o">|</span> <span class="n">Q_FLAGS_LI</span> <span class="o">|</span> <span class="n">Q_FLAGS_LO</span><span class="p">);</span>
	<span class="n">wqicb</span><span class="o">-&gt;</span><span class="n">cq_id_rss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="n">wqicb</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wqicb</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_base_dma</span><span class="p">);</span>

	<span class="n">wqicb</span><span class="o">-&gt;</span><span class="n">cnsmr_idx_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cnsmr_idx_sh_reg_dma</span><span class="p">);</span>

	<span class="n">ql_init_tx_ring</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_write_cfg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">wqicb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqicb</span><span class="p">),</span> <span class="n">CFG_LRQ</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to load tx_ring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_disable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* We start by trying to get the number of vectors</span>
<span class="cm"> * stored in qdev-&gt;intr_count. If we don&#39;t get that</span>
<span class="cm"> * many then we reduce the count and try again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Get the MSIX vectors. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlge_irq_type</span> <span class="o">==</span> <span class="n">MSIX_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Try to alloc space for the msix struct,</span>
<span class="cm">		 * if it fails then go to MSI/legacy.</span>
<span class="cm">		 */</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">),</span>
					    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlge_irq_type</span> <span class="o">=</span> <span class="n">MSI_IRQ</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">msi</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Loop to get our vectors.  We start with</span>
<span class="cm">		 * what we want and settle for what we get.</span>
<span class="cm">		 */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">);</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;MSI-X Enable failed, trying MSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">qlge_irq_type</span> <span class="o">=</span> <span class="n">MSI_IRQ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;MSI-X Enabled, got %d vectors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">msi:</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlge_irq_type</span> <span class="o">==</span> <span class="n">MSI_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Running with MSI interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qlge_irq_type</span> <span class="o">=</span> <span class="n">LEG_IRQ</span><span class="p">;</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		     <span class="s">&quot;Running with legacy interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Each vector services 1 RSS ring and and 1 or more</span>
<span class="cm"> * TX completion rings.  This function loops through</span>
<span class="cm"> * the TX completion rings and assigns the vector that</span>
<span class="cm"> * will service it.  An example would be if there are</span>
<span class="cm"> * 2 vectors (so 2 RSS rings) and 8 TX completion rings.</span>
<span class="cm"> * This would mean that vector 0 would service RSS ring 0</span>
<span class="cm"> * and TX completion rings 0,1,2 and 3.  Vector 1 would</span>
<span class="cm"> * service RSS ring 1 and TX completion rings 4,5,6 and 7.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_set_tx_vect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">vect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_rings_per_vector</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">/</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Assign irq vectors to TX rx_rings.*/</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span>
					 <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">tx_rings_per_vector</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vect</span><span class="o">++</span><span class="p">;</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">vect</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For single vector all rings have an irq</span>
<span class="cm">		 * of zero.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Set the interrupt mask for this vector.  Each vector</span>
<span class="cm"> * will service 1 RSS ring and 1 or more TX completion</span>
<span class="cm"> * rings.  This function sets up a bit mask per vector</span>
<span class="cm"> * that indicates which rings it services.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_set_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">vect</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_rings_per_vector</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">/</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Add the RSS ring serviced by this vector</span>
<span class="cm">		 * to the mask.</span>
<span class="cm">		 */</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">vect</span><span class="p">].</span><span class="n">cq_id</span><span class="p">);</span>
		<span class="cm">/* Add the TX ring(s) serviced by this vector</span>
<span class="cm">		 * to the mask. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tx_rings_per_vector</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">vect</span> <span class="o">*</span> <span class="n">tx_rings_per_vector</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">].</span><span class="n">cq_id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For single vector we just shift each queue&#39;s</span>
<span class="cm">		 * ID into the mask.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">cq_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Here we build the intr_context structures based on</span>
<span class="cm"> * our rx_ring count and intr vector count.</span>
<span class="cm"> * The intr_context structure is used to hook each vector</span>
<span class="cm"> * to possibly different handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_resolve_queues_to_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">intr_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Each rx_ring has it&#39;s</span>
<span class="cm">		 * own intr_context since we have separate</span>
<span class="cm">		 * vectors for each queue.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">qdev</span><span class="p">;</span>
			<span class="cm">/* Set up this vector&#39;s bit-mask that indicates</span>
<span class="cm">			 * which queues it services.</span>
<span class="cm">			 */</span>
			<span class="n">ql_set_irq_mask</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr_context</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * We set up each vectors enable/disable/read bits so</span>
<span class="cm">			 * there&#39;s no bit/mask calculations in the critical path.</span>
<span class="cm">			 */</span>
			<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr_en_mask</span> <span class="o">=</span>
			    <span class="n">INTR_EN_TYPE_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_INTR_MASK</span> <span class="o">|</span>
			    <span class="n">INTR_EN_TYPE_ENABLE</span> <span class="o">|</span> <span class="n">INTR_EN_IHD_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_IHD</span>
			    <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr_dis_mask</span> <span class="o">=</span>
			    <span class="n">INTR_EN_TYPE_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_INTR_MASK</span> <span class="o">|</span>
			    <span class="n">INTR_EN_TYPE_DISABLE</span> <span class="o">|</span> <span class="n">INTR_EN_IHD_MASK</span> <span class="o">|</span>
			    <span class="n">INTR_EN_IHD</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr_read_mask</span> <span class="o">=</span>
			    <span class="n">INTR_EN_TYPE_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_INTR_MASK</span> <span class="o">|</span>
			    <span class="n">INTR_EN_TYPE_READ</span> <span class="o">|</span> <span class="n">INTR_EN_IHD_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_IHD</span> <span class="o">|</span>
			    <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* The first vector/queue handles</span>
<span class="cm">				 * broadcast/multicast, fatal errors,</span>
<span class="cm">				 * and firmware events.  This in addition</span>
<span class="cm">				 * to normal inbound NAPI processing.</span>
<span class="cm">				 */</span>
				<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">qlge_isr</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-rx-%d&quot;</span><span class="p">,</span>
					<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Inbound queues handle unicast frames only.</span>
<span class="cm">				 */</span>
				<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">qlge_msix_rx_isr</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-rx-%d&quot;</span><span class="p">,</span>
					<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * All rx_rings use the same intr_context since</span>
<span class="cm">		 * there is only one vector.</span>
<span class="cm">		 */</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">qdev</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We set up each vectors enable/disable/read bits so</span>
<span class="cm">		 * there&#39;s no bit/mask calculations in the critical path.</span>
<span class="cm">		 */</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr_en_mask</span> <span class="o">=</span>
		    <span class="n">INTR_EN_TYPE_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_INTR_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_TYPE_ENABLE</span><span class="p">;</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr_dis_mask</span> <span class="o">=</span>
		    <span class="n">INTR_EN_TYPE_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_INTR_MASK</span> <span class="o">|</span>
		    <span class="n">INTR_EN_TYPE_DISABLE</span><span class="p">;</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">intr_read_mask</span> <span class="o">=</span>
		    <span class="n">INTR_EN_TYPE_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_INTR_MASK</span> <span class="o">|</span> <span class="n">INTR_EN_TYPE_READ</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Single interrupt means one handler for all rings.</span>
<span class="cm">		 */</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">qlge_isr</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-single_irq&quot;</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* Set up this vector&#39;s bit-mask that indicates</span>
<span class="cm">		 * which queues it services. In this case there is</span>
<span class="cm">		 * a single vector so it will service all RSS and</span>
<span class="cm">		 * TX completion rings.</span>
<span class="cm">		 */</span>
		<span class="n">ql_set_irq_mask</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">intr_context</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Tell the TX completion rings which MSIx vector</span>
<span class="cm">	 * they will be using.</span>
<span class="cm">	 */</span>
	<span class="n">ql_set_tx_vect</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">intr_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">hooked</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ql_disable_msix</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_context</span> <span class="o">*</span><span class="n">intr_context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_context</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ql_resolve_queues_to_irqs</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">intr_context</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSIX_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi_x_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vector</span><span class="p">,</span>
					     <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span>
					     <span class="mi">0</span><span class="p">,</span>
					     <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Failed request for MSIX interrupt %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">i</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;trying msi or legacy interrupts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%s: irq = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%s: context-&gt;name = %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				     <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;%s: dev_id = 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">qlge_isr</span><span class="p">,</span>
					<span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span>
						 <span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
					<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>

			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Hooked intr %d, queue type %s, with name %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">i</span><span class="p">,</span>
				  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">DEFAULT_Q</span> <span class="o">?</span>
				  <span class="s">&quot;DEFAULT_Q&quot;</span> <span class="o">:</span>
				  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">TX_Q</span> <span class="o">?</span> <span class="s">&quot;TX_Q&quot;</span> <span class="o">:</span>
				  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">RX_Q</span> <span class="o">?</span> <span class="s">&quot;RX_Q&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				  <span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">intr_context</span><span class="o">-&gt;</span><span class="n">hooked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">err_irq:</span>
	<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to get the interrupts!!!/n&quot;</span><span class="p">);</span>
	<span class="n">ql_free_irq</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_start_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">init_hash_seed</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span>
		<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span>
		<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
		<span class="mh">0x77</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xfa</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ricb</span> <span class="o">*</span><span class="n">ricb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ricb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">hash_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ricb</span><span class="o">-&gt;</span><span class="n">hash_cq_id</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ricb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ricb</span><span class="p">));</span>

	<span class="n">ricb</span><span class="o">-&gt;</span><span class="n">base_cq</span> <span class="o">=</span> <span class="n">RSS_L4K</span><span class="p">;</span>
	<span class="n">ricb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">RSS_L6K</span> <span class="o">|</span> <span class="n">RSS_LI</span> <span class="o">|</span> <span class="n">RSS_LB</span> <span class="o">|</span> <span class="n">RSS_LM</span> <span class="o">|</span> <span class="n">RSS_RT4</span> <span class="o">|</span> <span class="n">RSS_RT6</span><span class="p">);</span>
	<span class="n">ricb</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="mh">0x3ff</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill out the Indirection Table.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ricb</span><span class="o">-&gt;</span><span class="n">ipv6_hash_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_hash_seed</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ricb</span><span class="o">-&gt;</span><span class="n">ipv4_hash_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">init_hash_seed</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_write_cfg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ricb</span><span class="p">),</span> <span class="n">CFG_LR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to load RICB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_clear_routing_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_RT_IDX_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* Clear all the entries in the routing table. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_routing_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to init routing register for CAM packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_RT_IDX_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the frame-to-queue routing. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_route_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear all the entries in the routing table. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_clear_routing_entries</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_RT_IDX_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_routing_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_IP_CSUM_ERR_SLOT</span><span class="p">,</span>
						<span class="n">RT_IDX_IP_CSUM_ERR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			<span class="s">&quot;Failed to init routing register &quot;</span>
			<span class="s">&quot;for IP CSUM error packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_routing_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_TCP_UDP_CSUM_ERR_SLOT</span><span class="p">,</span>
						<span class="n">RT_IDX_TU_CSUM_ERR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			<span class="s">&quot;Failed to init routing register &quot;</span>
			<span class="s">&quot;for TCP/UDP CSUM error packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_routing_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_BCAST_SLOT</span><span class="p">,</span> <span class="n">RT_IDX_BCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to init routing register for broadcast packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If we have more than one inbound queue, then turn on RSS in the</span>
<span class="cm">	 * routing block.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_routing_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_RSS_MATCH_SLOT</span><span class="p">,</span>
					<span class="n">RT_IDX_RSS_MATCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to init routing register for MATCH RSS packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_routing_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_CAM_HIT_SLOT</span><span class="p">,</span>
				    <span class="n">RT_IDX_CAM_HIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to init routing register for CAM packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_RT_IDX_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ql_cam_route_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">set</span><span class="p">;</span>

	<span class="cm">/* If check if the link is up and use to</span>
<span class="cm">	 * determine if we are setting or clearing</span>
<span class="cm">	 * the MAC address in the CAM.</span>
<span class="cm">	 */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
	<span class="n">set</span> <span class="o">&amp;=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_up</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_mac_addr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to init mac address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_route_initialize</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to init routing table.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the System register to halt on errors.</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">SYS_EFE</span> <span class="o">|</span> <span class="n">SYS_FAE</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SYS</span><span class="p">,</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Set the default queue, and VLAN behavior. */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">NIC_RCV_CFG_DFQ</span> <span class="o">|</span> <span class="n">NIC_RCV_CFG_RV</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">NIC_RCV_CFG_DFQ_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">NIC_RCV_CFG_RV</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">NIC_RCV_CFG</span><span class="p">,</span> <span class="p">(</span><span class="n">mask</span> <span class="o">|</span> <span class="n">value</span><span class="p">));</span>

	<span class="cm">/* Set the MPI interrupt to enabled. */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">INTR_MASK</span><span class="p">,</span> <span class="p">(</span><span class="n">INTR_MASK_PI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">INTR_MASK_PI</span><span class="p">);</span>

	<span class="cm">/* Enable the function, set pagesize, enable error checking. */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">FSC_FE</span> <span class="o">|</span> <span class="n">FSC_EPC_INBOUND</span> <span class="o">|</span> <span class="n">FSC_EPC_OUTBOUND</span> <span class="o">|</span>
	    <span class="n">FSC_EC</span> <span class="o">|</span> <span class="n">FSC_VM_PAGE_4K</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">SPLT_SETTING</span><span class="p">;</span>

	<span class="cm">/* Set/clear header splitting. */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">FSC_VM_PAGESIZE_MASK</span> <span class="o">|</span>
	    <span class="n">FSC_DBL_MASK</span> <span class="o">|</span> <span class="n">FSC_DBRST_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">FSC</span><span class="p">,</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SPLT_HDR</span><span class="p">,</span> <span class="n">SPLT_LEN</span><span class="p">);</span>

	<span class="cm">/* Set RX packet routing to use port/pci function on which the</span>
<span class="cm">	 * packet arrived on in addition to usual frame routing.</span>
<span class="cm">	 * This is helpful on bonding where both interfaces can have</span>
<span class="cm">	 * the same MAC address.</span>
<span class="cm">	 */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RST_FO</span><span class="p">,</span> <span class="n">RST_FO_RR_MASK</span> <span class="o">|</span> <span class="n">RST_FO_RR_RCV_FUNC_CQ</span><span class="p">);</span>
	<span class="cm">/* Reroute all packets to our Interface.</span>
<span class="cm">	 * They may have been routed to MPI firmware</span>
<span class="cm">	 * due to WOL.</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MGMT_RCV_CFG</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MGMT_RCV_CFG_RM</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffff0000</span><span class="p">;</span>

	<span class="cm">/* Sticky reg needs clearing due to WOL. */</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MGMT_RCV_CFG</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MGMT_RCV_CFG</span><span class="p">,</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Default WOL is enable on Mezz cards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0068</span> <span class="o">||</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x0180</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>

	<span class="cm">/* Start up the rx queues. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_start_rx_ring</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to start rx ring[%d].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If there is more than one inbound completion queue</span>
<span class="cm">	 * then download a RICB to configure RSS.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_start_rss</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to start RSS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Start up the tx queues. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_start_tx_ring</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to start tx ring[%d].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the port and set the max framesize. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">port_initialize</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to start port.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set up the MAC address and frame routing filter. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_cam_route_initialize</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to init CAM/Routing tables.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start NAPI for the RSS queues. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Issue soft reset to chip. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_jiffies</span><span class="p">;</span>

	<span class="cm">/* Clear all the entries in the routing table. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_clear_routing_entries</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to clear routing bits.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">end_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">max</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">usecs_to_jiffies</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>

	<span class="cm">/* Check if bit is set then skip the mailbox command and</span>
<span class="cm">	 * clear the bit, else we are in normal reset process.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ASIC_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Stop management traffic. */</span>
		<span class="n">ql_mb_set_mgmnt_traffic_ctl</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MB_SET_MPI_TFK_STOP</span><span class="p">);</span>

		<span class="cm">/* Wait for the NIC and MGMNT FIFOs to empty. */</span>
		<span class="n">ql_wait_fifo_empty</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ASIC_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ql_write32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RST_FO</span><span class="p">,</span> <span class="p">(</span><span class="n">RST_FO_FR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">RST_FO_FR</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RST_FO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">RST_FO_FR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_jiffies</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">RST_FO_FR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;ETIMEDOUT!!! errored out of resetting the chip!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Resume management traffic. */</span>
	<span class="n">ql_mb_set_mgmnt_traffic_ctl</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MB_SET_MPI_TFK_RESUME</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_display_dev_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		   <span class="s">&quot;Function #%d, Port %d, NIC Roll %d, NIC Rev = %d, &quot;</span>
		   <span class="s">&quot;XG Roll = %d, XG Rev = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
		   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
		   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">,</span>
		   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">,</span>
		   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">,</span>
		   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="mh">0x0000000f</span><span class="p">);</span>
	<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		   <span class="s">&quot;MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wol</span> <span class="o">=</span> <span class="n">MB_WOL_DISABLE</span><span class="p">;</span>

	<span class="cm">/* The CAM is still intact after a reset, but if we</span>
<span class="cm">	 * are doing WOL, then we may need to program the</span>
<span class="cm">	 * routing regs. We would also need to issue the mailbox</span>
<span class="cm">	 * commands to instruct the MPI what to do per the ethtool</span>
<span class="cm">	 * settings.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKE_ARP</span> <span class="o">|</span> <span class="n">WAKE_MAGICSECURE</span> <span class="o">|</span> <span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_UCAST</span> <span class="o">|</span>
			<span class="n">WAKE_MCAST</span> <span class="o">|</span> <span class="n">WAKE_BCAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Unsupported WOL parameter. qdev-&gt;wol = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">wol</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_mb_wol_set_magic</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to set magic packet on %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Enabled magic packet successfully on %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">wol</span> <span class="o">|=</span> <span class="n">MB_WOL_MAGIC_PKT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">wol</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wol</span> <span class="o">|=</span> <span class="n">MB_WOL_MODE_ON</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_mb_wol_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">wol</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;WOL %s (wol code 0x%x) on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Successfully set&quot;</span> <span class="o">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">,</span>
			  <span class="n">wol</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_cancel_all_work_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Don&#39;t kill the reset worker thread if we</span>
<span class="cm">	 * are in the process of recovery.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">asic_reset_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_reset_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_idc_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_core_to_log</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_port_cfg_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_link_off</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="n">ql_cancel_all_work_sync</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ql_disable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="n">ql_tx_ring_clean</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="cm">/* Call netif_napi_del() from common point.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_adapter_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;reset(func #%d) FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">ql_free_rx_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_adapter_initialize</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Unable to initialize adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ql_alloc_rx_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="cm">/* If the port is initialized and the</span>
<span class="cm">	 * link is up the turn on the carrier.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_init</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_up</span><span class="p">))</span>
		<span class="n">ql_link_on</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="cm">/* Restore rx mode. */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_PROMISCUOUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">qlge_set_multicast_list</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Restore vlan setting. */</span>
	<span class="n">qlge_restore_vlan</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="n">ql_enable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_enable_all_completion_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">netif_tx_start_all_queues</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_init:</span>
	<span class="n">ql_adapter_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_release_adapter_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_free_mem_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_free_irq</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_adapter_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_mem_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Unable to  allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_request_irq</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* If we hit pci_channel_io_perm_failure</span>
<span class="cm">	 * failure condition, then we already</span>
<span class="cm">	 * brought the adapter down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_EEH_FATAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;EEH fatal did unload.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_EEH_FATAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for device to recover from a reset.</span>
<span class="cm">	 * (Rarely happens, but possible.)</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ql_adapter_down</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_release_adapter_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_configure_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">MAX_CPUS</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">num_online_cpus</span><span class="p">());</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lbq_buf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">LARGE_BUFFER_MAX_SIZE</span> <span class="o">:</span> <span class="n">LARGE_BUFFER_MIN_SIZE</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lbq_buf_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">lbq_buf_len</span><span class="p">);</span>

	<span class="cm">/* In a perfect world we have one RSS ring for each CPU</span>
<span class="cm">	 * and each has it&#39;s own vector.  To do that we ask for</span>
<span class="cm">	 * cpu_cnt vectors.  ql_enable_msix() will adjust the</span>
<span class="cm">	 * vector count to what we actually get.  We then</span>
<span class="cm">	 * allocate an RSS ring for each.</span>
<span class="cm">	 * Essentially, we are doing min(cpu_count, msix_vector_count).</span>
<span class="cm">	 */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span> <span class="o">=</span> <span class="n">cpu_cnt</span><span class="p">;</span>
	<span class="n">ql_enable_msix</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="cm">/* Adjust the RSS ring count to the actual vector count. */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">intr_count</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">=</span> <span class="n">cpu_cnt</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">+</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">));</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">qdev</span><span class="p">;</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_size</span> <span class="o">=</span>
		    <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">wq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_iocb_req</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The completion queue ID for the tx rings start</span>
<span class="cm">		 * immediately after the rss rings.</span>
<span class="cm">		 */</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">));</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">qdev</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">cpu_cnt</span><span class="p">;</span>	<span class="cm">/* CPU to run handler on. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Inbound (RSS) queues.</span>
<span class="cm">			 */</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_size</span> <span class="o">=</span>
			    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_net_rsp_iocb</span><span class="p">);</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">=</span> <span class="n">NUM_LARGE_BUFFERS</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_size</span> <span class="o">=</span>
			    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">);</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">lbq_buf_len</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">=</span> <span class="n">NUM_SMALL_BUFFERS</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_size</span> <span class="o">=</span>
			    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">);</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_buf_size</span> <span class="o">=</span> <span class="n">SMALL_BUF_MAP_SIZE</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">RX_Q</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Outbound queue handles outbound completions only.</span>
<span class="cm">			 */</span>
			<span class="cm">/* outbound cq is same size as tx_ring it services. */</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_size</span> <span class="o">=</span>
			    <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">cq_len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_net_rsp_iocb</span><span class="p">);</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">sbq_buf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TX_Q</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_adapter_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_configure_rings</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_get_adapter_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_up</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_adapter_up</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_up</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">error_up:</span>
	<span class="n">ql_release_adapter_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_change_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lbq_buf_len</span><span class="p">;</span>

	<span class="cm">/* Wait for an outstanding reset to complete. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Waiting for adapter UP...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Timed out waiting for adapter UP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_adapter_down</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Get the new rx buffer size. */</span>
	<span class="n">lbq_buf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">LARGE_BUFFER_MAX_SIZE</span> <span class="o">:</span> <span class="n">LARGE_BUFFER_MIN_SIZE</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lbq_buf_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">lbq_buf_len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="cm">/* Set the new size. */</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">lbq_buf_size</span> <span class="o">=</span> <span class="n">lbq_buf_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_adapter_up</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">netif_alert</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="s">&quot;Driver up/down cycle failed, closing device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_close</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">==</span> <span class="mi">1500</span> <span class="o">&amp;&amp;</span> <span class="n">new_mtu</span> <span class="o">==</span> <span class="mi">9000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Changing to jumbo MTU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">==</span> <span class="mi">9000</span> <span class="o">&amp;&amp;</span> <span class="n">new_mtu</span> <span class="o">==</span> <span class="mi">1500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Changing to normal MTU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_port_cfg_work</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_change_rx_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Changing MTU failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">qlge_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span>
					       <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pkts</span><span class="p">,</span> <span class="n">mcast</span><span class="p">,</span> <span class="n">dropped</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Get RX stats. */</span>
	<span class="n">pkts</span> <span class="o">=</span> <span class="n">mcast</span> <span class="o">=</span> <span class="n">dropped</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkts</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>
			<span class="n">dropped</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="p">;</span>
			<span class="n">errors</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="p">;</span>
			<span class="n">mcast</span> <span class="o">+=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">rx_multicast</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">pkts</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">dropped</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">mcast</span><span class="p">;</span>

	<span class="cm">/* Get TX stats. */</span>
	<span class="n">pkts</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pkts</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
			<span class="n">bytes</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>
			<span class="n">errors</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">pkts</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">errors</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlge_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_RT_IDX_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set or clear promiscuous mode if a</span>
<span class="cm">	 * transition is taking place.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_PROMISCUOUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_set_routing_reg</span>
			    <span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_PROMISCUOUS_SLOT</span><span class="p">,</span> <span class="n">RT_IDX_VALID</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Failed to set promiscuous mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_PROMISCUOUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_PROMISCUOUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_set_routing_reg</span>
			    <span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_PROMISCUOUS_SLOT</span><span class="p">,</span> <span class="n">RT_IDX_VALID</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Failed to clear promiscuous mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_PROMISCUOUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set or clear all multicast mode if a</span>
<span class="cm">	 * transition is taking place.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_MULTICAST_ENTRIES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_set_routing_reg</span>
			    <span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_ALLMULTI_SLOT</span><span class="p">,</span> <span class="n">RT_IDX_MCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Failed to set all-multi mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_set_routing_reg</span>
			    <span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_ALLMULTI_SLOT</span><span class="p">,</span> <span class="n">RT_IDX_MCAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Failed to clear all-multi mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_set_mac_addr_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">MAC_ADDR_TYPE_MULTI_MAC</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					  <span class="s">&quot;Failed to loadmulticast address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_set_routing_reg</span>
		    <span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">RT_IDX_MCAST_MATCH_SLOT</span><span class="p">,</span> <span class="n">RT_IDX_MCAST_MATCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to set multicast match mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_RT_IDX_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="cm">/* Update local copy of current mac address. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_mac_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_set_mac_addr_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
			<span class="n">MAC_ADDR_TYPE_CAM_MAC</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">*</span> <span class="n">MAX_CQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to load MAC address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">SEM_MAC_ADDR_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlge_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ql_queue_asic_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_asic_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ql_adapter</span><span class="p">,</span> <span class="n">asic_reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_adapter_down</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_adapter_up</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Restore rx mode. */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ALLMULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_PROMISCUOUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">qlge_set_multicast_list</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">netif_alert</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="s">&quot;Driver up/down cycle failed, closing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_close</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nic_operations</span> <span class="n">qla8012_nic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_flash</span>		<span class="o">=</span> <span class="n">ql_get_8012_flash_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_initialize</span>	<span class="o">=</span> <span class="n">ql_8012_port_initialize</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">nic_operations</span> <span class="n">qla8000_nic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_flash</span>		<span class="o">=</span> <span class="n">ql_get_8000_flash_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_initialize</span>	<span class="o">=</span> <span class="n">ql_8000_port_initialize</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Find the pcie function number for the other NIC</span>
<span class="cm"> * on this chip.  Since both NIC functions share a</span>
<span class="cm"> * common firmware we have the lowest enabled function</span>
<span class="cm"> * do any common work.  Examples would be resetting</span>
<span class="cm"> * after a fatal firmware error, or doing a firmware</span>
<span class="cm"> * coredump.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_alt_pcie_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nic_func1</span><span class="p">,</span> <span class="n">nic_func2</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_read_mpi_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">MPI_TEST_FUNC_PORT_CFG</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nic_func1</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_TEST_NIC1_FUNC_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">MPI_TEST_NIC_FUNC_MASK</span><span class="p">);</span>
	<span class="n">nic_func2</span> <span class="o">=</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_TEST_NIC2_FUNC_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">MPI_TEST_NIC_FUNC_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="n">nic_func1</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">alt_func</span> <span class="o">=</span> <span class="n">nic_func2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="n">nic_func2</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">alt_func</span> <span class="o">=</span> <span class="n">nic_func1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_board_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STS_FUNC_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">STS_FUNC_ID_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_get_alt_pcie_func</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">alt_func</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">xg_sem_mask</span> <span class="o">=</span> <span class="n">SEM_XGMAC1_MASK</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_up</span> <span class="o">=</span> <span class="n">STS_PL1</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_init</span> <span class="o">=</span> <span class="n">STS_PI1</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mailbox_in</span> <span class="o">=</span> <span class="n">PROC_ADDR_MPI_RISC</span> <span class="o">|</span> <span class="n">PROC_ADDR_FUNC2_MBI</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mailbox_out</span> <span class="o">=</span> <span class="n">PROC_ADDR_MPI_RISC</span> <span class="o">|</span> <span class="n">PROC_ADDR_FUNC2_MBO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">xg_sem_mask</span> <span class="o">=</span> <span class="n">SEM_XGMAC0_MASK</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_up</span> <span class="o">=</span> <span class="n">STS_PL0</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_init</span> <span class="o">=</span> <span class="n">STS_PI0</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mailbox_in</span> <span class="o">=</span> <span class="n">PROC_ADDR_MPI_RISC</span> <span class="o">|</span> <span class="n">PROC_ADDR_FUNC0_MBI</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mailbox_out</span> <span class="o">=</span> <span class="n">PROC_ADDR_MPI_RISC</span> <span class="o">|</span> <span class="n">PROC_ADDR_FUNC0_MBO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">REV_ID</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QLGE_DEVICE_ID_8012</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nic_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla8012_nic_ops</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QLGE_DEVICE_ID_8000</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nic_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qla8000_nic_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_release_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_coredump</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ql_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cards_found</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qdev</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI device enable failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Set PCIe read request size */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pcie_set_readrq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set readrq failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI region request failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_DMA64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		       <span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No usable DMA configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set PCIe reset type for EEH to fundamental. */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">needs_freset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">=</span>
	    <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Register mapping failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area</span> <span class="o">=</span>
	    <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
			    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">doorbell_area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Doorbell register mapping failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_get_board_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Register access failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">default_msg</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlge_mpi_coredump</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_coredump</span> <span class="o">=</span>
			<span class="n">vmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_mpi_coredump</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_coredump</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Coredump alloc failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlge_force_coredump</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_FRC_COREDUMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* make sure the EEPROM is good */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">get_flash</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid FLASH.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="cm">/* Keep local copy of current mac address. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_mac_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* Set up the default ring sizes. */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span> <span class="o">=</span> <span class="n">NUM_TX_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring_size</span> <span class="o">=</span> <span class="n">NUM_RX_RING_ENTRIES</span><span class="p">;</span>

	<span class="cm">/* Set up the coalescing parameters. */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_coalesce_usecs</span> <span class="o">=</span> <span class="n">DFLT_COALESCE_WAIT</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_coalesce_usecs</span> <span class="o">=</span> <span class="n">DFLT_COALESCE_WAIT</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">DFLT_INTER_FRAME_WAIT</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_max_coalesced_frames</span> <span class="o">=</span> <span class="n">DFLT_INTER_FRAME_WAIT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the operating parameters.</span>
<span class="cm">	 */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">asic_reset_work</span><span class="p">,</span> <span class="n">ql_asic_reset_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_reset_work</span><span class="p">,</span> <span class="n">ql_mpi_reset_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_work</span><span class="p">,</span> <span class="n">ql_mpi_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_port_cfg_work</span><span class="p">,</span> <span class="n">ql_mpi_port_cfg_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_idc_work</span><span class="p">,</span> <span class="n">ql_mpi_idc_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_core_to_log</span><span class="p">,</span> <span class="n">ql_mpi_core_to_log</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ide_completion</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mpi_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cards_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_STRING</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Driver name: %s, Version: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_out2:</span>
	<span class="n">ql_release_all</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out1:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">qlge_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">qlge_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">qlge_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">qlge_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">qlge_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">qlge_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">qlge_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">qlge_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">qlge_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">qlge_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">qlge_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">qlge_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">qlge_vlan_rx_kill_vid</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">var</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">var</span> <span class="o">=</span> <span class="n">ql_read32</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;EEH STS = 0x%.08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qlge_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev_mq</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_adapter</span><span class="p">),</span>
			<span class="n">min</span><span class="p">(</span><span class="n">MAX_CPUS</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">num_online_cpus</span><span class="p">()));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_init_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="n">cards_found</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span> <span class="o">|</span> <span class="n">NETIF_F_TSO_ECN</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_DMA64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up net_device structure.</span>
<span class="cm">	 */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_ring_size</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlge_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qlge_ethtool_ops</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;net device registration failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_release_all</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start up the timer to trigger EEH if</span>
<span class="cm">	 * the bus goes dead</span>
<span class="cm">	 */</span>
	<span class="n">init_timer_deferrable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">qdev</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ql_timer</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ql_link_off</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_display_dev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lb_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">netdev_tx_t</span> <span class="nf">ql_lb_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">qlge_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ql_clean_lb_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_ring</span> <span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ql_clean_inbound_rx_ring</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">qlge_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ql_cancel_all_work_sync</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">ql_release_all</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clean up resources without touching hardware. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_eeh_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disabling the timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">ql_cancel_all_work_sync</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rss_ring_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ql_tx_ring_clean</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_free_rx_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_release_adapter_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This callback is called by the PCI subsystem whenever</span>
<span class="cm"> * a PCI bus error is detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">qlge_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">pci_channel_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pci_channel_io_normal</span>:
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_CAN_RECOVER</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_frozen</span>:
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
			<span class="n">ql_eeh_close</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pci_channel_io_perm_failure</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: pci_channel_io_perm_failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ql_eeh_close</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_EEH_FATAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request a slot reset. */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This callback is called after the PCI buss has been reset.</span>
<span class="cm"> * Basically, this tries to restart the card from scratch.</span>
<span class="cm"> * This is a shortened version of the device probe/discovery code,</span>
<span class="cm"> * it resembles the first-half of the () routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">qlge_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">=</span> <span class="n">pci_channel_io_normal</span><span class="p">;</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Cannot re-enable PCI device after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_adapter_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;reset FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_EEH_FATAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlge_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlge_open</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				  <span class="s">&quot;Device initialization failed after reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			  <span class="s">&quot;Device was not running prior to EEH.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">qlge_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">qlge_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">qlge_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qlge_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ql_adapter_down</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_wol</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlge_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device from suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ql_adapter_up</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlge_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qlge_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PMSG_SUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">qlge_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">qlge_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">qlge_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">qlge_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">qlge_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qlge_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">qlge_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlge_err_handler</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qlge_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlge_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qlge_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlge_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qlge_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">qlge_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
