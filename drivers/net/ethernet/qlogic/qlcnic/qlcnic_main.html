<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › qlogic › qlcnic › qlcnic_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>qlcnic_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic qlcnic NIC Driver</span>
<span class="cm"> * Copyright (c)  2009-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qlcnic for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;qlcnic.h&quot;</span>

<span class="cp">#include &lt;linux/swab.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QLogic 1/10 GbE Converged/Intelligent Ethernet Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">QLCNIC_LINUX_VERSIONID</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">QLCNIC_UNIFIED_ROMIMAGE_NAME</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">qlcnic_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;qlcnic&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">qlcnic_driver_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;QLogic 1/10 GbE &quot;</span>
	<span class="s">&quot;Converged/Intelligent Ethernet Driver v&quot;</span> <span class="n">QLCNIC_LINUX_VERSIONID</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">qlcnic_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_mac_learn</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlcnic_mac_learn</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlcnic_mac_learn</span><span class="p">,</span> <span class="s">&quot;Mac Filter (0=disabled, 1=enabled)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_msi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_msi</span><span class="p">,</span> <span class="s">&quot;MSI interrupt (0=disabled, 1=enabled&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_msi_x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_msi_x</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_msi_x</span><span class="p">,</span> <span class="s">&quot;MSI-X interrupt (0=disabled, 1=enabled&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">auto_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_fw_reset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">auto_fw_reset</span><span class="p">,</span> <span class="s">&quot;Auto firmware reset (0=disabled, 1=enabled&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">load_fw_file</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">load_fw_file</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">load_fw_file</span><span class="p">,</span> <span class="s">&quot;Load firmware from (0=flash, 1=file&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_config_npars</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qlcnic_config_npars</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qlcnic_config_npars</span><span class="p">,</span> <span class="s">&quot;Configure NPARs (0=disabled, 1=enabled&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">qlcnic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">qlcnic_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_attach_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_fwinit_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_fw_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">work_func_t</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_cancel_fw_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_rx_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_create_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_remove_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_create_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_remove_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_idc_debug_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">encoding</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_can_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qlcnic_tmp_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qlcnic_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qlcnic_msi_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">qlcnic_msix_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">qlcnic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_free_lb_filters_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_dev_set_npar_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnicvf_config_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnicvf_config_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnicvf_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">qlcnic_set_netdev_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_vlan_rx_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qlcnic_vlan_rx_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>

<span class="cm">/*  PCI Device ID Table  */</span>
<span class="cp">#define ENTRY(device) \</span>
<span class="cp">	{PCI_DEVICE(PCI_VENDOR_ID_QLOGIC, (device)), \</span>
<span class="cp">	.class = PCI_CLASS_NETWORK_ETHERNET &lt;&lt; 8, .class_mask = ~0}</span>

<span class="cp">#define PCI_DEVICE_ID_QLOGIC_QLE824X  0x8020</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">qlcnic_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_QLOGIC_QLE824X</span><span class="p">),</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">qlcnic_pci_tbl</span><span class="p">);</span>


<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qlcnic_update_cmd_producer</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">crb_cmd_producer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">msi_tgt_status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ISR_INT_TARGET_STATUS</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F1</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F2</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F3</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F4</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F5</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F6</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F7</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span>
<span class="k">struct</span> <span class="n">qlcnic_legacy_intr_set</span> <span class="n">legacy_intr</span><span class="p">[]</span> <span class="o">=</span> <span class="n">QLCNIC_LEGACY_INTR_CONFIG</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlcnic_disable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">crb_intr_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">qlcnic_enable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">crb_intr_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLCNIC_IS_MSI_FAMILY</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xfbff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_alloc_sds_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_free_sds_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">);</span>

	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_napi_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_alloc_sds_rings</span><span class="p">(</span><span class="n">recv_ctx</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">qlcnic_poll</span><span class="p">,</span>
				<span class="n">QLCNIC_NETDEV_WEIGHT</span><span class="o">/</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span>
				<span class="n">qlcnic_rx_poll</span><span class="p">,</span> <span class="n">QLCNIC_NETDEV_WEIGHT</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_napi_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qlcnic_free_sds_rings</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_napi_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">qlcnic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_napi_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">qlcnic_disable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
		<span class="n">napi_synchronize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_set_msix_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_init_msix_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_read_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_get_mac_address</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* set station address */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Bad MAC address %pM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MAC_OVERRIDE_DISABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">qlcnic_napi_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">qlcnic_set_multi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">qlcnic_napi_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">qlcnic_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	   <span class="o">=</span> <span class="n">qlcnic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	   <span class="o">=</span> <span class="n">qlcnic_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>    <span class="o">=</span> <span class="n">qlcnic_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>	   <span class="o">=</span> <span class="n">qlcnic_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span> <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>   <span class="o">=</span> <span class="n">qlcnic_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">qlcnic_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>	   <span class="o">=</span> <span class="n">qlcnic_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>  <span class="o">=</span> <span class="n">qlcnic_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>  <span class="o">=</span> <span class="n">qlcnic_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>	   <span class="o">=</span> <span class="n">qlcnic_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">qlcnic_vlan_rx_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">qlcnic_vlan_rx_del</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span> <span class="o">=</span> <span class="n">qlcnic_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">qlcnic_netdev_failed_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	   <span class="o">=</span> <span class="n">qlcnic_open</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qlcnic_nic_template</span> <span class="n">qlcnic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">config_bridged_mode</span> <span class="o">=</span> <span class="n">qlcnic_config_bridged_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_led</span> <span class="o">=</span> <span class="n">qlcnic_config_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_firmware</span> <span class="o">=</span> <span class="n">qlcnic_start_firmware</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qlcnic_nic_template</span> <span class="n">qlcnic_vf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">config_bridged_mode</span> <span class="o">=</span> <span class="n">qlcnicvf_config_bridged_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config_led</span> <span class="o">=</span> <span class="n">qlcnicvf_config_led</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_firmware</span> <span class="o">=</span> <span class="n">qlcnicvf_start_firmware</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_enable_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_msix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QLCNIC_MSI_ENABLED</span> <span class="o">|</span> <span class="n">QLCNIC_MSIX_ENABLED</span><span class="p">);</span>
	<span class="n">qlcnic_set_msix_bit</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span><span class="p">)</span> <span class="p">{</span>
 <span class="nl">enable_msix:</span>
		<span class="n">qlcnic_init_msix_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_MSIX_ENABLED</span><span class="p">;</span>
			<span class="n">qlcnic_set_msix_bit</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">=</span> <span class="n">num_msix</span><span class="p">;</span>

			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using msi-x interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_msix</span> <span class="o">=</span> <span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num_msix</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">enable_msix</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_enable_msi_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">qlcnic_legacy_intr_set</span> <span class="o">*</span><span class="n">legacy_intrp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_msi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_MSI_ENABLED</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span> <span class="o">=</span> <span class="n">qlcnic_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">msi_tgt_status</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">]);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using msi interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">legacy_intrp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">legacy_intr</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">];</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span> <span class="o">=</span> <span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span> <span class="o">=</span> <span class="n">qlcnic_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span> <span class="o">=</span> <span class="n">qlcnic_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span> <span class="o">=</span> <span class="n">qlcnic_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span> <span class="o">=</span> <span class="n">qlcnic_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">ISR_INT_STATE_REG</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using legacy interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_setup_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_msix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_msix</span> <span class="o">=</span> <span class="n">rounddown_pow_of_two</span><span class="p">(</span><span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">num_online_cpus</span><span class="p">(),</span>
				<span class="n">QLCNIC_DEF_NUM_STS_DESC_RINGS</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">num_msix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qlcnic_enable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qlcnic_enable_msi_legacy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_teardown_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MSIX_ENABLED</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MSI_ENABLED</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_cleanup_pci_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_init_pci_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_pci_info</span> <span class="o">*</span><span class="n">pci_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pfn</span><span class="p">;</span>

	<span class="n">pci_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pci_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_npar_info</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pci_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_eswitch</span><span class="p">)</span> <span class="o">*</span>
				<span class="n">QLCNIC_NIU_MAX_XG_PORTS</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_npars</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_pci_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pci_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_eswitch</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_eswitch</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pfn</span><span class="p">].</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pfn</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pfn</span><span class="p">].</span><span class="n">phy_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_port</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pfn</span><span class="p">].</span><span class="n">min_bw</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_min_bw</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pfn</span><span class="p">].</span><span class="n">max_bw</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_max_bw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_NIU_MAX_XG_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_SWITCH_ENABLE</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pci_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_eswitch:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_npars:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_pci_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pci_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_set_function_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ref_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">priv_op</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">QLCNIC_DRV_OP_MODE</span><span class="p">;</span>

	<span class="cm">/* If other drivers are not in use set their privilege level */</span>
	<span class="n">ref_count</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_config_npars</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span> <span class="o">||</span>
				<span class="n">id</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">qlcnic_config_npars</span> <span class="o">&amp;</span>
					<span class="n">QLC_DEV_SET_DRV</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv_op</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">QLC_DEV_SET_DRV</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">))</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">QLC_DEV_SET_DRV</span><span class="p">(</span><span class="n">QLCNIC_MGMT_FUNC</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">priv_op</span><span class="p">);</span>
	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_lock:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_check_vf</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msix_base_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">priv_op</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msix_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op_mode</span><span class="p">,</span> <span class="n">priv_level</span><span class="p">;</span>

	<span class="cm">/* Determine FW API version */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_hal_version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span>
					<span class="n">QLCNIC_FW_API</span><span class="p">);</span>

	<span class="cm">/* Find PCI function number */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">QLCNIC_MSIX_TABLE_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">msix_base_addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">QLCNIC_MSIX_BASE</span><span class="p">;</span>
	<span class="n">msix_base</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">msix_base_addr</span><span class="p">);</span>
	<span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span> <span class="o">-</span> <span class="n">msix_base</span><span class="p">)</span><span class="o">/</span><span class="n">QLCNIC_MSIX_TBL_PGSIZE</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>

	<span class="cm">/* Determine function privilege level */</span>
	<span class="n">priv_op</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">QLCNIC_DRV_OP_MODE</span><span class="p">;</span>
	<span class="n">op_mode</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLC_DEV_DRV_DEFAULT</span><span class="p">)</span>
		<span class="n">priv_level</span> <span class="o">=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv_level</span> <span class="o">=</span> <span class="n">QLC_DEV_GET_DRV</span><span class="p">(</span><span class="n">op_mode</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv_level</span> <span class="o">==</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;HAL Version: %d Non Privileged function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_hal_version</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlcnic_vf_ops</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlcnic_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_setup_pci_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_ptr0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_len</span><span class="p">,</span> <span class="n">pci_len0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* remap phys address */</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 0 is for BAR 0 */</span>
	<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_len</span> <span class="o">==</span> <span class="n">QLCNIC_PCI_2MB_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mem_ptr0</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map PCI bar 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_len0</span> <span class="o">=</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%dMB memory map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">mem_len</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">));</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">=</span> <span class="n">mem_ptr0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_len0</span> <span class="o">=</span> <span class="n">pci_len0</span><span class="p">;</span>

	<span class="n">qlcnic_check_vf</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">ocm_win_crb</span> <span class="o">=</span> <span class="n">qlcnic_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">QLCNIC_PCIX_PS_REG</span><span class="p">(</span><span class="n">PCIX_OCM_WINDOW_REG</span><span class="p">(</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">)));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_brd_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_SUPPORTED_BOARDS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">&amp;&amp;</span>
			<span class="n">qlcnic_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span>
			<span class="n">qlcnic_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sub_vendor</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">&amp;&amp;</span>
			<span class="n">qlcnic_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sub_device</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%pM: %s&quot;</span> <span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span>
					<span class="n">qlcnic_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">short_name</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%pM Gigabit Ethernet&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_check_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">,</span> <span class="n">prev_fw_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_fw_dump</span> <span class="o">*</span><span class="n">fw_dump</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">;</span>

	<span class="n">prev_fw_version</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">;</span>

	<span class="n">fw_major</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_FW_VERSION_MAJOR</span><span class="p">);</span>
	<span class="n">fw_minor</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_FW_VERSION_MINOR</span><span class="p">);</span>
	<span class="n">fw_build</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_FW_VERSION_SUB</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">=</span> <span class="n">QLCNIC_VERSION_CODE</span><span class="p">(</span><span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">tmpl_hdr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&gt;</span> <span class="n">prev_fw_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">tmpl_hdr</span><span class="p">)</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">fw_dump</span><span class="o">-&gt;</span><span class="n">tmpl_hdr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qlcnic_fw_cmd_get_minidump_temp</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Supports FW dump capability</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware v%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">QLCNIC_XGBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">=</span> <span class="n">DEFAULT_RCV_DESCRIPTORS_VF</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rxd</span> <span class="o">=</span> <span class="n">MAX_RCV_DESCRIPTORS_VF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">=</span> <span class="n">DEFAULT_RCV_DESCRIPTORS_10G</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rxd</span> <span class="o">=</span> <span class="n">MAX_RCV_DESCRIPTORS_10G</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_jumbo_rxd</span> <span class="o">=</span> <span class="n">MAX_JUMBO_RCV_DESCRIPTORS_10G</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_jumbo_rxd</span> <span class="o">=</span> <span class="n">MAX_JUMBO_RCV_DESCRIPTORS_10G</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">QLCNIC_GBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">=</span> <span class="n">DEFAULT_RCV_DESCRIPTORS_1G</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_jumbo_rxd</span> <span class="o">=</span> <span class="n">MAX_JUMBO_RCV_DESCRIPTORS_1G</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_jumbo_rxd</span> <span class="o">=</span> <span class="n">MAX_JUMBO_RCV_DESCRIPTORS_1G</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rxd</span> <span class="o">=</span> <span class="n">MAX_RCV_DESCRIPTORS_1G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="n">use_msi_x</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_txd</span> <span class="o">=</span> <span class="n">MAX_CMD_DESCRIPTORS</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span> <span class="o">=</span> <span class="n">MAX_RDS_RINGS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_initialize_nic</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="n">nic_info</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_get_nic_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_info</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">nic_info</span><span class="p">.</span><span class="n">phys_port</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">switch_mode</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">switch_mode</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_tx_ques</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_tx_ques</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_rx_ques</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">capabilities</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mac_filters</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_mac_filters</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_set_vlan_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">discard_tagged</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLCNIC_TAGGING_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_TAGGING_ENABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">vlan_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_vlan_rx_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_vlan_rx_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_DOWN</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_set_eswitch_port_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">QLCNIC_MACSPOOF</span> <span class="o">|</span> <span class="n">QLCNIC_MAC_OVERRIDE_DISABLED</span> <span class="o">|</span>
				<span class="n">QLCNIC_PROMISC_DISABLED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">mac_anti_spoof</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_MACSPOOF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">mac_override</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_MAC_OVERRIDE_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">promisc_mode</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_PROMISC_DISABLED</span><span class="p">;</span>

	<span class="n">qlcnic_set_netdev_features</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">esw_cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_set_eswitch_port_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="n">esw_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">qlcnic_set_vlan_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">);</span>
	<span class="n">qlcnic_set_eswitch_port_features</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_set_netdev_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">,</span> <span class="n">vlan_features</span><span class="p">;</span>

	<span class="n">features</span> <span class="o">=</span> <span class="p">(</span><span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span>
			<span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_GRO</span><span class="p">);</span>
	<span class="n">vlan_features</span> <span class="o">=</span> <span class="p">(</span><span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
			<span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_TSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span><span class="p">);</span>
		<span class="n">vlan_features</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">features</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">))</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_TSO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">))</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_TSO6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">features</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">vlan_features</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_check_eswitch_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">priv_op</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op_mode</span><span class="p">,</span> <span class="n">priv_level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_initialize_nic</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ADAPTER_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv_op</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">QLCNIC_DRV_OP_MODE</span><span class="p">;</span>
	<span class="n">op_mode</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">priv_op</span><span class="p">);</span>
	<span class="n">priv_level</span> <span class="o">=</span> <span class="n">QLC_DEV_GET_DRV</span><span class="p">(</span><span class="n">op_mode</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLC_DEV_DRV_DEFAULT</span><span class="p">)</span>
		<span class="n">priv_level</span> <span class="o">=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv_level</span> <span class="o">=</span> <span class="n">QLC_DEV_GET_DRV</span><span class="p">(</span><span class="n">op_mode</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv_level</span> <span class="o">==</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_init_pci_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="cm">/* Set privilege level for other functions */</span>
			<span class="n">qlcnic_set_function_modes</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;HAL Version: %d, Management function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_hal_version</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv_level</span> <span class="o">==</span> <span class="n">QLCNIC_PRIV_FUNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">QLCNIC_PRIV_FUNC</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;HAL Version: %d, Privileged function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_hal_version</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_ADAPTER_INITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_set_default_offload_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="n">esw_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_npar_info</span> <span class="o">*</span><span class="n">npar</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span><span class="p">));</span>
		<span class="n">esw_cfg</span><span class="p">.</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">esw_cfg</span><span class="p">.</span><span class="n">offload_flags</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">esw_cfg</span><span class="p">.</span><span class="n">mac_override</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">esw_cfg</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span>  <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_TSO</span><span class="p">)</span>
			<span class="n">esw_cfg</span><span class="p">.</span><span class="n">offload_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_config_switch_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">npar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">npar</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">.</span><span class="n">vlan_id</span><span class="p">;</span>
		<span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac_override</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">.</span><span class="n">mac_override</span><span class="p">;</span>
		<span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac_anti_spoof</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">.</span><span class="n">mac_anti_spoof</span><span class="p">;</span>
		<span class="n">npar</span><span class="o">-&gt;</span><span class="n">discard_tagged</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">.</span><span class="n">discard_tagged</span><span class="p">;</span>
		<span class="n">npar</span><span class="o">-&gt;</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">.</span><span class="n">promisc_mode</span><span class="p">;</span>
		<span class="n">npar</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">.</span><span class="n">offload_flags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_reset_eswitch_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qlcnic_npar_info</span> <span class="o">*</span><span class="n">npar</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pci_func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="n">esw_cfg</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">QLCNIC_PORT_DEFAULTS</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">pvid</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">mac_override</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac_override</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">discard_tagged</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">discard_tagged</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">mac_anti_spoof</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac_anti_spoof</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">offload_flags</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">offload_flags</span><span class="p">;</span>
	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">promisc_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_config_switch_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">esw_cfg</span><span class="p">.</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">QLCNIC_ADD_VLAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_config_switch_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_reset_npar_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_npar_info</span> <span class="o">*</span><span class="n">npar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="n">nic_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set the NPAR config data after FW reset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">npar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_get_nic_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_info</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">nic_info</span><span class="p">.</span><span class="n">min_tx_bw</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">min_bw</span><span class="p">;</span>
		<span class="n">nic_info</span><span class="p">.</span><span class="n">max_tx_bw</span> <span class="o">=</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">max_bw</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_set_nic_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">enable_pm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_config_port_mirroring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
							<span class="n">npar</span><span class="o">-&gt;</span><span class="n">dest_npar</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_reset_eswitch_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">npar</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_check_npar_opertional</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">npar_opt_timeo</span> <span class="o">=</span> <span class="n">QLCNIC_DEV_NPAR_OPER_TIMEO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">npar_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">npar_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">npar_state</span> <span class="o">!=</span> <span class="n">QLCNIC_DEV_NPAR_OPER</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">npar_opt_timeo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">npar_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npar_opt_timeo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Waiting for NPAR state to opertional timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_set_mgmt_operations</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_set_default_offload_settings</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_reset_npar_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">qlcnic_dev_set_npar_ready</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_can_start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_fw_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load_fw_file</span><span class="p">)</span>
		<span class="n">qlcnic_request_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_check_flash_fw_ver</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">=</span> <span class="n">QLCNIC_FLASH_ROMIMAGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_need_fw_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">check_fw_status</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_pinit_from_rom</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_load_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">qlcnic_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_DRIVER_VERSION</span><span class="p">,</span> <span class="n">QLCNIC_DRIVER_VERSION</span><span class="p">);</span>

<span class="nl">check_fw_status:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_check_fw_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_READY</span><span class="p">);</span>
	<span class="n">qlcnic_idc_debug_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_check_eswitch_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Memory allocation failed for eswitch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_set_mgmt_operations</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">qlcnic_check_options</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qlcnic_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_FAILED</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device state set to failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qlcnic_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ring</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_test</span> <span class="o">==</span> <span class="n">QLCNIC_INTERRUPT_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">qlcnic_tmp_intr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QLCNIC_IS_MSI_FAMILY</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MSIX_ENABLED</span><span class="p">)</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">qlcnic_msix_intr</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MSI_ENABLED</span><span class="p">)</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">qlcnic_msi_intr</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
			<span class="n">handler</span> <span class="o">=</span> <span class="n">qlcnic_intr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s[%d]&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
				  <span class="n">flags</span><span class="p">,</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sds_ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__qlcnic_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_rds_ring</span> <span class="o">*</span><span class="n">rds_ring</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_set_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_fw_create_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">qlcnic_post_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qlcnic_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">qlcnic_fw_cmd_set_mtu</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">qlcnic_config_rss</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">qlcnic_config_intr_coalesce</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span>
		<span class="n">qlcnic_config_hw_lro</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_LRO_ENABLED</span><span class="p">);</span>

	<span class="n">qlcnic_napi_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_linkevent_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_context</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Usage: During resume and firmware recovery module.*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__qlcnic_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_free_mac_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fnum</span><span class="p">)</span>
		<span class="n">qlcnic_delete_lb_filters</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_nic_set_promisc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_NIU_NON_PROMISC_MODE</span><span class="p">);</span>

	<span class="n">qlcnic_napi_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_fw_destroy_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_reset_rx_buffers_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_release_tx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Usage: During suspend and firmware recovery module */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">__qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">==</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_napi_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_alloc_sw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error in setting sw resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_napi_del</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_alloc_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error in setting hw resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_sw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to setup interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qlcnic_create_sysfs_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">=</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_hw:</span>
	<span class="n">qlcnic_free_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_out_free_sw:</span>
	<span class="n">qlcnic_free_sw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_out_napi_del:</span>
	<span class="n">qlcnic_napi_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qlcnic_remove_sysfs_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_free_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_release_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_napi_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_free_sw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlcnic_diag_free_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sds_rings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_test</span> <span class="o">==</span> <span class="n">QLCNIC_INTERRUPT_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
			<span class="n">qlcnic_disable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qlcnic_fw_destroy_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">=</span> <span class="n">max_sds_rings</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">__qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_alloc_adapter_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hardware_context</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate recv ctx resources for adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_recv_context</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate recv ctx resources for adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize interrupt coalesce parameters */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">QLCNIC_INTR_DEFAULT</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">rx_time_us</span> <span class="o">=</span> <span class="n">QLCNIC_DEFAULT_INTR_COALESCE_RX_TIME_US</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">QLCNIC_DEFAULT_INTR_COALESCE_RX_PACKETS</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_free_adapter_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_diag_alloc_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_rds_ring</span> <span class="o">*</span><span class="n">rds_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">__qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_fw_create_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">qlcnic_post_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_test</span> <span class="o">==</span> <span class="n">QLCNIC_INTERRUPT_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
			<span class="n">qlcnic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_test</span> <span class="o">==</span> <span class="n">QLCNIC_LOOPBACK_TEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">loopback_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qlcnic_linkevent_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset context in hardware only */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_reset_hw_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qlcnic_reset_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">==</span> <span class="n">QLCNIC_ADAPTER_UP_MAGIC</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">__qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

		<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
				<span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_setup_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pci_using_dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_count</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	   <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlcnic_netdev_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>     <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="n">qlcnic_change_mtu</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qlcnic_ethtool_ops</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_TSO</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_FVLANTX</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_HW_LRO</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_RX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_set_dma_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pci_using_dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to set DMA mask, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_alloc_msix_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msix_entry</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed allocating msix_entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">qlcnic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">revision_id</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">pci_using_dac</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">brd_name</span><span class="p">[</span><span class="n">QLCNIC_MAX_BOARD_NAME_LEN</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_using_dac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">qlcnic_driver_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span>  <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span>    <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_alloc_adapter_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_rst_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">revision_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">=</span> <span class="n">revision_id</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_learn</span> <span class="o">=</span> <span class="n">qlcnic_mac_learn</span><span class="p">;</span>

	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">crb_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_setup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_hw</span><span class="p">;</span>

	<span class="cm">/* This will be reset for mezz cards  */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_get_board_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error getting board config info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_setup_idc_param</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_NEED_FLR</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Loading fw failed. Please Reboot</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t\t</span><span class="s">If reboot doesn&#39;t help, try flashing the card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_maintenance_mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_read_mac_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read mac addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_brd_name</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">brd_name</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s Board Chip rev 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">module_name</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">),</span>
				<span class="n">brd_name</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">revision_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">qlcnic_clear_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_alloc_msix_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_decr_ref</span><span class="p">;</span>

	<span class="n">qlcnic_setup_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_setup_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">pci_using_dac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable_msi</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">port_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLCNIC_GBE</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: GbE port initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLCNIC_XGBE</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: XGbE port initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_learn</span><span class="p">)</span>
		<span class="n">qlcnic_alloc_lb_filters_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_create_diag_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_disable_msi:</span>
	<span class="n">qlcnic_teardown_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">);</span>

<span class="nl">err_out_decr_ref:</span>
	<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">err_out_iounmap:</span>
	<span class="n">qlcnic_cleanup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err_out_free_hw:</span>
	<span class="n">qlcnic_free_adapter_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_out_maintenance_mode:</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlcnic_netdev_failed_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qlcnic_ethtool_failed_ops</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_decr_ref</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_create_diag_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">qlcnic_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">qlcnic_cancel_fw_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span><span class="p">);</span>

	<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">qlcnic_free_lb_filters_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_teardown_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">);</span>

	<span class="n">qlcnic_remove_diag_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_cleanup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">qlcnic_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">qlcnic_free_adapter_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__qlcnic_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_cancel_fw_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_wol_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__qlcnic_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__qlcnic_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to start firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_FAILED</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_BADBAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Device in FAILED state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * qlcnic_close - Disables a network interface entry point</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">__qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlcnic_alloc_lb_filters_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fmax</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_learn_lock</span><span class="p">);</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">QLCNIC_LB_MAX_FILTERS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hlist_head</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">QLCNIC_LB_MAX_FILTERS</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fmax</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_HLIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_free_lb_filters_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fmax</span> <span class="o">&amp;&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_change_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">uaddr</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">vlan_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">hwdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_nic_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_mac_req</span> <span class="o">*</span><span class="n">mac_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_vlan_req</span> <span class="o">*</span><span class="n">vlan_req</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">producer</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>

	<span class="n">producer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">;</span>
	<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">];</span>

	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_nic_req</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_nic_req</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">QLCNIC_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">QLCNIC_MAC_EVENT</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">mac_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_mac_req</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">mac_req</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">vlan_id</span> <span class="o">?</span> <span class="n">QLCNIC_MAC_VLAN_ADD</span> <span class="o">:</span> <span class="n">QLCNIC_MAC_ADD</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_req</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">vlan_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_vlan_req</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">vlan_req</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_id</span><span class="p">;</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#define QLCNIC_MAC_HASH(MAC)\</span>
<span class="cp">	((((MAC) &amp; 0x70000) &gt;&gt; 0x10) | (((MAC) &amp; 0x70000000000ULL) &gt;&gt; 0x25))</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_send_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">first_desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_filter</span> <span class="o">*</span><span class="n">fil</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_fil</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">tmp_hnode</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">src_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">vlan_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fnum</span> <span class="o">&gt;=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fmax</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Only NPAR capable devices support vlan based learning*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">)</span>
		<span class="n">vlan_id</span> <span class="o">=</span> <span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">vlan_TCI</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">phdr</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">hindex</span> <span class="o">=</span> <span class="n">QLCNIC_MAC_HASH</span><span class="p">(</span><span class="n">src_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">QLCNIC_LB_MAX_FILTERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fhead</span><span class="p">[</span><span class="n">hindex</span><span class="p">]);</span>

	<span class="n">hlist_for_each_entry_safe</span><span class="p">(</span><span class="n">tmp_fil</span><span class="p">,</span> <span class="n">tmp_hnode</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">fnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tmp_fil</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tmp_fil</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">==</span> <span class="n">vlan_id</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">&gt;</span>
			    <span class="p">(</span><span class="n">QLCNIC_READD_AGE</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">+</span> <span class="n">tmp_fil</span><span class="o">-&gt;</span><span class="n">ftime</span><span class="p">))</span>
				<span class="n">qlcnic_change_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">,</span>
								<span class="n">tx_ring</span><span class="p">);</span>
			<span class="n">tmp_fil</span><span class="o">-&gt;</span><span class="n">ftime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fil</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_filter</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fil</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">qlcnic_change_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">src_addr</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>

	<span class="n">fil</span><span class="o">-&gt;</span><span class="n">ftime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">fil</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_id</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fil</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_learn_lock</span><span class="p">);</span>
	<span class="n">hlist_add_head</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">fil</span><span class="o">-&gt;</span><span class="n">fnode</span><span class="p">),</span> <span class="n">head</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fnum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_learn_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_tx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">first_desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">hwdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="n">vh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_8021Q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS_VLAN_TAGGED</span><span class="p">;</span>
		<span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">vh</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS_VLAN_OOB</span><span class="p">;</span>
		<span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tci</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_TAGGING_ENABLED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tci</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_TAGGING_ENABLED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">set_flags</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS_VLAN_OOB</span><span class="p">;</span>
		<span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pvid</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">set_flags:</span>
	<span class="n">qlcnic_set_tx_vlan_tci</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">vlan_tci</span><span class="p">);</span>
	<span class="n">qlcnic_set_tx_flags_opcode</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">BIT_0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">eth_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_ETHER_PKT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">);</span>
		<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">total_hdr_length</span> <span class="o">=</span> <span class="n">hdr_len</span><span class="p">;</span>

		<span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IPV6</span><span class="p">)</span> <span class="o">?</span> <span class="n">TX_TCP_LSO6</span> <span class="o">:</span> <span class="n">TX_TCP_LSO</span><span class="p">;</span>

		<span class="cm">/* For LSO, we need to copy the MAC/IP/TCP headers into</span>
<span class="cm">		* the descriptor ring */</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAGS_VLAN_OOB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">total_hdr_length</span> <span class="o">+=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">tcp_hdr_offset</span> <span class="o">=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">ip_hdr_offset</span> <span class="o">=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="cm">/* Only in case of TSO on vlan device */</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_VLAN_TAGGED</span><span class="p">;</span>

			<span class="cm">/* Create a TSO vlan header template for firmware */</span>

			<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">copy_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">offset</span><span class="p">,</span> <span class="n">hdr_len</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">);</span>

			<span class="n">vh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">hwdesc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
			<span class="n">vh</span><span class="o">-&gt;</span><span class="n">h_vlan_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
			<span class="n">vh</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">vlan_tci</span><span class="p">);</span>

			<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">vh</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">copy_len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

			<span class="n">copied</span> <span class="o">=</span> <span class="n">copy_len</span> <span class="o">-</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&lt;</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">copy_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">-</span> <span class="n">copied</span><span class="p">));</span>

			<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">hwdesc</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>

			<span class="n">copied</span> <span class="o">+=</span> <span class="n">copy_len</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span><span class="p">;</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lso_frames</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">l4proto</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l4proto</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_TCP_PKT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_UDP_PKT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IPV6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l4proto</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_TCPV6_PKT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_UDPV6_PKT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">tcp_hdr_offset</span> <span class="o">+=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">ip_hdr_offset</span> <span class="o">+=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">qlcnic_set_tx_flags_opcode</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_map_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qlcnic_cmd_buffer</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_skb_frag</span> <span class="o">*</span><span class="n">nf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>

	<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
	<span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">map</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>

		<span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
		<span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_unmap_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qlcnic_cmd_buffer</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_skb_frag</span> <span class="o">*</span><span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">qlcnic_clear_cmddesc</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">netdev_tx_t</span>
<span class="nf">qlcnic_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_buffer</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_skb_frag</span> <span class="o">*</span><span class="n">buffrag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">hwdesc</span><span class="p">,</span> <span class="o">*</span><span class="n">first_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">phdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">producer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_txd</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MACSPOOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frag_count</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* 14 frags supported for normal packet and</span>
<span class="cm">	 * 32 frags supported for TSO packet</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">frag_count</span> <span class="o">&gt;</span> <span class="n">QLCNIC_MAX_FRAGS_PER_TX</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">frag_count</span> <span class="o">-</span> <span class="n">QLCNIC_MAX_FRAGS_PER_TX</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__pskb_pull_tail</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">delta</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>

		<span class="n">frag_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">qlcnic_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">TX_STOP_THRESH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TX_STOP_THRESH</span><span class="p">)</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmit_off</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">producer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">first_desc</span> <span class="o">=</span> <span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
	<span class="n">qlcnic_clear_cmddesc</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_map_tx_skb</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dma_map_error</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_count</span> <span class="o">=</span> <span class="n">frag_count</span><span class="p">;</span>

	<span class="n">qlcnic_set_tx_frags_len</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">frag_count</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">qlcnic_set_tx_port</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frag_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* move to next desc.*/</span>
			<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">num_txd</span><span class="p">);</span>
			<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
			<span class="n">qlcnic_clear_cmddesc</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span><span class="p">);</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buffrag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer1</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer2</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer3</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer4</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">num_txd</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">qlcnic_tx_pkt</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">first_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">unwind_buff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_learn</span><span class="p">)</span>
		<span class="n">qlcnic_send_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">,</span> <span class="n">first_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmitcalled</span><span class="o">++</span><span class="p">;</span>

	<span class="n">qlcnic_update_cmd_producer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">unwind_buff:</span>
	<span class="n">qlcnic_unmap_buffers</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">);</span>
<span class="nl">drop_packet:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txdropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_check_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_TEMP_STATE</span><span class="p">);</span>

	<span class="n">temp_state</span> <span class="o">=</span> <span class="n">qlcnic_get_temp_state</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp_val</span> <span class="o">=</span> <span class="n">qlcnic_get_temp_val</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">QLCNIC_TEMP_PANIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;Device temperature %d degrees C exceeds&quot;</span>
		       <span class="s">&quot; maximum allowed. Hardware has been shut down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">temp_val</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">QLCNIC_TEMP_WARN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">==</span> <span class="n">QLCNIC_TEMP_NORMAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;Device temperature %d degrees C &quot;</span>
			       <span class="s">&quot;exceeds operating range.&quot;</span>
			       <span class="s">&quot; Immediate action needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">temp_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">==</span> <span class="n">QLCNIC_TEMP_WARN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;Device temperature is now %d degrees C&quot;</span>
			       <span class="s">&quot; in normal range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlcnic_advert_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">linkup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">linkup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;NIC Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">&amp;&amp;</span> <span class="n">linkup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;NIC Link is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit timeout, resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeo_cnt</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_TX_TIMEOUTS</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_context</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">qlcnic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_pkts</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lro_pkts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmitfinished</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytes</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lrobytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxdropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txdropped</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlcnic_clear_legacy_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* check interrupt state machine, to be sure */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISR_LEGACY_INT_TRIGGERED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>
	<span class="cm">/* read twice to ensure write is flushed */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlcnic_tmp_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MSIX_ENABLED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_MSI_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_clear_legacy_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">==</span> <span class="n">IRQ_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">diag_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qlcnic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlcnic_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_clear_legacy_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">==</span> <span class="n">IRQ_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlcnic_msi_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="cm">/* clear interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">qlcnic_msix_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_process_cmd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sw_consumer</span><span class="p">,</span> <span class="n">hw_consumer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_skb_frag</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sw_consumer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">sw_consumer</span><span class="p">;</span>
	<span class="n">hw_consumer</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sw_consumer</span> <span class="o">!=</span> <span class="n">hw_consumer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">sw_consumer</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">frag</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">frag_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frag</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">frag</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmitfinished</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sw_consumer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">sw_consumer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_STATUS_HANDLE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">sw_consumer</span> <span class="o">=</span> <span class="n">sw_consumer</span><span class="p">;</span>

		<span class="n">smp_mb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TX_STOP_THRESH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmit_on</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeo_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If everything is freed up to consumer then check if the ring is full</span>
<span class="cm">	 * If the ring is full then check if more needs to be freed and</span>
<span class="cm">	 * schedule the call back again.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This happens when there are 2 CPUs. One could be freeing and the</span>
<span class="cm">	 * other filling it. If the ring is full when we get out of here and</span>
<span class="cm">	 * the card has already interrupted the host then the host can miss the</span>
<span class="cm">	 * interrupt.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is still a possible race condition and the host could miss an</span>
<span class="cm">	 * interrupt. The card has to take care of this.</span>
<span class="cm">	 */</span>
	<span class="n">hw_consumer</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span><span class="p">));</span>
	<span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw_consumer</span> <span class="o">==</span> <span class="n">hw_consumer</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">tx_complete</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">tx_complete</span> <span class="o">=</span> <span class="n">qlcnic_process_cmd_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="n">qlcnic_process_rcv_ring</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tx_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">qlcnic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_rx_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="n">qlcnic_process_rcv_ring</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">qlcnic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">qlcnic_intr</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_idc_debug_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">encoding</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">encoding</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_rst_time</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_SCRATCH</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_rst_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_set_drv_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">val</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">QLCNIC_DEV_NEED_RESET</span> <span class="o">&amp;&amp;</span>
			<span class="n">state</span> <span class="o">!=</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_RESET</span><span class="p">)</span>
		<span class="n">QLC_DEV_SET_RST_RDY</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span><span class="p">)</span>
		<span class="n">QLC_DEV_SET_QSCNT_RDY</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>

	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_clr_drv_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">QLC_DEV_CLR_RST_QSCNT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">failed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="n">QLC_DEV_CLR_REF_CNT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_ACTIVE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_FAILED</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Device state set to Failed. Please Reboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">))</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_COLD</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">QLC_DEV_CLR_RST_QSCNT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLCNIC_FW_HANG</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_START_FW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Grab api lock, before checking state */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_check_drv_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">act</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">active_mask</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">act</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_ACTIVE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_RESET_OWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">active_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)));</span>
		<span class="n">act</span> <span class="o">=</span> <span class="n">act</span> <span class="o">&amp;</span> <span class="n">active_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">act</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x11111111</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_check_idc_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_IDC_VER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">QLCNIC_DRV_IDC_VER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IDC Version mismatch, driver&#39;s&quot;</span>
			<span class="s">&quot; idc ver = %x; reqd = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">QLCNIC_DRV_IDC_VER</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_can_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_init_timeo</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_init_timeo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">portnum</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_START_FW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_ACTIVE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">portnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">QLC_DEV_SET_REF_CNT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_ACTIVE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">prev_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">HW</span><span class="p">,</span> <span class="s">&quot;Device state = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prev_state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">prev_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLCNIC_DEV_COLD</span>:
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_INITIALIZING</span><span class="p">);</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_IDC_VER</span><span class="p">,</span> <span class="n">QLCNIC_DRV_IDC_VER</span><span class="p">);</span>
		<span class="n">qlcnic_idc_debug_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLCNIC_DEV_READY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_check_idc_ver</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLCNIC_DEV_NEED_RESET</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
		<span class="n">QLC_DEV_SET_RST_RDY</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
		<span class="n">QLC_DEV_SET_QSCNT_RDY</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLCNIC_DEV_FAILED</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device in failed state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">QLCNIC_DEV_INITIALIZING</span>:
	<span class="k">case</span> <span class="n">QLCNIC_DEV_QUISCENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">prev_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_QUISCENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">prev_state</span> <span class="o">!=</span> <span class="n">QLCNIC_DEV_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">dev_init_timeo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_init_timeo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Waiting for device to initialize timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
	<span class="n">QLC_DEV_CLR_RST_QSCNT</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">portnum</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_check_idc_ver</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_fwinit_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qlcnic_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">dev_state</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>

	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_QUISCENT</span> <span class="o">||</span>
	    <span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fwinit_work</span><span class="p">,</span>
						<span class="n">FW_POLL_DELAY</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">wait_npar</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_INITIALIZING</span> <span class="o">||</span>
	    <span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected state change from &quot;</span>
				<span class="s">&quot;DEV_NEED_RESET, skipping ack check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_ack_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_ack_timeo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset:Failed to get ack %d sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_ack_timeo</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">skip_ack_check</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qlcnic_check_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">skip_ack_check:</span>
		<span class="n">dev_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span>
						<span class="n">QLCNIC_DEV_INITIALIZING</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_START_FW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;Restarting fw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qlcnic_idc_debug_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">);</span>
			<span class="n">QLC_DEV_SET_RST_RDY</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
			<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DRV_STATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">enable</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_RESET_OWNER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;Take FW dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qlcnic_dump_fw</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_FW_HANG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLCNIC_FW_RESET_OWNER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_attach_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">wait_npar:</span>
	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">HW</span><span class="p">,</span> <span class="s">&quot;Func waiting: Device state=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_state</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLCNIC_DEV_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_attach_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">QLCNIC_DEV_FAILED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">qlcnic_fwinit_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err_ret:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fwinit work failed state=%u &quot;</span>
		<span class="s">&quot;fw_wait_cnt=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_state</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_detach_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qlcnic_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Dont grab rtnl lock during Quiscent mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">__qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_PEG_HALT_STATUS1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">QLCNIC_RCODE_FATAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Detaching the device: peg halt status1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">QLCNIC_FWERROR_CODE</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLCNIC_FWERROR_FAN_FAILURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;On board active cooling fan failed. &quot;</span>
				<span class="s">&quot;Device has been halted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Replace the adapter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">==</span> <span class="n">QLCNIC_TEMP_PANIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detaching the device: temp=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Dont ack if this instance is the reset owner */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_RESET_OWNER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_set_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to set driver state,&quot;</span>
					<span class="s">&quot;detaching the device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fwinit_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_ret:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*Transit NPAR state to NON Operational */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_set_npar_non_operational</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NPAR_NON_OPER</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_NPAR_NON_OPER</span><span class="p">);</span>
	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*Transit to RESET state from READY state only */</span>
<span class="kt">void</span>
<span class="nf">qlcnic_dev_request_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">,</span> <span class="n">xg_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gb_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qlcnic_xg_set_xg0_mask</span><span class="p">(</span><span class="n">xg_val</span><span class="p">);</span>
	<span class="n">qlcnic_xg_set_xg1_mask</span><span class="p">(</span><span class="n">xg_val</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_NIU_XG_PAUSE_CTL</span><span class="p">,</span> <span class="n">xg_val</span><span class="p">);</span>
	<span class="n">qlcnic_gb_set_gb0_mask</span><span class="p">(</span><span class="n">gb_val</span><span class="p">);</span>
	<span class="n">qlcnic_gb_set_gb1_mask</span><span class="p">(</span><span class="n">gb_val</span><span class="p">);</span>
	<span class="n">qlcnic_gb_set_gb2_mask</span><span class="p">(</span><span class="n">gb_val</span><span class="p">);</span>
	<span class="n">qlcnic_gb_set_gb3_mask</span><span class="p">(</span><span class="n">gb_val</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_NIU_GB_PAUSE_CTL</span><span class="p">,</span> <span class="n">gb_val</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Pause control frames disabled&quot;</span>
				<span class="s">&quot; on all ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span>  <span class="o">==</span> <span class="n">QLCNIC_DEV_FAILED</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_BADBAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				<span class="s">&quot;Device is in FAILED state, Please Reboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_NEED_RESET</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_FW_RESET_OWNER</span><span class="p">;</span>
		<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;NEED_RESET state set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qlcnic_idc_debug_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_NPAR_NON_OPER</span><span class="p">);</span>
	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Transit to NPAR READY state from NPAR NOT READY state */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_dev_set_npar_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_NPAR_OPER</span><span class="p">);</span>
	<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;NPAR operational state set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">work_func_t</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_AER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qlcnic_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">,</span>
					<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_cancel_fw_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_attach_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qlcnic_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">npar_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">npar_state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_NPAR_STATE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">QLCNIC_DEV_NPAR_OPER_TIMEO</span><span class="p">)</span>
			<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">npar_state</span> <span class="o">!=</span> <span class="n">QLCNIC_DEV_NPAR_OPER</span><span class="p">)</span>
			<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_attach_work</span><span class="p">,</span>
							<span class="n">FW_POLL_DELAY</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">attach</span><span class="p">;</span>
		<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;Waiting for NPAR state to operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">attach:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLCNIC_FW_HANG</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qlcnic_clr_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fw_poll_work</span><span class="p">,</span>
							<span class="n">FW_POLL_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_check_health</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">heartbeat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">peg_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_check_temp</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span><span class="p">)</span>
		<span class="n">qlcnic_dev_request_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlcnic_set_npar_non_operational</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>

	<span class="n">heartbeat</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_PEG_ALIVE_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">heartbeat</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_context</span> <span class="o">&amp;&amp;</span> <span class="n">auto_fw_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlcnic_reset_hw_context</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">&lt;</span> <span class="n">FW_FAIL_THRESH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">QLCNIC_FW_HANG</span><span class="p">;</span>

	<span class="n">qlcnic_dev_request_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_fw_reset</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_FW_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware hang detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dumping hw/fw registers</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_HALT_STATUS1: 0x%x, PEG_HALT_STATUS2: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_NET_0_PC: 0x%x, PEG_NET_1_PC: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_NET_2_PC: 0x%x, PEG_NET_3_PC: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_NET_4_PC: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_PEG_HALT_STATUS1</span><span class="p">),</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_PEG_HALT_STATUS2</span><span class="p">),</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_PEG_NET_1</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_PEG_NET_2</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_PEG_NET_3</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_PEG_NET_4</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">));</span>
	<span class="n">peg_status</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_PEG_HALT_STATUS1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">QLCNIC_FWERROR_CODE</span><span class="p">(</span><span class="n">peg_status</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x67</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Firmware aborted with error code 0x00006700. &quot;</span>
				<span class="s">&quot;Device is being reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">detach:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_NEED_QUISCENT</span><span class="p">)</span> <span class="o">?</span> <span class="n">state</span> <span class="o">:</span>
		<span class="n">QLCNIC_DEV_NEED_RESET</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_fw_reset</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_detach_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;fw recovery scheduled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_fw_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qlcnic_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">reschedule</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_check_health</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fhash</span><span class="p">.</span><span class="n">fnum</span><span class="p">)</span>
		<span class="n">qlcnic_prune_lb_filters</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">reschedule:</span>
	<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_is_first_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">oth_pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oth_pdev</span> <span class="o">=</span> <span class="n">pci_get_domain_bus_and_slot</span><span class="p">(</span><span class="n">pci_domain_nr</span>
			<span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">val</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oth_pdev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oth_pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">!=</span> <span class="n">PCI_D3cold</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">oth_pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">oth_pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_attach_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">first_func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">error_state</span> <span class="o">=</span> <span class="n">pci_channel_io_normal</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">first_func</span> <span class="o">=</span> <span class="n">qlcnic_is_first_func</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span> <span class="o">&amp;&amp;</span> <span class="n">first_func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_START_FW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">QLCNIC_DEV_INITIALIZING</span><span class="p">);</span>
		<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;Restarting fw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">qlcnic_clr_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_setup_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qlcnic_clr_all_drv_state</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_AER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">done:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">qlcnic_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_normal</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_AER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_teardown_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">qlcnic_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">qlcnic_attach_func</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">?</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span> <span class="o">:</span>
				<span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qlcnic_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_READY</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_AER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">qlcnic_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">qlcnic_fw_poll_work</span><span class="p">,</span>
						<span class="n">FW_POLL_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnicvf_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_can_start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_check_npar_opertional</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_initialize_nic</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">qlcnic_check_options</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_set_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnicvf_config_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnicvf_config_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_store_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_BDG</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">nic_ops</span><span class="o">-&gt;</span><span class="n">config_bridged_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">!!</span><span class="n">new</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_show_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bridged_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_BDG</span><span class="p">)</span>
		<span class="n">bridged_mode</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_BRIDGE_ENABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bridged_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_bridged_mode</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bridged_mode&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
       <span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">qlcnic_show_bridged_mode</span><span class="p">,</span>
       <span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">qlcnic_store_bridged_mode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_store_diag_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">new</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_DIAG_ENABLED</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^=</span> <span class="n">QLCNIC_DIAG_ENABLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_show_diag_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_DIAG_ENABLED</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_diag_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;diag_mode&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">qlcnic_show_diag_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">qlcnic_store_diag_mode</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">qlcnic_validate_max_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">max_hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_msi_x</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">use_msi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;no msix or msi support, hence no rss</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">max_hw</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span>  <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;rss_ring valid range [2 - %x] in &quot;</span>
			<span class="s">&quot; powers of 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_set_max_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">__qlcnic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">qlcnic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">qlcnic_teardown_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_enable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;failed setting max_rss; rss disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">qlcnic_enable_msi_legacy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__qlcnic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">done:</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_validate_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u16</span> <span class="n">beacon</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="n">LSB</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
	<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">MSB</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>

	<span class="n">QLCDB</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">DRV</span><span class="p">,</span> <span class="s">&quot;rate %x state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">rate</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="n">__QLCNIC_MAX_LED_RATE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">__QLCNIC_MAX_LED_STATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!*</span><span class="n">rate</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">__QLCNIC_MAX_LED_RATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_store_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_sds_rings</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">beacon</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b_state</span><span class="p">,</span> <span class="n">b_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;LED test not supported for non &quot;</span>
				<span class="s">&quot;privilege function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beacon</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_validate_beacon</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">beacon_state</span> <span class="o">==</span> <span class="n">b_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">beacon_state</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__QLCNIC_LED_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_diag_alloc_res</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">QLCNIC_LED_TEST</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_DIAG_RES_ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_config_led</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">b_state</span><span class="p">,</span> <span class="n">b_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">beacon_state</span> <span class="o">=</span> <span class="n">b_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_DIAG_RES_ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">qlcnic_diag_free_res</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">max_sds_rings</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">beacon_state</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_LED_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_show_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">beacon_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_beacon</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;beacon&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">qlcnic_show_beacon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">qlcnic_store_beacon</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_sysfs_validate_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">crb_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_DIAG_ENABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">QLCNIC_PCI_CRBSPACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_PCI_CAMQM</span><span class="p">,</span>
					<span class="n">QLCNIC_PCI_CAMQM_END</span><span class="p">))</span>
			<span class="n">crb_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="n">crb_size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">crb_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_read_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">qmdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_validate_crb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_PCI_CAMQM</span><span class="p">,</span> <span class="n">QLCNIC_PCI_CAMQM_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qlcnic_pci_camqm_read_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qmdata</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qmdata</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_write_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">qmdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_validate_crb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_PCI_CAMQM</span><span class="p">,</span> <span class="n">QLCNIC_PCI_CAMQM_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qmdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">qlcnic_pci_camqm_write_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">qmdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_sysfs_validate_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_DIAG_ENABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_validate_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_pci_mem_read_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_validate_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_pci_mem_write_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_crb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;crb&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_read_crb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_write_crb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_mem</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mem&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_read_mem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_write_mem</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">validate_pm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qlcnic_pm_func_cfg</span> <span class="o">*</span><span class="n">pm_cfg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u8</span> <span class="n">src_pci_func</span><span class="p">,</span> <span class="n">s_esw_id</span><span class="p">,</span> <span class="n">d_esw_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dest_pci_func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_pci_func</span> <span class="o">=</span> <span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="n">dest_pci_func</span> <span class="o">=</span> <span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_npar</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_pci_func</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span>
				<span class="o">||</span> <span class="n">dest_pci_func</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">src_pci_func</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">dest_pci_func</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="n">s_esw_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">src_pci_func</span><span class="p">].</span><span class="n">phy_port</span><span class="p">;</span>
		<span class="n">d_esw_id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">dest_pci_func</span><span class="p">].</span><span class="n">phy_port</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s_esw_id</span> <span class="o">!=</span> <span class="n">d_esw_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_write_pm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_pm_func_cfg</span> <span class="o">*</span><span class="n">pm_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">rem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">count</span>	<span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_pm_func_cfg</span><span class="p">);</span>
	<span class="n">rem</span>	<span class="o">=</span> <span class="n">size</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_pm_func_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">pm_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_pm_func_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_pm_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pm_cfg</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_func</span> <span class="o">=</span> <span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="n">action</span> <span class="o">=</span> <span class="o">!!</span><span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">action</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">phy_port</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_config_port_mirroring</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
						<span class="n">action</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_func</span> <span class="o">=</span> <span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">phy_port</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">enable_pm</span> <span class="o">=</span> <span class="o">!!</span><span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">action</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">dest_npar</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_read_pm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_pm_func_cfg</span> <span class="n">pm_cfg</span><span class="p">[</span><span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pm_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">action</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enable_pm</span><span class="p">;</span>
		<span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest_npar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pm_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pm_cfg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">validate_esw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">op_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">op_mode</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">QLCNIC_DRV_OP_MODE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_func</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_func</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLCNIC_PORT_DEFAULTS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">QLC_DEV_GET_DRV</span><span class="p">(</span><span class="n">op_mode</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">)</span> <span class="o">!=</span>
						<span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_anti_spoof</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_override</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promisc_mode</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLCNIC_ADD_VLAN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_VALID_VLAN</span><span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vlan_id</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_type</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLCNIC_DEL_VLAN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_type</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_write_esw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_npar_info</span> <span class="o">*</span><span class="n">npar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">rem</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_func</span><span class="p">,</span> <span class="n">op_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">count</span>	<span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span><span class="p">);</span>
	<span class="n">rem</span>	<span class="o">=</span> <span class="n">size</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">esw_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_esw_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">esw_cfg</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_config_switch_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">!=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">op_mode</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_mode</span><span class="p">;</span>
		<span class="n">qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">op_mode</span><span class="p">;</span>
		<span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLCNIC_PORT_DEFAULTS</span>:
			<span class="n">qlcnic_set_eswitch_port_features</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLCNIC_ADD_VLAN</span>:
			<span class="n">qlcnic_set_vlan_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLCNIC_DEL_VLAN</span>:
			<span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qlcnic_set_vlan_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_func</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="n">npar</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">QLCNIC_PORT_DEFAULTS</span>:
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">promisc_mode</span><span class="p">;</span>
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac_override</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_override</span><span class="p">;</span>
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offload_flags</span><span class="p">;</span>
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac_anti_spoof</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac_anti_spoof</span><span class="p">;</span>
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">discard_tagged</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">discard_tagged</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLCNIC_ADD_VLAN</span>:
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vlan_id</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QLCNIC_DEL_VLAN</span>:
			<span class="n">npar</span><span class="o">-&gt;</span><span class="n">pvid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_read_esw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="n">esw_cfg</span><span class="p">[</span><span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">esw_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_cfg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">validate_npar_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qlcnic_npar_func_cfg</span> <span class="o">*</span><span class="n">np_cfg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pci_func</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_func</span> <span class="o">=</span> <span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_func</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_VALID_BW</span><span class="p">(</span><span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_bw</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">IS_VALID_BW</span><span class="p">(</span><span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_bw</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_write_npar_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="n">nic_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_npar_func_cfg</span> <span class="o">*</span><span class="n">np_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">rem</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_func</span><span class="p">;</span>

	<span class="n">count</span>	<span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_npar_func_cfg</span><span class="p">);</span>
	<span class="n">rem</span>	<span class="o">=</span> <span class="n">size</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_npar_func_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rem</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">np_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_npar_func_cfg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_npar_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">np_cfg</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_func</span> <span class="o">=</span> <span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_nic_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_info</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">nic_info</span><span class="p">.</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">pci_func</span><span class="p">;</span>
		<span class="n">nic_info</span><span class="p">.</span><span class="n">min_tx_bw</span> <span class="o">=</span> <span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_bw</span><span class="p">;</span>
		<span class="n">nic_info</span><span class="p">.</span><span class="n">max_tx_bw</span> <span class="o">=</span> <span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_bw</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_set_nic_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_bw</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">min_tx_bw</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_bw</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_tx_bw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_read_npar_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="n">nic_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_npar_func_cfg</span> <span class="n">np_cfg</span><span class="p">[</span><span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">np_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">QLCNIC_TYPE_NIC</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_nic_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic_info</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">op_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">nic_info</span><span class="p">.</span><span class="n">op_mode</span><span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">phys_port</span><span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fw_capab</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">capabilities</span><span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_bw</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">min_tx_bw</span> <span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_bw</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_tx_bw</span><span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_tx_queues</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_tx_ques</span><span class="p">;</span>
		<span class="n">np_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_rx_queues</span> <span class="o">=</span> <span class="n">nic_info</span><span class="p">.</span><span class="n">max_rx_ques</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">np_cfg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_get_port_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_statistics</span> <span class="n">port_stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_esw_statistics</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_QUERY_RX_COUNTER</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">port_stats</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_QUERY_TX_COUNTER</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">port_stats</span><span class="p">.</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_stats</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_get_esw_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_esw_statistics</span> <span class="n">esw_stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_esw_statistics</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_NIU_MAX_XG_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">esw_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_eswitch_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_QUERY_RX_COUNTER</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">esw_stats</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_eswitch_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">QLCNIC_QUERY_TX_COUNTER</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">esw_stats</span><span class="p">.</span><span class="n">tx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esw_stats</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_clear_esw_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_NIU_MAX_XG_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_clear_esw_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_STATS_ESWITCH</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						<span class="n">QLCNIC_QUERY_RX_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_clear_esw_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_STATS_ESWITCH</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						<span class="n">QLCNIC_QUERY_TX_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_clear_port_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_clear_esw_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_STATS_PORT</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						<span class="n">QLCNIC_QUERY_RX_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_clear_esw_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_STATS_PORT</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						<span class="n">QLCNIC_QUERY_TX_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">qlcnic_sysfs_read_pci_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">qlcnic_pci_func_cfg</span> <span class="n">pci_cfg</span><span class="p">[</span><span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">qlcnic_pci_info</span> <span class="o">*</span><span class="n">pci_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pci_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">QL_STATUS_INVALID_PARAM</span><span class="p">;</span>

	<span class="n">pci_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pci_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">qlcnic_get_pci_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pci_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pci_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
		<span class="n">pci_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">func_type</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
		<span class="n">pci_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_num</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_port</span><span class="p">;</span>
		<span class="n">pci_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min_bw</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_min_bw</span><span class="p">;</span>
		<span class="n">pci_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_bw</span> <span class="o">=</span> <span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_max_bw</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">def_mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cfg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pci_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_npar_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;npar_config&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_read_npar_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_write_npar_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_pci_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pci_config&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_read_pci_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_port_stats</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;port_stats&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_get_port_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_clear_port_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_esw_stats</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;esw_stats&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_get_esw_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_clear_esw_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_esw_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;esw_config&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_read_esw_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_write_esw_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_pm_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pm_config&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_read_pm_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qlcnic_sysfs_write_pm_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_create_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_BDG</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bridged_mode</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to create bridged_mode sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_remove_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_BDG</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bridged_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_create_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_port_stats</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create port stats sysfs entry&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_diag_mode</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create diag_mode sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_crb</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create crb sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_mem</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create mem sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_FAILED</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_BADBAD</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_pci_config</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create pci config sysfs entry&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_beacon</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create beacon sysfs entry&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_esw_config</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create esw config sysfs entry&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_npar_config</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create npar config sysfs entry&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_pm_config</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create pm config sysfs entry&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_esw_stats</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create eswitch stats sysfs entry&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_remove_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_port_stats</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_NON_PRIV_FUNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_diag_mode</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_crb</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_FAILED</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_DEV_BADBAD</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_pci_config</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_beacon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_ESWITCH_ENABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_esw_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_npar_config</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_pm_config</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_esw_stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_INET</span>

<span class="cp">#define is_qlcnic_netdev(dev) (dev-&gt;netdev_ops == &amp;qlcnic_netdev_ops)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_config_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">indev</span><span class="p">;</span>

	<span class="n">indev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">indev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_ifa</span><span class="p">(</span><span class="n">indev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NETDEV_UP</span>:
			<span class="n">qlcnic_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">QLCNIC_IP_UP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
			<span class="n">qlcnic_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">QLCNIC_IP_DOWN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">indev</span><span class="p">);</span>

	<span class="n">in_dev_put</span><span class="p">(</span><span class="n">indev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">qlcnic_config_indev_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">__vlan_find_dev_deep</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">qlcnic_config_indev_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qlcnic_netdev_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

<span class="nl">recheck:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">recheck</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qlcnic_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">qlcnic_config_indev_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_inetaddr_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">?</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">recheck:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">recheck</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_qlcnic_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__QLCNIC_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="n">qlcnic_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">QLCNIC_IP_UP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">qlcnic_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">QLCNIC_IP_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span>	<span class="n">qlcnic_netdev_cb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">qlcnic_netdev_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">qlcnic_inetaddr_cb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">qlcnic_inetaddr_event</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_restore_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">qlcnic_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">qlcnic_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">qlcnic_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qlcnic_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">qlcnic_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">qlcnic_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">qlcnic_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">qlcnic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">qlcnic_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">qlcnic_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">qlcnic_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">qlcnic_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qlcnic_err_handler</span>

<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">qlcnic_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qlcnic_driver_string</span><span class="p">);</span>

	<span class="n">qlcnic_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;qlcnic&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;qlcnic: cannot create workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_INET</span>
	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_netdev_cb</span><span class="p">);</span>
	<span class="n">register_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_inetaddr_cb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_INET</span>
		<span class="n">unregister_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_inetaddr_cb</span><span class="p">);</span>
		<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_netdev_cb</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">qlcnic_wq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">qlcnic_init_module</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">qlcnic_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_driver</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INET</span>
	<span class="n">unregister_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_inetaddr_cb</span><span class="p">);</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qlcnic_netdev_cb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">qlcnic_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">qlcnic_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
