<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › qlogic › qlcnic › qlcnic_ctx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>qlcnic_ctx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic qlcnic NIC Driver</span>
<span class="cm"> * Copyright (c)  2009-2010 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qlcnic for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;qlcnic.h&quot;</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">qlcnic_poll_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* give atleast 1ms for firmware to respond */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">QLCNIC_OS_CRB_RETRY_COUNT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">QLCNIC_CDRP_RSP_TIMEOUT</span><span class="p">;</span>

		<span class="n">rsp</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CDRP_CRB_OFFSET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">QLCNIC_CDRP_IS_RSP</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rsp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">qlcnic_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">signature</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_hardware_context</span> <span class="o">*</span><span class="n">ahw</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">;</span>

	<span class="n">signature</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_SIGNATURE_MAKE</span><span class="p">(</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_hal_version</span><span class="p">);</span>

	<span class="cm">/* Acquire semaphore before accessing CRB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_RCODE_TIMEOUT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_SIGN_CRB_OFFSET</span><span class="p">,</span> <span class="n">signature</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_ARG1_CRB_OFFSET</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_ARG2_CRB_OFFSET</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_ARG3_CRB_OFFSET</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span><span class="p">);</span>
	<span class="n">QLCWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_CDRP_CRB_OFFSET</span><span class="p">,</span>
		<span class="n">QLCNIC_CDRP_FORM_CMD</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">rsp</span> <span class="o">=</span> <span class="n">qlcnic_poll_rsp</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">==</span> <span class="n">QLCNIC_CDRP_RSP_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;card response timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_RCODE_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">==</span> <span class="n">QLCNIC_CDRP_RSP_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_ARG1_CRB_OFFSET</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed card response code:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">==</span> <span class="n">QLCNIC_CDRP_RSP_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">QLCNIC_ARG2_CRB_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg3</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">QLCNIC_ARG3_CRB_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg1</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">QLCRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">QLCNIC_ARG1_CRB_OFFSET</span><span class="p">);</span>

	<span class="cm">/* Release semaphore */</span>
	<span class="n">qlcnic_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">qlcnic_temp_checksum</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">temp_buffer</span><span class="p">,</span> <span class="n">u16</span> <span class="n">temp_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">temp_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">temp_buffer</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sum</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">~</span><span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_fw_cmd_get_minidump_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmp_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">version</span><span class="p">,</span> <span class="n">csum</span><span class="p">,</span> <span class="o">*</span><span class="n">template</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_hardware_context</span> <span class="o">*</span><span class="n">ahw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_dump_template_hdr</span> <span class="o">*</span><span class="n">tmpl_hdr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_tmpl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tmp_addr_t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ahw</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_TEMP_SIZE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_cdrp_cmd</span><span class="p">));</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Can&#39;t get template size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temp_size</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span><span class="p">;</span>
	<span class="n">version</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">tmp_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">temp_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tmp_addr_t</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Can&#39;t get memory for FW dump template</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_cdrp_cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_TEMP_HDR</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">LSD</span><span class="p">(</span><span class="n">tmp_addr_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">MSD</span><span class="p">(</span><span class="n">tmp_addr_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">temp_size</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to get mini dump template header %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp_tmpl</span> <span class="o">=</span> <span class="n">tmp_addr</span><span class="p">;</span>
	<span class="n">csum</span> <span class="o">=</span> <span class="n">qlcnic_temp_checksum</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp_addr</span><span class="p">,</span> <span class="n">temp_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Template header checksum validation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">temp_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp_buf</span> <span class="o">=</span> <span class="n">tmp_addr</span><span class="p">;</span>
	<span class="n">template</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">temp_size</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">template</span><span class="o">++</span> <span class="o">=</span> <span class="n">__le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_buf</span><span class="o">++</span><span class="p">);</span>

	<span class="n">tmpl_hdr</span> <span class="o">=</span> <span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">tmpl_hdr</span><span class="p">;</span>
	<span class="n">tmpl_hdr</span><span class="o">-&gt;</span><span class="n">drv_cap_mask</span> <span class="o">=</span> <span class="n">QLCNIC_DUMP_MASK_DEF</span><span class="p">;</span>
	<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">fw_dump</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">temp_size</span><span class="p">,</span> <span class="n">tmp_addr</span><span class="p">,</span> <span class="n">tmp_addr_t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qlcnic_fw_cmd_set_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_SET_MTU</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">QLCNIC_HOST_CTX_STATE_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set mtu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_fw_cmd_create_rx_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_hostrq_rx_ctx</span> <span class="o">*</span><span class="n">prq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cardrsp_rx_ctx</span> <span class="o">*</span><span class="n">prsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_hostrq_rds_ring</span> <span class="o">*</span><span class="n">prq_rds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_hostrq_sds_ring</span> <span class="o">*</span><span class="n">prq_sds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cardrsp_rds_ring</span> <span class="o">*</span><span class="n">prsp_rds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cardrsp_sds_ring</span> <span class="o">*</span><span class="n">prsp_sds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_rds_ring</span> <span class="o">*</span><span class="n">rds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">dma_addr_t</span> <span class="n">hostrq_phys_addr</span><span class="p">,</span> <span class="n">cardrsp_phys_addr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phys_addr</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">nrds_rings</span><span class="p">,</span> <span class="n">nsds_rings</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">rq_size</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="n">nrds_rings</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span><span class="p">;</span>
	<span class="n">nsds_rings</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span>

	<span class="n">rq_size</span> <span class="o">=</span>
		<span class="n">SIZEOF_HOSTRQ_RX</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hostrq_rx_ctx</span><span class="p">,</span> <span class="n">nrds_rings</span><span class="p">,</span>
						<span class="n">nsds_rings</span><span class="p">);</span>
	<span class="n">rsp_size</span> <span class="o">=</span>
		<span class="n">SIZEOF_CARDRSP_RX</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_cardrsp_rx_ctx</span><span class="p">,</span> <span class="n">nrds_rings</span><span class="p">,</span>
						<span class="n">nsds_rings</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rq_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">hostrq_phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">prq</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cardrsp_phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_rq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prsp</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">host_rsp_dma_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cardrsp_phys_addr</span><span class="p">);</span>

	<span class="n">cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">QLCNIC_CAP0_LEGACY_CONTEXT</span> <span class="o">|</span> <span class="n">QLCNIC_CAP0_LEGACY_MN</span>
						<span class="o">|</span> <span class="n">QLCNIC_CAP0_VALIDOFF</span><span class="p">);</span>
	<span class="n">cap</span> <span class="o">|=</span> <span class="p">(</span><span class="n">QLCNIC_CAP0_JUMBO_CONTIGUOUS</span> <span class="o">|</span> <span class="n">QLCNIC_CAP0_LRO_CONTIGUOUS</span><span class="p">);</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">valid_field_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hostrq_rx_ctx</span><span class="p">,</span>
							 <span class="n">msix_handler</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">txrx_sds_binding</span> <span class="o">=</span> <span class="n">nsds_rings</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">host_int_crb_mode</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">QLCNIC_HOST_INT_CRB_MODE_SHARED</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">host_rds_crb_mode</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">QLCNIC_HOST_RDS_CRB_MODE_UNIQUE</span><span class="p">);</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">num_rds_rings</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nrds_rings</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">num_sds_rings</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nsds_rings</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">rds_ring_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">rds_ring_offset</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hostrq_rds_ring</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrds_rings</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">sds_ring_offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">prq_rds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hostrq_rds_ring</span> <span class="o">*</span><span class="p">)(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">rds_ring_offset</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrds_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">prq_rds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">prq_rds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
		<span class="n">prq_rds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring_kind</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">prq_rds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buff_size</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">prq_sds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hostrq_sds_ring</span> <span class="o">*</span><span class="p">)(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">sds_ring_offset</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsds_rings</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">consumer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">STATUS_DESC_RINGSIZE</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">));</span>

		<span class="n">prq_sds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">prq_sds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ring_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
		<span class="n">prq_sds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msi_index</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">hostrq_phys_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">rq_size</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_CREATE_RX_CTX</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to create rx ctx in firmware%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_rsp</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">prsp_rds</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">qlcnic_cardrsp_rds_ring</span> <span class="o">*</span><span class="p">)</span>
			 <span class="o">&amp;</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">rds_ring_offset</span><span class="p">)]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">num_rds_rings</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp_rds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_producer_crb</span><span class="p">);</span>
		<span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">crb_rcv_producer</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prsp_sds</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">qlcnic_cardrsp_sds_ring</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">sds_ring_offset</span><span class="p">)]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">num_sds_rings</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp_sds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">host_consumer_crb</span><span class="p">);</span>
		<span class="n">reg2</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp_sds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interrupt_crb</span><span class="p">);</span>

		<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">crb_sts_consumer</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">crb_intr_mask</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">reg2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">host_ctx_state</span><span class="p">);</span>
	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">);</span>
	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">virt_port</span> <span class="o">=</span> <span class="n">prsp</span><span class="o">-&gt;</span><span class="n">virt_port</span><span class="p">;</span>

<span class="nl">out_free_rsp:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">,</span> <span class="n">prsp</span><span class="p">,</span>
		<span class="n">cardrsp_phys_addr</span><span class="p">);</span>
<span class="nl">out_free_rq:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rq_size</span><span class="p">,</span> <span class="n">prq</span><span class="p">,</span> <span class="n">hostrq_phys_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_fw_cmd_destroy_rx_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">QLCNIC_DESTROY_CTX_RESET</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_DESTROY_RX_CTX</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to destroy rx ctx in firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">QLCNIC_HOST_CTX_STATE_FREED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">qlcnic_fw_cmd_create_tx_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_hostrq_tx_ctx</span>	<span class="o">*</span><span class="n">prq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_hostrq_cds_ring</span>	<span class="o">*</span><span class="n">prq_cds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cardrsp_tx_ctx</span>	<span class="o">*</span><span class="n">prsp</span><span class="p">;</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">rq_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">rsp_addr</span><span class="p">;</span>
	<span class="kt">size_t</span>	<span class="n">rq_size</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">rq_phys_addr</span><span class="p">,</span> <span class="n">rsp_phys_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="cm">/* reset host resources */</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">sw_consumer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rq_size</span> <span class="o">=</span> <span class="n">SIZEOF_HOSTRQ_TX</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_hostrq_tx_ctx</span><span class="p">);</span>
	<span class="n">rq_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rq_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rq_phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rq_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rsp_size</span> <span class="o">=</span> <span class="n">SIZEOF_CARDRSP_TX</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_cardrsp_tx_ctx</span><span class="p">);</span>
	<span class="n">rsp_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">rsp_phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_rq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rq_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rq_size</span><span class="p">);</span>
	<span class="n">prq</span> <span class="o">=</span> <span class="n">rq_addr</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rsp_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">);</span>
	<span class="n">prsp</span> <span class="o">=</span> <span class="n">rsp_addr</span><span class="p">;</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">host_rsp_dma_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rsp_phys_addr</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">QLCNIC_CAP0_LEGACY_CONTEXT</span> <span class="o">|</span> <span class="n">QLCNIC_CAP0_LEGACY_MN</span> <span class="o">|</span>
					<span class="n">QLCNIC_CAP0_LSO</span><span class="p">);</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">host_int_crb_mode</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">QLCNIC_HOST_INT_CRB_MODE_SHARED</span><span class="p">);</span>

	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">interrupt_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">msi_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prq</span><span class="o">-&gt;</span><span class="n">cmd_cons_dma_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_cons_phys_addr</span><span class="p">);</span>

	<span class="n">prq_cds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">prq</span><span class="o">-&gt;</span><span class="n">cds_ring</span><span class="p">;</span>

	<span class="n">prq_cds</span><span class="o">-&gt;</span><span class="n">host_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">prq_cds</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>

	<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">rq_phys_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">phys_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">phys_addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">rq_size</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_CREATE_TX_CTX</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">cds_ring</span><span class="p">.</span><span class="n">host_producer_crb</span><span class="p">);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">crb_cmd_producer</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">temp</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_context_id</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">prsp</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to create tx ctx in firmware%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rsp_size</span><span class="p">,</span> <span class="n">rsp_addr</span><span class="p">,</span>
		<span class="n">rsp_phys_addr</span><span class="p">);</span>

<span class="nl">out_free_rq:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rq_size</span><span class="p">,</span> <span class="n">rq_addr</span><span class="p">,</span> <span class="n">rq_phys_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">qlcnic_fw_cmd_destroy_tx_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_context_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">QLCNIC_DESTROY_CTX_RESET</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_DESTROY_TX_CTX</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to destroy tx ctx in firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qlcnic_fw_cmd_set_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_CONFIG_PORT</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_alloc_hw_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_rds_ring</span> <span class="o">*</span><span class="n">rds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>
	<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_cons_phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate tx consumer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cmd desc ring */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_DESC_RINGSIZE</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate tx desc ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">RCV_DESC_RINGSIZE</span><span class="p">(</span><span class="n">rds_ring</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to allocate rds ring [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">STATUS_DESC_RINGSIZE</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to allocate sds ring [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free:</span>
	<span class="n">qlcnic_free_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">qlcnic_fw_create_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_NEED_FLR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_reset_function</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">QLCNIC_NEED_FLR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_fw_cmd_create_rx_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">qlcnic_fw_cmd_create_tx_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qlcnic_fw_cmd_destroy_rx_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__QLCNIC_FW_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlcnic_fw_destroy_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__QLCNIC_FW_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qlcnic_fw_cmd_destroy_rx_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">qlcnic_fw_cmd_destroy_tx_ctx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="cm">/* Allow dma queues to drain after context reset */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">qlcnic_free_hw_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_rds_ring</span> <span class="o">*</span><span class="n">rds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>

	<span class="n">recv_ctx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span><span class="p">,</span>
				<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_cons_phys_addr</span><span class="p">);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">hw_consumer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">TX_DESC_RINGSIZE</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">),</span>
				<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">RCV_DESC_RINGSIZE</span><span class="p">(</span><span class="n">rds_ring</span><span class="p">),</span>
					<span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">,</span>
					<span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
			<span class="n">rds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">STATUS_DESC_RINGSIZE</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">),</span>
				<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">,</span>
				<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
			<span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Get MAC address of a NIC partition */</span>
<span class="kt">int</span> <span class="nf">qlcnic_get_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">|</span> <span class="n">BIT_8</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_MAC_ADDRESS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span>
		<span class="n">qlcnic_fetch_mac</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to get mac address%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get info of a NIC partition */</span>
<span class="kt">int</span> <span class="nf">qlcnic_get_nic_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="o">*</span><span class="n">npar_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">err</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">nic_dma_t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="o">*</span><span class="n">nic_info</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">nic_info_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">size_t</span>	<span class="n">nic_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_info</span><span class="p">);</span>

	<span class="n">nic_info_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_size</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">nic_dma_t</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic_info_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nic_info_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nic_size</span><span class="p">);</span>

	<span class="n">nic_info</span> <span class="o">=</span> <span class="n">nic_info_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_NIC_INFO</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">MSD</span><span class="p">(</span><span class="n">nic_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">LSD</span><span class="p">(</span><span class="n">nic_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="p">(</span><span class="n">func_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">nic_size</span><span class="p">);</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">op_mode</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">phys_port</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">phys_port</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">switch_mode</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">switch_mode</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_tx_ques</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_tx_ques</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">min_tx_bw</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">min_tx_bw</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_tx_bw</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_tx_bw</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">);</span>
		<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_mtu</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;phy port: %d switch_mode: %d,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">max_tx_q: %d max_rx_q: %d min_tx_bw: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">max_tx_bw: 0x%x max_mtu:0x%x, capabilities: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">phys_port</span><span class="p">,</span> <span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">switch_mode</span><span class="p">,</span>
			<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_tx_ques</span><span class="p">,</span> <span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span><span class="p">,</span>
			<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">min_tx_bw</span><span class="p">,</span> <span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_tx_bw</span><span class="p">,</span>
			<span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">max_mtu</span><span class="p">,</span> <span class="n">npar_info</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to get nic info%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_size</span><span class="p">,</span> <span class="n">nic_info_addr</span><span class="p">,</span>
		<span class="n">nic_dma_t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure a NIC partition */</span>
<span class="kt">int</span> <span class="nf">qlcnic_set_nic_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">nic_dma_t</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">nic_info_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_info</span> <span class="o">*</span><span class="n">nic_info</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nic_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">nic_info_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">nic_dma_t</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic_info_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">nic_info_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nic_size</span><span class="p">);</span>
	<span class="n">nic_info</span> <span class="o">=</span> <span class="n">nic_info_addr</span><span class="p">;</span>

	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">op_mode</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">phys_port</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phys_port</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">switch_mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">switch_mode</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_mac_filters</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">max_mac_filters</span><span class="p">;</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_tx_ques</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">max_tx_ques</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">max_rx_ques</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">min_tx_bw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">min_tx_bw</span><span class="p">);</span>
	<span class="n">nic_info</span><span class="o">-&gt;</span><span class="n">max_tx_bw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">max_tx_bw</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_SET_NIC_INFO</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">MSD</span><span class="p">(</span><span class="n">nic_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">LSD</span><span class="p">(</span><span class="n">nic_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">nic_size</span><span class="p">);</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to set nic info%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nic_size</span><span class="p">,</span> <span class="n">nic_info_addr</span><span class="p">,</span>
		<span class="n">nic_dma_t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get PCI Info of a partition */</span>
<span class="kt">int</span> <span class="nf">qlcnic_get_pci_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">qlcnic_pci_info</span> <span class="o">*</span><span class="n">pci_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pci_info_dma_t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_pci_info</span> <span class="o">*</span><span class="n">npar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pci_info_addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">npar_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_pci_info</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">pci_size</span> <span class="o">=</span> <span class="n">npar_size</span> <span class="o">*</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span>

	<span class="n">pci_info_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">pci_info_dma_t</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_info_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pci_info_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pci_size</span><span class="p">);</span>

	<span class="n">npar</span> <span class="o">=</span> <span class="n">pci_info_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_PCI_INFO</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">MSD</span><span class="p">(</span><span class="n">pci_info_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">LSD</span><span class="p">(</span><span class="n">pci_info_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">pci_size</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">npar</span><span class="o">++</span><span class="p">,</span> <span class="n">pci_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
			<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">default_port</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">default_port</span><span class="p">);</span>
			<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">tx_min_bw</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">tx_min_bw</span><span class="p">);</span>
			<span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">tx_max_bw</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">npar</span><span class="o">-&gt;</span><span class="n">tx_max_bw</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pci_info</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">npar</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to get PCI Info%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_size</span><span class="p">,</span> <span class="n">pci_info_addr</span><span class="p">,</span>
		<span class="n">pci_info_dma_t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure eSwitch for port mirroring */</span>
<span class="kt">int</span> <span class="nf">qlcnic_config_port_mirroring</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">enable_mirroring</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pci_func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span> <span class="o">||</span>
		<span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">eswitch</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QLCNIC_SWITCH_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">arg1</span> <span class="o">=</span> <span class="n">id</span> <span class="o">|</span> <span class="p">(</span><span class="n">enable_mirroring</span> <span class="o">?</span> <span class="n">BIT_4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">arg1</span> <span class="o">|=</span> <span class="n">pci_func</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_SET_PORTMIRRORING</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to configure port mirroring%d on eswitch:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_func</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Configured eSwitch %d for port mirroring:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">id</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_get_port_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">func</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">rx_tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__qlcnic_esw_statistics</span> <span class="o">*</span><span class="n">esw_stats</span><span class="p">)</span> <span class="p">{</span>

	<span class="kt">size_t</span> <span class="n">stats_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__qlcnic_esw_statistics</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">__qlcnic_esw_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">stats_dma_t</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stats_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esw_stats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">func</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Not privilege to query stats for func=%d&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">stats_dma_t</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stats_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stats_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">);</span>

	<span class="n">arg1</span> <span class="o">=</span> <span class="n">func</span> <span class="o">|</span> <span class="n">QLCNIC_STATS_VERSION</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">QLCNIC_STATS_PORT</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">arg1</span> <span class="o">|=</span> <span class="n">rx_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span> <span class="o">|</span> <span class="n">stats_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_ESWITCH_STATS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">LSD</span><span class="p">(</span><span class="n">stats_dma_t</span><span class="p">);</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="n">stats_addr</span><span class="p">;</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">context_id</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">multicast_frames</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">multicast_frames</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">broadcast_frames</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">broadcast_frames</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">unicast_frames</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">unicast_frames</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">dropped_frames</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">dropped_frames</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">local_frames</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">local_frames</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">);</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">numbytes</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">numbytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span> <span class="n">stats_addr</span><span class="p">,</span>
		<span class="n">stats_dma_t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine will retrieve the MAC statistics from firmware */</span>
<span class="kt">int</span> <span class="nf">qlcnic_get_mac_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_mac_statistics</span> <span class="o">*</span><span class="n">mac_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qlcnic_mac_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">stats_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_mac_statistics</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">stats_dma_t</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stats_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">stats_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">stats_dma_t</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stats_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Unable to allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stats_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_MAC_STATS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">stats_size</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">MSD</span><span class="p">(</span><span class="n">stats_dma_t</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">LSD</span><span class="p">(</span><span class="n">stats_dma_t</span><span class="p">);</span>

	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats</span> <span class="o">=</span> <span class="n">stats_addr</span><span class="p">;</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_tx_frames</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_tx_frames</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_tx_bytes</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_tx_bytes</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_tx_mcast_pkts</span> <span class="o">=</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_tx_mcast_pkts</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_tx_bcast_pkts</span> <span class="o">=</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_tx_bcast_pkts</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_frames</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_frames</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_bytes</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_bytes</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_mcast_pkts</span> <span class="o">=</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_mcast_pkts</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_length_error</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_length_error</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_length_small</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_length_small</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_length_large</span> <span class="o">=</span>
				<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_length_large</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_jabber</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_jabber</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_dropped</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_dropped</span><span class="p">);</span>
		<span class="n">mac_stats</span><span class="o">-&gt;</span><span class="n">mac_rx_crc_error</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">mac_rx_crc_error</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Get mac stats failed =%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">stats_size</span><span class="p">,</span> <span class="n">stats_addr</span><span class="p">,</span>
		<span class="n">stats_dma_t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_get_eswitch_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">eswitch</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">rx_tx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__qlcnic_esw_statistics</span> <span class="o">*</span><span class="n">esw_stats</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">__qlcnic_esw_statistics</span> <span class="n">port_stats</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">esw_stats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">esw_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">unicast_frames</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">multicast_frames</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">broadcast_frames</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">dropped_frames</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">local_frames</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">numbytes</span> <span class="o">=</span> <span class="n">QLCNIC_STATS_NOT_AVAIL</span><span class="p">;</span>
	<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">context_id</span> <span class="o">=</span> <span class="n">eswitch</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_port</span> <span class="o">!=</span> <span class="n">eswitch</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__qlcnic_esw_statistics</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qlcnic_get_port_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_tx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_stats</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">port_stats</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">port_stats</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">unicast_frames</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">unicast_frames</span><span class="p">);</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">multicast_frames</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">multicast_frames</span><span class="p">);</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">broadcast_frames</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">broadcast_frames</span><span class="p">);</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">dropped_frames</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">dropped_frames</span><span class="p">);</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">errors</span><span class="p">);</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">local_frames</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">local_frames</span><span class="p">);</span>
		<span class="n">QLCNIC_ADD_ESW_STATS</span><span class="p">(</span><span class="n">esw_stats</span><span class="o">-&gt;</span><span class="n">numbytes</span><span class="p">,</span>
						<span class="n">port_stats</span><span class="p">.</span><span class="n">numbytes</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">qlcnic_clear_esw_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">func_esw</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rx_tx</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">u32</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_esw</span> <span class="o">==</span> <span class="n">QLCNIC_STATS_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_MAX_PCI_FUNC</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_esw</span> <span class="o">==</span> <span class="n">QLCNIC_STATS_ESWITCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="n">QLCNIC_NIU_MAX_XG_PORTS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_tx</span> <span class="o">&gt;</span> <span class="n">QLCNIC_QUERY_TX_COUNTER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>

	<span class="n">arg1</span> <span class="o">=</span> <span class="n">port</span> <span class="o">|</span> <span class="n">QLCNIC_STATS_VERSION</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">func_esw</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">arg1</span> <span class="o">|=</span> <span class="n">BIT_14</span> <span class="o">|</span> <span class="n">rx_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_ESWITCH_STATS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

<span class="nl">err_ret:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid argument func_esw=%d port=%d&quot;</span>
		<span class="s">&quot;rx_ctx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func_esw</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">rx_tx</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">u32</span> <span class="o">*</span><span class="n">arg1</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">arg2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_func</span><span class="p">;</span>
	<span class="n">pci_func</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">arg1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_GET_ESWITCH_PORT_CONFIG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="o">*</span><span class="n">arg1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="o">*</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">arg2</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;eSwitch port config for pci func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to get eswitch port config for pci func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">pci_func</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Configure eSwitch port</span>
<span class="cm">op_mode = 0 for setting default port behavior</span>
<span class="cm">op_mode = 1 for setting  vlan id</span>
<span class="cm">op_mode = 2 for deleting vlan id</span>
<span class="cm">op_type = 0 for vlan_id</span>
<span class="cm">op_type = 1 for port vlan_id</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">qlcnic_config_switch_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qlcnic_cmd_args</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pci_func</span> <span class="o">=</span> <span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">;</span>
	<span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">pci_func</span><span class="p">].</span><span class="n">phy_port</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">);</span>
	<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pci_func</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">arg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0ff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pci_func</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">arg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">op_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">QLCNIC_PORT_DEFAULTS</span>:
		<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_4</span> <span class="o">|</span> <span class="n">BIT_6</span> <span class="o">|</span> <span class="n">BIT_7</span><span class="p">);</span>
		<span class="n">arg2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_0</span> <span class="o">|</span> <span class="n">BIT_1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">QLCNIC_FW_CAPABILITY_TSO</span><span class="p">)</span>
			<span class="n">arg2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">discard_tagged</span><span class="p">))</span>
			<span class="n">arg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">promisc_mode</span><span class="p">))</span>
			<span class="n">arg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">mac_override</span><span class="p">))</span>
			<span class="n">arg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">mac_anti_spoof</span><span class="p">))</span>
			<span class="n">arg2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">&amp;</span> <span class="n">BIT_0</span><span class="p">))</span>
			<span class="n">arg2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_1</span> <span class="o">|</span> <span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">&amp;</span> <span class="n">BIT_1</span><span class="p">))</span>
			<span class="n">arg2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">&amp;</span> <span class="n">BIT_2</span><span class="p">))</span>
			<span class="n">arg2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLCNIC_ADD_VLAN</span>:
			<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_2</span> <span class="o">|</span> <span class="n">BIT_5</span><span class="p">);</span>
			<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">QLCNIC_DEL_VLAN</span>:
			<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_3</span> <span class="o">|</span> <span class="n">BIT_5</span><span class="p">);</span>
			<span class="n">arg1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0ffff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">QLCNIC_CDRP_CMD_CONFIGURE_ESWITCH</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">arg2</span><span class="p">;</span>
	<span class="n">qlcnic_issue_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">rsp</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">QLCNIC_RCODE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to configure eswitch pci func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Configured eSwitch for pci func %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_func</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">qlcnic_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">qlcnic_esw_func_cfg</span> <span class="o">*</span><span class="n">esw_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_port</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">QLCNIC_MGMT_FUNC</span><span class="p">)</span>
		<span class="n">phy_port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">npars</span><span class="p">[</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">pci_func</span><span class="p">].</span><span class="n">phy_port</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phy_port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>
	<span class="n">arg1</span> <span class="o">=</span> <span class="n">phy_port</span><span class="p">;</span>
	<span class="n">arg1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">pci_func</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__qlcnic_get_eswitch_port_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">discard_tagged</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">arg1</span> <span class="o">&amp;</span> <span class="n">BIT_4</span><span class="p">);</span>
	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">host_vlan_tag</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">arg1</span> <span class="o">&amp;</span> <span class="n">BIT_5</span><span class="p">);</span>
	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">promisc_mode</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">arg1</span> <span class="o">&amp;</span> <span class="n">BIT_6</span><span class="p">);</span>
	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">mac_override</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">arg1</span> <span class="o">&amp;</span> <span class="n">BIT_7</span><span class="p">);</span>
	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">vlan_id</span> <span class="o">=</span> <span class="n">LSW</span><span class="p">(</span><span class="n">arg1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">mac_anti_spoof</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg2</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">esw_cfg</span><span class="o">-&gt;</span><span class="n">offload_flags</span> <span class="o">=</span> <span class="p">((</span><span class="n">arg2</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
