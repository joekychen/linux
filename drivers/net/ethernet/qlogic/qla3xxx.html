<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › qlogic › qla3xxx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>qla3xxx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * QLogic QLA3xxx NIC HBA Driver</span>
<span class="cm"> * Copyright (c)  2003-2006 QLogic Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * See LICENSE.qla3xxx for copyright and licensing details.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/mempool.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &quot;qla3xxx.h&quot;</span>

<span class="cp">#define DRV_NAME	&quot;qla3xxx&quot;</span>
<span class="cp">#define DRV_STRING	&quot;QLogic ISP3XXX Network Driver&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;v2.03.00-k5&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ql3xxx_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ql3xxx_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_VERSION</span><span class="p">;</span>

<span class="cp">#define TIMED_OUT_MSG							\</span>
<span class="cp">&quot;Timed out waiting for management port to get free before issuing command\n&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;QLogic Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QLogic ISP3XXX Network Driver &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">default_msg</span>
    <span class="o">=</span> <span class="n">NETIF_MSG_DRV</span> <span class="o">|</span> <span class="n">NETIF_MSG_PROBE</span> <span class="o">|</span> <span class="n">NETIF_MSG_LINK</span>
    <span class="o">|</span> <span class="n">NETIF_MSG_IFUP</span> <span class="o">|</span> <span class="n">NETIF_MSG_IFDOWN</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* defaults above */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0=none,...,16=all)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">msi</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="s">&quot;Turn on Message Signaled Interrupts.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ql3xxx_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_QLOGIC</span><span class="p">,</span> <span class="n">QL3032_DEVICE_ID</span><span class="p">)},</span>
	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ql3xxx_pci_tbl</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  These are the known PHY&#39;s which are used</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">PHY_DEVICE_TYPE</span> <span class="p">{</span>
   <span class="n">PHY_TYPE_UNKNOWN</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
   <span class="n">PHY_VITESSE_VSC8211</span><span class="p">,</span>
   <span class="n">PHY_AGERE_ET1011C</span><span class="p">,</span>
   <span class="n">MAX_PHY_DEV_TYPES</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">PHY_DEVICE_INFO</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">enum</span> <span class="n">PHY_DEVICE_TYPE</span>	<span class="n">phyDevice</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span>		<span class="n">phyIdOUI</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span>		<span class="n">phyIdModel</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">PHY_DEVICE_INFO</span> <span class="n">PHY_DEVICES</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PHY_TYPE_UNKNOWN</span><span class="p">,</span>    <span class="mh">0x000000</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s">&quot;PHY_TYPE_UNKNOWN&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PHY_VITESSE_VSC8211</span><span class="p">,</span> <span class="mh">0x0003f1</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="s">&quot;PHY_VITESSE_VSC8211&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PHY_AGERE_ET1011C</span><span class="p">,</span>   <span class="mh">0x00a0bc</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="s">&quot;PHY_AGERE_ET1011C&quot;</span><span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Caller must take hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_sem_spinlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seconds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">sem_mask</span> <span class="o">|</span> <span class="n">sem_bits</span><span class="p">),</span>
		       <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">semaphoreReg</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">semaphoreReg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sem_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">==</span> <span class="n">sem_bits</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">seconds</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_sem_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sem_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">semaphoreReg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">semaphoreReg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_sem_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sem_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">sem_mask</span> <span class="o">|</span> <span class="n">sem_bits</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">semaphoreReg</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">semaphoreReg</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sem_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">==</span> <span class="n">sem_bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_wait_for_drvr_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_lock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">QL_DRVR_SEM_MASK</span><span class="p">,</span>
				<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
				 <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				      <span class="s">&quot;driver lock acquired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Timed out waiting for driver lock...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_set_register_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(((</span><span class="n">ISP_CONTROL_NP_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">page</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_read_common_reg_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_read_common_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_read_page0_reg_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql_set_register_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_read_page0_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql_set_register_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_common_reg_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_common_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_nvram_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_page0_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ql_set_register_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock. Only called during init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_page1_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ql_set_register_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock. Only called during init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_write_page2_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ql_set_register_page</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">ql_write_common_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispInterruptMaskReg</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">ISP_IMR_ENABLE_INT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">ql_write_common_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispInterruptMaskReg</span><span class="p">,</span>
			    <span class="p">((</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ISP_IMR_ENABLE_INT</span><span class="p">));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_release_to_lrg_buf_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_tail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* The list is empty  */</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_head</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_tail</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_tail</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;failed netdev_alloc_skb()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_skb_check</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We save some space to copy the ethhdr from first</span>
<span class="cm">			 * buffer</span>
<span class="cm">			 */</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">QL_HEADER_SPACE</span><span class="p">);</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					     <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span>
					     <span class="n">QL_HEADER_SPACE</span><span class="p">,</span>
					     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					   <span class="s">&quot;PCI mapping failed with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">err</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_skb_check</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_low</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_high</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span>
					  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span>
					  <span class="n">QL_HEADER_SPACE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="nf">ql_get_from_lrg_buf_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span>
							   <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lrg_buf_cb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_head</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lrg_buf_cb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">addrBits</span> <span class="o">=</span> <span class="n">EEPROM_NO_ADDR_BITS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">dataBits</span> <span class="o">=</span> <span class="n">EEPROM_NO_DATA_BITS</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fm93c56a_deselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">eeprom_readword</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eepromAddr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm93c56a_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">spir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">serialPortInterfaceReg</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">=</span> <span class="n">AUBURN_EEPROM_CS_1</span><span class="p">;</span>
	<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span> <span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span><span class="p">);</span>
	<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm93c56a_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eepromAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dataBit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">previousBit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">spir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">serialPortInterfaceReg</span><span class="p">;</span>

	<span class="cm">/* Clock in a zero, then do the start bit */</span>
	<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
			    <span class="n">AUBURN_EEPROM_DO_1</span><span class="p">));</span>
	<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
			    <span class="n">AUBURN_EEPROM_DO_1</span> <span class="o">|</span> <span class="n">AUBURN_EEPROM_CLK_RISE</span><span class="p">));</span>
	<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
			    <span class="n">AUBURN_EEPROM_DO_1</span> <span class="o">|</span> <span class="n">AUBURN_EEPROM_CLK_FALL</span><span class="p">));</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">FM93C56A_CMD_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Force the previous data bit to be different */</span>
	<span class="n">previousBit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FM93C56A_CMD_BITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dataBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">AUBURN_EEPROM_DO_1</span>
			<span class="o">:</span> <span class="n">AUBURN_EEPROM_DO_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previousBit</span> <span class="o">!=</span> <span class="n">dataBit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If the bit changed, change the DO state to match */</span>
			<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span>
					    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span> <span class="n">dataBit</span><span class="p">));</span>
			<span class="n">previousBit</span> <span class="o">=</span> <span class="n">dataBit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
				    <span class="n">dataBit</span> <span class="o">|</span> <span class="n">AUBURN_EEPROM_CLK_RISE</span><span class="p">));</span>
		<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
				    <span class="n">dataBit</span> <span class="o">|</span> <span class="n">AUBURN_EEPROM_CLK_FALL</span><span class="p">));</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">addrBits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Force the previous data bit to be different */</span>
	<span class="n">previousBit</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">addrBits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dataBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">eepromAddr</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="n">AUBURN_EEPROM_DO_1</span>
			<span class="o">:</span> <span class="n">AUBURN_EEPROM_DO_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">previousBit</span> <span class="o">!=</span> <span class="n">dataBit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the bit changed, then change the DO state to</span>
<span class="cm">			 * match</span>
<span class="cm">			 */</span>
			<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span>
					    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span> <span class="n">dataBit</span><span class="p">));</span>
			<span class="n">previousBit</span> <span class="o">=</span> <span class="n">dataBit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
				    <span class="n">dataBit</span> <span class="o">|</span> <span class="n">AUBURN_EEPROM_CLK_RISE</span><span class="p">));</span>
		<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
				    <span class="n">dataBit</span> <span class="o">|</span> <span class="n">AUBURN_EEPROM_CLK_FALL</span><span class="p">));</span>
		<span class="n">eepromAddr</span> <span class="o">=</span> <span class="n">eepromAddr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm93c56a_deselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">spir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">serialPortInterfaceReg</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">=</span> <span class="n">AUBURN_EEPROM_CS_0</span><span class="p">;</span>
	<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span> <span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fm93c56a_datain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dataBit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">spir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">serialPortInterfaceReg</span><span class="p">;</span>

	<span class="cm">/* Read the data bits */</span>
	<span class="cm">/* The first bit is a dummy.  Clock right over it. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dataBits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
				   <span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
				   <span class="n">AUBURN_EEPROM_CLK_RISE</span><span class="p">);</span>
		<span class="n">ql_write_nvram_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
				   <span class="n">ISP_NVRAM_MASK</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">|</span>
				   <span class="n">AUBURN_EEPROM_CLK_FALL</span><span class="p">);</span>
		<span class="n">dataBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ql_read_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">)</span> <span class="o">&amp;</span>
			   <span class="n">AUBURN_EEPROM_DI_1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">dataBit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeprom_readword</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">eepromAddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fm93c56a_select</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">fm93c56a_cmd</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">FM93C56A_READ</span><span class="p">,</span> <span class="n">eepromAddr</span><span class="p">);</span>
	<span class="n">fm93c56a_datain</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">fm93c56a_deselect</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_nvram_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">pEEPROMData</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="n">pEEPROMData</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">eeprom_cmd_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_NVRAM_SEM_MASK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span>
			 <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Failed ql_sem_spinlock()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">EEPROM_SIZE</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeprom_readword</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">pEEPROMData</span><span class="p">);</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">pEEPROMData</span><span class="p">;</span>
		<span class="n">pEEPROMData</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_NVRAM_SEM_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;checksum should be zero, is %x!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">checksum</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">checksum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">PHYAddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PORT0_PHY_ADDRESS</span><span class="p">,</span> <span class="n">PORT1_PHY_ADDRESS</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_wait_for_mii_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIStatusReg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MAC_MII_STATUS_BSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_mii_enable_scan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scanControl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Auto scan will cycle through multiple ports */</span>
		<span class="n">scanControl</span> <span class="o">=</span> <span class="n">MAC_MII_CONTROL_AS</span> <span class="o">|</span> <span class="n">MAC_MII_CONTROL_SC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scanControl</span> <span class="o">=</span> <span class="n">MAC_MII_CONTROL_SC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Scan register 1 of PHY/PETBI,</span>
<span class="cm">	 * Set up to scan both devices</span>
<span class="cm">	 * The autoscan starts from the first register, completes</span>
<span class="cm">	 * the last one before rolling over to the first</span>
<span class="cm">	 */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtAddrReg</span><span class="p">,</span>
			   <span class="n">PHYAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">MII_SCAN_REGISTER</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">scanControl</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">MAC_MII_CONTROL_SC</span> <span class="o">|</span> <span class="n">MAC_MII_CONTROL_AS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ql_mii_disable_scan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
					<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="cm">/* See if scan mode is enabled before we turn it off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">MAC_MII_CONTROL_AS</span> <span class="o">|</span> <span class="n">MAC_MII_CONTROL_SC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Scan is enabled */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Scan is disabled */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When disabling scan mode you must first change the MII register</span>
<span class="cm">	 * address</span>
<span class="cm">	 */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtAddrReg</span><span class="p">,</span>
			   <span class="n">PHYAddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">MII_SCAN_REGISTER</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">MAC_MII_CONTROL_SC</span> <span class="o">|</span> <span class="n">MAC_MII_CONTROL_AS</span> <span class="o">|</span>
			     <span class="n">MAC_MII_CONTROL_RC</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_mii_write_reg_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">regAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phyAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scanWasEnabled</span><span class="p">;</span>

	<span class="n">scanWasEnabled</span> <span class="o">=</span> <span class="n">ql_mii_disable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtAddrReg</span><span class="p">,</span>
			   <span class="n">phyAddr</span> <span class="o">|</span> <span class="n">regAddr</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtDataReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Wait for write to complete 9/10/04 SJP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scanWasEnabled</span><span class="p">)</span>
		<span class="n">ql_mii_enable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_mii_read_reg_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regAddr</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phyAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scanWasEnabled</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">scanWasEnabled</span> <span class="o">=</span> <span class="n">ql_mii_disable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtAddrReg</span><span class="p">,</span>
			   <span class="n">phyAddr</span> <span class="o">|</span> <span class="n">regAddr</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">MAC_MII_CONTROL_RC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">MAC_MII_CONTROL_RC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAC_MII_CONTROL_RC</span><span class="p">);</span>

	<span class="cm">/* Wait for the read to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtDataReg</span><span class="p">);</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scanWasEnabled</span><span class="p">)</span>
		<span class="n">ql_mii_enable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_mii_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">ql_mii_disable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtAddrReg</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">PHYAddr</span> <span class="o">|</span> <span class="n">regAddr</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtDataReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Wait for write to complete. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_mii_enable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_mii_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regAddr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">ql_mii_disable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtAddrReg</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">PHYAddr</span> <span class="o">|</span> <span class="n">regAddr</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">MAC_MII_CONTROL_RC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">MAC_MII_CONTROL_RC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAC_MII_CONTROL_RC</span><span class="p">);</span>

	<span class="cm">/* Wait for the read to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_mii_ready</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TIMED_OUT_MSG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtDataReg</span><span class="p">);</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">ql_mii_enable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_petbi_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_CONTROL_REG</span><span class="p">,</span> <span class="n">PETBI_CTRL_SOFT_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_petbi_start_neg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Enable Auto-negotiation sense */</span>
	<span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_TBI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PETBI_TBI_AUTO_SENSE</span><span class="p">;</span>
	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_TBI_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_NEG_ADVER</span><span class="p">,</span>
			 <span class="n">PETBI_NEG_PAUSE</span> <span class="o">|</span> <span class="n">PETBI_NEG_DUPLEX</span><span class="p">);</span>

	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_CONTROL_REG</span><span class="p">,</span>
			 <span class="n">PETBI_CTRL_AUTO_NEG</span> <span class="o">|</span> <span class="n">PETBI_CTRL_RESTART_NEG</span> <span class="o">|</span>
			 <span class="n">PETBI_CTRL_FULL_DUPLEX</span> <span class="o">|</span> <span class="n">PETBI_CTRL_SPEED_1000</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_petbi_reset_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_CONTROL_REG</span><span class="p">,</span> <span class="n">PETBI_CTRL_SOFT_RESET</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_petbi_start_neg_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Enable Auto-negotiation sense */</span>
	<span class="n">ql_mii_read_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_TBI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
			   <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PETBI_TBI_AUTO_SENSE</span><span class="p">;</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_TBI_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>

	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_NEG_ADVER</span><span class="p">,</span>
			    <span class="n">PETBI_NEG_PAUSE</span> <span class="o">|</span> <span class="n">PETBI_NEG_DUPLEX</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>

	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_CONTROL_REG</span><span class="p">,</span>
			    <span class="n">PETBI_CTRL_AUTO_NEG</span> <span class="o">|</span> <span class="n">PETBI_CTRL_RESTART_NEG</span> <span class="o">|</span>
			    <span class="n">PETBI_CTRL_FULL_DUPLEX</span> <span class="o">|</span> <span class="n">PETBI_CTRL_SPEED_1000</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_petbi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_petbi_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_petbi_start_neg</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_petbi_init_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_petbi_reset_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_petbi_start_neg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_petbi_neg_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PETBI_NEG_PARTNER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PETBI_NEG_PAUSE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PETBI_NEG_PAUSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">phyAgereSpecificInit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">miiAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;enabling Agere specific PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* power down device bit 11 = 1 */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1940</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* enable diagnostic mode bit 2 = 1 */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x840e</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* 1000MB amplitude adjust (see Agere errata) */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8805</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* 1000MB amplitude adjust (see Agere errata) */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xf03e</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* 100MB amplitude adjust (see Agere errata) */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8806</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* 100MB amplitude adjust (see Agere errata) */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x003e</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* 10MB amplitude adjust (see Agere errata) */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x8807</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* 10MB amplitude adjust (see Agere errata) */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x1f00</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* point to hidden reg 0x2806 */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x2806</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/* Write new PHYAD w/bit 5 set */</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
			    <span class="mh">0x0020</span> <span class="o">|</span> <span class="p">(</span><span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable diagnostic mode bit 2 = 0</span>
<span class="cm">	 * Power up device bit 11 = 0</span>
<span class="cm">	 * Link up (on) and activity (blink)</span>
<span class="cm">	 */</span>
	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x840a</span><span class="p">);</span>
	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1140</span><span class="p">);</span>
	<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xfaf0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">PHY_DEVICE_TYPE</span> <span class="nf">getPhyType</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">phyIdReg0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">phyIdReg1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">PHY_DEVICE_TYPE</span> <span class="n">result</span> <span class="o">=</span> <span class="n">PHY_TYPE_UNKNOWN</span><span class="p">;</span>
	<span class="n">u32</span>   <span class="n">oui</span><span class="p">;</span>
	<span class="n">u16</span>   <span class="n">model</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phyIdReg0</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phyIdReg1</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* oui is split between two registers */</span>
	<span class="n">oui</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyIdReg0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">phyIdReg1</span> <span class="o">&amp;</span> <span class="n">PHY_OUI_1_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">model</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyIdReg1</span> <span class="o">&amp;</span> <span class="n">PHY_MODEL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Scan table for this PHY */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PHY_DEV_TYPES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">oui</span> <span class="o">==</span> <span class="n">PHY_DEVICES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phyIdOUI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">PHY_DEVICES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phyIdModel</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Phy: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">PHY_DEVICES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">PHY_DEVICES</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phyDevice</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_phy_get_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">phyType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_AGERE_ET1011C</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">AUX_CONTROL_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="p">(((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">SPEED_100</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">SPEED_10</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_full_dup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">phyType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PHY_AGERE_ET1011C</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PHY_VITESSE_VSC8211</span>:
	<span class="nl">default:</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">AUX_CONTROL_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PHY_AUX_DUPLEX_STAT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_phy_neg_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_NEG_PARTNER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PHY_NEG_PAUSE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PHY_Setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>   <span class="n">reg1</span><span class="p">;</span>
	<span class="n">u16</span>   <span class="n">reg2</span><span class="p">;</span>
	<span class="n">bool</span>  <span class="n">agereAddrChangeNeeded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">miiAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*  Determine the PHY we are using by reading the ID&#39;s */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_ID_0_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Could not read from reg PHY_ID_0_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_ID_1_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Could not read from reg PHY_ID_1_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Check if we have a Agere PHY */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg1</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg2</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Determine which MII address we should be using</span>
<span class="cm">		   determined by the index of the card */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">miiAddr</span> <span class="o">=</span> <span class="n">MII_AGERE_ADDR_1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">miiAddr</span> <span class="o">=</span> <span class="n">MII_AGERE_ADDR_2</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ql_mii_read_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_ID_0_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg1</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Could not read from reg PHY_ID_0_REG after Agere detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ql_mii_read_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_ID_1_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg2</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Could not read from reg PHY_ID_1_REG after Agere detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*  We need to remember to initialize the Agere PHY */</span>
		<span class="n">agereAddrChangeNeeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Determine the particular PHY we have on board to apply</span>
<span class="cm">	    PHY specific initializations */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">phyType</span> <span class="o">=</span> <span class="n">getPhyType</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">phyType</span> <span class="o">==</span> <span class="n">PHY_AGERE_ET1011C</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">agereAddrChangeNeeded</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* need this here so address gets changed */</span>
		<span class="n">phyAgereSpecificInit</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">miiAddr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">phyType</span> <span class="o">==</span> <span class="n">PHY_TYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;PHY is unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_mac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_PE</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_PE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_PE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_mac_cfg_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_SR</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_SR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_SR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_mac_cfg_gig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_GM</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_GM</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_GM</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_mac_cfg_full_dup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_FD</span> <span class="o">|</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_FD</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAC_CONFIG_REG_FD</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_mac_cfg_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">MAC_CONFIG_REG_TF</span> <span class="o">|</span> <span class="n">MAC_CONFIG_REG_RF</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">MAC_CONFIG_REG_TF</span> <span class="o">|</span> <span class="n">MAC_CONFIG_REG_RF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">MAC_CONFIG_REG_TF</span> <span class="o">|</span> <span class="n">MAC_CONFIG_REG_RF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0ConfigReg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_fiber</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitToCheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_SM0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_SM1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bitToCheck</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_auto_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">ql_mii_read_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_auto_neg_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitToCheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_AC0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_AC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bitToCheck</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Auto-Negotiate complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Auto-Negotiate incomplete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ql_is_neg_pause() returns 1 if pause was negotiated to be on</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_neg_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_is_fiber</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ql_is_petbi_neg_pause</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ql_is_phy_neg_pause</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_auto_neg_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitToCheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_AE0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_AE1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bitToCheck</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_get_link_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_is_fiber</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SPEED_1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ql_phy_get_speed</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_is_link_full_dup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_is_fiber</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ql_is_full_dup</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_link_down_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitToCheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">ISP_CONTROL_LINK_DN_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">ISP_CONTROL_LINK_DN_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span>
	    <span class="n">ql_read_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bitToCheck</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_link_down_detect_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ISP_CONTROL_LINK_DN_0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">ISP_CONTROL_LINK_DN_0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ISP_CONTROL_LINK_DN_1</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">ISP_CONTROL_LINK_DN_1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_this_adapter_controls_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitToCheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_F1_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_F3_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bitToCheck</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="s">&quot;not link master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;link master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_phy_reset_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">CONTROL_REG</span><span class="p">,</span> <span class="n">PHY_CTRL_SOFT_RESET</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_phy_start_neg_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">portConfiguration</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">phyType</span> <span class="o">==</span> <span class="n">PHY_AGERE_ET1011C</span><span class="p">)</span>
		<span class="n">ql_mii_write_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
					<span class="cm">/* turn off external loopback */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">portConfiguration</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">macCfg_port0</span><span class="p">.</span><span class="n">portConfiguration</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">portConfiguration</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">macCfg_port1</span><span class="p">.</span><span class="n">portConfiguration</span><span class="p">;</span>

	<span class="cm">/*  Some HBA&#39;s in the field are set to 0 and they need to</span>
<span class="cm">	    be reinterpreted with a default value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">portConfiguration</span> <span class="o">=</span> <span class="n">PORT_CONFIG_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* Set the 1000 advertisements */</span>
	<span class="n">ql_mii_read_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_GIG_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
			   <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_GIG_ALL_PARAMS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_1000MB_SPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_FULL_DUPLEX_ENABLED</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_GIG_ADV_1000F</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_GIG_ADV_1000H</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_GIG_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>

	<span class="cm">/* Set the 10/100 &amp; pause negotiation advertisements */</span>
	<span class="n">ql_mii_read_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_NEG_ADVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
			   <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PHY_NEG_ALL_PARAMS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_SYM_PAUSE_ENABLED</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_NEG_ASY_PAUSE</span> <span class="o">|</span> <span class="n">PHY_NEG_SYM_PAUSE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_FULL_DUPLEX_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_100MB_SPEED</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_NEG_ADV_100F</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_10MB_SPEED</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_NEG_ADV_10F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_HALF_DUPLEX_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_100MB_SPEED</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_NEG_ADV_100H</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_10MB_SPEED</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PHY_NEG_ADV_10H</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portConfiguration</span> <span class="o">&amp;</span> <span class="n">PORT_CONFIG_1000MB_SPEED</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">PHY_NEG_ADVER</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>

	<span class="n">ql_mii_read_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">CONTROL_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>

	<span class="n">ql_mii_write_reg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">CONTROL_REG</span><span class="p">,</span>
			    <span class="n">reg</span> <span class="o">|</span> <span class="n">PHY_CTRL_RESTART_NEG</span> <span class="o">|</span> <span class="n">PHY_CTRL_AUTO_NEG</span><span class="p">,</span>
			    <span class="n">PHYAddr</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_phy_init_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_phy_reset_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">PHY_Setup</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_phy_start_neg_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_get_link_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bitToCheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">linkState</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_UP0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">bitToCheck</span> <span class="o">=</span> <span class="n">PORT_STATUS_UP1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bitToCheck</span><span class="p">)</span>
		<span class="n">linkState</span> <span class="o">=</span> <span class="n">LS_UP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">linkState</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">linkState</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
		<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span>
			 <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Could not get hw lock for GIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_is_fiber</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ql_petbi_init</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Copper port */</span>
		<span class="n">ql_phy_init_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_finish_auto_neg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
		<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span>
			 <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql_auto_neg_error</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* configure the MAC */</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Configuring link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ql_mac_cfg_soft_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ql_mac_cfg_gig</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">ql_get_link_speed</span>
					<span class="p">(</span><span class="n">qdev</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">SPEED_1000</span><span class="p">));</span>
			<span class="n">ql_mac_cfg_full_dup</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
					    <span class="n">ql_is_link_full_dup</span>
					    <span class="p">(</span><span class="n">qdev</span><span class="p">));</span>
			<span class="n">ql_mac_cfg_pause</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
					 <span class="n">ql_is_neg_pause</span>
					 <span class="p">(</span><span class="n">qdev</span><span class="p">));</span>
			<span class="n">ql_mac_cfg_soft_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* enable the MAC */</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Enabling mac</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ql_mac_enable</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_UP</span><span class="p">;</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Link is up at %d Mbps, %s duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ql_get_link_speed</span><span class="p">(</span><span class="n">qdev</span><span class="p">),</span>
			   <span class="n">ql_is_link_full_dup</span><span class="p">(</span><span class="n">qdev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Remote error detected */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				     <span class="s">&quot;Remote error detected. Calling ql_port_start()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * ql_port_start() is shared code and needs</span>
<span class="cm">			 * to lock the PHY on it&#39;s own.</span>
<span class="cm">			 */</span>
			<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_port_start</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>	<span class="cm">/* Restart port */</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_link_state_machine_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ql3_adapter</span><span class="p">,</span> <span class="n">link_state_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">curr_link_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="n">curr_link_state</span> <span class="o">=</span> <span class="n">ql_get_link_state</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Reset in progress, skip processing link state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

		<span class="cm">/* Restart timer on 2 second interval. */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">ql_port_start</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>
		<span class="cm">/* Fall Through */</span>

	<span class="k">case</span> <span class="n">LS_DOWN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">curr_link_state</span> <span class="o">==</span> <span class="n">LS_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ql_is_auto_neg_complete</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
				<span class="n">ql_finish_auto_neg</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">==</span> <span class="n">LS_UP</span><span class="p">)</span>
				<span class="n">ql_link_down_detect_clear</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_UP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LS_UP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * See if the link is currently down or went down and came</span>
<span class="cm">		 * back up</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr_link_state</span> <span class="o">==</span> <span class="n">LS_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_link_down_detect</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="cm">/* Restart timer on 2 second interval. */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller must take hw_lock and QL_PHY_GIO_SEM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_get_phy_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_this_adapter_controls_port</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller must take hw_lock and QL_PHY_GIO_SEM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_init_scan_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_mii_enable_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_this_adapter_controls_port</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
			<span class="n">ql_petbi_init_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_this_adapter_controls_port</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
			<span class="n">ql_phy_init_ex</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MII_Setup needs to be called before taking the PHY out of reset</span>
<span class="cm"> * so that the management interface clock speed can be set properly.</span>
<span class="cm"> * It would be better if we had a way to disable MDC until after the</span>
<span class="cm"> * PHY is out of reset, but we don&#39;t have that capability.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_mii_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span>
			 <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3032_DEVICE_ID</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span> <span class="mh">0x0f00000</span><span class="p">);</span>

	<span class="cm">/* Divide 125MHz clock by 28 to meet PHY timing requirements */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">MAC_MII_CONTROL_CLK_SEL_DIV28</span><span class="p">;</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macMIIMgmtControlReg</span><span class="p">,</span>
			   <span class="n">reg</span> <span class="o">|</span> <span class="p">((</span><span class="n">MAC_MII_CONTROL_CLK_SEL_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SUPPORTED_OPTICAL_MODES	(SUPPORTED_1000baseT_Full |	\</span>
<span class="cp">				 SUPPORTED_FIBRE |		\</span>
<span class="cp">				 SUPPORTED_Autoneg)</span>
<span class="cp">#define SUPPORTED_TP_MODES	(SUPPORTED_10baseT_Half |	\</span>
<span class="cp">				 SUPPORTED_10baseT_Full |	\</span>
<span class="cp">				 SUPPORTED_100baseT_Half |	\</span>
<span class="cp">				 SUPPORTED_100baseT_Full |	\</span>
<span class="cp">				 SUPPORTED_1000baseT_Half |	\</span>
<span class="cp">				 SUPPORTED_1000baseT_Full |	\</span>
<span class="cp">				 SUPPORTED_Autoneg |		\</span>
<span class="cp">				 SUPPORTED_TP)			\</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_supported_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SUPPORTED_OPTICAL_MODES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">SUPPORTED_TP_MODES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_auto_cfg_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_is_auto_cfg</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_get_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_get_link_speed</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_full_dup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ql_is_link_full_dup</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">ql_supported_modes</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_TP</span><span class="p">;</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">phy_address</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">PHYAddr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">ql_supported_modes</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">ql_get_auto_cfg_status</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">ql_get_speed</span><span class="p">(</span><span class="n">qdev</span><span class="p">));</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">ql_get_full_dup</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">ql3xxx_driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">ql3xxx_driver_version</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">eedump_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ql_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_get_pauseparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_pauseparam</span> <span class="o">*</span><span class="n">pause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0ConfigReg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1ConfigReg</span><span class="p">);</span>

	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">autoneg</span>  <span class="o">=</span> <span class="n">ql_get_auto_cfg_status</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">rx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MAC_CONFIG_REG_RF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pause</span><span class="o">-&gt;</span><span class="n">tx_pause</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">MAC_CONFIG_REG_TF</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ql3xxx_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">ql_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">ql_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">ql_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">ql_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pauseparam</span> <span class="o">=</span> <span class="n">ql_get_pauseparam</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_populate_free_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_head</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span>
				<span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						 <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					      <span class="s">&quot;Failed netdev_alloc_skb()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We save some space to copy the ethhdr from</span>
<span class="cm">				 * first buffer</span>
<span class="cm">				 */</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">QL_HEADER_SPACE</span><span class="p">);</span>
				<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
						     <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span>
						     <span class="n">QL_HEADER_SPACE</span><span class="p">,</span>
						     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

				<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
						   <span class="s">&quot;PCI mapping failed with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">err</span><span class="p">);</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>


				<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_low</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
				<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_high</span> <span class="o">=</span>
					<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
				<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
				<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span>
						  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span>
						  <span class="n">QL_HEADER_SPACE</span><span class="p">);</span>
				<span class="o">--</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_skb_check</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_skb_check</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_update_small_bufq_prod_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_release_cnt</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_release_cnt</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_producer_index</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_producer_index</span> <span class="o">==</span>
			    <span class="n">NUM_SBUFQ_ENTRIES</span><span class="p">)</span>
				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_producer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_release_cnt</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_producer_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">rxSmallQProducerIndex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_update_lrg_bufq_prod_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bufq_addr_element</span> <span class="o">*</span><span class="n">lrg_buf_q_ele</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_count</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_release_cnt</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_skb_check</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql_populate_free_queue</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

		<span class="n">lrg_buf_q_ele</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_next_free</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_release_cnt</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_count</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lrg_buf_cb</span> <span class="o">=</span>
				    <span class="n">ql_get_from_lrg_buf_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
				<span class="n">lrg_buf_q_ele</span><span class="o">-&gt;</span><span class="n">addr_high</span> <span class="o">=</span>
				    <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_high</span><span class="p">;</span>
				<span class="n">lrg_buf_q_ele</span><span class="o">-&gt;</span><span class="n">addr_low</span> <span class="o">=</span>
				    <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_low</span><span class="p">;</span>
				<span class="n">lrg_buf_q_ele</span><span class="o">++</span><span class="p">;</span>

				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_release_cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span> <span class="o">==</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span><span class="p">)</span>
				<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span> <span class="o">==</span>
			    <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">lrg_buf_q_ele</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_virt_addr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_next_free</span> <span class="o">=</span> <span class="n">lrg_buf_q_ele</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">rxLargeQProducerIndex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ob_mac_iocb_rsp</span> <span class="o">*</span><span class="n">mac_rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_tx_buf_cb</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OB_MAC_IOCB_RSP_S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			    <span class="s">&quot;Frame too short but it was padded and sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tx_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">transaction_id</span><span class="p">];</span>

	<span class="cm">/*  Check the transmit response flags for any errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OB_MAC_IOCB_RSP_S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Frame too short to be legal, frame not sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">frame_not_sent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;tx_cb-&gt;seg_count == 0: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mac_rsp</span><span class="o">-&gt;</span><span class="n">transaction_id</span><span class="p">);</span>

		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">invalid_seg_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">),</span>
			 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maplen</span><span class="p">),</span>
			 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						      <span class="n">mapaddr</span><span class="p">),</span>
				       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">maplen</span><span class="p">),</span>
				       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="nl">frame_not_sent:</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">invalid_seg_count:</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_get_sbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_index</span> <span class="o">==</span> <span class="n">NUM_SMALL_BUFFERS</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_release_cnt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="nf">ql_get_lbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_index</span><span class="p">];</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_release_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_index</span> <span class="o">==</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_large_buffers</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lrg_buf_cb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The difference between 3022 and 3032 for inbound completions:</span>
<span class="cm"> * 3022 uses two buffers per completion.  The first buffer contains</span>
<span class="cm"> * (some) header info, the second the remainder of the headers plus</span>
<span class="cm"> * the data.  For this chip we reserve some space at the top of the</span>
<span class="cm"> * receive buffer so that the header info in buffer one can be</span>
<span class="cm"> * prepended to the buffer two.  Buffer two is the sent up while</span>
<span class="cm"> * buffer one is returned to the hardware to be reused.</span>
<span class="cm"> * 3032 receives all of it&#39;s data and headers in one buffer for a</span>
<span class="cm"> * simpler process.  3032 also supports checksum verification as</span>
<span class="cm"> * can be seen in ql_process_macip_rx_intr().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_mac_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="n">ib_mac_rsp_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ib_mac_rsp_ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the inbound address list (small buffer).</span>
<span class="cm">	 */</span>
	<span class="n">ql_get_sbuf</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)</span>
		<span class="n">lrg_buf_cb1</span> <span class="o">=</span> <span class="n">ql_get_lbuf</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="cm">/* start of second buffer */</span>
	<span class="n">lrg_buf_cb2</span> <span class="o">=</span> <span class="n">ql_get_lbuf</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">lrg_buf_cb2</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">lrg_buf_cb2</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
			 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">lrg_buf_cb2</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">lrg_buf_cb2</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)</span>
		<span class="n">ql_release_to_lrg_buf_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">lrg_buf_cb1</span><span class="p">);</span>
	<span class="n">ql_release_to_lrg_buf_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">lrg_buf_cb2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_process_macip_rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ib_ip_iocb_rsp</span> <span class="o">*</span><span class="n">ib_ip_rsp_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ib_ip_rsp_ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the inbound address list (small buffer).</span>
<span class="cm">	 */</span>

	<span class="n">ql_get_sbuf</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start of first buffer on 3022 */</span>
		<span class="n">lrg_buf_cb1</span> <span class="o">=</span> <span class="n">ql_get_lbuf</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="n">skb1</span> <span class="o">=</span> <span class="n">lrg_buf_cb1</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb1</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">VLAN_ETH_HLEN</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start of second buffer */</span>
	<span class="n">lrg_buf_cb2</span> <span class="o">=</span> <span class="n">ql_get_lbuf</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">skb2</span> <span class="o">=</span> <span class="n">lrg_buf_cb2</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>	<span class="cm">/* Just the second buffer length here. */</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">lrg_buf_cb2</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
			 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">lrg_buf_cb2</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">skb2</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Copy the ethhdr from first buffer to second. This</span>
<span class="cm">		 * is necessary for 3022 IP completions.</span>
<span class="cm">		 */</span>
		<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb1</span><span class="p">,</span> <span class="n">VLAN_ID_LEN</span><span class="p">,</span>
						 <span class="n">skb_push</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">checksum</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ib_ip_rsp_ptr</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">IB_IP_IOCB_RSP_3032_ICE</span> <span class="o">|</span>
			 <span class="n">IB_IP_IOCB_RSP_3032_CE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;%s: Bad checksum for this %s packet, checksum = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span>
				   <span class="p">((</span><span class="n">checksum</span> <span class="o">&amp;</span> <span class="n">IB_IP_IOCB_RSP_3032_TCP</span><span class="p">)</span> <span class="o">?</span>
				    <span class="s">&quot;TCP&quot;</span> <span class="o">:</span> <span class="s">&quot;UDP&quot;</span><span class="p">),</span> <span class="n">checksum</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">checksum</span> <span class="o">&amp;</span> <span class="n">IB_IP_IOCB_RSP_3032_TCP</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">checksum</span> <span class="o">&amp;</span> <span class="n">IB_IP_IOCB_RSP_3032_UDP</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">checksum</span> <span class="o">&amp;</span> <span class="n">IB_IP_IOCB_RSP_3032_NUC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">skb2</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">skb2</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb2</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">lrg_buf_cb2</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)</span>
		<span class="n">ql_release_to_lrg_buf_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">lrg_buf_cb1</span><span class="p">);</span>
	<span class="n">ql_release_to_lrg_buf_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">lrg_buf_cb2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_tx_rx_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">tx_cleaned</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rx_cleaned</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_rsp_iocb</span> <span class="o">*</span><span class="n">net_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* While there are entries in the completion queue. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">prsp_producer_index</span><span class="p">))</span> <span class="o">!=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_consumer_index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">work_to_do</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">net_rsp</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_current</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fix 4032 chip&#39;s undocumented &quot;feature&quot; where bit-8 is set</span>
<span class="cm">		 * if the inbound completion is for a VLAN.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3032_DEVICE_ID</span><span class="p">)</span>
			<span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">OPCODE_OB_MAC_IOCB_FN0</span>:
		<span class="k">case</span> <span class="n">OPCODE_OB_MAC_IOCB_FN2</span>:
			<span class="n">ql_process_mac_tx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_iocb_rsp</span> <span class="o">*</span><span class="p">)</span>
					       <span class="n">net_rsp</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">tx_cleaned</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OPCODE_IB_MAC_IOCB</span>:
		<span class="k">case</span> <span class="n">OPCODE_IB_3032_MAC_IOCB</span>:
			<span class="n">ql_process_mac_rx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ib_mac_iocb_rsp</span> <span class="o">*</span><span class="p">)</span>
					       <span class="n">net_rsp</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">rx_cleaned</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OPCODE_IB_IP_IOCB</span>:
		<span class="k">case</span> <span class="n">OPCODE_IB_3032_IP_IOCB</span>:
			<span class="n">ql_process_macip_rx_intr</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ib_ip_iocb_rsp</span> <span class="o">*</span><span class="p">)</span>
						 <span class="n">net_rsp</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="n">rx_cleaned</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">net_rsp</span><span class="p">;</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Hit default case, not handled!</span><span class="se">\n</span><span class="s">&quot;</span>
				   <span class="s">&quot;	dropping the packet, opcode = %x</span><span class="se">\n</span><span class="s">&quot;</span>
				   <span class="s">&quot;0x%08lx 0x%08lx 0x%08lx 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">net_rsp</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_consumer_index</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_consumer_index</span> <span class="o">==</span> <span class="n">NUM_RSP_Q_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_consumer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_current</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_current</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">work_done</span> <span class="o">=</span> <span class="o">*</span><span class="n">tx_cleaned</span> <span class="o">+</span> <span class="o">*</span><span class="n">rx_cleaned</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ql3_adapter</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rx_cleaned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_cleaned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="n">ql_tx_rx_clean</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_cleaned</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_cleaned</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_cleaned</span> <span class="o">+</span> <span class="n">rx_cleaned</span> <span class="o">!=</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="n">__napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">ql_update_small_bufq_prod_index</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="n">ql_update_lrg_bufq_prod_index</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_consumer_index</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">rspQConsumerIndex</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

		<span class="n">ql_enable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tx_cleaned</span> <span class="o">+</span> <span class="n">rx_cleaned</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ql3xxx_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">var</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read_common_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISP_CONTROL_FE</span> <span class="o">|</span> <span class="n">ISP_CONTROL_RI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_lock</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">ql_disable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_FE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Chip Fatal Error.</span>
<span class="cm">			 */</span>
			<span class="n">var</span> <span class="o">=</span>
			    <span class="n">ql_read_page0_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">PortFatalErrStatus</span><span class="p">);</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				    <span class="s">&quot;Resetting chip. PortFatalErrStatus register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">var</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_RESET_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Soft Reset Requested.</span>
<span class="cm">			 */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_RESET_PER_SCSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Another function issued a reset to the chip. ISR value = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_IMR_DISABLE_CMPL_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ql_disable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)))</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the total number of segments needed for the given number of fragments.</span>
<span class="cm"> * This is necessary because outbound address lists (OAL) will be used when</span>
<span class="cm"> * more than two frags are given.  Each address list has 5 addr/len pairs.</span>
<span class="cm"> * The 5th pair in each OAL is used to  point to the next OAL if more frags</span>
<span class="cm"> * are coming.  That is why the frags:segment count ratio is not linear.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_get_seg_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">frags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3022_DEVICE_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">frags</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">frags</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">frags</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&lt;=</span> <span class="mi">18</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">frags</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_hw_csum_setup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">ip_hdr_off</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">ip_hdr_len</span> <span class="o">=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ihl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="n">OB_3032MAC_IOCB_REQ_TC</span> <span class="o">|</span>
			<span class="n">OB_3032MAC_IOCB_REQ_IC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags1</span> <span class="o">|=</span> <span class="n">OB_3032MAC_IOCB_REQ_UC</span> <span class="o">|</span>
			<span class="n">OB_3032MAC_IOCB_REQ_IC</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map the buffers for this transmit.</span>
<span class="cm"> * This will return NETDEV_TX_BUSY or NETDEV_TX_OK based on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_send_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ql_tx_buf_cb</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oal</span> <span class="o">*</span><span class="n">oal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">oal_entry</span> <span class="o">*</span><span class="n">oal_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">completed_segs</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">seg_cnt</span><span class="p">,</span> <span class="n">seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>

	<span class="n">seg_cnt</span> <span class="o">=</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Map the skb buffer first.</span>
<span class="cm">	 */</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;PCI mapping failed with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">err</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">oal_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">oal_entry</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">buf_addr0_low</span><span class="p">;</span>
	<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">dma_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
	<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">dma_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
	<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">seg</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seg_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Terminate the last segment. */</span>
		<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">OAL_LAST_ENTRY</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">oal</span> <span class="o">=</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">oal</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">completed_segs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">completed_segs</span> <span class="o">&lt;</span> <span class="n">frag_cnt</span><span class="p">;</span>
	     <span class="n">completed_segs</span><span class="o">++</span><span class="p">,</span> <span class="n">seg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">completed_segs</span><span class="p">];</span>
		<span class="n">oal_entry</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check for continuation requirements.</span>
<span class="cm">		 * It&#39;s strange but necessary.</span>
<span class="cm">		 * Continuation entry points to outbound address list.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">17</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">oal</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">oal</span><span class="p">),</span>
					     <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					   <span class="s">&quot;PCI mapping outbound address list with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">map_error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">dma_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
			<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">dma_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
			<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">oal</span><span class="p">)</span> <span class="o">|</span>
						     <span class="n">OAL_CONT_ENTRY</span><span class="p">);</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">maplen</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">oal</span><span class="p">));</span>
			<span class="n">oal_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">oal_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">oal</span><span class="p">;</span>
			<span class="n">oal</span><span class="o">++</span><span class="p">;</span>
			<span class="n">seg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">map</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;PCI mapping frags failed with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">map_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">dma_lo</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
		<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">dma_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
		<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
		<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">maplen</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="cm">/* Terminate the last segment. */</span>
	<span class="n">oal_entry</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">OAL_LAST_ENTRY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">map_error:</span>
	<span class="cm">/* A PCI mapping failed and now we will need to back out</span>
<span class="cm">	 * We need to traverse through the oal&#39;s and associated pages which</span>
<span class="cm">	 * have been mapped and now we must unmap them to clean up properly</span>
<span class="cm">	 */</span>

	<span class="n">seg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">oal_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">oal_entry</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">buf_addr0_low</span><span class="p">;</span>
	<span class="n">oal</span> <span class="o">=</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">oal</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">completed_segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">seg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oal_entry</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check for continuation requirements.</span>
<span class="cm">		 * It&#39;s strange but necessary.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">17</span> <span class="o">&amp;&amp;</span> <span class="n">seg_cnt</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">),</span>
				<span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">maplen</span><span class="p">),</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">oal</span><span class="o">++</span><span class="p">;</span>
			<span class="n">seg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">),</span>
			       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">seg</span><span class="p">],</span> <span class="n">maplen</span><span class="p">),</span>
			       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mapaddr</span><span class="p">),</span>
			 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maplen</span><span class="p">),</span>
			 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The difference between 3022 and 3032 sends:</span>
<span class="cm"> * 3022 only supports a simple single segment transmission.</span>
<span class="cm"> * 3032 supports checksumming and scatter/gather lists (fragments).</span>
<span class="cm"> * The 3032 supports sglists by using the 3 addr/len pairs (ALP)</span>
<span class="cm"> * in the IOCB plus a chain of outbound address lists (OAL) that</span>
<span class="cm"> * each contain 5 ALPs.  The last ALP of the IOCB (3rd) or OAL (5th)</span>
<span class="cm"> * will be used to point to an OAL when more ALP entries are required.</span>
<span class="cm"> * The IOCB is always the top of the chain followed by one or more</span>
<span class="cm"> * OALs (when necessary).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ql3xxx_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_tx_buf_cb</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tot_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">mac_iocb_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="n">tx_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span><span class="p">];</span>
	<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span> <span class="o">=</span> <span class="n">ql_get_seg_count</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
					     <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;%s: invalid segment count!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_iocb_ptr</span> <span class="o">=</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">queue_entry</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mac_iocb_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_iocb_req</span><span class="p">));</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_ob_opcode</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">OB_MAC_IOCB_REQ_X</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mb_bit_mask</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">transaction_id</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span><span class="p">;</span>
	<span class="n">mac_iocb_ptr</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">tot_len</span><span class="p">);</span>
	<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3032_DEVICE_ID</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="n">ql_hw_csum_setup</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">mac_iocb_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_send_map</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">mac_iocb_ptr</span><span class="p">,</span> <span class="n">tx_cb</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NETDEV_TX_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;%s: Could not map the segments!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span> <span class="o">==</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ql_write_common_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">reqQProducerIndex</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span>
		     <span class="s">&quot;tx queued, slot %d, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_net_req_rsp_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_size</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">NUM_REQ_Q_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ob_mac_iocb_req</span><span class="p">));</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_virt_addr</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_size</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_virt_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_phy_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;reqQ failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_size</span> <span class="o">=</span> <span class="n">NUM_RSP_Q_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_rsp_iocb</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span> <span class="o">=</span>
	    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_size</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_phy_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;rspQ allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_size</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_virt_addr</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_phy_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ALLOC_REQ_RSP_Q_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_net_req_rsp_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ALLOC_REQ_RSP_Q_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Already done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_size</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_virt_addr</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_phy_addr</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_virt_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_size</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_phy_addr</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ALLOC_REQ_RSP_Q_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_buffer_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Create Large Buffer Queue */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_size</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lrg_buf_q_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_size</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_large_buffers</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;qdev-&gt;lrg_buf alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_virt_addr</span> <span class="o">=</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_size</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_virt_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;lBufQ failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_virt_addr</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_virt_addr</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_phy_addr</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_phy_addr</span><span class="p">;</span>

	<span class="cm">/* Create Small Buffer Queue */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_size</span> <span class="o">=</span>
		<span class="n">NUM_SBUFQ_ENTRIES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lrg_buf_q_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_size</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_virt_addr</span> <span class="o">=</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_size</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_virt_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Small Buffer Queue allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_size</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_virt_addr</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_phy_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_virt_addr</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_virt_addr</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_phy_addr</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_phy_addr</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ALLOC_BUFQS_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_buffer_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ALLOC_BUFQS_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Already done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_size</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_virt_addr</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_alloc_phy_addr</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_virt_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_size</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_virt_addr</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_alloc_phy_addr</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_virt_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ALLOC_BUFQS_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_small_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bufq_addr_element</span> <span class="o">*</span><span class="n">small_buf_q_entry</span><span class="p">;</span>

	<span class="cm">/* Currently we allocate on one of memory and use it for smallbuffers */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_total_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">QL_ADDR_ELE_PER_BUFQ_ENTRY</span> <span class="o">*</span> <span class="n">NUM_SBUFQ_ENTRIES</span> <span class="o">*</span>
		 <span class="n">QL_SMALL_BUFFER_SIZE</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_virt_addr</span> <span class="o">=</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_total_size</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_virt_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Failed to get small buffer memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr_low</span> <span class="o">=</span> <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr_high</span> <span class="o">=</span> <span class="n">MS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr</span><span class="p">);</span>

	<span class="n">small_buf_q_entry</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_virt_addr</span><span class="p">;</span>

	<span class="cm">/* Initialize the small buffer queue. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">QL_ADDR_ELE_PER_BUFQ_ENTRY</span> <span class="o">*</span> <span class="n">NUM_SBUFQ_ENTRIES</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">small_buf_q_entry</span><span class="o">-&gt;</span><span class="n">addr_high</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr_high</span><span class="p">);</span>
		<span class="n">small_buf_q_entry</span><span class="o">-&gt;</span><span class="n">addr_low</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr_low</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">QL_SMALL_BUFFER_SIZE</span><span class="p">));</span>
		<span class="n">small_buf_q_entry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ALLOC_SMALL_BUF_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_small_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ALLOC_SMALL_BUF_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Already done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_virt_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_total_size</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_virt_addr</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_phy_addr</span><span class="p">);</span>

		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_virt_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_large_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_large_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">),</span>
					 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">maplen</span><span class="p">),</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_init_large_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bufq_addr_element</span> <span class="o">*</span><span class="n">buf_addr_ele</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_virt_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_large_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">buf_addr_ele</span><span class="o">-&gt;</span><span class="n">addr_high</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_high</span><span class="p">;</span>
		<span class="n">buf_addr_ele</span><span class="o">-&gt;</span><span class="n">addr_low</span> <span class="o">=</span> <span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_low</span><span class="p">;</span>
		<span class="n">buf_addr_ele</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_skb_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_large_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span> <span class="o">*</span><span class="n">lrg_buf_cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_large_buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				       <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Better luck next round */</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;large buff alloc failed for %d bytes at index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ql_free_large_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">lrg_buf_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql_rcv_buf_cb</span><span class="p">));</span>
			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * We save some space to copy the ethhdr from first</span>
<span class="cm">			 * buffer</span>
<span class="cm">			 */</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">QL_HEADER_SPACE</span><span class="p">);</span>
			<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					     <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span>
					     <span class="n">QL_HEADER_SPACE</span><span class="p">,</span>
					     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
					   <span class="s">&quot;PCI mapping failed with error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">err</span><span class="p">);</span>
				<span class="n">ql_free_large_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">mapaddr</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
			<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">lrg_buf_cb</span><span class="p">,</span> <span class="n">maplen</span><span class="p">,</span>
					  <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span>
					  <span class="n">QL_HEADER_SPACE</span><span class="p">);</span>
			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_low</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
			<span class="n">lrg_buf_cb</span><span class="o">-&gt;</span><span class="n">buf_phy_addr_high</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MS_64BITS</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_send_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_tx_buf_cb</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tx_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">oal</span><span class="p">);</span>
		<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">oal</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tx_cb</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_create_send_free_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql_tx_buf_cb</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ob_mac_iocb_req</span> <span class="o">*</span><span class="n">req_q_curr</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_virt_addr</span><span class="p">;</span>

	<span class="cm">/* Create free list of transmit buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">tx_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">queue_entry</span> <span class="o">=</span> <span class="n">req_q_curr</span><span class="p">;</span>
		<span class="n">req_q_curr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">oal</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">oal</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_alloc_mem_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">==</span> <span class="n">NORMAL_MTU_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span> <span class="o">=</span> <span class="n">NUM_LBUFQ_ENTRIES</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">=</span> <span class="n">NORMAL_MTU_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">==</span> <span class="n">JUMBO_MTU_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Bigger buffers, so less of them.</span>
<span class="cm">		 */</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span> <span class="o">=</span> <span class="n">JUMBO_NUM_LBUFQ_ENTRIES</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">=</span> <span class="n">JUMBO_MTU_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Invalid mtu size: %d.  Only %d and %d are accepted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">,</span> <span class="n">NORMAL_MTU_SIZE</span><span class="p">,</span> <span class="n">JUMBO_MTU_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_large_buffers</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span> <span class="o">*</span> <span class="n">QL_ADDR_ELE_PER_BUFQ_ENTRY</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">+=</span> <span class="n">VLAN_ETH_HLEN</span> <span class="o">+</span> <span class="n">VLAN_ID_LEN</span> <span class="o">+</span> <span class="n">QL_HEADER_SPACE</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span> <span class="o">-</span> <span class="n">QL_HEADER_SPACE</span><span class="p">)</span> <span class="o">+</span> <span class="n">ETHERNET_CRC_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First allocate a page of shared memory and use it for shadow</span>
<span class="cm">	 * locations of Network Request Queue Consumer Address Register and</span>
<span class="cm">	 * Network Completion Queue Producer Index Register</span>
<span class="cm">	 */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span> <span class="o">=</span>
		<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				     <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_phy_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">preq_consumer_index</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_consumer_index_phy_addr_high</span> <span class="o">=</span>
			<span class="n">MS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_phy_addr</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_consumer_index_phy_addr_low</span> <span class="o">=</span>
			<span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_phy_addr</span><span class="p">);</span>

		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">prsp_producer_index</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">preq_consumer_index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_producer_index_phy_addr_high</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_consumer_index_phy_addr_high</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_producer_index_phy_addr_low</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_consumer_index_phy_addr_low</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;shadowReg Alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_net_req_rsp_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;ql_alloc_net_req_rsp_queues failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_req_rsp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_buffer_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;ql_alloc_buffer_queues failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_buffer_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_small_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;ql_alloc_small_buffers failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_small_buffers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_large_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;ql_alloc_large_buffers failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_small_buffers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the large buffer queue. */</span>
	<span class="n">ql_init_large_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_create_send_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free_list</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_current</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_free_list:</span>
	<span class="n">ql_free_send_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="nl">err_small_buffers:</span>
	<span class="n">ql_free_buffer_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="nl">err_buffer_queues:</span>
	<span class="n">ql_free_net_req_rsp_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="nl">err_req_rsp:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">PAGE_SIZE</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_phy_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_free_mem_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_free_send_free_list</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_free_large_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_free_small_buffers</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_free_buffer_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_free_net_req_rsp_queues</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span><span class="p">,</span>
				    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_phy_addr</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">shadow_reg_virt_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_init_misc_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_local_ram_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">local_ram</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DDR_RAM_SEM_MASK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span>
			 <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">bufletSize</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">bufletSize</span><span class="p">);</span>

	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">maxBufletCount</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">bufletCount</span><span class="p">);</span>

	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">freeBufletThresholdLow</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpWindowThreshold25</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpWindowThreshold0</span><span class="p">));</span>

	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">freeBufletThresholdHigh</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpWindowThreshold50</span><span class="p">);</span>

	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">ipHashTableBase</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">ipHashTableBaseHi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">ipHashTableBaseLo</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">ipHashTableCount</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">ipHashTableSize</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">tcpHashTableBase</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpHashTableBaseHi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpHashTableBaseLo</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">tcpHashTableCount</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpHashTableSize</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">ncbBase</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">ncbTableBaseHi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">ncbTableBaseLo</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">maxNcbCount</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">ncbTableSize</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">drbBase</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">drbTableBaseHi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">drbTableBaseLo</span><span class="p">);</span>
	<span class="n">ql_write_page2_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">local_ram</span><span class="o">-&gt;</span><span class="n">maxDrbCount</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">drbTableSize</span><span class="p">);</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DDR_RAM_SEM_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="n">u32</span> <span class="o">*</span><span class="n">spir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">serialPortInterfaceReg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_host_memory_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hmem_regs</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">port_regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_mii_setup</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Bring out PHY out of reset */</span>
	<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">ISP_SERIAL_PORT_IF_WE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">ISP_SERIAL_PORT_IF_WE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>
	<span class="cm">/* Give the PHY time to come out of reset. */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* V2 chip fix for ARS-39168. */</span>
	<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">spir</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">ISP_SERIAL_PORT_IF_SDE</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">ISP_SERIAL_PORT_IF_SDE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)));</span>

	<span class="cm">/* Request Queue Registers */</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">preq_consumer_index</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">,</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_producer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">reqConsumerIndexAddrHigh</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_consumer_index_phy_addr_high</span><span class="p">);</span>
	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">reqConsumerIndexAddrLow</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_consumer_index_phy_addr_low</span><span class="p">);</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">reqBaseAddrHigh</span><span class="p">,</span>
			   <span class="n">MS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_phy_addr</span><span class="p">));</span>
	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">reqBaseAddrLow</span><span class="p">,</span>
			   <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">req_q_phy_addr</span><span class="p">));</span>
	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">reqLength</span><span class="p">,</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">);</span>

	<span class="cm">/* Response Queue Registers */</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">prsp_producer_index</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_consumer_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_current</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_virt_addr</span><span class="p">;</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rspProducerIndexAddrHigh</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_producer_index_phy_addr_high</span><span class="p">);</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rspProducerIndexAddrLow</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_producer_index_phy_addr_low</span><span class="p">);</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rspBaseAddrHigh</span><span class="p">,</span>
			   <span class="n">MS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_phy_addr</span><span class="p">));</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rspBaseAddrLow</span><span class="p">,</span>
			   <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">rsp_q_phy_addr</span><span class="p">));</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rspLength</span><span class="p">,</span> <span class="n">NUM_RSP_Q_ENTRIES</span><span class="p">);</span>

	<span class="cm">/* Large Buffer Queue */</span>
	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxLargeQBaseAddrHigh</span><span class="p">,</span>
			   <span class="n">MS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_phy_addr</span><span class="p">));</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxLargeQBaseAddrLow</span><span class="p">,</span>
			   <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_phy_addr</span><span class="p">));</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxLargeQLength</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span><span class="p">);</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxLargeBufferLength</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buffer_len</span><span class="p">);</span>

	<span class="cm">/* Small Buffer Queue */</span>
	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxSmallQBaseAddrHigh</span><span class="p">,</span>
			   <span class="n">MS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_phy_addr</span><span class="p">));</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxSmallQBaseAddrLow</span><span class="p">,</span>
			   <span class="n">LS_64BITS</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_phy_addr</span><span class="p">));</span>

	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxSmallQLength</span><span class="p">,</span> <span class="n">NUM_SBUFQ_ENTRIES</span><span class="p">);</span>
	<span class="n">ql_write_page1_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">hmem_regs</span><span class="o">-&gt;</span><span class="n">rxSmallBufferLength</span><span class="p">,</span>
			   <span class="n">QL_SMALL_BUFFER_SIZE</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_producer_index</span> <span class="o">=</span> <span class="n">NUM_SBUFQ_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_release_cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">num_lbufq_entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_release_cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_next_free</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_virt_addr</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_free_tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>
			    <span class="n">rxSmallQProducerIndex</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">small_buf_q_producer_index</span><span class="p">);</span>
	<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>
			    <span class="n">rxLargeQProducerIndex</span><span class="p">,</span>
			    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">lrg_buf_q_producer_index</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find out if the chip has already been initialized.  If it has, then</span>
<span class="cm">	 * we skip some of the initialization.</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_IC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Chip has not been configured yet, so let it rip. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_init_misc_registers</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">tcpMaxWindowSize</span><span class="p">;</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">tcpMaxWindow</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">extHwConfig</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_FLASH_SEM_MASK</span><span class="p">,</span>
				<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
				 <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">ExternalHWConfig</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">InternalChipConfig</span><span class="p">,</span>
				   <span class="p">(((</span><span class="n">INTERNAL_CHIP_SD</span> <span class="o">|</span> <span class="n">INTERNAL_CHIP_WE</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				     <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">INTERNAL_CHIP_SD</span> <span class="o">|</span>
					    <span class="n">INTERNAL_CHIP_WE</span><span class="p">)));</span>
		<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_FLASH_SEM_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac1MaxFrameLengthReg</span><span class="p">,</span>
				   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">mac0MaxFrameLengthReg</span><span class="p">,</span>
					   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_sem_spinlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">,</span>
			<span class="p">(</span><span class="n">QL_RESOURCE_BITS_BASE_CODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="o">*</span>
			 <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PHY_Setup</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_init_scan_mode</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="n">ql_get_phy_owner</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="cm">/* Load the MAC Configuration */</span>

	<span class="cm">/* Program lower 32 bits of the MAC address */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrIndirectPtrReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">MAC_ADDR_INDIRECT_PTR_REG_RP_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrDataReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			    <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>

	<span class="cm">/* Program top 16 bits of the MAC address */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrIndirectPtrReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">MAC_ADDR_INDIRECT_PTR_REG_RP_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrDataReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			    <span class="o">|</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

	<span class="cm">/* Enable Primary MAC */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrIndirectPtrReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">MAC_ADDR_INDIRECT_PTR_REG_PE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">MAC_ADDR_INDIRECT_PTR_REG_PE</span><span class="p">));</span>

	<span class="cm">/* Clear Primary and Secondary IP addresses */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">ipAddrIndexReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">IP_ADDR_INDEX_REG_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">ipAddrDataReg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">ipAddrIndexReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">IP_ADDR_INDEX_REG_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">ipAddrDataReg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_PHY_GIO_SEM_MASK</span><span class="p">);</span>

	<span class="cm">/* Indicate Configuration Complete */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portControl</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">PORT_CONTROL_CC</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">PORT_CONTROL_CC</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_IC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">delay</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Hw Initialization timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Ethernet Function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3032_DEVICE_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">QL3032_PORT_CONTROL_EF</span> <span class="o">|</span> <span class="n">QL3032_PORT_CONTROL_KIE</span> <span class="o">|</span>
		     <span class="n">QL3032_PORT_CONTROL_EIv6</span> <span class="o">|</span> <span class="n">QL3032_PORT_CONTROL_EIv4</span> <span class="o">|</span>
			<span class="n">QL3032_PORT_CONTROL_ET</span><span class="p">);</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">functionControl</span><span class="p">,</span>
				   <span class="p">((</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">PORT_CONTROL_EF</span> <span class="o">|</span> <span class="n">PORT_CONTROL_ET</span> <span class="o">|</span> <span class="n">PORT_CONTROL_EI</span> <span class="o">|</span>
		     <span class="n">PORT_CONTROL_HH</span><span class="p">);</span>
		<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portControl</span><span class="p">,</span>
				   <span class="p">((</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">));</span>
	<span class="p">}</span>


<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Caller holds hw_lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_wait_time</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Issue soft reset to chip.</span>
<span class="cm">	 */</span>
	<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Issue soft reset to chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">,</span>
			    <span class="p">((</span><span class="n">ISP_CONTROL_SR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ISP_CONTROL_SR</span><span class="p">));</span>

	<span class="cm">/* Wait 3 seconds for reset to complete. */</span>
	<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
		      <span class="s">&quot;Wait 10 milliseconds for reset to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait until the firmware tells us the Soft Reset is done */</span>
	<span class="n">max_wait_time</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span>
		    <span class="n">ql_read_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_SR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">max_wait_time</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Also, make sure that the Network Reset Interrupt bit has been</span>
<span class="cm">	 * cleared after the soft reset has taken place.</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span>
	    <span class="n">ql_read_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_RI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			      <span class="s">&quot;clearing RI after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>
				    <span class="n">ispControlStatus</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">ISP_CONTROL_RI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ISP_CONTROL_RI</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_wait_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Issue Force Soft Reset */</span>
		<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>
				    <span class="n">ispControlStatus</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">ISP_CONTROL_FSR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">ISP_CONTROL_FSR</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait until the firmware tells us the Force Soft Reset is</span>
<span class="cm">		 * done</span>
<span class="cm">		 */</span>
		<span class="n">max_wait_time</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>
						   <span class="n">ispControlStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_FSR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">max_wait_time</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_wait_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_RESET_DONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_set_mac_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">port_status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func_number</span><span class="p">;</span>

	<span class="cm">/* Get the function number */</span>
	<span class="n">value</span> <span class="o">=</span>
	    <span class="n">ql_read_common_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span><span class="n">ispControlStatus</span><span class="p">);</span>
	<span class="n">func_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OPCODE_FUNC_ID_MASK</span><span class="p">);</span>
	<span class="n">port_status</span> <span class="o">=</span> <span class="n">ql_read_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_FN_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_CONTROL_FN0_NET</span>:
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_ob_opcode</span> <span class="o">=</span> <span class="n">OUTBOUND_MAC_IOCB</span> <span class="o">|</span> <span class="n">func_number</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mb_bit_mask</span> <span class="o">=</span> <span class="n">FN0_MA_BITS_MASK</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">PHYAddr</span> <span class="o">=</span> <span class="n">PORT0_PHY_ADDRESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_SM0</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_CONTROL_FN1_NET</span>:
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_ob_opcode</span> <span class="o">=</span> <span class="n">OUTBOUND_MAC_IOCB</span> <span class="o">|</span> <span class="n">func_number</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mb_bit_mask</span> <span class="o">=</span> <span class="n">FN1_MA_BITS_MASK</span><span class="p">;</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">PHYAddr</span> <span class="o">=</span> <span class="n">PORT1_PHY_ADDRESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_status</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_SM1</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_CONTROL_FN0_SCSI</span>:
	<span class="k">case</span> <span class="n">ISP_CONTROL_FN1_SCSI</span>:
	<span class="nl">default:</span>
		<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			      <span class="s">&quot;Invalid function number, ispControlStatus = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">numPorts</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">version_and_numPorts</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_display_dev_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
		    <span class="s">&quot;%s Adapter %d RevisionID %d found %s on PCI slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span><span class="p">,</span>
		    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3032_DEVICE_ID</span> <span class="o">?</span> <span class="s">&quot;QLA3032&quot;</span> <span class="o">:</span> <span class="s">&quot;QLA3022&quot;</span><span class="p">,</span>
		    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_slot</span><span class="p">);</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;%s Interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">QL_LINK_OPTICAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;OPTICAL&quot;</span> <span class="o">:</span> <span class="s">&quot;COPPER&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Print PCI bus width/type.</span>
<span class="cm">	 */</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Bus interface is %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_width</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;64-bit&quot;</span> <span class="o">:</span> <span class="s">&quot;32-bit&quot;</span><span class="p">),</span>
		    <span class="p">((</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_x</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PCI-X&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI&quot;</span><span class="p">));</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;mem  IO base address adjusted = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">);</span>
	<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Interrupt number = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ql_disable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;calling pci_disable_msi()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">soft_reset</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ql_wait_for_drvr_lock</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">soft_reset</span> <span class="o">=</span> <span class="n">ql_adapter_reset</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">soft_reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;ql_adapter_reset(%d) FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Releasing driver lock via chip reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Could not acquire driver lock to do reset!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ql_free_mem_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_adapter_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ql_alloc_mem_resources</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Unable to  allocate buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;User requested MSI, but MSI failed to initialize.  Continuing without MSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;MSI Enabled...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">irq_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRQF_SHARED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ql3xxx_isr</span><span class="p">,</span>
			  <span class="n">irq_flags</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Failed to reserve interrupt %d - already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ql_wait_for_drvr_lock</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ql_adapter_initialize</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Unable to initialize adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Releasing driver lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DRVR_SEM_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Could not acquire driver lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_lock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">ql_enable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init:</span>
	<span class="n">ql_sem_unlock</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DRVR_SEM_MASK</span><span class="p">);</span>
<span class="nl">err_lock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;calling pci_disable_msi()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_MSI_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql_cycle_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_adapter_down</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">reset</span><span class="p">)</span> <span class="o">||</span> <span class="n">ql_adapter_up</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span>
			   <span class="s">&quot;Driver up/down cycle failed, closing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">dev_close</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql3xxx_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for device to recover from a reset.</span>
<span class="cm">	 * (Rarely happens, but possible.)</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">QL_ADAPTER_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">ql_adapter_down</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DO_RESET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql3xxx_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ql_adapter_up</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ql3xxx_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
			<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
	<span class="cm">/* Program lower 32 bits of the MAC address */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrIndirectPtrReg</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">MAC_ADDR_INDIRECT_PTR_REG_RP_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrDataReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span>
							 <span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>

	<span class="cm">/* Program top 16 bits of the MAC address */</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrIndirectPtrReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">MAC_ADDR_INDIRECT_PTR_REG_RP_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ql_write_page0_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">macAddrDataReg</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql3xxx_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Resetting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Stop the queues, we&#39;ve got a problem.</span>
<span class="cm">	 */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up the worker to process this event.</span>
<span class="cm">	 */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_timeout_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ql3_adapter</span><span class="p">,</span> <span class="n">reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql_tx_buf_cb</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_wait_time</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hw_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">((</span><span class="n">QL_RESET_PER_SCSI</span> <span class="o">|</span> <span class="n">QL_RESET_START</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_LINK_MASTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Loop through the active list and return the skb.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">tx_cb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span>
					      <span class="s">&quot;Freeing lost SKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							<span class="n">mapaddr</span><span class="p">),</span>
					 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">maplen</span><span class="p">),</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">seg_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
							      <span class="n">mapaddr</span><span class="p">),</span>
					       <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
							     <span class="n">maplen</span><span class="p">),</span>
					       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Clearing NRI after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>
				    <span class="n">ispControlStatus</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">ISP_CONTROL_RI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ISP_CONTROL_RI</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Wait the for Soft Reset to Complete.</span>
<span class="cm">		 */</span>
		<span class="n">max_wait_time</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">CommonRegs</span><span class="p">.</span>

						   <span class="n">ispControlStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_SR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span>
					      <span class="s">&quot;reset completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_RI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">ndev</span><span class="p">,</span>
					      <span class="s">&quot;clearing NRI after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ql_write_common_reg</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span>
						    <span class="n">CommonRegs</span><span class="p">.</span>
						    <span class="n">ispControlStatus</span><span class="p">,</span>
						    <span class="p">((</span><span class="n">ISP_CONTROL_RI</span> <span class="o">&lt;&lt;</span>
						      <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ISP_CONTROL_RI</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">max_wait_time</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">,</span> <span class="n">hw_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">ISP_CONTROL_SR</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set the reset flags and clear the board again.</span>
<span class="cm">			 * Nothing else to do...</span>
<span class="cm">			 */</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				   <span class="s">&quot;Timed out waiting for reset to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;Do a reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_PER_SCSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ql_cycle_adapter</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DO_RESET</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_PER_SCSI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">QL_RESET_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ql_cycle_adapter</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_NO_RESET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_tx_timeout_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ql3_adapter</span><span class="p">,</span> <span class="n">tx_timeout_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">ql_cycle_adapter</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="n">QL_DO_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql_get_board_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3xxx_port_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_regs</span> <span class="o">=</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ql_read_page0_reg_l</span><span class="p">(</span><span class="n">qdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_regs</span><span class="o">-&gt;</span><span class="n">portStatus</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">chip_rev_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_REV_ID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_64</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_width</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_width</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">PORT_STATUS_X</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ql3xxx_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">link_state_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ql3xxx_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ql3xxx_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ql3xxx_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ql3xxx_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ql3xxx_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ql3xxx_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ql3xxx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">pci_using_dac</span><span class="p">),</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s cannot enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s cannot obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s no usable DMA configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ql3_adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">pci_entry</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">port_link_state</span> <span class="o">=</span> <span class="n">LS_DOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msi</span><span class="p">)</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">default_msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">QL3032_DEVICE_ID</span><span class="p">)</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_SG</span><span class="p">;</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot map device registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_ndev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">hw_lock</span><span class="p">);</span>

	<span class="cm">/* Set driver entry points */</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ql3xxx_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ql3xxx_ethtool_ops</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">ql_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* make sure the EEPROM is good */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ql_get_nvram_params</span><span class="p">(</span><span class="n">qdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;%s: Adapter #%d, Invalid NVRAM parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ql_set_mac_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="cm">/* Validate and set parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mac_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">macCfg_port1</span><span class="p">.</span><span class="n">etherMtu_mac</span> <span class="p">;</span>
		<span class="n">ql_set_mac_addr</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">funcCfg_fn2</span><span class="p">.</span><span class="n">macAddress</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">macCfg_port0</span><span class="p">.</span><span class="n">etherMtu_mac</span> <span class="p">;</span>
		<span class="n">ql_set_mac_addr</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">qdev</span><span class="o">-&gt;</span><span class="n">nvram_data</span><span class="p">.</span><span class="n">funcCfg_fn0</span><span class="p">.</span><span class="n">macAddress</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">NUM_REQ_Q_ENTRIES</span><span class="p">;</span>

	<span class="cm">/* Record PCI bus information. */</span>
	<span class="n">ql_get_board_info</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the Maximum Memory Read Byte Count value. We do this to handle</span>
<span class="cm">	 * jumbo frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">pci_x</span><span class="p">)</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mh">0x4e</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="mh">0x0036</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: cannot register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we&#39;re going to reset, so assume we have no link for now */</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="n">ql_reset_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_timeout_work</span><span class="p">,</span> <span class="n">ql_tx_timeout_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">link_state_work</span><span class="p">,</span> <span class="n">ql_link_state_machine_work</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">);</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ql3xxx_timer</span><span class="p">;</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* two second delay */</span>
	<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">adapter_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">qdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cards_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_STRING</span><span class="p">);</span>
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;Driver name: %s, Version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ql_display_dev_info</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">);</span>
<span class="nl">err_out_free_ndev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">err_out_free_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ql3xxx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ql3_adapter</span> <span class="o">*</span><span class="n">qdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">ql_disable_interrupts</span><span class="p">(</span><span class="n">qdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">tx_timeout_work</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">qdev</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">qdev</span><span class="o">-&gt;</span><span class="n">mem_map_registers</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ql3xxx_driver</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ql3xxx_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ql3xxx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ql3xxx_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ql3xxx_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ql3xxx_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ql3xxx_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ql3xxx_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ql3xxx_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ql3xxx_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
