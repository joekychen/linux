<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › qlogic › netxen › netxen_nic_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>netxen_nic_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2003 - 2009 NetXen, Inc.</span>
<span class="cm"> * Copyright (C) 2009 - QLogic Corporation.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston,</span>
<span class="cm"> * MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called &quot;COPYING&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;netxen_nic.h&quot;</span>
<span class="cp">#include &quot;netxen_nic_hw.h&quot;</span>

<span class="cp">#include &lt;net/ip.h&gt;</span>

<span class="cp">#define MASK(n) ((1ULL&lt;&lt;(n))-1)</span>
<span class="cp">#define MN_WIN(addr) (((addr &amp; 0x1fc0000) &gt;&gt; 1) | ((addr &gt;&gt; 25) &amp; 0x3ff))</span>
<span class="cp">#define OCM_WIN(addr) (((addr &amp; 0x1ff0000) &gt;&gt; 1) | ((addr &gt;&gt; 25) &amp; 0x3ff))</span>
<span class="cp">#define MS_WIN(addr) (addr &amp; 0x0ffc0000)</span>

<span class="cp">#define GET_MEM_OFFS_2M(addr) (addr &amp; MASK(18))</span>

<span class="cp">#define CRB_BLK(off)	((off &gt;&gt; 20) &amp; 0x3f)</span>
<span class="cp">#define CRB_SUBBLK(off)	((off &gt;&gt; 16) &amp; 0xf)</span>
<span class="cp">#define CRB_WINDOW_2M	(0x130060)</span>
<span class="cp">#define CRB_HI(off)	((crb_hub_agt[CRB_BLK(off)] &lt;&lt; 20) | ((off) &amp; 0xf0000))</span>
<span class="cp">#define CRB_INDIRECT_2M	(0x1e0000UL)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_nic_io_write_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">netxen_nic_io_read_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>
<span class="cp">#ifndef readq</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">readq</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32LL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef writeq</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">writeq</span><span class="p">(</span><span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span><span class="p">)),</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)),</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define PCI_OFFSET_FIRST_RANGE(adapter, off)    \</span>
<span class="cp">	((adapter)-&gt;ahw.pci_base0 + (off))</span>
<span class="cp">#define PCI_OFFSET_SECOND_RANGE(adapter, off)   \</span>
<span class="cp">	((adapter)-&gt;ahw.pci_base1 + (off) - SECOND_PAGE_GROUP_START)</span>
<span class="cp">#define PCI_OFFSET_THIRD_RANGE(adapter, off)    \</span>
<span class="cp">	((adapter)-&gt;ahw.pci_base2 + (off) - THIRD_PAGE_GROUP_START)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">pci_base_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">FIRST_PAGE_GROUP_START</span><span class="p">,</span> <span class="n">FIRST_PAGE_GROUP_END</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_OFFSET_FIRST_RANGE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">SECOND_PAGE_GROUP_START</span><span class="p">,</span> <span class="n">SECOND_PAGE_GROUP_END</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_OFFSET_SECOND_RANGE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">THIRD_PAGE_GROUP_START</span><span class="p">,</span> <span class="n">THIRD_PAGE_GROUP_END</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_OFFSET_THIRD_RANGE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">crb_128M_2M_block_map_t</span>
<span class="n">crb_128M_2M_map</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="n">__cacheline_aligned_in_smp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>		<span class="cm">/* 0: PCI */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0100000</span><span class="p">,</span> <span class="mh">0x0102000</span><span class="p">,</span> <span class="mh">0x120000</span><span class="p">},</span>	<span class="cm">/* 1: PCIE */</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0110000</span><span class="p">,</span> <span class="mh">0x0120000</span><span class="p">,</span> <span class="mh">0x130000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0120000</span><span class="p">,</span> <span class="mh">0x0122000</span><span class="p">,</span> <span class="mh">0x124000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0130000</span><span class="p">,</span> <span class="mh">0x0132000</span><span class="p">,</span> <span class="mh">0x126000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0140000</span><span class="p">,</span> <span class="mh">0x0142000</span><span class="p">,</span> <span class="mh">0x128000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0150000</span><span class="p">,</span> <span class="mh">0x0152000</span><span class="p">,</span> <span class="mh">0x12a000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0160000</span><span class="p">,</span> <span class="mh">0x0170000</span><span class="p">,</span> <span class="mh">0x110000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0170000</span><span class="p">,</span> <span class="mh">0x0172000</span><span class="p">,</span> <span class="mh">0x12e000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x01e0000</span><span class="p">,</span> <span class="mh">0x01e0800</span><span class="p">,</span> <span class="mh">0x122000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0200000</span><span class="p">,</span> <span class="mh">0x0210000</span><span class="p">,</span> <span class="mh">0x180000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 2: MN */</span>
    <span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	    <span class="cm">/* 3: */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0400000</span><span class="p">,</span> <span class="mh">0x0401000</span><span class="p">,</span> <span class="mh">0x169000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 4: P2NR1 */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0500000</span><span class="p">,</span> <span class="mh">0x0510000</span><span class="p">,</span> <span class="mh">0x140000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 5: SRE   */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0600000</span><span class="p">,</span> <span class="mh">0x0610000</span><span class="p">,</span> <span class="mh">0x1c0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 6: NIU   */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0700000</span><span class="p">,</span> <span class="mh">0x0704000</span><span class="p">,</span> <span class="mh">0x1b8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 7: QM    */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0800000</span><span class="p">,</span> <span class="mh">0x0802000</span><span class="p">,</span> <span class="mh">0x170000</span><span class="p">},</span>  <span class="cm">/* 8: SQM0  */</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x08f0000</span><span class="p">,</span> <span class="mh">0x08f2000</span><span class="p">,</span> <span class="mh">0x172000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0900000</span><span class="p">,</span> <span class="mh">0x0902000</span><span class="p">,</span> <span class="mh">0x174000</span><span class="p">},</span>	<span class="cm">/* 9: SQM1*/</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x09f0000</span><span class="p">,</span> <span class="mh">0x09f2000</span><span class="p">,</span> <span class="mh">0x176000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0a00000</span><span class="p">,</span> <span class="mh">0x0a02000</span><span class="p">,</span> <span class="mh">0x178000</span><span class="p">},</span>	<span class="cm">/* 10: SQM2*/</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0af0000</span><span class="p">,</span> <span class="mh">0x0af2000</span><span class="p">,</span> <span class="mh">0x17a000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0b00000</span><span class="p">,</span> <span class="mh">0x0b02000</span><span class="p">,</span> <span class="mh">0x17c000</span><span class="p">},</span>	<span class="cm">/* 11: SQM3*/</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
      <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0bf0000</span><span class="p">,</span> <span class="mh">0x0bf2000</span><span class="p">,</span> <span class="mh">0x17e000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0c00000</span><span class="p">,</span> <span class="mh">0x0c04000</span><span class="p">,</span> <span class="mh">0x1d4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 12: I2Q */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0d00000</span><span class="p">,</span> <span class="mh">0x0d04000</span><span class="p">,</span> <span class="mh">0x1a4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 13: TMR */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0e00000</span><span class="p">,</span> <span class="mh">0x0e04000</span><span class="p">,</span> <span class="mh">0x1a0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 14: ROMUSB */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x0f00000</span><span class="p">,</span> <span class="mh">0x0f01000</span><span class="p">,</span> <span class="mh">0x164000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 15: PEG4 */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000000</span><span class="p">,</span> <span class="mh">0x1004000</span><span class="p">,</span> <span class="mh">0x1a8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 16: XDMA */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1100000</span><span class="p">,</span> <span class="mh">0x1101000</span><span class="p">,</span> <span class="mh">0x160000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 17: PEG0 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1200000</span><span class="p">,</span> <span class="mh">0x1201000</span><span class="p">,</span> <span class="mh">0x161000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 18: PEG1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1300000</span><span class="p">,</span> <span class="mh">0x1301000</span><span class="p">,</span> <span class="mh">0x162000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 19: PEG2 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1400000</span><span class="p">,</span> <span class="mh">0x1401000</span><span class="p">,</span> <span class="mh">0x163000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 20: PEG3 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1500000</span><span class="p">,</span> <span class="mh">0x1501000</span><span class="p">,</span> <span class="mh">0x165000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 21: P2ND */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1600000</span><span class="p">,</span> <span class="mh">0x1601000</span><span class="p">,</span> <span class="mh">0x166000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 22: P2NI */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 23: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 24: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 25: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 26: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 27: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* 28: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1d00000</span><span class="p">,</span> <span class="mh">0x1d10000</span><span class="p">,</span> <span class="mh">0x190000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 29: MS */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1e00000</span><span class="p">,</span> <span class="mh">0x1e01000</span><span class="p">,</span> <span class="mh">0x16a000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 30: P2NR2 */</span>
    <span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1f00000</span><span class="p">,</span> <span class="mh">0x1f10000</span><span class="p">,</span> <span class="mh">0x150000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 31: EPG */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 32: PCI */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2100000</span><span class="p">,</span> <span class="mh">0x2102000</span><span class="p">,</span> <span class="mh">0x120000</span><span class="p">},</span>	<span class="cm">/* 33: PCIE */</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2110000</span><span class="p">,</span> <span class="mh">0x2120000</span><span class="p">,</span> <span class="mh">0x130000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2120000</span><span class="p">,</span> <span class="mh">0x2122000</span><span class="p">,</span> <span class="mh">0x124000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2130000</span><span class="p">,</span> <span class="mh">0x2132000</span><span class="p">,</span> <span class="mh">0x126000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2140000</span><span class="p">,</span> <span class="mh">0x2142000</span><span class="p">,</span> <span class="mh">0x128000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2150000</span><span class="p">,</span> <span class="mh">0x2152000</span><span class="p">,</span> <span class="mh">0x12a000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2160000</span><span class="p">,</span> <span class="mh">0x2170000</span><span class="p">,</span> <span class="mh">0x110000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2170000</span><span class="p">,</span> <span class="mh">0x2172000</span><span class="p">,</span> <span class="mh">0x12e000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">},</span>
	  <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x0000000</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2200000</span><span class="p">,</span> <span class="mh">0x2204000</span><span class="p">,</span> <span class="mh">0x1b0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 34: CAM */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 35: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 36: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 37: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 38: */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 39: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2800000</span><span class="p">,</span> <span class="mh">0x2804000</span><span class="p">,</span> <span class="mh">0x1a4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 40: TMR */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2900000</span><span class="p">,</span> <span class="mh">0x2901000</span><span class="p">,</span> <span class="mh">0x16b000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 41: P2NR3 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2a00000</span><span class="p">,</span> <span class="mh">0x2a00400</span><span class="p">,</span> <span class="mh">0x1ac400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 42: RPMX1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2b00000</span><span class="p">,</span> <span class="mh">0x2b00400</span><span class="p">,</span> <span class="mh">0x1ac800</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 43: RPMX2 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2c00000</span><span class="p">,</span> <span class="mh">0x2c00400</span><span class="p">,</span> <span class="mh">0x1acc00</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 44: RPMX3 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2d00000</span><span class="p">,</span> <span class="mh">0x2d00400</span><span class="p">,</span> <span class="mh">0x1ad000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 45: RPMX4 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2e00000</span><span class="p">,</span> <span class="mh">0x2e00400</span><span class="p">,</span> <span class="mh">0x1ad400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 46: RPMX5 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x2f00000</span><span class="p">,</span> <span class="mh">0x2f00400</span><span class="p">,</span> <span class="mh">0x1ad800</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 47: RPMX6 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3000000</span><span class="p">,</span> <span class="mh">0x3000400</span><span class="p">,</span> <span class="mh">0x1adc00</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 48: RPMX7 */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x3100000</span><span class="p">,</span> <span class="mh">0x3104000</span><span class="p">,</span> <span class="mh">0x1a8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 49: XDMA */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3200000</span><span class="p">,</span> <span class="mh">0x3204000</span><span class="p">,</span> <span class="mh">0x1d4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 50: I2Q */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3300000</span><span class="p">,</span> <span class="mh">0x3304000</span><span class="p">,</span> <span class="mh">0x1a0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 51: ROMUSB */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 52: */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3500000</span><span class="p">,</span> <span class="mh">0x3500400</span><span class="p">,</span> <span class="mh">0x1ac000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 53: RPMX0 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3600000</span><span class="p">,</span> <span class="mh">0x3600400</span><span class="p">,</span> <span class="mh">0x1ae000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 54: RPMX8 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3700000</span><span class="p">,</span> <span class="mh">0x3700400</span><span class="p">,</span> <span class="mh">0x1ae400</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 55: RPMX9 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3800000</span><span class="p">,</span> <span class="mh">0x3804000</span><span class="p">,</span> <span class="mh">0x1d0000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 56: OCM0 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3900000</span><span class="p">,</span> <span class="mh">0x3904000</span><span class="p">,</span> <span class="mh">0x1b4000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 57: CRYPTO */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3a00000</span><span class="p">,</span> <span class="mh">0x3a04000</span><span class="p">,</span> <span class="mh">0x1d8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 58: SMB */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 59: I2C0 */</span>
	<span class="p">{{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span>				<span class="cm">/* 60: I2C1 */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3d00000</span><span class="p">,</span> <span class="mh">0x3d04000</span><span class="p">,</span> <span class="mh">0x1d8000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 61: LPC */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3e00000</span><span class="p">,</span> <span class="mh">0x3e01000</span><span class="p">,</span> <span class="mh">0x167000</span><span class="p">}</span> <span class="p">}</span> <span class="p">},</span><span class="cm">/* 62: P2NC */</span>
	<span class="p">{{{</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x3f00000</span><span class="p">,</span> <span class="mh">0x3f01000</span><span class="p">,</span> <span class="mh">0x168000</span><span class="p">}</span> <span class="p">}</span> <span class="p">}</span>	<span class="cm">/* 63: P2NR0 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * top 12 bits of crb internal address (hub, agent)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">crb_hub_agt</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PS</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_MN</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_MS</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SRE</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_NIU</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_QMN</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SQN0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SQN1</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SQN2</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SQN3</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_I2Q</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_TIMR</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_ROMUSB</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGN4</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_XDMA</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGN0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGN1</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGN2</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGN3</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGND</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGNI</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGS0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGS1</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGS2</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGS3</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGSI</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SN</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_EG</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PS</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_CAM</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_TIMR</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX1</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX2</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX3</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX4</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX5</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX6</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX7</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_XDMA</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_I2Q</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_ROMUSB</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX8</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_RPMX9</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_OCM0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_SMB</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_I2C0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_I2C1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NETXEN_HW_CRB_HUB_AGT_ADR_PGNC</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*  PCI Windowing for DDR regions.  */</span>

<span class="cp">#define NETXEN_WINDOW_ONE 	0x2000000 </span><span class="cm">/*CRB Window: bit 25 of CRB address */</span><span class="cp"></span>

<span class="cp">#define NETXEN_PCIE_SEM_TIMEOUT	10000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">netxen_nic_set_mtu_xgb</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">netxen_pcie_sem_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sem</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM_LOCK</span><span class="p">(</span><span class="n">sem</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="n">NETXEN_PCIE_SEM_TIMEOUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id_reg</span><span class="p">)</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">id_reg</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">netxen_pcie_sem_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_SEM_UNLOCK</span><span class="p">(</span><span class="n">sem</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_niu_xg_init_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XGE_CONFIG_1</span><span class="o">+</span><span class="p">(</span><span class="mh">0x10000</span><span class="o">*</span><span class="n">port</span><span class="p">),</span> <span class="mh">0x1447</span><span class="p">);</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XGE_CONFIG_0</span><span class="o">+</span><span class="p">(</span><span class="mh">0x10000</span><span class="o">*</span><span class="n">port</span><span class="p">),</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disable an XG interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_niu_disable_xg_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">mac_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">NETXEN_NIU_MAX_XG_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mac_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">NETXEN_NIU_XGE_CONFIG_0</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">port</span><span class="p">),</span> <span class="n">mac_cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NETXEN_UNICAST_ADDR(port, index) \</span>
<span class="cp">	(NETXEN_UNICAST_ADDR_BASE+(port*32)+(index*8))</span>
<span class="cp">#define NETXEN_MCAST_ADDR(port, index) \</span>
<span class="cp">	(NETXEN_MULTICAST_ADDR_BASE+(port*0x80)+(index*8))</span>
<span class="cp">#define MAC_HI(addr) \</span>
<span class="cp">	((addr[2] &lt;&lt; 16) | (addr[1] &lt;&lt; 8) | (addr[0]))</span>
<span class="cp">#define MAC_LO(addr) \</span>
<span class="cp">	((addr[5] &lt;&lt; 16) | (addr[4] &lt;&lt; 8) | (addr[3]))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_p2_nic_set_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mac_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">board_type</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;</span> <span class="n">NETXEN_NIU_MAX_XG_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mac_cfg</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XGE_CONFIG_0</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">port</span><span class="p">));</span>
	<span class="n">mac_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XGE_CONFIG_0</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">port</span><span class="p">),</span> <span class="n">mac_cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_IMEZ</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_HMEZ</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">&lt;&lt;</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_FRAME_COUNT_SELECT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_FRAME_COUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">NETXEN_NIU_XGE_CONFIG_1</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">port</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NETXEN_NIU_PROMISC_MODE</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x2000UL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x2000UL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NETXEN_NIU_ALLMULTI_MODE</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="mh">0x1000UL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1000UL</span><span class="p">);</span>

		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">NETXEN_NIU_XGE_CONFIG_1</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">port</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mac_cfg</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XGE_CONFIG_0</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">port</span><span class="p">),</span> <span class="n">mac_cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_p2_nic_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mac_hi</span><span class="p">,</span> <span class="n">mac_lo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_hi</span><span class="p">,</span> <span class="n">reg_lo</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">&gt;=</span> <span class="n">NETXEN_NIU_MAX_XG_PORTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mac_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">mac_hi</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">reg_lo</span> <span class="o">=</span> <span class="n">NETXEN_NIU_XGE_STATION_ADDR_0_1</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">phy</span><span class="p">);</span>
	<span class="n">reg_hi</span> <span class="o">=</span> <span class="n">NETXEN_NIU_XGE_STATION_ADDR_0_HI</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10000</span> <span class="o">*</span> <span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* write twice to flush */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg_lo</span><span class="p">,</span> <span class="n">mac_lo</span><span class="p">)</span> <span class="o">||</span> <span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg_hi</span><span class="p">,</span> <span class="n">mac_hi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg_lo</span><span class="p">,</span> <span class="n">mac_lo</span><span class="p">)</span> <span class="o">||</span> <span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">reg_hi</span><span class="p">,</span> <span class="n">mac_hi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_enable_mcast_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MAC_ADDR_CNTL_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">28</span><span class="o">+</span><span class="n">port</span><span class="p">));</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MAC_ADDR_CNTL_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* add broadcast addr to filter */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* add station addr to filter */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_HI</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_LO</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_disable_mcast_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MAC_ADDR_CNTL_REG</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">28</span><span class="o">+</span><span class="n">port</span><span class="p">));</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MAC_ADDR_CNTL_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_HI</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">MAC_LO</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_UNICAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_set_mcast_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">MAC_LO</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">MAC_HI</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MCAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span> <span class="n">hi</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MCAST_ADDR</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_p2_nic_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">null_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">null_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_NIU_PROMISC_MODE</span><span class="p">);</span>

		<span class="cm">/* Full promiscuous mode */</span>
		<span class="n">netxen_nic_disable_mcast_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_NIU_NON_PROMISC_MODE</span><span class="p">);</span>
		<span class="n">netxen_nic_disable_mcast_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_ALLMULTI_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span>
			<span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netxen_nic_disable_mcast_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_nic_enable_mcast_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span>
		<span class="n">netxen_nic_set_mcast_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/* Clear out remaining addresses */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_count</span><span class="p">)</span>
		<span class="n">netxen_nic_set_mcast_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">null_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_send_cmd_descs</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">cmd_desc_arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">producer</span><span class="p">,</span> <span class="n">consumer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_cmd_buffer</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">cmd_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">__netif_tx_lock_bh</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">producer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">;</span>
	<span class="n">consumer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">sw_consumer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_desc</span> <span class="o">&gt;=</span> <span class="n">netxen_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_tx_stop_queue</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nr_desc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netxen_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TX_STOP_THRESH</span><span class="p">)</span>
				<span class="n">netif_tx_wake_queue</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__netif_tx_unlock_bh</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">cmd_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd_desc_arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
		<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">cmd_desc_arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span><span class="p">));</span>

		<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">nr_desc</span><span class="p">);</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span><span class="p">;</span>

	<span class="n">netxen_nic_update_cmd_producer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>

	<span class="n">__netif_tx_unlock_bh</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nx_p3_sre_macaddr_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">nx_mac_req_t</span> <span class="o">*</span><span class="n">mac_req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>
	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_NIC_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_MAC_EVENT</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">mac_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx_mac_req_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mac_req</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_req</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nx_p3_nic_add_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">del_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">nx_mac_list_t</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="cm">/* look up if already exists */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">del_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">nx_mac_list_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">nx_mac_list_t</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to add mac address filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nx_p3_sre_macaddr_change</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">NETXEN_MAC_ADD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_p3_nic_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">VPORT_MISS_MODE_DROP</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">del_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">nx_mac_list_t</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">);</span>

	<span class="n">nx_p3_nic_add_mac</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">);</span>
	<span class="n">nx_p3_nic_add_mac</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bcast_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">VPORT_MISS_MODE_ACCEPT_ALL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_fw_cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">VPORT_MISS_MODE_ACCEPT_MULTI</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_fw_cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span>
			<span class="n">nx_p3_nic_add_mac</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">send_fw_cmd:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">del_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">nx_mac_list_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">nx_p3_sre_macaddr_change</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">NETXEN_MAC_DEL</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_p3_nic_set_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>

	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_PROXY_SET_VPORT_MISS_MODE</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">netxen_p3_free_mac_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_mac_list_t</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">nx_mac_list_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">nx_p3_sre_macaddr_change</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">NETXEN_MAC_DEL</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_p3_nic_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assuming caller has already copied new addr to netdev */</span>
	<span class="n">netxen_p3_nic_set_multi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define	NETXEN_CONFIG_INTR_COALESCE	3</span>

<span class="cm">/*</span>
<span class="cm"> * Send the interrupt coalescing parameter set by ethtool to the card.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">netxen_config_intr_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">word</span><span class="p">));</span>

	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NETXEN_CONFIG_INTR_COALESCE</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR. Could not send &quot;</span>
			<span class="s">&quot;interrupt coalescing parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_config_hw_lro</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__NX_FW_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>

	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_CONFIG_HW_LRO</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR. Could not send &quot;</span>
			<span class="s">&quot;configure hw lro request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_config_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_BRIDGE_ENABLED</span><span class="p">)</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>

	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_CONFIG_BRIDGING</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR. Could not send &quot;</span>
				<span class="s">&quot;configure bridge mode request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^=</span> <span class="n">NETXEN_NIC_BRIDGE_ENABLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define RSS_HASHTYPE_IP_TCP	0x3</span>

<span class="kt">int</span> <span class="nf">netxen_config_rss</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xbeac01fa6a42b73bULL</span><span class="p">,</span> <span class="mh">0x8030f20c77cb2da3ULL</span><span class="p">,</span>
		<span class="mh">0xae7b30b4d0ca2bcbULL</span><span class="p">,</span> <span class="mh">0x43a38fb04167253dULL</span><span class="p">,</span>
		<span class="mh">0x255b0ec26d5a56daULL</span>
	<span class="p">};</span>


	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>
	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_CONFIG_RSS</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * RSS request:</span>
<span class="cm">	 * bits 3-0: hash_method</span>
<span class="cm">	 *      5-4: hash_type_ipv4</span>
<span class="cm">	 *	7-6: hash_type_ipv6</span>
<span class="cm">	 *	  8: enable</span>
<span class="cm">	 *        9: use indirection table</span>
<span class="cm">	 *    47-10: reserved</span>
<span class="cm">	 *    63-48: indirection table mask</span>
<span class="cm">	 */</span>
	<span class="n">word</span> <span class="o">=</span>  <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">RSS_HASHTYPE_IP_TCP</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">RSS_HASHTYPE_IP_TCP</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="mh">0x7ULL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">key</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>


	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: could not configure RSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_config_ipaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>
	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_CONFIG_IPADDR</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: could not notify %s IP 0x%x reuqest</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">NX_IP_UP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Add&quot;</span> <span class="o">:</span> <span class="s">&quot;Remove&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_linkevent_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>
	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_GET_LINKEVENT</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">enable</span> <span class="o">|</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: could not configure link notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_send_lro_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nx_nic_req_t</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__NX_FW_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nx_nic_req_t</span><span class="p">));</span>
	<span class="n">req</span><span class="p">.</span><span class="n">qhdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">NX_HOST_REQUEST</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">NX_NIC_H2C_OPCODE_LRO_REQUEST</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">NX_NIC_LRO_REQUEST_CLEANUP</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">req</span><span class="p">.</span><span class="n">req_hdr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_send_cmd_descs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: could not cleanup lro flows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * netxen_nic_change_mtu - Change the Maximum Transfer Unit</span>
<span class="cm"> * @returns 0 on success, negative on failure</span>
<span class="cm"> */</span>

<span class="cp">#define MTU_FUDGE_FACTOR	100</span>

<span class="kt">int</span> <span class="nf">netxen_nic_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_mtu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">max_mtu</span> <span class="o">=</span> <span class="n">P3_MAX_MTU</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_mtu</span> <span class="o">=</span> <span class="n">P2_MAX_MTU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">max_mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: mtu &gt; %d bytes unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">max_mtu</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_mtu</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_mtu</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_get_flash_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">ptr32</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">ptr32</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_rom_fast_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ptr32</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="n">ptr32</span><span class="o">++</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">local</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_rom_fast_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">local</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_get_flash_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">pmac</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">NX_FW_MAC_ADDR_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_get_flash_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">pmac</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mac</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">NX_OLD_MAC_ADDR_OFFSET</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_get_flash_block</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">offset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span> <span class="n">pmac</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mac</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_p3_get_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">crbaddr</span><span class="p">,</span> <span class="n">mac_hi</span><span class="p">,</span> <span class="n">mac_lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_func</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">;</span>

	<span class="n">crbaddr</span> <span class="o">=</span> <span class="n">CRB_MAC_BLOCK_START</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">((</span><span class="n">pci_func</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">pci_func</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">mac_lo</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">crbaddr</span><span class="p">);</span>
	<span class="n">mac_hi</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">crbaddr</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_func</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">((</span><span class="n">mac_lo</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mac_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mac_lo</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">mac_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Changes the CRB window to the specified window.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_win</span> <span class="o">==</span> <span class="n">window</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">PCI_OFFSET_SECOND_RANGE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">NETXEN_PCIX_PH_REG</span><span class="p">(</span><span class="n">PCIE_CRB_WINDOW_REG</span><span class="p">(</span><span class="n">func</span><span class="p">)));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">window</span> <span class="o">==</span> <span class="n">readl</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to set CRB window to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">window</span> <span class="o">==</span> <span class="n">NETXEN_WINDOW_ONE</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_win</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns &lt; 0 if off is not valid,</span>
<span class="cm"> *	 1 if window access is needed. &#39;off&#39; is set to offset from</span>
<span class="cm"> *	   CRB space in 128M pci map</span>
<span class="cm"> *	 0 if no window access is needed. &#39;off&#39; is set to 2M addr</span>
<span class="cm"> * In: &#39;off&#39; is offset from base in 128M pci map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_get_crb_addr_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">ulong</span> <span class="n">off</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">**</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crb_128M_2M_sub_block_map_t</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">NETXEN_CRB_MAX</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">NETXEN_PCI_CRBSPACE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">-=</span> <span class="n">NETXEN_PCI_CRBSPACE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try direct map</span>
<span class="cm">	 */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crb_128M_2M_map</span><span class="p">[</span><span class="n">CRB_BLK</span><span class="p">(</span><span class="n">off</span><span class="p">)].</span><span class="n">sub_block</span><span class="p">[</span><span class="n">CRB_SUBBLK</span><span class="p">(</span><span class="n">off</span><span class="p">)];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">start_128M</span> <span class="o">&lt;=</span> <span class="n">off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">end_128M</span> <span class="o">&gt;</span> <span class="n">off</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">start_2M</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">off</span> <span class="o">-</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">start_128M</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Not in direct map, use crb window</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">CRB_INDIRECT_2M</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In: &#39;off&#39; is offset from CRB space in 128M pci map</span>
<span class="cm"> * Out: &#39;off&#39; is 2M pci map addr</span>
<span class="cm"> * side effect: lock crb window</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_nic_pci_set_crbwindow_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">window</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">CRB_WINDOW_2M</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">-=</span> <span class="n">NETXEN_PCI_CRBSPACE</span><span class="p">;</span>

	<span class="n">window</span> <span class="o">=</span> <span class="n">CRB_HI</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">window</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to set CRB window to %d off 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">window</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span>
<span class="nf">netxen_nic_map_indirect_address_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">ulong</span> <span class="n">win_off</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">**</span><span class="n">mem_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">off</span> <span class="o">=</span> <span class="n">win_off</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">mem_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_WINDOW1</span><span class="p">(</span><span class="n">win_off</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">NETXEN_CRB_NORMAL</span><span class="p">(</span><span class="n">win_off</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_base_offset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_len0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">off</span> <span class="o">-=</span> <span class="n">NETXEN_PCI_CRBSPACE</span><span class="p">;</span>

	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_hw_write_wx_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">netxen_nic_map_indirect_address_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_WINDOW1</span><span class="p">(</span><span class="n">off</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Window 1 */</span>
		<span class="n">netxen_nic_io_write_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="cm">/* Window 0 */</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_WINDOW_ONE</span><span class="p">);</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_nic_hw_read_wx_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">netxen_nic_map_indirect_address_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_WINDOW1</span><span class="p">(</span><span class="n">off</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Window 1 */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">netxen_nic_io_read_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="cm">/* Window 0 */</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_WINDOW_ONE</span><span class="p">);</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_hw_write_wx_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_nic_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* indirect access */</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">crb_win_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">netxen_nic_pci_set_crbwindow_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">crb_win_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: invalid offset: 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_nic_hw_read_wx_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_nic_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* indirect access */</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">crb_win_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">netxen_nic_pci_set_crbwindow_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">crb_win_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: invalid offset: 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* window 1 registers only */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_nic_io_write_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netxen_nic_io_read_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_nic_io_write_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netxen_nic_io_read_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span>
<span class="nf">netxen_get_ioaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">NETXEN_CRB_PCIX_HOST2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">NETXEN_CRB_PCIX_HOST</span><span class="p">))</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">PCI_OFFSET_SECOND_RANGE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">NETXEN_CRB_NORMALIZE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">netxen_nic_pci_get_crb_addr_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_set_window_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">NETXEN_ADDR_OCM0</span>  <span class="o">+</span> <span class="n">NETXEN_PCI_OCM0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">NETXEN_ADDR_OCM1</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM1_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">NETXEN_ADDR_OCM1</span> <span class="o">+</span> <span class="n">NETXEN_PCI_OCM1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_set_window_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">window</span><span class="p">;</span>

	<span class="n">window</span> <span class="o">=</span> <span class="n">OCM_WIN</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win_crb</span><span class="p">);</span>
	<span class="cm">/* read back to flush */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win_crb</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">NETXEN_PCI_OCM0_2M</span> <span class="o">+</span> <span class="n">GET_MEM_OFFS_2M</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_mem_access_direct</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">off</span><span class="p">,</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_set_window</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_base_offset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">noremap</span><span class="p">;</span>

		<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
		<span class="n">mem_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">mem_ptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="nl">noremap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* read */</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>		<span class="cm">/* write */</span>
		<span class="n">writeq</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_ptr</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">netxen_pci_camqm_read_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span>
		<span class="n">NETXEN_PCI_CAMQM_2M_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">off</span> <span class="o">-</span> <span class="n">NETXEN_PCI_CAMQM</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">readq</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">netxen_pci_camqm_write_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span>
		<span class="n">NETXEN_PCI_CAMQM_2M_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">off</span> <span class="o">-</span> <span class="n">NETXEN_PCI_CAMQM</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="n">writeq</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_CTL_CHECK   1000</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_mem_write_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">off_lo</span><span class="p">,</span> <span class="n">off_hi</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">data_hi</span><span class="p">,</span> <span class="n">data_lo</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_crb</span><span class="p">;</span>

	<span class="cm">/* Only 64-bit aligned access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* P2 has different SIU and MIU test agent base addr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_QDR_NET</span><span class="p">,</span>
				<span class="n">NETXEN_ADDR_QDR_NET_MAX_P2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">pci_base_offset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_QDR_NET</span><span class="o">+</span><span class="n">SIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="n">addr_hi</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_ADDR_HI</span><span class="p">;</span>
		<span class="n">data_lo</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_WRDATA_LO</span><span class="p">;</span>
		<span class="n">data_hi</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_WRDATA_HI</span><span class="p">;</span>
		<span class="n">off_lo</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="n">SIU_TEST_AGT_ADDR_MASK</span><span class="p">;</span>
		<span class="n">off_hi</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_UPPER_ADDR</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">pci_base_offset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_DDR_NET</span><span class="o">+</span><span class="n">MIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="n">addr_hi</span> <span class="o">=</span> <span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">;</span>
		<span class="n">data_lo</span> <span class="o">=</span> <span class="n">MIU_TEST_AGT_WRDATA_LO</span><span class="p">;</span>
		<span class="n">data_hi</span> <span class="o">=</span> <span class="n">MIU_TEST_AGT_WRDATA_HI</span><span class="p">;</span>
		<span class="n">off_lo</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="n">MIU_TEST_AGT_ADDR_MASK</span><span class="p">;</span>
		<span class="n">off_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0_MAX</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM1</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM1_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_len0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">netxen_nic_pci_mem_access_direct</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">correct:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">off_lo</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">off_hi</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">addr_hi</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">data_lo</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">data_hi</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">TA_CTL_WRITE</span><span class="p">),</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">TA_CTL_START</span> <span class="o">|</span> <span class="n">TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">TA_CTL_WRITE</span><span class="p">),</span>
			<span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to write through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_WINDOW_ONE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_mem_read_128M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">off_lo</span><span class="p">,</span> <span class="n">off_hi</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">,</span> <span class="n">data_hi</span><span class="p">,</span> <span class="n">data_lo</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_crb</span><span class="p">;</span>

	<span class="cm">/* Only 64-bit aligned access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* P2 has different SIU and MIU test agent base addr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_QDR_NET</span><span class="p">,</span>
				<span class="n">NETXEN_ADDR_QDR_NET_MAX_P2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">pci_base_offset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_QDR_NET</span><span class="o">+</span><span class="n">SIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="n">addr_hi</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_ADDR_HI</span><span class="p">;</span>
		<span class="n">data_lo</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_RDDATA_LO</span><span class="p">;</span>
		<span class="n">data_hi</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_RDDATA_HI</span><span class="p">;</span>
		<span class="n">off_lo</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="n">SIU_TEST_AGT_ADDR_MASK</span><span class="p">;</span>
		<span class="n">off_hi</span> <span class="o">=</span> <span class="n">SIU_TEST_AGT_UPPER_ADDR</span><span class="p">(</span><span class="n">off</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">pci_base_offset</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_DDR_NET</span><span class="o">+</span><span class="n">MIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="n">addr_hi</span> <span class="o">=</span> <span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">;</span>
		<span class="n">data_lo</span> <span class="o">=</span> <span class="n">MIU_TEST_AGT_RDDATA_LO</span><span class="p">;</span>
		<span class="n">data_hi</span> <span class="o">=</span> <span class="n">MIU_TEST_AGT_RDDATA_HI</span><span class="p">;</span>
		<span class="n">off_lo</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="n">MIU_TEST_AGT_ADDR_MASK</span><span class="p">;</span>
		<span class="n">off_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0_MAX</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM1</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM1_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_len0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">netxen_nic_pci_mem_access_direct</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">correct:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">off_lo</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">off_hi</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">addr_hi</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TA_CTL_ENABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">TA_CTL_START</span><span class="o">|</span><span class="n">TA_CTL_ENABLE</span><span class="p">),</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to read through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">data_hi</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">data_lo</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_nic_pci_set_crbwindow_128M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_WINDOW_ONE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_mem_write_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">off8</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_crb</span><span class="p">;</span>

	<span class="cm">/* Only 64-bit aligned access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* P3 onward, test agent base for MIU and SIU is same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_QDR_NET</span><span class="p">,</span>
				<span class="n">NETXEN_ADDR_QDR_NET_MAX_P3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_QDR_NET</span><span class="o">+</span><span class="n">MIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_DDR_NET</span><span class="o">+</span><span class="n">MIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">netxen_nic_pci_mem_access_direct</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">correct:</span>
	<span class="n">off8</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xfffffff8</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">off8</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			<span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_WRDATA_LO</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span>
			<span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_WRDATA_HI</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">TA_CTL_WRITE</span><span class="p">),</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">TA_CTL_START</span> <span class="o">|</span> <span class="n">TA_CTL_ENABLE</span> <span class="o">|</span> <span class="n">TA_CTL_WRITE</span><span class="p">),</span>
			<span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to write through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_pci_mem_read_2M</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">off</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">off8</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_crb</span><span class="p">;</span>

	<span class="cm">/* Only 64-bit aligned access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* P3 onward, test agent base for MIU and SIU is same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_QDR_NET</span><span class="p">,</span>
				<span class="n">NETXEN_ADDR_QDR_NET_MAX_P3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_QDR_NET</span><span class="o">+</span><span class="n">MIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET</span><span class="p">,</span> <span class="n">NETXEN_ADDR_DDR_NET_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mem_crb</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NETXEN_CRB_DDR_NET</span><span class="o">+</span><span class="n">MIU_TEST_AGT_BASE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">correct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0</span><span class="p">,</span> <span class="n">NETXEN_ADDR_OCM0_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">netxen_nic_pci_mem_access_direct</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">off</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">correct:</span>
	<span class="n">off8</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xfffffff8</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">off8</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_LO</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_ADDR_HI</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TA_CTL_ENABLE</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">TA_CTL_START</span> <span class="o">|</span> <span class="n">TA_CTL_ENABLE</span><span class="p">),</span> <span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">TEST_AGT_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">TA_CTL_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to read through agent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_RDDATA_HI</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_crb</span> <span class="o">+</span> <span class="n">MIU_TEST_AGT_RDDATA_LO</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">netxen_setup_hwops</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">init_port</span> <span class="o">=</span> <span class="n">netxen_niu_xg_init_port</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stop_port</span> <span class="o">=</span> <span class="n">netxen_niu_disable_xg_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_read</span> <span class="o">=</span> <span class="n">netxen_nic_hw_read_wx_128M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_write</span> <span class="o">=</span> <span class="n">netxen_nic_hw_write_wx_128M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_set_window</span> <span class="o">=</span> <span class="n">netxen_nic_pci_set_window_128M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_mem_read</span> <span class="o">=</span> <span class="n">netxen_nic_pci_mem_read_128M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_mem_write</span> <span class="o">=</span> <span class="n">netxen_nic_pci_mem_write_128M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">io_read</span> <span class="o">=</span> <span class="n">netxen_nic_io_read_128M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">io_write</span> <span class="o">=</span> <span class="n">netxen_nic_io_write_128M</span><span class="p">,</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macaddr_set</span> <span class="o">=</span> <span class="n">netxen_p2_nic_set_mac_addr</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_multi</span> <span class="o">=</span> <span class="n">netxen_p2_nic_set_multi</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_mtu</span> <span class="o">=</span> <span class="n">netxen_nic_set_mtu_xgb</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span> <span class="o">=</span> <span class="n">netxen_p2_nic_set_promisc</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_read</span> <span class="o">=</span> <span class="n">netxen_nic_hw_read_wx_2M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_write</span> <span class="o">=</span> <span class="n">netxen_nic_hw_write_wx_2M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_set_window</span> <span class="o">=</span> <span class="n">netxen_nic_pci_set_window_2M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_mem_read</span> <span class="o">=</span> <span class="n">netxen_nic_pci_mem_read_2M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_mem_write</span> <span class="o">=</span> <span class="n">netxen_nic_pci_mem_write_2M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">io_read</span> <span class="o">=</span> <span class="n">netxen_nic_io_read_2M</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">io_write</span> <span class="o">=</span> <span class="n">netxen_nic_io_write_2M</span><span class="p">,</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_mtu</span> <span class="o">=</span> <span class="n">nx_fw_cmd_set_mtu</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span> <span class="o">=</span> <span class="n">netxen_p3_nic_set_promisc</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macaddr_set</span> <span class="o">=</span> <span class="n">netxen_p3_nic_set_mac_addr</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_multi</span> <span class="o">=</span> <span class="n">netxen_p3_nic_set_multi</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_read</span> <span class="o">=</span> <span class="n">nx_fw_cmd_query_phy</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_write</span> <span class="o">=</span> <span class="n">nx_fw_cmd_set_phy</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">netxen_nic_get_board_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">board_type</span><span class="p">,</span> <span class="n">magic</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">NX_FW_MAGIC_OFFSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_rom_fast_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">magic</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">NETXEN_BDINFO_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid board config, magic=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">magic</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">NX_BRDTYPE_OFFSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_rom_fast_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">board_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">NETXEN_BRDTYPE_P3_4_GB_MM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_ROMUSB_GLB_PAD_GPIO_I</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">board_type</span> <span class="o">=</span> <span class="n">NETXEN_BRDTYPE_P3_10G_TP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">board_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB35_4G</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">NETXEN_NIC_GBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_IMEZ</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_HMEZ</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_CX4</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_HMEZ</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_XG_LOM</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_CX4</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_CX4_LP</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_IMEZ</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_SFP_PLUS</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_SFP_CT</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_SFP_QT</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_XFP</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10000_BASE_T</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">NETXEN_NIC_XGBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P1_BD</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P1_SB</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P1_SMAX</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P1_SOCK</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_REF_QG</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_4_GB</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_4_GB_MM</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">NETXEN_NIC_GBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P3_10G_TP</span>:
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">NETXEN_NIC_XGBE</span> <span class="o">:</span> <span class="n">NETXEN_NIC_GBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown board type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board_type</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">=</span> <span class="n">NETXEN_NIC_XGBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NIU access sections */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_set_mtu_xgb</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">new_mtu</span> <span class="o">+=</span> <span class="n">MTU_FUDGE_FACTOR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XGE_MAX_FRAME_SIZE</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_XG1_MAX_FRAME_SIZE</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">netxen_nic_set_link_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">port_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">NETXEN_NIC_GBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_mode</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PORT_MODE_ADDR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">NETXEN_PORT_MODE_802_3_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span>   <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span>  <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_read</span> <span class="o">&amp;&amp;</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				      <span class="n">NETXEN_NIU_GB_MII_MGMT_ADDR_PHY_STATUS</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netxen_get_phy_link</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">netxen_get_phy_speed</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">netxen_get_phy_duplex</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_read</span> <span class="o">&amp;&amp;</span>
				    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phy_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						      <span class="n">NETXEN_NIU_GB_MII_MGMT_ADDR_AUTONEG</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">autoneg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_autoneg</span> <span class="o">=</span> <span class="n">autoneg</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">link_down</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		      <span class="nl">link_down:</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">netxen_nic_wol_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">wol_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wol_cfg</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_WOL_CONFIG_NV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol_cfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wol_cfg</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_WOL_CONFIG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wol_cfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">netxen_md_cntrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="n">template_hdr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">netxen_minidump_entry_crb</span> <span class="o">*</span><span class="n">crtEntry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout_flag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op_count</span><span class="p">,</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">timeout_jiffies</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">op_count</span> <span class="o">=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">stride</span> <span class="o">=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">addr_stride</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop_cnt</span> <span class="o">&lt;</span> <span class="n">op_count</span><span class="p">;</span> <span class="n">loop_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">NX_DUMP_WCRB</span>:
					<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
							<span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_RWCRB</span>:
					<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
					<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="n">read_value</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_ANDCRB</span>:
					<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
					<span class="n">read_value</span> <span class="o">&amp;=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">;</span>
					<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="n">read_value</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_ORCRB</span>:
					<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
					<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
					<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="n">read_value</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_POLLCRB</span>:
					<span class="n">timeout</span> <span class="o">=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">poll_timeout</span><span class="p">;</span>
					<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
					<span class="n">timeout_jiffies</span> <span class="o">=</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">timeout_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="o">!</span><span class="n">timeout_flag</span>
					<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">read_value</span> <span class="o">&amp;</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">)</span>
					<span class="o">!=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">);)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
							<span class="n">timeout_jiffies</span><span class="p">))</span>
							<span class="n">timeout_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
							<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">timeout_flag</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : &quot;</span>
							<span class="s">&quot;Timeout in poll_crb control operation.</span><span class="se">\n</span><span class="s">&quot;</span>
								<span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_RD_SAVE</span>:
					<span class="cm">/* Decide which address to use */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_a</span><span class="p">)</span>
						<span class="n">addr</span> <span class="o">=</span>
						<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span>
						<span class="p">[</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_a</span><span class="p">];</span>
					<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
					<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span>
					<span class="p">[</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_v</span><span class="p">]</span>
						<span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_WRT_SAVED</span>:
					<span class="cm">/* Decide which value to use */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_v</span><span class="p">)</span>
						<span class="n">read_value</span> <span class="o">=</span>
						<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span>
						<span class="p">[</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_v</span><span class="p">];</span>
					<span class="k">else</span>
						<span class="n">read_value</span> <span class="o">=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">;</span>

					<span class="cm">/* Decide which address to use */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_a</span><span class="p">)</span>
						<span class="n">addr</span> <span class="o">=</span>
						<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span>
						<span class="p">[</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_a</span><span class="p">];</span>

					<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
								<span class="n">read_value</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">NX_DUMP_MOD_SAVE_ST</span>:
					<span class="n">read_value</span> <span class="o">=</span>
					<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span>
						<span class="p">[</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_v</span><span class="p">];</span>
					<span class="n">read_value</span> <span class="o">&lt;&lt;=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">shl</span><span class="p">;</span>
					<span class="n">read_value</span> <span class="o">&gt;&gt;=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">shr</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">)</span>
						<span class="n">read_value</span> <span class="o">&amp;=</span>
						<span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_2</span><span class="p">;</span>
					<span class="n">read_value</span> <span class="o">|=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_3</span><span class="p">;</span>
					<span class="n">read_value</span> <span class="o">+=</span> <span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">value_1</span><span class="p">;</span>
					<span class="cm">/* Write value back to state area.*/</span>
					<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">saved_state_array</span>
						<span class="p">[</span><span class="n">crtEntry</span><span class="o">-&gt;</span><span class="n">state_index_v</span><span class="p">]</span>
							<span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read memory or MN */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_md_rdmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">netxen_minidump_entry_rdmem</span>
			<span class="o">*</span><span class="n">memEntry</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">memEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">memEntry</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">;</span>    <span class="cm">/* This is size in bytes */</span>
	<span class="n">loop_cnt</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_nic_pci_mem_read_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read CRB operation */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">netxen_md_rd_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">netxen_minidump_entry_crb</span>
				<span class="o">*</span><span class="n">crbEntry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">op_count</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">crbEntry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">op_count</span> <span class="o">=</span> <span class="n">crbEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">stride</span> <span class="o">=</span> <span class="n">crbEntry</span><span class="o">-&gt;</span><span class="n">addr_stride</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop_cnt</span> <span class="o">&lt;</span> <span class="n">op_count</span><span class="p">;</span> <span class="n">loop_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">loop_cnt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Read ROM */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_md_rdrom</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">netxen_minidump_entry_rdrom</span>
				<span class="o">*</span><span class="n">romEntry</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">lck_val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fl_addr</span><span class="p">,</span> <span class="n">waddr</span><span class="p">,</span> <span class="n">raddr</span><span class="p">;</span>
	<span class="n">fl_addr</span> <span class="o">=</span> <span class="n">romEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">romEntry</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<span class="nl">lock_try:</span>
	<span class="n">lck_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span>
							<span class="n">NX_FLASH_SEM2_LK</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lck_val</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">MAX_CTL_CHECK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">lock_try</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span>
							<span class="n">NX_FLASH_LOCK_ID</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">waddr</span> <span class="o">=</span> <span class="n">fl_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">;</span>
		<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">FLASH_ROM_WINDOW</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="n">waddr</span><span class="p">);</span>
		<span class="n">raddr</span> <span class="o">=</span> <span class="n">FLASH_ROM_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">fl_addr</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">raddr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">fl_addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">+</span> <span class="n">NX_FLASH_SEM2_ULK</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">romEntry</span><span class="o">-&gt;</span><span class="n">read_data_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle L2 Cache */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_md_L2Cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_minidump_entry_cache</span>
					<span class="o">*</span><span class="n">cacheEntry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">timeout_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">read_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">cntrl_addr</span><span class="p">,</span> <span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_value</span><span class="p">,</span> <span class="n">read_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cntl_value_w</span><span class="p">,</span> <span class="n">cntl_value_r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">timeout_jiffies</span><span class="p">;</span>

	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">read_addr</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">cntrl_addr</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">control_addr</span><span class="p">;</span>
	<span class="n">cntl_value_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">write_value</span><span class="p">;</span>
	<span class="n">tag_reg_addr</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">tag_value</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">init_tag_value</span><span class="p">;</span>
	<span class="n">read_cnt</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">read_addr_cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">tag_reg_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="n">tag_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cntl_value_w</span><span class="p">)</span>
			<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">cntrl_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cntl_value_w</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">poll_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">;</span>
			<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">cntrl_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">cntl_value_r</span><span class="p">);</span>
			<span class="n">timeout_jiffies</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">timeout_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">timeout_flag</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">cntl_value_r</span> <span class="o">&amp;</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">poll_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout_jiffies</span><span class="p">))</span>
					<span class="n">timeout_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">cntrl_addr</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">cntl_value_r</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;Timeout in processing L2 Tag poll.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">read_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">read_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">read_addr_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tag_value</span> <span class="o">+=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">tag_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">read_cnt</span> <span class="o">*</span> <span class="n">loop_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">read_value</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Handle L1 Cache */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">netxen_md_L1Cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_minidump_entry_cache</span>
					<span class="o">*</span><span class="n">cacheEntry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">read_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">cntrl_addr</span><span class="p">,</span> <span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag_value</span><span class="p">,</span> <span class="n">read_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cntl_value_w</span><span class="p">;</span>

	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
	<span class="n">read_addr</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">cntrl_addr</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">control_addr</span><span class="p">;</span>
	<span class="n">cntl_value_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">write_value</span><span class="p">;</span>
	<span class="n">tag_reg_addr</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">tag_reg_addr</span><span class="p">;</span>
	<span class="n">tag_value</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">init_tag_value</span><span class="p">;</span>
	<span class="n">read_cnt</span> <span class="o">=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">read_addr_cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">tag_reg_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="n">tag_value</span><span class="p">);</span>
		<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">cntrl_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
						<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">cntl_value_w</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">read_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">read_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">read_addr_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tag_value</span> <span class="o">+=</span> <span class="n">cacheEntry</span><span class="o">-&gt;</span><span class="n">tag_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">read_cnt</span> <span class="o">*</span> <span class="n">loop_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">read_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reading OCM memory */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_md_rdocm</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_minidump_entry_rdocm</span>
					<span class="o">*</span><span class="n">ocmEntry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">loop_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ocmEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">);</span>
	<span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">ocmEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">ocmEntry</span><span class="o">-&gt;</span><span class="n">read_addr_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read MUX data */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_md_rdmux</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netxen_minidump_entry_mux</span>
					<span class="o">*</span><span class="n">muxEntry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">read_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">select_addr</span><span class="p">,</span> <span class="n">sel_value</span><span class="p">;</span>

	<span class="n">read_addr</span> <span class="o">=</span> <span class="n">muxEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
	<span class="n">sel_value</span> <span class="o">=</span> <span class="n">muxEntry</span><span class="o">-&gt;</span><span class="n">select_value</span><span class="p">;</span>
	<span class="n">select_addr</span> <span class="o">=</span> <span class="n">muxEntry</span><span class="o">-&gt;</span><span class="n">select_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop_cnt</span> <span class="o">&lt;</span> <span class="n">muxEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span> <span class="n">loop_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">select_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="n">sel_value</span><span class="p">);</span>
		<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">sel_value</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
		<span class="n">sel_value</span> <span class="o">+=</span> <span class="n">muxEntry</span><span class="o">-&gt;</span><span class="n">select_value_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">loop_cnt</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Handling Queue State Reads */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">netxen_md_rdqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_minidump_entry_queue</span>
					<span class="o">*</span><span class="n">queueEntry</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop_cnt</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">read_addr</span><span class="p">,</span> <span class="n">read_value</span><span class="p">,</span> <span class="n">read_stride</span><span class="p">,</span> <span class="n">select_addr</span><span class="p">,</span> <span class="n">read_cnt</span><span class="p">;</span>

	<span class="n">read_cnt</span> <span class="o">=</span> <span class="n">queueEntry</span><span class="o">-&gt;</span><span class="n">read_addr_cnt</span><span class="p">;</span>
	<span class="n">read_stride</span> <span class="o">=</span> <span class="n">queueEntry</span><span class="o">-&gt;</span><span class="n">read_addr_stride</span><span class="p">;</span>
	<span class="n">select_addr</span> <span class="o">=</span> <span class="n">queueEntry</span><span class="o">-&gt;</span><span class="n">select_addr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">queue_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop_cnt</span> <span class="o">&lt;</span> <span class="n">queueEntry</span><span class="o">-&gt;</span><span class="n">op_count</span><span class="p">;</span>
				 <span class="n">loop_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NX_WR_DUMP_REG</span><span class="p">(</span><span class="n">select_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span> <span class="n">queue_id</span><span class="p">);</span>
		<span class="n">read_addr</span> <span class="o">=</span> <span class="n">queueEntry</span><span class="o">-&gt;</span><span class="n">read_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">read_cnt</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NX_RD_DUMP_REG</span><span class="p">(</span><span class="n">read_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">read_value</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_buff</span><span class="o">++</span> <span class="o">=</span> <span class="n">read_value</span><span class="p">;</span>
			<span class="n">read_addr</span> <span class="o">+=</span> <span class="n">read_stride</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">queue_id</span> <span class="o">+=</span> <span class="n">queueEntry</span><span class="o">-&gt;</span><span class="n">queue_id_stride</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">loop_cnt</span> <span class="o">*</span> <span class="p">(</span><span class="n">read_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">read_value</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">* We catch an error where driver does not read</span>
<span class="cm">* as much data as we expect from the entry.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_md_entry_err_chk</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_minidump_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="kt">int</span> <span class="n">esize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SKIP</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">esize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esize</span> <span class="o">!=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_capture_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_capture_size</span> <span class="o">=</span> <span class="n">esize</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SIZE_ERR</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Invalidate dump, Type:%d</span><span class="se">\t</span><span class="s">Mask:%d</span><span class="se">\t</span><span class="s">Size:%dCap_size:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_type</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_capture_mask</span><span class="p">,</span>
			<span class="n">esize</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_capture_size</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Aborting further dump capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_parse_md_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_of_entries</span><span class="p">,</span> <span class="n">buff_level</span><span class="p">,</span> <span class="n">e_cnt</span><span class="p">,</span> <span class="n">esize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sane_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sane_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dbuff</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">template_buff</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dump_buff</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">capture_mask</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="n">template_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_minidump_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">capture_mask</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Capture mask %02x below minimum needed &quot;</span>
			<span class="s">&quot;for valid firmware dump</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">capture_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">template_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">template_buff</span><span class="p">;</span>
	<span class="n">num_of_entries</span> <span class="o">=</span> <span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">num_of_entries</span><span class="p">;</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netxen_minidump_entry</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">template_buff</span> <span class="o">+</span>
				<span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">first_entry_offset</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dump_buff</span><span class="p">,</span> <span class="n">template_buff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template_size</span><span class="p">);</span>
	<span class="n">dump_buff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">template_hdr</span><span class="o">-&gt;</span><span class="n">entry_type</span> <span class="o">==</span> <span class="n">TLHDR</span><span class="p">)</span>
		<span class="n">sane_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">e_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buff_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e_cnt</span> <span class="o">&lt;</span> <span class="n">num_of_entries</span><span class="p">;</span> <span class="n">e_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_capture_mask</span> <span class="o">&amp;</span> <span class="n">capture_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SKIP</span><span class="p">;</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netxen_minidump_entry</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_size</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RDNOP</span>:
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RDEND</span>:
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SKIP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sane_end</span><span class="p">)</span>
				<span class="n">end_cnt</span> <span class="o">=</span> <span class="n">e_cnt</span><span class="p">;</span>
			<span class="n">sane_end</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CNTRL</span>:
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_cntrl</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">template_hdr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
				<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RDCRB</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_rd_crb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RDMN</span>:
		<span class="k">case</span> <span class="n">RDMEM</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_rdmem</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BOARD</span>:
		<span class="k">case</span> <span class="n">RDROM</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_rdrom</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">L2ITG</span>:
		<span class="k">case</span> <span class="n">L2DTG</span>:
		<span class="k">case</span> <span class="n">L2DAT</span>:
		<span class="k">case</span> <span class="n">L2INS</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_L2Cache</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">L1DAT</span>:
		<span class="k">case</span> <span class="n">L1INS</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_L1Cache</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RDOCM</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_rdocm</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RDMUX</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_rdmux</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">QUEUE</span>:
			<span class="n">dbuff</span> <span class="o">=</span> <span class="n">dump_buff</span> <span class="o">+</span> <span class="n">buff_level</span><span class="p">;</span>
			<span class="n">esize</span> <span class="o">=</span> <span class="n">netxen_md_rdqueue</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dbuff</span><span class="p">);</span>
			<span class="n">rv</span> <span class="o">=</span> <span class="n">netxen_md_entry_err_chk</span>
				<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">esize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">buff_level</span> <span class="o">+=</span> <span class="n">esize</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">NX_DUMP_SKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Next entry in the template */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netxen_minidump_entry</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">entry_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sane_start</span> <span class="o">||</span> <span class="n">sane_end</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Firmware minidump template configuration error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_collect_minidump</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">driver_capture_mask</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_mask</span><span class="p">;</span>
	<span class="n">jiffies_to_timespec</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">driver_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">val</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">driver_info_word2</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">driver_info_word3</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">netxen_parse_md_template</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">netxen_dump_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capture_mask</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">netxen_minidump_template_hdr</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span><span class="p">;</span>
	<span class="n">capture_mask</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">NX_DUMP_MASK_MAX</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">capture_mask</span><span class="p">)</span>
			<span class="n">data_size</span> <span class="o">+=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">capture_size_array</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Invalid cap sizes for capture_mask=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_mask</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_dump_size</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template_size</span> <span class="o">+</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span> <span class="o">=</span>
				<span class="n">vmalloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_dump_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Unable to allocate memory for minidump &quot;</span>
				<span class="s">&quot;capture_buffer(%d bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_dump_size</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_dump_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_collect_minidump</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">has_valid_dump</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_dump_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Error in collecting firmware minidump.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">has_valid_dump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_mdump_rdy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Successfully &quot;</span>
				<span class="s">&quot;collected fw dump.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Cannot overwrite previously collected &quot;</span>
							<span class="s">&quot;firmware minidump.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_mdump_rdy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
