<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › qlogic › netxen › netxen_nic_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>netxen_nic_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2003 - 2009 NetXen, Inc.</span>
<span class="cm"> * Copyright (C) 2009 - QLogic Corporation.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston,</span>
<span class="cm"> * MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called &quot;COPYING&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &quot;netxen_nic_hw.h&quot;</span>

<span class="cp">#include &quot;netxen_nic.h&quot;</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;net/ip.h&gt;</span>
<span class="cp">#include &lt;linux/ipv6.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/aer.h&gt;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;QLogic/NetXen (1/10) GbE Intelligent Ethernet Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">NETXEN_NIC_LINUX_VERSIONID</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">NX_UNIFIED_ROMIMAGE_NAME</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">netxen_nic_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;netxen_nic&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">netxen_nic_driver_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;QLogic/NetXen Network Driver v&quot;</span>
    <span class="n">NETXEN_NIC_LINUX_VERSIONID</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">port_mode</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG</span><span class="p">;</span>

<span class="cm">/* Default to restricted 1G auto-neg mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wol_port_mode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_msi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">use_msi_x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">auto_fw_reset</span> <span class="o">=</span> <span class="n">AUTO_FW_RESET_ENABLED</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_fw_reset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">auto_fw_reset</span><span class="p">,</span><span class="s">&quot;Auto firmware reset (0=disabled, 1=enabled&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">netxen_nic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">netxen_nic_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netxen_nic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netxen_nic_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">netxen_nic_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_fw_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">work_func_t</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_cancel_fw_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netxen_nic_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_nic_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_create_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_remove_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_create_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_remove_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nx_dev_request_aer</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netxen_can_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">netxen_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">netxen_msi_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">netxen_msix_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_free_vlan_ip_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">netxen_restore_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">netxen_nic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netxen_nic_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>

<span class="cm">/*  PCI Device ID Table  */</span>
<span class="cp">#define ENTRY(device) \</span>
<span class="cp">	{PCI_DEVICE(PCI_VENDOR_ID_NETXEN, (device)), \</span>
<span class="cp">	.class = PCI_CLASS_NETWORK_ETHERNET &lt;&lt; 8, .class_mask = ~0}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">netxen_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_10GXSR</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_10GCX4</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_4GCU</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_IMEZ</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_HMEZ</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_XG_MGMT</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX2031_XG_MGMT2</span><span class="p">),</span>
	<span class="n">ENTRY</span><span class="p">(</span><span class="n">PCI_DEVICE_ID_NX3031</span><span class="p">),</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">netxen_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">crb_cmd_producer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CRB_CMD_PRODUCER_OFFSET</span><span class="p">,</span> <span class="n">CRB_CMD_PRODUCER_OFFSET_1</span><span class="p">,</span>
	<span class="n">CRB_CMD_PRODUCER_OFFSET_2</span><span class="p">,</span> <span class="n">CRB_CMD_PRODUCER_OFFSET_3</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">netxen_nic_update_cmd_producer</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nx_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NXWRIO</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">crb_cmd_producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">crb_cmd_consumer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CRB_CMD_CONSUMER_OFFSET</span><span class="p">,</span> <span class="n">CRB_CMD_CONSUMER_OFFSET_1</span><span class="p">,</span>
	<span class="n">CRB_CMD_CONSUMER_OFFSET_2</span><span class="p">,</span> <span class="n">CRB_CMD_CONSUMER_OFFSET_3</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">netxen_nic_update_cmd_consumer</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nx_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NXWRIO</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">crb_cmd_consumer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">sw_consumer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">msi_tgt_status</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ISR_INT_TARGET_STATUS</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F1</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F2</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F3</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F4</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F5</span><span class="p">,</span>
	<span class="n">ISR_INT_TARGET_STATUS_F6</span><span class="p">,</span> <span class="n">ISR_INT_TARGET_STATUS_F7</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">netxen_legacy_intr_set</span> <span class="n">legacy_intr</span><span class="p">[]</span> <span class="o">=</span> <span class="n">NX_LEGACY_INTR_CONFIG</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">netxen_nic_disable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">NXWRIO</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">crb_intr_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">netxen_nic_enable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">NXWRIO</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">crb_intr_mask</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NETXEN_IS_MSI_FAMILY</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">NXWRIO</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_alloc_sds_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nx_host_sds_ring</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_free_sds_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">);</span>

	<span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_napi_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_alloc_sds_rings</span><span class="p">(</span><span class="n">recv_ctx</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span>
				<span class="n">netxen_nic_poll</span><span class="p">,</span> <span class="n">NETXEN_NETDEV_WEIGHT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_napi_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netxen_free_sds_rings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_napi_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">netxen_nic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_napi_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">netxen_nic_disable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
		<span class="n">napi_synchronize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nx_set_dma_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">mask</span><span class="p">,</span> <span class="n">cmask</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">cmask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_IA64</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">39</span><span class="p">);</span>
		<span class="n">cmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update addressable range if firmware supports it */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nx_update_dma_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">mask</span><span class="p">,</span> <span class="n">old_mask</span><span class="p">,</span> <span class="n">old_cmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_DMA_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span> <span class="o">==</span> <span class="n">NX_P2_C1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_mask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
		<span class="n">old_cmask</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="o">+</span><span class="n">shift</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using %d-bit dma mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="o">+</span><span class="n">shift</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">old_mask</span><span class="p">);</span>
	<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">old_cmask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_check_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first_boot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_boot</span> <span class="o">==</span> <span class="mh">0x55555555</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is the first boot after power up */</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">),</span> <span class="n">NETXEN_BDINFO_MAGIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* PCI bus master workaround */</span>
		<span class="n">first_boot</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="mh">0x4</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">first_boot</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">first_boot</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="mh">0x4</span><span class="p">),</span> <span class="n">first_boot</span><span class="p">);</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="mh">0x4</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* This is the first boot after power up */</span>
		<span class="n">first_boot</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_ROMUSB_GLB_SW_RESET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_boot</span> <span class="o">!=</span> <span class="mh">0x80000f</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear the register for future unloads/loads */</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Start P2 boot loader */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_ROMUSB_GLB_PEGTUNE_DONE</span><span class="p">);</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_ROMUSB_GLB_PEGTUNE_DONE</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">NETXEN_BDINFO_MAGIC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_set_port_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">NETXEN_BRDTYPE_P3_HMEZ</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">NETXEN_BRDTYPE_P3_XG_LOM</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">NETXEN_PORT_MODE_802_3_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_802_3_AP</span><span class="p">;</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PORT_MODE_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">NETXEN_PORT_MODE_XG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_XG</span><span class="p">;</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PORT_MODE_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG_1G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG_1G</span><span class="p">;</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PORT_MODE_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_mode</span> <span class="o">==</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG_XG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG_XG</span><span class="p">;</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PORT_MODE_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG</span><span class="p">;</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PORT_MODE_ADDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">wol_port_mode</span> <span class="o">!=</span> <span class="n">NETXEN_PORT_MODE_802_3_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">wol_port_mode</span> <span class="o">!=</span> <span class="n">NETXEN_PORT_MODE_XG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">wol_port_mode</span> <span class="o">!=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG_1G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">wol_port_mode</span> <span class="o">!=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG_XG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wol_port_mode</span> <span class="o">=</span> <span class="n">NETXEN_PORT_MODE_AUTO_NEG</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_WOL_PORT_MODE</span><span class="p">,</span> <span class="n">wol_port_mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define PCI_CAP_ID_GEN  0x10</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_pcie_strap_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pdevfuncsave</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">c8c9value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chicken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">chicken</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_CHICKEN3</span><span class="p">));</span>
	<span class="cm">/* clear chicken3.25:24 */</span>
	<span class="n">chicken</span> <span class="o">&amp;=</span> <span class="mh">0xFCFFFFFF</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * if gen1 and B0, set F1020 - if gen 2, do nothing</span>
<span class="cm">	 * if gen2 set to F1000</span>
<span class="cm">	 */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_GEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0x000F0000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00020000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  set chicken3.24 if gen1 */</span>
			<span class="n">chicken</span> <span class="o">|=</span> <span class="mh">0x01000000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Gen2 strapping detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">c8c9value</span> <span class="o">=</span> <span class="mh">0xF1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* set chicken3.24 if gen1 */</span>
		<span class="n">chicken</span> <span class="o">|=</span> <span class="mh">0x01000000</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Gen1 strapping detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span> <span class="o">==</span> <span class="n">NX_P3_B0</span><span class="p">)</span>
			<span class="n">c8c9value</span> <span class="o">=</span> <span class="mh">0xF1020</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">c8c9value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PCIE_REG</span><span class="p">(</span><span class="n">PCIE_CHICKEN3</span><span class="p">),</span> <span class="n">chicken</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c8c9value</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pdevfuncsave</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdevfuncsave</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">c8c9value</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">pdevfuncsave</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_set_msix_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">control</span> <span class="o">|=</span> <span class="n">PCI_MSIX_FLAGS_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_init_msix_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_read_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_p3_get_mac_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_get_flash_mac_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* set station address */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Bad MAC address %pM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netxen_napi_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macaddr_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netxen_napi_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_multi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">netxen_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling LRO as RXCSUM is off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_LRO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">hw_lro</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">^</span> <span class="n">features</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw_lro</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span> <span class="o">?</span> <span class="n">NETXEN_NIC_LRO_ENABLED</span>
	         <span class="o">:</span> <span class="n">NETXEN_NIC_LRO_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_config_hw_lro</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hw_lro</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netxen_send_lro_cleanup</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">netxen_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	   <span class="o">=</span> <span class="n">netxen_nic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	   <span class="o">=</span> <span class="n">netxen_nic_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>    <span class="o">=</span> <span class="n">netxen_nic_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>   <span class="o">=</span> <span class="n">netxen_nic_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span> <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>   <span class="o">=</span> <span class="n">netxen_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">netxen_nic_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>	   <span class="o">=</span> <span class="n">netxen_nic_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>	   <span class="o">=</span> <span class="n">netxen_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span> <span class="o">=</span> <span class="n">netxen_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span> <span class="o">=</span> <span class="n">netxen_set_features</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span> <span class="o">=</span> <span class="n">netxen_nic_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_setup_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_legacy_intr_set</span> <span class="o">*</span><span class="n">legacy_intrp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rss_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_msix</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_online_cpus</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">MSIX_ENTRIES_PER_ADAPTER</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">MSIX_ENTRIES_PER_ADAPTER</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">num_msix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NETXEN_NIC_MSI_ENABLED</span> <span class="o">|</span> <span class="n">NETXEN_NIC_MSIX_ENABLED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span> <span class="o">&gt;=</span> <span class="n">NX_P3_B0</span><span class="p">)</span>
		<span class="n">legacy_intrp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">legacy_intr</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">legacy_intrp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">legacy_intr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span> <span class="o">=</span> <span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">tgt_mask_reg</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_int_reg</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">legacy_intrp</span><span class="o">-&gt;</span><span class="n">pci_int_reg</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ISR_INT_VECTOR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span> <span class="o">&gt;=</span> <span class="n">NX_P3_B1</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">ISR_INT_STATE_REG</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">CRB_INT_VECTOR</span><span class="p">);</span>

	<span class="n">netxen_set_msix_bit</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">netxen_init_msix_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">,</span> <span class="n">num_msix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETXEN_NIC_MSIX_ENABLED</span><span class="p">;</span>
			<span class="n">netxen_set_msix_bit</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rss_supported</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">=</span> <span class="n">num_msix</span><span class="p">;</span>

			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using msi-x interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="cm">/* fall through for msi */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_msi</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETXEN_NIC_MSI_ENABLED</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">msi_tgt_status</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">]);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using msi interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using legacy interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_teardown_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_MSIX_ENABLED</span><span class="p">)</span>
		<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_MSI_ENABLED</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_cleanup_pci_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">db_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">db_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base1</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_base2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_setup_pci_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">db_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">resource_size_t</span> <span class="n">mem_base</span><span class="p">,</span> <span class="n">db_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_len</span><span class="p">,</span> <span class="n">db_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_func</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_hardware_context</span> <span class="o">*</span><span class="n">ahw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the CRB window to invalid. If any register in window 0 is</span>
<span class="cm">	 * accessed it should set the window to 0 and then reset it to 1.</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_win</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* remap phys address */</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* 0 is for BAR 0 */</span>
	<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* 128 Meg of memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_len</span> <span class="o">==</span> <span class="n">NETXEN_PCI_128MB_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">,</span> <span class="n">FIRST_PAGE_GROUP_SIZE</span><span class="p">);</span>
		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base1</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">SECOND_PAGE_GROUP_START</span><span class="p">,</span>
				<span class="n">SECOND_PAGE_GROUP_SIZE</span><span class="p">);</span>
		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base2</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">THIRD_PAGE_GROUP_START</span><span class="p">,</span>
				<span class="n">THIRD_PAGE_GROUP_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base1</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
						<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map PCI bar 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_len0</span> <span class="o">=</span> <span class="n">FIRST_PAGE_GROUP_SIZE</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mem_len</span> <span class="o">==</span> <span class="n">NETXEN_PCI_32MB_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base1</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">,</span> <span class="n">SECOND_PAGE_GROUP_SIZE</span><span class="p">);</span>
		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base2</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">THIRD_PAGE_GROUP_START</span> <span class="o">-</span>
			<span class="n">SECOND_PAGE_GROUP_START</span><span class="p">,</span> <span class="n">THIRD_PAGE_GROUP_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base1</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map PCI bar 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mem_len</span> <span class="o">==</span> <span class="n">NETXEN_PCI_2MB_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_base0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map PCI bar 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ahw</span><span class="o">-&gt;</span><span class="n">pci_len0</span> <span class="o">=</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_setup_hwops</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%dMB memory map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">mem_len</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3P</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win_crb</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">NETXEN_PCIX_PS_REG</span><span class="p">(</span><span class="n">PCIX_OCM_WINDOW_REG</span><span class="p">(</span><span class="n">pci_func</span><span class="p">)));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win_crb</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			<span class="n">NETXEN_PCIX_PS_REG</span><span class="p">(</span><span class="n">PCIE_MN_WINDOW_REG</span><span class="p">(</span><span class="n">pci_func</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_doorbell</span><span class="p">;</span>

	<span class="n">db_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* doorbell is on bar 4 */</span>
	<span class="n">db_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: doorbell is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netxen_nic_driver_name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">db_base</span><span class="p">,</span> <span class="n">NETXEN_DB_MAPSIZE_BYTES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">db_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to allocate doorbell map.&quot;</span><span class="p">,</span>
				<span class="n">netxen_nic_driver_name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">skip_doorbell:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">db_base</span> <span class="o">=</span> <span class="n">db_ptr</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">db_len</span> <span class="o">=</span> <span class="n">db_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">netxen_cleanup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_check_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">,</span> <span class="n">prev_fw_version</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">brd_name</span><span class="p">[</span><span class="n">NETXEN_MAX_SHORT_NAME</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">serial_num</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">ptr32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">driver_mismatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ptr32</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serial_num</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">NX_FW_SERIAL_NUM_OFFSET</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_rom_fast_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error reading board info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">driver_mismatch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr32</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fw_major</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_FW_VERSION_MAJOR</span><span class="p">);</span>
	<span class="n">fw_minor</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_FW_VERSION_MINOR</span><span class="p">);</span>
	<span class="n">fw_build</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_FW_VERSION_SUB</span><span class="p">);</span>
	<span class="n">prev_fw_version</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">=</span> <span class="n">NETXEN_VERSION_CODE</span><span class="p">(</span><span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">);</span>

	<span class="cm">/* Get FW Mini Coredump template and store it */</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&gt;</span> <span class="n">prev_fw_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_setup_minidump</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to setup minidump rcode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_brd_name_by_type</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span><span class="p">,</span> <span class="n">brd_name</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s Board S/N %s  Chip rev 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">module_name</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">),</span>
				<span class="n">brd_name</span><span class="p">,</span> <span class="n">serial_num</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&lt;</span> <span class="n">NETXEN_VERSION_CODE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">216</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">driver_mismatch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware version %d.%d.%d unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_SRE_MISC</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">cut_through</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware v%d.%d.%d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fw_major</span><span class="p">,</span> <span class="n">fw_minor</span><span class="p">,</span> <span class="n">fw_build</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">cut_through</span> <span class="o">?</span> <span class="s">&quot;cut-through&quot;</span> <span class="o">:</span> <span class="s">&quot;legacy&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">&gt;=</span> <span class="n">NETXEN_VERSION_CODE</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">222</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_FW_CAPABILITIES_1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">NETXEN_NIC_XGBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">=</span> <span class="n">DEFAULT_RCV_DESCRIPTORS_10G</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_jumbo_rxd</span> <span class="o">=</span> <span class="n">MAX_JUMBO_RCV_DESCRIPTORS_10G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">NETXEN_NIC_GBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rxd</span> <span class="o">=</span> <span class="n">DEFAULT_RCV_DESCRIPTORS_1G</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_jumbo_rxd</span> <span class="o">=</span> <span class="n">MAX_JUMBO_RCV_DESCRIPTORS_1G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="n">use_msi_x</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rss_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="n">use_msi_x</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">flashed_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netxen_rom_fast_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">NX_FW_VERSION_OFFSET</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">flashed_ver</span><span class="p">);</span>
		<span class="n">flashed_ver</span> <span class="o">=</span> <span class="n">NETXEN_DECODE_VERSION</span><span class="p">(</span><span class="n">flashed_ver</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flashed_ver</span> <span class="o">&gt;=</span> <span class="n">NETXEN_VERSION_CODE</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">336</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G</span>:
			<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_CX4</span>:
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="n">use_msi_x</span><span class="p">;</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rss_supported</span> <span class="o">=</span> <span class="o">!!</span><span class="n">use_msi_x</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_txd</span> <span class="o">=</span> <span class="n">MAX_CMD_DESCRIPTORS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_lro_rxd</span> <span class="o">=</span> <span class="n">MAX_LRO_RCV_DESCRIPTORS</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_lro_rxd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">first_boot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* required for NX2031 dummy dma */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">nx_set_dma_mask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_can_start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">wait_init</span><span class="p">;</span>

	<span class="n">first_boot</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CAM_RAM</span><span class="p">(</span><span class="mh">0x1fc</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_check_hw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">first_boot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error in init HW init sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_request_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_need_fw_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pcie_strap_init</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_boot</span> <span class="o">!=</span> <span class="mh">0x55555555</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_CMDPEG_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">netxen_pinit_from_rom</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_DMA_SHIFT</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PEG_HALT_STATUS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PEG_HALT_STATUS2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">netxen_set_port_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_load_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">netxen_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Initialize multicast addr pool owners */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x7654</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span> <span class="o">==</span> <span class="n">NETXEN_NIC_XGBE</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x0f000000</span><span class="p">;</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_MAC_ADDR_CNTL_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_init_dummy_dma</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the hardware our version number.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">_NETXEN_NIC_LINUX_MAJOR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">_NETXEN_NIC_LINUX_MINOR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">_NETXEN_NIC_LINUX_SUBVERSION</span><span class="p">);</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_DRIVER_VERSION</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

<span class="nl">pcie_strap_init:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">netxen_pcie_strap_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">wait_init:</span>
	<span class="cm">/* Handshake with the card before we register the devices. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_phantom_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIC_PEG_TUNE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netxen_free_dummy_dma</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_READY</span><span class="p">);</span>

	<span class="n">nx_update_dma_mask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_check_options</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* fall through and release firmware */</span>

<span class="nl">err_out:</span>
	<span class="n">netxen_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_request_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irq_handler_t</span> <span class="n">handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ring</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_MSIX_ENABLED</span><span class="p">)</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">netxen_msix_intr</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_MSI_ENABLED</span><span class="p">)</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">netxen_msi_intr</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">netxen_intr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s[%d]&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
				  <span class="n">flags</span><span class="p">,</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sds_ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_nic_free_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_nic_init_coalesce_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NETXEN_NIC_INTR_DEFAULT</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">rx_time_us</span> <span class="o">=</span>
		<span class="n">NETXEN_DEFAULT_INTR_COALESCE_RX_TIME_US</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span>
		<span class="n">NETXEN_DEFAULT_INTR_COALESCE_RX_PACKETS</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_time_us</span> <span class="o">=</span>
		<span class="n">NETXEN_DEFAULT_INTR_COALESCE_TX_TIME_US</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">coal</span><span class="p">.</span><span class="n">normal</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span>
		<span class="n">NETXEN_DEFAULT_INTR_COALESCE_TX_PACKETS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__netxen_nic_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">init_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to initialize port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netxen_nic_driver_name</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macaddr_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_mtu</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">netxen_config_rss</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">netxen_config_intr_coalesce</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_LRO</span><span class="p">)</span>
		<span class="n">netxen_config_hw_lro</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIC_LRO_ENABLED</span><span class="p">);</span>

	<span class="n">netxen_napi_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_LINK_NOTIFICATION</span><span class="p">)</span>
		<span class="n">netxen_linkevent_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netxen_nic_set_link_parameters</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__NX_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Usage: During resume and firmware recovery module.*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">netxen_nic_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__netxen_nic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* with rtnl_lock */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__netxen_nic_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">__NX_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">smp_mb</span><span class="p">();</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_tx_disable</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_LINK_NOTIFICATION</span><span class="p">)</span>
		<span class="n">netxen_linkevent_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stop_port</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stop_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">netxen_p3_free_mac_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">set_promisc</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_NIU_NON_PROMISC_MODE</span><span class="p">);</span>

	<span class="n">netxen_napi_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_release_tx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Usage: During suspend and firmware recovery module */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">netxen_nic_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">__netxen_nic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_rds_ring</span> <span class="o">*</span><span class="n">rds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capab2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">==</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_init_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETXEN_FW_MSS_CAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_MORE_CAPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">capab2</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_FW_CAPABILITIES_2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capab2</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_2_LRO_MAX_TCP_SEG</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETXEN_FW_MSS_CAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_napi_add</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_alloc_sw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error in setting sw resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_alloc_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error in setting hw resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_sw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">crb_cmd_producer</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">crb_cmd_producer</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">]);</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">crb_cmd_consumer</span> <span class="o">=</span> <span class="n">netxen_get_ioaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				<span class="n">crb_cmd_consumer</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">]);</span>

		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">sw_consumer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">netxen_nic_update_cmd_producer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
		<span class="n">netxen_nic_update_cmd_consumer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_rds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">.</span><span class="n">rds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">netxen_post_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">rds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to setup interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_rxbuf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">netxen_nic_init_coalesce_defaults</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_create_sysfs_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free_rxbuf:</span>
	<span class="n">netxen_release_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netxen_free_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_out_free_sw:</span>
	<span class="n">netxen_free_sw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_nic_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netxen_remove_sysfs_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_free_hw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netxen_release_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netxen_nic_free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netxen_napi_del</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netxen_free_sw_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">netxen_nic_reset_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">==</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">__netxen_nic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

		<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">__netxen_nic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_setup_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mc_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_count</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mc_count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	   <span class="o">=</span> <span class="o">&amp;</span><span class="n">netxen_netdev_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>     <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="n">netxen_nic_change_mtu</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netxen_nic_ethtool_ops</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span>
	                      <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_IPV6_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_using_dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_FVLANTX</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_HW_LRO</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_LRO</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">,</span> <span class="n">netxen_tx_timeout_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_read_mac_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read mac addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCIEAER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_mask_aer_correctable</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aer_pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span> <span class="o">!=</span> <span class="n">NETXEN_BRDTYPE_P3_4_GB_MM</span> <span class="o">&amp;&amp;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span> <span class="o">!=</span> <span class="n">NETXEN_BRDTYPE_P3_10G_TP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">!=</span> <span class="n">PCI_EXP_TYPE_ROOT_PORT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">aer_pos</span> <span class="o">=</span> <span class="n">pci_find_ext_capability</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">PCI_EXT_CAP_ID_ERR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aer_pos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">aer_pos</span> <span class="o">+</span> <span class="n">PCI_ERR_COR_MASK</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">netxen_nic_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_func_id</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">revision_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="n">NX_P3_A0</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="n">NX_P3_B1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: chip revisions between 0x%x-0x%x &quot;</span>
				<span class="s">&quot;will not be enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">module_name</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">),</span> <span class="n">NX_P3_A0</span><span class="p">,</span> <span class="n">NX_P3_B1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netxen_nic_driver_name</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">))</span>
		<span class="n">pci_enable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span>  <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span>    <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span>  <span class="o">=</span> <span class="n">pci_func_id</span><span class="p">;</span>

	<span class="n">revision_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span> <span class="o">=</span> <span class="n">revision_id</span><span class="p">;</span>

	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_clean_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_ip_list</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_setup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>

	<span class="cm">/* This will be reset for mezz cards  */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">=</span> <span class="n">pci_func_id</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_get_board_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error getting board config info.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCIEAER</span>
	<span class="n">netxen_mask_aer_correctable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Mezz cards have PCI function 0,2,3 enabled */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_IMEZ</span>:
	<span class="k">case</span> <span class="n">NETXEN_BRDTYPE_P2_SB31_10G_HMEZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_func_id</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">=</span> <span class="n">pci_func_id</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_check_flash_fw_compatibility</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_decr_ref</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if the firmware gave us a virtual-physical port mapping.</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_V2P</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mh">0x55555555</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_nic_clear_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_setup_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_setup_netdev</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_disable_msi</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">port_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETXEN_NIC_GBE</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: GbE port initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETXEN_NIC_XGBE</span>:
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: XGbE port initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_create_diag_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_disable_msi:</span>
	<span class="n">netxen_teardown_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_free_dummy_dma</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err_out_decr_ref:</span>
	<span class="n">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err_out_iounmap:</span>
	<span class="n">netxen_cleanup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">netxen_cleanup_minidump</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_capture_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">netxen_nic_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">netxen_cancel_fw_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>

	<span class="n">netxen_free_vlan_ip_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netxen_free_dummy_dma</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">netxen_teardown_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_remove_diag_entries</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_cleanup_pci_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netxen_release_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netxen_cleanup_minidump</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">pci_disable_pcie_error_reporting</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_nic_detach_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netxen_cancel_fw_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netxen_nic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>

	<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netxen_free_dummy_dma</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_attach_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">crb_win</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">ocm_win</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to start firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out_detach</span><span class="p">;</span>

		<span class="n">netxen_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_detach:</span>
	<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">netxen_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nx_dev_request_aer</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

	<span class="n">netxen_nic_detach_func</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">netxen_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_attach_func</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span> <span class="o">:</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_cleanup_aer_uncorrect_error_status</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_nic_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netxen_nic_detach_func</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_nic_wol_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">netxen_nic_detach_func</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_nic_wol_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_nic_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">netxen_nic_attach_func</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">driver_mismatch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__netxen_nic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * netxen_nic_close - Disables a network interface entry point</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">__netxen_nic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_tso_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">nx_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">first_desc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_ETHER_PKT</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">protocol</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">producer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">,</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tso</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vlan_oob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">hwdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="n">vh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">vh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">protocol</span> <span class="o">=</span> <span class="n">vh</span><span class="o">-&gt;</span><span class="n">h_vlan_encapsulated_proto</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS_VLAN_TAGGED</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS_VLAN_OOB</span><span class="p">;</span>
		<span class="n">vid</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">netxen_set_tx_vlan_tci</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
		<span class="n">vlan_oob</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_TSO</span> <span class="o">|</span> <span class="n">NETIF_F_TSO6</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">);</span>
		<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">total_hdr_length</span> <span class="o">=</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vlan_oob</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">total_hdr_length</span> <span class="o">+=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">tcp_hdr_offset</span> <span class="o">=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">ip_hdr_offset</span> <span class="o">=</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
			<span class="cm">/* Only in case of TSO on vlan device */</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAGS_VLAN_TAGGED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">))</span> <span class="o">?</span>
				<span class="n">TX_TCP_LSO6</span> <span class="o">:</span> <span class="n">TX_TCP_LSO</span><span class="p">;</span>
		<span class="n">tso</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">l4proto</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l4proto</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_TCP_PKT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_UDP_PKT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IPV6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">l4proto</span> <span class="o">=</span> <span class="n">ipv6_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nexthdr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_TCPV6_PKT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">l4proto</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
				<span class="n">opcode</span> <span class="o">=</span> <span class="n">TX_UDPV6_PKT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">tcp_hdr_offset</span> <span class="o">+=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">first_desc</span><span class="o">-&gt;</span><span class="n">ip_hdr_offset</span> <span class="o">+=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">netxen_set_tx_flags_opcode</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tso</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* For LSO, we need to copy the MAC/IP/TCP headers into</span>
<span class="cm">	 * the descriptor ring</span>
<span class="cm">	 */</span>
	<span class="n">producer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">;</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_oob</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Create a TSO vlan header template for firmware */</span>

		<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">copy_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">hdr_len</span> <span class="o">+</span> <span class="n">VLAN_HLEN</span><span class="p">);</span>

		<span class="n">vh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vlan_ethhdr</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vh</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">vh</span><span class="o">-&gt;</span><span class="n">h_vlan_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_8021Q</span><span class="p">);</span>
		<span class="n">vh</span><span class="o">-&gt;</span><span class="n">h_vlan_TCI</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">vid</span><span class="p">);</span>
		<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">vh</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">copy_len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">copied</span> <span class="o">=</span> <span class="n">copy_len</span> <span class="o">-</span> <span class="n">VLAN_HLEN</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&lt;</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">copy_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_desc_type0</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
				<span class="p">(</span><span class="n">hdr_len</span> <span class="o">-</span> <span class="n">copied</span><span class="p">));</span>

		<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
		<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">copied</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>

		<span class="n">copied</span> <span class="o">+=</span> <span class="n">copy_len</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="n">producer</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_map_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netxen_cmd_buffer</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_skb_frag</span> <span class="o">*</span><span class="n">nf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">map</span><span class="p">;</span>

	<span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
	<span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">map</span> <span class="o">=</span> <span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
				       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">map</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>

		<span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
		<span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nf</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">netxen_clear_cmddesc</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0ULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">netxen_nic_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nx_host_tx_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_cmd_buffer</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_skb_frag</span> <span class="o">*</span><span class="n">buffrag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_desc_type0</span> <span class="o">*</span><span class="n">hwdesc</span><span class="p">,</span> <span class="o">*</span><span class="n">first_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">producer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_count</span><span class="p">,</span> <span class="n">no_of_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_txd</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span>

	<span class="n">frag_count</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 14 frags supported for normal packet and</span>
<span class="cm">	 * 32 frags supported for TSO packet</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">frag_count</span> <span class="o">&gt;</span> <span class="n">NETXEN_MAX_FRAGS_PER_TX</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">frag_count</span> <span class="o">-</span> <span class="n">NETXEN_MAX_FRAGS_PER_TX</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">delta</span> <span class="o">+=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__pskb_pull_tail</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">delta</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>

		<span class="n">frag_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 4 fragments per cmd des */</span>
	<span class="n">no_of_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">frag_count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netxen_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">TX_STOP_THRESH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_tx_avail</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">TX_STOP_THRESH</span><span class="p">)</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">producer</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_map_tx_skb</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>

	<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_count</span> <span class="o">=</span> <span class="n">frag_count</span><span class="p">;</span>

	<span class="n">first_desc</span> <span class="o">=</span> <span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
	<span class="n">netxen_clear_cmddesc</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span><span class="p">);</span>

	<span class="n">netxen_set_tx_frags_len</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">frag_count</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">netxen_set_tx_port</span><span class="p">(</span><span class="n">first_desc</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frag_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* move to next desc.*/</span>
			<span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">num_txd</span><span class="p">);</span>
			<span class="n">hwdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc_head</span><span class="p">[</span><span class="n">producer</span><span class="p">];</span>
			<span class="n">netxen_clear_cmddesc</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">hwdesc</span><span class="p">);</span>
			<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">cmd_buf_arr</span><span class="p">[</span><span class="n">producer</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buffrag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">frag_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">buffer_length</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer1</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer2</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer3</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">hwdesc</span><span class="o">-&gt;</span><span class="n">addr_buffer4</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffrag</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">producer</span> <span class="o">=</span> <span class="n">get_next_index</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">num_txd</span><span class="p">);</span>

	<span class="n">netxen_tso_check</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">,</span> <span class="n">first_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmitcalled</span><span class="o">++</span><span class="p">;</span>

	<span class="n">netxen_nic_update_cmd_producer</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tx_ring</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">drop_packet:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txdropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_check_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">,</span> <span class="n">temp_state</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_TEMP_STATE</span><span class="p">);</span>

	<span class="n">temp_state</span> <span class="o">=</span> <span class="n">nx_get_temp_state</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">temp_val</span> <span class="o">=</span> <span class="n">nx_get_temp_val</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">NX_TEMP_PANIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
		       <span class="s">&quot;%s: Device temperature %d degrees C exceeds&quot;</span>
		       <span class="s">&quot; maximum allowed. Hardware has been shut down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp_state</span> <span class="o">==</span> <span class="n">NX_TEMP_WARN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">==</span> <span class="n">NX_TEMP_NORMAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
			       <span class="s">&quot;%s: Device temperature %d degrees C &quot;</span>
			       <span class="s">&quot;exceeds operating range.&quot;</span>
			       <span class="s">&quot; Immediate action needed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">temp_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">==</span> <span class="n">NX_TEMP_WARN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;%s: Device temperature is now %d degrees C&quot;</span>
			       <span class="s">&quot; in normal range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">temp_val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">netxen_advert_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">linkup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">linkup</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">linkup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s NIC Link is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">netxen_nic_driver_name</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_changed</span> <span class="o">=</span> <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">has_link_events</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">linkup</span> <span class="o">&amp;&amp;</span> <span class="n">linkup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s NIC Link is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">netxen_nic_driver_name</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">linkup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_changed</span> <span class="o">=</span> <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">has_link_events</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_nic_handle_phy_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">linkup</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physical_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_XG_STATE_P3</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">XG_LINK_STATE_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">pci_func</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">linkup</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">XG_LINK_UP_P3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">CRB_XG_STATE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">port</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">linkup</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">XG_LINK_UP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netxen_advert_link_change</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">linkup</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;transmit timeout, resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">netxen_adapter</span><span class="p">,</span> <span class="n">tx_timeout_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeo_cnt</span> <span class="o">&gt;=</span> <span class="n">NX_MAX_TX_TIMEOUTS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">request_reset</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* try to scrub interrupt */</span>
		<span class="n">netxen_napi_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">netxen_napi_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netxen_nic_reset_context</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">request_reset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">request_reset:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="nf">netxen_nic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_pkts</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lro_pkts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xmitfinished</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxbytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txbytes</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxdropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txdropped</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">netxen_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">int_vec_bit</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* check interrupt state machine, to be sure */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ISR_LEGACY_INT_TRIGGERED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">our_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">our_int</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span><span class="p">);</span>

		<span class="cm">/* not our interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">((</span><span class="mi">7</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">portnum</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">our_int</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

		<span class="cm">/* claim interrupt */</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">our_int</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">),</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">crb_int_state_reg</span><span class="p">);</span>

		<span class="cm">/* clear interrupt */</span>
		<span class="n">netxen_nic_disable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>
	<span class="cm">/* read twice to ensure write is flushed */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_int_vec</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">netxen_msi_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="cm">/* clear interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tgt_status_reg</span><span class="p">);</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">netxen_msix_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_nic_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nx_host_sds_ring</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">tx_complete</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">tx_complete</span> <span class="o">=</span> <span class="n">netxen_process_cmd_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">work_done</span> <span class="o">=</span> <span class="n">netxen_process_rcv_ring</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tx_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sds_ring</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__NX_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
			<span class="n">netxen_nic_enable_int</span><span class="p">(</span><span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">netxen_nic_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_host_sds_ring</span> <span class="o">*</span><span class="n">sds_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_recv_context</span> <span class="o">*</span><span class="n">recv_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">recv_ctx</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ring</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_sds_rings</span><span class="p">;</span> <span class="n">ring</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sds_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">recv_ctx</span><span class="o">-&gt;</span><span class="n">sds_rings</span><span class="p">[</span><span class="n">ring</span><span class="p">];</span>
		<span class="n">netxen_intr</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sds_ring</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nx_incr_dev_ref_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">);</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">,</span> <span class="o">++</span><span class="n">count</span><span class="p">);</span>

	<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">,</span> <span class="o">--</span><span class="n">count</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">NX_DEV_FAILED</span><span class="p">)</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_COLD</span><span class="p">);</span>

	<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nx_dev_request_aer</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_NEED_AER</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_NEED_AER</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nx_dev_request_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_NEED_RESET</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_FAILED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">NX_DEV_INITALIZING</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">NX_DEV_NEED_AER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_NEED_RESET</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NETXEN_FW_RESET_OWNER</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_can_start_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">can_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nx_incr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">NX_MAX_PCI_FUNC</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">can_start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_INITALIZING</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">,</span> <span class="o">++</span><span class="n">count</span><span class="p">);</span>

	<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">can_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_schedule_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">work_func_t</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">,</span> <span class="n">func</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_cancel_fw_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_attach_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_attach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">netxen_nic_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netxen_restore_indev_addr</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">NETDEV_UP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_fwinit_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dev_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">dev_state</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_FW_RESET_OWNER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mdump</span><span class="p">.</span><span class="n">md_enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtnl_lock</span><span class="p">();</span>
				<span class="n">netxen_dump_fw</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
				<span class="n">rtnl_unlock</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETXEN_FW_RESET_OWNER</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
				<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span>
						<span class="n">NX_DEV_FAILED</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">);</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_REF_COUNT</span><span class="p">,</span> <span class="o">--</span><span class="n">count</span><span class="p">);</span>
			<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_COLD</span><span class="p">);</span>
			<span class="n">dev_state</span> <span class="o">=</span> <span class="n">NX_DEV_COLD</span><span class="p">;</span>
			<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NX_DEV_COLD</span>:
	<span class="k">case</span> <span class="n">NX_DEV_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netxen_start_firmware</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_attach_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NX_DEV_NEED_RESET</span>:
	<span class="k">case</span> <span class="n">NX_DEV_INITALIZING</span>:
			<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">netxen_fwinit_work</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NX_DEV_FAILED</span>:
	<span class="nl">default:</span>
		<span class="n">nx_incr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_api_lock</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">,</span> <span class="n">NX_DEV_FAILED</span><span class="p">);</span>
	<span class="n">netxen_api_unlock</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Device initialization Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_detach_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ref_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netxen_nic_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">netxen_nic_detach</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PEG_HALT_STATUS1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NX_RCODE_FATAL_ERROR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">temp</span> <span class="o">==</span> <span class="n">NX_TEMP_PANIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_FW_RESET_OWNER</span><span class="p">))</span>
		<span class="n">ref_cnt</span> <span class="o">=</span> <span class="n">nx_decr_dev_ref_cnt</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ref_cnt</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ret</span><span class="p">;</span>

	<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_wait_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_fwinit_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_ret:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_check_health</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">,</span> <span class="n">heartbit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">peg_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NX_CRB_DEV_STATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_NEED_AER</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_nic_check_temp</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nx_dev_request_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NX_DEV_NEED_RESET, this state can be marked in two cases</span>
<span class="cm">	 * 1. Tx timeout 2. Fw hang</span>
<span class="cm">	 * Send request to destroy context in case of tx timeout only</span>
<span class="cm">	 * and doesn&#39;t required in case of Fw hang</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_NEED_RESET</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">NX_DEV_FAILED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">heartbit</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PEG_ALIVE_COUNTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">heartbit</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">heartbit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">heartbit</span> <span class="o">=</span> <span class="n">heartbit</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_fw_reset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">detach</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_fail_cnt</span> <span class="o">&lt;</span> <span class="n">FW_FAIL_THRESH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nx_dev_request_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__NX_FW_ATTACHED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware hang detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">peg_status</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PEG_HALT_STATUS1</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Dumping hw/fw registers</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_HALT_STATUS1: 0x%x, PEG_HALT_STATUS2: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_NET_0_PC: 0x%x, PEG_NET_1_PC: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_NET_2_PC: 0x%x, PEG_NET_3_PC: 0x%x,</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="s">&quot;PEG_NET_4_PC: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">peg_status</span><span class="p">,</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_PEG_HALT_STATUS2</span><span class="p">),</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CRB_PEG_NET_0</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CRB_PEG_NET_1</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CRB_PEG_NET_2</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CRB_PEG_NET_3</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">),</span>
			<span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_CRB_PEG_NET_4</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_FWERROR_PEGSTAT1</span><span class="p">(</span><span class="n">peg_status</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x67</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Firmware aborted with error code 0x00006700. &quot;</span>
				<span class="s">&quot;Device is being reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">detach:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">auto_fw_reset</span> <span class="o">==</span> <span class="n">AUTO_FW_RESET_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_detach_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_fw_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">netxen_adapter</span><span class="p">,</span> <span class="n">fw_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__NX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">reschedule</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__NX_DEV_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">has_link_events</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">netxen_nic_handle_phy_intr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_changed</span><span class="p">)</span>
				<span class="n">netxen_nic_set_link_parameters</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netxen_check_health</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="nl">reschedule:</span>
	<span class="n">netxen_schedule_work</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netxen_fw_poll_work</span><span class="p">,</span> <span class="n">FW_POLL_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_store_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_BDG</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netxen_config_bridged_mode</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">!!</span><span class="n">new</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_show_bridged_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="n">to_net_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bridged_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_BDG</span><span class="p">)</span>
		<span class="n">bridged_mode</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_BRIDGE_ENABLED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bridged_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_bridged_mode</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bridged_mode&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
       <span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">netxen_show_bridged_mode</span><span class="p">,</span>
       <span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">netxen_store_bridged_mode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_store_diag_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">new</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_DIAG_ENABLED</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^=</span> <span class="n">NETXEN_NIC_DIAG_ENABLED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_show_diag_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_DIAG_ENABLED</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_diag_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;diag_mode&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">netxen_show_diag_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">netxen_store_diag_mode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_sysfs_validate_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">crb_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_DIAG_ENABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">NETXEN_PCI_CRBSPACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">NETXEN_PCI_CAMQM</span><span class="p">,</span>
						<span class="n">NETXEN_PCI_CAMQM_2M_END</span><span class="p">))</span>
			<span class="n">crb_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="n">crb_size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">crb_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_sysfs_read_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">qmdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netxen_sysfs_validate_crb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">NETXEN_PCI_CAMQM</span><span class="p">,</span>
					<span class="n">NETXEN_PCI_CAMQM_2M_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netxen_pci_camqm_read_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qmdata</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qmdata</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_sysfs_write_crb</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">qmdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netxen_sysfs_validate_crb</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P3</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">ADDR_IN_RANGE</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">NETXEN_PCI_CAMQM</span><span class="p">,</span>
					<span class="n">NETXEN_PCI_CAMQM_2M_END</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qmdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">netxen_pci_camqm_write_2M</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">qmdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">NXWR32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_sysfs_validate_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NETXEN_NIC_DIAG_ENABLED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_sysfs_read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netxen_sysfs_validate_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_mem_read</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">netxen_sysfs_write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netxen_sysfs_validate_mem</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pci_mem_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_crb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;crb&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">netxen_sysfs_read_crb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">netxen_sysfs_write_crb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_mem</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mem&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">netxen_sysfs_read_mem</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">netxen_sysfs_write_mem</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">netxen_sysfs_read_dimm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netxen_dimm_cfg</span> <span class="n">dimm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dw</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">banks</span><span class="p">,</span> <span class="n">ranks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_dimm_cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dimm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_dimm_cfg</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">NXRD32</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">NETXEN_DIMM_CAPABILITY</span><span class="p">);</span>

	<span class="cm">/* Checks if DIMM info is valid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">NETXEN_DIMM_VALID_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid DIMM flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dimm</span><span class="p">.</span><span class="n">presence</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rows</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_NUMROWS</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">cols</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_NUMCOLS</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">ranks</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_NUMRANKS</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">banks</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_NUMBANKS</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">dw</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_DATAWIDTH</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">dimm</span><span class="p">.</span><span class="n">presence</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">NETXEN_DIMM_PRESENT</span><span class="p">);</span>

	<span class="cm">/* Checks if DIMM info is present. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dimm</span><span class="p">.</span><span class="n">presence</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;DIMM not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dimm</span><span class="p">.</span><span class="n">dimm_type</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_TYPE</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dimm</span><span class="p">.</span><span class="n">dimm_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETXEN_DIMM_TYPE_RDIMM</span>:
	<span class="k">case</span> <span class="n">NETXEN_DIMM_TYPE_UDIMM</span>:
	<span class="k">case</span> <span class="n">NETXEN_DIMM_TYPE_SO_DIMM</span>:
	<span class="k">case</span> <span class="n">NETXEN_DIMM_TYPE_Micro_DIMM</span>:
	<span class="k">case</span> <span class="n">NETXEN_DIMM_TYPE_Mini_RDIMM</span>:
	<span class="k">case</span> <span class="n">NETXEN_DIMM_TYPE_Mini_UDIMM</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid DIMM type %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dimm</span><span class="p">.</span><span class="n">dimm_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">NETXEN_DIMM_MEMTYPE_DDR2_SDRAM</span><span class="p">)</span>
		<span class="n">dimm</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_MEM_DDR2_SDRAM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dimm</span><span class="p">.</span><span class="n">mem_type</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_MEMTYPE</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">NETXEN_DIMM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dimm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">NETXEN_DIMM_STD_MEM_SIZE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rows</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid no of rows %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid no of columns %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cols</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">banks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid no of banks %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">banks</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ranks</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x6</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="n">dw</span> <span class="o">=</span> <span class="mi">144</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid data-width %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dimm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rows</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cols</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">*</span> <span class="n">banks</span> <span class="o">*</span> <span class="n">ranks</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="cm">/* Size returned in MB. */</span>
	<span class="n">dimm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">dimm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x100000</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dimm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_dimm_cfg</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_dimm_cfg</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">bin_attr_dimm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dimm&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">netxen_sysfs_read_dimm</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_create_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_BDG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bridged_mode control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bridged_mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to create bridged_mode sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_remove_sysfs_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">NX_FW_CAPABILITY_BDG</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bridged_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_create_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_diag_mode</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create diag_mode sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_crb</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create crb sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_mem</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create mem sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_dimm</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create dimm sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_remove_diag_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_diag_mode</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_crb</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_mem</span><span class="p">);</span>
	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bin_attr_dimm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_INET</span>

<span class="cp">#define is_netxen_netdev(dev) (dev-&gt;netdev_ops == &amp;netxen_netdev_ops)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_destip_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NX_IS_REVISION_P2</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">revision_id</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ahw</span><span class="p">.</span><span class="n">cut_through</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_free_vlan_ip_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nx_vlan_ip_list</span>  <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_ip_list</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nx_vlan_ip_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">netxen_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">NX_IP_DOWN</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_list_config_vlan_ip</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nx_vlan_ip_list</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">?</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_vlan_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NX_IP_UP</span>:
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_ip_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nx_vlan_ip_list</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cur</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nx_vlan_ip_list</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to add vlan ip to list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cur</span><span class="o">-&gt;</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_ip_list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NX_IP_DOWN</span>:
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="n">tmp_cur</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_ip_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ip_addr</span> <span class="o">==</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_config_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">indev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netxen_destip_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">indev</span> <span class="o">=</span> <span class="n">in_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">indev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_ifa</span><span class="p">(</span><span class="n">indev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NETDEV_UP</span>:
			<span class="n">netxen_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">NX_IP_UP</span><span class="p">);</span>
			<span class="n">netxen_list_config_vlan_ip</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">NX_IP_UP</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
			<span class="n">netxen_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">NX_IP_DOWN</span><span class="p">);</span>
			<span class="n">netxen_list_config_vlan_ip</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">NX_IP_DOWN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="n">endfor_ifa</span><span class="p">(</span><span class="n">indev</span><span class="p">);</span>

	<span class="n">in_dev_put</span><span class="p">(</span><span class="n">indev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_restore_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nx_vlan_ip_list</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip_event</span><span class="p">;</span>

	<span class="n">ip_event</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">NETDEV_UP</span><span class="p">)</span> <span class="o">?</span> <span class="n">NX_IP_UP</span> <span class="o">:</span> <span class="n">NX_IP_DOWN</span><span class="p">;</span>
	<span class="n">netxen_config_indev_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">tmp_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vlan_ip_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netxen_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">ip_event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netxen_netdev_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">orig_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">recheck:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">recheck</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_netxen_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">netxen_config_indev_addr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">orig_dev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netxen_inetaddr_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span> <span class="o">?</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">recheck:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;</span> <span class="n">IFF_802_1Q_VLAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">vlan_dev_real_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">recheck</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_netxen_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span> <span class="o">||</span> <span class="o">!</span><span class="n">netxen_destip_supported</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_up</span> <span class="o">!=</span> <span class="n">NETXEN_ADAPTER_UP_MAGIC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NETDEV_UP</span>:
		<span class="n">netxen_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">NX_IP_UP</span><span class="p">);</span>
		<span class="n">netxen_list_config_vlan_ip</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">NX_IP_UP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NETDEV_DOWN</span>:
		<span class="n">netxen_config_ipaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_address</span><span class="p">,</span> <span class="n">NX_IP_DOWN</span><span class="p">);</span>
		<span class="n">netxen_list_config_vlan_ip</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">NX_IP_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span>	<span class="n">netxen_netdev_cb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">netxen_netdev_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">netxen_inetaddr_cb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">netxen_inetaddr_event</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_restore_indev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">netxen_free_vlan_ip_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">netxen_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">netxen_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">netxen_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">netxen_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">netxen_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">netxen_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">netxen_nic_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">netxen_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">netxen_nic_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">netxen_nic_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">netxen_nic_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">netxen_nic_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">netxen_nic_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netxen_err_handler</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">netxen_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netxen_nic_driver_string</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INET</span>
	<span class="n">register_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netxen_netdev_cb</span><span class="p">);</span>
	<span class="n">register_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netxen_inetaddr_cb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netxen_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">netxen_init_module</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">netxen_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netxen_driver</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_INET</span>
	<span class="n">unregister_inetaddr_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netxen_inetaddr_cb</span><span class="p">);</span>
	<span class="n">unregister_netdevice_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netxen_netdev_cb</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">netxen_exit_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
