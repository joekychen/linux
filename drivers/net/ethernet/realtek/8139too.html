<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › realtek › 8139too.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>8139too.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">	8139too.c: A RealTek RTL-8139 Fast Ethernet driver for Linux.</span>

<span class="cm">	Maintained by Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm">	Copyright 2000-2002 Jeff Garzik</span>

<span class="cm">	Much code comes from Donald Becker&#39;s rtl8139.c driver,</span>
<span class="cm">	versions 1.13 and older.  This driver was originally based</span>
<span class="cm">	on rtl8139.c version 1.07.  Header of rtl8139.c version 1.13:</span>

<span class="cm">	-----&lt;snip&gt;-----</span>

<span class="cm">        	Written 1997-2001 by Donald Becker.</span>
<span class="cm">		This software may be used and distributed according to the</span>
<span class="cm">		terms of the GNU General Public License (GPL), incorporated</span>
<span class="cm">		herein by reference.  Drivers based on or derived from this</span>
<span class="cm">		code fall under the GPL and must retain the authorship,</span>
<span class="cm">		copyright and license notice.  This file is not a complete</span>
<span class="cm">		program and may only be used when the entire operating</span>
<span class="cm">		system is licensed under the GPL.</span>

<span class="cm">		This driver is for boards based on the RTL8129 and RTL8139</span>
<span class="cm">		PCI ethernet chips.</span>

<span class="cm">		The author may be reached as becker@scyld.com, or C/O Scyld</span>
<span class="cm">		Computing Corporation 410 Severn Ave., Suite 210 Annapolis</span>
<span class="cm">		MD 21403</span>

<span class="cm">		Support and updates available at</span>
<span class="cm">		http://www.scyld.com/network/rtl8139.html</span>

<span class="cm">		Twister-tuning table provided by Kinston</span>
<span class="cm">		&lt;shangh@realtek.com.tw&gt;.</span>

<span class="cm">	-----&lt;snip&gt;-----</span>

<span class="cm">	This software may be used and distributed according to the terms</span>
<span class="cm">	of the GNU General Public License, incorporated herein by reference.</span>

<span class="cm">	Contributors:</span>

<span class="cm">		Donald Becker - he wrote the original driver, kudos to him!</span>
<span class="cm">		(but please don&#39;t e-mail him for support, this isn&#39;t his driver)</span>

<span class="cm">		Tigran Aivazian - bug fixes, skbuff free cleanup</span>

<span class="cm">		Martin Mares - suggestions for PCI cleanup</span>

<span class="cm">		David S. Miller - PCI DMA and softnet updates</span>

<span class="cm">		Ernst Gill - fixes ported from BSD driver</span>

<span class="cm">		Daniel Kobras - identified specific locations of</span>
<span class="cm">			posted MMIO write bugginess</span>

<span class="cm">		Gerard Sharp - bug fix, testing and feedback</span>

<span class="cm">		David Ford - Rx ring wrap fix</span>

<span class="cm">		Dan DeMaggio - swapped RTL8139 cards with me, and allowed me</span>
<span class="cm">		to find and fix a crucial bug on older chipsets.</span>

<span class="cm">		Donald Becker/Chris Butterworth/Marcus Westergren -</span>
<span class="cm">		Noticed various Rx packet size-related buglets.</span>

<span class="cm">		Santiago Garcia Mantinan - testing and feedback</span>

<span class="cm">		Jens David - 2.2.x kernel backports</span>

<span class="cm">		Martin Dennett - incredibly helpful insight on undocumented</span>
<span class="cm">		features of the 8139 chips</span>

<span class="cm">		Jean-Jacques Michel - bug fix</span>

<span class="cm">		Tobias Ringström - Rx interrupt status checking suggestion</span>

<span class="cm">		Andrew Morton - Clear blocked signals, avoid</span>
<span class="cm">		buffer overrun setting current-&gt;comm.</span>

<span class="cm">		Kalle Olavi Niemitalo - Wake-on-LAN ioctls</span>

<span class="cm">		Robert Kuebel - Save kernel thread from dying on any signal.</span>

<span class="cm">	Submitting bug reports:</span>

<span class="cm">		&quot;rtl8139-diag -mmmaaavvveefN&quot; output</span>
<span class="cm">		enable RTL8139_DEBUG below, and look at &#39;dmesg&#39; or kernel log</span>

<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define DRV_NAME	&quot;8139too&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;0.9.28&quot;</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#define RTL8139_DRIVER_NAME   DRV_NAME &quot; Fast Ethernet driver &quot; DRV_VERSION</span>

<span class="cm">/* Default Message level */</span>
<span class="cp">#define RTL8139_DEF_MSG_ENABLE   (NETIF_MSG_DRV   | \</span>
<span class="cp">                                 NETIF_MSG_PROBE  | \</span>
<span class="cp">                                 NETIF_MSG_LINK)</span>


<span class="cm">/* define to 1, 2 or 3 to enable copious debugging info */</span>
<span class="cp">#define RTL8139_DEBUG 0</span>

<span class="cm">/* define to 1 to disable lightweight runtime debugging checks */</span>
<span class="cp">#undef RTL8139_NDEBUG</span>


<span class="cp">#ifdef RTL8139_NDEBUG</span>
<span class="cp">#  define assert(expr) do {} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#  define assert(expr) \</span>
<span class="cp">        if (unlikely(!(expr))) {				\</span>
<span class="cp">		pr_err(&quot;Assertion failed! %s,%s,%s,line=%d\n&quot;,	\</span>
<span class="cp">		       #expr, __FILE__, __func__, __LINE__);	\</span>
<span class="cp">        }</span>
<span class="cp">#endif</span>


<span class="cm">/* A few user-configurable values. */</span>
<span class="cm">/* media options */</span>
<span class="cp">#define MAX_UNITS 8</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">media</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">MAX_UNITS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">};</span>

<span class="cm">/* Whether to use MMIO or PIO. Default to MMIO. */</span>
<span class="cp">#ifdef CONFIG_8139TOO_PIO</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_io</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">use_io</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* Maximum number of multicast addresses to filter (vs. Rx-all-multicast).</span>
<span class="cm">   The RTL chips use a 64 element hash table based on the Ethernet CRC.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="cm">/* bitmapped message enable number */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Receive ring size</span>
<span class="cm"> * Warning: 64K ring has hardware issues and may lock up.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_SH_DREAMCAST)</span>
<span class="cp">#define RX_BUF_IDX 0	</span><span class="cm">/* 8K ring */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define RX_BUF_IDX	2	</span><span class="cm">/* 32K ring */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#define RX_BUF_LEN	(8192 &lt;&lt; RX_BUF_IDX)</span>
<span class="cp">#define RX_BUF_PAD	16</span>
<span class="cp">#define RX_BUF_WRAP_PAD 2048 </span><span class="cm">/* spare padding to handle lack of packet wrap */</span><span class="cp"></span>

<span class="cp">#if RX_BUF_LEN == 65536</span>
<span class="cp">#define RX_BUF_TOT_LEN	RX_BUF_LEN</span>
<span class="cp">#else</span>
<span class="cp">#define RX_BUF_TOT_LEN	(RX_BUF_LEN + RX_BUF_PAD + RX_BUF_WRAP_PAD)</span>
<span class="cp">#endif</span>

<span class="cm">/* Number of Tx descriptor registers. */</span>
<span class="cp">#define NUM_TX_DESC	4</span>

<span class="cm">/* max supported ethernet frame size -- must be at least (dev-&gt;mtu+14+4).*/</span>
<span class="cp">#define MAX_ETH_FRAME_SIZE	1536</span>

<span class="cm">/* Size of the Tx bounce buffers -- must be at least (dev-&gt;mtu+14+4). */</span>
<span class="cp">#define TX_BUF_SIZE	MAX_ETH_FRAME_SIZE</span>
<span class="cp">#define TX_BUF_TOT_LEN	(TX_BUF_SIZE * NUM_TX_DESC)</span>

<span class="cm">/* PCI Tuning Parameters</span>
<span class="cm">   Threshold is bytes transferred to chip before transmission starts. */</span>
<span class="cp">#define TX_FIFO_THRESH 256	</span><span class="cm">/* In bytes, rounded down to 32 byte units. */</span><span class="cp"></span>

<span class="cm">/* The following settings are log_2(bytes)-4:  0 == 16 bytes .. 6==1024, 7==end of packet. */</span>
<span class="cp">#define RX_FIFO_THRESH	7	</span><span class="cm">/* Rx buffer level before first PCI xfer.  */</span><span class="cp"></span>
<span class="cp">#define RX_DMA_BURST	7	</span><span class="cm">/* Maximum PCI burst, &#39;6&#39; is 1024 */</span><span class="cp"></span>
<span class="cp">#define TX_DMA_BURST	6	</span><span class="cm">/* Maximum PCI burst, &#39;6&#39; is 1024 */</span><span class="cp"></span>
<span class="cp">#define TX_RETRY	8	</span><span class="cm">/* 0-15.  retries = 16 + (TX_RETRY * 16) */</span><span class="cp"></span>

<span class="cm">/* Operational parameters that usually are not changed. */</span>
<span class="cm">/* Time in jiffies before concluding the transmitter is hung. */</span>
<span class="cp">#define TX_TIMEOUT  (6*HZ)</span>


<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HAS_MII_XCVR</span> <span class="o">=</span> <span class="mh">0x010000</span><span class="p">,</span>
	<span class="n">HAS_CHIP_XCVR</span> <span class="o">=</span> <span class="mh">0x020000</span><span class="p">,</span>
	<span class="n">HAS_LNK_CHNG</span> <span class="o">=</span> <span class="mh">0x040000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define RTL_NUM_STATS 4		</span><span class="cm">/* number of ETHTOOL_GSTATS u64&#39;s */</span><span class="cp"></span>
<span class="cp">#define RTL_REGS_VER 1		</span><span class="cm">/* version of reg. data in ETHTOOL_GREGS */</span><span class="cp"></span>
<span class="cp">#define RTL_MIN_IO_SIZE 0x80</span>
<span class="cp">#define RTL8139B_IO_SIZE 256</span>

<span class="cp">#define RTL8129_CAPS	HAS_MII_XCVR</span>
<span class="cp">#define RTL8139_CAPS	(HAS_CHIP_XCVR|HAS_LNK_CHNG)</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">RTL8139</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RTL8129</span><span class="p">,</span>
<span class="p">}</span> <span class="n">board_t</span><span class="p">;</span>


<span class="cm">/* indexed by board_t, above */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">board_info</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;RealTek RTL8139&quot;</span><span class="p">,</span> <span class="n">RTL8139_CAPS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;RealTek RTL8129&quot;</span><span class="p">,</span> <span class="n">RTL8129_CAPS</span> <span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">rtl8139_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x10ec</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x10ec</span><span class="p">,</span> <span class="mh">0x8138</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1113</span><span class="p">,</span> <span class="mh">0x1211</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1500</span><span class="p">,</span> <span class="mh">0x1360</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x4033</span><span class="p">,</span> <span class="mh">0x1360</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1186</span><span class="p">,</span> <span class="mh">0x1300</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1186</span><span class="p">,</span> <span class="mh">0x1340</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x13d1</span><span class="p">,</span> <span class="mh">0xab06</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1259</span><span class="p">,</span> <span class="mh">0xa117</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1259</span><span class="p">,</span> <span class="mh">0xa11e</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x14ea</span><span class="p">,</span> <span class="mh">0xab06</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x14ea</span><span class="p">,</span> <span class="mh">0xab07</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x11db</span><span class="p">,</span> <span class="mh">0x1234</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1432</span><span class="p">,</span> <span class="mh">0x9130</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x02ac</span><span class="p">,</span> <span class="mh">0x1012</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x018a</span><span class="p">,</span> <span class="mh">0x0106</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x126c</span><span class="p">,</span> <span class="mh">0x1211</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x1743</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="mh">0x021b</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>

<span class="cp">#ifdef CONFIG_SH_SECUREEDGE5410</span>
	<span class="cm">/* Bogus 8139 silicon reports 8129 without external PROM :-( */</span>
	<span class="p">{</span><span class="mh">0x10ec</span><span class="p">,</span> <span class="mh">0x8129</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
	<span class="p">{</span><span class="mh">0x10ec</span><span class="p">,</span> <span class="mh">0x8129</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8129</span> <span class="p">},</span>
<span class="cp">#endif</span>

	<span class="cm">/* some crazy cards report invalid vendor ids like</span>
<span class="cm">	 * 0x0001 here.  The other ids are valid and constant,</span>
<span class="cm">	 * so we simply don&#39;t match on the main vendor id.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="mh">0x10ec</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="mh">0x1186</span><span class="p">,</span> <span class="mh">0x1300</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x8139</span><span class="p">,</span> <span class="mh">0x13d1</span><span class="p">,</span> <span class="mh">0xab06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL8139</span> <span class="p">},</span>

	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">rtl8139_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ethtool_stats_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;early_rx&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_buf_mapped&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_timeouts&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_lost_in_ring&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* The rest of these values should never change. */</span>

<span class="cm">/* Symbolic offsets to registers. */</span>
<span class="k">enum</span> <span class="n">RTL8139_registers</span> <span class="p">{</span>
	<span class="n">MAC0</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	 <span class="cm">/* Ethernet hardware address. */</span>
	<span class="n">MAR0</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	 <span class="cm">/* Multicast filter. */</span>
	<span class="n">TxStatus0</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	 <span class="cm">/* Transmit status (Four 32bit registers). */</span>
	<span class="n">TxAddr0</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>	 <span class="cm">/* Tx descriptors (also four 32bit). */</span>
	<span class="n">RxBuf</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">ChipCmd</span>		<span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
	<span class="n">RxBufPtr</span>	<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="n">RxBufAddr</span>	<span class="o">=</span> <span class="mh">0x3A</span><span class="p">,</span>
	<span class="n">IntrMask</span>	<span class="o">=</span> <span class="mh">0x3C</span><span class="p">,</span>
	<span class="n">IntrStatus</span>	<span class="o">=</span> <span class="mh">0x3E</span><span class="p">,</span>
	<span class="n">TxConfig</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">RxConfig</span>	<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="n">Timer</span>		<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>	 <span class="cm">/* A general-purpose counter. */</span>
	<span class="n">RxMissed</span>	<span class="o">=</span> <span class="mh">0x4C</span><span class="p">,</span>  <span class="cm">/* 24 bits valid, write clears. */</span>
	<span class="n">Cfg9346</span>		<span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">Config0</span>		<span class="o">=</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="n">Config1</span>		<span class="o">=</span> <span class="mh">0x52</span><span class="p">,</span>
	<span class="n">TimerInt</span>	<span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span>
	<span class="n">MediaStatus</span>	<span class="o">=</span> <span class="mh">0x58</span><span class="p">,</span>
	<span class="n">Config3</span>		<span class="o">=</span> <span class="mh">0x59</span><span class="p">,</span>
	<span class="n">Config4</span>		<span class="o">=</span> <span class="mh">0x5A</span><span class="p">,</span>	 <span class="cm">/* absent on RTL-8139A */</span>
	<span class="n">HltClk</span>		<span class="o">=</span> <span class="mh">0x5B</span><span class="p">,</span>
	<span class="n">MultiIntr</span>	<span class="o">=</span> <span class="mh">0x5C</span><span class="p">,</span>
	<span class="n">TxSummary</span>	<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">BasicModeCtrl</span>	<span class="o">=</span> <span class="mh">0x62</span><span class="p">,</span>
	<span class="n">BasicModeStatus</span>	<span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
	<span class="n">NWayAdvert</span>	<span class="o">=</span> <span class="mh">0x66</span><span class="p">,</span>
	<span class="n">NWayLPAR</span>	<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="n">NWayExpansion</span>	<span class="o">=</span> <span class="mh">0x6A</span><span class="p">,</span>
	<span class="cm">/* Undocumented registers, but required for proper operation. */</span>
	<span class="n">FIFOTMS</span>		<span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>	 <span class="cm">/* FIFO Control and test. */</span>
	<span class="n">CSCR</span>		<span class="o">=</span> <span class="mh">0x74</span><span class="p">,</span>	 <span class="cm">/* Chip Status and Configuration Register. */</span>
	<span class="n">PARA78</span>		<span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>
	<span class="n">FlashReg</span>	<span class="o">=</span> <span class="mh">0xD4</span><span class="p">,</span>	<span class="cm">/* Communication with Flash ROM, four bytes. */</span>
	<span class="n">PARA7c</span>		<span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>	 <span class="cm">/* Magic transceiver parameter register. */</span>
	<span class="n">Config5</span>		<span class="o">=</span> <span class="mh">0xD8</span><span class="p">,</span>	 <span class="cm">/* absent on RTL-8139A */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ClearBitMasks</span> <span class="p">{</span>
	<span class="n">MultiIntrClear</span>	<span class="o">=</span> <span class="mh">0xF000</span><span class="p">,</span>
	<span class="n">ChipCmdClear</span>	<span class="o">=</span> <span class="mh">0xE2</span><span class="p">,</span>
	<span class="n">Config1Clear</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ChipCmdBits</span> <span class="p">{</span>
	<span class="n">CmdReset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CmdRxEnb</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">CmdTxEnb</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">RxBufEmpty</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Interrupt register bits, using my own meaningful names. */</span>
<span class="k">enum</span> <span class="n">IntrStatusBits</span> <span class="p">{</span>
	<span class="n">PCIErr</span>		<span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">PCSTimeout</span>	<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">RxFIFOOver</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">RxUnderrun</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">RxOverflow</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">TxErr</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">TxOK</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">RxErr</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">RxOK</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="n">RxAckBits</span>	<span class="o">=</span> <span class="n">RxFIFOOver</span> <span class="o">|</span> <span class="n">RxOverflow</span> <span class="o">|</span> <span class="n">RxOK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">TxStatusBits</span> <span class="p">{</span>
	<span class="n">TxHostOwns</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="n">TxUnderrun</span>	<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">TxStatOK</span>	<span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">TxOutOfWindow</span>	<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
	<span class="n">TxAborted</span>	<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>
	<span class="n">TxCarrierLost</span>	<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="n">RxStatusBits</span> <span class="p">{</span>
	<span class="n">RxMulticast</span>	<span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">RxPhysical</span>	<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">RxBroadcast</span>	<span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="n">RxBadSymbol</span>	<span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
	<span class="n">RxRunt</span>		<span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
	<span class="n">RxTooLong</span>	<span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
	<span class="n">RxCRCErr</span>	<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">RxBadAlign</span>	<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
	<span class="n">RxStatusOK</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in RxConfig. */</span>
<span class="k">enum</span> <span class="n">rx_mode_bits</span> <span class="p">{</span>
	<span class="n">AcceptErr</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">AcceptRunt</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">AcceptBroadcast</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">AcceptMulticast</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">AcceptMyPhys</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">AcceptAllPhys</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Bits in TxConfig. */</span>
<span class="k">enum</span> <span class="n">tx_config_bits</span> <span class="p">{</span>
        <span class="cm">/* Interframe Gap Time. Only TxIFG96 doesn&#39;t violate IEEE 802.3 */</span>
        <span class="n">TxIFGShift</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
        <span class="n">TxIFG84</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">TxIFGShift</span><span class="p">),</span> <span class="cm">/* 8.4us / 840ns (10 / 100Mbps) */</span>
        <span class="n">TxIFG88</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TxIFGShift</span><span class="p">),</span> <span class="cm">/* 8.8us / 880ns (10 / 100Mbps) */</span>
        <span class="n">TxIFG92</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">TxIFGShift</span><span class="p">),</span> <span class="cm">/* 9.2us / 920ns (10 / 100Mbps) */</span>
        <span class="n">TxIFG96</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">TxIFGShift</span><span class="p">),</span> <span class="cm">/* 9.6us / 960ns (10 / 100Mbps) */</span>

	<span class="n">TxLoopBack</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* enable loopback test mode */</span>
	<span class="n">TxCRC</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>	<span class="cm">/* DISABLE Tx pkt CRC append */</span>
	<span class="n">TxClearAbt</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* Clear abort (WO) */</span>
	<span class="n">TxDMAShift</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="cm">/* DMA burst value (0-7) is shifted X many bits */</span>
	<span class="n">TxRetryShift</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="cm">/* TXRR value (0-15) is shifted X many bits */</span>

	<span class="n">TxVersionMask</span>	<span class="o">=</span> <span class="mh">0x7C800000</span><span class="p">,</span> <span class="cm">/* mask out version bits 30-26, 23 */</span>
<span class="p">};</span>

<span class="cm">/* Bits in Config1 */</span>
<span class="k">enum</span> <span class="n">Config1Bits</span> <span class="p">{</span>
	<span class="n">Cfg1_PM_Enable</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">Cfg1_VPD_Enable</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">Cfg1_PIO</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">Cfg1_MMIO</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">LWAKE</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>		<span class="cm">/* not on 8139, 8139A */</span>
	<span class="n">Cfg1_Driver_Load</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">Cfg1_LED0</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">Cfg1_LED1</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">SLEEP</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* only on 8139, 8139A */</span>
	<span class="n">PWRDN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* only on 8139, 8139A */</span>
<span class="p">};</span>

<span class="cm">/* Bits in Config3 */</span>
<span class="k">enum</span> <span class="n">Config3Bits</span> <span class="p">{</span>
	<span class="n">Cfg3_FBtBEn</span>   	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* 1	= Fast Back to Back */</span>
	<span class="n">Cfg3_FuncRegEn</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* 1	= enable CardBus Function registers */</span>
	<span class="n">Cfg3_CLKRUN_En</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* 1	= enable CLKRUN */</span>
	<span class="n">Cfg3_CardB_En</span> 	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="cm">/* 1	= enable CardBus registers */</span>
	<span class="n">Cfg3_LinkUp</span>   	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="cm">/* 1	= wake up on link up */</span>
	<span class="n">Cfg3_Magic</span>    	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="cm">/* 1	= wake up on Magic Packet (tm) */</span>
	<span class="n">Cfg3_PARM_En</span>  	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="cm">/* 0	= software can set twister parameters */</span>
	<span class="n">Cfg3_GNTSel</span>   	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span> <span class="cm">/* 1	= delay 1 clock from PCI GNT signal */</span>
<span class="p">};</span>

<span class="cm">/* Bits in Config4 */</span>
<span class="k">enum</span> <span class="n">Config4Bits</span> <span class="p">{</span>
	<span class="n">LWPTN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* not on 8139, 8139A */</span>
<span class="p">};</span>

<span class="cm">/* Bits in Config5 */</span>
<span class="k">enum</span> <span class="n">Config5Bits</span> <span class="p">{</span>
	<span class="n">Cfg5_PME_STS</span>   	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* 1	= PCI reset resets PME_Status */</span>
	<span class="n">Cfg5_LANWake</span>   	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* 1	= enable LANWake signal */</span>
	<span class="n">Cfg5_LDPS</span>      	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* 0	= save power when link is down */</span>
	<span class="n">Cfg5_FIFOAddrPtr</span><span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="cm">/* Realtek internal SRAM testing */</span>
	<span class="n">Cfg5_UWF</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="cm">/* 1 = accept unicast wakeup frame */</span>
	<span class="n">Cfg5_MWF</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span> <span class="cm">/* 1 = accept multicast wakeup frame */</span>
	<span class="n">Cfg5_BWF</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span> <span class="cm">/* 1 = accept broadcast wakeup frame */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">RxConfigBits</span> <span class="p">{</span>
	<span class="cm">/* rx fifo threshold */</span>
	<span class="n">RxCfgFIFOShift</span>	<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">RxCfgFIFONone</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgFIFOShift</span><span class="p">),</span>

	<span class="cm">/* Max DMA burst */</span>
	<span class="n">RxCfgDMAShift</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">RxCfgDMAUnlimited</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgDMAShift</span><span class="p">),</span>

	<span class="cm">/* rx ring buffer length */</span>
	<span class="n">RxCfgRcv8K</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RxCfgRcv16K</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span>
	<span class="n">RxCfgRcv32K</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>
	<span class="n">RxCfgRcv64K</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>

	<span class="cm">/* Disable packet wrap at end of Rx buffer. (not possible with 64k) */</span>
	<span class="n">RxNoWrap</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Twister tuning parameters from RealTek.</span>
<span class="cm">   Completely undocumented, but required to tune bad links on some boards. */</span>
<span class="k">enum</span> <span class="n">CSCRBits</span> <span class="p">{</span>
	<span class="n">CSCR_LinkOKBit</span>		<span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="n">CSCR_LinkChangeBit</span>	<span class="o">=</span> <span class="mh">0x0800</span><span class="p">,</span>
	<span class="n">CSCR_LinkStatusBits</span>	<span class="o">=</span> <span class="mh">0x0f000</span><span class="p">,</span>
	<span class="n">CSCR_LinkDownOffCmd</span>	<span class="o">=</span> <span class="mh">0x003c0</span><span class="p">,</span>
	<span class="n">CSCR_LinkDownCmd</span>	<span class="o">=</span> <span class="mh">0x0f3c0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">Cfg9346Bits</span> <span class="p">{</span>
	<span class="n">Cfg9346_Lock</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">Cfg9346_Unlock</span>	<span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">CH_8139</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CH_8139_K</span><span class="p">,</span>
	<span class="n">CH_8139A</span><span class="p">,</span>
	<span class="n">CH_8139A_G</span><span class="p">,</span>
	<span class="n">CH_8139B</span><span class="p">,</span>
	<span class="n">CH_8130</span><span class="p">,</span>
	<span class="n">CH_8139C</span><span class="p">,</span>
	<span class="n">CH_8100</span><span class="p">,</span>
	<span class="n">CH_8100B_8139D</span><span class="p">,</span>
	<span class="n">CH_8101</span><span class="p">,</span>
<span class="p">}</span> <span class="n">chip_t</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">chip_flags</span> <span class="p">{</span>
	<span class="n">HasHltClk</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HasLWake</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define HW_REVID(b30, b29, b28, b27, b26, b23, b22) \</span>
<span class="cp">	(b30&lt;&lt;30 | b29&lt;&lt;29 | b28&lt;&lt;28 | b27&lt;&lt;27 | b26&lt;&lt;26 | b23&lt;&lt;23 | b22&lt;&lt;22)</span>
<span class="cp">#define HW_REVID_MASK	HW_REVID(1, 1, 1, 1, 1, 1, 1)</span>

<span class="cm">/* directly indexed by chip_t, above */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">version</span><span class="p">;</span> <span class="cm">/* from RTL8139C/RTL8139D docs */</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">rtl_chip_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;RTL-8139&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasHltClk</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8139 rev K&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasHltClk</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8139A&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasHltClk</span><span class="p">,</span> <span class="cm">/* XXX undocumented? */</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8139A rev G&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasHltClk</span><span class="p">,</span> <span class="cm">/* XXX undocumented? */</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8139B&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasLWake</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8130&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasLWake</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8139C&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	  <span class="n">HasLWake</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8100&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 	  <span class="n">HasLWake</span><span class="p">,</span>
 	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8100B/8139D&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	  <span class="n">HasHltClk</span> <span class="cm">/* XXX undocumented? */</span>
	<span class="o">|</span> <span class="n">HasLWake</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">{</span> <span class="s">&quot;RTL-8101&quot;</span><span class="p">,</span>
	  <span class="n">HW_REVID</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	  <span class="n">HasLWake</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtl_extra_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">early_rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_buf_mapped</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tx_timeouts</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_lost_in_ring</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtl8139_stats</span> <span class="p">{</span>
	<span class="n">u64</span>	<span class="n">packets</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span>	<span class="n">syncp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">drv_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">msg_enable</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span>	<span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cur_rx</span><span class="p">;</span>	<span class="cm">/* RX buf index of next pkt */</span>
	<span class="k">struct</span> <span class="n">rtl8139_stats</span>	<span class="n">rx_stats</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">rx_ring_dma</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">tx_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">cur_tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">dirty_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8139_stats</span>	<span class="n">tx_stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">NUM_TX_DESC</span><span class="p">];</span>	<span class="cm">/* Tx bounce buffers */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">tx_bufs</span><span class="p">;</span>	<span class="cm">/* Tx bounce buffer region. */</span>
	<span class="n">dma_addr_t</span>		<span class="n">tx_bufs_dma</span><span class="p">;</span>

	<span class="kt">signed</span> <span class="kt">char</span>		<span class="n">phys</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* MII device addresses. */</span>

				<span class="cm">/* Twister tune state. */</span>
	<span class="kt">char</span>			<span class="n">twistie</span><span class="p">,</span> <span class="n">twist_row</span><span class="p">,</span> <span class="n">twist_col</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">watchdog_fired</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">default_port</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Last dev-&gt;if_port value. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">have_thread</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">rx_lock</span><span class="p">;</span>

	<span class="n">chip_t</span>			<span class="n">chipset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">rx_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_extra_stats</span>	<span class="n">xstats</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="kr">thread</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mii_if_info</span>	<span class="n">mii</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">regs_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">fifo_copy_timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span> <span class="p">(</span><span class="s">&quot;Jeff Garzik &lt;jgarzik@pobox.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;RealTek RTL-8139 Fast Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">use_io</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_io</span><span class="p">,</span> <span class="s">&quot;Force use of I/O access mode. 0=MMIO 1=PIO&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">multicast_filter_limit</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;8139too bitmapped message enable number&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">multicast_filter_limit</span><span class="p">,</span> <span class="s">&quot;8139too maximum number of filtered multicast addresses&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">media</span><span class="p">,</span> <span class="s">&quot;8139too: Bits 4+9: force full duplex, bit 5: 100Mbps&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span> <span class="p">(</span><span class="n">full_duplex</span><span class="p">,</span> <span class="s">&quot;8139too: Force full duplex for board(s) (1)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">read_eeprom</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rtl8139_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mdio_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mdio_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_start_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_init_ring</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">rtl8139_start_xmit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rtl8139_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rtl8139_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">rtl8139_interrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rtl8139_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">netdev_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">rtl8139_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">rtnl_link_stats64</span>
						    <span class="o">*</span><span class="n">stats</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_set_rx_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__set_rx_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_hw_start</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_thread</span> <span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtl8139_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">rtl8139_ethtool_ops</span><span class="p">;</span>

<span class="cm">/* write MMIO register, with flush */</span>
<span class="cm">/* Flush avoids rtl8139 bug w/ posted MMIO writes */</span>
<span class="cp">#define RTL_W8_F(reg, val8)	do { iowrite8 ((val8), ioaddr + (reg)); ioread8 (ioaddr + (reg)); } while (0)</span>
<span class="cp">#define RTL_W16_F(reg, val16)	do { iowrite16 ((val16), ioaddr + (reg)); ioread16 (ioaddr + (reg)); } while (0)</span>
<span class="cp">#define RTL_W32_F(reg, val32)	do { iowrite32 ((val32), ioaddr + (reg)); ioread32 (ioaddr + (reg)); } while (0)</span>

<span class="cm">/* write MMIO register */</span>
<span class="cp">#define RTL_W8(reg, val8)	iowrite8 ((val8), ioaddr + (reg))</span>
<span class="cp">#define RTL_W16(reg, val16)	iowrite16 ((val16), ioaddr + (reg))</span>
<span class="cp">#define RTL_W32(reg, val32)	iowrite32 ((val32), ioaddr + (reg))</span>

<span class="cm">/* read MMIO register */</span>
<span class="cp">#define RTL_R8(reg)		ioread8 (ioaddr + (reg))</span>
<span class="cp">#define RTL_R16(reg)		ioread16 (ioaddr + (reg))</span>
<span class="cp">#define RTL_R32(reg)		ioread32 (ioaddr + (reg))</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rtl8139_intr_mask</span> <span class="o">=</span>
	<span class="n">PCIErr</span> <span class="o">|</span> <span class="n">PCSTimeout</span> <span class="o">|</span> <span class="n">RxUnderrun</span> <span class="o">|</span> <span class="n">RxOverflow</span> <span class="o">|</span> <span class="n">RxFIFOOver</span> <span class="o">|</span>
	<span class="n">TxErr</span> <span class="o">|</span> <span class="n">TxOK</span> <span class="o">|</span> <span class="n">RxErr</span> <span class="o">|</span> <span class="n">RxOK</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rtl8139_norx_intr_mask</span> <span class="o">=</span>
	<span class="n">PCIErr</span> <span class="o">|</span> <span class="n">PCSTimeout</span> <span class="o">|</span> <span class="n">RxUnderrun</span> <span class="o">|</span>
	<span class="n">TxErr</span> <span class="o">|</span> <span class="n">TxOK</span> <span class="o">|</span> <span class="n">RxErr</span> <span class="p">;</span>

<span class="cp">#if RX_BUF_IDX == 0</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtl8139_rx_config</span> <span class="o">=</span>
	<span class="n">RxCfgRcv8K</span> <span class="o">|</span> <span class="n">RxNoWrap</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_FIFO_THRESH</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgFIFOShift</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgDMAShift</span><span class="p">);</span>
<span class="cp">#elif RX_BUF_IDX == 1</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtl8139_rx_config</span> <span class="o">=</span>
	<span class="n">RxCfgRcv16K</span> <span class="o">|</span> <span class="n">RxNoWrap</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_FIFO_THRESH</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgFIFOShift</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgDMAShift</span><span class="p">);</span>
<span class="cp">#elif RX_BUF_IDX == 2</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtl8139_rx_config</span> <span class="o">=</span>
	<span class="n">RxCfgRcv32K</span> <span class="o">|</span> <span class="n">RxNoWrap</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_FIFO_THRESH</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgFIFOShift</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgDMAShift</span><span class="p">);</span>
<span class="cp">#elif RX_BUF_IDX == 3</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtl8139_rx_config</span> <span class="o">=</span>
	<span class="n">RxCfgRcv64K</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_FIFO_THRESH</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgFIFOShift</span><span class="p">)</span> <span class="o">|</span>
	<span class="p">(</span><span class="n">RX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">RxCfgDMAShift</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Invalid configuration for 8139_RXBUF_IDX&quot;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtl8139_tx_config</span> <span class="o">=</span>
	<span class="n">TxIFG96</span> <span class="o">|</span> <span class="p">(</span><span class="n">TX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">TxDMAShift</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">TX_RETRY</span> <span class="o">&lt;&lt;</span> <span class="n">TxRetryShift</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rtl8139_cleanup_dev</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">)</span>
		<span class="n">pci_iounmap</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">);</span>

	<span class="cm">/* it&#39;s ok to call this even if we have no regions to free */</span>
	<span class="n">pci_release_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_chip_reset</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Soft reset the chip. */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdReset</span><span class="p">);</span>

	<span class="cm">/* Check that the chip has finished the reset. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdReset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">__devinit</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="nf">rtl8139_init_board</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">disable_dev_on_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span>  <span class="s">&quot;PIO&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;MMIO&quot;</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* dev and priv zeroed in alloc_etherdev */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* enable device (incl. PCI PM wakeup and hotplug setup) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">disable_dev_on_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">pci_set_master</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="cm">/* PIO bar register comes first. */</span>
	<span class="n">bar</span> <span class="o">=</span> <span class="o">!</span><span class="n">use_io</span><span class="p">;</span>

	<span class="n">io_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;%s region size = 0x%02lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="n">bar</span><span class="p">].</span><span class="n">type</span><span class="p">,</span> <span class="n">io_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">res</span><span class="p">[</span><span class="n">bar</span><span class="p">].</span><span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;region #%d not a %s resource, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span>
			<span class="n">res</span><span class="p">[</span><span class="n">bar</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_len</span> <span class="o">&lt;</span> <span class="n">RTL_MIN_IO_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;Invalid PCI %s region size(s), aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">res</span><span class="p">[</span><span class="n">bar</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s">&quot;cannot map %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="n">bar</span><span class="p">].</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">use_io</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">use_io</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs_len</span> <span class="o">=</span> <span class="n">io_len</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="cm">/* Bring old chips out of low-power mode. */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">HltClk</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">);</span>

	<span class="cm">/* check for missing/broken hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span> <span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip not responding, ignoring board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* identify chip attached to board */</span>
	<span class="n">version</span> <span class="o">=</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HW_REVID_MASK</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span> <span class="p">(</span><span class="n">rtl_chip_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">match</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* if unknown chip, assume array element #0, original RTL-8139 in this case */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown chip version, assuming RTL-8139</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TxConfig = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">TxConfig</span><span class="p">));</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">match:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;chipset id (%d) == index %d, &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">version</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="n">CH_8139B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">new_tmp8</span> <span class="o">=</span> <span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config1</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PCI PM wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasLWake</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">LWAKE</span><span class="p">))</span>
			<span class="n">new_tmp8</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LWAKE</span><span class="p">;</span>
		<span class="n">new_tmp8</span> <span class="o">|=</span> <span class="n">Cfg1_PM_Enable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_tmp8</span> <span class="o">!=</span> <span class="n">tmp8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
			<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
			<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasLWake</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">LWPTN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
				<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">tmp8</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LWPTN</span><span class="p">);</span>
				<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Old chip wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config1</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SLEEP</span> <span class="o">|</span> <span class="n">PWRDN</span><span class="p">);</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtl8139_chip_reset</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">__rtl8139_cleanup_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_dev_on_err</span><span class="p">)</span>
		<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_RXALL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rx_mode</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span>
			<span class="n">rx_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AcceptErr</span> <span class="o">|</span> <span class="n">AcceptRunt</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rx_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AcceptErr</span> <span class="o">|</span> <span class="n">AcceptRunt</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">=</span> <span class="n">rtl8139_rx_config</span> <span class="o">|</span> <span class="n">rx_mode</span><span class="p">;</span>
		<span class="n">RTL_W32_F</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rtl8139_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">rtl8139_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">rtl8139_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">rtl8139_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">rtl8139_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">rtl8139_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">rtl8139_set_rx_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">netdev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">rtl8139_tx_timeout</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">rtl8139_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">rtl8139_set_features</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rtl8139_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">option</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">board_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span> <span class="p">(</span><span class="n">ent</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">board_idx</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* when we&#39;re built into the kernel, the driver version message</span>
<span class="cm">	 * is only printed if at least one 8139 board has been found</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef MODULE</span>
	<span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="n">RTL8139_DRIVER_NAME</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_REALTEK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_REALTEK_8139</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;This (id %04x:%04x rev %02x) is an enhanced 8139C+ chip, use 8139cp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       	   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_REALTEK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_REALTEK_8139</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_ATHEROS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_REALTEK_8139</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;OQO Model 2 detected. Forcing PIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">use_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">rtl8139_init_board</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">assert</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">addr_len</span> <span class="o">=</span> <span class="n">read_eeprom</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x8129</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">read_eeprom</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* The Rtl8139-specific entries in the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl8139_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl8139_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">rtl8139_poll</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="cm">/* note: the hardware is not capable of sg/csum/highdma, however</span>
<span class="cm">	 * through the use of skb_copy_and_csum_dev we enable these</span>
<span class="cm">	 * features</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_HW_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXALL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXFCS</span><span class="p">;</span>

	<span class="cm">/* tp zeroed and aligned in alloc_etherdev */</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* note: tp-&gt;chipset set in rtl8139_init_board */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">=</span> <span class="n">board_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">hw_flags</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">debug</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">RTL8139_DEF_MSG_ENABLE</span> <span class="o">:</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">debug</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="n">rtl8139_thread</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="cm">/* dev is fully set up and ready to use now */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;about to register device named %s (%p)...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">register_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s at 0x%p, %pM, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">board_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Identified 8139 chip type &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Find the connected MII xcvrs.</span>
<span class="cm">	   Doing this in open() would allow detecting external xcvrs later, but</span>
<span class="cm">	   takes too much time. */</span>
<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_MII_XCVR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="n">phy_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">phy_idx</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span> <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">mii_status</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0xffff</span>  <span class="o">&amp;&amp;</span>  <span class="n">mii_status</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">advertising</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">phy_idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MII transceiver %d status 0x%04x advertising %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">phy</span><span class="p">,</span> <span class="n">mii_status</span><span class="p">,</span> <span class="n">advertising</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No MII transceivers found! Assuming SYM transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* The lower four bits are the media type. */</span>
	<span class="n">option</span> <span class="o">=</span> <span class="p">(</span><span class="n">board_idx</span> <span class="o">&gt;=</span> <span class="n">MAX_UNITS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">media</span><span class="p">[</span><span class="n">board_idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">option</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x210</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">default_port</span> <span class="o">=</span> <span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">default_port</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board_idx</span> <span class="o">&lt;</span> <span class="n">MAX_UNITS</span>  <span class="o">&amp;&amp;</span>  <span class="n">full_duplex</span><span class="p">[</span><span class="n">board_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">full_duplex</span><span class="p">[</span><span class="n">board_idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Media type forced to Full Duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Changing the MII-advertised media because might prevent</span>
<span class="cm">		   re-connection. */</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">default_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;  Forcing %dMbps %s-duplex operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">));</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> 	<span class="cm">/* 100Mbps? */</span>
				   <span class="p">((</span><span class="n">option</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span> <span class="cm">/* Full duplex? */</span>
	<span class="p">}</span>

	<span class="cm">/* Put the chip into low-power mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasHltClk</span><span class="p">)</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">HltClk</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">);</span>	<span class="cm">/* &#39;R&#39; would leave the clock running. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">__rtl8139_cleanup_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rtl8139_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">unregister_netdev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">__rtl8139_cleanup_dev</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Serial EEPROM section. */</span>

<span class="cm">/*  EEPROM_Ctrl bits. */</span>
<span class="cp">#define EE_SHIFT_CLK	0x04	</span><span class="cm">/* EEPROM shift clock. */</span><span class="cp"></span>
<span class="cp">#define EE_CS			0x08	</span><span class="cm">/* EEPROM chip select. */</span><span class="cp"></span>
<span class="cp">#define EE_DATA_WRITE	0x02	</span><span class="cm">/* EEPROM chip data in. */</span><span class="cp"></span>
<span class="cp">#define EE_WRITE_0		0x00</span>
<span class="cp">#define EE_WRITE_1		0x02</span>
<span class="cp">#define EE_DATA_READ	0x01	</span><span class="cm">/* EEPROM chip data out. */</span><span class="cp"></span>
<span class="cp">#define EE_ENB			(0x80 | EE_CS)</span>

<span class="cm">/* Delay between EEPROM clock transitions.</span>
<span class="cm">   No extra delay is needed with 33Mhz PCI, but 66Mhz may change this.</span>
<span class="cm"> */</span>

<span class="cp">#define eeprom_delay()	(void)RTL_R8(Cfg9346)</span>

<span class="cm">/* The EEPROM commands include the alway-set leading bit. */</span>
<span class="cp">#define EE_WRITE_CMD	(5)</span>
<span class="cp">#define EE_READ_CMD		(6)</span>
<span class="cp">#define EE_ERASE_CMD	(7)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">read_eeprom</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_cmd</span> <span class="o">=</span> <span class="n">location</span> <span class="o">|</span> <span class="p">(</span><span class="n">EE_READ_CMD</span> <span class="o">&lt;&lt;</span> <span class="n">addr_len</span><span class="p">);</span>

	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EE_CS</span><span class="p">);</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span><span class="p">);</span>
	<span class="n">eeprom_delay</span> <span class="p">();</span>

	<span class="cm">/* Shift the read command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">addr_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">EE_DATA_WRITE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span> <span class="o">|</span> <span class="n">dataval</span><span class="p">);</span>
		<span class="n">eeprom_delay</span> <span class="p">();</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span> <span class="o">|</span> <span class="n">dataval</span> <span class="o">|</span> <span class="n">EE_SHIFT_CLK</span><span class="p">);</span>
		<span class="n">eeprom_delay</span> <span class="p">();</span>
	<span class="p">}</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span><span class="p">);</span>
	<span class="n">eeprom_delay</span> <span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span> <span class="o">|</span> <span class="n">EE_SHIFT_CLK</span><span class="p">);</span>
		<span class="n">eeprom_delay</span> <span class="p">();</span>
		<span class="n">retval</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EE_DATA_READ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
				     <span class="mi">0</span><span class="p">);</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">EE_ENB</span><span class="p">);</span>
		<span class="n">eeprom_delay</span> <span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Terminate the EEPROM access. */</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">eeprom_delay</span> <span class="p">();</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* MII serial management: mostly bogus for now. */</span>
<span class="cm">/* Read and write the MII management registers using software-generated</span>
<span class="cm">   serial MDIO protocol.</span>
<span class="cm">   The maximum data clock rate is 2.5 Mhz.  The minimum timing is usually</span>
<span class="cm">   met by back-to-back PCI I/O cycles, but we insert a delay to avoid</span>
<span class="cm">   &quot;overclocking&quot; issues. */</span>
<span class="cp">#define MDIO_DIR		0x80</span>
<span class="cp">#define MDIO_DATA_OUT	0x04</span>
<span class="cp">#define MDIO_DATA_IN	0x02</span>
<span class="cp">#define MDIO_CLK		0x01</span>
<span class="cp">#define MDIO_WRITE0 (MDIO_DIR)</span>
<span class="cp">#define MDIO_WRITE1 (MDIO_DIR | MDIO_DATA_OUT)</span>

<span class="cp">#define mdio_delay()	RTL_R8(Config4)</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">mii_2_8139_map</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BasicModeCtrl</span><span class="p">,</span>
	<span class="n">BasicModeStatus</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">NWayAdvert</span><span class="p">,</span>
	<span class="n">NWayLPAR</span><span class="p">,</span>
	<span class="n">NWayExpansion</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
<span class="cm">/* Syncronize the MII management interface by shifting 32 one bits out. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_sync</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">MDIO_WRITE1</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">MDIO_WRITE1</span> <span class="o">|</span> <span class="n">MDIO_CLK</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mii_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xf6</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">location</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Really a 8139.  Use internal registers. */</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">location</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">mii_2_8139_map</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">?</span>
		    <span class="n">RTL_R16</span> <span class="p">(</span><span class="n">mii_2_8139_map</span><span class="p">[</span><span class="n">location</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
	<span class="n">mdio_sync</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="cm">/* Shift the read command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span> <span class="p">(</span><span class="n">mii_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">MDIO_DATA_OUT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">MDIO_DIR</span> <span class="o">|</span> <span class="n">dataval</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">MDIO_DIR</span> <span class="o">|</span> <span class="n">dataval</span> <span class="o">|</span> <span class="n">MDIO_CLK</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* Read the two transition, 16 data, and wire-idle bits. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MDIO_DATA_IN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">MDIO_CLK</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mii_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x5002</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Really a 8139.  Use internal registers. */</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
			<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">BasicModeCtrl</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">mii_2_8139_map</span><span class="p">[</span><span class="n">location</span><span class="p">])</span>
			<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">mii_2_8139_map</span><span class="p">[</span><span class="n">location</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_8139TOO_8129</span>
	<span class="n">mdio_sync</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Shift the command bits out. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dataval</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">mii_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">MDIO_WRITE1</span> <span class="o">:</span> <span class="n">MDIO_WRITE0</span><span class="p">;</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">dataval</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">dataval</span> <span class="o">|</span> <span class="n">MDIO_CLK</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* Clear out extra bits. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">MDIO_CLK</span><span class="p">);</span>
		<span class="n">mdio_delay</span> <span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">rtl8139_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BUF_TOT_LEN</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_BUF_TOT_LEN</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BUF_TOT_LEN</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span>
			<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_BUF_TOT_LEN</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">TX_FIFO_THRESH</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003f0000</span><span class="p">;</span>

	<span class="n">rtl8139_init_ring</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8139_hw_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_start_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		  <span class="s">&quot;%s() ioaddr %#llx IRQ %d GP Pins %02x %s-duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">__func__</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		  <span class="n">irq</span><span class="p">,</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">MediaStatus</span><span class="p">),</span>
		  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">);</span>

	<span class="n">rtl8139_start_thread</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_check_media</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">init_media</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mii_check_media</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">netif_msg_link</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span> <span class="n">init_media</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Start the hardware at open or resume. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_hw_start</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Bring old chips out of low-power mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasHltClk</span><span class="p">)</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">HltClk</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">);</span>

	<span class="n">rtl8139_chip_reset</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* unlock Config[01234] and BMCR register writes */</span>
	<span class="n">RTL_W8_F</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="cm">/* Restore our idea of the MAC address. */</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">MAC0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">MAC0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">le16_to_cpu</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* init Rx ring buffer DMA address */</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">RxBuf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>

	<span class="cm">/* Must enable Tx/Rx before setting transfer thresholds! */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdRxEnb</span> <span class="o">|</span> <span class="n">CmdTxEnb</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">=</span> <span class="n">rtl8139_rx_config</span> <span class="o">|</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span><span class="p">);</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="n">rtl8139_tx_config</span><span class="p">);</span>

	<span class="n">rtl_check_media</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="n">CH_8139B</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable magic packet scanning, which is enabled</span>
<span class="cm">		 * when PM is enabled in Config1.  It can be reenabled</span>
<span class="cm">		 * via ETHTOOL_SWOL if desired.  */</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Cfg3_Magic</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;init buffer addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Lock Config[01234] and BMCR register writes */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="cm">/* init Tx buffer DMA addresses */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">TxAddr0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">));</span>

	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtl8139_set_rx_mode</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* no early-rx interrupts */</span>
	<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">MultiIntr</span><span class="p">,</span> <span class="n">RTL_R16</span> <span class="p">(</span><span class="n">MultiIntr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MultiIntrClear</span><span class="p">);</span>

	<span class="cm">/* make sure RxTx has started */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CmdRxEnb</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CmdTxEnb</span><span class="p">)))</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdRxEnb</span> <span class="o">|</span> <span class="n">CmdTxEnb</span><span class="p">);</span>

	<span class="cm">/* Enable all known interrupts by setting the interrupt mask. */</span>
	<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="n">rtl8139_intr_mask</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Initialize the Rx and Tx rings, along with various &#39;dev&#39; bits. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_init_ring</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUF_SIZE</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/* This must be global for CONFIG_8139TOO_TUNE_TWISTER case */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">next_tick</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_8139TOO_TUNE_TWISTER</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8139_tune_twister</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#else</span>
<span class="k">enum</span> <span class="n">TwisterParamVals</span> <span class="p">{</span>
	<span class="n">PARA78_default</span>	<span class="o">=</span> <span class="mh">0x78fa8388</span><span class="p">,</span>
	<span class="n">PARA7c_default</span>	<span class="o">=</span> <span class="mh">0xcb38de43</span><span class="p">,</span>	<span class="cm">/* param[0][3] */</span>
	<span class="n">PARA7c_xxx</span>	<span class="o">=</span> <span class="mh">0xcb38de43</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0xcb39de43</span><span class="p">,</span> <span class="mh">0xcb39ce43</span><span class="p">,</span> <span class="mh">0xfb38de03</span><span class="p">,</span> <span class="mh">0xcb38de43</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xcb39de43</span><span class="p">,</span> <span class="mh">0xcb39ce43</span><span class="p">,</span> <span class="mh">0xcb39ce83</span><span class="p">,</span> <span class="mh">0xcb39ce83</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xcb39de43</span><span class="p">,</span> <span class="mh">0xcb39ce43</span><span class="p">,</span> <span class="mh">0xcb39ce83</span><span class="p">,</span> <span class="mh">0xcb39ce83</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0xbb39de43</span><span class="p">,</span> <span class="mh">0xbb39ce43</span><span class="p">,</span> <span class="mh">0xbb39ce83</span><span class="p">,</span> <span class="mh">0xbb39ce83</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_tune_twister</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">linkcase</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="cm">/* This is a complicated state machine to configure the &quot;twister&quot; for</span>
<span class="cm">	   impedance/echos based on the cable length.</span>
<span class="cm">	   All of this is magic and undocumented.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R16</span> <span class="p">(</span><span class="n">CSCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSCR_LinkOKBit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We have link beat, let us tune the twister. */</span>
			<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">CSCR</span><span class="p">,</span> <span class="n">CSCR_LinkDownOffCmd</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Change to state 2. */</span>
			<span class="n">next_tick</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Just put in some reasonable defaults for when beat returns. */</span>
			<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">CSCR</span><span class="p">,</span> <span class="n">CSCR_LinkDownCmd</span><span class="p">);</span>
			<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">FIFOTMS</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>	<span class="cm">/* Turn on cable test mode. */</span>
			<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">PARA78</span><span class="p">,</span> <span class="n">PARA78_default</span><span class="p">);</span>
			<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">PARA7c</span><span class="p">,</span> <span class="n">PARA7c_default</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Bail from future actions. */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* Read how long it took to hear the echo. */</span>
		<span class="n">linkcase</span> <span class="o">=</span> <span class="n">RTL_R16</span> <span class="p">(</span><span class="n">CSCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSCR_LinkStatusBits</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linkcase</span> <span class="o">==</span> <span class="mh">0x7000</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkcase</span> <span class="o">==</span> <span class="mh">0x3000</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkcase</span> <span class="o">==</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Change to state 2. */</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* Put out four tuning parameters, one per 100msec. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">FIFOTMS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">PARA7c</span><span class="p">,</span> <span class="n">param</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span><span class="p">]</span>
			 <span class="p">[(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_col</span><span class="p">]);</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_col</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* For short cables we are done.</span>
<span class="cm">			   For long cables (row == 3) check for mistune. */</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* Special case for long cables: check for mistune. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R16</span> <span class="p">(</span><span class="n">CSCR</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">CSCR_LinkStatusBits</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">PARA7c</span><span class="p">,</span> <span class="mh">0xfb38de03</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">next_tick</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* Retune for shorter cable (column 2). */</span>
		<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">FIFOTMS</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">PARA78</span><span class="p">,</span> <span class="n">PARA78_default</span><span class="p">);</span>
		<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">PARA7c</span><span class="p">,</span> <span class="n">PARA7c_default</span><span class="p">);</span>
		<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">FIFOTMS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_row</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twist_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">next_tick</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_8139TOO_TUNE_TWISTER */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8139_thread_iter</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mii_lpa</span><span class="p">;</span>

	<span class="n">mii_lpa</span> <span class="o">=</span> <span class="n">mdio_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">MII_LPA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">&amp;&amp;</span> <span class="n">mii_lpa</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">duplex</span> <span class="o">=</span> <span class="p">((</span><span class="n">mii_lpa</span> <span class="o">&amp;</span> <span class="n">LPA_100FULL</span><span class="p">)</span> <span class="o">||</span>
			      <span class="p">(</span><span class="n">mii_lpa</span> <span class="o">&amp;</span> <span class="mh">0x01C0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">!=</span> <span class="n">duplex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">duplex</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mii_lpa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Setting %s-duplex based on MII #%d link partner ability of %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">?</span> <span class="s">&quot;full&quot;</span> <span class="o">:</span> <span class="s">&quot;half&quot;</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mii_lpa</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;media is unconnected, link down, or incompatible connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			RTL_W8 (Cfg9346, Cfg9346_Unlock);</span>
<span class="c">			RTL_W8 (Config1, tp-&gt;mii.full_duplex ? 0x60 : 0x20);</span>
<span class="c">			RTL_W8 (Cfg9346, Cfg9346_Lock);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">next_tick</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>

	<span class="n">rtl8139_tune_twister</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Media selection tick, Link partner %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">RTL_R16</span><span class="p">(</span><span class="n">NWayLPAR</span><span class="p">));</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Other registers are IntMask %04x IntStatus %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">),</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">));</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip config %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config0</span><span class="p">),</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_thread</span> <span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8139_private</span><span class="p">,</span> <span class="kr">thread</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thr_delay</span> <span class="o">=</span> <span class="n">next_tick</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">watchdog_fired</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">watchdog_fired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rtl8139_tx_timeout_task</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rtl8139_thread_iter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">have_thread</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="n">thr_delay</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">rtnl_unlock</span> <span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_start_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">CH_8139_K</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">twistie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_LNK_CHNG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">have_thread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">watchdog_fired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="n">next_tick</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8139_tx_clear</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* XXX account for unsent Tx packets in tp-&gt;stats.tx_dropped */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_tx_timeout_task</span> <span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8139_private</span><span class="p">,</span> <span class="kr">thread</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit timeout, status %02x %04x %04x media %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">),</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">),</span>
		   <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">),</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">MediaStatus</span><span class="p">));</span>
	<span class="cm">/* Emit info to figure out what went wrong. */</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx queue start entry %ld  dirty entry %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx descriptor %d is %08x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxStatus0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)),</span>
			   <span class="n">i</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span> <span class="o">?</span>
			   <span class="s">&quot; (queue head)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_timeouts</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* disable Tx ASAP, if not already */</span>
	<span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">CmdTxEnb</span><span class="p">)</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdRxEnb</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="cm">/* Disable interrupts by clearing the interrupt mask. */</span>
	<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Stop a shared interrupt from scavenging while we are. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rtl8139_tx_clear</span> <span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* ...and finally, reset everything */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl8139_hw_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_tx_timeout</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">watchdog_fired</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">have_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="n">rtl8139_thread</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">,</span> <span class="n">next_tick</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">rtl8139_start_xmit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Calculate the next Tx descriptor entry. */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>

	<span class="cm">/* Note: the chip doesn&#39;t have auto-pad! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">TX_BUF_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">);</span>
		<span class="n">skb_copy_and_csum_dev</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Writing to TxStatus triggers a DMA transfer of the data</span>
<span class="cm">	 * copied to tp-&gt;tx_buf[entry] above. Use a memory barrier</span>
<span class="cm">	 * to make sure that the device sees the updated data.</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">TxStatus0</span> <span class="o">+</span> <span class="p">(</span><span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">u32</span><span class="p">)),</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_flag</span> <span class="o">|</span> <span class="n">max</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ETH_ZLEN</span><span class="p">));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">NUM_TX_DESC</span><span class="p">)</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tx_queued</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Queued Tx packet size %u to slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_tx_interrupt</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dirty_tx</span><span class="p">,</span> <span class="n">tx_left</span><span class="p">;</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>
	<span class="n">tx_left</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tx_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">txstatus</span><span class="p">;</span>

		<span class="n">txstatus</span> <span class="o">=</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">TxStatus0</span> <span class="o">+</span> <span class="p">(</span><span class="n">entry</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">u32</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxStatOK</span> <span class="o">|</span> <span class="n">TxUnderrun</span> <span class="o">|</span> <span class="n">TxAborted</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* It still hasn&#39;t been Txed */</span>

		<span class="cm">/* Note: TxCarrierLost is always asserted at 100mbps. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxOutOfWindow</span> <span class="o">|</span> <span class="n">TxAborted</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* There was an major error, log it. */</span>
			<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Transmit error, Tx status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">txstatus</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txstatus</span> <span class="o">&amp;</span> <span class="n">TxAborted</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="n">TxClearAbt</span><span class="p">);</span>
				<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="n">TxErr</span><span class="p">);</span>
				<span class="n">wmb</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txstatus</span> <span class="o">&amp;</span> <span class="n">TxCarrierLost</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txstatus</span> <span class="o">&amp;</span> <span class="n">TxOutOfWindow</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txstatus</span> <span class="o">&amp;</span> <span class="n">TxUnderrun</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Add 64 to the Tx FIFO threshold. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_flag</span> <span class="o">&lt;</span> <span class="mh">0x00300000</span><span class="p">)</span>
					<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_flag</span> <span class="o">+=</span> <span class="mh">0x00020000</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="p">(</span><span class="n">txstatus</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">txstatus</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dirty_tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_left</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef RTL8139_NDEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span> <span class="o">&gt;</span> <span class="n">NUM_TX_DESC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Out-of-sync dirty pointer, %ld vs. %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dirty_tx</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>
		<span class="n">dirty_tx</span> <span class="o">+=</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* RTL8139_NDEBUG */</span><span class="cp"></span>

	<span class="cm">/* only wake the queue if we did work, and the queue is stopped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">!=</span> <span class="n">dirty_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">dirty_tx</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* TODO: clean this up!  Rx reset need not be this intensive */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_rx_err</span> <span class="p">(</span><span class="n">u32</span> <span class="n">rx_status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp8</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_8139_OLD_RX_RESET</span>
	<span class="kt">int</span> <span class="n">tmp_work</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ethernet frame had errors, status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">rx_status</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxStatusOK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxTooLong</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Oversized Ethernet frame, status %04x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rx_status</span><span class="p">);</span>
			<span class="cm">/* A.C.: The chip hangs here. */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxBadSymbol</span> <span class="o">|</span> <span class="n">RxBadAlign</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxRunt</span> <span class="o">|</span> <span class="n">RxTooLong</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxCRCErr</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">rx_lost_in_ring</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef CONFIG_8139_OLD_RX_RESET</span>
	<span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">tmp8</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CmdRxEnb</span><span class="p">);</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">tmp8</span><span class="p">);</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* Reset the receiver, based on RealTek recommendation. (Bug?) */</span>

	<span class="cm">/* disable receive */</span>
	<span class="n">RTL_W8_F</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdTxEnb</span><span class="p">);</span>
	<span class="n">tmp_work</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tmp_work</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">CmdRxEnb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_work</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rx stop wait too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* restart receive */</span>
	<span class="n">tmp_work</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">tmp_work</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8_F</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdRxEnb</span> <span class="o">|</span> <span class="n">CmdTxEnb</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">tmp8</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">CmdRxEnb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp8</span> <span class="o">&amp;</span> <span class="n">CmdTxEnb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp_work</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx/rx enable wait too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* and reinitialize all rx related registers */</span>
	<span class="n">RTL_W8_F</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="cm">/* Must enable Tx/Rx before setting transfer thresholds! */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdRxEnb</span> <span class="o">|</span> <span class="n">CmdTxEnb</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">=</span> <span class="n">rtl8139_rx_config</span> <span class="o">|</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;init buffer addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Lock Config[01234] and BMCR register writes */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="cm">/* init Rx ring buffer DMA address */</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">RxBuf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>

	<span class="cm">/* A.C.: Reset the multicast list. */</span>
	<span class="n">__set_rx_mode</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#if RX_BUF_IDX == 3</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wrap_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">left</span> <span class="o">=</span> <span class="n">RX_BUF_LEN</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ring</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">left</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ring</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_isr_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">RTL_R16</span> <span class="p">(</span><span class="n">IntrStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RxAckBits</span><span class="p">;</span>

	<span class="cm">/* Clear out errors and receive interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxFIFOOver</span> <span class="o">|</span> <span class="n">RxOverflow</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxFIFOOver</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RTL_W16_F</span> <span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="n">RxAckBits</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_rx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;In %s(), current %04x BufAddr %04x, free to %04x, Cmd %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">cur_rx</span><span class="p">,</span>
		   <span class="n">RTL_R16</span><span class="p">(</span><span class="n">RxBufAddr</span><span class="p">),</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">RxBufPtr</span><span class="p">),</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">received</span> <span class="o">&lt;</span> <span class="n">budget</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">RTL_R8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RxBufEmpty</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ring_offset</span> <span class="o">=</span> <span class="n">cur_rx</span> <span class="o">%</span> <span class="n">RX_BUF_LEN</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rx_status</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_size</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">rmb</span><span class="p">();</span>

		<span class="cm">/* read size+status of next frame from DMA ring buffer */</span>
		<span class="n">rx_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">rx_ring</span> <span class="o">+</span> <span class="n">ring_offset</span><span class="p">));</span>
		<span class="n">rx_size</span> <span class="o">=</span> <span class="n">rx_status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXFCS</span><span class="p">)))</span>
			<span class="n">pkt_size</span> <span class="o">=</span> <span class="n">rx_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pkt_size</span> <span class="o">=</span> <span class="n">rx_size</span><span class="p">;</span>

		<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s() status %04x, size %04x, cur %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">rx_size</span><span class="p">,</span> <span class="n">cur_rx</span><span class="p">);</span>
<span class="cp">#if RTL8139_DEBUG &gt; 2</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;Frame contents: &quot;</span><span class="p">,</span>
			       <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_offset</span><span class="p">],</span> <span class="mi">70</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Packet copy from FIFO still in progress.</span>
<span class="cm">		 * Theoretically, this should never happen</span>
<span class="cm">		 * since EarlyRx is disabled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx_size</span> <span class="o">==</span> <span class="mh">0xfff0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fifo_copy_timeout</span><span class="p">)</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fifo_copy_timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">fifo_copy_timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hung FIFO. Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">rx_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">no_early_rx</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fifo copy in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">early_rx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">no_early_rx:</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">fifo_copy_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* If Rx err or invalid rx_size/rx_status received</span>
<span class="cm">		 * (which happens if we get lost in the ring),</span>
<span class="cm">		 * Rx process gets reset, so we abort any further</span>
<span class="cm">		 * Rx processing.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">rx_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_ETH_FRAME_SIZE</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">rx_size</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxStatusOK</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">rx_size</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">MAX_ETH_FRAME_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">rx_size</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxStatusOK</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* Length is at least mostly OK, but pkt has</span>
<span class="cm">				 * error.  I&#39;m hoping we can handle some of these</span>
<span class="cm">				 * errors without resetting the chip. --Ben</span>
<span class="cm">				 */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxCRCErr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">keep_pkt</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">RxRunt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">keep_pkt</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rtl8139_rx_err</span> <span class="p">(</span><span class="n">rx_status</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">received</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">keep_pkt:</span>
		<span class="cm">/* Malloc up new buffer, compatible with net-2e. */</span>
		<span class="cm">/* Omit the four octet CRC from the length. */</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if RX_BUF_IDX == 3</span>
			<span class="n">wrap_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_ring</span><span class="p">,</span> <span class="n">ring_offset</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">skb_copy_to_linear_data</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">ring_offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="n">pkt_size</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">pkt_size</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>

			<span class="n">netif_receive_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory squeeze, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">received</span><span class="o">++</span><span class="p">;</span>

		<span class="n">cur_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_rx</span> <span class="o">+</span> <span class="n">rx_size</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">RxBufPtr</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">cur_rx</span> <span class="o">-</span> <span class="mi">16</span><span class="p">));</span>

		<span class="n">rtl8139_isr_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">received</span> <span class="o">||</span> <span class="n">rx_size</span> <span class="o">==</span> <span class="mh">0xfff0</span><span class="p">))</span>
		<span class="n">rtl8139_isr_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Done %s(), current %04x BufAddr %04x, free to %04x, Cmd %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">cur_rx</span><span class="p">,</span>
		   <span class="n">RTL_R16</span><span class="p">(</span><span class="n">RxBufAddr</span><span class="p">),</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">RxBufPtr</span><span class="p">),</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">));</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">cur_rx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The receive buffer should be mostly empty.</span>
<span class="cm">	 * Tell NAPI to reenable the Rx irq.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fifo_copy_timeout</span><span class="p">)</span>
		<span class="n">received</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_weird_interrupt</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link_changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Abnormal interrupt, status %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">assert</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span> <span class="p">(</span><span class="n">tp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span> <span class="p">(</span><span class="n">ioaddr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Update the error count. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">);</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxUnderrun</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">link_changed</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">drv_flags</span> <span class="o">&amp;</span> <span class="n">HAS_LNK_CHNG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl_check_media</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxUnderrun</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxUnderrun</span> <span class="o">|</span> <span class="n">RxErr</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCSTimeout</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxUnderrun</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PCIErr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">pci_cmd_status</span><span class="p">;</span>
		<span class="n">pci_read_config_word</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd_status</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">pci_cmd_status</span><span class="p">);</span>

		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI Bus error %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_cmd_status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8139_private</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RxAckBits</span><span class="p">))</span>
		<span class="n">work_done</span> <span class="o">+=</span> <span class="n">rtl8139_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Order is important since data can get interrupted</span>
<span class="cm">		 * again when we think we are done.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">__napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">RTL_W16_F</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="n">rtl8139_intr_mask</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The interrupt handler does all of the Rx thread work and cleans up</span>
<span class="cm">   after the Tx thread. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">rtl8139_interrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">ackstat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* avoid bogus &quot;uninit&quot; warning */</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">RTL_R16</span> <span class="p">(</span><span class="n">IntrStatus</span><span class="p">);</span>

	<span class="cm">/* shared irq? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">rtl8139_intr_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* h/w no longer present (hotplug?) or major error, bail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* close possible race&#39;s with dev_close */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Acknowledge all of the current interrupt sources ASAP, but</span>
<span class="cm">	   an first get an additional status bit from CSCR. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxUnderrun</span><span class="p">))</span>
		<span class="n">link_changed</span> <span class="o">=</span> <span class="n">RTL_R16</span> <span class="p">(</span><span class="n">CSCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSCR_LinkChangeBit</span><span class="p">;</span>

	<span class="n">ackstat</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">RxAckBits</span> <span class="o">|</span> <span class="n">TxErr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ackstat</span><span class="p">)</span>
		<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="n">ackstat</span><span class="p">);</span>

	<span class="cm">/* Receive packets are processed by poll routine.</span>
<span class="cm">	   If not running start it now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxAckBits</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTL_W16_F</span> <span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="n">rtl8139_norx_intr_mask</span><span class="p">);</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check uncommon events with one test. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCIErr</span> <span class="o">|</span> <span class="n">PCSTimeout</span> <span class="o">|</span> <span class="n">RxUnderrun</span> <span class="o">|</span> <span class="n">RxErr</span><span class="p">)))</span>
		<span class="n">rtl8139_weird_interrupt</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span>
					 <span class="n">status</span><span class="p">,</span> <span class="n">link_changed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TxOK</span> <span class="o">|</span> <span class="n">TxErr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl8139_tx_interrupt</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxErr</span><span class="p">)</span>
			<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="n">TxErr</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;exiting interrupt, intr_status=%#4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling receive - used by netconsole and other diagnostic tools</span>
<span class="cm"> * to allow network i/o with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">rtl8139_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">RTL_W8_F</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="n">RTL_W32_F</span><span class="p">(</span><span class="n">MAC0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="n">RTL_W32_F</span><span class="p">(</span><span class="n">MAC0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cpu_to_le32</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="n">RTL_W8_F</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">netif_dbg</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Shutting down ethercard, status was 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Stop the chip&#39;s Tx and Rx DMA processes. */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts by clearing the interrupt mask. */</span>
	<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Update the error counts. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">);</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8139_tx_clear</span> <span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_BUF_TOT_LEN</span><span class="p">,</span>
			  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">TX_BUF_TOT_LEN</span><span class="p">,</span>
			  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs_dma</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_bufs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Green! Put the chip in low-power mode. */</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasHltClk</span><span class="p">)</span>
		<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">HltClk</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">);</span>	<span class="cm">/* &#39;R&#39; would leave the clock running. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Get the ethtool Wake-on-LAN settings.  Assumes that wol points to</span>
<span class="cm">   kernel memory, *wol has been initialized as {ETHTOOL_GWOL}, and</span>
<span class="cm">   other threads or interrupts aren&#39;t messing with the 8139.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasLWake</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cfg3</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config3</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">cfg5</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config5</span><span class="p">);</span>

		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span>
			<span class="o">|</span> <span class="n">WAKE_UCAST</span> <span class="o">|</span> <span class="n">WAKE_MCAST</span> <span class="o">|</span> <span class="n">WAKE_BCAST</span><span class="p">;</span>

		<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg3</span> <span class="o">&amp;</span> <span class="n">Cfg3_LinkUp</span><span class="p">)</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_PHY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg3</span> <span class="o">&amp;</span> <span class="n">Cfg3_Magic</span><span class="p">)</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
		<span class="cm">/* (KON)FIXME: See how netdev_set_wol() handles the</span>
<span class="cm">		   following constants.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg5</span> <span class="o">&amp;</span> <span class="n">Cfg5_UWF</span><span class="p">)</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_UCAST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg5</span> <span class="o">&amp;</span> <span class="n">Cfg5_MWF</span><span class="p">)</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MCAST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg5</span> <span class="o">&amp;</span> <span class="n">Cfg5_BWF</span><span class="p">)</span>
			<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_BCAST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Set the ethtool Wake-on-LAN settings.  Return 0 or -errno.  Assumes</span>
<span class="cm">   that wol points to kernel memory and other threads or interrupts</span>
<span class="cm">   aren&#39;t messing with the 8139.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">support</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfg3</span><span class="p">,</span> <span class="n">cfg5</span><span class="p">;</span>

	<span class="n">support</span> <span class="o">=</span> <span class="p">((</span><span class="n">rtl_chip_info</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HasLWake</span><span class="p">)</span>
		   <span class="o">?</span> <span class="p">(</span><span class="n">WAKE_PHY</span> <span class="o">|</span> <span class="n">WAKE_MAGIC</span>
		      <span class="o">|</span> <span class="n">WAKE_UCAST</span> <span class="o">|</span> <span class="n">WAKE_MCAST</span> <span class="o">|</span> <span class="n">WAKE_BCAST</span><span class="p">)</span>
		   <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">support</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cfg3</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Cfg3_LinkUp</span> <span class="o">|</span> <span class="n">Cfg3_Magic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">cfg3</span> <span class="o">|=</span> <span class="n">Cfg3_LinkUp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">cfg3</span> <span class="o">|=</span> <span class="n">Cfg3_Magic</span><span class="p">;</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">cfg3</span><span class="p">);</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="n">cfg5</span> <span class="o">=</span> <span class="n">RTL_R8</span> <span class="p">(</span><span class="n">Config5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Cfg5_UWF</span> <span class="o">|</span> <span class="n">Cfg5_MWF</span> <span class="o">|</span> <span class="n">Cfg5_BWF</span><span class="p">);</span>
	<span class="cm">/* (KON)FIXME: These are untested.  We may have to set the</span>
<span class="cm">	   CRC0, Wakeup0 and LSBCRC0 registers too, but I have no</span>
<span class="cm">	   documentation.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_UCAST</span><span class="p">)</span>
		<span class="n">cfg5</span> <span class="o">|=</span> <span class="n">Cfg5_UWF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MCAST</span><span class="p">)</span>
		<span class="n">cfg5</span> <span class="o">|=</span> <span class="n">Cfg5_MWF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_BCAST</span><span class="p">)</span>
		<span class="n">cfg5</span> <span class="o">|=</span> <span class="n">Cfg5_BWF</span><span class="p">;</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">Config5</span><span class="p">,</span> <span class="n">cfg5</span><span class="p">);</span>	<span class="cm">/* need not unlock via Cfg9346 */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regdump_len</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rtl8139_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rtl8139_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="cm">/* TODO: we are too slack to do reg dumping for pio, for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_io</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">regs_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">regbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>

	<span class="cm">/* TODO: we are too slack to do reg dumping for pio, for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_io</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">RTL_REGS_VER</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">regbuf</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">RTL_NUM_STATS</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">early_rx</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_buf_mapped</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">tx_timeouts</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">xstats</span><span class="p">.</span><span class="n">rx_lost_in_ring</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ethtool_stats_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_stats_keys</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">rtl8139_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">rtl8139_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">rtl8139_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">rtl8139_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">rtl8139_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">rtl8139_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">rtl8139_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">rtl8139_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">rtl8139_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">rtl8139_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">rtl8139_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">rtl8139_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">rtl8139_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">rtl8139_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">rtl8139_get_ethtool_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netdev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">rq</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span>
<span class="nf">rtl8139_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">);</span>
		<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netdev_stats_to_stats64</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set or clear the multicast filter for this adaptor.</span>
<span class="cm">   This routine is not state sensitive and need not be SMP locked. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__set_rx_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Multicast hash filter */</span>
	<span class="kt">int</span> <span class="n">rx_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtl8139_set_rx_mode(%04x) done -- Rx config %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">));</span>

	<span class="cm">/* Note: do not reorder, GCC is clever about common statements. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_mode</span> <span class="o">=</span>
		    <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span> <span class="o">|</span>
		    <span class="n">AcceptAllPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to filter perfectly -- accept all multicasts. */</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bit_nr</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>

			<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
			<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptMulticast</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AcceptErr</span> <span class="o">|</span> <span class="n">AcceptRunt</span><span class="p">);</span>

	<span class="cm">/* We can safely update without stopping the chip. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rtl8139_rx_config</span> <span class="o">|</span> <span class="n">rx_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">MAR0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">RTL_W32_F</span> <span class="p">(</span><span class="n">MAR0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8139_set_rx_mode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_suspend</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8139_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pci_save_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_device_detach</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts, stop Tx and Rx. */</span>
	<span class="n">RTL_W16</span> <span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RTL_W8</span> <span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Update the error counts. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">RTL_R32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">);</span>
	<span class="n">RTL_W32</span> <span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8139_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_restore_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_set_power_state</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">rtl8139_init_ring</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8139_hw_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_device_attach</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rtl8139_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rtl8139_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rtl8139_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rtl8139_remove_one</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">rtl8139_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">rtl8139_resume</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rtl8139_init_module</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* when we&#39;re a module, we always print a version message,</span>
<span class="cm">	 * even if no 8139 board is found.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">RTL8139_DRIVER_NAME</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8139_pci_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rtl8139_cleanup_module</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8139_pci_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">rtl8139_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rtl8139_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
