<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › realtek › r8169.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>r8169.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * r8169.c: RealTek 8169/8168/8101 ethernet driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2002 ShuChen &lt;shuchen@realtek.com.tw&gt;</span>
<span class="cm"> * Copyright (c) 2003 - 2007 Francois Romieu &lt;romieu@fr.zoreil.com&gt;</span>
<span class="cm"> * Copyright (c) a lot of people too. Please respect their work.</span>
<span class="cm"> *</span>
<span class="cm"> * See MAINTAINERS file for support contact information.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#define RTL8169_VERSION &quot;2.3LK-NAPI&quot;</span>
<span class="cp">#define MODULENAME &quot;r8169&quot;</span>
<span class="cp">#define PFX MODULENAME &quot;: &quot;</span>

<span class="cp">#define FIRMWARE_8168D_1	&quot;rtl_nic/rtl8168d-1.fw&quot;</span>
<span class="cp">#define FIRMWARE_8168D_2	&quot;rtl_nic/rtl8168d-2.fw&quot;</span>
<span class="cp">#define FIRMWARE_8168E_1	&quot;rtl_nic/rtl8168e-1.fw&quot;</span>
<span class="cp">#define FIRMWARE_8168E_2	&quot;rtl_nic/rtl8168e-2.fw&quot;</span>
<span class="cp">#define FIRMWARE_8168E_3	&quot;rtl_nic/rtl8168e-3.fw&quot;</span>
<span class="cp">#define FIRMWARE_8168F_1	&quot;rtl_nic/rtl8168f-1.fw&quot;</span>
<span class="cp">#define FIRMWARE_8168F_2	&quot;rtl_nic/rtl8168f-2.fw&quot;</span>
<span class="cp">#define FIRMWARE_8105E_1	&quot;rtl_nic/rtl8105e-1.fw&quot;</span>
<span class="cp">#define FIRMWARE_8402_1		&quot;rtl_nic/rtl8402-1.fw&quot;</span>
<span class="cp">#define FIRMWARE_8411_1		&quot;rtl_nic/rtl8411-1.fw&quot;</span>

<span class="cp">#ifdef RTL8169_DEBUG</span>
<span class="cp">#define assert(expr) \</span>
<span class="cp">	if (!(expr)) {					\</span>
<span class="cp">		printk( &quot;Assertion failed! %s,%s,%s,line=%d\n&quot;,	\</span>
<span class="cp">		#expr,__FILE__,__func__,__LINE__);		\</span>
<span class="cp">	}</span>
<span class="cp">#define dprintk(fmt, args...) \</span>
<span class="cp">	do { printk(KERN_DEBUG PFX fmt, ## args); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define assert(expr) do {} while (0)</span>
<span class="cp">#define dprintk(fmt, args...)	do {} while (0)</span>
<span class="cp">#endif </span><span class="cm">/* RTL8169_DEBUG */</span><span class="cp"></span>

<span class="cp">#define R8169_MSG_DEFAULT \</span>
<span class="cp">	(NETIF_MSG_DRV | NETIF_MSG_PROBE | NETIF_MSG_IFUP | NETIF_MSG_IFDOWN)</span>

<span class="cp">#define TX_SLOTS_AVAIL(tp) \</span>
<span class="cp">	(tp-&gt;dirty_tx + NUM_TX_DESC - tp-&gt;cur_tx)</span>

<span class="cm">/* A skbuff with nr_frags needs nr_frags+1 entries in the tx queue */</span>
<span class="cp">#define TX_FRAGS_READY_FOR(tp,nr_frags) \</span>
<span class="cp">	(TX_SLOTS_AVAIL(tp) &gt;= (nr_frags + 1))</span>

<span class="cm">/* Maximum number of multicast addresses to filter (vs. Rx-all-multicast).</span>
<span class="cm">   The RTL chips use a 64 element hash table based on the Ethernet CRC. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">multicast_filter_limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

<span class="cp">#define MAX_READ_REQUEST_SHIFT	12</span>
<span class="cp">#define TX_DMA_BURST	6	</span><span class="cm">/* Maximum PCI burst, &#39;6&#39; is 1024 */</span><span class="cp"></span>
<span class="cp">#define SafeMtu		0x1c20	</span><span class="cm">/* ... actually life sucks beyond ~7k */</span><span class="cp"></span>
<span class="cp">#define InterFrameGap	0x03	</span><span class="cm">/* 3 means InterFrameGap = the shortest one */</span><span class="cp"></span>

<span class="cp">#define R8169_REGS_SIZE		256</span>
<span class="cp">#define R8169_NAPI_WEIGHT	64</span>
<span class="cp">#define NUM_TX_DESC	64	</span><span class="cm">/* Number of Tx descriptor registers */</span><span class="cp"></span>
<span class="cp">#define NUM_RX_DESC	256	</span><span class="cm">/* Number of Rx descriptor registers */</span><span class="cp"></span>
<span class="cp">#define RX_BUF_SIZE	1536	</span><span class="cm">/* Rx Buffer size */</span><span class="cp"></span>
<span class="cp">#define R8169_TX_RING_BYTES	(NUM_TX_DESC * sizeof(struct TxDesc))</span>
<span class="cp">#define R8169_RX_RING_BYTES	(NUM_RX_DESC * sizeof(struct RxDesc))</span>

<span class="cp">#define RTL8169_TX_TIMEOUT	(6*HZ)</span>
<span class="cp">#define RTL8169_PHY_TIMEOUT	(10*HZ)</span>

<span class="cp">#define RTL_EEPROM_SIG		cpu_to_le32(0x8129)</span>
<span class="cp">#define RTL_EEPROM_SIG_MASK	cpu_to_le32(0xffff)</span>
<span class="cp">#define RTL_EEPROM_SIG_ADDR	0x0000</span>

<span class="cm">/* write/read MMIO register */</span>
<span class="cp">#define RTL_W8(reg, val8)	writeb ((val8), ioaddr + (reg))</span>
<span class="cp">#define RTL_W16(reg, val16)	writew ((val16), ioaddr + (reg))</span>
<span class="cp">#define RTL_W32(reg, val32)	writel ((val32), ioaddr + (reg))</span>
<span class="cp">#define RTL_R8(reg)		readb (ioaddr + (reg))</span>
<span class="cp">#define RTL_R16(reg)		readw (ioaddr + (reg))</span>
<span class="cp">#define RTL_R32(reg)		readl (ioaddr + (reg))</span>

<span class="k">enum</span> <span class="n">mac_version</span> <span class="p">{</span>
	<span class="n">RTL_GIGA_MAC_VER_01</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_02</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_03</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_04</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_07</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_08</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_09</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_10</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_11</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_12</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_13</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_14</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_15</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_16</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_17</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_18</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_19</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_20</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_21</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_22</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_23</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_24</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_25</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_26</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_27</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_28</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_29</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_30</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_32</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_33</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_34</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_35</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_36</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_37</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_VER_38</span><span class="p">,</span>
	<span class="n">RTL_GIGA_MAC_NONE</span>   <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl_tx_desc_version</span> <span class="p">{</span>
	<span class="n">RTL_TD_0</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RTL_TD_1</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define JUMBO_1K	ETH_DATA_LEN</span>
<span class="cp">#define JUMBO_4K	(4*1024 - ETH_HLEN - 2)</span>
<span class="cp">#define JUMBO_6K	(6*1024 - ETH_HLEN - 2)</span>
<span class="cp">#define JUMBO_7K	(7*1024 - ETH_HLEN - 2)</span>
<span class="cp">#define JUMBO_9K	(9*1024 - ETH_HLEN - 2)</span>

<span class="cp">#define _R(NAME,TD,FW,SZ,B) {	\</span>
<span class="cp">	.name = NAME,		\</span>
<span class="cp">	.txd_version = TD,	\</span>
<span class="cp">	.fw_name = FW,		\</span>
<span class="cp">	.jumbo_max = SZ,	\</span>
<span class="cp">	.jumbo_tx_csum = B	\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rtl_tx_desc_version</span> <span class="n">txd_version</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">jumbo_max</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">jumbo_tx_csum</span><span class="p">;</span>
<span class="p">}</span> <span class="n">rtl_chip_infos</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PCI devices. */</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_01</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8169&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_7K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_02</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8169s&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_7K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_03</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8110s&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_7K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_04</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8169sb/8110sb&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_7K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8169sc/8110sc&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_7K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8169sc/8110sc&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_7K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="cm">/* PCI-E devices. */</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_07</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8102e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_08</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8102e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_09</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8102e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_10</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8101e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_11</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168b/8111b&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_4K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_12</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168b/8111b&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_4K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_13</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8101e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_14</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8100e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_15</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8100e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_16</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8101e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_17</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168b/8111b&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_4K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_18</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168cp/8111cp&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_19</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168c/8111c&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_20</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168c/8111c&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_21</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168c/8111c&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_22</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168c/8111c&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_23</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168cp/8111cp&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_24</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168cp/8111cp&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_6K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_25</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168d/8111d&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168D_1</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_26</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168d/8111d&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168D_2</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_27</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168dp/8111dp&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_28</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168dp/8111dp&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_29</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8105e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8105E_1</span><span class="p">,</span>
							<span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_30</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8105e&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8105E_1</span><span class="p">,</span>
							<span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168dp/8111dp&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_32</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168e/8111e&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168E_1</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_33</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168e/8111e&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168E_2</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_34</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168evl/8111evl&quot;</span><span class="p">,</span><span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168E_3</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_35</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168f/8111f&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168F_1</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_36</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8168f/8111f&quot;</span><span class="p">,</span>	<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8168F_2</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_37</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8402&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8402_1</span><span class="p">,</span>
							<span class="n">JUMBO_1K</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="p">[</span><span class="n">RTL_GIGA_MAC_VER_38</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">_R</span><span class="p">(</span><span class="s">&quot;RTL8411&quot;</span><span class="p">,</span>		<span class="n">RTL_TD_1</span><span class="p">,</span> <span class="n">FIRMWARE_8411_1</span><span class="p">,</span>
							<span class="n">JUMBO_9K</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#undef _R</span>

<span class="k">enum</span> <span class="n">cfg_version</span> <span class="p">{</span>
	<span class="n">RTL_CFG_0</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">RTL_CFG_1</span><span class="p">,</span>
	<span class="n">RTL_CFG_2</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">rtl8169_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_REALTEK</span><span class="p">,</span>	<span class="mh">0x8129</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_REALTEK</span><span class="p">,</span>	<span class="mh">0x8136</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_REALTEK</span><span class="p">,</span>	<span class="mh">0x8167</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_REALTEK</span><span class="p">,</span>	<span class="mh">0x8168</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_REALTEK</span><span class="p">,</span>	<span class="mh">0x8169</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">,</span>	<span class="mh">0x4300</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_DLINK</span><span class="p">,</span>	<span class="mh">0x4302</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_AT</span><span class="p">,</span>		<span class="mh">0xc107</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x16ec</span><span class="p">,</span>			<span class="mh">0x0116</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LINKSYS</span><span class="p">,</span>		<span class="mh">0x1032</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0001</span><span class="p">,</span>				<span class="mh">0x8168</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mh">0x2410</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RTL_CFG_2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">rtl8169_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="mi">16383</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_dac</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span> <span class="n">debug</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl_registers</span> <span class="p">{</span>
	<span class="n">MAC0</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Ethernet hardware address. */</span>
	<span class="n">MAC4</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">MAR0</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* Multicast filter. */</span>
	<span class="n">CounterAddrLow</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CounterAddrHigh</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">TxDescStartAddrLow</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">TxDescStartAddrHigh</span>	<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="n">TxHDescStartAddrLow</span>	<span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>
	<span class="n">TxHDescStartAddrHigh</span>	<span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>
	<span class="n">FLASH</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">ERSR</span>		<span class="o">=</span> <span class="mh">0x36</span><span class="p">,</span>
	<span class="n">ChipCmd</span>		<span class="o">=</span> <span class="mh">0x37</span><span class="p">,</span>
	<span class="n">TxPoll</span>		<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>
	<span class="n">IntrMask</span>	<span class="o">=</span> <span class="mh">0x3c</span><span class="p">,</span>
	<span class="n">IntrStatus</span>	<span class="o">=</span> <span class="mh">0x3e</span><span class="p">,</span>

	<span class="n">TxConfig</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
<span class="cp">#define	TXCFG_AUTO_FIFO			(1 &lt;&lt; 7)	</span><span class="cm">/* 8111e-vl */</span><span class="cp"></span>
<span class="cp">#define	TXCFG_EMPTY			(1 &lt;&lt; 11)	</span><span class="cm">/* 8111e-vl */</span><span class="cp"></span>

	<span class="n">RxConfig</span>	<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
<span class="cp">#define	RX128_INT_EN			(1 &lt;&lt; 15)	</span><span class="cm">/* 8111c and later */</span><span class="cp"></span>
<span class="cp">#define	RX_MULTI_EN			(1 &lt;&lt; 14)	</span><span class="cm">/* 8111c only */</span><span class="cp"></span>
<span class="cp">#define	RXCFG_FIFO_SHIFT		13</span>
					<span class="cm">/* No threshold before first PCI xfer */</span>
<span class="cp">#define	RX_FIFO_THRESH			(7 &lt;&lt; RXCFG_FIFO_SHIFT)</span>
<span class="cp">#define	RXCFG_DMA_SHIFT			8</span>
					<span class="cm">/* Unlimited maximum PCI burst. */</span>
<span class="cp">#define	RX_DMA_BURST			(7 &lt;&lt; RXCFG_DMA_SHIFT)</span>

	<span class="n">RxMissed</span>	<span class="o">=</span> <span class="mh">0x4c</span><span class="p">,</span>
	<span class="n">Cfg9346</span>		<span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">Config0</span>		<span class="o">=</span> <span class="mh">0x51</span><span class="p">,</span>
	<span class="n">Config1</span>		<span class="o">=</span> <span class="mh">0x52</span><span class="p">,</span>
	<span class="n">Config2</span>		<span class="o">=</span> <span class="mh">0x53</span><span class="p">,</span>
<span class="cp">#define PME_SIGNAL			(1 &lt;&lt; 5)	</span><span class="cm">/* 8168c and later */</span><span class="cp"></span>

	<span class="n">Config3</span>		<span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span>
	<span class="n">Config4</span>		<span class="o">=</span> <span class="mh">0x55</span><span class="p">,</span>
	<span class="n">Config5</span>		<span class="o">=</span> <span class="mh">0x56</span><span class="p">,</span>
	<span class="n">MultiIntr</span>	<span class="o">=</span> <span class="mh">0x5c</span><span class="p">,</span>
	<span class="n">PHYAR</span>		<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">PHYstatus</span>	<span class="o">=</span> <span class="mh">0x6c</span><span class="p">,</span>
	<span class="n">RxMaxSize</span>	<span class="o">=</span> <span class="mh">0xda</span><span class="p">,</span>
	<span class="n">CPlusCmd</span>	<span class="o">=</span> <span class="mh">0xe0</span><span class="p">,</span>
	<span class="n">IntrMitigate</span>	<span class="o">=</span> <span class="mh">0xe2</span><span class="p">,</span>
	<span class="n">RxDescAddrLow</span>	<span class="o">=</span> <span class="mh">0xe4</span><span class="p">,</span>
	<span class="n">RxDescAddrHigh</span>	<span class="o">=</span> <span class="mh">0xe8</span><span class="p">,</span>
	<span class="n">EarlyTxThres</span>	<span class="o">=</span> <span class="mh">0xec</span><span class="p">,</span>	<span class="cm">/* 8169. Unit of 32 bytes. */</span>

<span class="cp">#define NoEarlyTx	0x3f	</span><span class="cm">/* Max value : no early transmit. */</span><span class="cp"></span>

	<span class="n">MaxTxPacketSize</span>	<span class="o">=</span> <span class="mh">0xec</span><span class="p">,</span>	<span class="cm">/* 8101/8168. Unit of 128 bytes. */</span>

<span class="cp">#define TxPacketMax	(8064 &gt;&gt; 7)</span>
<span class="cp">#define EarlySize	0x27</span>

	<span class="n">FuncEvent</span>	<span class="o">=</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="n">FuncEventMask</span>	<span class="o">=</span> <span class="mh">0xf4</span><span class="p">,</span>
	<span class="n">FuncPresetState</span>	<span class="o">=</span> <span class="mh">0xf8</span><span class="p">,</span>
	<span class="n">FuncForceEvent</span>	<span class="o">=</span> <span class="mh">0xfc</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl8110_registers</span> <span class="p">{</span>
	<span class="n">TBICSR</span>			<span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
	<span class="n">TBI_ANAR</span>		<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="n">TBI_LPAR</span>		<span class="o">=</span> <span class="mh">0x6a</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl8168_8101_registers</span> <span class="p">{</span>
	<span class="n">CSIDR</span>			<span class="o">=</span> <span class="mh">0x64</span><span class="p">,</span>
	<span class="n">CSIAR</span>			<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
<span class="cp">#define	CSIAR_FLAG			0x80000000</span>
<span class="cp">#define	CSIAR_WRITE_CMD			0x80000000</span>
<span class="cp">#define	CSIAR_BYTE_ENABLE		0x0f</span>
<span class="cp">#define	CSIAR_BYTE_ENABLE_SHIFT		12</span>
<span class="cp">#define	CSIAR_ADDR_MASK			0x0fff</span>
<span class="cp">#define CSIAR_FUNC_CARD			0x00000000</span>
<span class="cp">#define CSIAR_FUNC_SDIO			0x00010000</span>
<span class="cp">#define CSIAR_FUNC_NIC			0x00020000</span>
	<span class="n">PMCH</span>			<span class="o">=</span> <span class="mh">0x6f</span><span class="p">,</span>
	<span class="n">EPHYAR</span>			<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
<span class="cp">#define	EPHYAR_FLAG			0x80000000</span>
<span class="cp">#define	EPHYAR_WRITE_CMD		0x80000000</span>
<span class="cp">#define	EPHYAR_REG_MASK			0x1f</span>
<span class="cp">#define	EPHYAR_REG_SHIFT		16</span>
<span class="cp">#define	EPHYAR_DATA_MASK		0xffff</span>
	<span class="n">DLLPR</span>			<span class="o">=</span> <span class="mh">0xd0</span><span class="p">,</span>
<span class="cp">#define	PFM_EN				(1 &lt;&lt; 6)</span>
	<span class="n">DBG_REG</span>			<span class="o">=</span> <span class="mh">0xd1</span><span class="p">,</span>
<span class="cp">#define	FIX_NAK_1			(1 &lt;&lt; 4)</span>
<span class="cp">#define	FIX_NAK_2			(1 &lt;&lt; 3)</span>
	<span class="n">TWSI</span>			<span class="o">=</span> <span class="mh">0xd2</span><span class="p">,</span>
	<span class="n">MCU</span>			<span class="o">=</span> <span class="mh">0xd3</span><span class="p">,</span>
<span class="cp">#define	NOW_IS_OOB			(1 &lt;&lt; 7)</span>
<span class="cp">#define	EN_NDP				(1 &lt;&lt; 3)</span>
<span class="cp">#define	EN_OOB_RESET			(1 &lt;&lt; 2)</span>
	<span class="n">EFUSEAR</span>			<span class="o">=</span> <span class="mh">0xdc</span><span class="p">,</span>
<span class="cp">#define	EFUSEAR_FLAG			0x80000000</span>
<span class="cp">#define	EFUSEAR_WRITE_CMD		0x80000000</span>
<span class="cp">#define	EFUSEAR_READ_CMD		0x00000000</span>
<span class="cp">#define	EFUSEAR_REG_MASK		0x03ff</span>
<span class="cp">#define	EFUSEAR_REG_SHIFT		8</span>
<span class="cp">#define	EFUSEAR_DATA_MASK		0xff</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl8168_registers</span> <span class="p">{</span>
	<span class="n">LED_FREQ</span>		<span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>
	<span class="n">EEE_LED</span>			<span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>
	<span class="n">ERIDR</span>			<span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="n">ERIAR</span>			<span class="o">=</span> <span class="mh">0x74</span><span class="p">,</span>
<span class="cp">#define ERIAR_FLAG			0x80000000</span>
<span class="cp">#define ERIAR_WRITE_CMD			0x80000000</span>
<span class="cp">#define ERIAR_READ_CMD			0x00000000</span>
<span class="cp">#define ERIAR_ADDR_BYTE_ALIGN		4</span>
<span class="cp">#define ERIAR_TYPE_SHIFT		16</span>
<span class="cp">#define ERIAR_EXGMAC			(0x00 &lt;&lt; ERIAR_TYPE_SHIFT)</span>
<span class="cp">#define ERIAR_MSIX			(0x01 &lt;&lt; ERIAR_TYPE_SHIFT)</span>
<span class="cp">#define ERIAR_ASF			(0x02 &lt;&lt; ERIAR_TYPE_SHIFT)</span>
<span class="cp">#define ERIAR_MASK_SHIFT		12</span>
<span class="cp">#define ERIAR_MASK_0001			(0x1 &lt;&lt; ERIAR_MASK_SHIFT)</span>
<span class="cp">#define ERIAR_MASK_0011			(0x3 &lt;&lt; ERIAR_MASK_SHIFT)</span>
<span class="cp">#define ERIAR_MASK_1111			(0xf &lt;&lt; ERIAR_MASK_SHIFT)</span>
	<span class="n">EPHY_RXER_NUM</span>		<span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
	<span class="n">OCPDR</span>			<span class="o">=</span> <span class="mh">0xb0</span><span class="p">,</span>	<span class="cm">/* OCP GPHY access */</span>
<span class="cp">#define OCPDR_WRITE_CMD			0x80000000</span>
<span class="cp">#define OCPDR_READ_CMD			0x00000000</span>
<span class="cp">#define OCPDR_REG_MASK			0x7f</span>
<span class="cp">#define OCPDR_GPHY_REG_SHIFT		16</span>
<span class="cp">#define OCPDR_DATA_MASK			0xffff</span>
	<span class="n">OCPAR</span>			<span class="o">=</span> <span class="mh">0xb4</span><span class="p">,</span>
<span class="cp">#define OCPAR_FLAG			0x80000000</span>
<span class="cp">#define OCPAR_GPHY_WRITE_CMD		0x8000f060</span>
<span class="cp">#define OCPAR_GPHY_READ_CMD		0x0000f060</span>
	<span class="n">RDSAR1</span>			<span class="o">=</span> <span class="mh">0xd0</span><span class="p">,</span>	<span class="cm">/* 8168c only. Undocumented on 8168dp */</span>
	<span class="n">MISC</span>			<span class="o">=</span> <span class="mh">0xf0</span><span class="p">,</span>	<span class="cm">/* 8168e only. */</span>
<span class="cp">#define TXPLA_RST			(1 &lt;&lt; 29)</span>
<span class="cp">#define PWM_EN				(1 &lt;&lt; 22)</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl_register_content</span> <span class="p">{</span>
	<span class="cm">/* InterruptStatusBits */</span>
	<span class="n">SYSErr</span>		<span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">PCSTimeout</span>	<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">SWInt</span>		<span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span>
	<span class="n">TxDescUnavail</span>	<span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
	<span class="n">RxFIFOOver</span>	<span class="o">=</span> <span class="mh">0x0040</span><span class="p">,</span>
	<span class="n">LinkChg</span>		<span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
	<span class="n">RxOverflow</span>	<span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
	<span class="n">TxErr</span>		<span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
	<span class="n">TxOK</span>		<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">RxErr</span>		<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
	<span class="n">RxOK</span>		<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>

	<span class="cm">/* RxStatusDesc */</span>
	<span class="n">RxBOVF</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span>
	<span class="n">RxFOVF</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">),</span>
	<span class="n">RxRWT</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">),</span>
	<span class="n">RxRES</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">),</span>
	<span class="n">RxRUNT</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span>
	<span class="n">RxCRC</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">),</span>

	<span class="cm">/* ChipCmdBits */</span>
	<span class="n">StopReq</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">CmdReset</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CmdRxEnb</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">CmdTxEnb</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">RxBufEmpty</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="cm">/* TXPoll register p.5 */</span>
	<span class="n">HPQ</span>		<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>		<span class="cm">/* Poll cmd on the high prio queue */</span>
	<span class="n">NPQ</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>		<span class="cm">/* Poll cmd on the low prio queue */</span>
	<span class="n">FSWInt</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>		<span class="cm">/* Forced software interrupt */</span>

	<span class="cm">/* Cfg9346Bits */</span>
	<span class="n">Cfg9346_Lock</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">Cfg9346_Unlock</span>	<span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>

	<span class="cm">/* rx_mode_bits */</span>
	<span class="n">AcceptErr</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">AcceptRunt</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">AcceptBroadcast</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">AcceptMulticast</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">AcceptMyPhys</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">AcceptAllPhys</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="cp">#define RX_CONFIG_ACCEPT_MASK		0x3f</span>

	<span class="cm">/* TxConfigBits */</span>
	<span class="n">TxInterFrameGapShift</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="n">TxDMAShift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* DMA burst value (0-7) is shift this many bits */</span>

	<span class="cm">/* Config1 register p.24 */</span>
	<span class="n">LEDS1</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">LEDS0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">Speed_down</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">MEMMAP</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">IOMAP</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">VPD</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">PMEnable</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* Power Management Enable */</span>

	<span class="cm">/* Config2 register p. 25 */</span>
	<span class="n">MSIEnable</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* 8169 only. Reserved in the 8168. */</span>
	<span class="n">PCI_Clock_66MHz</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">PCI_Clock_33MHz</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* Config3 register p.25 */</span>
	<span class="n">MagicPacket</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* Wake up when receives a Magic Packet */</span>
	<span class="n">LinkUp</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* Wake up when the cable connection is re-established */</span>
	<span class="n">Jumbo_En0</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/* 8168 only. Reserved in the 8168b */</span>
	<span class="n">Beacon_en</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* 8168 only. Reserved in the 8168b */</span>

	<span class="cm">/* Config4 register */</span>
	<span class="n">Jumbo_En1</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* 8168 only. Reserved in the 8168b */</span>

	<span class="cm">/* Config5 register p.27 */</span>
	<span class="n">BWF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>	<span class="cm">/* Accept Broadcast wakeup frame */</span>
	<span class="n">MWF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>	<span class="cm">/* Accept Multicast wakeup frame */</span>
	<span class="n">UWF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>	<span class="cm">/* Accept Unicast wakeup frame */</span>
	<span class="n">Spi_en</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">LanWake</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>	<span class="cm">/* LanWake enable/disable */</span>
	<span class="n">PMEStatus</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>	<span class="cm">/* PME status can be reset by PCI RST# */</span>

	<span class="cm">/* TBICSR p.28 */</span>
	<span class="n">TBIReset</span>	<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span>
	<span class="n">TBILoopback</span>	<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span>
	<span class="n">TBINwEnable</span>	<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
	<span class="n">TBINwRestart</span>	<span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
	<span class="n">TBILinkOk</span>	<span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>
	<span class="n">TBINwComplete</span>	<span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span>

	<span class="cm">/* CPlusCmd p.31 */</span>
	<span class="n">EnableBist</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">Mac_dbgo_oe</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">Normal_mode</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span>	<span class="c1">// unused</span>
	<span class="n">Force_half_dup</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">Force_rxflow_en</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">Force_txflow_en</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">Cxpl_dbg_sel</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">ASF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">PktCntrDisable</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>	<span class="c1">// 8168 8101</span>
	<span class="n">Mac_dbgo_sel</span>	<span class="o">=</span> <span class="mh">0x001c</span><span class="p">,</span>	<span class="c1">// 8168</span>
	<span class="n">RxVlan</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">RxChkSum</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">PCIDAC</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">PCIMulRW</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">INTT_0</span>		<span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="c1">// 8168</span>
	<span class="n">INTT_1</span>		<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>	<span class="c1">// 8168</span>
	<span class="n">INTT_2</span>		<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>	<span class="c1">// 8168</span>
	<span class="n">INTT_3</span>		<span class="o">=</span> <span class="mh">0x0003</span><span class="p">,</span>	<span class="c1">// 8168</span>

	<span class="cm">/* rtl8169_PHYstatus */</span>
	<span class="n">TBI_Enable</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">TxFlowCtrl</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">RxFlowCtrl</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">_1000bpsF</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">_100bps</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">_10bps</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">LinkStatus</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">FullDup</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="cm">/* _TBICSRBit */</span>
	<span class="n">TBILinkOK</span>	<span class="o">=</span> <span class="mh">0x02000000</span><span class="p">,</span>

	<span class="cm">/* DumpCounterCommand */</span>
	<span class="n">CounterDump</span>	<span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl_desc_bit</span> <span class="p">{</span>
	<span class="cm">/* First doubleword. */</span>
	<span class="n">DescOwn</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span> <span class="cm">/* Descriptor is owned by NIC */</span>
	<span class="n">RingEnd</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span> <span class="cm">/* End of descriptor ring */</span>
	<span class="n">FirstFrag</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">),</span> <span class="cm">/* First segment of a packet */</span>
	<span class="n">LastFrag</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">),</span> <span class="cm">/* Final segment of a packet */</span>
<span class="p">};</span>

<span class="cm">/* Generic case. */</span>
<span class="k">enum</span> <span class="n">rtl_tx_desc_bit</span> <span class="p">{</span>
	<span class="cm">/* First doubleword. */</span>
	<span class="n">TD_LSO</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">),</span>		<span class="cm">/* Large Send Offload */</span>
<span class="cp">#define TD_MSS_MAX			0x07ffu	</span><span class="cm">/* MSS value */</span><span class="cp"></span>

	<span class="cm">/* Second doubleword. */</span>
	<span class="n">TxVlanTag</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span>		<span class="cm">/* Add VLAN tag */</span>
<span class="p">};</span>

<span class="cm">/* 8169, 8168b and 810x except 8102e. */</span>
<span class="k">enum</span> <span class="n">rtl_tx_desc_bit_0</span> <span class="p">{</span>
	<span class="cm">/* First doubleword. */</span>
<span class="cp">#define TD0_MSS_SHIFT			16	</span><span class="cm">/* MSS position (11 bits) */</span><span class="cp"></span>
	<span class="n">TD0_TCP_CS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>		<span class="cm">/* Calculate TCP/IP checksum */</span>
	<span class="n">TD0_UDP_CS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span>		<span class="cm">/* Calculate UDP/IP checksum */</span>
	<span class="n">TD0_IP_CS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span>		<span class="cm">/* Calculate IP checksum */</span>
<span class="p">};</span>

<span class="cm">/* 8102e, 8168c and beyond. */</span>
<span class="k">enum</span> <span class="n">rtl_tx_desc_bit_1</span> <span class="p">{</span>
	<span class="cm">/* Second doubleword. */</span>
<span class="cp">#define TD1_MSS_SHIFT			18	</span><span class="cm">/* MSS position (11 bits) */</span><span class="cp"></span>
	<span class="n">TD1_IP_CS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">),</span>		<span class="cm">/* Calculate IP checksum */</span>
	<span class="n">TD1_TCP_CS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span>		<span class="cm">/* Calculate TCP/IP checksum */</span>
	<span class="n">TD1_UDP_CS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span>		<span class="cm">/* Calculate UDP/IP checksum */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_tx_desc_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">udp</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tcp</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mss_shift</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">opts_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tx_desc_info</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">RTL_TD_0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">udp</span>	<span class="o">=</span> <span class="n">TD0_IP_CS</span> <span class="o">|</span> <span class="n">TD0_UDP_CS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tcp</span>	<span class="o">=</span> <span class="n">TD0_IP_CS</span> <span class="o">|</span> <span class="n">TD0_TCP_CS</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">mss_shift</span>	<span class="o">=</span> <span class="n">TD0_MSS_SHIFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">opts_offset</span>	<span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RTL_TD_1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">udp</span>	<span class="o">=</span> <span class="n">TD1_IP_CS</span> <span class="o">|</span> <span class="n">TD1_UDP_CS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">tcp</span>	<span class="o">=</span> <span class="n">TD1_IP_CS</span> <span class="o">|</span> <span class="n">TD1_TCP_CS</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">mss_shift</span>	<span class="o">=</span> <span class="n">TD1_MSS_SHIFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">opts_offset</span>	<span class="o">=</span> <span class="mi">1</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl_rx_desc_bit</span> <span class="p">{</span>
	<span class="cm">/* Rx private */</span>
	<span class="n">PID1</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span> <span class="cm">/* Protocol ID bit 1/2 */</span>
	<span class="n">PID0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* Protocol ID bit 2/2 */</span>

<span class="cp">#define RxProtoUDP	(PID1)</span>
<span class="cp">#define RxProtoTCP	(PID0)</span>
<span class="cp">#define RxProtoIP	(PID1 | PID0)</span>
<span class="cp">#define RxProtoMask	RxProtoIP</span>

	<span class="n">IPFail</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/* IP checksum failed */</span>
	<span class="n">UDPFail</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span> <span class="cm">/* UDP/IP checksum failed */</span>
	<span class="n">TCPFail</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span> <span class="cm">/* TCP/IP checksum failed */</span>
	<span class="n">RxVlanTag</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/* VLAN tag available */</span>
<span class="p">};</span>

<span class="cp">#define RsvdMask	0x3fffc000</span>

<span class="k">struct</span> <span class="n">TxDesc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">opts1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">opts2</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">RxDesc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">opts1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">opts2</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ring_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">__pad</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">features</span> <span class="p">{</span>
	<span class="n">RTL_FEATURE_WOL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RTL_FEATURE_MSI</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">RTL_FEATURE_GMII</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtl8169_counters</span> <span class="p">{</span>
	<span class="n">__le64</span>	<span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">__le64</span>	<span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">__le64</span>	<span class="n">tx_errors</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">rx_missed</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">align_errors</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">tx_one_collision</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">tx_multi_collision</span><span class="p">;</span>
	<span class="n">__le64</span>	<span class="n">rx_unicast</span><span class="p">;</span>
	<span class="n">__le64</span>	<span class="n">rx_broadcast</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">rx_multicast</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">tx_aborted</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">tx_underun</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">rtl_flag</span> <span class="p">{</span>
	<span class="n">RTL_FLAG_TASK_ENABLED</span><span class="p">,</span>
	<span class="n">RTL_FLAG_TASK_SLOW_PENDING</span><span class="p">,</span>
	<span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">,</span>
	<span class="n">RTL_FLAG_TASK_PHY_PENDING</span><span class="p">,</span>
	<span class="n">RTL_FLAG_MAX</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtl8169_stats</span> <span class="p">{</span>
	<span class="n">u64</span>			<span class="n">packets</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">u64_stats_sync</span>	<span class="n">syncp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_addr</span><span class="p">;</span>	<span class="cm">/* memory map physical address */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txd_version</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mac_version</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_rx</span><span class="p">;</span> <span class="cm">/* Index into the Rx descriptor buffer of next Rx pkt. */</span>
	<span class="n">u32</span> <span class="n">cur_tx</span><span class="p">;</span> <span class="cm">/* Index into the Tx descriptor buffer of next Rx pkt. */</span>
	<span class="n">u32</span> <span class="n">dirty_rx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dirty_tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_stats</span> <span class="n">rx_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_stats</span> <span class="n">tx_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">TxDescArray</span><span class="p">;</span>	<span class="cm">/* 256-aligned Tx descriptor ring */</span>
	<span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">RxDescArray</span><span class="p">;</span>	<span class="cm">/* 256-aligned Rx descriptor ring */</span>
	<span class="n">dma_addr_t</span> <span class="n">TxPhyAddr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">RxPhyAddr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">Rx_databuff</span><span class="p">[</span><span class="n">NUM_RX_DESC</span><span class="p">];</span>	<span class="cm">/* Rx data buffers */</span>
	<span class="k">struct</span> <span class="n">ring_info</span> <span class="n">tx_skb</span><span class="p">[</span><span class="n">NUM_TX_DESC</span><span class="p">];</span>	<span class="cm">/* Tx data buffers */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cp_cmd</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">event_slow</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mdio_ops</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">mdio_ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pll_power_ops</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">down</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="p">);</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">pll_power_ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">jumbo_ops</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">enable</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="p">);</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">disable</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">jumbo_ops</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">csi_ops</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
		<span class="n">u32</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">csi_ops</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_speed</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="n">aneg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dpx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">adv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_settings</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">phy_reset_enable</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hw_start</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">phy_reset_pending</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">link_ok</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">do_ioctl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">RTL_FLAG_MAX</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">wk</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">features</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_counters</span> <span class="n">counters</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saved_wolopts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opts1_mask</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">rtl_fw</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>

<span class="cp">#define RTL_VER_SIZE		32</span>

		<span class="kt">char</span> <span class="n">version</span><span class="p">[</span><span class="n">RTL_VER_SIZE</span><span class="p">];</span>

		<span class="k">struct</span> <span class="n">rtl_fw_phy_action</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
			<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">phy_action</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">rtl_fw</span><span class="p">;</span>
<span class="cp">#define RTL_FIRMWARE_UNKNOWN	ERR_PTR(-EAGAIN)</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Realtek and the Linux r8169 crew &lt;netdev@vger.kernel.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RealTek RTL-8169 Gigabit Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_dac</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_dac</span><span class="p">,</span> <span class="s">&quot;Enable PCI DAC. Unsafe on 32 bit PCI slot.&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug verbosity level (0=none, ..., 16=all)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">RTL8169_VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168D_1</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168D_2</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168E_1</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168E_2</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168E_3</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8105E_1</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168F_1</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8168F_2</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8402_1</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_8411_1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_lock_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_unlock_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_tx_performance_tweak</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PCI_EXP_DEVCTL_READRQ</span><span class="p">)</span> <span class="o">|</span> <span class="n">force</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ocp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">,</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OCPAR_FLAG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">OCPDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ocp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">OCPDR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">,</span> <span class="n">OCPAR_FLAG</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OCPAR_FLAG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168_oob_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ERIDR</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">ERIAR</span><span class="p">,</span> <span class="mh">0x800010e8</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">ERIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ERIAR_FLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ocp_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define OOB_CMD_RESET		0x00</span>
<span class="cp">#define OOB_CMD_DRIVER_START	0x05</span>
<span class="cp">#define OOB_CMD_DRIVER_STOP	0x06</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">rtl8168_get_ocp_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xb8</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168_driver_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtl8168_oob_notify</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">OOB_CMD_DRIVER_START</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">rtl8168_get_ocp_reg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ocp_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000800</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168_driver_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtl8168_oob_notify</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">OOB_CMD_DRIVER_STOP</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">rtl8168_get_ocp_reg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ocp_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000800</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8168dp_check_dash</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">rtl8168_get_ocp_reg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ocp_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00008000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8169_mdio_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">PHYAR</span><span class="p">,</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if the RTL8169 has completed writing to the specified</span>
<span class="cm">		 * MII register.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">PHYAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * According to hardware specs a 20us delay is required after write</span>
<span class="cm">	 * complete indication, but before sending next command.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8169_mdio_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">PHYAR</span><span class="p">,</span> <span class="mh">0x0</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if the RTL8169 has completed retrieving data from</span>
<span class="cm">		 * the specified MII register.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">PHYAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">PHYAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * According to hardware specs a 20us delay is required after read</span>
<span class="cm">	 * complete indication, but before sending next command.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_1_mdio_access</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">OCPDR</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="n">OCPDR_REG_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">OCPDR_GPHY_REG_SHIFT</span><span class="p">));</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">,</span> <span class="n">OCPAR_GPHY_WRITE_CMD</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">EPHY_RXER_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OCPAR_FLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_1_mdio_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r8168dp_1_mdio_access</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">OCPDR_WRITE_CMD</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">OCPDR_DATA_MASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8168dp_1_mdio_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">r8168dp_1_mdio_access</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">OCPDR_READ_CMD</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">,</span> <span class="n">OCPAR_GPHY_READ_CMD</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">EPHY_RXER_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">OCPAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OCPAR_FLAG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">OCPDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OCPDR_DATA_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define R8168DP_1_MDIO_ACCESS_BIT	0x00020000</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_2_mdio_start</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">R8168DP_1_MDIO_ACCESS_BIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_2_mdio_stop</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="mh">0xd0</span><span class="p">)</span> <span class="o">|</span> <span class="n">R8168DP_1_MDIO_ACCESS_BIT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_2_mdio_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r8168dp_2_mdio_start</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">r8169_mdio_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">r8168dp_2_mdio_stop</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r8168dp_2_mdio_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">r8168dp_2_mdio_start</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">r8169_mdio_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>

	<span class="n">r8168dp_2_mdio_stop</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_writephy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_ops</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_readphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_patchphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_w1w0_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_ephy_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">EPHYAR</span><span class="p">,</span> <span class="n">EPHYAR_WRITE_CMD</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">EPHYAR_DATA_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="n">EPHYAR_REG_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EPHYAR_REG_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">EPHYAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EPHYAR_FLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">rtl_ephy_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">EPHYAR</span><span class="p">,</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="n">EPHYAR_REG_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EPHYAR_REG_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">EPHYAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EPHYAR_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">EPHYAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EPHYAR_DATA_MASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">rtl_eri_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">ERIDR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">ERIAR</span><span class="p">,</span> <span class="n">ERIAR_WRITE_CMD</span> <span class="o">|</span> <span class="n">type</span> <span class="o">|</span> <span class="n">mask</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">ERIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ERIAR_FLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rtl_eri_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">ERIAR</span><span class="p">,</span> <span class="n">ERIAR_READ_CMD</span> <span class="o">|</span> <span class="n">type</span> <span class="o">|</span> <span class="n">ERIAR_MASK_1111</span> <span class="o">|</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">ERIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ERIAR_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">ERIDR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rtl_w1w0_eri</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rtl_eri_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">exgmac_reg</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_write_exgmac_batch</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">exgmac_reg</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="n">r</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rtl8168d_efuse_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">EFUSEAR</span><span class="p">,</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">&amp;</span> <span class="n">EFUSEAR_REG_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">EFUSEAR_REG_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">EFUSEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EFUSEAR_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">EFUSEAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EFUSEAR_DATA_MASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">rtl_get_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_ack_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">IntrStatus</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RTL_EVENT_NAPI_RX	(RxOK | RxErr)</span>
<span class="cp">#define RTL_EVENT_NAPI_TX	(TxOK | TxErr)</span>
<span class="cp">#define RTL_EVENT_NAPI		(RTL_EVENT_NAPI_RX | RTL_EVENT_NAPI_TX)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_irq_enable_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_irq_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_EVENT_NAPI</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_irq_mask_and_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rtl_irq_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl_ack_events</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_EVENT_NAPI</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">);</span>
	<span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rtl8169_tbi_reset_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TBIReset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rtl8169_xmii_reset_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rtl8169_tbi_link_ok</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TBILinkOk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rtl8169_xmii_link_ok</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">PHYstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LinkStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_tbi_reset_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">TBIReset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_xmii_reset_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_link_chg_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_34</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_38</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">PHYstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_1000bpsF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1bc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x00000011</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1dc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x00000005</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">PHYstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_100bps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1bc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x0000001f</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1dc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x00000005</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1bc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x0000001f</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1dc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x0000003f</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Reset packet filter */</span>
		<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
			     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
			     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_35</span> <span class="o">||</span>
		   <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_36</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">PHYstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_1000bpsF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1bc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x00000011</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1dc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x00000005</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1bc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x0000001f</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1dc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span>
				      <span class="mh">0x0000003f</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_37</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">PHYstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_10bps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1d0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span>
				      <span class="mh">0x4d02</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1dc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span>
				      <span class="mh">0x0060</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1d0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span>
				      <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rtl8169_check_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_ok</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtl_link_chg_patch</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="cm">/* This is to cancel a scheduled suspend if there&#39;s one. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm</span><span class="p">)</span>
			<span class="n">pm_request_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifdown</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm</span><span class="p">)</span>
			<span class="n">pm_schedule_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_check_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__rtl8169_check_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define WAKE_ANY (WAKE_PHY | WAKE_MAGIC | WAKE_UCAST | WAKE_BCAST | WAKE_MCAST)</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__rtl8169_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">options</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">PMEnable</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">LinkUp</span><span class="p">)</span>
		<span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_PHY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MagicPacket</span><span class="p">)</span>
		<span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>

	<span class="n">options</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">UWF</span><span class="p">)</span>
		<span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_UCAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">BWF</span><span class="p">)</span>
		<span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_BCAST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">MWF</span><span class="p">)</span>
		<span class="n">wolopts</span> <span class="o">|=</span> <span class="n">WAKE_MCAST</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wolopts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_ANY</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">__rtl8169_get_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rtl8169_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wolopts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">opt</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cfg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">WAKE_PHY</span><span class="p">,</span>   <span class="n">Config3</span><span class="p">,</span> <span class="n">LinkUp</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">WAKE_MAGIC</span><span class="p">,</span> <span class="n">Config3</span><span class="p">,</span> <span class="n">MagicPacket</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">WAKE_UCAST</span><span class="p">,</span> <span class="n">Config5</span><span class="p">,</span> <span class="n">UWF</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">WAKE_BCAST</span><span class="p">,</span> <span class="n">Config5</span><span class="p">,</span> <span class="n">BWF</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">WAKE_MCAST</span><span class="p">,</span> <span class="n">Config5</span><span class="p">,</span> <span class="n">MWF</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">WAKE_ANY</span><span class="p">,</span>   <span class="n">Config5</span><span class="p">,</span> <span class="n">LanWake</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">options</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cfg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">options</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">opt</span><span class="p">)</span>
			<span class="n">options</span> <span class="o">|=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_01</span> <span class="p">...</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">options</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PMEnable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wolopts</span><span class="p">)</span>
			<span class="n">options</span> <span class="o">|=</span> <span class="n">PMEnable</span><span class="p">;</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">options</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PME_SIGNAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wolopts</span><span class="p">)</span>
			<span class="n">options</span> <span class="o">|=</span> <span class="n">PME_SIGNAL</span><span class="p">;</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config2</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">RTL_FEATURE_WOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTL_FEATURE_WOL</span><span class="p">;</span>
	<span class="n">__rtl8169_set_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">);</span>

	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">rtl_lookup_firmware_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">].</span><span class="n">fw_name</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl_fw</span> <span class="o">*</span><span class="n">rtl_fw</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">MODULENAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">RTL8169_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">rtl_fw</span><span class="p">))</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">R8169_REGS_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_set_speed_tbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_DISABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TBINwEnable</span> <span class="o">|</span> <span class="n">TBINwRestart</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span>
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">TBINwEnable</span> <span class="o">|</span> <span class="n">TBINwRestart</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;incorrect speed setting refused in TBI mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_set_speed_xmii</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">u32</span> <span class="n">adv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">giga_ctrl</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">auto_nego</span><span class="p">;</span>

		<span class="n">auto_nego</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
		<span class="n">auto_nego</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_10HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">|</span>
				<span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_100FULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">)</span>
			<span class="n">auto_nego</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">)</span>
			<span class="n">auto_nego</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">)</span>
			<span class="n">auto_nego</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">)</span>
			<span class="n">auto_nego</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>

		<span class="n">auto_nego</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>

		<span class="n">giga_ctrl</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">);</span>
		<span class="n">giga_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_1000FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_1000HALF</span><span class="p">);</span>

		<span class="cm">/* The 8100e/8101e/8102e do Fast Ethernet only. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">supports_gmii</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Half</span><span class="p">)</span>
				<span class="n">giga_ctrl</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000HALF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">)</span>
				<span class="n">giga_ctrl</span> <span class="o">|=</span> <span class="n">ADVERTISE_1000FULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adv</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
				  <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;PHY does not support 1000Mbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">;</span>

		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">auto_nego</span><span class="p">);</span>
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_CTRL1000</span><span class="p">,</span> <span class="n">giga_ctrl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">giga_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_02</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_03</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">autoneg</span> <span class="o">!=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x2138</span><span class="p">);</span>
			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0260</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x2108</span><span class="p">);</span>
			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_set_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">speed</span><span class="p">,</span> <span class="n">u8</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">u32</span> <span class="n">advertising</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">advertising</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">advertising</span> <span class="o">&amp;</span> <span class="n">ADVERTISED_1000baseT_Full</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">RTL8169_PHY_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rtl8169_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">,</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span> <span class="nf">rtl8169_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">TD_MSS_MAX</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_ALL_TSO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">JUMBO_1K</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">].</span><span class="n">jumbo_tx_csum</span><span class="p">)</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rtl8169_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_RXALL</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="n">RxChkSum</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxChkSum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="n">RxVlan</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxVlan</span><span class="p">;</span>

		<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span><span class="p">);</span>
		<span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">AcceptErr</span> <span class="o">|</span> <span class="n">AcceptRunt</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AcceptErr</span> <span class="o">|</span> <span class="n">AcceptRunt</span><span class="p">);</span>
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">__rtl8169_set_features</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rtl8169_tx_vlan_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">?</span>
		<span class="n">TxVlanTag</span> <span class="o">|</span> <span class="n">swab16</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_rx_vlan_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opts2</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts2</span> <span class="o">&amp;</span> <span class="n">RxVlanTag</span><span class="p">)</span>
		<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">swab16</span><span class="p">(</span><span class="n">opts2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_gset_tbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span>
		<span class="n">SUPPORTED_1000baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_FIBRE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_FIBRE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TBICSR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TBINwEnable</span><span class="p">)</span> <span class="o">?</span>  <span class="n">ADVERTISED_Autoneg</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TBINwEnable</span><span class="p">);</span>

	<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span> <span class="cm">/* Always set */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_gset_xmii</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">get_settings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">R8169_REGS_SIZE</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">R8169_REGS_SIZE</span><span class="p">;</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rtl8169_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">rtl8169_gstrings</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;tx_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_missed&quot;</span><span class="p">,</span>
	<span class="s">&quot;align_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_single_collisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_multi_collisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;unicast&quot;</span><span class="p">,</span>
	<span class="s">&quot;broadcast&quot;</span><span class="p">,</span>
	<span class="s">&quot;multicast&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_aborted&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_underrun&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rtl8169_gstrings</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_update_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_counters</span> <span class="o">*</span><span class="n">counters</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some chips are unable to dump tally counters when the receiver</span>
<span class="cm">	 * is disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdRxEnb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">counters</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">counters</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">paddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">counters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CounterAddrHigh</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">paddr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CounterAddrLow</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CounterAddrLow</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="n">CounterDump</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">wait</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">CounterAddrLow</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CounterDump</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">,</span> <span class="n">counters</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">counters</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CounterAddrLow</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CounterAddrHigh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">counters</span><span class="p">),</span> <span class="n">counters</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ASSERT_RTNL</span><span class="p">();</span>

	<span class="n">rtl8169_update_counters</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">rx_missed</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">align_errors</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_one_collision</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_multi_collision</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">rx_unicast</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">rx_broadcast</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">rx_multicast</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_aborted</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_underun</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">rtl8169_gstrings</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rtl8169_gstrings</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">rtl8169_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">rtl8169_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">rtl8169_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">rtl8169_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">rtl8169_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">rtl8169_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">rtl8169_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">rtl8169_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">rtl8169_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">rtl8169_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">rtl8169_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">rtl8169_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">rtl8169_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span>		<span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_get_mac_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">default_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The driver currently handles the 8168Bf and the 8168Be identically</span>
<span class="cm">	 * but they can be identified more specifically through the test below</span>
<span class="cm">	 * if needed:</span>
<span class="cm">	 *</span>
<span class="cm">	 * (RTL_R32(TxConfig) &amp; 0x700000) == 0x500000 ? 8168Bf : 8168Be</span>
<span class="cm">	 *</span>
<span class="cm">	 * Same thing for the 8101Eb and the 8101Ec:</span>
<span class="cm">	 *</span>
<span class="cm">	 * (RTL_R32(TxConfig) &amp; 0x700000) == 0x200000 ? 8101Eb : 8101Ec</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_mac_info</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mac_version</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mac_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* 8168F family. */</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x48800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_38</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x48100000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_36</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x48000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_35</span> <span class="p">},</span>

		<span class="cm">/* 8168E family. */</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x2c800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_34</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x2c200000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_33</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x2c100000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_32</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x2c000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_33</span> <span class="p">},</span>

		<span class="cm">/* 8168D family. */</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x28300000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_26</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x28100000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_25</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x28000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_26</span> <span class="p">},</span>

		<span class="cm">/* 8168DP family. */</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x28800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_27</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x28a00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_28</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x28b00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_31</span> <span class="p">},</span>

		<span class="cm">/* 8168C family. */</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3cb00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_24</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3c900000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_23</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3c800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_18</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x3c800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_24</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3c000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_19</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3c200000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3c300000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_21</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x3c400000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_22</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x3c000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_22</span> <span class="p">},</span>

		<span class="cm">/* 8168B family. */</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x38000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_12</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x38500000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_17</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x38000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_17</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x30000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_11</span> <span class="p">},</span>

		<span class="cm">/* 8101 family. */</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x44000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_37</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x40b00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x40a00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x40900000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_29</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x40800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x34a00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_09</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x24a00000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_09</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x34900000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x24900000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_08</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x34800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_07</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x24800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_07</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x34000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_13</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x34300000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_10</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7cf00000</span><span class="p">,</span> <span class="mh">0x34200000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_16</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x34800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_09</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x24800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_09</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x7c800000</span><span class="p">,</span> <span class="mh">0x34000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_16</span> <span class="p">},</span>
		<span class="cm">/* FIXME: where did these entries come from ? -- FR */</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x38800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_15</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x30800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_14</span> <span class="p">},</span>

		<span class="cm">/* 8110 family. */</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x98000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_06</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x18000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_05</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_04</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_03</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0xfc800000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_VER_01</span> <span class="p">},</span>

		<span class="cm">/* Catch-all */</span>
		<span class="p">{</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>	<span class="n">RTL_GIGA_MAC_NONE</span>   <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_mac_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">mac_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_notice</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;unknown MAC, using family default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">=</span> <span class="n">default_version</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_print_mac_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mac_version = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">phy_reg</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_writephy_batch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define PHY_READ		0x00000000</span>
<span class="cp">#define PHY_DATA_OR		0x10000000</span>
<span class="cp">#define PHY_DATA_AND		0x20000000</span>
<span class="cp">#define PHY_BJMPN		0x30000000</span>
<span class="cp">#define PHY_READ_EFUSE		0x40000000</span>
<span class="cp">#define PHY_READ_MAC_BYTE	0x50000000</span>
<span class="cp">#define PHY_WRITE_MAC_BYTE	0x60000000</span>
<span class="cp">#define PHY_CLEAR_READCOUNT	0x70000000</span>
<span class="cp">#define PHY_WRITE		0x80000000</span>
<span class="cp">#define PHY_READCOUNT_EQ_SKIP	0x90000000</span>
<span class="cp">#define PHY_COMP_EQ_SKIPN	0xa0000000</span>
<span class="cp">#define PHY_COMP_NEQ_SKIPN	0xb0000000</span>
<span class="cp">#define PHY_WRITE_PREVIOUS	0xc0000000</span>
<span class="cp">#define PHY_SKIPN		0xd0000000</span>
<span class="cp">#define PHY_DELAY_MS		0xe0000000</span>
<span class="cp">#define PHY_WRITE_ERI_WORD	0xf0000000</span>

<span class="k">struct</span> <span class="n">fw_info</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">magic</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">version</span><span class="p">[</span><span class="n">RTL_VER_SIZE</span><span class="p">];</span>
	<span class="n">__le32</span>	<span class="n">fw_start</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">fw_len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">chksum</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define FW_OPCODE_SIZE	sizeof(typeof(*((struct rtl_fw_phy_action *)0)-&gt;code))</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl_fw_format_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_fw</span> <span class="o">*</span><span class="n">rtl_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_info</span> <span class="o">*</span><span class="n">fw_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_info</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_fw_phy_action</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">phy_action</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">FW_OPCODE_SIZE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_info</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fw_info</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_info</span><span class="o">-&gt;</span><span class="n">fw_start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_info</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">FW_OPCODE_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">fw_info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">RTL_VER_SIZE</span><span class="p">);</span>

		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">start</span><span class="p">);</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="n">FW_OPCODE_SIZE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">strlcpy</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">rtl_lookup_firmware_name</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span> <span class="n">RTL_VER_SIZE</span><span class="p">);</span>

		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">FW_OPCODE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">version</span><span class="p">[</span><span class="n">RTL_VER_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl_fw_data_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">rtl_fw_phy_action</span> <span class="o">*</span><span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">action</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">u32</span> <span class="n">regno</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="mh">0x0fff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHY_READ</span>:
		<span class="k">case</span> <span class="n">PHY_DATA_OR</span>:
		<span class="k">case</span> <span class="n">PHY_DATA_AND</span>:
		<span class="k">case</span> <span class="n">PHY_READ_EFUSE</span>:
		<span class="k">case</span> <span class="n">PHY_CLEAR_READCOUNT</span>:
		<span class="k">case</span> <span class="n">PHY_WRITE</span>:
		<span class="k">case</span> <span class="n">PHY_WRITE_PREVIOUS</span>:
		<span class="k">case</span> <span class="n">PHY_DELAY_MS</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PHY_BJMPN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="s">&quot;Out of range of firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_READCOUNT_EQ_SKIP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="s">&quot;Out of range of firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_COMP_EQ_SKIPN</span>:
		<span class="k">case</span> <span class="n">PHY_COMP_NEQ_SKIPN</span>:
		<span class="k">case</span> <span class="n">PHY_SKIPN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="s">&quot;Out of range of firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PHY_READ_MAC_BYTE</span>:
		<span class="k">case</span> <span class="n">PHY_WRITE_MAC_BYTE</span>:
		<span class="k">case</span> <span class="n">PHY_WRITE_ERI_WORD</span>:
		<span class="nl">default:</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="s">&quot;Invalid action 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_check_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_fw</span> <span class="o">*</span><span class="n">rtl_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl_fw_format_ok</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rtl_fw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid firwmare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_fw_data_ok</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">phy_action</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_phy_write_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl_fw</span> <span class="o">*</span><span class="n">rtl_fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_fw_phy_action</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">phy_action</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">predata</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">predata</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">action</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">action</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">regno</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="mh">0x0fff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PHY_READ</span>:
			<span class="n">predata</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_DATA_OR</span>:
			<span class="n">predata</span> <span class="o">|=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_DATA_AND</span>:
			<span class="n">predata</span> <span class="o">&amp;=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_BJMPN</span>:
			<span class="n">index</span> <span class="o">-=</span> <span class="n">regno</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_READ_EFUSE</span>:
			<span class="n">predata</span> <span class="o">=</span> <span class="n">rtl8168d_efuse_read</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">regno</span><span class="p">);</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_CLEAR_READCOUNT</span>:
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_WRITE</span>:
			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_READCOUNT_EQ_SKIP</span>:
			<span class="n">index</span> <span class="o">+=</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_COMP_EQ_SKIPN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">predata</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="n">regno</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_COMP_NEQ_SKIPN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">predata</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span>
				<span class="n">index</span> <span class="o">+=</span> <span class="n">regno</span><span class="p">;</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_WRITE_PREVIOUS</span>:
			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">predata</span><span class="p">);</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_SKIPN</span>:
			<span class="n">index</span> <span class="o">+=</span> <span class="n">regno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PHY_DELAY_MS</span>:
			<span class="n">mdelay</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PHY_READ_MAC_BYTE</span>:
		<span class="k">case</span> <span class="n">PHY_WRITE_MAC_BYTE</span>:
		<span class="k">case</span> <span class="n">PHY_WRITE_ERI_WORD</span>:
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span> <span class="o">=</span> <span class="n">RTL_FIRMWARE_UNKNOWN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_apply_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_fw</span> <span class="o">*</span><span class="n">rtl_fw</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span><span class="p">;</span>

	<span class="cm">/* TODO: release firmware once rtl_phy_write_fw signals failures. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">rtl_fw</span><span class="p">))</span>
		<span class="n">rtl_phy_write_fw</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rtl_fw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_apply_firmware_cond</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">netif_warn</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chipset not ready for firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169s_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x006e</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0708</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x4000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x65c7</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00a1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0008</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0120</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xff41</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0140</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0077</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x7800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x7000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x802f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4f02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0409</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf0f9</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xff95</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xba00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xff41</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0140</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00bb</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xb800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xb000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf41</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdc60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x6340</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x007d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xd800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xd000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x100a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9200</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169sb_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x90d0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169scd_hw_phy_config_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_GIGABYTE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">!=</span> <span class="mh">0xe000</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf01b</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169scd_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00a1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0008</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0120</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x802f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4f02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0409</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf099</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xff95</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xba00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x101a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf41b</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xfb54</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xf5c7</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="n">rtl8169scd_hw_phy_config_quirk</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169sce_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00a1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0008</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0120</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x802f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4f02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0409</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf099</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xff95</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xba00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x101a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x8480</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x67c7</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x2000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x002f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4360</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0109</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3022</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x2800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168bb_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf41b</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168bef_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf41b</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168cp_1_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x0f00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1ec8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168cp_2_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3d98</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168c_1_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x88d4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x82b1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x7002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x9e30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01f0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x5500</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00c8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xc096</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x000a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x2000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168c_2_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x802f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4f02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0409</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf099</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x9000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3d98</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x7eb8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0761</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0f0a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168c_3_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3d98</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x7eb8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x5461</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0f0a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168c_4_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8168c_3_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168d_1_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Channel Estimation */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x4064</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x2863</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x059c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x26b4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x6a19</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xdcc8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf06d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7f68</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7fd9</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xf0ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3d9c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xf49f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x070b</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x05ad</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x94c0</span> <span class="p">},</span>

		<span class="cm">/*</span>
<span class="cm">		 * Tx Error Issue</span>
<span class="cm">		 * Enhance line driver power</span>
<span class="cm">		 */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x5561</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8332</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x5561</span> <span class="p">},</span>

		<span class="cm">/*</span>
<span class="cm">		 * Can not link to 1Gbps with bad cable</span>
<span class="cm">		 * Decrease SNR threshold form 21.07dB to 19.04dB</span>
<span class="cm">		 */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xf880</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init_0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init_0</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rx Error Issue</span>
<span class="cm">	 * Fine Tune Switching regulator parameter</span>
<span class="cm">	 */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x00ef</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0xa200</span><span class="p">,</span> <span class="mh">0x5d00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8168d_efuse_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x669a</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8330</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x669a</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">}</span>
		<span class="p">};</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x006c</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">set</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="mh">0x0065</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x0067</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span>
				<span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x006b</span><span class="p">,</span> <span class="mh">0x006c</span>
			<span class="p">};</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff00</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">set</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">set</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x6662</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8330</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x6662</span> <span class="p">}</span>
		<span class="p">};</span>

		<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* RSET couple improve */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>

	<span class="cm">/* Fine tune PLL performance */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0600</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xe000</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">);</span>

	<span class="n">rtl_apply_firmware_cond</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_EXPANSION</span><span class="p">,</span> <span class="mh">0xbf00</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168d_2_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Channel Estimation */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x4064</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x2863</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x059c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x26b4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x6a19</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xdcc8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf06d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7f68</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7fd9</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xf0ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3d9c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xf49f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x070b</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x05ad</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x94c0</span> <span class="p">},</span>

		<span class="cm">/*</span>
<span class="cm">		 * Tx Error Issue</span>
<span class="cm">		 * Enhance line driver power</span>
<span class="cm">		 */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x5561</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8332</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x5561</span> <span class="p">},</span>

		<span class="cm">/*</span>
<span class="cm">		 * Can not link to 1Gbps with bad cable</span>
<span class="cm">		 * Decrease SNR threshold form 21.07dB to 19.04dB</span>
<span class="cm">		 */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xf880</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init_0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init_0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8168d_efuse_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x669a</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8330</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x669a</span> <span class="p">},</span>

			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">}</span>
		<span class="p">};</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x006c</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">set</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="mh">0x0065</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x0067</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span>
				<span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x006b</span><span class="p">,</span> <span class="mh">0x006c</span>
			<span class="p">};</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xff00</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">set</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">set</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x2642</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8330</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x2642</span> <span class="p">}</span>
		<span class="p">};</span>

		<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Fine tune PLL performance */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0600</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xe000</span><span class="p">);</span>

	<span class="cm">/* Switching regulator Slew rate */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">);</span>

	<span class="n">rtl_apply_firmware_cond</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_EXPANSION</span><span class="p">,</span> <span class="mh">0xb300</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168d_3_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0008</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x006c</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xf880</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xa4d8</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x281c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x2883</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x6b35</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x3da4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xeffd</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7f52</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7fc6</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0601</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x4063</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xf074</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x0789</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xf4bd</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x04fd</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x84b0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9200</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0340</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x4000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x1d21</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c32</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0200</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5554</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x4800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x4000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xdf01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdf20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x101a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0ff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf800</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xf000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0023</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168d_4_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0cc0</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x002d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0040</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168e_1_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Enable Delay cap */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b80</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xc896</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Channel estimation fine tune */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x6c20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x2872</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xefff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x6420</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Update PFM &amp; 10M TX idle timer */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x002f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x1919</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00ac</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0006</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="cm">/* DCO enable for 10M IDLE Power */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* For impedance matching */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x7f00</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* PHY auto speed down */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b86</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x1100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5a00</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x4007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168e_2_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Enable Delay cap */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0004</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00ac</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0006</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Channel estimation fine tune */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xa20f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Green Setting */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b5b</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x9222</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b6d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x8000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b76</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x8000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="cm">/* For 4-corner performance improve */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b80</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* PHY auto speed down */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* improve 10M EEE waveform */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b86</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Improve 2-pair detection performance */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* EEE setting */</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="mh">0x1b0</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span>
		     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x4007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Green feature */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168f_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For 4-corner performance improve */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b80</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* PHY auto speed down */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Improve 10M EEE waveform */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b86</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168f_1_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Channel estimation fine tune */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xa20f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Modify green table for giga &amp; fnet */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b55</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b5e</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b67</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b70</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0078</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00fb</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Modify green table for 10M */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b79</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xaa00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Disable hiimpedance detection (RTCT) */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x328a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="n">rtl8168f_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Improve 2-pair detection performance */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8168f_2_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8168f_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8411_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Channel estimation fine tune */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xa20f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Modify green table for giga &amp; fnet */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b55</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b5e</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b67</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b70</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0078</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x00aa</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Modify green table for 10M */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b79</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xaa00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="cm">/* Disable hiimpedance detection (RTCT) */</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x328a</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>


	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8168f_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Improve 2-pair detection performance */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>

	<span class="cm">/* Modify green table for giga */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b54</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b5d</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8a7c</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8a7f</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8a82</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8a85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8a88</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* uc same-seed solution */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* eee setting */</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1b0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b85</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x4007</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Green feature */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">rtl_w1w0_phy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8102e_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0003</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x441d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x9100</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">rtl_patchphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8105e_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">phy_reg</span> <span class="n">phy_reg_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0004</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>

		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x7701</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="cm">/* Disable ALDPS before ram code */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0310</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_writephy_batch</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">phy_reg_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy_reg_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8402_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="cm">/* Disable ALDPS before setting firmware */</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0310</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">rtl_apply_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* EEE setting */</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1b0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x401f</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x7030</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_phy_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8169_print_mac_version</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_01</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_02</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_03</span>:
		<span class="n">rtl8169s_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_04</span>:
		<span class="n">rtl8169sb_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_05</span>:
		<span class="n">rtl8169scd_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_06</span>:
		<span class="n">rtl8169sce_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_07</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_08</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_09</span>:
		<span class="n">rtl8102e_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
		<span class="n">rtl8168bb_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
		<span class="n">rtl8168bef_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">rtl8168bef_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>:
		<span class="n">rtl8168cp_1_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
		<span class="n">rtl8168c_1_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
		<span class="n">rtl8168c_2_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>:
		<span class="n">rtl8168c_3_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
		<span class="n">rtl8168c_4_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
		<span class="n">rtl8168cp_2_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
		<span class="n">rtl8168d_1_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
		<span class="n">rtl8168d_2_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
		<span class="n">rtl8168d_3_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
		<span class="n">rtl8168d_4_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_29</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_30</span>:
		<span class="n">rtl8105e_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
		<span class="cm">/* None. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
		<span class="n">rtl8168e_1_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_34</span>:
		<span class="n">rtl8168e_2_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_35</span>:
		<span class="n">rtl8168f_1_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_36</span>:
		<span class="n">rtl8168f_2_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_37</span>:
		<span class="n">rtl8402_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_38</span>:
		<span class="n">rtl8411_hw_phy_config</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_phy_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">RTL8169_PHY_TIMEOUT</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&gt;</span> <span class="n">RTL_GIGA_MAC_VER_01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_pending</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * A busy loop could burn quite a few cycles on nowadays CPU.</span>
<span class="cm">		 * Let&#39;s delay the execution of the timer for a few ticks.</span>
<span class="cm">		 */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mod_timer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_ok</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netif_warn</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY reset until link up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

<span class="nl">out_mod_timer:</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_schedule_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rtl_flag</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_phy_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">__opaque</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_schedule_task</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_FLAG_TASK_PHY_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_release_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_clear_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_pending</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl_tbi_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_01</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">PHYstatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TBI_Enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_init_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rtl_hw_phy_config</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&lt;=</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Set MAC Reg C+CR Offset 0x82h = 0x01h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&lt;=</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Set MAC Reg C+CR Offset 0x82h = 0x01h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Set PHY Reg 0x0bh = 0x00h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span> <span class="c1">//w 0x0b 15 0 0</span>
	<span class="p">}</span>

	<span class="n">rtl8169_phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8169_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AUTONEG_ENABLE</span><span class="p">,</span> <span class="n">SPEED_1000</span><span class="p">,</span> <span class="n">DUPLEX_FULL</span><span class="p">,</span>
			  <span class="n">ADVERTISED_10baseT_Half</span> <span class="o">|</span> <span class="n">ADVERTISED_10baseT_Full</span> <span class="o">|</span>
			  <span class="n">ADVERTISED_100baseT_Half</span> <span class="o">|</span> <span class="n">ADVERTISED_100baseT_Full</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">supports_gmii</span> <span class="o">?</span>
			   <span class="n">ADVERTISED_1000baseT_Half</span> <span class="o">|</span>
			   <span class="n">ADVERTISED_1000baseT_Full</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_tbi_enabled</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TBI auto-negotiating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_rar_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">high</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>

	<span class="n">low</span>  <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">high</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MAC4</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="n">RTL_R32</span><span class="p">(</span><span class="n">MAC4</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MAC0</span><span class="p">,</span> <span class="n">low</span><span class="p">);</span>
	<span class="n">RTL_R32</span><span class="p">(</span><span class="n">MAC0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_34</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">exgmac_reg</span> <span class="n">e</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">low</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">high</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">low</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
								<span class="n">low</span>  <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="p">},</span>
		<span class="p">};</span>

		<span class="n">rtl_write_exgmac_batch</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">rtl_rar_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">do_ioctl</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_xmii_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="cm">/* Internal PHY */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">rtl_readphy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_tbi_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_disable_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">RTL_FEATURE_MSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RTL_FEATURE_MSI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">rtl_init_mdio_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mdio_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mdio_ops</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">r8168dp_1_mdio_write</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">r8168dp_1_mdio_read</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">r8168dp_2_mdio_write</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">r8168dp_2_mdio_read</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">r8169_mdio_write</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">r8169_mdio_read</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_wol_suspend_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_29</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_30</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_34</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_37</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_38</span>:
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rtl_wol_pll_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__rtl8169_get_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WAKE_ANY</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rtl_wol_suspend_quirk</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r810x_phy_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_PDOWN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r810x_phy_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r810x_pll_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_wol_pll_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r810x_phy_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_07</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_08</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_09</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_10</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_13</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_16</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r810x_pll_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">r810x_phy_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_07</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_08</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_09</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_10</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_13</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_16</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168_phy_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_ANENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168_phy_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_PDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">rtl_writephy</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_PDOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168_pll_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_27</span> <span class="o">||</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_28</span> <span class="o">||</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">r8168dp_check_dash</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_23</span> <span class="o">||</span>
	     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_24</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ASF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_32</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_33</span><span class="p">)</span>
		<span class="n">rtl_ephy_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xff64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_wol_pll_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r8168_phy_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168_pll_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">PMCH</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r8168_phy_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_generic_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">op</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span>
		<span class="n">op</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pll_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_generic_op</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pll_power_ops</span><span class="p">.</span><span class="n">down</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_pll_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_generic_op</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pll_power_ops</span><span class="p">.</span><span class="n">up</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">rtl_init_pll_power_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pll_power_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pll_power_ops</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_07</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_08</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_09</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_10</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_16</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_29</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_30</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_37</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">down</span>	<span class="o">=</span> <span class="n">r810x_pll_power_down</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">up</span>		<span class="o">=</span> <span class="n">r810x_pll_power_up</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_34</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_35</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_36</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_38</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">down</span>	<span class="o">=</span> <span class="n">r8168_pll_power_down</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">up</span>		<span class="o">=</span> <span class="n">r8168_pll_power_up</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">down</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">up</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_init_rxcfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_01</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_02</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_03</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_04</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_05</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_06</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_10</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_13</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_14</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_15</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_16</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">RX_FIFO_THRESH</span> <span class="o">|</span> <span class="n">RX_DMA_BURST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_34</span>:
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">RX128_INT_EN</span> <span class="o">|</span> <span class="n">RX_MULTI_EN</span> <span class="o">|</span> <span class="n">RX_DMA_BURST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">RX128_INT_EN</span> <span class="o">|</span> <span class="n">RX_DMA_BURST</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_init_ring_indexes</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_jumbo_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="n">rtl_generic_op</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">jumbo_ops</span><span class="p">.</span><span class="n">enable</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_jumbo_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="n">rtl_generic_op</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">jumbo_ops</span><span class="p">.</span><span class="n">disable</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168c_hw_jumbo_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">|</span> <span class="n">Jumbo_En0</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">|</span> <span class="n">Jumbo_En1</span><span class="p">);</span>
	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168c_hw_jumbo_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Jumbo_En0</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Jumbo_En1</span><span class="p">);</span>
	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_hw_jumbo_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">|</span> <span class="n">Jumbo_En0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168dp_hw_jumbo_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Jumbo_En0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168e_hw_jumbo_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">|</span> <span class="n">Jumbo_En0</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168e_hw_jumbo_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Jumbo_En0</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>
	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168b_0_hw_jumbo_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168b_0_hw_jumbo_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168b_1_hw_jumbo_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">r8168b_0_hw_jumbo_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8168b_1_hw_jumbo_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">r8168b_0_hw_jumbo_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">rtl_init_jumbo_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">jumbo_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">jumbo_ops</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">r8168b_0_hw_jumbo_disable</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span>	<span class="o">=</span> <span class="n">r8168b_0_hw_jumbo_enable</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">r8168b_1_hw_jumbo_disable</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span>	<span class="o">=</span> <span class="n">r8168b_1_hw_jumbo_enable</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>: <span class="cm">/* Wild guess. Needs info from Realtek. */</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>: <span class="cm">/* Wild guess. Needs info from Realtek. */</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">r8168c_hw_jumbo_disable</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span>	<span class="o">=</span> <span class="n">r8168c_hw_jumbo_enable</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">r8168dp_hw_jumbo_disable</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span>	<span class="o">=</span> <span class="n">r8168dp_hw_jumbo_enable</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>: <span class="cm">/* Wild guess. Needs info from Realtek. */</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_34</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span>	<span class="o">=</span> <span class="n">r8168e_hw_jumbo_disable</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span>	<span class="o">=</span> <span class="n">r8168e_hw_jumbo_enable</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No action needed for jumbo frames with 8169.</span>
<span class="cm">	 * No jumbo for 810x at all.</span>
<span class="cm">	 */</span>
	<span class="nl">default:</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Soft reset the chip. */</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdReset</span><span class="p">);</span>

	<span class="cm">/* Check that the chip has finished the reset. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CmdReset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_request_uncached_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl_fw</span> <span class="o">*</span><span class="n">rtl_fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">rtl_lookup_firmware_name</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_firmware</span><span class="p">;</span>

	<span class="n">rtl_fw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rtl_fw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtl_fw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_warn</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">rtl_check_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rtl_fw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_firmware</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span> <span class="o">=</span> <span class="n">rtl_fw</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_release_firmware:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">rtl_fw</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rtl_fw</span><span class="p">);</span>
<span class="nl">err_warn:</span>
	<span class="n">netif_warn</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to load firmware patch %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="nl">out_no_firmware:</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span><span class="p">))</span>
		<span class="n">rtl_request_uncached_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_rx_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX_CONFIG_ACCEPT_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">rtl8169_irq_mask_and_ack</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_rx_close</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_27</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_28</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">TxPoll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NPQ</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_34</span> <span class="o">||</span>
	           <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_35</span> <span class="o">||</span>
	           <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_36</span> <span class="o">||</span>
	           <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_37</span> <span class="o">||</span>
	           <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_38</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">)</span> <span class="o">|</span> <span class="n">StopReq</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXCFG_EMPTY</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">)</span> <span class="o">|</span> <span class="n">StopReq</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtl_hw_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_set_rx_tx_config_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="cm">/* Set DMA burst size and Interframe Gap Time */</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="p">(</span><span class="n">TX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">TxDMAShift</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">InterFrameGap</span> <span class="o">&lt;&lt;</span> <span class="n">TxInterFrameGapShift</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_irq_enable_all</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_set_rx_tx_desc_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Magic spell: some iop3xx ARM board needs the TxDescAddrHigh</span>
<span class="cm">	 * register to be written before TxDescAddrLow to work.</span>
<span class="cm">	 * Switching from MMIO to I/O access fixes the issue as well.</span>
<span class="cm">	 */</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxDescStartAddrHigh</span><span class="p">,</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxPhyAddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxDescStartAddrLow</span><span class="p">,</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxPhyAddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxDescAddrHigh</span><span class="p">,</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxPhyAddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxDescAddrLow</span><span class="p">,</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxPhyAddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">rtl_rw_cpluscmd</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">);</span>
	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_set_rx_max_size</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_buf_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Low hurts. Let&#39;s disable the filtering. */</span>
	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">RxMaxSize</span><span class="p">,</span> <span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_set_magic_reg</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mac_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_cfg2_info</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mac_version</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">clk</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cfg2_info</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">,</span> <span class="n">PCI_Clock_33MHz</span><span class="p">,</span> <span class="mh">0x000fff00</span> <span class="p">},</span> <span class="c1">// 8110SCd</span>
		<span class="p">{</span> <span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">,</span> <span class="n">PCI_Clock_66MHz</span><span class="p">,</span> <span class="mh">0x000fffff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">,</span> <span class="n">PCI_Clock_33MHz</span><span class="p">,</span> <span class="mh">0x00ffff00</span> <span class="p">},</span> <span class="c1">// 8110SCe</span>
		<span class="p">{</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">,</span> <span class="n">PCI_Clock_66MHz</span><span class="p">,</span> <span class="mh">0x00ffffff</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_cfg2_info</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cfg2_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clk</span><span class="p">;</span>

	<span class="n">clk</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI_Clock_66MHz</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cfg2_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">mac_version</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">==</span> <span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTL_W32</span><span class="p">(</span><span class="mh">0x7c</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Multicast hash filter */</span>
	<span class="kt">int</span> <span class="n">rx_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unconditionally log net taps. */</span>
		<span class="n">netif_notice</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Promiscuous mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_mode</span> <span class="o">=</span>
		    <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span> <span class="o">|</span>
		    <span class="n">AcceptAllPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">multicast_filter_limit</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too many to filter perfectly -- accept all multicasts. */</span>
		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMulticast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

		<span class="n">rx_mode</span> <span class="o">=</span> <span class="n">AcceptBroadcast</span> <span class="o">|</span> <span class="n">AcceptMyPhys</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bit_nr</span> <span class="o">=</span> <span class="n">ether_crc</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
			<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit_nr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_nr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
			<span class="n">rx_mode</span> <span class="o">|=</span> <span class="n">AcceptMulticast</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span>
		<span class="n">rx_mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AcceptErr</span> <span class="o">|</span> <span class="n">AcceptRunt</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RX_CONFIG_ACCEPT_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">rx_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&gt;</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MAR0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MAR0</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxConfig</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8169</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCIMulRW</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_01</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_02</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_03</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_04</span><span class="p">)</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdTxEnb</span> <span class="o">|</span> <span class="n">CmdRxEnb</span><span class="p">);</span>

	<span class="n">rtl_init_rxcfg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">EarlyTxThres</span><span class="p">,</span> <span class="n">NoEarlyTx</span><span class="p">);</span>

	<span class="n">rtl_set_rx_max_size</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_01</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_02</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_03</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_04</span><span class="p">)</span>
		<span class="n">rtl_set_rx_tx_config_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="n">rtl_rw_cpluscmd</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCIMulRW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_02</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_03</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Set MAC Reg C+CR Offset 0xE0. &quot;</span>
			<span class="s">&quot;Bit-3 and bit-14 MUST be 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span><span class="p">);</span>

	<span class="n">rtl8169_set_magic_reg</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Undocumented corner. Supposedly:</span>
<span class="cm">	 * (TxTimer &lt;&lt; 12) | (TxPackets &lt;&lt; 8) | (RxTimer &lt;&lt; 4) | RxPackets</span>
<span class="cm">	 */</span>
	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">IntrMitigate</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rtl_set_rx_tx_desc_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">!=</span> <span class="n">RTL_GIGA_MAC_VER_01</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">!=</span> <span class="n">RTL_GIGA_MAC_VER_02</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">!=</span> <span class="n">RTL_GIGA_MAC_VER_03</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">!=</span> <span class="n">RTL_GIGA_MAC_VER_04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdTxEnb</span> <span class="o">|</span> <span class="n">CmdRxEnb</span><span class="p">);</span>
		<span class="n">rtl_set_rx_tx_config_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="cm">/* Initially a 10 us delay. Turned it into a PCI commit. - FR */</span>
	<span class="n">RTL_R8</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtl_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* no early-rx interrupts */</span>
	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">MultiIntr</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">MultiIntr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_csi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">csi_ops</span><span class="p">.</span><span class="n">write</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">csi_ops</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">rtl_csi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">csi_ops</span><span class="p">.</span><span class="n">read</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">csi_ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_csi_access_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csi</span><span class="p">;</span>

	<span class="n">csi</span> <span class="o">=</span> <span class="n">rtl_csi_read</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x070c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
	<span class="n">rtl_csi_write</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x070c</span><span class="p">,</span> <span class="n">csi</span> <span class="o">|</span> <span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_csi_access_enable_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_csi_access_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x17000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_csi_access_enable_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_csi_access_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0x27000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8169_csi_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CSIDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">,</span> <span class="n">CSIAR_WRITE_CMD</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">CSIAR_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">CSIAR_BYTE_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="n">CSIAR_BYTE_ENABLE_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSIAR_FLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">r8169_csi_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">CSIAR_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">CSIAR_BYTE_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="n">CSIAR_BYTE_ENABLE_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSIAR_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">CSIDR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r8402_csi_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CSIDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">,</span> <span class="n">CSIAR_WRITE_CMD</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">CSIAR_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">CSIAR_BYTE_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="n">CSIAR_BYTE_ENABLE_SHIFT</span> <span class="o">|</span>
		<span class="n">CSIAR_FUNC_NIC</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSIAR_FLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">r8402_csi_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">CSIAR_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">CSIAR_FUNC_NIC</span> <span class="o">|</span>
		<span class="n">CSIAR_BYTE_ENABLE</span> <span class="o">&lt;&lt;</span> <span class="n">CSIAR_BYTE_ENABLE_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">CSIAR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSIAR_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">CSIDR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">rtl_init_csi_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">csi_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">csi_ops</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_01</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_02</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_03</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_04</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_05</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_06</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_10</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_13</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_14</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_15</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_16</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_37</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_38</span>:
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">r8402_csi_write</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">r8402_csi_read</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span>	<span class="o">=</span> <span class="n">r8169_csi_write</span><span class="p">;</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span>	<span class="o">=</span> <span class="n">r8169_csi_read</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ephy_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_ephy_init</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtl_ephy_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span>
		<span class="n">rtl_ephy_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
		<span class="n">e</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_disable_clock_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_EXP_LNKCTL_CLKREQ_EN</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_enable_clock_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>

		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">PCI_EXP_LNKCTL_CLKREQ_EN</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_LNKCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define R8168_CPCMD_QUIRK_MASK (\</span>
<span class="cp">	EnableBist | \</span>
<span class="cp">	Mac_dbgo_oe | \</span>
<span class="cp">	Force_half_dup | \</span>
<span class="cp">	Force_rxflow_en | \</span>
<span class="cp">	Force_txflow_en | \</span>
<span class="cp">	Cxpl_dbg_sel | \</span>
<span class="cp">	ASF | \</span>
<span class="cp">	PktCntrDisable | \</span>
<span class="cp">	Mac_dbgo_sel)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168bb</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Beacon_en</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">R8168_CPCMD_QUIRK_MASK</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168bef</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rtl_hw_start_8168bb</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config4</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rtl_hw_start_8168cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config1</span><span class="p">)</span> <span class="o">|</span> <span class="n">Speed_down</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Beacon_en</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">rtl_disable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">R8168_CPCMD_QUIRK_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168cp_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168cp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span>	<span class="mh">0x1000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="mh">0x0042</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">,</span>	<span class="mh">0x0000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="mh">0x2000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168cp</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168cp</span><span class="p">));</span>

	<span class="n">__rtl_hw_start_8168cp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168cp_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Beacon_en</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">R8168_CPCMD_QUIRK_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168cp_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Beacon_en</span><span class="p">);</span>

	<span class="cm">/* Magic. */</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">DBG_REG</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">R8168_CPCMD_QUIRK_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168c_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168c_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span>	<span class="mh">0x1000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">,</span>	<span class="mh">0x0000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">DBG_REG</span><span class="p">,</span> <span class="mh">0x06</span> <span class="o">|</span> <span class="n">FIX_NAK_1</span> <span class="o">|</span> <span class="n">FIX_NAK_2</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168c_1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168c_1</span><span class="p">));</span>

	<span class="n">__rtl_hw_start_8168cp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168c_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168c_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">,</span>	<span class="mh">0x0220</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168c_2</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168c_2</span><span class="p">));</span>

	<span class="n">__rtl_hw_start_8168cp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168c_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_hw_start_8168c_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168c_4</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">__rtl_hw_start_8168cp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168d</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_disable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">R8168_CPCMD_QUIRK_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168dp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">rtl_disable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168d_4</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168d_4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>	<span class="mh">0x48</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="mh">0x50</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span>	<span class="mh">0x20</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168d_4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">e_info_8168d_4</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">w</span><span class="p">;</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">rtl_ephy_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">rtl_ephy_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtl_enable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168e_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168e_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">,</span>	<span class="mh">0x0100</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0004</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span>	<span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0030</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x2000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0020</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x5800</span><span class="p">,</span>	<span class="mh">0x2000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span>	<span class="mh">0x1000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x4000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x2000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>	<span class="mh">0xfe6c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0040</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168e_1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168e_1</span><span class="p">));</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">rtl_disable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Reset tx FIFO pointer */</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MISC</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">MISC</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXPLA_RST</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MISC</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">MISC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TXPLA_RST</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config5</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Spi_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168e_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168e_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0080</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0224</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_csi_access_enable_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168e_2</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168e_2</span><span class="p">));</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00100002</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00100006</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00000050</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x07ff0060</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1b0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x0d4</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0c00</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">,</span>
		     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">EarlySize</span><span class="p">);</span>

	<span class="n">rtl_disable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXCFG_AUTO_FIFO</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MCU</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">MCU</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NOW_IS_OOB</span><span class="p">);</span>

	<span class="cm">/* Adjust EEE LED frequency */</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">EEE_LED</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">EEE_LED</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">DLLPR</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">DLLPR</span><span class="p">)</span> <span class="o">|</span> <span class="n">PFM_EN</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MISC</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">MISC</span><span class="p">)</span> <span class="o">|</span> <span class="n">PWM_EN</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config5</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Spi_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168f</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00100002</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00100006</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1b0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1d0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00000050</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00000060</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">EarlySize</span><span class="p">);</span>

	<span class="n">rtl_disable_clock_request</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXCFG_AUTO_FIFO</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MCU</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">MCU</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NOW_IS_OOB</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">DLLPR</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">DLLPR</span><span class="p">)</span> <span class="o">|</span> <span class="n">PFM_EN</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">MISC</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">MISC</span><span class="p">)</span> <span class="o">|</span> <span class="n">PWM_EN</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config5</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Spi_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168f_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168f_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00c0</span><span class="p">,</span>	<span class="mh">0x0020</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span>	<span class="mh">0x0002</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0080</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0224</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_hw_start_8168f</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168f_1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168f_1</span><span class="p">));</span>

	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x0d4</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0c00</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">,</span>
		     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>

	<span class="cm">/* Adjust EEE LED frequency */</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">EEE_LED</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">EEE_LED</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8411</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8168f_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00c0</span><span class="p">,</span>	<span class="mh">0x0020</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>	<span class="mh">0x5200</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x4000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>	<span class="mh">0x0224</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_hw_start_8168f</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8168f_1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8168f_1</span><span class="p">));</span>

	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x0d4</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0c00</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8168</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">rtl_set_rx_max_size</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">)</span> <span class="o">|</span> <span class="n">PktCntrDisable</span> <span class="o">|</span> <span class="n">INTT_1</span><span class="p">;</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">IntrMitigate</span><span class="p">,</span> <span class="mh">0x5151</span><span class="p">);</span>

	<span class="cm">/* Work around for RxFIFO overflow. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span> <span class="o">|=</span> <span class="n">RxFIFOOver</span> <span class="o">|</span> <span class="n">PCSTimeout</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxOverflow</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl_set_rx_tx_desc_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">rtl_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="p">(</span><span class="n">TX_DMA_BURST</span> <span class="o">&lt;&lt;</span> <span class="n">TxDMAShift</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">InterFrameGap</span> <span class="o">&lt;&lt;</span> <span class="n">TxInterFrameGapShift</span><span class="p">));</span>

	<span class="n">RTL_R8</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
		<span class="n">rtl_hw_start_8168bb</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">rtl_hw_start_8168bef</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_18</span>:
		<span class="n">rtl_hw_start_8168cp_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_19</span>:
		<span class="n">rtl_hw_start_8168c_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_20</span>:
		<span class="n">rtl_hw_start_8168c_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_21</span>:
		<span class="n">rtl_hw_start_8168c_3</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_22</span>:
		<span class="n">rtl_hw_start_8168c_4</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_23</span>:
		<span class="n">rtl_hw_start_8168cp_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_24</span>:
		<span class="n">rtl_hw_start_8168cp_3</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_25</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_26</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_27</span>:
		<span class="n">rtl_hw_start_8168d</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_28</span>:
		<span class="n">rtl_hw_start_8168d_4</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_31</span>:
		<span class="n">rtl_hw_start_8168dp</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_32</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_33</span>:
		<span class="n">rtl_hw_start_8168e_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_34</span>:
		<span class="n">rtl_hw_start_8168e_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_35</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_36</span>:
		<span class="n">rtl_hw_start_8168f_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_38</span>:
		<span class="n">rtl_hw_start_8411</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;%s: unknown chipset (mac_version = %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdTxEnb</span> <span class="o">|</span> <span class="n">CmdRxEnb</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">MultiIntr</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">MultiIntr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define R810X_CPCMD_QUIRK_MASK (\</span>
<span class="cp">	EnableBist | \</span>
<span class="cp">	Mac_dbgo_oe | \</span>
<span class="cp">	Force_half_dup | \</span>
<span class="cp">	Force_rxflow_en | \</span>
<span class="cp">	Force_txflow_en | \</span>
<span class="cp">	Cxpl_dbg_sel | \</span>
<span class="cp">	ASF | \</span>
<span class="cp">	PktCntrDisable | \</span>
<span class="cp">	Mac_dbgo_sel)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8102e_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8102e_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x6e65</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x091f</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0xc2f9</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0xafb5</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0e00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0xec80</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x2e65</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x6e65</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">cfg1</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">DBG_REG</span><span class="p">,</span> <span class="n">FIX_NAK_1</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config1</span><span class="p">,</span>
	       <span class="n">LEDS1</span> <span class="o">|</span> <span class="n">LEDS0</span> <span class="o">|</span> <span class="n">Speed_down</span> <span class="o">|</span> <span class="n">MEMMAP</span> <span class="o">|</span> <span class="n">IOMAP</span> <span class="o">|</span> <span class="n">VPD</span> <span class="o">|</span> <span class="n">PMEnable</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Beacon_en</span><span class="p">);</span>

	<span class="n">cfg1</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cfg1</span> <span class="o">&amp;</span> <span class="n">LEDS0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cfg1</span> <span class="o">&amp;</span> <span class="n">LEDS1</span><span class="p">))</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">cfg1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LEDS0</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8102e_1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8102e_1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8102e_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">MEMMAP</span> <span class="o">|</span> <span class="n">IOMAP</span> <span class="o">|</span> <span class="n">VPD</span> <span class="o">|</span> <span class="n">PMEnable</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config3</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Beacon_en</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8102e_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl_hw_start_8102e_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ephy_write</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xc2f9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8105e_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8105e_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x4000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0200</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0020</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x2000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0001</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0100</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0004</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x0020</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="cm">/* Force LAN exit from ASPM if Rx/Tx are not idle */</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">FuncEvent</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">FuncEvent</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x002800</span><span class="p">);</span>

	<span class="cm">/* Disable Early Tally Counter */</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">FuncEvent</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">FuncEvent</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x010000</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MCU</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">MCU</span><span class="p">)</span> <span class="o">|</span> <span class="n">EN_NDP</span> <span class="o">|</span> <span class="n">EN_OOB_RESET</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">DLLPR</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">DLLPR</span><span class="p">)</span> <span class="o">|</span> <span class="n">PFM_EN</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8105e_1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8105e_1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8105e_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">rtl_hw_start_8105e_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl_ephy_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">rtl_ephy_read</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8402</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ephy_info</span> <span class="n">e_info_8402</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span>	<span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xff64</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span> <span class="mh">0x4000</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">rtl_csi_access_enable_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="cm">/* Force LAN exit from ASPM if Rx/Tx are not idle */</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">FuncEvent</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">FuncEvent</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x002800</span><span class="p">);</span>

	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">,</span> <span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">|</span> <span class="n">TXCFG_AUTO_FIFO</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MCU</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">MCU</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NOW_IS_OOB</span><span class="p">);</span>

	<span class="n">rtl_ephy_init</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">e_info_8402</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">e_info_8402</span><span class="p">));</span>

	<span class="n">rtl_tx_performance_tweak</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="n">MAX_READ_REQUEST_SHIFT</span><span class="p">);</span>

	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="n">ERIAR_MASK_1111</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="n">ERIAR_MASK_0001</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_eri_write</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
	<span class="n">rtl_w1w0_eri</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mh">0x0d4</span><span class="p">,</span> <span class="n">ERIAR_MASK_0011</span><span class="p">,</span> <span class="mh">0x0e00</span><span class="p">,</span> <span class="mh">0xff00</span><span class="p">,</span>
		     <span class="n">ERIAR_EXGMAC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_hw_start_8101</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&gt;=</span> <span class="n">RTL_GIGA_MAC_VER_30</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxFIFOOver</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_13</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">pci_pcie_cap</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cap</span> <span class="o">+</span> <span class="n">PCI_EXP_DEVCTL</span><span class="p">,</span>
					      <span class="n">PCI_EXP_DEVCTL_NOSNOOP_EN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_07</span>:
		<span class="n">rtl_hw_start_8102e_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_08</span>:
		<span class="n">rtl_hw_start_8102e_3</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_09</span>:
		<span class="n">rtl_hw_start_8102e_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_29</span>:
		<span class="n">rtl_hw_start_8105e_1</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_30</span>:
		<span class="n">rtl_hw_start_8105e_2</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_37</span>:
		<span class="n">rtl_hw_start_8402</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">MaxTxPacketSize</span><span class="p">,</span> <span class="n">TxPacketMax</span><span class="p">);</span>

	<span class="n">rtl_set_rx_max_size</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R810X_CPCMD_QUIRK_MASK</span><span class="p">;</span>
	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">IntrMitigate</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rtl_set_rx_tx_desc_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdTxEnb</span> <span class="o">|</span> <span class="n">CmdRxEnb</span><span class="p">);</span>
	<span class="n">rtl_set_rx_tx_config_registers</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">RTL_R8</span><span class="p">(</span><span class="n">IntrMask</span><span class="p">);</span>

	<span class="n">rtl_set_rx_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">RTL_W16</span><span class="p">(</span><span class="n">MultiIntr</span><span class="p">,</span> <span class="n">RTL_R16</span><span class="p">(</span><span class="n">MultiIntr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span> <span class="o">||</span>
	    <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">].</span><span class="n">jumbo_max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="n">rtl_hw_jumbo_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rtl_hw_jumbo_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="n">netdev_update_features</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8169_make_unusable_by_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="mh">0x0badbadbadbadbadull</span><span class="p">);</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DescOwn</span> <span class="o">|</span> <span class="n">RsvdMask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_free_rx_databuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">**</span><span class="n">data_buff</span><span class="p">,</span> <span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="n">rx_buf_sz</span><span class="p">,</span>
			 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">data_buff</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rtl8169_make_unusable_by_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8169_mark_to_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_buf_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eor</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RingEnd</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DescOwn</span> <span class="o">|</span> <span class="n">eor</span> <span class="o">|</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8169_map_to_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">rx_buf_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rtl8169_mark_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rtl8169_align</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtl8169_alloc_rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">node</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">?</span> <span class="n">dev_to_node</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc_node</span><span class="p">(</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl8169_align</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc_node</span><span class="p">(</span><span class="n">rx_buf_sz</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">rtl8169_align</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">rx_buf_sz</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map RX DMA!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl8169_map_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_rx_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_databuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rtl8169_free_rx_databuff</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_databuff</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8169_mark_as_last_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RingEnd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_rx_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_databuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">rtl8169_alloc_rx_data</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl8169_make_unusable_by_asic</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_databuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl8169_mark_as_last_descriptor</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">+</span> <span class="n">NUM_RX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">rtl8169_rx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8169_init_ring_indexes</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">NUM_TX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_databuff</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">NUM_RX_DESC</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rtl8169_rx_fill</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_unmap_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">tx_skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_tx_clear_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">rtl8169_unmap_tx_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">,</span>
					     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_tx_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtl8169_tx_clear_range</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">,</span> <span class="n">NUM_TX_DESC</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_reset_queue</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">synchronize_sched</span><span class="p">();</span>

	<span class="n">rtl8169_hw_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rtl8169_mark_to_asic</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>

	<span class="n">rtl8169_tx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl8169_init_ring_indexes</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">rtl_hw_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl8169_check_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_schedule_task</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_xmit_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">skb_shared_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_frag</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">txd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cur_frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cur_frag</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">cur_frag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">+</span> <span class="n">cur_frag</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>

		<span class="n">txd</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">skb_frag_address</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="s">&quot;Failed to map TX fragments DMA!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Anti gcc 2.95.3 bugware (sic) */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">len</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">RingEnd</span> <span class="o">*</span> <span class="o">!</span><span class="p">((</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">));</span>

		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">opts2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">opts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>

		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_frag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">txd</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">LastFrag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cur_frag</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">rtl8169_tx_clear_range</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_frag</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8169_tso_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_tx_desc_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">tx_desc_info</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">txd_version</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">opts_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TD_LSO</span><span class="p">;</span>
		<span class="n">opts</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">|=</span> <span class="n">min</span><span class="p">(</span><span class="n">mss</span><span class="p">,</span> <span class="n">TD_MSS_MAX</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mss_shift</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_TCP</span><span class="p">)</span>
			<span class="n">opts</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">|=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">.</span><span class="n">tcp</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">IPPROTO_UDP</span><span class="p">)</span>
			<span class="n">opts</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">|=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">.</span><span class="n">udp</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">rtl8169_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxDesc</span> <span class="o">*</span><span class="n">txd</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">frags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">TX_FRAGS_READY_FOR</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BUG! Tx Ring full when queue awake!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_stop_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txd</span><span class="o">-&gt;</span><span class="n">opts1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DescOwn</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_stop_0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map TX DMA!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_dma_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>

	<span class="n">opts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rtl8169_tx_vlan_tag</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb</span><span class="p">));</span>
	<span class="n">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">DescOwn</span><span class="p">;</span>

	<span class="n">rtl8169_tso_csum</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>

	<span class="n">frags</span> <span class="o">=</span> <span class="n">rtl8169_xmit_frags</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frags</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dma_1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frags</span><span class="p">)</span>
		<span class="n">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">FirstFrag</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">FirstFrag</span> <span class="o">|</span> <span class="n">LastFrag</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">opts2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">opts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">netdev_sent_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* Anti gcc 2.95.3 bugware (sic) */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">len</span> <span class="o">|</span> <span class="p">(</span><span class="n">RingEnd</span> <span class="o">*</span> <span class="o">!</span><span class="p">((</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">));</span>
	<span class="n">txd</span><span class="o">-&gt;</span><span class="n">opts1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">+=</span> <span class="n">frags</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">TxPoll</span><span class="p">,</span> <span class="n">NPQ</span><span class="p">);</span>

	<span class="n">mmiowb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TX_FRAGS_READY_FOR</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Avoid wrongly optimistic queue wake-up: rtl_tx thread must</span>
<span class="cm">		 * not miss a ring update when it notices a stopped queue.</span>
<span class="cm">		 */</span>
		<span class="n">smp_wmb</span><span class="p">();</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* Sync with rtl_tx:</span>
<span class="cm">		 * - publish queue status and cur_tx ring index (write barrier)</span>
<span class="cm">		 * - refresh dirty_tx ring index (read barrier).</span>
<span class="cm">		 * May the current thread have a pessimistic view of the ring</span>
<span class="cm">		 * status and forget to wake up queue, a racing rtl_tx thread</span>
<span class="cm">		 * can&#39;t.</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TX_FRAGS_READY_FOR</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">))</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">err_dma_1:</span>
	<span class="n">rtl8169_unmap_tx_skb</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">+</span> <span class="n">entry</span><span class="p">,</span> <span class="n">txd</span><span class="p">);</span>
<span class="nl">err_dma_0:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">err_stop_0:</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_pcierr_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_status</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_status</span><span class="p">);</span>

	<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCI error (cmd = 0x%04x, status = 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">pci_cmd</span><span class="p">,</span> <span class="n">pci_status</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The recovery sequence below admits a very elaborated explanation:</span>
<span class="cm">	 * - it seems to work;</span>
<span class="cm">	 * - I did not see what else could be done;</span>
<span class="cm">	 * - it makes iop3xx happy.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Feel free to adjust to your needs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">broken_parity_status</span><span class="p">)</span>
		<span class="n">pci_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_PARITY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pci_cmd</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span><span class="p">;</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span>
		<span class="n">pci_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCI_STATUS_DETECTED_PARITY</span> <span class="o">|</span>
		<span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span> <span class="o">|</span> <span class="n">PCI_STATUS_REC_MASTER_ABORT</span> <span class="o">|</span>
		<span class="n">PCI_STATUS_REC_TARGET_ABORT</span> <span class="o">|</span> <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span><span class="p">));</span>

	<span class="cm">/* The infamous DAC f*ckup only happens at boot time */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">&amp;</span> <span class="n">PCIDAC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabling PCI DAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCIDAC</span><span class="p">;</span>
		<span class="n">RTL_W16</span><span class="p">(</span><span class="n">CPlusCmd</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtl8169_hw_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_schedule_task</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rtl_txc</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">packets</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_stats</span> <span class="o">*</span><span class="n">tx_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty_tx</span><span class="p">,</span> <span class="n">tx_left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl_txc</span> <span class="n">txc</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>
	<span class="n">smp_rmb</span><span class="p">();</span>
	<span class="n">tx_left</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">-</span> <span class="n">dirty_tx</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tx_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">dirty_tx</span> <span class="o">%</span> <span class="n">NUM_TX_DESC</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ring_info</span> <span class="o">*</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">opts1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DescOwn</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rtl8169_unmap_tx_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_skb</span><span class="p">,</span>
				     <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">+</span> <span class="n">entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LastFrag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>

			<span class="n">txc</span><span class="p">.</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">txc</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dirty_tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_left</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>
	<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">packets</span> <span class="o">+=</span> <span class="n">txc</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
	<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">txc</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">syncp</span><span class="p">);</span>

	<span class="n">netdev_completed_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txc</span><span class="p">.</span><span class="n">packets</span><span class="p">,</span> <span class="n">txc</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">!=</span> <span class="n">dirty_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">dirty_tx</span><span class="p">;</span>
		<span class="cm">/* Sync with rtl8169_start_xmit:</span>
<span class="cm">		 * - publish dirty_tx ring index (write barrier)</span>
<span class="cm">		 * - refresh cur_tx ring index and queue status (read barrier)</span>
<span class="cm">		 * May the current thread miss the stopped queue condition,</span>
<span class="cm">		 * a racing xmit thread can only have a right view of the</span>
<span class="cm">		 * ring status.</span>
<span class="cm">		 */</span>
		<span class="n">smp_mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">TX_FRAGS_READY_FOR</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">MAX_SKB_FRAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * 8168 hack: TxPoll requests are lost when the Tx packets are</span>
<span class="cm">		 * too close. Let&#39;s kick an extra TxPoll request when a burst</span>
<span class="cm">		 * of start_xmit activity is detected (if it is not detected,</span>
<span class="cm">		 * it is slow enough). -- FR</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="n">dirty_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

			<span class="n">RTL_W8</span><span class="p">(</span><span class="n">TxPoll</span><span class="p">,</span> <span class="n">NPQ</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rtl8169_fragmented_frame</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FirstFrag</span> <span class="o">|</span> <span class="n">LastFrag</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">FirstFrag</span> <span class="o">|</span> <span class="n">LastFrag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtl8169_rx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">opts1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">opts1</span> <span class="o">&amp;</span> <span class="n">RxProtoMask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">status</span> <span class="o">==</span> <span class="n">RxProtoTCP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">opts1</span> <span class="o">&amp;</span> <span class="n">TCPFail</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">RxProtoUDP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">opts1</span> <span class="o">&amp;</span> <span class="n">UDPFail</span><span class="p">)))</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">rtl8169_try_rx_copy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">pkt_size</span><span class="p">,</span>
					   <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">rtl8169_align</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">prefetch</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_rx</span><span class="p">,</span> <span class="n">rx_left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">cur_rx</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">rx_left</span> <span class="o">=</span> <span class="n">NUM_RX_DESC</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">-</span> <span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">rx_left</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rx_left</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">rx_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rx_left</span><span class="o">--</span><span class="p">,</span> <span class="n">cur_rx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">cur_rx</span> <span class="o">%</span> <span class="n">NUM_RX_DESC</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">RxDesc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">+</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">opts1_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DescOwn</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxRES</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">rx_err</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx ERROR. status = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">status</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxRWT</span> <span class="o">|</span> <span class="n">RxRUNT</span><span class="p">))</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxCRC</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxFOVF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtl_schedule_task</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxRUNT</span> <span class="o">|</span> <span class="n">RxCRC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RxRWT</span> <span class="o">|</span> <span class="n">RxFOVF</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">process_pkt</span><span class="p">;</span>

			<span class="n">rtl8169_mark_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">pkt_size</span><span class="p">;</span>

<span class="nl">process_pkt:</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXFCS</span><span class="p">)))</span>
				<span class="n">pkt_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x00003fff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pkt_size</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x00003fff</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * The driver does not support incoming fragmented</span>
<span class="cm">			 * frames. They are seen as a symptom of over-mtu</span>
<span class="cm">			 * sized frames.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rtl8169_fragmented_frame</span><span class="p">(</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rtl8169_mark_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">rtl8169_try_rx_copy</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">Rx_databuff</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span>
						  <span class="n">tp</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">rtl8169_mark_to_asic</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">rx_buf_sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rtl8169_rx_csum</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_size</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="n">rtl8169_rx_vlan_tag</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

			<span class="n">napi_gro_receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

			<span class="n">u64_stats_update_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">pkt_size</span><span class="p">;</span>
			<span class="n">u64_stats_update_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Work around for AMD plateform. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts2</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xfffe000</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">opts2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cur_rx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">cur_rx</span> <span class="o">-</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">cur_rx</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">rtl8169_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rtl_get_events</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">RTL_EVENT_NAPI</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">rtl_irq_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Workqueue context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_slow_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rtl_get_events</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">;</span>
	<span class="n">rtl_ack_events</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RxFIFOOver</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Work around for rx fifo overflow */</span>
		<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* XXX - Hack alert. See rtl_task(). */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SYSErr</span><span class="p">))</span>
		<span class="n">rtl8169_pcierr_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LinkChg</span><span class="p">)</span>
		<span class="n">__rtl8169_check_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">rtl_irq_enable_all</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bitnr</span><span class="p">;</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">rtl_work</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* XXX - keep rtl_slow_event_work() as first element. */</span>
		<span class="p">{</span> <span class="n">RTL_FLAG_TASK_SLOW_PENDING</span><span class="p">,</span>	<span class="n">rtl_slow_event_work</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">,</span>	<span class="n">rtl_reset_work</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">RTL_FLAG_TASK_PHY_PENDING</span><span class="p">,</span>	<span class="n">rtl_phy_work</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8169_private</span><span class="p">,</span> <span class="n">wk</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">RTL_FLAG_TASK_ENABLED</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rtl_work</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">pending</span><span class="p">;</span>

		<span class="n">pending</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">rtl_work</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitnr</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span>
			<span class="n">rtl_work</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">action</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtl8169_private</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">enable_mask</span> <span class="o">=</span> <span class="n">RTL_EVENT_NAPI</span> <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">work_done</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">rtl_get_events</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl_ack_events</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RTL_EVENT_NAPI_RX</span><span class="p">)</span>
		<span class="n">work_done</span> <span class="o">=</span> <span class="n">rtl_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">budget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RTL_EVENT_NAPI_TX</span><span class="p">)</span>
		<span class="n">rtl_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enable_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">;</span>

		<span class="n">rtl_schedule_task</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_FLAG_TASK_SLOW_PENDING</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>

		<span class="n">rtl_irq_enable</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">enable_mask</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_rx_missed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&gt;</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="p">(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">RxMissed</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">);</span>
	<span class="n">RTL_W32</span><span class="p">(</span><span class="n">RxMissed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8169_hw_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point device interrupts can not be enabled in any function,</span>
<span class="cm">	 * as netif_running is not true (rtl8169_interrupt, rtl8169_reset_task)</span>
<span class="cm">	 * and napi is disabled (rtl8169_poll).</span>
<span class="cm">	 */</span>
	<span class="n">rtl8169_rx_missed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="cm">/* Give a racing hard_start_xmit a few cycles to complete. */</span>
	<span class="n">synchronize_sched</span><span class="p">();</span>

	<span class="n">rtl8169_tx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8169_rx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_pll_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Update counters before going down */</span>
	<span class="n">rtl8169_update_counters</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RTL_FLAG_TASK_ENABLED</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rtl8169_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">R8169_RX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span><span class="p">,</span>
			  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxPhyAddr</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">R8169_TX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span><span class="p">,</span>
			  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxPhyAddr</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8169_interrupt</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rx and Tx descriptors needs 256 bytes alignment.</span>
<span class="cm">	 * dma_alloc_coherent provides more.</span>
<span class="cm">	 */</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">R8169_TX_RING_BYTES</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxPhyAddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pm_runtime_put</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">R8169_RX_RING_BYTES</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxPhyAddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_tx_0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtl8169_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_rx_1</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">rtl_task</span><span class="p">);</span>

	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="n">rtl_request_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rtl8169_interrupt</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">RTL_FEATURE_MSI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_release_fw_2</span><span class="p">;</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">RTL_FLAG_TASK_ENABLED</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">rtl8169_init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>

	<span class="n">__rtl8169_set_features</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">);</span>

	<span class="n">rtl_pll_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_hw_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8169_check_link_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

<span class="nl">err_release_fw_2:</span>
	<span class="n">rtl_release_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl8169_rx_clear</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="nl">err_free_rx_1:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">R8169_RX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span><span class="p">,</span>
			  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxPhyAddr</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">RxDescArray</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_free_tx_0:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">R8169_TX_RING_BYTES</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span><span class="p">,</span>
			  <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxPhyAddr</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_pm_runtime_put:</span>
	<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span>
<span class="nf">rtl8169_get_stats64</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">rtl8169_rx_missed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span>	<span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">rx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>


	<span class="k">do</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">u64_stats_fetch_begin_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">packets</span><span class="p">;</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span>	<span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">u64_stats_fetch_retry_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">.</span><span class="n">syncp</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl8169_net_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">RTL_FLAG_TASK_ENABLED</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_pll_power_down</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rtl8169_net_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__rtl8169_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_pll_power_up</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">RTL_FLAG_TASK_ENABLED</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_schedule_task</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">RTL_FLAG_TASK_RESET_PENDING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl8169_init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">__rtl8169_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_wolopts</span> <span class="o">=</span> <span class="n">__rtl8169_get_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">__rtl8169_set_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">WAKE_ANY</span><span class="p">);</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8169_net_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rtl_lock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">__rtl8169_set_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_wolopts</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">saved_wolopts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rtl_unlock_work</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8169_init_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>

	<span class="n">__rtl8169_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtl8169_runtime_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">TxDescArray</span> <span class="o">?</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">rtl8169_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">rtl8169_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">rtl8169_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">rtl8169_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">rtl8169_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poweroff</span>		<span class="o">=</span> <span class="n">rtl8169_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span>		<span class="o">=</span> <span class="n">rtl8169_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_suspend</span>	<span class="o">=</span> <span class="n">rtl8169_runtime_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span>		<span class="o">=</span> <span class="n">rtl8169_runtime_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_idle</span>		<span class="o">=</span> <span class="n">rtl8169_runtime_idle</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define RTL8169_PM_OPS	(&amp;rtl8169_pm_ops)</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define RTL8169_PM_OPS	NULL</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_wol_shutdown_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>

	<span class="cm">/* WoL fails with 8168b when the receiver is disabled. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_11</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_12</span>:
	<span class="k">case</span> <span class="n">RTL_GIGA_MAC_VER_17</span>:
		<span class="n">pci_clear_master</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>

		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">,</span> <span class="n">CmdRxEnb</span><span class="p">);</span>
		<span class="cm">/* PCI commit */</span>
		<span class="n">RTL_R8</span><span class="p">(</span><span class="n">ChipCmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtl_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">rtl8169_net_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Restore original MAC address */</span>
	<span class="n">rtl_rar_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>

	<span class="n">rtl8169_hw_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">system_state</span> <span class="o">==</span> <span class="n">SYSTEM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__rtl8169_get_wol</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WAKE_ANY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtl_wol_suspend_quirk</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
			<span class="n">rtl_wol_shutdown_quirk</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rtl_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_27</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_28</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl8168_driver_stop</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">rtl_release_firmware</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_run_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* restore original MAC address */</span>
	<span class="n">rtl_rar_set</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>

	<span class="n">rtl_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl8169_release_board</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rtl_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">rtl_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">rtl8169_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats64</span>	<span class="o">=</span> <span class="n">rtl8169_get_stats64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">rtl8169_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">rtl8169_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">rtl8169_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>	<span class="o">=</span> <span class="n">rtl8169_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">rtl8169_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">rtl_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">rtl8169_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">rtl_set_rx_mode</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">rtl8169_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_cfg_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hw_start</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">event_slow</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">default_ver</span><span class="p">;</span>
<span class="p">}</span> <span class="n">rtl_cfg_infos</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">RTL_CFG_0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hw_start</span>	<span class="o">=</span> <span class="n">rtl_hw_start_8169</span><span class="p">,</span>
		<span class="p">.</span><span class="n">region</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">align</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">event_slow</span>	<span class="o">=</span> <span class="n">SYSErr</span> <span class="o">|</span> <span class="n">LinkChg</span> <span class="o">|</span> <span class="n">RxOverflow</span> <span class="o">|</span> <span class="n">RxFIFOOver</span><span class="p">,</span>
		<span class="p">.</span><span class="n">features</span>	<span class="o">=</span> <span class="n">RTL_FEATURE_GMII</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_ver</span>	<span class="o">=</span> <span class="n">RTL_GIGA_MAC_VER_01</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RTL_CFG_1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hw_start</span>	<span class="o">=</span> <span class="n">rtl_hw_start_8168</span><span class="p">,</span>
		<span class="p">.</span><span class="n">region</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">align</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">event_slow</span>	<span class="o">=</span> <span class="n">SYSErr</span> <span class="o">|</span> <span class="n">LinkChg</span> <span class="o">|</span> <span class="n">RxOverflow</span><span class="p">,</span>
		<span class="p">.</span><span class="n">features</span>	<span class="o">=</span> <span class="n">RTL_FEATURE_GMII</span> <span class="o">|</span> <span class="n">RTL_FEATURE_MSI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_ver</span>	<span class="o">=</span> <span class="n">RTL_GIGA_MAC_VER_11</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">RTL_CFG_2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">hw_start</span>	<span class="o">=</span> <span class="n">rtl_hw_start_8101</span><span class="p">,</span>
		<span class="p">.</span><span class="n">region</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">align</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">event_slow</span>	<span class="o">=</span> <span class="n">SYSErr</span> <span class="o">|</span> <span class="n">LinkChg</span> <span class="o">|</span> <span class="n">RxOverflow</span> <span class="o">|</span> <span class="n">RxFIFOOver</span> <span class="o">|</span>
				  <span class="n">PCSTimeout</span><span class="p">,</span>
		<span class="p">.</span><span class="n">features</span>	<span class="o">=</span> <span class="n">RTL_FEATURE_MSI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_ver</span>	<span class="o">=</span> <span class="n">RTL_GIGA_MAC_VER_13</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Cfg9346_Unlock assumed. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">rtl_try_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_cfg_info</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">msi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfg2</span><span class="p">;</span>

	<span class="n">cfg2</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSIEnable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">RTL_FEATURE_MSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no MSI. Back to INTx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cfg2</span> <span class="o">|=</span> <span class="n">MSIEnable</span><span class="p">;</span>
			<span class="n">msi</span> <span class="o">=</span> <span class="n">RTL_FEATURE_MSI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">&lt;=</span> <span class="n">RTL_GIGA_MAC_VER_06</span><span class="p">)</span>
		<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config2</span><span class="p">,</span> <span class="n">cfg2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">msi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">rtl_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rtl_cfg_info</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">rtl_cfg_infos</span> <span class="o">+</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtl8169_private</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="o">*</span><span class="n">mii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chipset</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_drv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s Gigabit Ethernet driver %s loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">MODULENAME</span><span class="p">,</span> <span class="n">RTL8169_VERSION</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rtl_netdev_ops</span><span class="p">;</span>
	<span class="n">tp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">.</span><span class="n">msg_enable</span><span class="p">,</span> <span class="n">R8169_MSG_DEFAULT</span><span class="p">);</span>

	<span class="n">mii</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">;</span>
	<span class="n">mii</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mii</span><span class="o">-&gt;</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">rtl_mdio_read</span><span class="p">;</span>
	<span class="n">mii</span><span class="o">-&gt;</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">rtl_mdio_write</span><span class="p">;</span>
	<span class="n">mii</span><span class="o">-&gt;</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">mii</span><span class="o">-&gt;</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">mii</span><span class="o">-&gt;</span><span class="n">supports_gmii</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">RTL_FEATURE_GMII</span><span class="p">);</span>

	<span class="cm">/* disable ASPM completely as that cause random device stop working</span>
<span class="cm">	 * problems as well as full system hangs for some PCIe devices users */</span>
	<span class="n">pci_disable_link_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCIE_LINK_STATE_L0S</span> <span class="o">|</span> <span class="n">PCIE_LINK_STATE_L1</span> <span class="o">|</span>
				     <span class="n">PCIE_LINK_STATE_CLKPM</span><span class="p">);</span>

	<span class="cm">/* enable device (incl. PCI PM wakeup and hotplug setup) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enable failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Mem-Wr-Inval unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* make sure PCI base addr 1 is MMIO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;region #%d not an MMIO resource, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">region</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_mwi_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for weird/broken PCI region reporting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">R8169_REGS_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;Invalid PCI region size(s), aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_mwi_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MODULENAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not request regions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_mwi_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">=</span> <span class="n">RxChkSum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">use_dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="n">PCIDAC</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA configuration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_free_res_3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ioremap MMIO region */</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">region</span><span class="p">),</span> <span class="n">R8169_REGS_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remap MMIO, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res_3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">mmio_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not PCI Express</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Identify chip attached to board */</span>
	<span class="n">rtl8169_get_mac_version</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">default_ver</span><span class="p">);</span>

	<span class="n">rtl_init_rxcfg</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_irq_disable</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_hw_reset</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl_ack_events</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pretend we are using VLANs; This bypasses a nasty bug where</span>
<span class="cm">	 * Interrupts stop flowing on high load on 8110SCd controllers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">cp_cmd</span> <span class="o">|=</span> <span class="n">RxVlan</span><span class="p">;</span>

	<span class="n">rtl_init_mdio_ops</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl_init_pll_power_ops</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl_init_jumbo_ops</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="n">rtl_init_csi_ops</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">rtl8169_print_mac_version</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>

	<span class="n">chipset</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">txd_version</span> <span class="o">=</span> <span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">chipset</span><span class="p">].</span><span class="n">txd_version</span><span class="p">;</span>

	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Unlock</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config1</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PMEnable</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Config5</span><span class="p">,</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PMEStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LinkUp</span> <span class="o">|</span> <span class="n">MagicPacket</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">RTL_FEATURE_WOL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">RTL_R8</span><span class="p">(</span><span class="n">Config5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">UWF</span> <span class="o">|</span> <span class="n">BWF</span> <span class="o">|</span> <span class="n">MWF</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">RTL_FEATURE_WOL</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">rtl_try_msi</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="n">RTL_W8</span><span class="p">(</span><span class="n">Cfg9346</span><span class="p">,</span> <span class="n">Cfg9346_Lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_tbi_enabled</span><span class="p">(</span><span class="n">tp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">set_speed</span> <span class="o">=</span> <span class="n">rtl8169_set_speed_tbi</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">rtl8169_gset_tbi</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_enable</span> <span class="o">=</span> <span class="n">rtl8169_tbi_reset_enable</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_pending</span> <span class="o">=</span> <span class="n">rtl8169_tbi_reset_pending</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="n">rtl8169_tbi_link_ok</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">do_ioctl</span> <span class="o">=</span> <span class="n">rtl_tbi_ioctl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">set_speed</span> <span class="o">=</span> <span class="n">rtl8169_set_speed_xmii</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">rtl8169_gset_xmii</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_enable</span> <span class="o">=</span> <span class="n">rtl8169_xmii_reset_enable</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">phy_reset_pending</span> <span class="o">=</span> <span class="n">rtl8169_xmii_reset_pending</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">link_ok</span> <span class="o">=</span> <span class="n">rtl8169_xmii_link_ok</span><span class="p">;</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">do_ioctl</span> <span class="o">=</span> <span class="n">rtl_xmii_ioctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Get MAC address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RTL_R8</span><span class="p">(</span><span class="n">MAC0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtl8169_ethtool_ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">RTL8169_TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">rtl8169_poll</span><span class="p">,</span> <span class="n">R8169_NAPI_WEIGHT</span><span class="p">);</span>

	<span class="cm">/* don&#39;t enable SG, IP_CSUM and TSO by default - it might not work</span>
<span class="cm">	 * properly for all devices */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span>
		<span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span>
		<span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_TSO</span> <span class="o">|</span>
		<span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_05</span><span class="p">)</span>
		<span class="cm">/* 8110SCd requires hardware Rx VLAN - disallow toggling */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXALL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXFCS</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">hw_start</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">hw_start</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">event_slow</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">event_slow</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">opts1_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">!=</span> <span class="n">RTL_GIGA_MAC_VER_01</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">~</span><span class="p">(</span><span class="n">RxBOVF</span> <span class="o">|</span> <span class="n">RxFOVF</span><span class="p">)</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">rtl8169_phy_timer</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">rtl_fw</span> <span class="o">=</span> <span class="n">RTL_FIRMWARE_UNKNOWN</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_msi_4</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s at 0x%p, %pM, XID %08x IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">chipset</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">RTL_R32</span><span class="p">(</span><span class="n">TxConfig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x9cf0f8ff</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">chipset</span><span class="p">].</span><span class="n">jumbo_max</span> <span class="o">!=</span> <span class="n">JUMBO_1K</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;jumbo features [frames: %d bytes, &quot;</span>
			   <span class="s">&quot;tx checksumming: %s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">chipset</span><span class="p">].</span><span class="n">jumbo_max</span><span class="p">,</span>
			   <span class="n">rtl_chip_infos</span><span class="p">[</span><span class="n">chipset</span><span class="p">].</span><span class="n">jumbo_tx_csum</span> <span class="o">?</span> <span class="s">&quot;ok&quot;</span> <span class="o">:</span> <span class="s">&quot;ko&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_27</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_28</span> <span class="o">||</span>
	    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">mac_version</span> <span class="o">==</span> <span class="n">RTL_GIGA_MAC_VER_31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtl8168_driver_start</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">RTL_FEATURE_WOL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev_run_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_out_msi_4:</span>
	<span class="n">netif_napi_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">rtl_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">tp</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">err_out_free_res_3:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_mwi_2:</span>
	<span class="n">pci_clear_mwi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_free_dev_1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rtl8169_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">MODULENAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rtl8169_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rtl_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rtl_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">rtl_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">RTL8169_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rtl8169_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8169_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rtl8169_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtl8169_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rtl8169_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rtl8169_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
