<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › amd › sun3lance.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sun3lance.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* sun3lance.c: Ethernet driver for SUN3 Lance chip */</span>
<span class="cm">/*</span>

<span class="cm">  Sun3 Lance ethernet driver, by Sam Creasey (sammy@users.qual.net).</span>
<span class="cm">  This driver is a part of the linux kernel, and is thus distributed</span>
<span class="cm">  under the GNU General Public License.</span>

<span class="cm">  The values used in LANCE_OBIO and LANCE_IRQ seem to be empirically</span>
<span class="cm">  true for the correct IRQ and address of the lance registers.  They</span>
<span class="cm">  have not been widely tested, however.  What we probably need is a</span>
<span class="cm">  &quot;proper&quot; way to search for a device in the sun3&#39;s prom, but, alas,</span>
<span class="cm">  linux has no such thing.</span>

<span class="cm">  This driver is largely based on atarilance.c, by Roman Hodek.  Other</span>
<span class="cm">  sources of inspiration were the NetBSD sun3 am7990 driver, and the</span>
<span class="cm">  linux sparc lance driver (sunlance.c).</span>

<span class="cm">  There are more assumptions made throughout this driver, it almost</span>
<span class="cm">  certainly still needs work, but it does work at least for RARP/BOOTP and</span>
<span class="cm">  mounting the root NFS filesystem.</span>

<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;sun3lance.c: v1.2 1/12/2001  Sam Creasey (sammy@sammy.net)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/dvma.h&gt;</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/machines.h&gt;</span>

<span class="cp">#ifdef CONFIG_SUN3</span>
<span class="cp">#include &lt;asm/sun3mmu.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;asm/sun3xprom.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/* sun3/60 addr/irq for the lance chip.  If your sun is different,</span>
<span class="cm">   change this. */</span>
<span class="cp">#define LANCE_OBIO 0x120000</span>
<span class="cp">#define LANCE_IRQ IRQ_AUTO_3</span>

<span class="cm">/* Debug level:</span>
<span class="cm"> *  0 = silent, print only serious errors</span>
<span class="cm"> *  1 = normal, print error messages</span>
<span class="cm"> *  2 = debug, print debug infos</span>
<span class="cm"> *  3 = debug, print even more debug infos (packet data)</span>
<span class="cm"> */</span>

<span class="cp">#define	LANCE_DEBUG	0</span>

<span class="cp">#ifdef LANCE_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_debug</span> <span class="o">=</span> <span class="n">LANCE_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lance_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lance_debug</span><span class="p">,</span> <span class="s">&quot;SUN3 Lance debug level (0-3)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define	DPRINTK(n,a) \</span>
<span class="cp">	do {  \</span>
<span class="cp">		if (lance_debug &gt;= n)  \</span>
<span class="cp">			printk a; \</span>
<span class="cp">	} while( 0 )</span>


<span class="cm">/* we&#39;re only using 32k of memory, so we use 4 TX</span>
<span class="cm">   buffers and 16 RX buffers.  These values are expressed as log2. */</span>

<span class="cp">#define TX_LOG_RING_SIZE			3</span>
<span class="cp">#define RX_LOG_RING_SIZE			5</span>

<span class="cm">/* These are the derived values */</span>

<span class="cp">#define TX_RING_SIZE			(1 &lt;&lt; TX_LOG_RING_SIZE)</span>
<span class="cp">#define TX_RING_LEN_BITS		(TX_LOG_RING_SIZE &lt;&lt; 5)</span>
<span class="cp">#define	TX_RING_MOD_MASK		(TX_RING_SIZE - 1)</span>

<span class="cp">#define RX_RING_SIZE			(1 &lt;&lt; RX_LOG_RING_SIZE)</span>
<span class="cp">#define RX_RING_LEN_BITS		(RX_LOG_RING_SIZE &lt;&lt; 5)</span>
<span class="cp">#define	RX_RING_MOD_MASK		(RX_RING_SIZE - 1)</span>

<span class="cm">/* Definitions for packet buffer access: */</span>
<span class="cp">#define PKT_BUF_SZ		1544</span>

<span class="cm">/* Get the address of a packet buffer corresponding to a given buffer head */</span>
<span class="cp">#define	PKTBUF_ADDR(head)	(void *)((unsigned long)(MEM) | (head)-&gt;base)</span>


<span class="cm">/* The LANCE Rx and Tx ring descriptors. */</span>
<span class="k">struct</span> <span class="n">lance_rx_head</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">base</span><span class="p">;</span>		<span class="cm">/* Low word of base addr */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">base_hi</span><span class="p">;</span>	<span class="cm">/* High word of base addr (unused) */</span>
	<span class="kt">short</span> <span class="n">buf_length</span><span class="p">;</span>	<span class="cm">/* This length is 2s complement! */</span>
	<span class="k">volatile</span> <span class="kt">short</span> <span class="n">msg_length</span><span class="p">;</span>	<span class="cm">/* This length is &quot;normal&quot;. */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lance_tx_head</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">base</span><span class="p">;</span>		<span class="cm">/* Low word of base addr */</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">base_hi</span><span class="p">;</span>	<span class="cm">/* High word of base addr (unused) */</span>
	<span class="kt">short</span> <span class="n">length</span><span class="p">;</span>		<span class="cm">/* Length is 2s complement! */</span>
	<span class="k">volatile</span> <span class="kt">short</span> <span class="n">misc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The LANCE initialization block, described in databook. */</span>
<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">mode</span><span class="p">;</span>		<span class="cm">/* Pre-set mode */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">hwaddr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>	<span class="cm">/* Physical ethernet address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Multicast filter (unused). */</span>
	<span class="cm">/* Receive and transmit ring base, along with length bits. */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rdra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tdra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="cm">/* is thie needed? */</span>
<span class="p">};</span>

<span class="cm">/* The whole layout of the Lance shared memory */</span>
<span class="k">struct</span> <span class="n">lance_memory</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span>	<span class="n">init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_tx_head</span>	<span class="n">tx_head</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lance_rx_head</span>	<span class="n">rx_head</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">char</span>   <span class="n">rx_data</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">][</span><span class="n">PKT_BUF_SZ</span><span class="p">];</span>
	<span class="kt">char</span>   <span class="n">tx_data</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">][</span><span class="n">PKT_BUF_SZ</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* The driver&#39;s private device structure */</span>

<span class="k">struct</span> <span class="n">lance_private</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span>	<span class="o">*</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_memory</span>	<span class="o">*</span><span class="n">mem</span><span class="p">;</span>
     	<span class="kt">int</span> <span class="n">new_rx</span><span class="p">,</span> <span class="n">new_tx</span><span class="p">;</span>	<span class="cm">/* The next free ring entry */</span>
	<span class="kt">int</span> <span class="n">old_tx</span><span class="p">,</span> <span class="n">old_rx</span><span class="p">;</span>     <span class="cm">/* ring entry to be processed */</span>
<span class="cm">/* These two must be longs for set_bit() */</span>
	<span class="kt">long</span>	    <span class="n">tx_full</span><span class="p">;</span>
	<span class="kt">long</span>	    <span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* I/O register access macros */</span>

<span class="cp">#define	MEM	lp-&gt;mem</span>
<span class="cp">#define	DREG	lp-&gt;iobase[0]</span>
<span class="cp">#define	AREG	lp-&gt;iobase[1]</span>
<span class="cp">#define	REGA(a)	(*( AREG = (a), &amp;DREG ))</span>

<span class="cm">/* Definitions for the Lance */</span>

<span class="cm">/* tx_head flags */</span>
<span class="cp">#define TMD1_ENP		0x01	</span><span class="cm">/* end of packet */</span><span class="cp"></span>
<span class="cp">#define TMD1_STP		0x02	</span><span class="cm">/* start of packet */</span><span class="cp"></span>
<span class="cp">#define TMD1_DEF		0x04	</span><span class="cm">/* deferred */</span><span class="cp"></span>
<span class="cp">#define TMD1_ONE		0x08	</span><span class="cm">/* one retry needed */</span><span class="cp"></span>
<span class="cp">#define TMD1_MORE		0x10	</span><span class="cm">/* more than one retry needed */</span><span class="cp"></span>
<span class="cp">#define TMD1_ERR		0x40	</span><span class="cm">/* error summary */</span><span class="cp"></span>
<span class="cp">#define TMD1_OWN 		0x80	</span><span class="cm">/* ownership (set: chip owns) */</span><span class="cp"></span>

<span class="cp">#define TMD1_OWN_CHIP	TMD1_OWN</span>
<span class="cp">#define TMD1_OWN_HOST	0</span>

<span class="cm">/* tx_head misc field */</span>
<span class="cp">#define TMD3_TDR		0x03FF	</span><span class="cm">/* Time Domain Reflectometry counter */</span><span class="cp"></span>
<span class="cp">#define TMD3_RTRY		0x0400	</span><span class="cm">/* failed after 16 retries */</span><span class="cp"></span>
<span class="cp">#define TMD3_LCAR		0x0800	</span><span class="cm">/* carrier lost */</span><span class="cp"></span>
<span class="cp">#define TMD3_LCOL		0x1000	</span><span class="cm">/* late collision */</span><span class="cp"></span>
<span class="cp">#define TMD3_UFLO		0x4000	</span><span class="cm">/* underflow (late memory) */</span><span class="cp"></span>
<span class="cp">#define TMD3_BUFF		0x8000	</span><span class="cm">/* buffering error (no ENP) */</span><span class="cp"></span>

<span class="cm">/* rx_head flags */</span>
<span class="cp">#define RMD1_ENP		0x01	</span><span class="cm">/* end of packet */</span><span class="cp"></span>
<span class="cp">#define RMD1_STP		0x02	</span><span class="cm">/* start of packet */</span><span class="cp"></span>
<span class="cp">#define RMD1_BUFF		0x04	</span><span class="cm">/* buffer error */</span><span class="cp"></span>
<span class="cp">#define RMD1_CRC		0x08	</span><span class="cm">/* CRC error */</span><span class="cp"></span>
<span class="cp">#define RMD1_OFLO		0x10	</span><span class="cm">/* overflow */</span><span class="cp"></span>
<span class="cp">#define RMD1_FRAM		0x20	</span><span class="cm">/* framing error */</span><span class="cp"></span>
<span class="cp">#define RMD1_ERR		0x40	</span><span class="cm">/* error summary */</span><span class="cp"></span>
<span class="cp">#define RMD1_OWN 		0x80	</span><span class="cm">/* ownership (set: ship owns) */</span><span class="cp"></span>

<span class="cp">#define RMD1_OWN_CHIP	RMD1_OWN</span>
<span class="cp">#define RMD1_OWN_HOST	0</span>

<span class="cm">/* register names */</span>
<span class="cp">#define CSR0	0		</span><span class="cm">/* mode/status */</span><span class="cp"></span>
<span class="cp">#define CSR1	1		</span><span class="cm">/* init block addr (low) */</span><span class="cp"></span>
<span class="cp">#define CSR2	2		</span><span class="cm">/* init block addr (high) */</span><span class="cp"></span>
<span class="cp">#define CSR3	3		</span><span class="cm">/* misc */</span><span class="cp"></span>
<span class="cp">#define CSR8	8	  	</span><span class="cm">/* address filter */</span><span class="cp"></span>
<span class="cp">#define CSR15	15		</span><span class="cm">/* promiscuous mode */</span><span class="cp"></span>

<span class="cm">/* CSR0 */</span>
<span class="cm">/* (R=readable, W=writeable, S=set on write, C=clear on write) */</span>
<span class="cp">#define CSR0_INIT	0x0001		</span><span class="cm">/* initialize (RS) */</span><span class="cp"></span>
<span class="cp">#define CSR0_STRT	0x0002		</span><span class="cm">/* start (RS) */</span><span class="cp"></span>
<span class="cp">#define CSR0_STOP	0x0004		</span><span class="cm">/* stop (RS) */</span><span class="cp"></span>
<span class="cp">#define CSR0_TDMD	0x0008		</span><span class="cm">/* transmit demand (RS) */</span><span class="cp"></span>
<span class="cp">#define CSR0_TXON	0x0010		</span><span class="cm">/* transmitter on (R) */</span><span class="cp"></span>
<span class="cp">#define CSR0_RXON	0x0020		</span><span class="cm">/* receiver on (R) */</span><span class="cp"></span>
<span class="cp">#define CSR0_INEA	0x0040		</span><span class="cm">/* interrupt enable (RW) */</span><span class="cp"></span>
<span class="cp">#define CSR0_INTR	0x0080		</span><span class="cm">/* interrupt active (R) */</span><span class="cp"></span>
<span class="cp">#define CSR0_IDON	0x0100		</span><span class="cm">/* initialization done (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_TINT	0x0200		</span><span class="cm">/* transmitter interrupt (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_RINT	0x0400		</span><span class="cm">/* receiver interrupt (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_MERR	0x0800		</span><span class="cm">/* memory error (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_MISS	0x1000		</span><span class="cm">/* missed frame (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_CERR	0x2000		</span><span class="cm">/* carrier error (no heartbeat :-) (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_BABL	0x4000		</span><span class="cm">/* babble: tx-ed too many bits (RC) */</span><span class="cp"></span>
<span class="cp">#define CSR0_ERR	0x8000		</span><span class="cm">/* error (RC) */</span><span class="cp"></span>

<span class="cm">/* CSR3 */</span>
<span class="cp">#define CSR3_BCON	0x0001		</span><span class="cm">/* byte control */</span><span class="cp"></span>
<span class="cp">#define CSR3_ACON	0x0002		</span><span class="cm">/* ALE control */</span><span class="cp"></span>
<span class="cp">#define CSR3_BSWP	0x0004		</span><span class="cm">/* byte swap (1=big endian) */</span><span class="cp"></span>

<span class="cm">/***************************** Prototypes *****************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_probe</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">lance_init_ring</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_start_xmit</span><span class="p">(</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">lance_interrupt</span><span class="p">(</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_rx</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lance_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>

<span class="cm">/************************* End of Prototypes **************************/</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">sun3lance_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">found</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_SUN3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">MACH_IS_SUN3X</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="cm">/* check that this machine has an onboard lance */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_machtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SM_SUN3</span><span class="o">|</span><span class="n">SM_3_50</span>:
	<span class="k">case</span> <span class="n">SM_SUN3</span><span class="o">|</span><span class="n">SM_3_60</span>:
	<span class="k">case</span> <span class="n">SM_SUN3X</span><span class="o">|</span><span class="n">SM_3_80</span>:
		<span class="cm">/* these machines have lance */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lance_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">out1:</span>
<span class="cp">#ifdef CONFIG_SUN3</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">lance_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">lance_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">lance_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">lance_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lance_probe</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">lance_private</span>	<span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> 		<span class="n">did_version</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ioaddr_probe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SUN3</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">LANCE_OBIO</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">SUN3X_LANCE</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* test to see if there&#39;s really a lance here */</span>
	<span class="cm">/* (CSRO_INIT shouldn&#39;t be readable) */</span>

	<span class="n">ioaddr_probe</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CSR0</span><span class="p">;</span>
	<span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CSR0_INIT</span> <span class="o">|</span> <span class="n">CSR0_STOP</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CSR0_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>
		<span class="n">ioaddr_probe</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SUN3</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* XXX - leak? */</span>
	<span class="n">MEM</span> <span class="o">=</span> <span class="n">dvma_malloc_align</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_memory</span><span class="p">),</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MEM</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SUN3</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;SUN3 Lance couldn&#39;t allocate DVMA memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span> <span class="cm">/* informational only */</span>

	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">LANCE_IRQ</span><span class="p">,</span> <span class="n">lance_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;SUN3 Lance&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SUN3</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">dvma_free</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">MEM</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;SUN3 Lance unable to allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">LANCE_IRQ</span><span class="p">;</span>


	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SUN3 Lance at io %#lx, mem %#lx, irq %d, hwaddr &quot;</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">MEM</span><span class="p">,</span>
		   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* copy in the ethernet address from the prom */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* tell the card it&#39;s ether address, bytes swapped */</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">rdra</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">);</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">rlen</span>    <span class="o">=</span> <span class="p">(</span><span class="n">RX_LOG_RING_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tdra</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">);</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tlen</span>    <span class="o">=</span> <span class="p">(</span><span class="n">TX_LOG_RING_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;initaddr: %08lx rx_ring: %08lx tx_ring: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dvma_vtob</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)),</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">))));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did_version</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span> <span class="n">version</span> <span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lance_netdev_ops</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>KLUDGE -- REMOVE ME</p></td><td class="code"><div class="highlight"><pre>	<span class="n">set_bit</span><span class="p">(</span><span class="n">__LINK_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>


	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: lance_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">));</span>

	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>

	<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* From now on, AREG is kept to point to CSR0 */</span>
	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_INIT</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DREG</span> <span class="o">&amp;</span> <span class="n">CSR0_IDON</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">DREG</span> <span class="o">&amp;</span> <span class="n">CSR0_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;lance_open(): opening %s failed, i=%d, csr0=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>
		<span class="n">DREG</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DREG</span> <span class="o">=</span> <span class="n">CSR0_IDON</span> <span class="o">|</span> <span class="n">CSR0_STRT</span> <span class="o">|</span> <span class="n">CSR0_INEA</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: LANCE is open, csr0 %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Initialize the LANCE Rx and Tx rings. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_init_ring</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_rx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_hi</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">;</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="n">RMD1_OWN_CHIP</span><span class="p">;</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_hi</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_length</span> <span class="o">=</span> <span class="o">-</span><span class="n">PKT_BUF_SZ</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msg_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tell the card it&#39;s ether address, bytes swapped */</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">hwaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">rdra</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">);</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">rlen</span>    <span class="o">=</span> <span class="p">(</span><span class="n">RX_LOG_RING_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tdra</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">);</span>
	<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tlen</span>    <span class="o">=</span> <span class="p">(</span><span class="n">TX_LOG_RING_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dvma_vtob</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>


	<span class="cm">/* tell the lance the address of its init block */</span>
	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">));</span>
	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dvma_vtob</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SUN3X</span>
	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR3</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR3_BSWP</span> <span class="o">|</span> <span class="n">CSR3_ACON</span> <span class="o">|</span> <span class="n">CSR3_BCON</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR3</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR3_BSWP</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_start_xmit</span><span class="p">(</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_tx_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: transmit start.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* Transmitter timeout, serious problems. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tickssofar</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">dev_trans_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tickssofar</span> <span class="o">&lt;</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: transmit timed out, status %04x, resetting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>
		<span class="n">DREG</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Always set BSWP after a STOP as STOP puts it back into</span>
<span class="cm">		 * little endian mode.</span>
<span class="cm">		 */</span>
		<span class="n">REGA</span><span class="p">(</span><span class="n">CSR3</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR3_BSWP</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">lance_debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Ring data: old_tx %d new_tx %d%s new_rx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_tx</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_tx</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">?</span> <span class="s">&quot; (full)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span> <span class="p">);</span>
			<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;rx #%d: base=%04x blen=%04x mlen=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="p">,</span> <span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">,</span>
					<span class="o">-</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf_length</span><span class="p">,</span>
					<span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">msg_length</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx #%d: base=%04x len=%04x misc=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">,</span>
				       <span class="o">-</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span>
				       <span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span> <span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_INEA</span> <span class="o">|</span> <span class="n">CSR0_INIT</span> <span class="o">|</span> <span class="n">CSR0_STRT</span><span class="p">;</span>

		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Block a timer-based transmit from overlapping.  This could better be</span>
<span class="cm">	   done with atomic_swap(1, dev-&gt;tbusy), but set_bit() works as well. */</span>

	<span class="cm">/* Block a timer-based transmit from overlapping with us by</span>
<span class="cm">	   stopping the queue for a bit... */</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s: tx queue lock!.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* don&#39;t clear dev-&gt;tbusy flag. */</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AREG</span> <span class="o">=</span> <span class="n">CSR0</span><span class="p">;</span>
  	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: lance_start_xmit() called, csr0 %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
  				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>

<span class="cp">#ifdef CONFIG_SUN3X</span>
	<span class="cm">/* this weirdness doesn&#39;t appear on sun3... */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">DREG</span> <span class="o">&amp;</span> <span class="n">CSR0_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;INIT not set, reinitializing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>
		<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_INIT</span> <span class="o">|</span> <span class="n">CSR0_STRT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Fill in a Tx ring entry */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (lance_debug &gt;= 2) {</span>
<span class="c">		printk( &quot;%s: TX pkt %d type 0x%04x&quot;</span>
<span class="c">			&quot; from %s to %s&quot;</span>
<span class="c">			&quot; data at 0x%08x len %d\n&quot;,</span>
<span class="c">			dev-&gt;name, lp-&gt;new_tx, ((u_short *)skb-&gt;data)[6],</span>
<span class="c">			DEV_ADDR(&amp;skb-&gt;data[6]), DEV_ADDR(skb-&gt;data),</span>
<span class="c">			(int)skb-&gt;data, (int)skb-&gt;len );</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="cm">/* We&#39;re not prepared for the int until the last flags are set/reset.</span>
<span class="cm">	 * And the int may happen already after setting the OWN_CHIP... */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Mask to ring buffer boundary. */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_tx</span><span class="p">;</span>
	<span class="n">head</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>

	<span class="cm">/* Caution: the write order is important here, set the &quot;ownership&quot; bits</span>
<span class="cm">	 * last.</span>
<span class="cm">	 */</span>

	<span class="cm">/* the sun3&#39;s lance needs it&#39;s buffer padded to the minimum</span>
<span class="cm">	   size */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>head->length = -len;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">head</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">PKTBUF_ADDR</span><span class="p">(</span><span class="n">head</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">PKTBUF_ADDR</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">TMD1_OWN_CHIP</span> <span class="o">|</span> <span class="n">TMD1_ENP</span> <span class="o">|</span> <span class="n">TMD1_STP</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_tx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Trigger an immediate send poll. */</span>
	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_INEA</span> <span class="o">|</span> <span class="n">CSR0_TDMD</span> <span class="o">|</span> <span class="n">CSR0_STRT</span><span class="p">;</span>
	<span class="n">AREG</span> <span class="o">=</span> <span class="n">CSR0</span><span class="p">;</span>
  	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: lance_start_xmit() exiting, csr0 %4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
  				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[(</span><span class="n">entry</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">TMD1_OWN</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">TMD1_OWN_HOST</span><span class="p">)</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The LANCE interrupt handler. */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lance_interrupt</span><span class="p">(</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">csr0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">in_interrupt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;lance_interrupt(): invalid dev_id</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">));</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: Re-entering the interrupt handler.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">));</span>
	<span class="n">in_interrupt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">still_more:</span>
	<span class="n">flush_cache_all</span><span class="p">();</span>

	<span class="n">AREG</span> <span class="o">=</span> <span class="n">CSR0</span><span class="p">;</span>
	<span class="n">csr0</span> <span class="o">=</span> <span class="n">DREG</span><span class="p">;</span>

	<span class="cm">/* ack interrupts */</span>
	<span class="n">DREG</span> <span class="o">=</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR0_TINT</span> <span class="o">|</span> <span class="n">CSR0_RINT</span> <span class="o">|</span> <span class="n">CSR0_IDON</span><span class="p">);</span>

	<span class="cm">/* clear errors */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_ERR</span><span class="p">)</span>
		<span class="n">DREG</span> <span class="o">=</span> <span class="n">CSR0_BABL</span> <span class="o">|</span> <span class="n">CSR0_MERR</span> <span class="o">|</span> <span class="n">CSR0_CERR</span> <span class="o">|</span> <span class="n">CSR0_MISS</span><span class="p">;</span>


	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: interrupt  csr0=%04x new csr=%04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csr0</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_TINT</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* Tx-done interrupt */</span>
		<span class="kt">int</span> <span class="n">old_tx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_tx</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><pre><code>if(lance_debug &gt;= 3) {
    int i;

    printk("%s: tx int\n", dev-&gt;name);

    for(i = 0; i &lt; TX_RING_SIZE; i++)
        printk("ring %d flag=%04x\n", i,
               MEM-&gt;tx_head[i].flag);
}
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">while</span><span class="p">(</span> <span class="n">old_tx</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">lance_tx_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">tx_head</span><span class="p">[</span><span class="n">old_tx</span><span class="p">]);</span>

			<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;on tx_ring %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_tx</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">TMD1_OWN_CHIP</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* It still hasn&#39;t been Txed */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">TMD1_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TMD3_RTRY</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TMD3_LCAR</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TMD3_LCOL</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMD3_UFLO</span> <span class="o">|</span> <span class="n">TMD3_BUFF</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Tx FIFO error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>
					<span class="n">REGA</span><span class="p">(</span><span class="n">CSR3</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR3_BSWP</span><span class="p">;</span>
					<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STRT</span> <span class="o">|</span> <span class="n">CSR0_INEA</span><span class="p">;</span>
					<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMD1_ENP</span> <span class="o">|</span> <span class="n">TMD1_STP</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TMD1_ENP</span> <span class="o">|</span> <span class="n">TMD1_STP</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMD1_ONE</span> <span class="o">|</span> <span class="n">TMD1_MORE</span><span class="p">))</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;cleared tx ring %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_tx</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">old_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_tx</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">old_tx</span> <span class="o">=</span> <span class="n">old_tx</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The ring is no longer full, clear tbusy. */</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_RINT</span><span class="p">)</span>			<span class="cm">/* Rx interrupt */</span>
		<span class="n">lance_rx</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="cm">/* Log misc errors. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_BABL</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Tx babble. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_MISS</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* Missed a Rx frame. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_MERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: Bus master arbitration failure (?!?), &quot;</span>
			      <span class="s">&quot;status %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csr0</span> <span class="p">));</span>
		<span class="cm">/* Restart the chip. */</span>
		<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>
		<span class="n">REGA</span><span class="p">(</span><span class="n">CSR3</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR3_BSWP</span><span class="p">;</span>
		<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_STRT</span> <span class="o">|</span> <span class="n">CSR0_INEA</span><span class="p">;</span>
	<span class="p">}</span>


    <span class="cm">/* Clear any other interrupt, and set interrupt enable. */</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>DREG = CSR0<em>BABL | CSR0</em>CERR | CSR0<em>MISS | CSR0</em>MERR |
       CSR0<em>IDON | CSR0</em>INEA;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">REGA</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_INEA</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">DREG</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR0_RINT</span> <span class="o">|</span> <span class="n">CSR0_TINT</span><span class="p">))</span> <span class="p">{</span>
	     <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;restarting interrupt, csr0=%#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DREG</span><span class="p">));</span>
	     <span class="k">goto</span> <span class="n">still_more</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: exiting interrupt, csr0=%#04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>
	<span class="n">in_interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get packet, toss into skbuff */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_rx</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span><span class="p">;</span>

	<span class="cm">/* If we own the next entry, it&#39;s a new packet. Send it up. */</span>
	<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RMD1_OWN</span><span class="p">)</span> <span class="o">==</span> <span class="n">RMD1_OWN_HOST</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_rx_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">MEM</span><span class="o">-&gt;</span><span class="n">rx_head</span><span class="p">[</span><span class="n">entry</span><span class="p">]);</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">RMD1_ENP</span><span class="o">|</span><span class="n">RMD1_STP</span><span class="p">))</span> <span class="p">{</span>  <span class="cm">/* There was an error. */</span>
			<span class="cm">/* There is a tricky error noted by John Murphy,</span>
<span class="cm">			   &lt;murf@perftech.com&gt; to Russ Nelson: Even with</span>
<span class="cm">			   full-sized buffers it&#39;s possible for a jabber packet to use two</span>
<span class="cm">			   buffers, with only the last correctly noting the error. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RMD1_ENP</span><span class="p">)</span>	<span class="cm">/* Only count a general error at the */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* end of a packet.*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RMD1_FRAM</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RMD1_OFLO</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RMD1_CRC</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RMD1_BUFF</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">RMD1_ENP</span><span class="o">|</span><span class="n">RMD1_STP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Malloc up new buffer, compatible with net-3. */</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><pre><code>    short pkt_len = head-&gt;msg_length;// &amp; 0xfff;
</code></pre></td><td class="code"><div class="highlight"><pre>			<span class="kt">short</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">msg_length</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s: Runt packet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: Memory squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">));</span>

					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
					<span class="n">head</span><span class="o">-&gt;</span><span class="n">msg_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RMD1_OWN_CHIP</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
					     <span class="n">RX_RING_MOD_MASK</span><span class="p">;</span>
				<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">				if (lance_debug &gt;= 3) {</span>
<span class="c">					u_char *data = PKTBUF_ADDR(head);</span>
<span class="c">					printk(&quot;%s: RX pkt %d type 0x%04x&quot;</span>
<span class="c">					       &quot; from %pM to %pM&quot;,</span>
<span class="c">					       dev-&gt;name, lp-&gt;new_tx, ((u_short *)data)[6],</span>
<span class="c">					       &amp;data[6], data);</span>

<span class="c">					printk(&quot; data %02x %02x %02x %02x %02x %02x %02x %02x &quot;</span>
<span class="c">					       &quot;len %d at %08x\n&quot;,</span>
<span class="c">					       data[15], data[16], data[17], data[18],</span>
<span class="c">					       data[19], data[20], data[21], data[22],</span>
<span class="c">					       pkt_len, data);</span>
<span class="c">				}</span>
<span class="cp">#endif</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lance_debug</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u_char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">PKTBUF_ADDR</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;%s: RX pkt %d type 0x%04x len %d</span><span class="se">\n</span><span class="s"> &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="mi">6</span><span class="p">],</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="p">}</span>


				<span class="n">skb_reserve</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>	<span class="cm">/* 16 byte align */</span>
				<span class="n">skb_put</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="p">);</span>	<span class="cm">/* Make room */</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						 <span class="n">PKTBUF_ADDR</span><span class="p">(</span><span class="n">head</span><span class="p">),</span>
						 <span class="n">pkt_len</span><span class="p">);</span>

				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span> <span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span> <span class="n">skb</span> <span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><pre><code>head-&gt;buf_length = -PKT_BUF_SZ | 0xf000;
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">head</span><span class="o">-&gt;</span><span class="n">msg_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">RMD1_OWN_CHIP</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">new_rx</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_RING_MOD_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* From lance.c (Donald Becker): */</span>
	<span class="cm">/* We should check that at least two ring entries are free.</span>
<span class="cm">	   If not, we should free one and mark stats-&gt;rx_dropped++. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">AREG</span> <span class="o">=</span> <span class="n">CSR0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: Shutting down ethercard, status was %2.2x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DREG</span> <span class="p">));</span>

	<span class="cm">/* We stop the LANCE here -- it occasionally polls</span>
<span class="cm">	   memory if we don&#39;t. */</span>
	<span class="n">DREG</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Set or clear the multicast filter for this adaptor.</span>
<span class="cm">   num_addrs == -1		Promiscuous mode, receive all packets</span>
<span class="cm">   num_addrs == 0		Normal mode, clear multicast list</span>
<span class="cm">   num_addrs &gt; 0		Multicast mode, receive normal and MC packets, and do</span>
<span class="cm">						best-effort filtering.</span>
<span class="cm"> */</span>

<span class="cm">/* completely untested on a sun3 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="cm">/* Only possible if board is already started */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We take the simple way out and always enable promiscuous mode. */</span>
	<span class="n">DREG</span> <span class="o">=</span> <span class="n">CSR0_STOP</span><span class="p">;</span> <span class="cm">/* Temporarily stop the lance. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Log any net taps. */</span>
		<span class="n">DPRINTK</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span> <span class="s">&quot;%s: Promiscuous mode enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">));</span>
		<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR15</span> <span class="p">)</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span> <span class="cm">/* Set promiscuous mode */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">multicast_table</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">num_addrs</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* We don&#39;t use the multicast table, but rely on upper-layer</span>
<span class="cm">		 * filtering. */</span>
		<span class="n">memset</span><span class="p">(</span> <span class="n">multicast_table</span><span class="p">,</span> <span class="p">(</span><span class="n">num_addrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">multicast_table</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
			<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR8</span><span class="o">+</span><span class="n">i</span> <span class="p">)</span> <span class="o">=</span> <span class="n">multicast_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR15</span> <span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Unset promiscuous mode */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always set BSWP after a STOP as STOP puts it back into</span>
<span class="cm">	 * little endian mode.</span>
<span class="cm">	 */</span>
	<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR3</span> <span class="p">)</span> <span class="o">=</span> <span class="n">CSR3_BSWP</span><span class="p">;</span>

	<span class="cm">/* Resume normal operation and reset AREG to CSR0 */</span>
	<span class="n">REGA</span><span class="p">(</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">=</span> <span class="n">CSR0_IDON</span> <span class="o">|</span> <span class="n">CSR0_INEA</span> <span class="o">|</span> <span class="n">CSR0_STRT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef MODULE</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">sun3lance_dev</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sun3lance_dev</span> <span class="o">=</span> <span class="n">sun3lance_probe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sun3lance_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sun3lance_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">sun3lance_dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SUN3</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">sun3lance_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">sun3lance_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
