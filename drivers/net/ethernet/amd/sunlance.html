<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › amd › sunlance.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sunlance.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: sunlance.c,v 1.112 2002/01/15 06:48:55 davem Exp $</span>
<span class="cm"> * lance.c: Linux/Sparc/Lance driver</span>
<span class="cm"> *</span>
<span class="cm"> *	Written 1995, 1996 by Miguel de Icaza</span>
<span class="cm"> * Sources:</span>
<span class="cm"> *	The Linux  depca driver</span>
<span class="cm"> *	The Linux  lance driver.</span>
<span class="cm"> *	The Linux  skeleton driver.</span>
<span class="cm"> *	The NetBSD Sparc/Lance driver.</span>
<span class="cm"> *	Theo de Raadt (deraadt@openbsd.org)</span>
<span class="cm"> *	NCR92C990 Lan Controller manual</span>
<span class="cm"> *</span>
<span class="cm"> * 1.4:</span>
<span class="cm"> *	Added support to run with a ledma on the Sun4m</span>
<span class="cm"> *</span>
<span class="cm"> * 1.5:</span>
<span class="cm"> *	Added multiple card detection.</span>
<span class="cm"> *</span>
<span class="cm"> *	 4/17/96: Burst sizes and tpe selection on sun4m by Eddie C. Dost</span>
<span class="cm"> *		  (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> *	 5/15/96: auto carrier detection on sun4m by Eddie C. Dost</span>
<span class="cm"> *		  (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> *	 5/17/96: lebuffer on scsi/ether cards now work David S. Miller</span>
<span class="cm"> *		  (davem@caip.rutgers.edu)</span>
<span class="cm"> *</span>
<span class="cm"> *	 5/29/96: override option &#39;tpe-link-test?&#39;, if it is &#39;false&#39;, as</span>
<span class="cm"> *		  this disables auto carrier detection on sun4m. Eddie C. Dost</span>
<span class="cm"> *		  (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> * 1.7:</span>
<span class="cm"> *	 6/26/96: Bug fix for multiple ledmas, miguel.</span>
<span class="cm"> *</span>
<span class="cm"> * 1.8:</span>
<span class="cm"> *		  Stole multicast code from depca.c, fixed lance_tx.</span>
<span class="cm"> *</span>
<span class="cm"> * 1.9:</span>
<span class="cm"> *	 8/21/96: Fixed the multicast code (Pedro Roque)</span>
<span class="cm"> *</span>
<span class="cm"> *	 8/28/96: Send fake packet in lance_open() if auto_select is true,</span>
<span class="cm"> *		  so we can detect the carrier loss condition in time.</span>
<span class="cm"> *		  Eddie C. Dost (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> *	 9/15/96: Align rx_buf so that eth_copy_and_sum() won&#39;t cause an</span>
<span class="cm"> *		  MNA trap during chksum_partial_copy(). (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> *	11/17/96: Handle LE_C0_MERR in lance_interrupt(). (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> *	12/22/96: Don&#39;t loop forever in lance_rx() on incomplete packets.</span>
<span class="cm"> *		  This was the sun4c killer. Shit, stupid bug.</span>
<span class="cm"> *		  (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> * 1.10:</span>
<span class="cm"> *	 1/26/97: Modularize driver. (ecd@skynet.be)</span>
<span class="cm"> *</span>
<span class="cm"> * 1.11:</span>
<span class="cm"> *	12/27/97: Added sun4d support. (jj@sunsite.mff.cuni.cz)</span>
<span class="cm"> *</span>
<span class="cm"> * 1.12:</span>
<span class="cm"> * 	 11/3/99: Fixed SMP race in lance_start_xmit found by davem.</span>
<span class="cm"> * 	          Anton Blanchard (anton@progsoc.uts.edu.au)</span>
<span class="cm"> * 2.00: 11/9/99: Massive overhaul and port to new SBUS driver interfaces.</span>
<span class="cm"> *		  David S. Miller (davem@redhat.com)</span>
<span class="cm"> * 2.01:</span>
<span class="cm"> *      11/08/01: Use library crc32 functions (Matt_Domsch@dell.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG_DRIVER</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">lancestr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;LANCE&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt; </span><span class="cm">/* Used for the temporal inet entries and routing */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/route.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;	</span><span class="cm">/* Used by the checksum routines */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/auxio.h&gt;		</span><span class="cm">/* For tpe-link-test? setting */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#define DRV_NAME	&quot;sunlance&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;2.02&quot;</span>
<span class="cp">#define DRV_RELDATE	&quot;8/24/03&quot;</span>
<span class="cp">#define DRV_AUTHOR	&quot;Miguel de Icaza (miguel@nuclecu.unam.mx)&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="n">DRV_NAME</span> <span class="s">&quot;.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_RELDATE</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_AUTHOR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun Lance ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* Define: 2^4 Tx buffers and 2^4 Rx buffers */</span>
<span class="cp">#ifndef LANCE_LOG_TX_BUFFERS</span>
<span class="cp">#define LANCE_LOG_TX_BUFFERS 4</span>
<span class="cp">#define LANCE_LOG_RX_BUFFERS 4</span>
<span class="cp">#endif</span>

<span class="cp">#define LE_CSR0 0</span>
<span class="cp">#define LE_CSR1 1</span>
<span class="cp">#define LE_CSR2 2</span>
<span class="cp">#define LE_CSR3 3</span>

<span class="cp">#define LE_MO_PROM      0x8000  </span><span class="cm">/* Enable promiscuous mode */</span><span class="cp"></span>

<span class="cp">#define	LE_C0_ERR	0x8000	</span><span class="cm">/* Error: set if BAB, SQE, MISS or ME is set */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_BABL	0x4000	</span><span class="cm">/* BAB:  Babble: tx timeout. */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_CERR	0x2000	</span><span class="cm">/* SQE:  Signal quality error */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_MISS	0x1000	</span><span class="cm">/* MISS: Missed a packet */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_MERR	0x0800	</span><span class="cm">/* ME:   Memory error */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_RINT	0x0400	</span><span class="cm">/* Received interrupt */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_TINT	0x0200	</span><span class="cm">/* Transmitter Interrupt */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_IDON	0x0100	</span><span class="cm">/* IFIN: Init finished. */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_INTR	0x0080	</span><span class="cm">/* Interrupt or error */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_INEA	0x0040	</span><span class="cm">/* Interrupt enable */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_RXON	0x0020	</span><span class="cm">/* Receiver on */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_TXON	0x0010	</span><span class="cm">/* Transmitter on */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_TDMD	0x0008	</span><span class="cm">/* Transmitter demand */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_STOP	0x0004	</span><span class="cm">/* Stop the card */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_STRT	0x0002	</span><span class="cm">/* Start the card */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_INIT	0x0001	</span><span class="cm">/* Init the card */</span><span class="cp"></span>

<span class="cp">#define	LE_C3_BSWP	0x4     </span><span class="cm">/* SWAP */</span><span class="cp"></span>
<span class="cp">#define	LE_C3_ACON	0x2	</span><span class="cm">/* ALE Control */</span><span class="cp"></span>
<span class="cp">#define	LE_C3_BCON	0x1	</span><span class="cm">/* Byte control */</span><span class="cp"></span>

<span class="cm">/* Receive message descriptor 1 */</span>
<span class="cp">#define LE_R1_OWN       0x80    </span><span class="cm">/* Who owns the entry */</span><span class="cp"></span>
<span class="cp">#define LE_R1_ERR       0x40    </span><span class="cm">/* Error: if FRA, OFL, CRC or BUF is set */</span><span class="cp"></span>
<span class="cp">#define LE_R1_FRA       0x20    </span><span class="cm">/* FRA: Frame error */</span><span class="cp"></span>
<span class="cp">#define LE_R1_OFL       0x10    </span><span class="cm">/* OFL: Frame overflow */</span><span class="cp"></span>
<span class="cp">#define LE_R1_CRC       0x08    </span><span class="cm">/* CRC error */</span><span class="cp"></span>
<span class="cp">#define LE_R1_BUF       0x04    </span><span class="cm">/* BUF: Buffer error */</span><span class="cp"></span>
<span class="cp">#define LE_R1_SOP       0x02    </span><span class="cm">/* Start of packet */</span><span class="cp"></span>
<span class="cp">#define LE_R1_EOP       0x01    </span><span class="cm">/* End of packet */</span><span class="cp"></span>
<span class="cp">#define LE_R1_POK       0x03    </span><span class="cm">/* Packet is complete: SOP + EOP */</span><span class="cp"></span>

<span class="cp">#define LE_T1_OWN       0x80    </span><span class="cm">/* Lance owns the packet */</span><span class="cp"></span>
<span class="cp">#define LE_T1_ERR       0x40    </span><span class="cm">/* Error summary */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EMORE     0x10    </span><span class="cm">/* Error: more than one retry needed */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EONE      0x08    </span><span class="cm">/* Error: one retry needed */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EDEF      0x04    </span><span class="cm">/* Error: deferred */</span><span class="cp"></span>
<span class="cp">#define LE_T1_SOP       0x02    </span><span class="cm">/* Start of packet */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EOP       0x01    </span><span class="cm">/* End of packet */</span><span class="cp"></span>
<span class="cp">#define LE_T1_POK	0x03	</span><span class="cm">/* Packet is complete: SOP + EOP */</span><span class="cp"></span>

<span class="cp">#define LE_T3_BUF       0x8000  </span><span class="cm">/* Buffer error */</span><span class="cp"></span>
<span class="cp">#define LE_T3_UFL       0x4000  </span><span class="cm">/* Error underflow */</span><span class="cp"></span>
<span class="cp">#define LE_T3_LCOL      0x1000  </span><span class="cm">/* Error late collision */</span><span class="cp"></span>
<span class="cp">#define LE_T3_CLOS      0x0800  </span><span class="cm">/* Error carrier loss */</span><span class="cp"></span>
<span class="cp">#define LE_T3_RTY       0x0400  </span><span class="cm">/* Error retry */</span><span class="cp"></span>
<span class="cp">#define LE_T3_TDR       0x03ff  </span><span class="cm">/* Time Domain Reflectometry counter */</span><span class="cp"></span>

<span class="cp">#define TX_RING_SIZE			(1 &lt;&lt; (LANCE_LOG_TX_BUFFERS))</span>
<span class="cp">#define TX_RING_MOD_MASK		(TX_RING_SIZE - 1)</span>
<span class="cp">#define TX_RING_LEN_BITS		((LANCE_LOG_TX_BUFFERS) &lt;&lt; 29)</span>
<span class="cp">#define TX_NEXT(__x)			(((__x)+1) &amp; TX_RING_MOD_MASK)</span>

<span class="cp">#define RX_RING_SIZE			(1 &lt;&lt; (LANCE_LOG_RX_BUFFERS))</span>
<span class="cp">#define RX_RING_MOD_MASK		(RX_RING_SIZE - 1)</span>
<span class="cp">#define RX_RING_LEN_BITS		((LANCE_LOG_RX_BUFFERS) &lt;&lt; 29)</span>
<span class="cp">#define RX_NEXT(__x)			(((__x)+1) &amp; RX_RING_MOD_MASK)</span>

<span class="cp">#define PKT_BUF_SZ		1544</span>
<span class="cp">#define RX_BUFF_SIZE            PKT_BUF_SZ</span>
<span class="cp">#define TX_BUFF_SIZE            PKT_BUF_SZ</span>

<span class="k">struct</span> <span class="n">lance_rx_desc</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">rmd0</span><span class="p">;</span>		<span class="cm">/* low address of packet */</span>
	<span class="n">u8</span>	<span class="n">rmd1_bits</span><span class="p">;</span>	<span class="cm">/* descriptor bits */</span>
	<span class="n">u8</span>	<span class="n">rmd1_hadr</span><span class="p">;</span>	<span class="cm">/* high address of packet */</span>
	<span class="n">s16</span>	<span class="n">length</span><span class="p">;</span>		<span class="cm">/* This length is 2s complement (negative)!</span>
<span class="cm">				 * Buffer length</span>
<span class="cm">				 */</span>
	<span class="n">u16</span>	<span class="n">mblength</span><span class="p">;</span>	<span class="cm">/* This is the actual number of bytes received */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lance_tx_desc</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">tmd0</span><span class="p">;</span>		<span class="cm">/* low address of packet */</span>
	<span class="n">u8</span> 	<span class="n">tmd1_bits</span><span class="p">;</span>	<span class="cm">/* descriptor bits */</span>
	<span class="n">u8</span> 	<span class="n">tmd1_hadr</span><span class="p">;</span>	<span class="cm">/* high address of packet */</span>
	<span class="n">s16</span> 	<span class="n">length</span><span class="p">;</span>		<span class="cm">/* Length is 2s complement (negative)! */</span>
	<span class="n">u16</span> 	<span class="n">misc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The LANCE initialization block, described in databook. */</span>
<span class="cm">/* On the Sparc, this block should be on a DMA region     */</span>
<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">mode</span><span class="p">;</span>		<span class="cm">/* Pre-set mode (reg. 15) */</span>
	<span class="n">u8</span>	<span class="n">phys_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>	<span class="cm">/* Physical ethernet address */</span>
	<span class="n">u32</span>	<span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* Multicast filter. */</span>

	<span class="cm">/* Receive and transmit ring base, along with extra bits. */</span>
	<span class="n">u16</span>	<span class="n">rx_ptr</span><span class="p">;</span>		<span class="cm">/* receive descriptor addr */</span>
	<span class="n">u16</span>	<span class="n">rx_len</span><span class="p">;</span>		<span class="cm">/* receive len and high addr */</span>
	<span class="n">u16</span>	<span class="n">tx_ptr</span><span class="p">;</span>		<span class="cm">/* transmit descriptor addr */</span>
	<span class="n">u16</span>	<span class="n">tx_len</span><span class="p">;</span>		<span class="cm">/* transmit len and high addr */</span>

	<span class="cm">/* The Tx and Rx ring entries must aligned on 8-byte boundaries. */</span>
	<span class="k">struct</span> <span class="n">lance_rx_desc</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lance_tx_desc</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>

	<span class="n">u8</span>	<span class="n">tx_buf</span> <span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">][</span><span class="n">TX_BUFF_SIZE</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">pad</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>		<span class="cm">/* align rx_buf for copy_and_sum(). */</span>
	<span class="n">u8</span>	<span class="n">rx_buf</span> <span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">][</span><span class="n">RX_BUFF_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define libdesc_offset(rt, elem) \</span>
<span class="cp">((__u32)(((unsigned long)(&amp;(((struct lance_init_block *)0)-&gt;rt[elem])))))</span>

<span class="cp">#define libbuff_offset(rt, elem) \</span>
<span class="cp">((__u32)(((unsigned long)(&amp;(((struct lance_init_block *)0)-&gt;rt[elem][0])))))</span>

<span class="k">struct</span> <span class="n">lance_private</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">lregs</span><span class="p">;</span>		<span class="cm">/* Lance RAP/RDP regs.		*/</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">dregs</span><span class="p">;</span>		<span class="cm">/* DMA controller regs.		*/</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">init_block_iomem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">init_block_mem</span><span class="p">;</span>

	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>

	<span class="kt">int</span>		<span class="n">rx_new</span><span class="p">,</span> <span class="n">tx_new</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rx_old</span><span class="p">,</span> <span class="n">tx_old</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ledma</span><span class="p">;</span>	<span class="cm">/* If set this points to ledma	*/</span>
	<span class="kt">char</span>		<span class="n">tpe</span><span class="p">;</span>		<span class="cm">/* cable-selection is TPE	*/</span>
	<span class="kt">char</span>		<span class="n">auto_select</span><span class="p">;</span>	<span class="cm">/* cable-selection by carrier	*/</span>
	<span class="kt">char</span>		<span class="n">burst_sizes</span><span class="p">;</span>	<span class="cm">/* ledma SBus burst sizes	*/</span>
	<span class="kt">char</span>		<span class="n">pio_buffer</span><span class="p">;</span>	<span class="cm">/* init block in PIO space?	*/</span>

	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">busmaster_regval</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_ring</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rx</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">tx</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

	<span class="kt">char</span>	       	       <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">init_block_dvma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>      <span class="o">*</span><span class="n">dev</span><span class="p">;</span>		  <span class="cm">/* Backpointer	*/</span>
	<span class="k">struct</span> <span class="n">platform_device</span>       <span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>       <span class="o">*</span><span class="n">lebuffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>       <span class="n">multicast_timer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TX_BUFFS_AVAIL ((lp-&gt;tx_old&lt;=lp-&gt;tx_new)?\</span>
<span class="cp">			lp-&gt;tx_old+TX_RING_MOD_MASK-lp-&gt;tx_new:\</span>
<span class="cp">			lp-&gt;tx_old - lp-&gt;tx_new-1)</span>

<span class="cm">/* Lance registers. */</span>
<span class="cp">#define RDP		0x00UL		</span><span class="cm">/* register data port		*/</span><span class="cp"></span>
<span class="cp">#define RAP		0x02UL		</span><span class="cm">/* register address port	*/</span><span class="cp"></span>
<span class="cp">#define LANCE_REG_SIZE	0x04UL</span>

<span class="cp">#define STOP_LANCE(__lp) \</span>
<span class="cp">do {	void __iomem *__base = (__lp)-&gt;lregs; \</span>
<span class="cp">	sbus_writew(LE_CSR0,	__base + RAP); \</span>
<span class="cp">	sbus_writew(LE_C0_STOP,	__base + RDP); \</span>
<span class="cp">} while (0)</span>

<span class="kt">int</span> <span class="n">sparc_lance_debug</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="cm">/* The Lance uses 24 bit addresses */</span>
<span class="cm">/* On the Sun4c the DVMA will provide the remaining bytes for us */</span>
<span class="cm">/* On the Sun4m we have to instruct the ledma to provide them    */</span>
<span class="cm">/* Even worse, on scsi/ether SBUS cards, the init block and the</span>
<span class="cm"> * transmit/receive buffers are addresses as offsets from absolute</span>
<span class="cm"> * zero on the lebuffer PIO area. -DaveM</span>
<span class="cm"> */</span>

<span class="cp">#define LANCE_ADDR(x) ((long)(x) &amp; ~0xff000000)</span>

<span class="cm">/* Load the CSR registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_csrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">leptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">LANCE_ADDR</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span><span class="p">);</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_CSR1</span><span class="p">,</span>		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RAP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">leptr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>	  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_CSR2</span><span class="p">,</span>		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RAP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>	  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_CSR3</span><span class="p">,</span>		  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RAP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">busmaster_regval</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="cm">/* Point back to csr0 */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_CSR0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RAP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Setup the Lance Rx and Tx rings */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_init_ring_dvma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">aib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">leptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Lock out other processes while setting up hardware */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy the ethernet address to the lance init block</span>
<span class="cm">	 * Note that on the sparc you need to swap the ethernet address.</span>
<span class="cm">	 */</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* Setup the Tx ring entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">LANCE_ADDR</span><span class="p">(</span><span class="n">aib</span> <span class="o">+</span> <span class="n">libbuff_offset</span><span class="p">(</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd0</span>      <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd1_hadr</span> <span class="o">=</span> <span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd1_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span>    <span class="o">=</span> <span class="mh">0xf000</span><span class="p">;</span> <span class="cm">/* The ones required by tmd2 */</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the Rx ring entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">LANCE_ADDR</span><span class="p">(</span><span class="n">aib</span> <span class="o">+</span> <span class="n">libbuff_offset</span><span class="p">(</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd0</span>      <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1_hadr</span> <span class="o">=</span> <span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1_bits</span> <span class="o">=</span> <span class="n">LE_R1_OWN</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span>    <span class="o">=</span> <span class="o">-</span><span class="n">RX_BUFF_SIZE</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mblength</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the initialization block */</span>

	<span class="cm">/* Setup rx descriptor pointer */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="n">LANCE_ADDR</span><span class="p">(</span><span class="n">aib</span> <span class="o">+</span> <span class="n">libdesc_offset</span><span class="p">(</span><span class="n">brx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">LANCE_LOG_RX_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">rx_ptr</span> <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>

	<span class="cm">/* Setup tx descriptor pointer */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="n">LANCE_ADDR</span><span class="p">(</span><span class="n">aib</span> <span class="o">+</span> <span class="n">libdesc_offset</span><span class="p">(</span><span class="n">btx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">LANCE_LOG_TX_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_ptr</span> <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_init_ring_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">leptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Lock out other processes while setting up hardware */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy the ethernet address to the lance init block</span>
<span class="cm">	 * Note that on the sparc you need to swap the ethernet address.</span>
<span class="cm">	 */</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="cm">/* Setup the Tx ring entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">libbuff_offset</span><span class="p">(</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">leptr</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd0</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd1_hadr</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>		<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd1_bits</span><span class="p">);</span>

		<span class="cm">/* The ones required by tmd2 */</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mh">0xf000</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>		<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the Rx ring entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">libbuff_offset</span><span class="p">(</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">leptr</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd0</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1_hadr</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">LE_R1_OWN</span><span class="p">,</span>	<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1_bits</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="o">-</span><span class="n">RX_BUFF_SIZE</span><span class="o">|</span><span class="mh">0xf000</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>		<span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mblength</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the initialization block */</span>

	<span class="cm">/* Setup rx descriptor pointer */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="n">libdesc_offset</span><span class="p">(</span><span class="n">brx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">LANCE_LOG_RX_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">leptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">rx_ptr</span><span class="p">);</span>

	<span class="cm">/* Setup tx descriptor pointer */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="n">libdesc_offset</span><span class="p">(</span><span class="n">btx_ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">((</span><span class="n">LANCE_LOG_TX_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
		    <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">leptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_restart_ledma</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">DMA_HNDL_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* E-Cache draining */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DMA_FIFO_ISDRAIN</span><span class="p">)</span>
			<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_E_BURSTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">burst_sizes</span> <span class="o">&amp;</span> <span class="n">DMA_BURST32</span><span class="p">)</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">DMA_E_BURST32</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">DMA_E_BURST16</span><span class="p">;</span>

	<span class="n">csr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DMA_DSBL_RD_DRN</span> <span class="o">|</span> <span class="n">DMA_DSBL_WR_INV</span> <span class="o">|</span> <span class="n">DMA_FIFO_INV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span><span class="p">)</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="n">DMA_EN_ENETAUI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_EN_ENETAUI</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_restart_lance</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">regval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span>
		<span class="n">init_restart_ledma</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_CSR0</span><span class="p">,</span>	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RAP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_INIT</span><span class="p">,</span>	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="cm">/* Wait for the lance to complete initialization */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LE_C0_ERR</span> <span class="o">|</span> <span class="n">LE_C0_IDON</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">LE_C0_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;LANCE unopened after %d ticks, csr0=%4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dcsr=%8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear IDON by writing a &quot;1&quot;, enable interrupts and start lance */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_IDON</span><span class="p">,</span>			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_INEA</span> <span class="o">|</span> <span class="n">LE_C0_STRT</span><span class="p">,</span>	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>

		<span class="n">csr</span> <span class="o">|=</span> <span class="n">DMA_INT_ENAB</span><span class="p">;</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_rx_dvma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_rx_desc</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	     <span class="o">!</span><span class="p">((</span><span class="n">bits</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">rmd1_bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LE_R1_OWN</span><span class="p">);</span>
	     <span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">])</span> <span class="p">{</span>

		<span class="cm">/* We got an incomplete frame? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_POK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LE_R1_POK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Count only the end frame as a rx error,</span>
<span class="cm">			 * not the beginning</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_BUF</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_CRC</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_OFL</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_FRA</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_EOP</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">mblength</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Memory squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">mblength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">rmd1_bits</span> <span class="o">=</span> <span class="n">LE_R1_OWN</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">RX_NEXT</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>		<span class="cm">/* 16 byte align */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>		<span class="cm">/* make room */</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
					 <span class="n">len</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Return the packet to the pool */</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">mblength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">rmd1_bits</span> <span class="o">=</span> <span class="n">LE_R1_OWN</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">RX_NEXT</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_tx_dvma</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_tx_desc</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">tmd1_bits</span><span class="p">;</span>

		<span class="cm">/* If we hit a packet not owned by us, stop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">;</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_RTY</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_LCOL</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_CLOS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_select</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Carrier Lost, trying %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span><span class="o">?</span><span class="s">&quot;TPE&quot;</span><span class="o">:</span><span class="s">&quot;AUI&quot;</span><span class="p">);</span>
					<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Buffer errors and underflows turn off the</span>
<span class="cm">			 * transmitter, restart the adapter.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LE_T3_BUF</span><span class="o">|</span><span class="n">LE_T3_UFL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Tx: ERR_BUF|ERR_UFL, restarting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_POK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LE_T1_POK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * So we don&#39;t count the packet more than once.</span>
<span class="cm">			 */</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">tmd1_bits</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LE_T1_POK</span><span class="p">);</span>

			<span class="cm">/* One collision before packet was sent. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_EONE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* More than one collision, be optimistic. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_EMORE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">TX_NEXT</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">TX_BUFFS_AVAIL</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_piocopy_to_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p16</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p32</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p8</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">piobuf</span><span class="p">;</span>

	<span class="cm">/* We know here that both src and dest are on a 16bit boundary. */</span>
	<span class="o">*</span><span class="n">p16</span><span class="o">++</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
	<span class="n">p32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">p16</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p32</span><span class="o">++</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
		<span class="n">pbuf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">p32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p16</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">p32</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p16</span><span class="o">++</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
		<span class="n">pbuf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">p16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p8</span> <span class="o">=</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_rx_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_rx_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">];</span>
	     <span class="o">!</span><span class="p">((</span><span class="n">bits</span> <span class="o">=</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">rmd1_bits</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LE_R1_OWN</span><span class="p">);</span>
	     <span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">brx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">])</span> <span class="p">{</span>

		<span class="cm">/* We got an incomplete frame? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_POK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LE_R1_POK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Count only the end frame as a rx error,</span>
<span class="cm">			 * not the beginning</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_BUF</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_CRC</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_OFL</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_FRA</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_EOP</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">sbus_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">mblength</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Memory squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">mblength</span><span class="p">);</span>
				<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">LE_R1_OWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">rmd1_bits</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">RX_NEXT</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">skb_reserve</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>		<span class="cm">/* 16 byte align */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>		<span class="cm">/* make room */</span>
			<span class="n">lance_piocopy_to_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Return the packet to the pool */</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">mblength</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">LE_R1_OWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">rmd1_bits</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">RX_NEXT</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_tx_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_tx_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">td</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">tmd1_bits</span><span class="p">);</span>

		<span class="cm">/* If we hit a packet not owned by us, stop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">);</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_RTY</span><span class="p">)</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_LCOL</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_CLOS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_select</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Carrier Lost, trying %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span><span class="o">?</span><span class="s">&quot;TPE&quot;</span><span class="o">:</span><span class="s">&quot;AUI&quot;</span><span class="p">);</span>
					<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Buffer errors and underflows turn off the</span>
<span class="cm">			 * transmitter, restart the adapter.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LE_T3_BUF</span><span class="o">|</span><span class="n">LE_T3_UFL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Tx: ERR_BUF|ERR_UFL, restarting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_POK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LE_T1_POK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * So we don&#39;t count the packet more than once.</span>
<span class="cm">			 */</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">LE_T1_POK</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">tmd1_bits</span><span class="p">);</span>

			<span class="cm">/* One collision before packet was sent. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_EONE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* More than one collision, be optimistic. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_T1_EMORE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">TX_NEXT</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">TX_BUFFS_AVAIL</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lance_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">csr0</span><span class="p">;</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_CSR0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RAP</span><span class="p">);</span>
	<span class="n">csr0</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="cm">/* Acknowledge all the interrupt sources ASAP */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LE_C0_INTR</span> <span class="o">|</span> <span class="n">LE_C0_TINT</span> <span class="o">|</span> <span class="n">LE_C0_RINT</span><span class="p">),</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_ERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear the error condition */</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="n">LE_C0_BABL</span> <span class="o">|</span> <span class="n">LE_C0_ERR</span> <span class="o">|</span> <span class="n">LE_C0_MISS</span> <span class="o">|</span>
			     <span class="n">LE_C0_CERR</span> <span class="o">|</span> <span class="n">LE_C0_MERR</span><span class="p">),</span>
			    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_RINT</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_TINT</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_BABL</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_MISS</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_MERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_ADDR</span><span class="p">);</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Memory error, status %04x, addr %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csr0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Memory error, status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csr0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_STOP</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">dma_csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>

			<span class="n">dma_csr</span> <span class="o">|=</span> <span class="n">DMA_FIFO_INV</span><span class="p">;</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="n">dma_csr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_INEA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Build a fake network packet and send it to ourselves. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_fake_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ETH_ZLEN</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="o">-</span><span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">misc</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">LE_T1_POK</span><span class="o">|</span><span class="n">LE_T1_OWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tmd1_bits</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">packet</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tmd1_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">LE_T1_POK</span><span class="o">|</span><span class="n">LE_T1_OWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">TX_NEXT</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lance_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">lancestr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Lance: Can&#39;t get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On the 4m, setup the ledma to provide the upper bits for buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">regval</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>

		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">regval</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_TEST</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set mode and clear multicast filter only at device open,</span>
<span class="cm">	 * so that lance_init_ring() called at any error will not</span>
<span class="cm">	 * forget multicast filters.</span>
<span class="cm">	 *</span>
<span class="cm">	 * BTW it is common bug in all lance drivers! --ANK</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_select</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">build_fake_packet</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_INEA</span> <span class="o">|</span> <span class="n">LE_C0_TDMD</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">);</span>

	<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="cm">/* On the 4m, reset the dma too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">csr</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;resetting ledma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span> <span class="o">|</span> <span class="n">DMA_RST_ENET</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_RST_ENET</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_TEST</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_piocopy_from_skb</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">p16</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p8</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">p32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="o">*</span><span class="n">p32</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
			<span class="n">p32</span><span class="o">++</span><span class="p">;</span>
			<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">p8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

			<span class="n">val</span>  <span class="o">=</span> <span class="n">p8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">p8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">p8</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">p8</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
			<span class="n">p8</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">p16</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">p16</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="o">|</span> <span class="n">p16</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
			<span class="n">p16</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">piobuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_piozero</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">piobuf</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">piobuf</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">piobuf</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
		<span class="n">piobuf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">piobuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: transmit timed out, status %04x, reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">));</span>
	<span class="n">lance_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">skblen</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">skblen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skblen</span> <span class="o">&lt;=</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="o">?</span> <span class="n">ETH_ZLEN</span> <span class="o">:</span> <span class="n">skblen</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
		<span class="n">sbus_writew</span><span class="p">((</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>
		<span class="n">sbus_writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">misc</span><span class="p">);</span>
		<span class="n">lance_piocopy_from_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skblen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">skblen</span><span class="p">)</span>
			<span class="n">lance_piozero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="n">skblen</span><span class="p">],</span> <span class="n">len</span> <span class="o">-</span> <span class="n">skblen</span><span class="p">);</span>
		<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">LE_T1_POK</span> <span class="o">|</span> <span class="n">LE_T1_OWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tmd1_bits</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">len</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">misc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">skblen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">skblen</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="n">skblen</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">skblen</span><span class="p">);</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">btx_ring</span> <span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tmd1_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">LE_T1_POK</span> <span class="o">|</span> <span class="n">LE_T1_OWN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="n">TX_NEXT</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Kick the lance: transmit now */</span>
	<span class="n">sbus_writew</span><span class="p">(</span><span class="n">LE_C0_INEA</span> <span class="o">|</span> <span class="n">LE_C0_TDMD</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="cm">/* Read back CSR to invalidate the E-Cache.</span>
<span class="cm">	 * This is needed, because DMA_DSBL_WR_INV is set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span>
		<span class="n">sbus_readw</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">+</span> <span class="n">RDP</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* taken from the depca driver */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_load_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* set all multicast bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Add addresses */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mcast_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcast_table</span><span class="p">[</span><span class="n">crc</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="n">sbus_writew</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcast_table</span><span class="p">[</span><span class="n">crc</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
			<span class="n">u16</span> <span class="o">*</span><span class="n">mcast_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">filter</span><span class="p">;</span>
			<span class="n">mcast_table</span> <span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="o">*</span><span class="n">ib_mem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ib_iomem</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">STOP_LANCE</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">sbus_readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ib_iomem</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">ib_mem</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">LE_MO_PROM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span>
			<span class="n">sbus_writew</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib_iomem</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ib_mem</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LE_MO_PROM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span><span class="p">)</span>
			<span class="n">sbus_writew</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ib_iomem</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ib_mem</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">lance_load_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_set_multicast_retry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">_opaque</span><span class="p">;</span>

	<span class="n">lance_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_free_hwresources</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span><span class="p">,</span> <span class="n">LANCE_REG_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ledma</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ledma</span><span class="p">;</span>

		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledma</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">,</span>
			   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledma</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lebuffer</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_init_block</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_init_block</span><span class="p">),</span>
				  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">,</span>
				  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Ethtool support... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sparc_lance_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;sunlance&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;2.02&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">sparc_lance_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">sparc_lance_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sparc_lance_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">lance_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">lance_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">lance_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">lance_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">lance_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sparc_lance_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ledma</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">lebuffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">version_printed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sparc_lance_debug</span> <span class="o">&amp;&amp;</span> <span class="n">version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Copy the IDPROM ethernet address to the device structure, later we</span>
<span class="cm">	 * will copy the address in the device structure to the lance</span>
<span class="cm">	 * initialization block.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">idprom</span><span class="o">-&gt;</span><span class="n">id_ethaddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* Get the IO region */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">LANCE_REG_SIZE</span><span class="p">,</span> <span class="n">lancestr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SunLance: Cannot map registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ledma</span> <span class="o">=</span> <span class="n">ledma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ledma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledma</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledma</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				       <span class="s">&quot;ledma&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SunLance: Cannot map &quot;</span>
			       <span class="s">&quot;ledma registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lebuffer</span> <span class="o">=</span> <span class="n">lebuffer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lebuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sanity check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lebuffer</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SunLance: ERROR: Rx and Tx rings not on even boundary.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span> <span class="o">=</span>
			<span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lebuffer</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_init_block</span><span class="p">),</span> <span class="s">&quot;lebuffer&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_iomem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SunLance: Cannot map PIO buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span> <span class="o">=</span> <span class="n">lance_init_ring_pio</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">lance_rx_pio</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">lance_tx_pio</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span> <span class="o">=</span>
			<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_init_block</span><span class="p">),</span>
					   <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_dvma</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_block_mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SunLance: Cannot allocate consistent DMA memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pio_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">init_ring</span> <span class="o">=</span> <span class="n">lance_init_ring_dvma</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">lance_rx_dvma</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">lance_tx_dvma</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">busmaster_regval</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span>  <span class="s">&quot;busmaster-regval&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">LE_C3_BSWP</span> <span class="o">|</span>
						      <span class="n">LE_C3_ACON</span> <span class="o">|</span>
						      <span class="n">LE_C3_BCON</span><span class="p">));</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">lancestr</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">burst_sizes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ledma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">ledma_dp</span> <span class="o">=</span> <span class="n">ledma</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">sbus_dp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sbmask</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>

		<span class="cm">/* Find burst-size property for ledma */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">burst_sizes</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">ledma_dp</span><span class="p">,</span>
							<span class="s">&quot;burst-sizes&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* ledma may be capable of fast bursts, but sbus may not. */</span>
		<span class="n">sbus_dp</span> <span class="o">=</span> <span class="n">ledma_dp</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="n">sbmask</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">sbus_dp</span><span class="p">,</span> <span class="s">&quot;burst-sizes&quot;</span><span class="p">,</span>
					       <span class="n">DMA_BURSTBITS</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">burst_sizes</span> <span class="o">&amp;=</span> <span class="n">sbmask</span><span class="p">;</span>

		<span class="cm">/* Get the cable-selection property */</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">ledma_dp</span><span class="p">,</span> <span class="s">&quot;cable-selection&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span> <span class="o">||</span> <span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SunLance: using &quot;</span>
			       <span class="s">&quot;auto-carrier-detection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">nd</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/options&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nd</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">no_link_test</span><span class="p">;</span>

			<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="s">&quot;tpe-link-test?&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">no_link_test</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;SunLance: warning: overriding option &quot;</span>
				       <span class="s">&quot;&#39;tpe-link-test?&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;SunLance: warning: mail any problems &quot;</span>
				       <span class="s">&quot;to ecd@skynet.be</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">auxio_set_lte</span><span class="p">(</span><span class="n">AUXIO_LTE_ON</span><span class="p">);</span>
			<span class="p">}</span>
<span class="nl">no_link_test:</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_select</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;aui&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_select</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">auto_select</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tpe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Reset ledma */</span>
		<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span> <span class="o">|</span> <span class="n">DMA_RST_ENET</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_RST_ENET</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">+</span> <span class="n">DMA_CSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dregs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sparc_lance_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sparc_lance_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* We cannot sleep if the chip is busy during a</span>
<span class="cm">	 * multicast list update event, because such events</span>
<span class="cm">	 * can occur from interrupts (ex. IPv6).  So we</span>
<span class="cm">	 * use a timer to try again later when necessary. -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">lance_set_multicast_retry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SunLance: Cannot register device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: LANCE %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">lance_free_hwresources</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sunlance_sbus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">parent_dp</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">parent_dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ledma&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sparc_lance_probe_one</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">parent_dp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;lebuffer&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sparc_lance_probe_one</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sparc_lance_probe_one</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">sunlance_sbus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">lance_free_hwresources</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">sunlance_sbus_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;le&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">sunlance_sbus_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sunlance_sbus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sunlance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">sunlance_sbus_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sunlance_sbus_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sunlance_sbus_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">sunlance_sbus_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
