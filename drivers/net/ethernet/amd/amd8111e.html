<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › amd › amd8111e.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>amd8111e.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Advanced  Micro Devices Inc. AMD8111E Linux Network Driver</span>
<span class="cm"> * Copyright (C) 2004 Advanced Micro Devices</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2001,2002 Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt; [ 8139cp.c,tg3.c ]</span>
<span class="cm"> * Copyright (C) 2001, 2002 David S. Miller (davem@redhat.com)[ tg3.c]</span>
<span class="cm"> * Copyright 1996-1999 Thomas Bogendoerfer [ pcnet32.c ]</span>
<span class="cm"> * Derived from the lance driver written 1993,1994,1995 by Donald Becker.</span>
<span class="cm"> * Copyright 1993 United States Government as represented by the</span>
<span class="cm"> *	Director, National Security Agency.[ pcnet32.c ]</span>
<span class="cm"> * Carsten Langgaard, carstenl@mips.com [ pcnet32.c ]</span>
<span class="cm"> * Copyright (C) 2000 MIPS Technologies, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307</span>
<span class="cm"> * USA</span>

<span class="cm">Module Name:</span>

<span class="cm">	amd8111e.c</span>

<span class="cm">Abstract:</span>

<span class="cm"> 	 AMD8111 based 10/100 Ethernet Controller Driver.</span>

<span class="cm">Environment:</span>

<span class="cm">	Kernel Mode</span>

<span class="cm">Revision History:</span>
<span class="cm"> 	3.0.0</span>
<span class="cm">	   Initial Revision.</span>
<span class="cm">	3.0.1</span>
<span class="cm">	 1. Dynamic interrupt coalescing.</span>
<span class="cm">	 2. Removed prev_stats.</span>
<span class="cm">	 3. MII support.</span>
<span class="cm">	 4. Dynamic IPG support</span>
<span class="cm">	3.0.2  05/29/2003</span>
<span class="cm">	 1. Bug fix: Fixed failure to send jumbo packets larger than 4k.</span>
<span class="cm">	 2. Bug fix: Fixed VLAN support failure.</span>
<span class="cm">	 3. Bug fix: Fixed receive interrupt coalescing bug.</span>
<span class="cm">	 4. Dynamic IPG support is disabled by default.</span>
<span class="cm">	3.0.3 06/05/2003</span>
<span class="cm">	 1. Bug fix: Fixed failure to close the interface if SMP is enabled.</span>
<span class="cm">	3.0.4 12/09/2003</span>
<span class="cm">	 1. Added set_mac_address routine for bonding driver support.</span>
<span class="cm">	 2. Tested the driver for bonding support</span>
<span class="cm">	 3. Bug fix: Fixed mismach in actual receive buffer lenth and lenth</span>
<span class="cm">	    indicated to the h/w.</span>
<span class="cm">	 4. Modified amd8111e_rx() routine to receive all the received packets</span>
<span class="cm">	    in the first interrupt.</span>
<span class="cm">	 5. Bug fix: Corrected  rx_errors  reported in get_stats() function.</span>
<span class="cm">	3.0.5 03/22/2004</span>
<span class="cm">	 1. Added NAPI support</span>

<span class="cm">*/</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)</span>
<span class="cp">#define AMD8111E_VLAN_TAG_USED 1</span>
<span class="cp">#else</span>
<span class="cp">#define AMD8111E_VLAN_TAG_USED 0</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;amd8111e.h&quot;</span>
<span class="cp">#define MODULE_NAME	&quot;amd8111e&quot;</span>
<span class="cp">#define MODULE_VERS	&quot;3.0.7&quot;</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Advanced Micro Devices, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span> <span class="p">(</span><span class="s">&quot;AMD8111 based 10/100 Ethernet Controller. Driver Version &quot;</span><span class="n">MODULE_VERS</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">amd8111e_pci_tbl</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">speed_duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">speed_duplex</span><span class="p">,</span> <span class="s">&quot;Set device speed and duplex modes, 0: Auto Negotiate, 1: 10Mbps Half Duplex, 2: 10Mbps Full Duplex, 3: 100Mbps Half Duplex, 4: 100Mbps Full Duplex&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">coalesce</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">coalesce</span><span class="p">,</span> <span class="s">&quot;Enable or Disable interrupt coalescing, 1: Enable, 0: Disable&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dynamic_ipg</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dynamic_ipg</span><span class="p">,</span> <span class="s">&quot;Enable or Disable dynamic IPG, 1: Enable, 0: Disable&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">amd8111e_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>

	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AMD8111E_7462</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>

<span class="p">};</span>
<span class="cm">/*</span>
<span class="cm">This function will read the PHY registers.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_read_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span><span class="o">*</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">repeat</span><span class="o">=</span> <span class="n">REPEAT_CNT</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PHY_CMD_ACTIVE</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span> <span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span> <span class="n">PHY_RD_CMD</span> <span class="o">|</span> <span class="p">((</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>  <span class="n">mmio</span> <span class="o">+</span><span class="n">PHY_ACCESS</span><span class="p">);</span>
	<span class="k">do</span><span class="p">{</span>
		<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>  <span class="cm">/* It takes 30 us to read/write data */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">repeat</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PHY_CMD_ACTIVE</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PHY_RD_ERR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_phy_read</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">reg_val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_phy_read:</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function will write into PHY registers.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_write_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">,</span><span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">repeat</span> <span class="o">=</span> <span class="n">REPEAT_CNT</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PHY_CMD_ACTIVE</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span> <span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span> <span class="n">PHY_WR_CMD</span> <span class="o">|</span> <span class="p">((</span><span class="n">phy_id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="n">val</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span><span class="p">);</span>

	<span class="k">do</span><span class="p">{</span>
		<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">PHY_ACCESS</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>  <span class="cm">/* It takes 30 us to read/write the data */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">repeat</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PHY_CMD_ACTIVE</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">PHY_RD_ERR</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_phy_write</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_phy_write:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This is the mii register read function provided to the mii interface.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">amd8111e_read_phy</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span><span class="n">phy_id</span><span class="p">,</span><span class="n">reg_num</span><span class="p">,</span><span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg_val</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This is the mii register write function provided to the mii interface.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">amd8111e_write_phy</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">phy_id</span><span class="p">,</span> <span class="n">reg_num</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function will set PHY speed. During initialization sets the original speed to 100 full.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_set_ext_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bmcr</span><span class="p">,</span><span class="n">advert</span><span class="p">,</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Determine mii register values to set the speed */</span>
	<span class="n">advert</span> <span class="o">=</span> <span class="n">amd8111e_mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">advert</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_ALL</span> <span class="o">|</span> <span class="n">ADVERTISE_100BASE4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_option</span><span class="p">){</span>

		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">SPEED_AUTONEG</span>: <span class="cm">/* advertise all values */</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span> <span class="n">ADVERTISE_10HALF</span><span class="o">|</span><span class="n">ADVERTISE_10FULL</span><span class="o">|</span>
				<span class="n">ADVERTISE_100HALF</span><span class="o">|</span><span class="n">ADVERTISE_100FULL</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED10_HALF</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED10_FULL</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED100_HALF</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPEED100_FULL</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">advert</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">amd8111e_mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* Restart auto negotiation */</span>
	<span class="n">bmcr</span> <span class="o">=</span> <span class="n">amd8111e_mdio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="n">bmcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>
	<span class="n">amd8111e_mdio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function will unmap skb-&gt;data space and will free</span>
<span class="cm">all transmit and receive skbuffs.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_free_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">rx_skbuff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Freeing transmit skbs */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]){</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Freeing previously allocated receive buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">rx_skbuff</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rx_skbuff</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This will set the receive buffer length corresponding to the mtu size of networkinterface.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">amd8111e_set_rx_buff_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">){</span>
		<span class="cm">/* MTU + ethernet header + FCS</span>
<span class="cm">		+ optional VLAN tag + skb reserve space 2 */</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span> <span class="o">=</span> <span class="n">mtu</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPTION_JUMBO_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span> <span class="o">=</span> <span class="n">PKT_BUFF_SZ</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OPTION_JUMBO_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function will free all the previously allocated buffers, determine new receive buffer length  and will allocate new receive buffers. This function also allocates and initializes both the transmitter and receive hardware descriptors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_idx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_complete_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
		<span class="cm">/* Free previously allocated transmit and receive skbs */</span>
		<span class="n">amd8111e_free_skbs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">else</span><span class="p">{</span>
		 <span class="cm">/* allocate the tx and rx descriptors */</span>
	     	<span class="k">if</span><span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_tx_dr</span><span class="p">)</span><span class="o">*</span><span class="n">NUM_TX_RING_DR</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma_addr</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>

			<span class="k">goto</span> <span class="n">err_no_mem</span><span class="p">;</span>

	     	<span class="k">if</span><span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_rx_dr</span><span class="p">)</span><span class="o">*</span><span class="n">NUM_RX_RING_DR</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma_addr</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>

			<span class="k">goto</span> <span class="n">err_free_tx_ring</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* Set new receive buff size */</span>
	<span class="n">amd8111e_set_rx_buff_len</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Allocating receive  skbs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* Release previos allocated skbs */</span>
				<span class="k">for</span><span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">goto</span> <span class="n">err_free_rx_ring</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
        <span class="cm">/* Initilaizing receive descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buff_phy_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buff_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">OWN_BIT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initializing transmit descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_RING_DR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buff_phy_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buff_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_rx_ring:</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_rx_dr</span><span class="p">)</span><span class="o">*</span><span class="n">NUM_RX_RING_DR</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma_addr</span><span class="p">);</span>

<span class="nl">err_free_tx_ring:</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_tx_dr</span><span class="p">)</span><span class="o">*</span><span class="n">NUM_TX_RING_DR</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
		 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma_addr</span><span class="p">);</span>

<span class="nl">err_no_mem:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* This function will set the interrupt coalescing according to the input arguments */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_set_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">coal_mode</span> <span class="n">cmod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">event_count</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd8111e_coalesce_conf</span> <span class="o">*</span> <span class="n">coal_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">coal_conf</span><span class="p">;</span>


	<span class="k">switch</span><span class="p">(</span><span class="n">cmod</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">RX_INTR_COAL</span> :
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_timeout</span><span class="p">;</span>
			<span class="n">event_count</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_event_count</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">MAX_TIMEOUT</span> <span class="o">||</span>
					<span class="n">event_count</span> <span class="o">&gt;</span> <span class="n">MAX_EVENT_COUNT</span> <span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">DELAY_TIMER_CONV</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">VAL0</span><span class="o">|</span><span class="n">STINTEN</span><span class="p">,</span> <span class="n">mmio</span><span class="o">+</span><span class="n">INTEN0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">DLY_INT_A_R0</span><span class="o">|</span><span class="p">(</span> <span class="n">event_count</span><span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="p">)</span><span class="o">|</span><span class="n">timeout</span><span class="p">,</span>
							<span class="n">mmio</span><span class="o">+</span><span class="n">DLY_INT_A</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TX_INTR_COAL</span> :
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_timeout</span><span class="p">;</span>
			<span class="n">event_count</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_event_count</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">MAX_TIMEOUT</span> <span class="o">||</span>
					<span class="n">event_count</span> <span class="o">&gt;</span> <span class="n">MAX_EVENT_COUNT</span> <span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>


			<span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">DELAY_TIMER_CONV</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">VAL0</span><span class="o">|</span><span class="n">STINTEN</span><span class="p">,</span><span class="n">mmio</span><span class="o">+</span><span class="n">INTEN0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">DLY_INT_B_T0</span><span class="o">|</span><span class="p">(</span> <span class="n">event_count</span><span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="p">)</span><span class="o">|</span><span class="n">timeout</span><span class="p">,</span>
							 <span class="n">mmio</span><span class="o">+</span><span class="n">DLY_INT_B</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DISABLE_COAL</span>:
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mmio</span><span class="o">+</span><span class="n">STVAL</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">STINTEN</span><span class="p">,</span> <span class="n">mmio</span><span class="o">+</span><span class="n">INTEN0</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span><span class="n">DLY_INT_B</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span><span class="o">+</span><span class="n">DLY_INT_A</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		 <span class="k">case</span> <span class="n">ENABLE_COAL</span>:
		       <span class="cm">/* Start the timer */</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">SOFT_TIMER_FREQ</span><span class="p">,</span> <span class="n">mmio</span><span class="o">+</span><span class="n">STVAL</span><span class="p">);</span> <span class="cm">/*  0.5 sec */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">VAL0</span><span class="o">|</span><span class="n">STINTEN</span><span class="p">,</span> <span class="n">mmio</span><span class="o">+</span><span class="n">INTEN0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>

   <span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function initializes the device registers  and starts the device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">reg_val</span><span class="p">;</span>

	<span class="cm">/* stop the chip */</span>
	 <span class="n">writel</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">amd8111e_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* enable the port manager and set auto negotiation always */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">VAL1</span><span class="o">|</span><span class="n">EN_PMGR</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span> <span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">XPHYANE</span><span class="o">|</span><span class="n">XPHYRST</span> <span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CTRL2</span><span class="p">);</span>

	<span class="n">amd8111e_set_ext_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* set control registers */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CTRL1</span><span class="p">);</span>
	<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XMTSP_MASK</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">reg_val</span><span class="o">|</span> <span class="n">XMTSP_128</span> <span class="o">|</span> <span class="n">CACHE_ALIGN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CTRL1</span> <span class="p">);</span>

	<span class="cm">/* enable interrupt */</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">APINT5EN</span> <span class="o">|</span> <span class="n">APINT4EN</span> <span class="o">|</span> <span class="n">APINT3EN</span> <span class="o">|</span> <span class="n">APINT2EN</span> <span class="o">|</span> <span class="n">APINT1EN</span> <span class="o">|</span>
		<span class="n">APINT0EN</span> <span class="o">|</span> <span class="n">MIIPDTINTEN</span> <span class="o">|</span> <span class="n">MCCIINTEN</span> <span class="o">|</span> <span class="n">MCCINTEN</span> <span class="o">|</span> <span class="n">MREINTEN</span> <span class="o">|</span>
		<span class="n">SPNDINTEN</span> <span class="o">|</span> <span class="n">MPINTEN</span> <span class="o">|</span> <span class="n">SINTEN</span> <span class="o">|</span> <span class="n">STINTEN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">VAL3</span> <span class="o">|</span> <span class="n">LCINTEN</span> <span class="o">|</span> <span class="n">VAL1</span> <span class="o">|</span> <span class="n">TINTEN0</span> <span class="o">|</span> <span class="n">VAL0</span> <span class="o">|</span> <span class="n">RINTEN0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>

	<span class="cm">/* initialize tx and rx ring base addresses */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma_addr</span><span class="p">,</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_BASE_ADDR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma_addr</span><span class="p">,</span><span class="n">mmio</span><span class="o">+</span> <span class="n">RCV_RING_BASE_ADDR0</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">NUM_TX_RING_DR</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_LEN0</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">NUM_RX_RING_DR</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">RCV_RING_LEN0</span><span class="p">);</span>

	<span class="cm">/* set default IPG to 96 */</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">DEFAULT_IPG</span><span class="p">,</span><span class="n">mmio</span><span class="o">+</span><span class="n">IPG</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">DEFAULT_IPG</span><span class="o">-</span><span class="n">IFS1_DELTA</span><span class="p">),</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">IFS1</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_JUMBO_ENABLE</span><span class="p">){</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">VAL2</span><span class="o">|</span><span class="n">JUMBO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span><span class="p">);</span>
		<span class="cm">/* Reset REX_UFLO */</span>
		<span class="n">writel</span><span class="p">(</span> <span class="n">REX_UFLO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
		<span class="cm">/* Should not set REX_UFLO for jumbo frames */</span>
		<span class="n">writel</span><span class="p">(</span> <span class="n">VAL0</span> <span class="o">|</span> <span class="n">APAD_XMT</span><span class="o">|</span><span class="n">REX_RTRY</span> <span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span> <span class="n">VAL0</span> <span class="o">|</span> <span class="n">APAD_XMT</span> <span class="o">|</span> <span class="n">REX_RTRY</span><span class="o">|</span><span class="n">REX_UFLO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">JUMBO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">VAL2</span><span class="o">|</span><span class="n">VSIZE</span><span class="o">|</span><span class="n">VL_TAG_DEL</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">VAL0</span> <span class="o">|</span> <span class="n">APAD_XMT</span> <span class="o">|</span> <span class="n">REX_RTRY</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span> <span class="p">);</span>

	<span class="cm">/* Setting the MAC address to the device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">PADR</span> <span class="o">+</span> <span class="n">i</span> <span class="p">);</span>

	<span class="cm">/* Enable interrupt coalesce */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_INTR_COAL_ENABLE</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Interrupt Coalescing Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">ENABLE_COAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set RUN bit to start the chip */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VAL2</span> <span class="o">|</span> <span class="n">RDMD0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VAL0</span> <span class="o">|</span> <span class="n">INTREN</span> <span class="o">|</span> <span class="n">RUN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="cm">/* To avoid PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span><span class="o">+</span><span class="n">CMD0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This function clears necessary the device registers.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_init_hw_default</span><span class="p">(</span> <span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">logic_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>


        <span class="cm">/* stop the chip */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="cm">/* AUTOPOLL0 Register *//*TBD default value is 8100 in FPS */</span>
	<span class="n">writew</span><span class="p">(</span> <span class="mh">0x8100</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">AUTOPOLL0</span><span class="p">);</span>

	<span class="cm">/* Clear RCV_RING_BASE_ADDR */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">RCV_RING_BASE_ADDR0</span><span class="p">);</span>

	<span class="cm">/* Clear XMT_RING_BASE_ADDR */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_BASE_ADDR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_BASE_ADDR1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_BASE_ADDR2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_BASE_ADDR3</span><span class="p">);</span>

	<span class="cm">/* Clear CMD0  */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CMD0_CLEAR</span><span class="p">,</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="cm">/* Clear CMD2 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CMD2_CLEAR</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span><span class="n">CMD2</span><span class="p">);</span>

	<span class="cm">/* Clear CMD7 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CMD7_CLEAR</span> <span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD7</span><span class="p">);</span>

	<span class="cm">/* Clear DLY_INT_A and DLY_INT_B */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">DLY_INT_A</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">DLY_INT_B</span><span class="p">);</span>

	<span class="cm">/* Clear FLOW_CONTROL */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">FLOW_CONTROL</span><span class="p">);</span>

	<span class="cm">/* Clear INT0  write 1 to clear register */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>

	<span class="cm">/* Clear STVAL */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">STVAL</span><span class="p">);</span>

	<span class="cm">/* Clear INTEN0 */</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">INTEN0_CLEAR</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>

	<span class="cm">/* Clear LADRF */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span> <span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">LADRF</span><span class="p">);</span>

	<span class="cm">/* Set SRAM_SIZE &amp; SRAM_BOUNDARY registers  */</span>
	<span class="n">writel</span><span class="p">(</span> <span class="mh">0x80010</span><span class="p">,</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">SRAM_SIZE</span><span class="p">);</span>

	<span class="cm">/* Clear RCV_RING0_LEN */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span>  <span class="n">RCV_RING_LEN0</span><span class="p">);</span>

	<span class="cm">/* Clear XMT_RING0/1/2/3_LEN */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span>  <span class="n">XMT_RING_LEN0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span>  <span class="n">XMT_RING_LEN1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span>  <span class="n">XMT_RING_LEN2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span>  <span class="n">XMT_RING_LEN3</span><span class="p">);</span>

	<span class="cm">/* Clear XMT_RING_LIMIT */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_LIMIT</span><span class="p">);</span>

	<span class="cm">/* Clear MIB */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">MIB_CLEAR</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">MIB_ADDR</span><span class="p">);</span>

	<span class="cm">/* Clear LARF */</span>
	<span class="n">amd8111e_writeq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">logic_filter</span><span class="p">,</span><span class="n">mmio</span><span class="o">+</span><span class="n">LADRF</span><span class="p">);</span>

	<span class="cm">/* SRAM_SIZE register */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">SRAM_SIZE</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_JUMBO_ENABLE</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span> <span class="n">VAL2</span><span class="o">|</span><span class="n">JUMBO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span><span class="p">);</span>
<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VAL2</span><span class="o">|</span><span class="n">VSIZE</span><span class="o">|</span><span class="n">VL_TAG_DEL</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span> <span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Set default value to CTRL1 Register */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CTRL1_DEFAULT</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CTRL1</span><span class="p">);</span>

	<span class="cm">/* To avoid PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function disables the interrupt and clears all the pending</span>
<span class="cm">interrupts in INT0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_disable_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intr0</span><span class="p">;</span>

	<span class="cm">/* Disable interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">INTREN</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="cm">/* Clear INT0 */</span>
	<span class="n">intr0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intr0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>

	<span class="cm">/* To avoid PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function stops the chip.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_stop_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="cm">/* To avoid PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function frees the  transmiter and receiver descriptor rings.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_free_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Free transmit and receive descriptor rings */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">){</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_rx_dr</span><span class="p">)</span><span class="o">*</span><span class="n">NUM_RX_RING_DR</span><span class="p">,</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring_dma_addr</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">){</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_tx_dr</span><span class="p">)</span><span class="o">*</span><span class="n">NUM_TX_RING_DR</span><span class="p">,</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring_dma_addr</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function will free all the transmit skbs that are actually transmitted by the device. It will check the ownership of the skb before freeing the skb.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tx_index</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_complete_idx</span> <span class="o">&amp;</span> <span class="n">TX_RING_DR_MOD_MASK</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* Complete all the transmit packet */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_complete_idx</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="p">){</span>
		<span class="n">tx_index</span> <span class="o">=</span>  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_complete_idx</span> <span class="o">&amp;</span> <span class="n">TX_RING_DR_MOD_MASK</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">tx_flags</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OWN_BIT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* It still hasn&#39;t been Txed */</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">buff_phy_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* We must free the original skb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">tx_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_addr</span><span class="p">[</span><span class="n">tx_index</span><span class="p">],</span>
				  	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_irq</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_addr</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_complete_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*COAL update tx coalescing parameters */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">coal_conf</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">coal_conf</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">buff_count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_complete_idx</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">-</span> <span class="n">NUM_TX_BUFFERS</span> <span class="o">+</span><span class="mi">2</span><span class="p">){</span>
			<span class="cm">/* The ring is no longer full, clear tbusy. */</span>
			<span class="cm">/* lp-&gt;tx_full = 0; */</span>
			<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function handles the driver receive operation in polling mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_rx_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">amd8111e_net_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_index</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_idx</span> <span class="o">&amp;</span> <span class="n">RX_RING_DR_MOD_MASK</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span><span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_pkt_len</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_rx_pkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">pkt_len</span><span class="p">;</span>
<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
	<span class="kt">short</span> <span class="n">vtag</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">rx_pkt_limit</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">do</span><span class="p">{</span>
		<span class="cm">/* process receive packets until we use the quota*/</span>
		<span class="cm">/* If we own the next entry, it&#39;s a new packet. Send it up. */</span>
		<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">rx_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">OWN_BIT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * There is a tricky error noted by John Murphy,</span>
<span class="cm">			 * &lt;murf@perftech.com&gt; to Russ Nelson: Even with</span>
<span class="cm">			 * full-sized * buffers it&#39;s possible for a</span>
<span class="cm">			 * jabber packet to use two buffers, with only</span>
<span class="cm">			 * the last correctly noting the error.</span>
<span class="cm">			 */</span>

			<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ERR_BIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* reseting flags */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="n">RESET_RX_FLAGS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_next_pkt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* check for STP and ENP */</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STP_BIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ENP_BIT</span><span class="p">))){</span>
				<span class="cm">/* reseting flags */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="n">RESET_RX_FLAGS</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_next_pkt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">msg_count</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
			<span class="n">vtag</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">TT_MASK</span><span class="p">;</span>
			<span class="cm">/*MAC will strip vlan tag*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vtag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">min_pkt_len</span> <span class="o">=</span><span class="n">MIN_PKT_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
<span class="cp">#endif</span>
				<span class="n">min_pkt_len</span> <span class="o">=</span><span class="n">MIN_PKT_LEN</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">min_pkt_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="n">RESET_RX_FLAGS</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">drv_rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_next_pkt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="o">--</span><span class="n">rx_pkt_limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">rx_not_empty</span><span class="p">;</span>
			<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* if allocation fail,</span>
<span class="cm">				   ignore that pkt and go to next one */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">rx_flags</span> <span class="o">&amp;=</span> <span class="n">RESET_RX_FLAGS</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">drv_rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_next_pkt</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">rx_index</span><span class="p">];</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">rx_index</span><span class="p">],</span>
					 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">rx_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">rx_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
								   <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
								   <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
								   <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vtag</span> <span class="o">==</span> <span class="n">TT_VLAN_TAGGED</span><span class="p">){</span>
				<span class="n">u16</span> <span class="n">vlan_tag</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">tag_ctrl_info</span><span class="p">);</span>
				<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vlan_tag</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="cm">/*COAL update rx coalescing parameters*/</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">coal_conf</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">coal_conf</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
			<span class="n">num_rx_pkt</span><span class="o">++</span><span class="p">;</span>

		<span class="nl">err_next_pkt:</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">buff_phy_addr</span>
				<span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dma_addr</span><span class="p">[</span><span class="n">rx_index</span><span class="p">]);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">buff_count</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buff_len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">rx_index</span><span class="p">].</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">OWN_BIT</span><span class="p">);</span>
			<span class="n">rx_index</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_RING_DR_MOD_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check the interrupt status register for more packets in the</span>
<span class="cm">		   mean time. Process them since we have not used up our quota.*/</span>

		<span class="n">intr0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>
		<span class="cm">/*Ack receive packets */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">RINT0</span><span class="p">,</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">RINT0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_pkt_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Receive descriptor is empty now */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">__napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">VAL0</span><span class="o">|</span><span class="n">RINTEN0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">VAL2</span> <span class="o">|</span> <span class="n">RDMD0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">rx_not_empty:</span>
	<span class="k">return</span> <span class="n">num_rx_pkt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function will indicate the link status to the kernel.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status0</span><span class="p">,</span><span class="n">speed</span><span class="p">;</span>

	<span class="cm">/* read the link change */</span>
     	<span class="n">status0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">STAT0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">LINK_STATS</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">AUTONEG_COMPLETE</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">FULL_DPLX</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">SPEED_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">PHY_SPEED_10</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">PHY_SPEED_100</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link is Up. Speed is %s Mbps %s Duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;100&quot;</span><span class="o">:</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot;Full&quot;</span><span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span><span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_INVALID</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_INVALID</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_INVALID</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Link is Down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This function reads the mib counters.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_read_mib</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">,</span> <span class="n">u8</span> <span class="n">MIB_COUNTER</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span>  <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">repeat</span> <span class="o">=</span> <span class="n">REPEAT_CNT</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span> <span class="n">MIB_RD_CMD</span> <span class="o">|</span> <span class="n">MIB_COUNTER</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">MIB_ADDR</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">MIB_ADDR</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>	<span class="cm">/* controller takes MAX 2 us to get mib data */</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">repeat</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MIB_CMD_ACTIVE</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">MIB_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function reads the mib registers and returns the hardware statistics.</span>
<span class="cm"> * It updates previous internal driver statistics with new values.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">amd8111e_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">new_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">new_stats</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* stats.rx_packets */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_broadcast_pkts</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_multicast_pkts</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_unicast_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.tx_packets */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_packets</span><span class="p">);</span>

	<span class="cm">/*stats.rx_bytes */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_octets</span><span class="p">);</span>

	<span class="cm">/* stats.tx_bytes */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_octets</span><span class="p">);</span>

	<span class="cm">/* stats.rx_errors */</span>
	<span class="cm">/* hw errors + errors driver reported */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_undersize_pkts</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_fragments</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_jabbers</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_alignment_errors</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_fcs_errors</span><span class="p">)</span><span class="o">+</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_miss_pkts</span><span class="p">)</span><span class="o">+</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">drv_rx_errors</span><span class="p">;</span>

	<span class="cm">/* stats.tx_errors */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_underrun_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.rx_dropped*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_miss_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.tx_dropped*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span>  <span class="n">xmt_underrun_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.multicast*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_multicast_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.collisions*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_collisions</span><span class="p">);</span>

	<span class="cm">/* stats.rx_length_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span>
		<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_undersize_pkts</span><span class="p">)</span><span class="o">+</span>
		<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_oversize_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.rx_over_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_miss_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.rx_crc_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_fcs_errors</span><span class="p">);</span>

	<span class="cm">/* stats.rx_frame_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">=</span>
		<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_alignment_errors</span><span class="p">);</span>

	<span class="cm">/* stats.rx_fifo_errors */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_miss_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.rx_missed_errors */</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">rcv_miss_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.tx_aborted_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">=</span>
		<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_excessive_collision</span><span class="p">);</span>

	<span class="cm">/* stats.tx_carrier_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">=</span>
		<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_loss_carrier</span><span class="p">);</span>

	<span class="cm">/* stats.tx_fifo_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span> <span class="o">=</span> <span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_underrun_pkts</span><span class="p">);</span>

	<span class="cm">/* stats.tx_window_errors*/</span>
	<span class="n">new_stats</span><span class="o">-&gt;</span><span class="n">tx_window_errors</span> <span class="o">=</span>
		<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_late_collision</span><span class="p">);</span>

	<span class="cm">/* Reset the mibs for collecting new statistics */</span>
	<span class="cm">/* writew(MIB_CLEAR, mmio + MIB_ADDR);*/</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">new_stats</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* This function recalculate the interrupt coalescing  mode on every interrupt</span>
<span class="cm">according to the datarate and the packet rate.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_calc_coalesce</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">amd8111e_coalesce_conf</span> <span class="o">*</span> <span class="n">coal_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">coal_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_pkt_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_pkt_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_data_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_data_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_pkt_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_pkt_size</span><span class="p">;</span>

	<span class="n">tx_pkt_rate</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">-</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_prev_packets</span><span class="p">;</span>
	<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_prev_packets</span> <span class="o">=</span>  <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>

	<span class="n">tx_data_rate</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">-</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_prev_bytes</span><span class="p">;</span>
	<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_prev_bytes</span> <span class="o">=</span>  <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">;</span>

	<span class="n">rx_pkt_rate</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">-</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_prev_packets</span><span class="p">;</span>
	<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_prev_packets</span> <span class="o">=</span>  <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>

	<span class="n">rx_data_rate</span> <span class="o">=</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">-</span> <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_prev_bytes</span><span class="p">;</span>
	<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_prev_bytes</span> <span class="o">=</span>  <span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">rx_pkt_rate</span> <span class="o">&lt;</span> <span class="mi">800</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">!=</span> <span class="n">NO_COALESCE</span><span class="p">){</span>

			<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RX_INTR_COAL</span><span class="p">);</span>
			<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">=</span> <span class="n">NO_COALESCE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span><span class="p">{</span>

		<span class="n">rx_pkt_size</span> <span class="o">=</span> <span class="n">rx_data_rate</span><span class="o">/</span><span class="n">rx_pkt_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_pkt_size</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">!=</span> <span class="n">NO_COALESCE</span><span class="p">){</span>

				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">=</span> <span class="n">NO_COALESCE</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_pkt_size</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">){</span>

			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">!=</span>  <span class="n">LOW_COALESCE</span><span class="p">){</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_event_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">=</span> <span class="n">LOW_COALESCE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_pkt_size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)){</span>

			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">!=</span>  <span class="n">MEDIUM_COALESCE</span><span class="p">){</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_event_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">=</span> <span class="n">MEDIUM_COALESCE</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">){</span>
			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">!=</span>  <span class="n">HIGH_COALESCE</span><span class="p">){</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_event_count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">RX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">rx_coal_type</span> <span class="o">=</span> <span class="n">HIGH_COALESCE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
    	<span class="cm">/* NOW FOR TX INTR COALESC */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tx_pkt_rate</span> <span class="o">&lt;</span> <span class="mi">800</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">!=</span> <span class="n">NO_COALESCE</span><span class="p">){</span>

			<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TX_INTR_COAL</span><span class="p">);</span>
			<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">=</span> <span class="n">NO_COALESCE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span><span class="p">{</span>

		<span class="n">tx_pkt_size</span> <span class="o">=</span> <span class="n">tx_data_rate</span><span class="o">/</span><span class="n">tx_pkt_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_pkt_size</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">){</span>

			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">!=</span> <span class="n">NO_COALESCE</span><span class="p">){</span>

				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_event_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">=</span> <span class="n">NO_COALESCE</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">tx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_pkt_size</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">){</span>

			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">!=</span>  <span class="n">LOW_COALESCE</span><span class="p">){</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_event_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">=</span> <span class="n">LOW_COALESCE</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_pkt_size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)){</span>

			<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">!=</span>  <span class="n">MEDIUM_COALESCE</span><span class="p">){</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_event_count</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TX_INTR_COAL</span><span class="p">);</span>
				<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">=</span> <span class="n">MEDIUM_COALESCE</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">tx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_pkt_size</span> <span class="o">&gt;=</span> <span class="mi">1024</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span><span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">!=</span>  <span class="n">HIGH_COALESCE</span><span class="p">){</span>
					<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
					<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_event_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">amd8111e_set_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TX_INTR_COAL</span><span class="p">);</span>
					<span class="n">coal_conf</span><span class="o">-&gt;</span><span class="n">tx_coal_type</span> <span class="o">=</span> <span class="n">HIGH_COALESCE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This is device interrupt function. It handles transmit, receive,link change and hardware timer interrupts.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">amd8111e_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr0</span><span class="p">,</span> <span class="n">intren0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* disabling interrupt */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">INTREN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="cm">/* Read interrupt status */</span>
	<span class="n">intr0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>
	<span class="n">intren0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>

	<span class="cm">/* Process all the INT event until INTR bit is clear. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">INTR</span><span class="p">)){</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_interrupt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Current driver processes 4 interrupts : RINT,TINT,LCINT,STINT */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">intr0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>

	<span class="cm">/* Check if Receive Interrupt has occurred. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">RINT0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Disable receive interupts */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">RINTEN0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>
			<span class="cm">/* Schedule a polling routine */</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intren0</span> <span class="o">&amp;</span> <span class="n">RINTEN0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;************Driver bug! interrupt while in poll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Fix by disable receive interrupts */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">RINTEN0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check if  Transmit Interrupt has occurred. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">TINT0</span><span class="p">)</span>
		<span class="n">amd8111e_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check if  Link Change Interrupt has occurred. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">LCINT</span><span class="p">)</span>
		<span class="n">amd8111e_link_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check if Hardware Timer Interrupt has occurred. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr0</span> <span class="o">&amp;</span> <span class="n">STINT</span><span class="p">)</span>
		<span class="n">amd8111e_calc_coalesce</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_no_interrupt:</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">VAL0</span> <span class="o">|</span> <span class="n">INTREN</span><span class="p">,</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">amd8111e_interrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm">This function closes the network interface and updates the statistics so that most recent statistics will be available after the interface is down.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">amd8111e_disable_interrupt</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">amd8111e_stop_chip</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="cm">/* Free transmit and receive skbs */</span>
	<span class="n">amd8111e_free_skbs</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">amd8111e_net_dev</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">amd8111e_net_dev</span><span class="p">);</span>

	<span class="cm">/* Delete ipg timer */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_DYN_IPG_ENABLE</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">amd8111e_free_ring</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="cm">/* Update the statistics before closing */</span>
	<span class="n">amd8111e_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* This function opens new interface.It requests irq for the device, initializes the device,buffers and descriptors, and starts the device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">amd8111e_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">amd8111e_init_hw_default</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">amd8111e_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">)){</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Start ipg timer */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_DYN_IPG_ENABLE</span><span class="p">){</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Dynamic IPG Enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This function checks if there is any transmit  descriptors available to queue more packet.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_tx_queue_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tx_index</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">&amp;</span> <span class="n">TX_BUFF_MOD_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">tx_index</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This function will queue the transmit packets to the descriptors and will trigger the send operation. It also initializes the transmit descriptors with buffer physical address, byte count, ownership to hardware etc.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">amd8111e_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tx_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tx_index</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_idx</span> <span class="o">&amp;</span> <span class="n">TX_RING_DR_MOD_MASK</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">buff_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">tag_ctrl_cmd</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TCC_VLAN_INSERT</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">tag_ctrl_info</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>

	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_addr</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">buff_phy_addr</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_dma_addr</span><span class="p">[</span><span class="n">tx_index</span><span class="p">]);</span>

	<span class="cm">/*  Set FCS and LTINT bits */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">tx_index</span><span class="p">].</span><span class="n">tx_flags</span> <span class="o">|=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">OWN_BIT</span> <span class="o">|</span> <span class="n">STP_BIT</span> <span class="o">|</span> <span class="n">ENP_BIT</span><span class="o">|</span><span class="n">ADD_FCS_BIT</span><span class="o">|</span><span class="n">LTINT_BIT</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_idx</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Trigger an immediate send poll. */</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">VAL1</span> <span class="o">|</span> <span class="n">TDMD0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">VAL2</span> <span class="o">|</span> <span class="n">RDMD0</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">amd8111e_tx_queue_avail</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">This function returns all the memory mapped registers of the device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_read_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="cm">/* Read only necessary registers */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_BASE_ADDR0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">XMT_RING_LEN0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">RCV_RING_BASE_ADDR0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">RCV_RING_LEN0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD7</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INT0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">INTEN0</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">LADRF</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">LADRF</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">STAT0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">This function sets promiscuos mode, all-multi mode or the multicast address</span>
<span class="cm">list to the device.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit_num</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">){</span>
		<span class="n">writel</span><span class="p">(</span> <span class="n">VAL2</span> <span class="o">|</span> <span class="n">PROM</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span> <span class="n">PROM</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span>
	    <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_FILTER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get all multicast packet */</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPTION_MULTICAST_ENABLE</span><span class="p">;</span>
		<span class="n">amd8111e_writeq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">mc_filter</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">LADRF</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* get only own packets */</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OPTION_MULTICAST_ENABLE</span><span class="p">;</span>
		<span class="n">amd8111e_writeq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">mc_filter</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">LADRF</span><span class="p">);</span>
		<span class="cm">/* disable promiscuous mode */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">PROM</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* load all the multicast addresses in the logic filter */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPTION_MULTICAST_ENABLE</span><span class="p">;</span>
	<span class="n">mc_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">mc_filter</span><span class="p">[</span><span class="n">bit_num</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit_num</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">amd8111e_writeq</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">mc_filter</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="o">+</span> <span class="n">LADRF</span><span class="p">);</span>

	<span class="cm">/* To eliminate PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD2</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">MODULE_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">MODULE_VERS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
		<span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">chip_version</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">AMD8111E_REG_DUMP_LEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">amd8111e_read_regs</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">ecmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">amd8111e_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wol_info</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="o">|</span><span class="n">WAKE_PHY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_WOL_ENABLE</span><span class="p">)</span>
		<span class="n">wol_info</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="n">WAKE_MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol_info</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">WAKE_MAGIC</span><span class="o">|</span><span class="n">WAKE_PHY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wol_info</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">OPTION_WOL_ENABLE</span> <span class="o">|</span> <span class="n">OPTION_WAKE_MAGIC_ENABLE</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">wol_info</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;</span> <span class="n">WAKE_PHY</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">OPTION_WOL_ENABLE</span> <span class="o">|</span> <span class="n">OPTION_WAKE_PHY_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OPTION_WOL_ENABLE</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">amd8111e_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span> <span class="o">=</span> <span class="n">amd8111e_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span> <span class="o">=</span> <span class="n">amd8111e_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">amd8111e_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">amd8111e_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">amd8111e_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">amd8111e_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span> <span class="o">=</span> <span class="n">amd8111e_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span> <span class="o">=</span> <span class="n">amd8111e_set_wol</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">This function handles all the  ethtool ioctls. It gives driver info, gets/sets driver speed, gets memory mapped register values, forces auto negotiation, sets/gets WOL options for ethtool application.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">dev</span> <span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mii_regval</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGMIIPHY</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">;</span>

	<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SIOCGMIIREG</span>:

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">amd8111e_read_phy</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="n">PHY_REG_ADDR_MASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mii_regval</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">val_out</span> <span class="o">=</span> <span class="n">mii_regval</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSMIIREG</span>:

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">amd8111e_write_phy</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">&amp;</span> <span class="n">PHY_REG_ADDR_MASK</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">val_in</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Setting the MAC address to the device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">PADR</span> <span class="o">+</span> <span class="n">i</span> <span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">This function changes the mtu of the device. It restarts the device  to initialize the descriptor with new receive buffers.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">AMD8111E_MIN_MTU</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">AMD8111E_MAX_MTU</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* new_mtu will be used</span>
<span class="cm">		   when device starts netxt time */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="cm">/* stop the chip */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">amd8111e_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_enable_magicpkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">VAL1</span><span class="o">|</span><span class="n">MPPLBA</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD3</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span> <span class="n">VAL0</span><span class="o">|</span><span class="n">MPEN_SW</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD7</span><span class="p">);</span>

	<span class="cm">/* To eliminate PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD7</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_enable_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Adapter is already stoped/suspended/interrupt-disabled */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">VAL0</span><span class="o">|</span><span class="n">LCMODE_SW</span><span class="p">,</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD7</span><span class="p">);</span>

	<span class="cm">/* To eliminate PCI posting bug */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CMD7</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called when a packet transmission fails to complete</span>
<span class="cm"> * within a reasonable period, on the assumption that an interrupt have</span>
<span class="cm"> * failed or the interface is locked up. This function will reinitialize</span>
<span class="cm"> * the hardware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: transmit timed out, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 					      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">amd8111e_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable the interrupt */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">amd8111e_disable_interrupt</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* stop chip */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_DYN_IPG_ENABLE</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">);</span>
	<span class="n">amd8111e_stop_chip</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_WOL_ENABLE</span><span class="p">){</span>
		 <span class="cm">/* enable wol */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_WAKE_MAGIC_ENABLE</span><span class="p">)</span>
			<span class="n">amd8111e_enable_magicpkt</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_WAKE_PHY_ENABLE</span><span class="p">)</span>
			<span class="n">amd8111e_enable_link_change</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">else</span><span class="p">{</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd8111e_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D3cold</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* D3 cold */</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">amd8111e_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Restart ipg timer */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_DYN_IPG_ENABLE</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">,</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="n">IPG_CONVERGE_JIFFIES</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">amd8111e_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(((</span><span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd8111e_config_ipg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ipg_info</span><span class="o">*</span> <span class="n">ipg_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prev_col_cnt</span> <span class="o">=</span> <span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">col_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total_col_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_ipg</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">link_config</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">){</span>
		<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg</span> <span class="o">=</span> <span class="n">DEFAULT_IPG</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg_state</span> <span class="o">==</span> <span class="n">SSTATE</span><span class="p">){</span>

		<span class="k">if</span><span class="p">(</span><span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">timer_tick</span> <span class="o">==</span> <span class="n">IPG_STABLE_TIME</span><span class="p">){</span>

			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">timer_tick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg</span> <span class="o">=</span> <span class="n">MIN_IPG</span> <span class="o">-</span> <span class="n">IPG_STEP</span><span class="p">;</span>
			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">current_ipg</span> <span class="o">=</span> <span class="n">MIN_IPG</span><span class="p">;</span>
			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">diff_col_cnt</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg_state</span> <span class="o">=</span> <span class="n">CSTATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">timer_tick</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg_state</span> <span class="o">==</span> <span class="n">CSTATE</span><span class="p">){</span>

		<span class="cm">/* Get the current collision count */</span>

		<span class="n">total_col_cnt</span> <span class="o">=</span> <span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">col_cnt</span> <span class="o">=</span>
				<span class="n">amd8111e_read_mib</span><span class="p">(</span><span class="n">mmio</span><span class="p">,</span> <span class="n">xmt_collisions</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">total_col_cnt</span> <span class="o">-</span> <span class="n">prev_col_cnt</span><span class="p">)</span> <span class="o">&lt;</span>
				<span class="p">(</span><span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">diff_col_cnt</span><span class="p">)){</span>

			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">diff_col_cnt</span> <span class="o">=</span>
				<span class="n">total_col_cnt</span> <span class="o">-</span> <span class="n">prev_col_cnt</span> <span class="p">;</span>

			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg</span> <span class="o">=</span> <span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">current_ipg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">current_ipg</span> <span class="o">+=</span> <span class="n">IPG_STEP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">current_ipg</span> <span class="o">&lt;=</span> <span class="n">MAX_IPG</span><span class="p">)</span>
			<span class="n">tmp_ipg</span> <span class="o">=</span> <span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">current_ipg</span><span class="p">;</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="n">tmp_ipg</span> <span class="o">=</span> <span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg</span><span class="p">;</span>
			<span class="n">ipg_data</span><span class="o">-&gt;</span><span class="n">ipg_state</span> <span class="o">=</span> <span class="n">SSTATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp_ipg</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">IPG</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">tmp_ipg</span> <span class="o">-</span> <span class="n">IFS1_DELTA</span><span class="p">),</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">IFS1</span><span class="p">);</span>
	<span class="p">}</span>
	 <span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">IPG_CONVERGE_JIFFIES</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">amd8111e_probe_ext_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x1e</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">amd8111e_read_phy</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amd8111e_read_phy</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">id1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">id2</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">amd8111e_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">amd8111e_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">amd8111e_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">amd8111e_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">amd8111e_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">amd8111e_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">amd8111e_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">amd8111e_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">amd8111e_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">amd8111e_change_mtu</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	 <span class="o">=</span> <span class="n">amd8111e_poll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">amd8111e_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pm_cap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_addr</span><span class="p">,</span><span class="n">reg_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="o">*</span> <span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: Cannot enable new PCI device, &quot;</span>
			<span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: Cannot find PCI base address, &quot;</span>
		       <span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MODULE_NAME</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: Cannot obtain PCI resources, &quot;</span>
		       <span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Find power-management capability. */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">pm_cap</span> <span class="o">=</span> <span class="n">pci_find_capability</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CAP_ID_PM</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: No Power Management capability, &quot;</span>
		       <span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: DMA not supported,&quot;</span>
			<span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">reg_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amd8111e_priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span> <span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">amd8111e_net_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pm_cap</span> <span class="o">=</span> <span class="n">pm_cap</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">reg_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: Cannot map device registers, &quot;</span>
		       <span class="s">&quot;exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initializing MAC address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">PADR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Setting user defined parametrs */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_option</span> <span class="o">=</span> <span class="n">speed_duplex</span><span class="p">[</span><span class="n">card_idx</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="n">coalesce</span><span class="p">[</span><span class="n">card_idx</span><span class="p">])</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPTION_INTR_COAL_ENABLE</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dynamic_ipg</span><span class="p">[</span><span class="n">card_idx</span><span class="o">++</span><span class="p">])</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">|=</span> <span class="n">OPTION_DYN_IPG_ENABLE</span><span class="p">;</span>


	<span class="cm">/* Initialize driver entry points */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd8111e_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">AMD8111E_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">amd8111e_rx_poll</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

<span class="cp">#if AMD8111E_VLAN_TAG_USED</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* Probe the external PHY */</span>
	<span class="n">amd8111e_probe_ext_phy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* setting mii default values */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">amd8111e_mdio_read</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">amd8111e_mdio_write</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">;</span>

	<span class="cm">/* Set receive buffer length and set jumbo option*/</span>
	<span class="n">amd8111e_set_rx_buff_len</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd8111e: Cannot register net device, &quot;</span>
		       <span class="s">&quot;exiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Initialize software ipg timer */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPTION_DYN_IPG_ENABLE</span><span class="p">){</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amd8111e_config_ipg</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
						 <span class="n">IPG_CONVERGE_JIFFIES</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg</span> <span class="o">=</span> <span class="n">DEFAULT_IPG</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ipg_data</span><span class="p">.</span><span class="n">ipg_state</span> <span class="o">=</span> <span class="n">CSTATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  display driver and device information */</span>

    	<span class="n">chip_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">CHIPID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">28</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: AMD-8111e Driver Version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">MODULE_VERS</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: [ Rev %x ] PCI 10/100BaseT Ethernet %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip_version</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_id</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Found MII PHY ID 0x%08x at address 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_id</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ext_phy_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Couldn&#39;t detect MII PHY, assuming address 0x01</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>

<span class="nl">err_free_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_free_reg:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">amd8111e_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>   	<span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">amd8111e_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">amd8111e_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">amd8111e_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">amd8111e_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">amd8111e_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amd8111e_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd8111e_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amd8111e_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd8111e_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amd8111e_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">amd8111e_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
