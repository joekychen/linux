<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › amd › ni65.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ni65.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ni6510 (am7990 &#39;lance&#39; chip) driver for Linux-net-3</span>
<span class="cm"> * BETAcode v0.71 (96/09/29) for 2.0.0 (or later)</span>
<span class="cm"> * copyrights (c) 1994,1995,1996 by M.Hipp</span>
<span class="cm"> *</span>
<span class="cm"> * This driver can handle the old ni6510 board and the newer ni6510</span>
<span class="cm"> * EtherBlaster. (probably it also works with every full NE2100</span>
<span class="cm"> * compatible card)</span>
<span class="cm"> *</span>
<span class="cm"> * driver probes: io: 0x360,0x300,0x320,0x340 / dma: 3,5,6,7</span>
<span class="cm"> *</span>
<span class="cm"> * This is an extension to the Linux operating system, and is covered by the</span>
<span class="cm"> * same GNU General Public License that covers the Linux-kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * comments/bugs/suggestions can be sent to:</span>
<span class="cm"> *   Michael Hipp</span>
<span class="cm"> *   email: hippm@informatik.uni-tuebingen.de</span>
<span class="cm"> *</span>
<span class="cm"> * sources:</span>
<span class="cm"> *   some things are from the &#39;ni6510-packet-driver for dos by Russ Nelson&#39;</span>
<span class="cm"> *   and from the original drivers by D.Becker</span>
<span class="cm"> *</span>
<span class="cm"> * known problems:</span>
<span class="cm"> *   - on some PCI boards (including my own) the card/board/ISA-bridge has</span>
<span class="cm"> *     problems with bus master DMA. This results in lotsa overruns.</span>
<span class="cm"> *     It may help to &#39;#define RCV_PARANOIA_CHECK&#39; or try to #undef</span>
<span class="cm"> *     the XMT and RCV_VIA_SKB option .. this reduces driver performance.</span>
<span class="cm"> *     Or just play with your BIOS options to optimize ISA-DMA access.</span>
<span class="cm"> *     Maybe you also wanna play with the LOW_PERFORAMCE and MID_PERFORMANCE</span>
<span class="cm"> *     defines -&gt; please report me your experience then</span>
<span class="cm"> *   - Harald reported for ASUS SP3G mainboards, that you should use</span>
<span class="cm"> *     the &#39;optimal settings&#39; from the user&#39;s manual on page 3-12!</span>
<span class="cm"> *</span>
<span class="cm"> * credits:</span>
<span class="cm"> *   thanx to Jason Sullivan for sending me a ni6510 card!</span>
<span class="cm"> *   lot of debug runs with ASUS SP3G Boards (Intel Saturn) by Harald Koenig</span>
<span class="cm"> *</span>
<span class="cm"> * simple performance test: (486DX-33/Ni6510-EB receives from 486DX4-100/Ni6510-EB)</span>
<span class="cm"> *    average: FTP -&gt; 8384421 bytes received in 8.5 seconds</span>
<span class="cm"> *           (no RCV_VIA_SKB,no XMT_VIA_SKB,PARANOIA_CHECK,4 XMIT BUFS, 8 RCV_BUFFS)</span>
<span class="cm"> *    peak: FTP -&gt; 8384421 bytes received in 7.5 seconds</span>
<span class="cm"> *           (RCV_VIA_SKB,XMT_VIA_SKB,no PARANOIA_CHECK,1(!) XMIT BUF, 16 RCV BUFFS)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * 99.Jun.8: added support for /proc/net/dev byte count for xosview (HK)</span>
<span class="cm"> * 96.Sept.29: virt_to_bus stuff added for new memory modell</span>
<span class="cm"> * 96.April.29: Added Harald Koenig&#39;s Patches (MH)</span>
<span class="cm"> * 96.April.13: enhanced error handling .. more tests (MH)</span>
<span class="cm"> * 96.April.5/6: a lot of performance tests. Got it stable now (hopefully) (MH)</span>
<span class="cm"> * 96.April.1: (no joke ;) .. added EtherBlaster and Module support (MH)</span>
<span class="cm"> * 96.Feb.19: fixed a few bugs .. cleanups .. tested for 1.3.66 (MH)</span>
<span class="cm"> *            hopefully no more 16MB limit</span>
<span class="cm"> *</span>
<span class="cm"> * 95.Nov.18: multicast tweaked (AC).</span>
<span class="cm"> *</span>
<span class="cm"> * 94.Aug.22: changes in xmit_intr (ack more than one xmitted-packet), ni65_send_packet (p-&gt;lock) (MH)</span>
<span class="cm"> *</span>
<span class="cm"> * 94.July.16: fixed bugs in recv_skb and skb-alloc stuff  (MH)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &quot;ni65.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * the current setting allows an acceptable performance</span>
<span class="cm"> * for &#39;RCV_PARANOIA_CHECK&#39; read the &#39;known problems&#39; part in</span>
<span class="cm"> * the header of this file</span>
<span class="cm"> * &#39;invert&#39; the defines for max. performance. This may cause DMA problems</span>
<span class="cm"> * on some boards (e.g on my ASUS SP3G)</span>
<span class="cm"> */</span>
<span class="cp">#undef XMT_VIA_SKB</span>
<span class="cp">#undef RCV_VIA_SKB</span>
<span class="cp">#define RCV_PARANOIA_CHECK</span>

<span class="cp">#define MID_PERFORMANCE</span>

<span class="cp">#if   defined( LOW_PERFORMANCE )</span>
 <span class="k">static</span> <span class="kt">int</span> <span class="n">isa0</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">isa1</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">csr80</span><span class="o">=</span><span class="mh">0x0c10</span><span class="p">;</span>
<span class="cp">#elif defined( MID_PERFORMANCE )</span>
 <span class="k">static</span> <span class="kt">int</span> <span class="n">isa0</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">isa1</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">csr80</span><span class="o">=</span><span class="mh">0x2810</span><span class="p">;</span>
<span class="cp">#else	</span><span class="cm">/* high performance */</span><span class="cp"></span>
 <span class="k">static</span> <span class="kt">int</span> <span class="n">isa0</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">isa1</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">csr80</span><span class="o">=</span><span class="mh">0x0017</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * a few card/vendor specific defines</span>
<span class="cm"> */</span>
<span class="cp">#define NI65_ID0    0x00</span>
<span class="cp">#define NI65_ID1    0x55</span>
<span class="cp">#define NI65_EB_ID0 0x52</span>
<span class="cp">#define NI65_EB_ID1 0x44</span>
<span class="cp">#define NE2100_ID0  0x57</span>
<span class="cp">#define NE2100_ID1  0x57</span>

<span class="cp">#define PORT p-&gt;cmdr_addr</span>

<span class="cm">/*</span>
<span class="cm"> * buffer configuration</span>
<span class="cm"> */</span>
<span class="cp">#if 1</span>
<span class="cp">#define RMDNUM 16</span>
<span class="cp">#define RMDNUMMASK 0x80000000</span>
<span class="cp">#else</span>
<span class="cp">#define RMDNUM 8</span>
<span class="cp">#define RMDNUMMASK 0x60000000 </span><span class="cm">/* log2(RMDNUM)&lt;&lt;29 */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define TMDNUM 1</span>
<span class="c">#define TMDNUMMASK 0x00000000</span>
<span class="cp">#else</span>
<span class="cp">#define TMDNUM 4</span>
<span class="cp">#define TMDNUMMASK 0x40000000 </span><span class="cm">/* log2(TMDNUM)&lt;&lt;29 */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/* slightly oversized */</span>
<span class="cp">#define R_BUF_SIZE 1544</span>
<span class="cp">#define T_BUF_SIZE 1544</span>

<span class="cm">/*</span>
<span class="cm"> * lance register defines</span>
<span class="cm"> */</span>
<span class="cp">#define L_DATAREG 0x00</span>
<span class="cp">#define L_ADDRREG 0x02</span>
<span class="cp">#define L_RESET   0x04</span>
<span class="cp">#define L_CONFIG  0x05</span>
<span class="cp">#define L_BUSIF   0x06</span>

<span class="cm">/*</span>
<span class="cm"> * to access the lance/am7990-regs, you have to write</span>
<span class="cm"> * reg-number into L_ADDRREG, then you can access it using L_DATAREG</span>
<span class="cm"> */</span>
<span class="cp">#define CSR0  0x00</span>
<span class="cp">#define CSR1  0x01</span>
<span class="cp">#define CSR2  0x02</span>
<span class="cp">#define CSR3  0x03</span>

<span class="cp">#define INIT_RING_BEFORE_START	0x1</span>
<span class="cp">#define FULL_RESET_ON_ERROR	0x2</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define writereg(val,reg) {outw(reg,PORT+L_ADDRREG);inw(PORT+L_ADDRREG); \</span>
<span class="c">                           outw(val,PORT+L_DATAREG);inw(PORT+L_DATAREG);}</span>
<span class="c">#define readreg(reg) (outw(reg,PORT+L_ADDRREG),inw(PORT+L_ADDRREG),\</span>
<span class="c">                       inw(PORT+L_DATAREG))</span>
<span class="cp">#if 0</span>
<span class="c">#define writedatareg(val) {outw(val,PORT+L_DATAREG);inw(PORT+L_DATAREG);}</span>
<span class="cp">#else</span>
<span class="c">#define writedatareg(val) {  writereg(val,CSR0); }</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
<span class="cp">#define writereg(val,reg) {outw(reg,PORT+L_ADDRREG);outw(val,PORT+L_DATAREG);}</span>
<span class="cp">#define readreg(reg) (outw(reg,PORT+L_ADDRREG),inw(PORT+L_DATAREG))</span>
<span class="cp">#define writedatareg(val) { writereg(val,CSR0); }</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ni_vendor</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0x01</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">card</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id0</span><span class="p">,</span><span class="n">id1</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">id_offset</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">cmd_offset</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">addr_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vendor_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cardname</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">config</span><span class="p">;</span>
<span class="p">}</span> <span class="n">cards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id0</span>	     <span class="o">=</span> <span class="n">NI65_ID0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id1</span>	     <span class="o">=</span> <span class="n">NI65_ID1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id_offset</span>   <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">total_size</span>  <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmd_offset</span>  <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_offset</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor_id</span>   <span class="o">=</span> <span class="n">ni_vendor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cardname</span>    <span class="o">=</span> <span class="s">&quot;ni6510&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">config</span>	     <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
       	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id0</span>	     <span class="o">=</span> <span class="n">NI65_EB_ID0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id1</span>	     <span class="o">=</span> <span class="n">NI65_EB_ID1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id_offset</span>   <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">total_size</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmd_offset</span>  <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_offset</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor_id</span>   <span class="o">=</span> <span class="n">ni_vendor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cardname</span>    <span class="o">=</span> <span class="s">&quot;ni6510 EtherBlaster&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">config</span>	     <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
       	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id0</span>	     <span class="o">=</span> <span class="n">NE2100_ID0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id1</span>	     <span class="o">=</span> <span class="n">NE2100_ID1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id_offset</span>   <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">total_size</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cmd_offset</span>  <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_offset</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vendor_id</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cardname</span>    <span class="o">=</span> <span class="s">&quot;generic NE2100&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">config</span>	     <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define NUM_CARDS 3</span>

<span class="k">struct</span> <span class="n">priv</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rmd</span> <span class="n">rmdhead</span><span class="p">[</span><span class="n">RMDNUM</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tmd</span> <span class="n">tmdhead</span><span class="p">[</span><span class="n">TMDNUM</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">init_block</span> <span class="n">ib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rmdnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmdnum</span><span class="p">,</span><span class="n">tmdlast</span><span class="p">;</span>
<span class="cp">#ifdef RCV_VIA_SKB</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">RMDNUM</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">recvbounce</span><span class="p">[</span><span class="n">RMDNUM</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">TMDNUM</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">TMDNUM</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tmdbouncenum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span><span class="p">,</span><span class="n">xmit_queued</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdr_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cardno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">ring_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ni65_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ni65_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni65_recv_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni65_xmit_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ni65_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ni65_lance_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni65_init_lance</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ni65_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">ni65_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ni65_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ni65_alloc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ni65_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">irqtab</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span> <span class="p">};</span> <span class="cm">/* irq config-translate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmatab</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span> <span class="p">};</span> <span class="cm">/* dma config-translate and autodetect */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debuglevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * set &#39;performance&#39; registers .. we must STOP lance for that</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_set_performance</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">CSR0_STOP</span> <span class="o">|</span> <span class="n">CSR0_CLRALL</span><span class="p">,</span><span class="n">CSR0</span><span class="p">);</span> <span class="cm">/* STOP */</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">80</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span> <span class="p">(</span><span class="n">csr80</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="p">,</span><span class="mi">80</span><span class="p">);</span> <span class="cm">/* FIFO watermarks */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="kt">short</span><span class="p">)</span><span class="n">isa0</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_BUSIF</span><span class="p">);</span> <span class="cm">/* write ISA 0: DMA_R : isa0 * 50ns */</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="kt">short</span><span class="p">)</span><span class="n">isa1</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_BUSIF</span><span class="p">);</span> <span class="cm">/* write ISA 1: DMA_W : isa1 * 50ns	*/</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">CSR0</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">);</span>	<span class="cm">/* switch back to CSR0 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open interface (up)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni65_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irqval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ni65_interrupt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">cardname</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to get IRQ %d (irqval=%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		          <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">irqval</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ni65_lance_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * close interface (down)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni65_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_RESET</span><span class="p">),</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_RESET</span><span class="p">);</span> <span class="cm">/* that&#39;s the hard way */</span>

<span class="cp">#ifdef XMT_VIA_SKB</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
	<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set: io,irq,dma or set it when calling insmod */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Probe The Card (not the lance-chip)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">ni65_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x320</span><span class="p">,</span> <span class="mh">0x340</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Check a single specified location. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ni65_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Don&#39;t probe at all. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="n">ports</span><span class="p">;</span> <span class="o">*</span><span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="n">ni65_probe1</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">port</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out1:</span>
	<span class="n">cleanup_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ni65_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">ni65_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ni65_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ni65_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ni65_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * this is the real card probe ..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ni65_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">NUM_CARDS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_size</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cardname</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_offset</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id0</span> <span class="o">||</span>
				 <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id_offset</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id1</span><span class="p">)</span> <span class="p">{</span>
				 <span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
				 <span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr_offset</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_id</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
			  <span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">NUM_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr_offset</span><span class="o">+</span><span class="n">j</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">ni65_alloc_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">cmdr_addr</span> <span class="o">=</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd_offset</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s found at %#3x, &quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">cardname</span> <span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_RESET</span><span class="p">),</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_RESET</span><span class="p">);</span> <span class="cm">/* first: reset the card */</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">readreg</span><span class="p">(</span><span class="n">CSR0</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t RESET card: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		 <span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		 <span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">)</span> <span class="o">==</span> <span class="mi">88</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">89</span><span class="p">,</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_ADDRREG</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Version %#08lx, &quot;</span><span class="p">,</span><span class="n">v</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">INIT_RING_BEFORE_START</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ancient LANCE, &quot;</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">config</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irqtab</span><span class="p">[(</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">L_CONFIG</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dmatab</span><span class="p">[</span><span class="n">inw</span><span class="p">(</span><span class="n">ioaddr</span><span class="o">+</span><span class="n">L_CONFIG</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ %d (from card), DMA %d (from card).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;stuck test&#39; from lance.c */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_channels</span> <span class="o">=</span>
				<span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">DMA1_STAT_REG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DMA2_STAT_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">dmatab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dma_channels</span><span class="p">)</span> <span class="o">||</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span><span class="s">&quot;ni6510&quot;</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
				<span class="n">disable_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
				<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span><span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
				<span class="n">enable_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
				<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

				<span class="n">ni65_init_lance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* trigger memory access */</span>

				<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
				<span class="n">disable_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
				<span class="n">free_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
				<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

				<span class="k">if</span><span class="p">(</span><span class="n">readreg</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR0_IDON</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t detect DMA channel!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dmatab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMA %d (autodetected), &quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMA %d (assigned), &quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span><span class="p">;</span>

			<span class="n">ni65_init_lance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>
			<span class="n">writereg</span><span class="p">(</span><span class="n">CSR0_INIT</span><span class="o">|</span><span class="n">CSR0_INEA</span><span class="p">,</span><span class="n">CSR0</span><span class="p">);</span> <span class="cm">/* trigger interrupt */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to detect IRQ line!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ %d (autodetected).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ %d (assigned).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">cardname</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t request dma-channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">total_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ni65_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* everything is OK */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set lance register and trigger init</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_init_lance</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span><span class="kt">int</span> <span class="n">filter</span><span class="p">,</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pib</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">CSR0_CLRALL</span><span class="o">|</span><span class="n">CSR0_STOP</span><span class="p">,</span><span class="n">CSR0</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">eaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">daddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">filter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">trp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span><span class="p">)</span> <span class="o">|</span> <span class="n">TMDNUMMASK</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">rrp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span><span class="p">)</span> <span class="o">|</span> <span class="n">RMDNUMMASK</span><span class="p">;</span>
	<span class="n">writereg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">CSR3</span><span class="p">);</span>	<span class="cm">/* busmaster/no word-swap */</span>
	<span class="n">pib</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">pib</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span><span class="n">CSR1</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="n">pib</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span><span class="n">CSR2</span><span class="p">);</span>

	<span class="n">writereg</span><span class="p">(</span><span class="n">CSR0_INIT</span><span class="p">,</span><span class="n">CSR0</span><span class="p">);</span> <span class="cm">/* this changes L_ADDRREG to CSR0 */</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR0_IDON</span> <span class="o">|</span> <span class="n">CSR0_MERR</span><span class="p">)</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* init ok ? */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate memory area and check the 16MB border</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ni65_alloc_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">,</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">16</span><span class="o">+</span><span class="n">size</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unable to allocate %s memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">what</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">R_BUF_SIZE</span><span class="p">);</span>	 <span class="cm">/* grab the whole space .. (not necessary) */</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">T_BUF_SIZE</span><span class="p">,</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unable to allocate %s memory in lower 16MB!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">what</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate all memory structures .. send/recv buffers etc ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni65_alloc_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we need 8-aligned memory ..</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">ni65_alloc_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;BUFFER&quot;</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span><span class="p">));</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni65_alloc_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;XMIT&quot;</span><span class="p">,</span><span class="n">T_BUF_SIZE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cp">#ifdef RCV_VIA_SKB</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni65_alloc_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;RECV&quot;</span><span class="p">,</span><span class="n">R_BUF_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">recvbounce</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni65_alloc_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;RECV&quot;</span><span class="p">,</span><span class="n">R_BUF_SIZE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recvbounce</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ni65_free_buffer</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* everything is OK */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * free buffers and private struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cp">#ifdef RCV_VIA_SKB</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#else</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recvbounce</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * stop and (re)start lance .. e.g after an error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_stop_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">csr0</span> <span class="o">=</span> <span class="n">CSR0_INEA</span><span class="p">;</span>

	<span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_STOP</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ni65_stop_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">INIT_RING_BEFORE_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_save</span><span class="p">[</span><span class="n">TMDNUM</span><span class="p">];</span>
<span class="cp">#endif</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buffer</span><span class="p">[</span><span class="n">TMDNUM</span><span class="p">];</span>
		<span class="kt">short</span> <span class="n">blen</span><span class="p">[</span><span class="n">TMDNUM</span><span class="p">];</span>

		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">XMIT_OWN</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tmd</span> <span class="o">*</span><span class="n">tmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
			<span class="n">skb_save</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#endif</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_bus_to_virt</span><span class="p">(</span><span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">blen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">blen</span><span class="p">;</span>
			<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rmd</span> <span class="o">*</span><span class="n">rmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">RCV_OWN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_STRT</span> <span class="o">|</span> <span class="n">csr0</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span> <span class="cm">/* status is part of buffer field */</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">blen</span> <span class="o">=</span> <span class="n">blen</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">XMIT_OWN</span><span class="p">)</span> <span class="p">{</span>
				 <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
				 <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_TDMD</span> <span class="o">|</span> <span class="n">CSR0_INEA</span> <span class="o">|</span> <span class="n">csr0</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb_save</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_STRT</span> <span class="o">|</span> <span class="n">csr0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init lance (write init-values .. init-buffers) (open-helper)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ni65_lance_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	 <span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	 <span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	 <span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	 <span class="n">disable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span> <span class="cm">/* I&#39;ve never worked with dma, but we do it like the packetdriver */</span>
	 <span class="n">set_dma_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span><span class="n">DMA_MODE_CASCADE</span><span class="p">);</span>
	 <span class="n">enable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	 <span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	 <span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_RESET</span><span class="p">),</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_RESET</span><span class="p">);</span> <span class="cm">/* first: reset the card */</span>
	 <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">readreg</span><span class="p">(</span><span class="n">CSR0</span><span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="mh">0x4</span><span class="p">)</span>
	 <span class="p">{</span>
		 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t RESET %s card: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
							<span class="n">cards</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cardno</span><span class="p">].</span><span class="n">cardname</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">i</span><span class="p">);</span>
		 <span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
		 <span class="n">disable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		 <span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="p">}</span>

	 <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbouncenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	 <span class="p">{</span>
		 <span class="k">struct</span> <span class="n">tmd</span> <span class="o">*</span><span class="n">tmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef XMT_VIA_SKB</span>
		 <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			 <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			 <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		 <span class="p">}</span>
<span class="cp">#endif</span>
		 <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		 <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">XMIT_START</span> <span class="o">|</span> <span class="n">XMIT_END</span><span class="p">;</span>
		 <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">blen</span> <span class="o">=</span> <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	 <span class="p">}</span>

	 <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	 <span class="p">{</span>
		 <span class="k">struct</span> <span class="n">rmd</span> <span class="o">*</span><span class="n">rmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef RCV_VIA_SKB</span>
		 <span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#else</span>
		 <span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recvbounce</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif</span>
		 <span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">blen</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">R_BUF_SIZE</span><span class="o">-</span><span class="mi">8</span><span class="p">);</span>
		 <span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">mlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">RCV_OWN</span><span class="p">;</span>
	 <span class="p">}</span>

	 <span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		 <span class="n">ni65_init_lance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="n">M_PROM</span><span class="p">);</span>
	 <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		 <span class="n">ni65_init_lance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x0</span><span class="p">);</span>
	 <span class="k">else</span>
		 <span class="n">ni65_init_lance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ni65_set_lance_mem() sets L_ADDRREG to CSR0</span>
<span class="cm">	 * NOW, WE WILL NEVER CHANGE THE L_ADDRREG, CSR0 IS ALWAYS SELECTED</span>
<span class="cm">	 */</span>

	 <span class="k">if</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR0_IDON</span><span class="p">)</span>	<span class="p">{</span>
		 <span class="n">ni65_set_performance</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
					 <span class="cm">/* init OK: start lance , enable interrupts */</span>
		 <span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_CLRALL</span> <span class="o">|</span> <span class="n">CSR0_INEA</span> <span class="o">|</span> <span class="n">CSR0_STRT</span><span class="p">);</span>
		 <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* -&gt;OK */</span>
	 <span class="p">}</span>
	 <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t init lance, status: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">));</span>
	 <span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	 <span class="n">disable_dma</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	 <span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* -&gt;Error */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ni65_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">csr0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bcnt</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">bcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csr0</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		writedatareg( (csr0 &amp; CSR0_CLRALL) ); /* ack interrupts, disable int. */</span>
<span class="cp">#else</span>
		<span class="n">writedatareg</span><span class="p">(</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_CLRALL</span><span class="p">)</span> <span class="o">|</span> <span class="n">CSR0_INEA</span> <span class="p">);</span> <span class="cm">/* ack interrupts, interrupts enabled */</span>
<span class="cp">#endif</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR0_ERR</span> <span class="o">|</span> <span class="n">CSR0_RINT</span> <span class="o">|</span> <span class="n">CSR0_TINT</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_RINT</span><span class="p">)</span> <span class="cm">/* RECV-int? */</span>
			<span class="n">ni65_recv_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">csr0</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_TINT</span><span class="p">)</span> <span class="cm">/* XMIT-int? */</span>
			<span class="n">ni65_xmit_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">csr0</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_ERR</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: general error: %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">csr0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_BABL</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_MISS</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_MERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Ooops .. memory error: %04x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">csr0</span><span class="p">);</span>
				<span class="n">ni65_stop_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef RCV_PARANOIA_CHECK</span>
<span class="p">{</span>
 <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
 <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
 <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">num2</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">RMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">num2</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		 <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span><span class="p">[</span><span class="n">num2</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RCV_OWN</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">num1</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num1</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span><span class="p">[</span><span class="n">num1</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RCV_OWN</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">k</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span><span class="o">*</span><span class="n">buf1</span><span class="p">;</span>
			<span class="n">buf1</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="n">RMDNUM</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span><span class="s">&quot;%02x &quot;</span><span class="p">,(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span><span class="p">));</span> <span class="cm">/* &amp; RCV_OWN) ); */</span>
				<span class="n">buf1</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">buf1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Ooops, receive ring corrupted %2d %2d | %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">=</span> <span class="n">num1</span><span class="p">;</span>
		<span class="n">ni65_recv_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">csr0</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span><span class="p">[</span><span class="n">num2</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RCV_OWN</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* ok, we are &#39;in sync&#39; again */</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">break</span><span class="p">;</span>
 <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR0_RXON</span> <span class="o">|</span> <span class="n">CSR0_TXON</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">CSR0_RXON</span> <span class="o">|</span> <span class="n">CSR0_TXON</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX or TX was offline -&gt; restart</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ni65_stop_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_INEA</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have received an Xmit-Interrupt ..</span>
<span class="cm"> * send a new packet if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_xmit_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">csr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">tmd</span> <span class="o">*</span><span class="n">tmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmdstat</span> <span class="o">=</span> <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">tmdstat</span> <span class="o">&amp;</span> <span class="n">XMIT_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">tmdstat</span> <span class="o">&amp;</span> <span class="n">XMIT_ERR</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if(tmdp-&gt;status2 &amp; XMIT_TDRMASK &amp;&amp; debuglevel &gt; 3)</span>
<span class="c">				printk(KERN_ERR &quot;%s: tdr-problems (e.g. no resistor)\n&quot;,dev-&gt;name);</span>
<span class="cp">#endif</span>
		 <span class="cm">/* checking some errors */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">XMIT_RTRY</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">XMIT_LCAR</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XMIT_BUFF</span> <span class="o">|</span> <span class="n">XMIT_UFLO</span> <span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this stops the xmitter */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Xmit FIFO/BUFF error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">INIT_RING_BEFORE_START</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">XMIT_OWN</span> <span class="o">|</span> <span class="n">XMIT_START</span> <span class="o">|</span> <span class="n">XMIT_END</span><span class="p">;</span>	<span class="cm">/* test: resend this frame */</span>
					<span class="n">ni65_stop_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>	<span class="cm">/* no more Xmit processing .. */</span>
				<span class="p">}</span>
				<span class="k">else</span>
				 <span class="n">ni65_stop_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: xmit-error: %04x %02x-%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">csr0</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tmdstat</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_BABL</span><span class="p">))</span> <span class="cm">/* don&#39;t count errors twice */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">blen</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef XMT_VIA_SKB</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">])</span> <span class="p">{</span>
			 <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">]);</span>
			 <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span><span class="p">)</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have received a packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_recv_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">csr0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rmd</span> <span class="o">*</span><span class="n">rmdp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rmdstat</span><span class="p">,</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">rmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span> <span class="p">(</span><span class="n">rmdstat</span> <span class="o">=</span> <span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCV_OWN</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RCV_START</span> <span class="o">|</span> <span class="n">RCV_END</span> <span class="o">|</span> <span class="n">RCV_ERR</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">RCV_START</span> <span class="o">|</span> <span class="n">RCV_END</span><span class="p">)</span> <span class="p">)</span> <span class="cm">/* error or oversized? */</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="n">RCV_ERR</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="n">RCV_START</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: recv, packet too long: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">mlen</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="n">debuglevel</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: receive-error: %04x, lance-status: %04x/%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
									<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rmdstat</span><span class="p">,</span><span class="n">csr0</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">inw</span><span class="p">(</span><span class="n">PORT</span><span class="o">+</span><span class="n">L_DATAREG</span><span class="p">)</span> <span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="n">RCV_FRAM</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="n">RCV_OFLO</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="n">RCV_CRC</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="n">rmdstat</span> <span class="o">&amp;</span> <span class="n">RCV_BUF_ERR</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">CSR0_MISS</span><span class="p">))</span> <span class="cm">/* don&#39;t count errors twice */</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">mlen</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cp">#ifdef RCV_VIA_SKB</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">R_BUF_SIZE</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span><span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="cp">#ifdef RCV_VIA_SKB</span>
				<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">R_BUF_SIZE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
					<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span><span class="n">len</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb1</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">];</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">R_BUF_SIZE</span><span class="p">);</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">recv_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
					<span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="n">skb1</span><span class="p">;</span>
					<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#else</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">recvbounce</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">],</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">=</span><span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t alloc new sk_buff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: received runt packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">blen</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">R_BUF_SIZE</span><span class="o">-</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">mlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">RCV_OWN</span><span class="p">;</span> <span class="cm">/* change owner */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdhead</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rmdnum</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kick xmitter ..</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ni65_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: xmitter timed out, try to restart!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TMDNUM</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ni65_lance_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Send a packet</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ni65_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">priv</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Queue was locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="kt">short</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">tmd</span> <span class="o">*</span><span class="n">tmdp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef XMT_VIA_SKB</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>

			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbouncenum</span><span class="p">],</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">T_BUF_SIZE</span> <span class="o">?</span> <span class="n">T_BUF_SIZE</span> <span class="o">:</span>
							      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
				<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbouncenum</span><span class="p">]</span><span class="o">+</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span><span class="p">;</span>
			<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbounce</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbouncenum</span><span class="p">]);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbouncenum</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdbouncenum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMDNUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

<span class="cp">#ifdef XMT_VIA_SKB</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">tmdp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdhead</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span><span class="p">;</span>
			<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">isa_virt_to_bus</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmd_skb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">blen</span> <span class="o">=</span> <span class="o">-</span><span class="n">len</span><span class="p">;</span>

		<span class="n">tmdp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">XMIT_OWN</span> <span class="o">|</span> <span class="n">XMIT_START</span> <span class="o">|</span> <span class="n">XMIT_END</span><span class="p">;</span>
		<span class="n">writedatareg</span><span class="p">(</span><span class="n">CSR0_TDMD</span> <span class="o">|</span> <span class="n">CSR0_INEA</span><span class="p">);</span> <span class="cm">/* enable xmit &amp; interrupt */</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">xmit_queued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TMDNUM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdnum</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">tmdlast</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ring_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ni65_lance_reinit</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t switch card into MC mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev_ni65</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;ni6510 IRQ number (ignored for some cards)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;ni6510 I/O base address&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;ni6510 ISA DMA channel (ignored for some cards)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="n">dev_ni65</span> <span class="o">=</span> <span class="n">ni65_probe</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev_ni65</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev_ni65</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev_ni65</span><span class="p">);</span>
 	<span class="n">cleanup_card</span><span class="p">(</span><span class="n">dev_ni65</span><span class="p">);</span>
 	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev_ni65</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
