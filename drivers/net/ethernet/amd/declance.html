<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › amd › declance.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>declance.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Lance ethernet driver for the MIPS processor based</span>
<span class="cm"> *      DECstation family</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *      adopted from sunlance.c by Richard van den Berg</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2002, 2003, 2005, 2006  Maciej W. Rozycki</span>
<span class="cm"> *</span>
<span class="cm"> *      additional sources:</span>
<span class="cm"> *      - PMAD-AA TURBOchannel Ethernet Module Functional Specification,</span>
<span class="cm"> *        Revision 1.2</span>
<span class="cm"> *</span>
<span class="cm"> *      History:</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.001: The kernel accepts the code and it shows the hardware address.</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.002: Removed most sparc stuff, left only some module and dma stuff.</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.003: Enhanced base address calculation from proposals by</span>
<span class="cm"> *              Harald Koerfgen and Thomas Riemer.</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.004: lance-regs is pointing at the right addresses, added prom</span>
<span class="cm"> *              check. First start of address mapping and DMA.</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.005: started to play around with LANCE-DMA. This driver will not</span>
<span class="cm"> *              work for non IOASIC lances. HK</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.006: added pointer arrays to lance_private and setup routine for</span>
<span class="cm"> *              them in dec_lance_init. HK</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.007: Big shit. The LANCE seems to use a different DMA mechanism to</span>
<span class="cm"> *              access the init block. This looks like one (short) word at a</span>
<span class="cm"> *              time, but the smallest amount the IOASIC can transfer is a</span>
<span class="cm"> *              (long) word. So we have a 2-2 padding here. Changed</span>
<span class="cm"> *              lance_init_block accordingly. The 16-16 padding for the buffers</span>
<span class="cm"> *              seems to be correct. HK</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.008: mods to make PMAX_LANCE work. 01/09/1999 triemer</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.009: Module support fixes, multiple interfaces support, various</span>
<span class="cm"> *              bits. macro</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.010: Fixes for the PMAD mapping of the LANCE buffer and for the</span>
<span class="cm"> *              PMAX requirement to only use halfword accesses to the</span>
<span class="cm"> *              buffer. macro</span>
<span class="cm"> *</span>
<span class="cm"> *      v0.011: Converted the PMAD to the driver model. macro</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/tc.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;asm/addrspace.h&gt;</span>

<span class="cp">#include &lt;asm/dec/interrupts.h&gt;</span>
<span class="cp">#include &lt;asm/dec/ioasic.h&gt;</span>
<span class="cp">#include &lt;asm/dec/ioasic_addrs.h&gt;</span>
<span class="cp">#include &lt;asm/dec/kn01.h&gt;</span>
<span class="cp">#include &lt;asm/dec/machtype.h&gt;</span>
<span class="cp">#include &lt;asm/dec/system.h&gt;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="s">&quot;declance.c: v0.011 by Linux MIPS DECstation task force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linux MIPS DECstation task force&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DEC LANCE (DECstation onboard, PMAD-xx) driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define __unused __attribute__ ((unused))</span>

<span class="cm">/*</span>
<span class="cm"> * card types</span>
<span class="cm"> */</span>
<span class="cp">#define ASIC_LANCE 1</span>
<span class="cp">#define PMAD_LANCE 2</span>
<span class="cp">#define PMAX_LANCE 3</span>


<span class="cp">#define LE_CSR0 0</span>
<span class="cp">#define LE_CSR1 1</span>
<span class="cp">#define LE_CSR2 2</span>
<span class="cp">#define LE_CSR3 3</span>

<span class="cp">#define LE_MO_PROM      0x8000	</span><span class="cm">/* Enable promiscuous mode */</span><span class="cp"></span>

<span class="cp">#define	LE_C0_ERR	0x8000	</span><span class="cm">/* Error: set if BAB, SQE, MISS or ME is set */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_BABL	0x4000	</span><span class="cm">/* BAB:  Babble: tx timeout. */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_CERR	0x2000	</span><span class="cm">/* SQE:  Signal quality error */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_MISS	0x1000	</span><span class="cm">/* MISS: Missed a packet */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_MERR	0x0800	</span><span class="cm">/* ME:   Memory error */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_RINT	0x0400	</span><span class="cm">/* Received interrupt */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_TINT	0x0200	</span><span class="cm">/* Transmitter Interrupt */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_IDON	0x0100	</span><span class="cm">/* IFIN: Init finished. */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_INTR	0x0080	</span><span class="cm">/* Interrupt or error */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_INEA	0x0040	</span><span class="cm">/* Interrupt enable */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_RXON	0x0020	</span><span class="cm">/* Receiver on */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_TXON	0x0010	</span><span class="cm">/* Transmitter on */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_TDMD	0x0008	</span><span class="cm">/* Transmitter demand */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_STOP	0x0004	</span><span class="cm">/* Stop the card */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_STRT	0x0002	</span><span class="cm">/* Start the card */</span><span class="cp"></span>
<span class="cp">#define	LE_C0_INIT	0x0001	</span><span class="cm">/* Init the card */</span><span class="cp"></span>

<span class="cp">#define	LE_C3_BSWP	0x4	</span><span class="cm">/* SWAP */</span><span class="cp"></span>
<span class="cp">#define	LE_C3_ACON	0x2	</span><span class="cm">/* ALE Control */</span><span class="cp"></span>
<span class="cp">#define	LE_C3_BCON	0x1	</span><span class="cm">/* Byte control */</span><span class="cp"></span>

<span class="cm">/* Receive message descriptor 1 */</span>
<span class="cp">#define LE_R1_OWN	0x8000	</span><span class="cm">/* Who owns the entry */</span><span class="cp"></span>
<span class="cp">#define LE_R1_ERR	0x4000	</span><span class="cm">/* Error: if FRA, OFL, CRC or BUF is set */</span><span class="cp"></span>
<span class="cp">#define LE_R1_FRA	0x2000	</span><span class="cm">/* FRA: Frame error */</span><span class="cp"></span>
<span class="cp">#define LE_R1_OFL	0x1000	</span><span class="cm">/* OFL: Frame overflow */</span><span class="cp"></span>
<span class="cp">#define LE_R1_CRC	0x0800	</span><span class="cm">/* CRC error */</span><span class="cp"></span>
<span class="cp">#define LE_R1_BUF	0x0400	</span><span class="cm">/* BUF: Buffer error */</span><span class="cp"></span>
<span class="cp">#define LE_R1_SOP	0x0200	</span><span class="cm">/* Start of packet */</span><span class="cp"></span>
<span class="cp">#define LE_R1_EOP	0x0100	</span><span class="cm">/* End of packet */</span><span class="cp"></span>
<span class="cp">#define LE_R1_POK	0x0300	</span><span class="cm">/* Packet is complete: SOP + EOP */</span><span class="cp"></span>

<span class="cm">/* Transmit message descriptor 1 */</span>
<span class="cp">#define LE_T1_OWN	0x8000	</span><span class="cm">/* Lance owns the packet */</span><span class="cp"></span>
<span class="cp">#define LE_T1_ERR	0x4000	</span><span class="cm">/* Error summary */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EMORE	0x1000	</span><span class="cm">/* Error: more than one retry needed */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EONE	0x0800	</span><span class="cm">/* Error: one retry needed */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EDEF	0x0400	</span><span class="cm">/* Error: deferred */</span><span class="cp"></span>
<span class="cp">#define LE_T1_SOP	0x0200	</span><span class="cm">/* Start of packet */</span><span class="cp"></span>
<span class="cp">#define LE_T1_EOP	0x0100	</span><span class="cm">/* End of packet */</span><span class="cp"></span>
<span class="cp">#define LE_T1_POK	0x0300	</span><span class="cm">/* Packet is complete: SOP + EOP */</span><span class="cp"></span>

<span class="cp">#define LE_T3_BUF       0x8000	</span><span class="cm">/* Buffer error */</span><span class="cp"></span>
<span class="cp">#define LE_T3_UFL       0x4000	</span><span class="cm">/* Error underflow */</span><span class="cp"></span>
<span class="cp">#define LE_T3_LCOL      0x1000	</span><span class="cm">/* Error late collision */</span><span class="cp"></span>
<span class="cp">#define LE_T3_CLOS      0x0800	</span><span class="cm">/* Error carrier loss */</span><span class="cp"></span>
<span class="cp">#define LE_T3_RTY       0x0400	</span><span class="cm">/* Error retry */</span><span class="cp"></span>
<span class="cp">#define LE_T3_TDR       0x03ff	</span><span class="cm">/* Time Domain Reflectometry counter */</span><span class="cp"></span>

<span class="cm">/* Define: 2^4 Tx buffers and 2^4 Rx buffers */</span>

<span class="cp">#ifndef LANCE_LOG_TX_BUFFERS</span>
<span class="cp">#define LANCE_LOG_TX_BUFFERS 4</span>
<span class="cp">#define LANCE_LOG_RX_BUFFERS 4</span>
<span class="cp">#endif</span>

<span class="cp">#define TX_RING_SIZE			(1 &lt;&lt; (LANCE_LOG_TX_BUFFERS))</span>
<span class="cp">#define TX_RING_MOD_MASK		(TX_RING_SIZE - 1)</span>

<span class="cp">#define RX_RING_SIZE			(1 &lt;&lt; (LANCE_LOG_RX_BUFFERS))</span>
<span class="cp">#define RX_RING_MOD_MASK		(RX_RING_SIZE - 1)</span>

<span class="cp">#define PKT_BUF_SZ		1536</span>
<span class="cp">#define RX_BUFF_SIZE            PKT_BUF_SZ</span>
<span class="cp">#define TX_BUFF_SIZE            PKT_BUF_SZ</span>

<span class="cp">#undef TEST_HITS</span>
<span class="cp">#define ZERO 0</span>

<span class="cm">/*</span>
<span class="cm"> * The DS2100/3100 have a linear 64 kB buffer which supports halfword</span>
<span class="cm"> * accesses only.  Each halfword of the buffer is word-aligned in the</span>
<span class="cm"> * CPU address space.</span>
<span class="cm"> *</span>
<span class="cm"> * The PMAD-AA has a 128 kB buffer on-board.</span>
<span class="cm"> *</span>
<span class="cm"> * The IOASIC LANCE devices use a shared memory region.  This region</span>
<span class="cm"> * as seen from the CPU is (max) 128 kB long and has to be on an 128 kB</span>
<span class="cm"> * boundary.  The LANCE sees this as a 64 kB long continuous memory</span>
<span class="cm"> * region.</span>
<span class="cm"> *</span>
<span class="cm"> * The LANCE&#39;s DMA address is used as an index in this buffer and DMA</span>
<span class="cm"> * takes place in bursts of eight 16-bit words which are packed into</span>
<span class="cm"> * four 32-bit words by the IOASIC.  This leads to a strange padding:</span>
<span class="cm"> * 16 bytes of valid data followed by a 16 byte gap :-(.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">lance_rx_desc</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rmd0</span><span class="p">;</span>		<span class="cm">/* low address of packet */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rmd1</span><span class="p">;</span>		<span class="cm">/* high address of packet</span>
<span class="cm">					   and descriptor bits */</span>
	<span class="kt">short</span> <span class="n">length</span><span class="p">;</span>			<span class="cm">/* 2s complement (negative!)</span>
<span class="cm">					   of buffer length */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mblength</span><span class="p">;</span>	<span class="cm">/* actual number of bytes received */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lance_tx_desc</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmd0</span><span class="p">;</span>		<span class="cm">/* low address of packet */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmd1</span><span class="p">;</span>		<span class="cm">/* high address of packet</span>
<span class="cm">					   and descriptor bits */</span>
	<span class="kt">short</span> <span class="n">length</span><span class="p">;</span>			<span class="cm">/* 2s complement (negative!)</span>
<span class="cm">					   of buffer length */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">misc</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* First part of the LANCE initialization block, described in databook. */</span>
<span class="k">struct</span> <span class="n">lance_init_block</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mode</span><span class="p">;</span>		<span class="cm">/* pre-set mode (reg. 15) */</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* physical ethernet address */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">filter</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* multicast filter */</span>

	<span class="cm">/* Receive and transmit ring base, along with extra bits. */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_ptr</span><span class="p">;</span>		<span class="cm">/* receive descriptor addr */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rx_len</span><span class="p">;</span>		<span class="cm">/* receive len and high addr */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_ptr</span><span class="p">;</span>		<span class="cm">/* transmit descriptor addr */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tx_len</span><span class="p">;</span>		<span class="cm">/* transmit len and high addr */</span>

	<span class="kt">short</span> <span class="n">gap</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* The buffer descriptors */</span>
	<span class="k">struct</span> <span class="n">lance_rx_desc</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lance_tx_desc</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define BUF_OFFSET_CPU sizeof(struct lance_init_block)</span>
<span class="cp">#define BUF_OFFSET_LNC sizeof(struct lance_init_block)</span>

<span class="cp">#define shift_off(off, type)						\</span>
<span class="cp">	(type == ASIC_LANCE || type == PMAX_LANCE ? off &lt;&lt; 1 : off)</span>

<span class="cp">#define lib_off(rt, type)						\</span>
<span class="cp">	shift_off(offsetof(struct lance_init_block, rt), type)</span>

<span class="cp">#define lib_ptr(ib, rt, type) 						\</span>
<span class="cp">	((volatile u16 *)((u8 *)(ib) + lib_off(rt, type)))</span>

<span class="cp">#define rds_off(rt, type)						\</span>
<span class="cp">	shift_off(offsetof(struct lance_rx_desc, rt), type)</span>

<span class="cp">#define rds_ptr(rd, rt, type) 						\</span>
<span class="cp">	((volatile u16 *)((u8 *)(rd) + rds_off(rt, type)))</span>

<span class="cp">#define tds_off(rt, type)						\</span>
<span class="cp">	shift_off(offsetof(struct lance_tx_desc, rt), type)</span>

<span class="cp">#define tds_ptr(td, rt, type) 						\</span>
<span class="cp">	((volatile u16 *)((u8 *)(td) + tds_off(rt, type)))</span>

<span class="k">struct</span> <span class="n">lance_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_irq</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span><span class="p">;</span>

	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">rx_new</span><span class="p">,</span> <span class="n">tx_new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_old</span><span class="p">,</span> <span class="n">tx_old</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">busmaster_regval</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>       <span class="n">multicast_timer</span><span class="p">;</span>

	<span class="cm">/* Pointers to the ring buffers as seen from the CPU */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rx_buf_ptr_cpu</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf_ptr_cpu</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>

	<span class="cm">/* Pointers to the ring buffers as seen from the LANCE */</span>
	<span class="n">uint</span> <span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">tx_buf_ptr_lnc</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define TX_BUFFS_AVAIL ((lp-&gt;tx_old&lt;=lp-&gt;tx_new)?\</span>
<span class="cp">			lp-&gt;tx_old+TX_RING_MOD_MASK-lp-&gt;tx_new:\</span>
<span class="cp">			lp-&gt;tx_old - lp-&gt;tx_new-1)</span>

<span class="cm">/* The lance control ports are at an absolute address, machine and tc-slot</span>
<span class="cm"> * dependent.</span>
<span class="cm"> * DECstations do only 32-bit access and the LANCE uses 16 bit addresses,</span>
<span class="cm"> * so we have to give the structure an extra member making rap pointing</span>
<span class="cm"> * at the right address</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lance_regs</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rdp</span><span class="p">;</span>	<span class="cm">/* register data port */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pad</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rap</span><span class="p">;</span>	<span class="cm">/* register address port */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">dec_lance_debug</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tc_driver</span> <span class="n">dec_lance_tc_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">root_lance_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">writereg</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">regptr</span><span class="p">,</span> <span class="kt">short</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">regptr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">iob</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Load the CSR registers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">load_csrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">leptr</span><span class="p">;</span>

	<span class="cm">/* The address space as seen from the LANCE</span>
<span class="cm">	 * begins at address 0. HK</span>
<span class="cm">	 */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR1</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="p">(</span><span class="n">leptr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR2</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR3</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">busmaster_regval</span><span class="p">);</span>

	<span class="cm">/* Point back to csr0 */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Our specialized copy routines</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp_to_buf</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rtp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rfp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PMAD_LANCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PMAX_LANCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rtp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">rfp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rtp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">rfp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * copy 16 Byte chunks</span>
<span class="cm">		 */</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * do the rest, if any.</span>
<span class="cm">		 */</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">rtp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">rfp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rtp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">rfp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iob</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cp_from_buf</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">clen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rtp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rfp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PMAD_LANCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PMAX_LANCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">fp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">rtp</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">rfp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rtp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">rfp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * copy 16 Byte chunks</span>
<span class="cm">		 */</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">to</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">fp</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * do the rest, if any.</span>
<span class="cm">		 */</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">rtp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">tp</span><span class="p">;</span>
		<span class="n">rfp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">clen</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rtp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">rfp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>


	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Setup the Lance Rx and Tx rings */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">leptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Lock out other processes while setting up hardware */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_old</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy the ethernet address to the lance init block.</span>
<span class="cm">	 * XXX bit 0 of the physical address registers has to be zero</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="cm">/* Setup the initialization block */</span>

	<span class="cm">/* Setup rx descriptor pointer */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_init_block</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">);</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">LANCE_LOG_RX_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">rx_ptr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ZERO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RX ptr: %8.8x(%8.8x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">leptr</span><span class="p">,</span> <span class="n">lib_off</span><span class="p">(</span><span class="n">brx_ring</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>

	<span class="cm">/* Setup tx descriptor pointer */</span>
	<span class="n">leptr</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_init_block</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">);</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">LANCE_LOG_TX_BUFFERS</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">tx_ptr</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ZERO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX ptr: %8.8x(%8.8x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">leptr</span><span class="p">,</span> <span class="n">lib_off</span><span class="p">(</span><span class="n">btx_ring</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ZERO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX rings:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Setup the Tx ring entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
							   <span class="mh">0xff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xf000</span><span class="p">;</span>
						<span class="cm">/* The ones required by tmd2 */</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">misc</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">ZERO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d: 0x%8.8x(0x%8.8x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">leptr</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the Rx ring entries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ZERO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RX rings:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leptr</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd0</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="n">leptr</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="n">leptr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
							    <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
							   <span class="n">LE_R1_OWN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">RX_BUFF_SIZE</span> <span class="o">|</span>
							     <span class="mh">0xf000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mblength</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">ZERO</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d: 0x%8.8x(0x%8.8x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">leptr</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">iob</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_restart_lance</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_INIT</span><span class="p">);</span>

	<span class="cm">/* Wait for the lance to complete initialization */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span> <span class="o">&amp;</span> <span class="n">LE_C0_IDON</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span> <span class="o">&amp;</span> <span class="n">LE_C0_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;LANCE unopened after %d ticks, csr0=%4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span> <span class="o">&amp;</span> <span class="n">LE_C0_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;LANCE unopened after %d ticks, csr0=%4.4x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_IDON</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STRT</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_INEA</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="cp">#ifdef TEST_HITS</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1</span><span class="p">,</span>
						      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span>
					     <span class="n">LE_R1_OWN</span> <span class="o">?</span> <span class="s">&quot;_&quot;</span> <span class="o">:</span> <span class="s">&quot;X&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rmd1</span><span class="p">,</span>
						      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span>
					     <span class="n">LE_R1_OWN</span> <span class="o">?</span> <span class="s">&quot;.&quot;</span> <span class="o">:</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	     <span class="o">!</span><span class="p">((</span><span class="n">bits</span> <span class="o">=</span> <span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">rmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LE_R1_OWN</span><span class="p">);</span>
	     <span class="n">rd</span> <span class="o">=</span> <span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">brx_ring</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span><span class="p">;</span>

		<span class="cm">/* We got an incomplete frame? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_POK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LE_R1_POK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Count only the end frame as a rx error,</span>
<span class="cm">			 * not the beginning</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_BUF</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_CRC</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_OFL</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_FRA</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">LE_R1_EOP</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">mblength</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Memory squeeze, deferring packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">mblength</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">rmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span>
					 <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">LE_R1_OWN</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_RING_MOD_MASK</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* 16 byte align */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>	<span class="cm">/* make room */</span>

			<span class="n">cp_from_buf</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_cpu</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Return the packet to the pool */</span>
		<span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">mblength</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">RX_BUFF_SIZE</span> <span class="o">|</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rds_ptr</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">rmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">LE_R1_OWN</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_RING_MOD_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="cm">/* If we hit a packet not owned by us, stop */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LE_T1_OWN</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LE_T1_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">misc</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_RTY</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_LCOL</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LE_T3_CLOS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Carrier Lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* Stop the lance */</span>
				<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
				<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>
				<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Buffer errors and underflows turn off the</span>
<span class="cm">			 * transmitter, restart the adapter.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LE_T3_BUF</span> <span class="o">|</span> <span class="n">LE_T3_UFL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Tx: ERR_BUF|ERR_UFL, restarting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* Stop the lance */</span>
				<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
				<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>
				<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LE_T1_POK</span><span class="p">)</span> <span class="o">==</span>
			   <span class="n">LE_T1_POK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * So we don&#39;t count the packet more than once.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LE_T1_POK</span><span class="p">);</span>

			<span class="cm">/* One collision before packet was sent. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LE_T1_EONE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* More than one collision, be optimistic. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tds_ptr</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LE_T1_EMORE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">TX_BUFFS_AVAIL</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lance_dma_merr_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: DMA error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lance_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">csr0</span><span class="p">;</span>

	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
	<span class="n">csr0</span> <span class="o">=</span> <span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">;</span>

	<span class="cm">/* Acknowledge all the interrupt sources ASAP */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LE_C0_INTR</span> <span class="o">|</span> <span class="n">LE_C0_TINT</span> <span class="o">|</span> <span class="n">LE_C0_RINT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clear the error condition */</span>
		<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_BABL</span> <span class="o">|</span> <span class="n">LE_C0_ERR</span> <span class="o">|</span> <span class="n">LE_C0_MISS</span> <span class="o">|</span>
			 <span class="n">LE_C0_CERR</span> <span class="o">|</span> <span class="n">LE_C0_MERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_RINT</span><span class="p">)</span>
		<span class="n">lance_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_TINT</span><span class="p">)</span>
		<span class="n">lance_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_BABL</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_MISS</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">LE_C0_MERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Memory error, status %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">csr0</span><span class="p">);</span>

		<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>

		<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_INEA</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_INEA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Stop the Lance */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>

	<span class="cm">/* Set mode and clear multicast filter only at device open,</span>
<span class="cm">	 * so that lance_init_ring() called at any error will not</span>
<span class="cm">	 * forget multicast filters.</span>
<span class="cm">	 *</span>
<span class="cm">	 * BTW it is common bug in all lance drivers! --ANK</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Associate IRQ with lance_interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lance_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;lance&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span><span class="p">,</span> <span class="n">lance_dma_merr_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;lance error&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t get DMA IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioasic_ssr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">fast_mb</span><span class="p">();</span>
		<span class="cm">/* Enable I/O ASIC LANCE DMA.  */</span>
		<span class="n">ioasic_write</span><span class="p">(</span><span class="n">IO_REG_SSR</span><span class="p">,</span>
			     <span class="n">ioasic_read</span><span class="p">(</span><span class="n">IO_REG_SSR</span><span class="p">)</span> <span class="o">|</span> <span class="n">IO_SSR_LANCE_DMA_EN</span><span class="p">);</span>

		<span class="n">fast_mb</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioasic_ssr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">);</span>

	<span class="cm">/* Stop the card */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioasic_ssr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">fast_mb</span><span class="p">();</span>
		<span class="cm">/* Disable I/O ASIC LANCE DMA.  */</span>
		<span class="n">ioasic_write</span><span class="p">(</span><span class="n">IO_REG_SSR</span><span class="p">,</span>
			     <span class="n">ioasic_read</span><span class="p">(</span><span class="n">IO_REG_SSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IO_SSR_LANCE_DMA_EN</span><span class="p">);</span>

		<span class="n">fast_iob</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioasic_ssr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lance_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Stop the lance */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>

	<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: transmit timed out, status %04x, reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">);</span>
	<span class="n">lance_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lance_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">misc</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cp_to_buf</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_cpu</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Now, give the packet to the lance */</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">btx_ring</span><span class="p">[</span><span class="n">entry</span><span class="p">].</span><span class="n">tmd1</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_lnc</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">LE_T1_POK</span> <span class="o">|</span> <span class="n">LE_T1_OWN</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_RING_MOD_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TX_BUFFS_AVAIL</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Kick the lance: transmit now */</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_INEA</span> <span class="o">|</span> <span class="n">LE_C0_TDMD</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

 	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_load_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>

	<span class="cm">/* set all multicast bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* clear the multicast filter */</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Add addresses */</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">filter</span><span class="p">[</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">],</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_set_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_old</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rap</span><span class="p">,</span> <span class="n">LE_CSR0</span><span class="p">);</span>
	<span class="n">writereg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ll</span><span class="o">-&gt;</span><span class="n">rdp</span><span class="p">,</span> <span class="n">LE_C0_STOP</span><span class="p">);</span>

	<span class="n">lance_init_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">|=</span> <span class="n">LE_MO_PROM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lib_ptr</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LE_MO_PROM</span><span class="p">;</span>
		<span class="n">lance_load_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">load_csrs</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">init_restart_lance</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lance_set_multicast_retry</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">_opaque</span><span class="p">;</span>

	<span class="n">lance_set_multicast</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">lance_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">lance_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">lance_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">lance_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">lance_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">lance_set_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dec_lance_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">version_printed</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fmt</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;declance%d&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="n">ll</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esar_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">esar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dec_lance_debug</span> <span class="o">&amp;&amp;</span> <span class="n">version_printed</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">root_lance_dev</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lance_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * alloc_etherdev ensures the data structures used by the LANCE</span>
<span class="cm">	 * are aligned.</span>
<span class="cm">	 */</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASIC_LANCE</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="n">dec_kn_slot_base</span> <span class="o">+</span> <span class="n">IOASIC_LANCE</span><span class="p">);</span>

		<span class="cm">/* buffer space for the on-board LANCE shared memory */</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: ugly hack!</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="mh">0x00020000</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mh">0x00020000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_LANCE</span><span class="p">];</span>
		<span class="n">esar_base</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="n">dec_kn_slot_base</span> <span class="o">+</span> <span class="n">IOASIC_ESAR</span><span class="p">);</span>

		<span class="cm">/* Workaround crash with booting KN04 2.1k from Disk */</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * setup the pointer arrays, this sucks [tm] :-(</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BUF_OFFSET_CPU</span> <span class="o">+</span>
					 <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">BUF_OFFSET_LNC</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BUF_OFFSET_CPU</span> <span class="o">+</span>
					 <span class="mi">2</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span> <span class="o">+</span>
					 <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">BUF_OFFSET_LNC</span> <span class="o">+</span>
				 <span class="n">RX_RING_SIZE</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span> <span class="o">+</span>
				 <span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUFF_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Setup I/O ASIC LANCE DMA.  */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_LANCE_MERR</span><span class="p">];</span>
		<span class="n">ioasic_write</span><span class="p">(</span><span class="n">IO_REG_LANCE_DMA_P</span><span class="p">,</span>
			     <span class="n">CPHYSADDR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TC</span>
	<span class="k">case</span> <span class="n">PMAD_LANCE</span>:
		<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">bdev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: Unable to reserve MMIO resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev_name</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mh">0x100000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mh">0x100000</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">;</span>
		<span class="n">esar_base</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mh">0x1c0002</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">BUF_OFFSET_CPU</span> <span class="o">+</span>
					 <span class="n">i</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">BUF_OFFSET_LNC</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">BUF_OFFSET_CPU</span> <span class="o">+</span>
					 <span class="n">RX_RING_SIZE</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span> <span class="o">+</span>
					 <span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">BUF_OFFSET_LNC</span> <span class="o">+</span>
				 <span class="n">RX_RING_SIZE</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span> <span class="o">+</span>
				 <span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUFF_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">PMAX_LANCE</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_LANCE</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="n">KN01_SLOT_BASE</span> <span class="o">+</span> <span class="n">KN01_LANCE</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="n">KN01_SLOT_BASE</span> <span class="o">+</span> <span class="n">KN01_LANCE_MEM</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">KN01_SLOT_SIZE</span><span class="p">;</span>
		<span class="n">esar_base</span> <span class="o">=</span> <span class="n">CKSEG1ADDR</span><span class="p">(</span><span class="n">KN01_SLOT_BASE</span> <span class="o">+</span> <span class="n">KN01_ESAR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dma_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * setup the pointer arrays, this sucks [tm] :-(</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BUF_OFFSET_CPU</span> <span class="o">+</span>
					 <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">BUF_OFFSET_LNC</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BUF_OFFSET_CPU</span> <span class="o">+</span>
					 <span class="mi">2</span> <span class="o">*</span> <span class="n">RX_RING_SIZE</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span> <span class="o">+</span>
					 <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUFF_SIZE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_buf_ptr_lnc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">BUF_OFFSET_LNC</span> <span class="o">+</span>
				 <span class="n">RX_RING_SIZE</span> <span class="o">*</span> <span class="n">RX_BUFF_SIZE</span> <span class="o">+</span>
				 <span class="n">i</span> <span class="o">*</span> <span class="n">TX_BUFF_SIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: declance_init called with unknown type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ll</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lance_regs</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">esar</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">esar_base</span><span class="p">;</span>

	<span class="cm">/* prom checks */</span>
	<span class="cm">/* First, check for test pattern */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esar</span><span class="p">[</span><span class="mh">0x60</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">esar</span><span class="p">[</span><span class="mh">0x64</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
	    <span class="n">esar</span><span class="p">[</span><span class="mh">0x68</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x55</span> <span class="o">&amp;&amp;</span> <span class="n">esar</span><span class="p">[</span><span class="mh">0x6c</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: Ethernet station address prom not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_resource</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check the prom contents */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esar</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">esar</span><span class="p">[</span><span class="mh">0x3c</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">esar</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">esar</span><span class="p">[</span><span class="mh">0x40</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">esar</span><span class="p">[</span><span class="mh">0x3c</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">esar</span><span class="p">[</span><span class="mh">0x40</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Something is wrong with the &quot;</span>
				<span class="s">&quot;ethernet station address prom!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_resource</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the ethernet address to the device structure, later to the</span>
<span class="cm">	 * lance initialization block so the lance gets it every time it&#39;s</span>
<span class="cm">	 * (re)initialized.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ASIC_LANCE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: IOASIC onboard LANCE&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PMAD_LANCE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PMAD-AA&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PMAX_LANCE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PMAX onboard LANCE&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">esar</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, addr = %pM, irq = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lance_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* lp-&gt;ll is the location of the registers for lance card */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ll</span> <span class="o">=</span> <span class="n">ll</span><span class="p">;</span>

	<span class="cm">/* busmaster_regval (CSR3) should be zero according to the PMAD-AA</span>
<span class="cm">	 * specification.</span>
<span class="cm">	 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">busmaster_regval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We cannot sleep if the chip is busy during a</span>
<span class="cm">	 * multicast list update event, because such events</span>
<span class="cm">	 * can occur from interrupts (ex. IPv6).  So we</span>
<span class="cm">	 * use a timer to try again later when necessary. -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">multicast_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">lance_set_multicast_retry</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s: Unable to register netdev, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">root_lance_dev</span><span class="p">;</span>
		<span class="n">root_lance_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: registered as %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_resource:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

<span class="nl">err_out_dev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dec_lance_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">to_tc_dev</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Find all the lance cards on the system and initialize them */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dec_lance_platform_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_LANCE</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dec_interrupt</span><span class="p">[</span><span class="n">DEC_IRQ_LANCE_MERR</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dec_lance_probe</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ASIC_LANCE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TURBOCHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dec_lance_probe</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PMAX_LANCE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dec_lance_platform_remove</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">root_lance_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">root_lance_dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">lance_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">root_lance_dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_TC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">dec_lance_tc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="n">dec_lance_tc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tc_device_id</span> <span class="n">dec_lance_tc_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;DEC     &quot;</span><span class="p">,</span> <span class="s">&quot;PMAD-AA &quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="n">dec_lance_tc_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tc_driver</span> <span class="n">dec_lance_tc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">dec_lance_tc_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;declance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tc_bus_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">dec_lance_tc_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">dec_lance_tc_remove</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dec_lance_tc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">dec_lance_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMAD_LANCE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
                <span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">dec_lance_tc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">dec_lance_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dec_lance_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">tc_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dec_lance_tc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">dec_lance_platform_probe</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dec_lance_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dec_lance_platform_remove</span><span class="p">();</span>
	<span class="n">tc_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dec_lance_tc_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">dec_lance_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dec_lance_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
