<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › toshiba › ps3_gelic_net.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ps3_gelic_net.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 Platfom gelic network driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Sony Computer Entertainment Inc.</span>
<span class="cm"> * Copyright 2006, 2007 Sony Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is based on: spider_net.h</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright IBM Corp. 2005</span>
<span class="cm"> *</span>
<span class="cm"> * Authors : Utz Bacher &lt;utz.bacher@de.ibm.com&gt;</span>
<span class="cm"> *           Jens Osterkamp &lt;Jens.Osterkamp@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _GELIC_NET_H</span>
<span class="cp">#define _GELIC_NET_H</span>

<span class="cm">/* descriptors */</span>
<span class="cp">#define GELIC_NET_RX_DESCRIPTORS        128 </span><span class="cm">/* num of descriptors */</span><span class="cp"></span>
<span class="cp">#define GELIC_NET_TX_DESCRIPTORS        128 </span><span class="cm">/* num of descriptors */</span><span class="cp"></span>

<span class="cp">#define GELIC_NET_MAX_MTU               VLAN_ETH_FRAME_LEN</span>
<span class="cp">#define GELIC_NET_MIN_MTU               VLAN_ETH_ZLEN</span>
<span class="cp">#define GELIC_NET_RXBUF_ALIGN           128</span>
<span class="cp">#define GELIC_CARD_RX_CSUM_DEFAULT      1 </span><span class="cm">/* hw chksum */</span><span class="cp"></span>
<span class="cp">#define GELIC_NET_WATCHDOG_TIMEOUT      5*HZ</span>
<span class="cp">#define GELIC_NET_NAPI_WEIGHT           (GELIC_NET_RX_DESCRIPTORS)</span>
<span class="cp">#define GELIC_NET_BROADCAST_ADDR        0xffffffffffffL</span>

<span class="cp">#define GELIC_NET_MC_COUNT_MAX          32 </span><span class="cm">/* multicast address list */</span><span class="cp"></span>

<span class="cm">/* virtual interrupt status register bits */</span>
	<span class="cm">/* INT1 */</span>
<span class="cp">#define GELIC_CARD_TX_RAM_FULL_ERR           0x0000000000000001L</span>
<span class="cp">#define GELIC_CARD_RX_RAM_FULL_ERR           0x0000000000000002L</span>
<span class="cp">#define GELIC_CARD_TX_SHORT_FRAME_ERR        0x0000000000000004L</span>
<span class="cp">#define GELIC_CARD_TX_INVALID_DESCR_ERR      0x0000000000000008L</span>
<span class="cp">#define GELIC_CARD_RX_FIFO_FULL_ERR          0x0000000000002000L</span>
<span class="cp">#define GELIC_CARD_RX_DESCR_CHAIN_END        0x0000000000004000L</span>
<span class="cp">#define GELIC_CARD_RX_INVALID_DESCR_ERR      0x0000000000008000L</span>
<span class="cp">#define GELIC_CARD_TX_RESPONCE_ERR           0x0000000000010000L</span>
<span class="cp">#define GELIC_CARD_RX_RESPONCE_ERR           0x0000000000100000L</span>
<span class="cp">#define GELIC_CARD_TX_PROTECTION_ERR         0x0000000000400000L</span>
<span class="cp">#define GELIC_CARD_RX_PROTECTION_ERR         0x0000000004000000L</span>
<span class="cp">#define GELIC_CARD_TX_TCP_UDP_CHECKSUM_ERR   0x0000000008000000L</span>
<span class="cp">#define GELIC_CARD_PORT_STATUS_CHANGED       0x0000000020000000L</span>
<span class="cp">#define GELIC_CARD_WLAN_EVENT_RECEIVED       0x0000000040000000L</span>
<span class="cp">#define GELIC_CARD_WLAN_COMMAND_COMPLETED    0x0000000080000000L</span>
	<span class="cm">/* INT 0 */</span>
<span class="cp">#define GELIC_CARD_TX_FLAGGED_DESCR          0x0004000000000000L</span>
<span class="cp">#define GELIC_CARD_RX_FLAGGED_DESCR          0x0040000000000000L</span>
<span class="cp">#define GELIC_CARD_TX_TRANSFER_END           0x0080000000000000L</span>
<span class="cp">#define GELIC_CARD_TX_DESCR_CHAIN_END        0x0100000000000000L</span>
<span class="cp">#define GELIC_CARD_NUMBER_OF_RX_FRAME        0x1000000000000000L</span>
<span class="cp">#define GELIC_CARD_ONE_TIME_COUNT_TIMER      0x4000000000000000L</span>
<span class="cp">#define GELIC_CARD_FREE_RUN_COUNT_TIMER      0x8000000000000000L</span>

<span class="cm">/* initial interrupt mask */</span>
<span class="cp">#define GELIC_CARD_TXINT	GELIC_CARD_TX_DESCR_CHAIN_END</span>

<span class="cp">#define GELIC_CARD_RXINT	(GELIC_CARD_RX_DESCR_CHAIN_END | \</span>
<span class="cp">				 GELIC_CARD_NUMBER_OF_RX_FRAME)</span>

 <span class="cm">/* RX descriptor data_status bits */</span>
<span class="k">enum</span> <span class="n">gelic_descr_rx_status</span> <span class="p">{</span>
	<span class="n">GELIC_DESCR_RXDMADU</span>	<span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="cm">/* destination MAC addr unknown */</span>
	<span class="n">GELIC_DESCR_RXLSTFBF</span>	<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="cm">/* last frame buffer            */</span>
	<span class="n">GELIC_DESCR_RXIPCHK</span>	<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="cm">/* IP checksum performed        */</span>
	<span class="n">GELIC_DESCR_RXTCPCHK</span>	<span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="cm">/* TCP/UDP checksup performed   */</span>
	<span class="n">GELIC_DESCR_RXWTPKT</span>	<span class="o">=</span> <span class="mh">0x00C00000</span><span class="p">,</span> <span class="cm">/*</span>
<span class="cm">					       * wakeup trigger packet</span>
<span class="cm">					       * 01: Magic Packet (TM)</span>
<span class="cm">					       * 10: ARP packet</span>
<span class="cm">					       * 11: Multicast MAC addr</span>
<span class="cm">					       */</span>
	<span class="n">GELIC_DESCR_RXVLNPKT</span>	<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span> <span class="cm">/* VLAN packet */</span>
	<span class="cm">/* bit 20..16 reserved */</span>
	<span class="n">GELIC_DESCR_RXRRECNUM</span>	<span class="o">=</span> <span class="mh">0x0000ff00</span><span class="p">,</span> <span class="cm">/* reception receipt number */</span>
	<span class="cm">/* bit 7..0 reserved */</span>
<span class="p">};</span>

<span class="cp">#define GELIC_DESCR_DATA_STATUS_CHK_MASK	\</span>
<span class="cp">	(GELIC_DESCR_RXIPCHK | GELIC_DESCR_RXTCPCHK)</span>

 <span class="cm">/* TX descriptor data_status bits */</span>
<span class="k">enum</span> <span class="n">gelic_descr_tx_status</span> <span class="p">{</span>
	<span class="n">GELIC_DESCR_TX_TAIL</span>	<span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span> <span class="cm">/* gelic treated this</span>
<span class="cm">					       * descriptor was end of</span>
<span class="cm">					       * a tx frame</span>
<span class="cm">					       */</span>
<span class="p">};</span>

<span class="cm">/* RX descriptor data error bits */</span>
<span class="k">enum</span> <span class="n">gelic_descr_rx_error</span> <span class="p">{</span>
	<span class="cm">/* bit 31 reserved */</span>
	<span class="n">GELIC_DESCR_RXALNERR</span>	<span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="cm">/* alignement error 10/100M */</span>
	<span class="n">GELIC_DESCR_RXOVERERR</span>	<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="cm">/* oversize error */</span>
	<span class="n">GELIC_DESCR_RXRNTERR</span>	<span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="cm">/* Runt error */</span>
	<span class="n">GELIC_DESCR_RXIPCHKERR</span>	<span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span> <span class="cm">/* IP checksum  error */</span>
	<span class="n">GELIC_DESCR_RXTCPCHKERR</span>	<span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span> <span class="cm">/* TCP/UDP checksum  error */</span>
	<span class="n">GELIC_DESCR_RXDRPPKT</span>	<span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span> <span class="cm">/* drop packet */</span>
	<span class="n">GELIC_DESCR_RXIPFMTERR</span>	<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span> <span class="cm">/* IP packet format error */</span>
	<span class="cm">/* bit 18 reserved */</span>
	<span class="n">GELIC_DESCR_RXDATAERR</span>	<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span> <span class="cm">/* IP packet format error */</span>
	<span class="n">GELIC_DESCR_RXCALERR</span>	<span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span> <span class="cm">/* cariier extension length</span>
<span class="cm">					      * error */</span>
	<span class="n">GELIC_DESCR_RXCREXERR</span>	<span class="o">=</span> <span class="mh">0x00008000</span><span class="p">,</span> <span class="cm">/* carrier extension error */</span>
	<span class="n">GELIC_DESCR_RXMLTCST</span>	<span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="cm">/* multicast address frame */</span>
	<span class="cm">/* bit 13..0 reserved */</span>
<span class="p">};</span>
<span class="cp">#define GELIC_DESCR_DATA_ERROR_CHK_MASK		\</span>
<span class="cp">	(GELIC_DESCR_RXIPCHKERR | GELIC_DESCR_RXTCPCHKERR)</span>

<span class="cm">/* DMA command and status (RX and TX)*/</span>
<span class="k">enum</span> <span class="n">gelic_descr_dma_status</span> <span class="p">{</span>
	<span class="n">GELIC_DESCR_DMA_COMPLETE</span>            <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="cm">/* used in tx */</span>
	<span class="n">GELIC_DESCR_DMA_BUFFER_FULL</span>         <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="cm">/* used in rx */</span>
	<span class="n">GELIC_DESCR_DMA_RESPONSE_ERROR</span>      <span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="cm">/* used in rx, tx */</span>
	<span class="n">GELIC_DESCR_DMA_PROTECTION_ERROR</span>    <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="cm">/* used in rx, tx */</span>
	<span class="n">GELIC_DESCR_DMA_FRAME_END</span>           <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="cm">/* used in rx */</span>
	<span class="n">GELIC_DESCR_DMA_FORCE_END</span>           <span class="o">=</span> <span class="mh">0x50000000</span><span class="p">,</span> <span class="cm">/* used in rx, tx */</span>
	<span class="n">GELIC_DESCR_DMA_CARDOWNED</span>           <span class="o">=</span> <span class="mh">0xa0000000</span><span class="p">,</span> <span class="cm">/* used in rx, tx */</span>
	<span class="n">GELIC_DESCR_DMA_NOT_IN_USE</span>          <span class="o">=</span> <span class="mh">0xb0000000</span><span class="p">,</span> <span class="cm">/* any other value */</span>
<span class="p">};</span>

<span class="cp">#define GELIC_DESCR_DMA_STAT_MASK	(0xf0000000)</span>

<span class="cm">/* tx descriptor command and status */</span>
<span class="k">enum</span> <span class="n">gelic_descr_tx_dma_status</span> <span class="p">{</span>
	<span class="cm">/* [19] */</span>
	<span class="n">GELIC_DESCR_TX_DMA_IKE</span>		<span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span> <span class="cm">/* IPSEC off */</span>
	<span class="cm">/* [18] */</span>
	<span class="n">GELIC_DESCR_TX_DMA_FRAME_TAIL</span>	<span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span> <span class="cm">/* last descriptor of</span>
<span class="cm">						       * the packet</span>
<span class="cm">						       */</span>
	<span class="cm">/* [17..16] */</span>
	<span class="n">GELIC_DESCR_TX_DMA_TCP_CHKSUM</span>	<span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span> <span class="cm">/* TCP packet */</span>
	<span class="n">GELIC_DESCR_TX_DMA_UDP_CHKSUM</span>	<span class="o">=</span> <span class="mh">0x00030000</span><span class="p">,</span> <span class="cm">/* UDP packet */</span>
	<span class="n">GELIC_DESCR_TX_DMA_NO_CHKSUM</span>	<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="cm">/* no checksum */</span>

	<span class="cm">/* [1] */</span>
	<span class="n">GELIC_DESCR_TX_DMA_CHAIN_END</span>	<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span> <span class="cm">/* DMA terminated</span>
<span class="cm">						       * due to chain end</span>
<span class="cm">						       */</span>
<span class="p">};</span>

<span class="cp">#define GELIC_DESCR_DMA_CMD_NO_CHKSUM	\</span>
<span class="cp">	(GELIC_DESCR_DMA_CARDOWNED | GELIC_DESCR_TX_DMA_IKE | \</span>
<span class="cp">	GELIC_DESCR_TX_DMA_NO_CHKSUM)</span>

<span class="cp">#define GELIC_DESCR_DMA_CMD_TCP_CHKSUM	\</span>
<span class="cp">	(GELIC_DESCR_DMA_CARDOWNED | GELIC_DESCR_TX_DMA_IKE | \</span>
<span class="cp">	GELIC_DESCR_TX_DMA_TCP_CHKSUM)</span>

<span class="cp">#define GELIC_DESCR_DMA_CMD_UDP_CHKSUM	\</span>
<span class="cp">	(GELIC_DESCR_DMA_CARDOWNED | GELIC_DESCR_TX_DMA_IKE | \</span>
<span class="cp">	GELIC_DESCR_TX_DMA_UDP_CHKSUM)</span>

<span class="k">enum</span> <span class="n">gelic_descr_rx_dma_status</span> <span class="p">{</span>
	<span class="cm">/* [ 1 ] */</span>
	<span class="n">GELIC_DESCR_RX_DMA_CHAIN_END</span>	<span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span> <span class="cm">/* DMA terminated</span>
<span class="cm">						       * due to chain end</span>
<span class="cm">						       */</span>
<span class="p">};</span>

<span class="cm">/* for lv1_net_control */</span>
<span class="k">enum</span> <span class="n">gelic_lv1_net_control_code</span> <span class="p">{</span>
	<span class="n">GELIC_LV1_GET_MAC_ADDRESS</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">GELIC_LV1_GET_ETH_PORT_STATUS</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">GELIC_LV1_SET_NEGOTIATION_MODE</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">GELIC_LV1_GET_VLAN_ID</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">GELIC_LV1_SET_WOL</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">GELIC_LV1_GET_CHANNEL</span>           <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">GELIC_LV1_POST_WLAN_CMD</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">GELIC_LV1_GET_WLAN_CMD_RESULT</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="n">GELIC_LV1_GET_WLAN_EVENT</span>	<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* for GELIC_LV1_SET_WOL */</span>
<span class="k">enum</span> <span class="n">gelic_lv1_wol_command</span> <span class="p">{</span>
	<span class="n">GELIC_LV1_WOL_MAGIC_PACKET</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">GELIC_LV1_WOL_ADD_MATCH_ADDR</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">GELIC_LV1_WOL_DELETE_MATCH_ADDR</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* for GELIC_LV1_WOL_MAGIC_PACKET */</span>
<span class="k">enum</span> <span class="n">gelic_lv1_wol_mp_arg</span> <span class="p">{</span>
	<span class="n">GELIC_LV1_WOL_MP_DISABLE</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">GELIC_LV1_WOL_MP_ENABLE</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* for GELIC_LV1_WOL_{ADD,DELETE}_MATCH_ADDR */</span>
<span class="k">enum</span> <span class="n">gelic_lv1_wol_match_arg</span> <span class="p">{</span>
	<span class="n">GELIC_LV1_WOL_MATCH_INDIVIDUAL</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">GELIC_LV1_WOL_MATCH_ALL</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* status returened from GET_ETH_PORT_STATUS */</span>
<span class="k">enum</span> <span class="n">gelic_lv1_ether_port_status</span> <span class="p">{</span>
	<span class="n">GELIC_LV1_ETHER_LINK_UP</span>		<span class="o">=</span> <span class="mh">0x0000000000000001L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_ETHER_FULL_DUPLEX</span>	<span class="o">=</span> <span class="mh">0x0000000000000002L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_ETHER_AUTO_NEG</span>	<span class="o">=</span> <span class="mh">0x0000000000000004L</span><span class="p">,</span>

	<span class="n">GELIC_LV1_ETHER_SPEED_10</span>	<span class="o">=</span> <span class="mh">0x0000000000000010L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_ETHER_SPEED_100</span>	<span class="o">=</span> <span class="mh">0x0000000000000020L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_ETHER_SPEED_1000</span>	<span class="o">=</span> <span class="mh">0x0000000000000040L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_ETHER_SPEED_MASK</span>	<span class="o">=</span> <span class="mh">0x0000000000000070L</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">gelic_lv1_vlan_index</span> <span class="p">{</span>
	<span class="cm">/* for outgoing packets */</span>
	<span class="n">GELIC_LV1_VLAN_TX_ETHERNET_0</span>	<span class="o">=</span> <span class="mh">0x0000000000000002L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_VLAN_TX_WIRELESS</span>	<span class="o">=</span> <span class="mh">0x0000000000000003L</span><span class="p">,</span>

	<span class="cm">/* for incoming packets */</span>
	<span class="n">GELIC_LV1_VLAN_RX_ETHERNET_0</span>	<span class="o">=</span> <span class="mh">0x0000000000000012L</span><span class="p">,</span>
	<span class="n">GELIC_LV1_VLAN_RX_WIRELESS</span>	<span class="o">=</span> <span class="mh">0x0000000000000013L</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">gelic_lv1_phy</span> <span class="p">{</span>
	<span class="n">GELIC_LV1_PHY_ETHERNET_0</span>	<span class="o">=</span> <span class="mh">0x0000000000000002L</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* size of hardware part of gelic descriptor */</span>
<span class="cp">#define GELIC_DESCR_SIZE	(32)</span>

<span class="k">enum</span> <span class="n">gelic_port_type</span> <span class="p">{</span>
	<span class="n">GELIC_PORT_ETHERNET_0</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">GELIC_PORT_WIRELESS</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">GELIC_PORT_MAX</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="p">{</span>
	<span class="cm">/* as defined by the hardware */</span>
	<span class="n">__be32</span> <span class="n">buf_addr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">next_descr_addr</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">dmac_cmd_status</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">result_size</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">valid_size</span><span class="p">;</span>	<span class="cm">/* all zeroes for tx */</span>
	<span class="n">__be32</span> <span class="n">data_status</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">data_error</span><span class="p">;</span>	<span class="cm">/* all zeroes for tx */</span>

	<span class="cm">/* used in the driver */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>

<span class="k">struct</span> <span class="n">gelic_descr_chain</span> <span class="p">{</span>
	<span class="cm">/* we walk from tail to head */</span>
	<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gelic_vlan_id</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gelic_card</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">[</span><span class="n">GELIC_PORT_MAX</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * hypervisor requires irq_status should be</span>
<span class="cm">	 * 8 bytes aligned, but u64 member is</span>
<span class="cm">	 * always disposed in that manner</span>
<span class="cm">	 */</span>
	<span class="n">u64</span> <span class="n">irq_status</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">irq_mask</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_vlan_id</span> <span class="n">vlan</span><span class="p">[</span><span class="n">GELIC_PORT_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">vlan_required</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">gelic_descr_chain</span> <span class="n">tx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_descr_chain</span> <span class="n">rx_chain</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * tx_lock guards tx descriptor list and</span>
<span class="cm">	 * tx_dma_progress.</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span> <span class="n">tx_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_dma_progress</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">tx_timeout_task</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">tx_timeout_task_counter</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">waitq</span><span class="p">;</span>

	<span class="cm">/* only first user should up the card */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">updown_lock</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">users</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">ether_port_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link_mode</span><span class="p">;</span>

	<span class="cm">/* original address returned by kzalloc */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">unalign</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * each netdevice has copy of irq</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="o">*</span><span class="n">tx_top</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_descr</span> <span class="n">descr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* must be the last */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gelic_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">gelic_port_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">priv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* long for alignment */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="nf">port_to_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">port_to_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="nf">netdev_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">d</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="nf">netdev_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">ctodev</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">bus_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">dev_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">port_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_EARLY_DEBUG_PS3GELIC</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">udbg_shutdown_ps3gelic</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">udbg_shutdown_ps3gelic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">gelic_card_set_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">);</span>
<span class="cm">/* shared netdev ops */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gelic_card_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gelic_card_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gelic_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gelic_net_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gelic_net_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gelic_net_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gelic_net_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gelic_net_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gelic_net_setup_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>

<span class="cm">/* shared ethtool ops */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gelic_net_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gelic_net_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* _GELIC_NET_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
