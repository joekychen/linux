<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › toshiba › ps3_gelic_wireless.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ps3_gelic_wireless.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 gelic network driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Sony Computer Entertainment Inc.</span>
<span class="cm"> * Copyright 2007 Sony Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>
<span class="cp">#include &lt;asm/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/ps3.h&gt;</span>
<span class="cp">#include &lt;asm/lv1call.h&gt;</span>

<span class="cp">#include &quot;ps3_gelic_net.h&quot;</span>
<span class="cp">#include &quot;ps3_gelic_wireless.h&quot;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">gelic_wl_start_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">always_scan</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">essid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">essid_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gelic_wl_try_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tables</span>
<span class="cm"> */</span>

<span class="cm">/* 802.11b/g channel to freq in MHz */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">channel_freq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2412</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span>
	<span class="mi">2437</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span>
	<span class="mi">2462</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">2484</span>
<span class="p">};</span>
<span class="cp">#define NUM_CHANNELS ARRAY_SIZE(channel_freq)</span>

<span class="cm">/* in bps */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bitrate_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	  <span class="mi">1000000</span><span class="p">,</span>
	  <span class="mi">2000000</span><span class="p">,</span>
	  <span class="mi">5500000</span><span class="p">,</span>
	 <span class="mi">11000000</span><span class="p">,</span>
	  <span class="mi">6000000</span><span class="p">,</span>
	  <span class="mi">9000000</span><span class="p">,</span>
	 <span class="mi">12000000</span><span class="p">,</span>
	 <span class="mi">18000000</span><span class="p">,</span>
	 <span class="mi">24000000</span><span class="p">,</span>
	 <span class="mi">36000000</span><span class="p">,</span>
	 <span class="mi">48000000</span><span class="p">,</span>
	 <span class="mi">54000000</span>
<span class="p">};</span>
<span class="cp">#define NUM_BITRATES ARRAY_SIZE(bitrate_list)</span>

<span class="cm">/*</span>
<span class="cm"> * wpa2 support requires the hypervisor version 2.0 or later</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wpa2_capable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ps3_compare_firmware_version</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">precise_ie</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ps3_compare_firmware_version</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * post_eurus_cmd helpers</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">eurus_cmd_arg_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pre_arg</span><span class="p">;</span> <span class="cm">/* command requires arg1, arg2 at POST COMMAND */</span>
	<span class="kt">int</span> <span class="n">post_arg</span><span class="p">;</span> <span class="cm">/* command requires arg1, arg2 at GET_RESULT */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">eurus_cmd_arg_info</span> <span class="n">cmd_info</span><span class="p">[</span><span class="n">GELIC_EURUS_CMD_MAX_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_SET_COMMON_CFG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">pre_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_SET_WEP_CFG</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">pre_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_SET_WPA_CFG</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">pre_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_GET_COMMON_CFG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">post_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_GET_WEP_CFG</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">post_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_GET_WPA_CFG</span><span class="p">]</span>    <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">post_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_GET_RSSI_CFG</span><span class="p">]</span>   <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">post_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_START_SCAN</span><span class="p">]</span>     <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">pre_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">[</span><span class="n">GELIC_EURUS_CMD_GET_SCAN</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">post_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cmdstr</span><span class="p">(</span><span class="k">enum</span> <span class="n">gelic_eurus_command</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_ASSOC</span>:
		<span class="k">return</span> <span class="s">&quot;ASSOC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_DISASSOC</span>:
		<span class="k">return</span> <span class="s">&quot;DISASSOC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_START_SCAN</span>:
		<span class="k">return</span> <span class="s">&quot;SCAN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_GET_SCAN</span>:
		<span class="k">return</span> <span class="s">&quot;GET SCAN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_SET_COMMON_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;SET_COMMON_CFG&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_GET_COMMON_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;GET_COMMON_CFG&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_SET_WEP_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;SET_WEP_CFG&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_GET_WEP_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;GET_WEP_CFG&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_SET_WPA_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;SET_WPA_CFG&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_GET_WPA_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;GET_WPA_CFG&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_CMD_GET_RSSI_CFG</span>:
		<span class="k">return</span> <span class="s">&quot;GET_RSSI&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cmdstr</span><span class="p">(</span><span class="k">enum</span> <span class="n">gelic_eurus_command</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* synchronously do eurus commands */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_eurus_sync_cmd_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gelic_eurus_cmd</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cmd_info</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">].</span><span class="n">pre_arg</span> <span class="o">&amp;&amp;</span>
	       <span class="n">cmd_info</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">].</span><span class="n">post_arg</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port_to_card</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_info</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">].</span><span class="n">pre_arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">))</span> <span class="o">:</span>
			<span class="mi">0</span><span class="p">;</span>
		<span class="n">arg2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">arg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">arg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_done_intr</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: cmd=&#39;%s&#39; start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">lv1_net_control</span><span class="p">(</span><span class="n">bus_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">dev_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
				      <span class="n">GELIC_LV1_POST_WLAN_CMD</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: cmd issue failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_done_intr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_info</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">].</span><span class="n">post_arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">arg1</span> <span class="o">=</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">));</span>
		<span class="n">arg2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">arg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">arg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">lv1_net_control</span><span class="p">(</span><span class="n">bus_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">dev_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
				      <span class="n">GELIC_LV1_GET_WLAN_CMD_RESULT</span><span class="p">,</span>
				      <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: cmd done tag=%#lx arg1=%#lx, arg2=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: cmd done status=%#x cmd_status=%#lx size=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: cmd=&#39;%s&#39; done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="nf">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eurus_cmd</span><span class="p">,</span>
						    <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* allocate cmd */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* initialize members */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">eurus_cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">gelic_eurus_sync_cmd_worker</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">eurus_cmd_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/* wait for command completion */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gelic_wl_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_port</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">data</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">port_to_netdev</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">)),</span> <span class="n">SIOCGIWAP</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wireless extension handlers and helpers</span>
<span class="cm"> */</span>

<span class="cm">/* SIOGIWNAME */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">iwreq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">iwreq</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11bg&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_get_ch_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">port_to_card</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">));</span>
	<span class="n">u64</span> <span class="n">ch_info_raw</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CH_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lv1_net_control</span><span class="p">(</span><span class="n">bus_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span> <span class="n">dev_id</span><span class="p">(</span><span class="n">card</span><span class="p">),</span>
					 <span class="n">GELIC_LV1_GET_CHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ch_info_raw</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="cm">/* some fw versions may return error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">LV1_NO_ENTRY</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: available ch unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ch_info</span> <span class="o">=</span> <span class="mh">0x07ff</span><span class="p">;</span><span class="cm">/* 11 ch */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* 16 bits of MSB has available channels */</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ch_info</span> <span class="o">=</span> <span class="n">ch_info_raw</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* SIOGIWRANGE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">iwreq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">point</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iwreq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_port</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chs</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">point</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">));</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>

	<span class="cm">/* available channels and frequencies */</span>
	<span class="n">gelic_wl_get_ch_info</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CHANNELS</span> <span class="o">&amp;&amp;</span> <span class="n">chs</span> <span class="o">&lt;</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ch_info</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">chs</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">chs</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">channel_freq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">chs</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">chs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">chs</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">old_num_frequency</span> <span class="o">=</span> <span class="n">chs</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">chs</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">old_num_channels</span> <span class="o">=</span> <span class="n">chs</span><span class="p">;</span>

	<span class="cm">/* bitrates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BITRATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bitrate_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* signal levels */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* relative value */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Event capability */</span>
	<span class="n">IW_EVENT_CAPA_SET_KERNEL</span><span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">);</span>
	<span class="n">IW_EVENT_CAPA_SET</span><span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">);</span>
	<span class="n">IW_EVENT_CAPA_SET</span><span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">);</span>

	<span class="cm">/* encryption capability */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span>
		<span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span> <span class="o">|</span>
		<span class="n">IW_ENC_CAPA_4WAY_HANDSHAKE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wpa2_capable</span><span class="p">())</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">|=</span> <span class="n">IW_ENC_CAPA_WPA2</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* 40bit WEP */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>	<span class="cm">/* 104bit WEP */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* WPA-PSK */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="n">GELIC_WEP_KEYS</span><span class="p">;</span>

	<span class="cm">/* scan capability */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">scan_capa</span> <span class="o">=</span> <span class="n">IW_SCAN_CAPA_ESSID</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* SIOC{G,S}IWSCAN */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">essid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">essid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_SCAN_THIS_ESSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
		<span class="n">essid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">;</span>
		<span class="n">essid_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: ESSID scan =%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">essid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">gelic_wl_start_scan</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">essid_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define OUI_LEN 3</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rsn_oui</span><span class="p">[</span><span class="n">OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xac</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">wpa_oui</span><span class="p">[</span><span class="n">OUI_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * synthesize WPA/RSN IE data</span>
<span class="cm"> * See WiFi WPA specification and IEEE 802.11-2007 7.3.2.25</span>
<span class="cm"> * for the format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">gelic_wl_synthesize_ie</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">gelic_eurus_scan_info</span> <span class="o">*</span><span class="n">scan</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">oui_header</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rsn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccmp</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;- sec=%16x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GELIC_EURUS_SCAN_SEC_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA</span>:
		<span class="n">rsn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA2</span>:
		<span class="n">rsn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* WEP or none.  No IE returned */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA_TKIP</span>:
		<span class="n">ccmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA_AES</span>:
		<span class="n">ccmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: no cipher info. defaulted to CCMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: no cipher info. defaulted to TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsn</span><span class="p">)</span>
		<span class="n">oui_header</span> <span class="o">=</span> <span class="n">rsn_oui</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oui_header</span> <span class="o">=</span> <span class="n">wpa_oui</span><span class="p">;</span>

	<span class="cm">/* element id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_RSN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_GENERIC</span><span class="p">;</span>

	<span class="cm">/* length filed; set later */</span>
	<span class="n">buf</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* wpa special header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">wpa_oui</span><span class="p">,</span> <span class="n">OUI_LEN</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">OUI_LEN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* version */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* version 1.0 */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* group cipher */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">oui_header</span><span class="p">,</span> <span class="n">OUI_LEN</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">OUI_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccmp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* CCMP */</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* TKIP */</span>

	<span class="cm">/* pairwise key count always 1 */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* pairwise key suit */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">oui_header</span><span class="p">,</span> <span class="n">OUI_LEN</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">OUI_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccmp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* CCMP */</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* TKIP */</span>

	<span class="cm">/* AKM count is 1 */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* AKM suite is assumed as PSK*/</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">oui_header</span><span class="p">,</span> <span class="n">OUI_LEN</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">OUI_LEN</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* PSK */</span>

	<span class="cm">/* RSN capabilities is 0 */</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* set length field */</span>
	<span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span> <span class="o">-</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ie_item</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ie_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ie_item</span> <span class="n">wpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ie_item</span> <span class="n">rsn</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_parse_ie</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ie_info</span> <span class="o">*</span><span class="n">ie_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">data_left</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">item_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">item_id</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: data=%p len=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ie_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ie_info</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">data_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">item_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">item_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">data_left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data_left</span> <span class="o">&lt;</span> <span class="n">item_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">item_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_EID_GENERIC</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">OUI_LEN</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">item_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">wpa_oui</span><span class="p">,</span> <span class="n">OUI_LEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pos</span><span class="p">[</span><span class="n">OUI_LEN</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">item_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_RSN</span>:
			<span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">rsn</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* length includes the header */</span>
			<span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">rsn</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">item_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: ignore %#x,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				 <span class="n">item_id</span><span class="p">,</span> <span class="n">item_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">item_len</span><span class="p">;</span>
		<span class="n">data_left</span> <span class="o">-=</span> <span class="n">item_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: wpa=%p,%d wpa2=%p,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
		 <span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">rsn</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ie_info</span><span class="o">-&gt;</span><span class="n">rsn</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * translate the scan informations from hypervisor to a</span>
<span class="cm"> * independent format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gelic_wl_translate_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">stop</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">network</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_scan_info</span> <span class="o">*</span><span class="n">scan</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span> <span class="cm">/* arbitrary size large enough */</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* first entry should be AP&#39;s mac address */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>

	<span class="cm">/* ESSID */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>

	<span class="cm">/* FREQUENCY */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* table value in MHz */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>

	<span class="cm">/* RATES */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWRATE</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* to stuff multiple values in one event */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">+</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="cm">/* put them in ascendant order (older is first) */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: rates=%d rate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">network</span><span class="o">-&gt;</span><span class="n">rate_len</span><span class="p">,</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rate_ext_len</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rate_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rate_ext_len</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">ext_rate</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)))</span>
		    <span class="n">rate</span> <span class="o">=</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">ext_rate</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">else</span>
		    <span class="n">rate</span> <span class="o">=</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span> <span class="cm">/* 500kbps unit */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
					   <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">rate_ext_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">ext_rate</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
					   <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Check if we added any rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">ev</span><span class="p">))</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* ENCODE */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>

	<span class="cm">/* MODE */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">WLAN_CAPABILITY_ESS</span> <span class="o">|</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* QUAL */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span>  <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span>
			<span class="n">IW_QUAL_QUAL_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ev</span>  <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>

	<span class="cm">/* RSN */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If wpa[2] capable station, synthesize IE and put it */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">gelic_wl_synthesize_ie</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* this scan info has IE data */</span>
		<span class="k">struct</span> <span class="n">ie_info</span> <span class="n">ie_info</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">data_len</span><span class="p">;</span>

		<span class="n">data_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan</span><span class="p">);</span>

		<span class="n">gelic_wl_parse_ie</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ie_info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ie_info</span><span class="p">.</span><span class="n">wpa</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ie_info</span><span class="p">.</span><span class="n">wpa</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ie_info</span><span class="p">.</span><span class="n">wpa</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ie_info</span><span class="p">.</span><span class="n">wpa</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ie_info</span><span class="p">.</span><span class="n">wpa</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ie_info</span><span class="p">.</span><span class="n">rsn</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ie_info</span><span class="p">.</span><span class="n">rsn</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ie_info</span><span class="p">.</span><span class="n">rsn</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ie_info</span><span class="p">.</span><span class="n">rsn</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ie_info</span><span class="p">.</span><span class="n">rsn</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ev</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">scan_info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">+</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">this_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_WL_SCAN_STAT_SCANNING</span>:
		<span class="cm">/* If a scan in progress, caller should call me again */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GELIC_WL_SCAN_STAT_INIT</span>:
		<span class="cm">/* last scan request failed or never issued */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_WL_SCAN_STAT_GOT_LIST</span>:
		<span class="cm">/* ok, use current list */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">scan_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">,</span>
			       <span class="n">this_time</span><span class="p">))</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">gelic_wl_translate_scan</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
						     <span class="n">ev</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
						     <span class="n">scan_info</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:entry too old</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">ev</span> <span class="o">&lt;=</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scan_list_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">scan_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">scan_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: item %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;valid=%d eurusindex=%d last=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">,</span> <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">eurus_index</span><span class="p">,</span>
			 <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;r_len=%d r_ext_len=%d essid_len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">rate_len</span><span class="p">,</span> <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">rate_ext_len</span><span class="p">,</span>
			 <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
		<span class="cm">/* -- */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;bssid=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;essid=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_port</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;- %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_WPA_VERSION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: NO WPA selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_WPA_VERSION_WPA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WPA version 1 selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_TKIP</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_TKIP</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_WPA_VERSION_WPA2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * As the hypervisor may not tell the cipher</span>
<span class="cm">			 * information of the AP if it is WPA2,</span>
<span class="cm">			 * you will not decide suitable cipher from</span>
<span class="cm">			 * its beacon.</span>
<span class="cm">			 * You should have knowledge about the AP&#39;s</span>
<span class="cm">			 * cipher information in other method prior to</span>
<span class="cm">			 * the association.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">precise_ie</span><span class="p">())</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: WPA2 may not work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wpa2_capable</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span><span class="p">;</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_AES</span><span class="p">;</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span>
					<span class="n">GELIC_WL_CIPHER_AES</span><span class="p">;</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">IW_AUTH_CIPHER_WEP104</span> <span class="o">|</span> <span class="n">IW_AUTH_CIPHER_WEP40</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WEP selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_CIPHER_TKIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: TKIP selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_TKIP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_CIPHER_CCMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: CCMP selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_AES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_CIPHER_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: no auth selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">IW_AUTH_CIPHER_WEP104</span> <span class="o">|</span> <span class="n">IW_AUTH_CIPHER_WEP40</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WEP selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_CIPHER_TKIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: TKIP selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_TKIP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_CIPHER_CCMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: CCMP selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_AES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_CIPHER_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: no auth selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: shared key specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_SHARED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: open system specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WPA enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WPA disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_KEY_MGMT_PSK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* intentionally fall through */</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">iwreq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iwreq</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_port</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;- %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">|=</span> <span class="n">IW_AUTH_WPA_VERSION_WPA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">|=</span> <span class="n">IW_AUTH_WPA_VERSION_WPA2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">|=</span> <span class="n">IW_AUTH_WPA_VERSION_DISABLED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">==</span> <span class="n">GELIC_EURUS_AUTH_SHARED</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">==</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span>:
		<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOC{S,G}IWESSID */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;- l=%d f=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IW_ESSID_MAX_SIZE</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: essid = &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_ESSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: ESSID any</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_ESSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>


	<span class="n">gelic_wl_try_associate</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span> <span class="cm">/* FIXME */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_ESSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIO{S,G}IWENCODE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">enc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">index_specified</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_FLAGS</span><span class="p">;</span>
	<span class="n">key_index</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: flag=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_FLAGS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GELIC_WEP_KEYS</span> <span class="o">&lt;</span> <span class="n">key_index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index_specified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">key_index</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">index_specified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">key_index</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if just IW_ENCODE_NOKEY, change current key index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">index_specified</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">index_specified</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* disable encryption */</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span>
					<span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
				<span class="cm">/* invalidate all key */</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: shared key mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_SHARED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IW_ENCODING_TOKEN_MAX</span> <span class="o">&lt;</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">key_index</span><span class="p">],</span> <span class="n">extra</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">enc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">index_specified</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">key_index</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: flag=%#x point=%p len=%d extra=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GELIC_WEP_KEYS</span> <span class="o">&lt;</span> <span class="n">key_index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index_specified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">key_index</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">index_specified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">key_index</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span>:
			<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GELIC_EURUS_AUTH_SHARED</span>:
			<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">key_index</span><span class="p">],</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">key_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; flag=%x len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOC{S,G}IWAP */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_BSSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: bss=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: clear bssid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_BSSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_bssid</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOC{S,G}IWENCODEEXT */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">enc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">alg</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_FLAGS</span><span class="p">;</span>
	<span class="n">alg</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">;</span>
	<span class="n">key_index</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: flag=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_FLAGS</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: ext_flag=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: ext_key_len=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GELIC_WEP_KEYS</span> <span class="o">&lt;</span> <span class="n">key_index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span><span class="p">)</span>
		<span class="n">key_index</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">key_index</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reques to change default key index */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: request to change default key to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_NONE</span> <span class="o">||</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: alg disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span> <span class="cm">/* should be open */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WEP requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: open key mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: shared key mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_SHARED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IW_ENCODING_TOKEN_MAX</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: key is too long %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* OK, update the key */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">key_index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_ENCODING_TOKEN_MAX</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">key_index</span><span class="p">],</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">);</span>
		<span class="cm">/* remember wep info changed */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_PMK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">!=</span> <span class="n">WPA_PSK_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: PSK length wrong %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk_len</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk_type</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_PSK_BIN</span><span class="p">;</span>
		<span class="cm">/* remember PSK configured */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_WPA_PSK_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">enc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_key_len</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">key_index</span> <span class="o">=</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: flag=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_FLAGS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GELIC_WEP_KEYS</span> <span class="o">&lt;</span> <span class="n">key_index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span><span class="p">)</span>
		<span class="n">key_index</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">key_index</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_WL_CIPHER_WEP</span>:
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">;</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_WL_CIPHER_TKIP</span>:
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">;</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_WL_CIPHER_AES</span>:
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_CCMP</span><span class="p">;</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_WL_CIPHER_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">))</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">key_index</span><span class="p">],</span>
			       <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: disabled key requested ix=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* SIOC{S,G}IWMODE */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SIOCGIWNICKN */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;gelic_wl&quot;</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* --- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">gelic_wl_get_wireless_stats</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_rssi_info</span> <span class="o">*</span><span class="n">rssi</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">is</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">iwstat</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">is</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_GET_RSSI_CFG</span><span class="p">,</span>
				   <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rssi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span> <span class="o">|</span>
			<span class="n">IW_QUAL_QUAL_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* not associated */</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_INVALID</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">is</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  scanning helpers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_start_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">always_scan</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">essid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">essid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;- always=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">always_scan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If already a scan in progress, do not trigger more</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_SCAN_STAT_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: scanning now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we have already a bss list, don&#39;t try to get new</span>
<span class="cm">	 * unless we are doing an ESSID scan</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">essid_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">always_scan</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_SCAN_STAT_GOT_LIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: already has the list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ESSID scan ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">essid_len</span> <span class="o">&amp;&amp;</span> <span class="n">essid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">;</span> <span class="cm">/* hypervisor always requires 32 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">essid_len</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: essid scan=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * issue start scan request</span>
<span class="cm">	 */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_SCAN_STAT_SCANNING</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_START_SCAN</span><span class="p">,</span>
				   <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_SCAN_STAT_INIT</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * retrieve scan result from the chip (hypervisor)</span>
<span class="cm"> * this function is invoked by schedule work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_scan_complete_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">oldest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_scan_info</span> <span class="o">*</span><span class="n">scan_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scan_info_size</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">this_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: scan buffer alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">!=</span> <span class="n">GELIC_WL_SCAN_STAT_SCANNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * stop() may be called while scanning, ignore result</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: scan complete when stat != scanning(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_GET_SCAN</span><span class="p">,</span>
				   <span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_SCAN_STAT_INIT</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data_len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: data_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* OK, bss list retrieved */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_SCAN_STAT_GOT_LIST</span><span class="p">;</span>

	<span class="cm">/* mark all entries are old */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* expire too old entries */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">+</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_age</span><span class="p">,</span>
				<span class="n">this_time</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="p">);</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* put them in the network_list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scan_info_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scan_info</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	     <span class="n">scan_info_size</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">scan_info_size</span> <span class="o">+=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
	     <span class="n">scan_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">scan_info</span> <span class="o">+</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:size=%d bssid=%pM scan_info=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
			 <span class="o">&amp;</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">scan_info</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The wireless firmware may return invalid channel 0 and/or</span>
<span class="cm">		 * invalid rate if the AP emits zero length SSID ie. As this</span>
<span class="cm">		 * scan information is useless, ignore it</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: invalid scan info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">oldest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					     <span class="o">&amp;</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: same BBS found scanned list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldest</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">&lt;</span> <span class="n">oldest</span><span class="o">-&gt;</span><span class="n">last_scanned</span><span class="p">))</span>
				<span class="n">oldest</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* not found in the list */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* expire oldest */</span>
				<span class="n">target</span> <span class="o">=</span> <span class="n">oldest</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">target</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">gelic_wl_scan_info</span><span class="p">,</span>
						    <span class="n">list</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update the item */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">last_scanned</span> <span class="o">=</span> <span class="n">this_time</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">eurus_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* copy hw scan info */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="p">,</span> <span class="n">scan_info</span><span class="p">,</span> <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">));</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">rate_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">rate_len</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">rate_len</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: AP returns %d rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">rate_len</span><span class="p">);</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">rate_ext_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">ext_rate</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">rate_ext_len</span><span class="o">++</span><span class="p">;</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">port_to_netdev</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">)),</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Select an appropriate bss from current scan list regarding</span>
<span class="cm"> * current settings from userspace.</span>
<span class="cm"> * The caller must hold wl-&gt;scan_lock,</span>
<span class="cm"> * and on the state of wl-&gt;scan_state == GELIC_WL_SCAN_GOT_LIST</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_best</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">**</span><span class="n">best</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">candid</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">best_weight</span><span class="p">,</span>
			<span class="kt">int</span> <span class="o">*</span><span class="n">weight</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">best_weight</span> <span class="o">&lt;</span> <span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">weight</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">best_weight</span> <span class="o">=</span> <span class="o">*</span><span class="n">weight</span><span class="p">;</span>
		<span class="o">*</span><span class="n">best</span> <span class="o">=</span> <span class="n">candid</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="nf">gelic_wl_find_best_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">scan_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">best_bss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">weight</span><span class="p">,</span> <span class="n">best_weight</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">security</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">best_bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">best_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">scan_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: station %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">scan_info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: station invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If bss specified, check it only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_BSSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">best_bss</span> <span class="o">=</span> <span class="n">scan_info</span><span class="p">;</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: bssid matched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: bssid unmached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* security */</span>
		<span class="n">security</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">GELIC_EURUS_SCAN_SEC_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">==</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">security</span> <span class="o">==</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA2</span><span class="p">)</span>
				<span class="n">update_best</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best_bss</span><span class="p">,</span> <span class="n">scan_info</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">best_weight</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weight</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">==</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">security</span> <span class="o">==</span> <span class="n">GELIC_EURUS_SCAN_SEC_WPA</span><span class="p">)</span>
				<span class="n">update_best</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best_bss</span><span class="p">,</span> <span class="n">scan_info</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">best_weight</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weight</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">==</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span> <span class="o">&amp;&amp;</span>
			   <span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">security</span> <span class="o">==</span> <span class="n">GELIC_EURUS_SCAN_SEC_WEP</span><span class="p">)</span>
				<span class="n">update_best</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best_bss</span><span class="p">,</span> <span class="n">scan_info</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">best_weight</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weight</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If ESSID is set, check it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_ESSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">==</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
				     <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span>
				     <span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">))</span>
				<span class="n">update_best</span><span class="p">(</span><span class="o">&amp;</span><span class="n">best_bss</span><span class="p">,</span> <span class="n">scan_info</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">best_weight</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">weight</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt; bss=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">best_bss</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:addr=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">best_bss</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">best_bss</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup WEP configuration to the chip</span>
<span class="cm"> * The caller must hold wl-&gt;scan_lock,</span>
<span class="cm"> * and on the state of wl-&gt;scan_state == GELIC_WL_SCAN_GOT_LIST</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_do_wep_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_wep_cfg</span> <span class="o">*</span><span class="n">wep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wep104</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">have_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* we can assume no one should uses the buffer */</span>
	<span class="n">wep</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gelic_eurus_wep_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wep</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WEP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GELIC_WEP_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: key#%d enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">have_key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
				<span class="n">wep104</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: wrong wep key[%d]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">wep</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: all wep key disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wep104</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: 104bit key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wep</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_WEP_SEC_104BIT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: 40bit key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">wep</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_WEP_SEC_40BIT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: NO encryption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wep</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_WEP_SEC_NONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* issue wep setup */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_SET_WEP_CFG</span><span class="p">,</span>
				   <span class="n">wep</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wep</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wep</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">wpasecstr</span><span class="p">(</span><span class="k">enum</span> <span class="n">gelic_eurus_wpa_security</span> <span class="n">sec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_NONE</span>:
		<span class="k">return</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA_TKIP_TKIP</span>:
		<span class="k">return</span> <span class="s">&quot;WPA_TKIP_TKIP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA_TKIP_AES</span>:
		<span class="k">return</span> <span class="s">&quot;WPA_TKIP_AES&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA_AES_AES</span>:
		<span class="k">return</span> <span class="s">&quot;WPA_AES_AES&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA2_TKIP_TKIP</span>:
		<span class="k">return</span> <span class="s">&quot;WPA2_TKIP_TKIP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA2_TKIP_AES</span>:
		<span class="k">return</span> <span class="s">&quot;WPA2_TKIP_AES&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA2_AES_AES</span>:
		<span class="k">return</span> <span class="s">&quot;WPA2_AES_AES&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_do_wpa_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_wpa_cfg</span> <span class="o">*</span><span class="n">wpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">security</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* we can assume no one should uses the buffer */</span>
	<span class="n">wpa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gelic_eurus_wpa_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wpa</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wpa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wpa</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_WPA_PSK_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: PSK not configured yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* copy key */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wpa</span><span class="o">-&gt;</span><span class="n">psk</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk_len</span><span class="p">);</span>

	<span class="cm">/* set security level */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">==</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_AES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">security</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA2_AES_AES</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_AES</span> <span class="o">&amp;&amp;</span>
			    <span class="n">precise_ie</span><span class="p">())</span>
				<span class="n">security</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA2_TKIP_AES</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">security</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA2_TKIP_TKIP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_AES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">security</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA_AES_AES</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_AES</span> <span class="o">&amp;&amp;</span>
			    <span class="n">precise_ie</span><span class="p">())</span>
				<span class="n">security</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA_TKIP_AES</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">security</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_SEC_WPA_TKIP_TKIP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wpa</span><span class="o">-&gt;</span><span class="n">security</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">security</span><span class="p">);</span>

	<span class="cm">/* PSK type */</span>
	<span class="n">wpa</span><span class="o">-&gt;</span><span class="n">psk_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk_type</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: sec=%s psktype=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">wpasecstr</span><span class="p">(</span><span class="n">wpa</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">),</span>
		 <span class="p">(</span><span class="n">wpa</span><span class="o">-&gt;</span><span class="n">psk_type</span> <span class="o">==</span> <span class="n">GELIC_EURUS_WPA_PSK_BIN</span><span class="p">)</span> <span class="o">?</span>
		 <span class="s">&quot;BIN&quot;</span> <span class="o">:</span> <span class="s">&quot;passphrase&quot;</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * don&#39;t enable here if you plan to submit</span>
<span class="c">	 * the debug log because this dumps your precious</span>
<span class="c">	 * passphrase/key.</span>
<span class="c">	 */</span>
<span class="c">	pr_debug(&quot;%s: psk=%s\n&quot;, __func__,</span>
<span class="c">		 (wpa-&gt;psk_type == GELIC_EURUS_WPA_PSK_BIN) ?</span>
<span class="c">		 &quot;N/A&quot; : wpa-&gt;psk);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="cm">/* issue wpa setup */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_SET_WPA_CFG</span><span class="p">,</span>
				   <span class="n">wpa</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wpa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wpa</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start association. caller must hold assoc_stat_lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_associate_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_common_cfg</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* do common config */</span>
	<span class="n">common</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gelic_eurus_common_cfg</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">common</span><span class="p">));</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_BSS_INFRA</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">op_mode</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_OPMODE_11BG</span><span class="p">);</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">scan_index</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">eurus_index</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span>:
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_EURUS_AUTH_SHARED</span>:
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">GELIC_EURUS_AUTH_SHARED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">scan_list_dump</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: common cfg index=%d bsstype=%d auth=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">scan_index</span><span class="p">),</span>
		 <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">),</span>
		 <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">auth_method</span><span class="p">));</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_SET_COMMON_CFG</span><span class="p">,</span>
				   <span class="n">common</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">common</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* WEP/WPA */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span>:
		<span class="cm">/* If WEP or no security, setup WEP config */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gelic_wl_do_wep_setup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span>:
	<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gelic_wl_do_wpa_setup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WEP/WPA setup failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start association */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_done</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATING</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_ASSOC</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: assoc request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_ASSOC_STAT_DISCONN</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* wait for connected event */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_done</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span><span class="cm">/*FIXME*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* timeouted.  Maybe key or cyrpt mode is wrong */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: connect timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_DISASSOC</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_ASSOC_STAT_DISCONN</span><span class="p">;</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">;</span>
		<span class="cm">/* copy bssid */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="cm">/* send connect event */</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_bssid</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">common</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * connected event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_connected_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">desired_event</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span>:
		<span class="n">desired_event</span> <span class="o">=</span> <span class="n">GELIC_LV1_WL_EVENT_CONNECTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA</span>:
	<span class="k">case</span> <span class="n">GELIC_WL_WPA_LEVEL_WPA2</span>:
		<span class="n">desired_event</span> <span class="o">=</span> <span class="n">GELIC_LV1_WL_EVENT_WPA_CONNECTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desired_event</span> <span class="o">==</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_done</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">port_to_netdev</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: event %#llx under wpa</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * disconnect event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_disconnect_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				      <span class="n">u64</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we fall here in the middle of association,</span>
<span class="cm">	 * associate_bss() should be waiting for complation of</span>
<span class="cm">	 * wl-&gt;assoc_done.</span>
<span class="cm">	 * As it waits with timeout, just leave assoc_done</span>
<span class="cm">	 * uncompleted, then it terminates with timeout</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: already locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: obtain lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_DISASSOC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* send disconnected event to the supplicant */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">)</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_ASSOC_STAT_DISCONN</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">port_to_netdev</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * event worker</span>
<span class="cm"> */</span>
<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">eventstr</span><span class="p">(</span><span class="k">enum</span> <span class="n">gelic_lv1_wl_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_DEVICE_READY</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;EURUS_READY&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_SCAN_COMPLETED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;SCAN_COMPLETED&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_DEAUTH</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;DEAUTH&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_BEACON_LOST</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;BEACON_LOST&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_CONNECTED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;CONNECTED&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_WPA_CONNECTED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;WPA_CONNECTED&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">GELIC_LV1_WL_EVENT_WPA_ERROR</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;WPA_ERROR&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Unknown(%#x)&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">eventstr</span><span class="p">(</span><span class="k">enum</span> <span class="n">gelic_lv1_wl_event</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_event_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">event</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gelic_wl_info</span><span class="p">,</span> <span class="n">event_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">lv1_net_control</span><span class="p">(</span><span class="n">bus_id</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">),</span> <span class="n">dev_id</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">),</span>
					 <span class="n">GELIC_LV1_GET_WLAN_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">LV1_NO_ENTRY</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:wlan event failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* got all events */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: event=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">eventstr</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GELIC_LV1_WL_EVENT_SCAN_COMPLETED</span>:
			<span class="n">gelic_wl_scan_complete_event</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GELIC_LV1_WL_EVENT_BEACON_LOST</span>:
		<span class="k">case</span> <span class="n">GELIC_LV1_WL_EVENT_DEAUTH</span>:
			<span class="n">gelic_wl_disconnect_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GELIC_LV1_WL_EVENT_CONNECTED</span>:
		<span class="k">case</span> <span class="n">GELIC_LV1_WL_EVENT_WPA_CONNECTED</span>:
			<span class="n">gelic_wl_connected_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* while */</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * association worker</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_assoc_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">best_bss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">essid</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">essid_len</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gelic_wl_info</span><span class="p">,</span> <span class="n">assoc_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">!=</span> <span class="n">GELIC_WL_ASSOC_STAT_DISCONN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_ESSID_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: assoc ESSID configured %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>
		<span class="n">essid</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">;</span>
		<span class="n">essid_len</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">essid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">essid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflag</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gelic_wl_start_scan</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">essid_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: scan start failed association</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_work</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/*FIXME*/</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: scan prerequisite failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for bss scan completion</span>
<span class="cm">	 * If we have scan list already, gelic_wl_start_scan()</span>
<span class="cm">	 * returns OK and raises the complete.  Thus,</span>
<span class="cm">	 * it&#39;s ok to wait unconditionally here</span>
<span class="cm">	 */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: scan done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">!=</span> <span class="n">GELIC_WL_SCAN_STAT_GOT_LIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: no scan list. association failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">scan_lock_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find best matching bss */</span>
	<span class="n">best_bss</span> <span class="o">=</span> <span class="n">gelic_wl_find_best_bss</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">best_bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: no bss matched. association failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">scan_lock_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ok, do association */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gelic_wl_associate_bss</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">best_bss</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: association failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="nl">scan_lock_out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Interrupt handler</span>
<span class="cm"> * Called from the ethernet interrupt handler</span>
<span class="cm"> * Processes wireless specific virtual interrupts only</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gelic_wl_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GELIC_CARD_WLAN_COMMAND_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:cmd complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_done_intr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">GELIC_CARD_WLAN_EVENT_RECEIVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:event received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * driver helpers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">gelic_wl_wext_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">,</span> <span class="n">gelic_wl_get_name</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">,</span> <span class="n">gelic_wl_get_range</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSCAN</span><span class="p">,</span> <span class="n">gelic_wl_set_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="n">gelic_wl_get_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAUTH</span><span class="p">,</span> <span class="n">gelic_wl_set_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAUTH</span><span class="p">,</span> <span class="n">gelic_wl_get_auth</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">,</span> <span class="n">gelic_wl_set_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">,</span> <span class="n">gelic_wl_get_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODE</span><span class="p">,</span> <span class="n">gelic_wl_set_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODE</span><span class="p">,</span> <span class="n">gelic_wl_get_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAP</span><span class="p">,</span> <span class="n">gelic_wl_set_ap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="n">gelic_wl_get_ap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWENCODEEXT</span><span class="p">,</span> <span class="n">gelic_wl_set_encodeext</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODEEXT</span><span class="p">,</span> <span class="n">gelic_wl_get_encodeext</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">,</span> <span class="n">gelic_wl_set_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">,</span> <span class="n">gelic_wl_get_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNICKN</span><span class="p">,</span> <span class="n">gelic_wl_get_nick</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">gelic_wl_wext_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gelic_wl_wext_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span>		<span class="o">=</span> <span class="n">gelic_wl_wext_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span>	<span class="o">=</span> <span class="n">gelic_wl_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">gelic_wl_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_port</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: netdev =%p card=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">GELIC_PORT_WIRELESS</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: wl=%p port=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* allocate scan list */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">networks</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_scan_info</span><span class="p">)</span> <span class="o">*</span>
			       <span class="n">GELIC_WL_BSS_MAX_ENT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_bss</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">eurus_cmd_queue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;gelic_cmd&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">eurus_cmd_queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_cmd_workqueue</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_queue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;gelic_event&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_event_workqueue</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GELIC_WL_BSS_MAX_ENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_done_intr</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">gelic_wl_event_worker</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_work</span><span class="p">,</span> <span class="n">gelic_wl_assoc_worker</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat_lock</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>
	<span class="cm">/* for the case that no scan request is issued and stop() is called */</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_age</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span> <span class="cm">/* FIXME */</span>

	<span class="cm">/* buffer for receiving scanned list etc */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">&lt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_eurus_scan_info</span><span class="p">)</span> <span class="o">*</span>
		     <span class="n">GELIC_EURUS_MAX_SCAN</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">netdev</span><span class="p">;</span>

<span class="nl">fail_event_workqueue:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">eurus_cmd_queue</span><span class="p">);</span>
<span class="nl">fail_cmd_workqueue:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">);</span>
<span class="nl">fail_bss:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:end error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">scan_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: destroy queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">eurus_cmd_queue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">);</span>

	<span class="n">scan_info</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GELIC_WL_BSS_MAX_ENT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">scan_info</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scan_info</span><span class="o">-&gt;</span><span class="n">hwinfo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">port_to_netdev</span><span class="p">(</span><span class="n">wl_port</span><span class="p">(</span><span class="n">wl</span><span class="p">)));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: -&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_try_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* check constraits for start association */</span>
	<span class="cm">/* for no access restriction AP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_CONFIGURED</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">do_associate</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: no wep, not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* for WEP, one of four keys should be set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_WEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* one of keys set */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GELIC_WEP_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span><span class="p">))</span>
			    <span class="k">goto</span> <span class="n">do_associate</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WEP, but no key specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for WPA[2], psk should be set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_TKIP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">==</span> <span class="n">GELIC_WL_CIPHER_AES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">GELIC_WL_STAT_WPA_PSK_SET</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">do_associate</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: AES/TKIP, but PSK not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">do_associate:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: start association work %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * netdev handlers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_card</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:-&gt;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">gelic_card_up</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* try to associate */</span>
	<span class="n">gelic_wl_try_associate</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:&lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gelic_wl_scan_info</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* empty scan list */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_SCAN_STAT_INIT</span><span class="p">;</span>

	<span class="cm">/* clear configuration */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">GELIC_EURUS_AUTH_OPEN</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">group_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_method</span> <span class="o">=</span> <span class="n">GELIC_WL_CIPHER_NONE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wpa_level</span> <span class="o">=</span> <span class="n">GELIC_WL_WPA_LEVEL_NONE</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">key_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk_type</span> <span class="o">=</span> <span class="n">GELIC_EURUS_WPA_PSK_PASSPHRASE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psk_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_bssid</span><span class="p">));</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">=</span> <span class="n">GELIC_WL_ASSOC_STAT_DISCONN</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">iwstat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">iwstat</span><span class="p">));</span>
	<span class="cm">/* all status bit clear */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tell eurus to terminate association</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gelic_wl_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gelic_eurus_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If scann process is running on chip,</span>
<span class="cm">	 * further requests will be rejected</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_SCAN_STAT_SCANNING</span><span class="p">)</span>
		<span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_done</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">gelic_eurus_sync_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">GELIC_EURUS_CMD_DISASSOC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">gelic_wl_send_iwap_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gelic_wl_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_card</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:&lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cancel pending association work.</span>
<span class="cm">	 * event work can run after netdev down</span>
<span class="cm">	 */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">)</span>
		<span class="n">gelic_wl_disconnect</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* reset our state machine */</span>
	<span class="n">gelic_wl_reset_state</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">gelic_card_down</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:-&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">gelic_wl_netdevice_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">gelic_wl_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">gelic_wl_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">gelic_net_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span> <span class="o">=</span> <span class="n">gelic_net_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">gelic_net_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">gelic_net_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span> <span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span> <span class="o">=</span> <span class="n">gelic_net_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">gelic_wl_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">gelic_net_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>	<span class="o">=</span> <span class="n">gelic_wl_get_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">gelic_wl_setup_netdev_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">GELIC_NET_WATCHDOG_TIMEOUT</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gelic_wl_ethtool_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gelic_wl_netdevice_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gelic_wl_wext_handler_def</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * driver probe/remove</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">gelic_wl_driver_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3_compare_firmware_version</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">[</span><span class="n">GELIC_PORT_WIRELESS</span><span class="p">].</span><span class="n">tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* alloc netdevice for wireless */</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">gelic_wl_alloc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* setup net_device structure */</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">);</span>
	<span class="n">gelic_wl_setup_netdev_ops</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* setup some of net_device and register it */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gelic_net_setup_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_setup</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">[</span><span class="n">GELIC_PORT_WIRELESS</span><span class="p">]</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* add enable wireless interrupt */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">GELIC_CARD_WLAN_EVENT_RECEIVED</span> <span class="o">|</span>
		<span class="n">GELIC_CARD_WLAN_COMMAND_COMPLETED</span><span class="p">;</span>
	<span class="cm">/* to allow wireless commands while both interfaces are down */</span>
	<span class="n">gelic_card_set_irq_mask</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">GELIC_CARD_WLAN_EVENT_RECEIVED</span> <span class="o">|</span>
				<span class="n">GELIC_CARD_WLAN_COMMAND_COMPLETED</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_setup:</span>
	<span class="n">gelic_wl_free</span><span class="p">(</span><span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_port</span><span class="p">(</span><span class="n">netdev</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gelic_wl_driver_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">gelic_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gelic_wl_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3_compare_firmware_version</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vlan</span><span class="p">[</span><span class="n">GELIC_PORT_WIRELESS</span><span class="p">].</span><span class="n">tx</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">[</span><span class="n">GELIC_PORT_WIRELESS</span><span class="p">];</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">port_wl</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>

	<span class="cm">/* if the interface was not up, but associated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_stat</span> <span class="o">==</span> <span class="n">GELIC_WL_ASSOC_STAT_ASSOCIATED</span><span class="p">)</span>
		<span class="n">gelic_wl_disconnect</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_done_intr</span><span class="p">);</span>

	<span class="cm">/* cancel all work queue */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">assoc_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">eurus_cmd_queue</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">event_queue</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* disable wireless interrupt */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: disable intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GELIC_CARD_WLAN_EVENT_RECEIVED</span> <span class="o">|</span>
			    <span class="n">GELIC_CARD_WLAN_COMMAND_COMPLETED</span><span class="p">);</span>
	<span class="cm">/* free bss list, netdev*/</span>
	<span class="n">gelic_wl_free</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
