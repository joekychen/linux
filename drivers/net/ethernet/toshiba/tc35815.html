<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › toshiba › tc35815.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tc35815.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * tc35815.c: A TOSHIBA TC35815CF PCI 10/100Mbps ethernet driver for linux.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on skelton.c by Donald Becker.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is a replacement of older and less maintained version.</span>
<span class="cm"> * This is a header of the older version:</span>
<span class="cm"> *	-----&lt;snip&gt;-----</span>
<span class="cm"> *	Copyright 2001 MontaVista Software Inc.</span>
<span class="cm"> *	Author: MontaVista Software, Inc.</span>
<span class="cm"> *		ahennessy@mvista.com</span>
<span class="cm"> *	Copyright (C) 2000-2001 Toshiba Corporation</span>
<span class="cm"> *	static const char *version =</span>
<span class="cm"> *		&quot;tc35815.c:v0.00 26/07/2000 by Toshiba Corporation\n&quot;;</span>
<span class="cm"> *	-----&lt;snip&gt;-----</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright TOSHIBA CORPORATION 2004-2005</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> */</span>

<span class="cp">#define DRV_VERSION	&quot;1.39&quot;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;tc35815.c:v&quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="cp">#define MODNAME			&quot;tc35815&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/phy.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="k">enum</span> <span class="n">tc35815_chiptype</span> <span class="p">{</span>
	<span class="n">TC35815CF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TC35815_NWU</span><span class="p">,</span>
	<span class="n">TC35815_TX4939</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* indexed by tc35815_chiptype, above */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">chip_info</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;TOSHIBA TC35815CF 10/100BaseTX&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TOSHIBA TC35815 with Wake on LAN&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;TOSHIBA TC35815/TX4939&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">tc35815_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOSHIBA_2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TOSHIBA_TC35815CF</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">TC35815CF</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOSHIBA_2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TOSHIBA_TC35815_NWU</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">TC35815_NWU</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TOSHIBA_2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TOSHIBA_TC35815_TX4939</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">TC35815_TX4939</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">tc35815_pci_tbl</span><span class="p">);</span>

<span class="cm">/* see MODULE_PARM_DESC */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tc35815_options</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>
<span class="p">}</span> <span class="n">options</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Registers</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">DMA_Ctl</span><span class="p">;</span>		<span class="cm">/* 0x00 */</span>
	<span class="n">__u32</span> <span class="n">TxFrmPtr</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">TxThrsh</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">TxPollCtr</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">BLFrmPtr</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">RxFragSize</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Int_En</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">FDA_Bas</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">FDA_Lim</span><span class="p">;</span>		<span class="cm">/* 0x20 */</span>
	<span class="n">__u32</span> <span class="n">Int_Src</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">unused0</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__u32</span> <span class="n">PauseCnt</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">RemPauCnt</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">TxCtlFrmStat</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">unused1</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">MAC_Ctl</span><span class="p">;</span>		<span class="cm">/* 0x40 */</span>
	<span class="n">__u32</span> <span class="n">CAM_Ctl</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Tx_Ctl</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Tx_Stat</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Rx_Ctl</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Rx_Stat</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">MD_Data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">MD_CA</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">CAM_Adr</span><span class="p">;</span>		<span class="cm">/* 0x60 */</span>
	<span class="n">__u32</span> <span class="n">CAM_Data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">CAM_Ena</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">PROM_Ctl</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">PROM_Data</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Algn_Cnt</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">CRC_Cnt</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">Miss_Cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Bit assignments</span>
<span class="cm"> */</span>
<span class="cm">/* DMA_Ctl bit assign ------------------------------------------------------- */</span>
<span class="cp">#define DMA_RxAlign	       0x00c00000 </span><span class="cm">/* 1:Reception Alignment	     */</span><span class="cp"></span>
<span class="cp">#define DMA_RxAlign_1	       0x00400000</span>
<span class="cp">#define DMA_RxAlign_2	       0x00800000</span>
<span class="cp">#define DMA_RxAlign_3	       0x00c00000</span>
<span class="cp">#define DMA_M66EnStat	       0x00080000 </span><span class="cm">/* 1:66MHz Enable State	     */</span><span class="cp"></span>
<span class="cp">#define DMA_IntMask	       0x00040000 </span><span class="cm">/* 1:Interrupt mask		     */</span><span class="cp"></span>
<span class="cp">#define DMA_SWIntReq	       0x00020000 </span><span class="cm">/* 1:Software Interrupt request    */</span><span class="cp"></span>
<span class="cp">#define DMA_TxWakeUp	       0x00010000 </span><span class="cm">/* 1:Transmit Wake Up		     */</span><span class="cp"></span>
<span class="cp">#define DMA_RxBigE	       0x00008000 </span><span class="cm">/* 1:Receive Big Endian	     */</span><span class="cp"></span>
<span class="cp">#define DMA_TxBigE	       0x00004000 </span><span class="cm">/* 1:Transmit Big Endian	     */</span><span class="cp"></span>
<span class="cp">#define DMA_TestMode	       0x00002000 </span><span class="cm">/* 1:Test Mode		     */</span><span class="cp"></span>
<span class="cp">#define DMA_PowrMgmnt	       0x00001000 </span><span class="cm">/* 1:Power Management		     */</span><span class="cp"></span>
<span class="cp">#define DMA_DmBurst_Mask       0x000001fc </span><span class="cm">/* DMA Burst size		     */</span><span class="cp"></span>

<span class="cm">/* RxFragSize bit assign ---------------------------------------------------- */</span>
<span class="cp">#define RxFrag_EnPack	       0x00008000 </span><span class="cm">/* 1:Enable Packing		     */</span><span class="cp"></span>
<span class="cp">#define RxFrag_MinFragMask     0x00000ffc </span><span class="cm">/* Minimum Fragment		     */</span><span class="cp"></span>

<span class="cm">/* MAC_Ctl bit assign ------------------------------------------------------- */</span>
<span class="cp">#define MAC_Link10	       0x00008000 </span><span class="cm">/* 1:Link Status 10Mbits	     */</span><span class="cp"></span>
<span class="cp">#define MAC_EnMissRoll	       0x00002000 </span><span class="cm">/* 1:Enable Missed Roll	     */</span><span class="cp"></span>
<span class="cp">#define MAC_MissRoll	       0x00000400 </span><span class="cm">/* 1:Missed Roll		     */</span><span class="cp"></span>
<span class="cp">#define MAC_Loop10	       0x00000080 </span><span class="cm">/* 1:Loop 10 Mbps		     */</span><span class="cp"></span>
<span class="cp">#define MAC_Conn_Auto	       0x00000000 </span><span class="cm">/*00:Connection mode (Automatic)   */</span><span class="cp"></span>
<span class="cp">#define MAC_Conn_10M	       0x00000020 </span><span class="cm">/*01:		       (10Mbps endec)*/</span><span class="cp"></span>
<span class="cp">#define MAC_Conn_Mll	       0x00000040 </span><span class="cm">/*10:		       (Mll clock)   */</span><span class="cp"></span>
<span class="cp">#define MAC_MacLoop	       0x00000010 </span><span class="cm">/* 1:MAC Loopback		     */</span><span class="cp"></span>
<span class="cp">#define MAC_FullDup	       0x00000008 </span><span class="cm">/* 1:Full Duplex 0:Half Duplex     */</span><span class="cp"></span>
<span class="cp">#define MAC_Reset	       0x00000004 </span><span class="cm">/* 1:Software Reset		     */</span><span class="cp"></span>
<span class="cp">#define MAC_HaltImm	       0x00000002 </span><span class="cm">/* 1:Halt Immediate		     */</span><span class="cp"></span>
<span class="cp">#define MAC_HaltReq	       0x00000001 </span><span class="cm">/* 1:Halt request		     */</span><span class="cp"></span>

<span class="cm">/* PROM_Ctl bit assign ------------------------------------------------------ */</span>
<span class="cp">#define PROM_Busy	       0x00008000 </span><span class="cm">/* 1:Busy (Start Operation)	     */</span><span class="cp"></span>
<span class="cp">#define PROM_Read	       0x00004000 </span><span class="cm">/*10:Read operation		     */</span><span class="cp"></span>
<span class="cp">#define PROM_Write	       0x00002000 </span><span class="cm">/*01:Write operation		     */</span><span class="cp"></span>
<span class="cp">#define PROM_Erase	       0x00006000 </span><span class="cm">/*11:Erase operation		     */</span><span class="cp"></span>
					  <span class="cm">/*00:Enable or Disable Writting,   */</span>
					  <span class="cm">/*	  as specified in PROM_Addr. */</span>
<span class="cp">#define PROM_Addr_Ena	       0x00000030 </span><span class="cm">/*11xxxx:PROM Write enable	     */</span><span class="cp"></span>
					  <span class="cm">/*00xxxx:	      disable	     */</span>

<span class="cm">/* CAM_Ctl bit assign ------------------------------------------------------- */</span>
<span class="cp">#define CAM_CompEn	       0x00000010 </span><span class="cm">/* 1:CAM Compare Enable	     */</span><span class="cp"></span>
<span class="cp">#define CAM_NegCAM	       0x00000008 </span><span class="cm">/* 1:Reject packets CAM recognizes,*/</span><span class="cp"></span>
					  <span class="cm">/*			accept other */</span>
<span class="cp">#define CAM_BroadAcc	       0x00000004 </span><span class="cm">/* 1:Broadcast assept		     */</span><span class="cp"></span>
<span class="cp">#define CAM_GroupAcc	       0x00000002 </span><span class="cm">/* 1:Multicast assept		     */</span><span class="cp"></span>
<span class="cp">#define CAM_StationAcc	       0x00000001 </span><span class="cm">/* 1:unicast accept		     */</span><span class="cp"></span>

<span class="cm">/* CAM_Ena bit assign ------------------------------------------------------- */</span>
<span class="cp">#define CAM_ENTRY_MAX		       21   </span><span class="cm">/* CAM Data entry max count	     */</span><span class="cp"></span>
<span class="cp">#define CAM_Ena_Mask ((1&lt;&lt;CAM_ENTRY_MAX)-1) </span><span class="cm">/* CAM Enable bits (Max 21bits)  */</span><span class="cp"></span>
<span class="cp">#define CAM_Ena_Bit(index)	(1 &lt;&lt; (index))</span>
<span class="cp">#define CAM_ENTRY_DESTINATION	0</span>
<span class="cp">#define CAM_ENTRY_SOURCE	1</span>
<span class="cp">#define CAM_ENTRY_MACCTL	20</span>

<span class="cm">/* Tx_Ctl bit assign -------------------------------------------------------- */</span>
<span class="cp">#define Tx_En		       0x00000001 </span><span class="cm">/* 1:Transmit enable		     */</span><span class="cp"></span>
<span class="cp">#define Tx_TxHalt	       0x00000002 </span><span class="cm">/* 1:Transmit Halt Request	     */</span><span class="cp"></span>
<span class="cp">#define Tx_NoPad	       0x00000004 </span><span class="cm">/* 1:Suppress Padding		     */</span><span class="cp"></span>
<span class="cp">#define Tx_NoCRC	       0x00000008 </span><span class="cm">/* 1:Suppress Padding		     */</span><span class="cp"></span>
<span class="cp">#define Tx_FBack	       0x00000010 </span><span class="cm">/* 1:Fast Back-off		     */</span><span class="cp"></span>
<span class="cp">#define Tx_EnUnder	       0x00000100 </span><span class="cm">/* 1:Enable Underrun		     */</span><span class="cp"></span>
<span class="cp">#define Tx_EnExDefer	       0x00000200 </span><span class="cm">/* 1:Enable Excessive Deferral     */</span><span class="cp"></span>
<span class="cp">#define Tx_EnLCarr	       0x00000400 </span><span class="cm">/* 1:Enable Lost Carrier	     */</span><span class="cp"></span>
<span class="cp">#define Tx_EnExColl	       0x00000800 </span><span class="cm">/* 1:Enable Excessive Collision    */</span><span class="cp"></span>
<span class="cp">#define Tx_EnLateColl	       0x00001000 </span><span class="cm">/* 1:Enable Late Collision	     */</span><span class="cp"></span>
<span class="cp">#define Tx_EnTxPar	       0x00002000 </span><span class="cm">/* 1:Enable Transmit Parity	     */</span><span class="cp"></span>
<span class="cp">#define Tx_EnComp	       0x00004000 </span><span class="cm">/* 1:Enable Completion	     */</span><span class="cp"></span>

<span class="cm">/* Tx_Stat bit assign ------------------------------------------------------- */</span>
<span class="cp">#define Tx_TxColl_MASK	       0x0000000F </span><span class="cm">/* Tx Collision Count		     */</span><span class="cp"></span>
<span class="cp">#define Tx_ExColl	       0x00000010 </span><span class="cm">/* Excessive Collision	     */</span><span class="cp"></span>
<span class="cp">#define Tx_TXDefer	       0x00000020 </span><span class="cm">/* Transmit Defered		     */</span><span class="cp"></span>
<span class="cp">#define Tx_Paused	       0x00000040 </span><span class="cm">/* Transmit Paused		     */</span><span class="cp"></span>
<span class="cp">#define Tx_IntTx	       0x00000080 </span><span class="cm">/* Interrupt on Tx		     */</span><span class="cp"></span>
<span class="cp">#define Tx_Under	       0x00000100 </span><span class="cm">/* Underrun			     */</span><span class="cp"></span>
<span class="cp">#define Tx_Defer	       0x00000200 </span><span class="cm">/* Deferral			     */</span><span class="cp"></span>
<span class="cp">#define Tx_NCarr	       0x00000400 </span><span class="cm">/* No Carrier			     */</span><span class="cp"></span>
<span class="cp">#define Tx_10Stat	       0x00000800 </span><span class="cm">/* 10Mbps Status		     */</span><span class="cp"></span>
<span class="cp">#define Tx_LateColl	       0x00001000 </span><span class="cm">/* Late Collision		     */</span><span class="cp"></span>
<span class="cp">#define Tx_TxPar	       0x00002000 </span><span class="cm">/* Tx Parity Error		     */</span><span class="cp"></span>
<span class="cp">#define Tx_Comp		       0x00004000 </span><span class="cm">/* Completion			     */</span><span class="cp"></span>
<span class="cp">#define Tx_Halted	       0x00008000 </span><span class="cm">/* Tx Halted			     */</span><span class="cp"></span>
<span class="cp">#define Tx_SQErr	       0x00010000 </span><span class="cm">/* Signal Quality Error(SQE)	     */</span><span class="cp"></span>

<span class="cm">/* Rx_Ctl bit assign -------------------------------------------------------- */</span>
<span class="cp">#define Rx_EnGood	       0x00004000 </span><span class="cm">/* 1:Enable Good		     */</span><span class="cp"></span>
<span class="cp">#define Rx_EnRxPar	       0x00002000 </span><span class="cm">/* 1:Enable Receive Parity	     */</span><span class="cp"></span>
<span class="cp">#define Rx_EnLongErr	       0x00000800 </span><span class="cm">/* 1:Enable Long Error	     */</span><span class="cp"></span>
<span class="cp">#define Rx_EnOver	       0x00000400 </span><span class="cm">/* 1:Enable OverFlow		     */</span><span class="cp"></span>
<span class="cp">#define Rx_EnCRCErr	       0x00000200 </span><span class="cm">/* 1:Enable CRC Error		     */</span><span class="cp"></span>
<span class="cp">#define Rx_EnAlign	       0x00000100 </span><span class="cm">/* 1:Enable Alignment		     */</span><span class="cp"></span>
<span class="cp">#define Rx_IgnoreCRC	       0x00000040 </span><span class="cm">/* 1:Ignore CRC Value		     */</span><span class="cp"></span>
<span class="cp">#define Rx_StripCRC	       0x00000010 </span><span class="cm">/* 1:Strip CRC Value		     */</span><span class="cp"></span>
<span class="cp">#define Rx_ShortEn	       0x00000008 </span><span class="cm">/* 1:Short Enable		     */</span><span class="cp"></span>
<span class="cp">#define Rx_LongEn	       0x00000004 </span><span class="cm">/* 1:Long Enable		     */</span><span class="cp"></span>
<span class="cp">#define Rx_RxHalt	       0x00000002 </span><span class="cm">/* 1:Receive Halt Request	     */</span><span class="cp"></span>
<span class="cp">#define Rx_RxEn		       0x00000001 </span><span class="cm">/* 1:Receive Intrrupt Enable	     */</span><span class="cp"></span>

<span class="cm">/* Rx_Stat bit assign ------------------------------------------------------- */</span>
<span class="cp">#define Rx_Halted	       0x00008000 </span><span class="cm">/* Rx Halted			     */</span><span class="cp"></span>
<span class="cp">#define Rx_Good		       0x00004000 </span><span class="cm">/* Rx Good			     */</span><span class="cp"></span>
<span class="cp">#define Rx_RxPar	       0x00002000 </span><span class="cm">/* Rx Parity Error		     */</span><span class="cp"></span>
<span class="cp">#define Rx_TypePkt	       0x00001000 </span><span class="cm">/* Rx Type Packet		     */</span><span class="cp"></span>
<span class="cp">#define Rx_LongErr	       0x00000800 </span><span class="cm">/* Rx Long Error		     */</span><span class="cp"></span>
<span class="cp">#define Rx_Over		       0x00000400 </span><span class="cm">/* Rx Overflow		     */</span><span class="cp"></span>
<span class="cp">#define Rx_CRCErr	       0x00000200 </span><span class="cm">/* Rx CRC Error		     */</span><span class="cp"></span>
<span class="cp">#define Rx_Align	       0x00000100 </span><span class="cm">/* Rx Alignment Error		     */</span><span class="cp"></span>
<span class="cp">#define Rx_10Stat	       0x00000080 </span><span class="cm">/* Rx 10Mbps Status		     */</span><span class="cp"></span>
<span class="cp">#define Rx_IntRx	       0x00000040 </span><span class="cm">/* Rx Interrupt		     */</span><span class="cp"></span>
<span class="cp">#define Rx_CtlRecd	       0x00000020 </span><span class="cm">/* Rx Control Receive		     */</span><span class="cp"></span>
<span class="cp">#define Rx_InLenErr	       0x00000010 </span><span class="cm">/* Rx In Range Frame Length Error  */</span><span class="cp"></span>

<span class="cp">#define Rx_Stat_Mask	       0x0000FFF0 </span><span class="cm">/* Rx All Status Mask		     */</span><span class="cp"></span>

<span class="cm">/* Int_En bit assign -------------------------------------------------------- */</span>
<span class="cp">#define Int_NRAbtEn	       0x00000800 </span><span class="cm">/* 1:Non-recoverable Abort Enable  */</span><span class="cp"></span>
<span class="cp">#define Int_TxCtlCmpEn	       0x00000400 </span><span class="cm">/* 1:Transmit Ctl Complete Enable  */</span><span class="cp"></span>
<span class="cp">#define Int_DmParErrEn	       0x00000200 </span><span class="cm">/* 1:DMA Parity Error Enable	     */</span><span class="cp"></span>
<span class="cp">#define Int_DParDEn	       0x00000100 </span><span class="cm">/* 1:Data Parity Error Enable	     */</span><span class="cp"></span>
<span class="cp">#define Int_EarNotEn	       0x00000080 </span><span class="cm">/* 1:Early Notify Enable	     */</span><span class="cp"></span>
<span class="cp">#define Int_DParErrEn	       0x00000040 </span><span class="cm">/* 1:Detected Parity Error Enable  */</span><span class="cp"></span>
<span class="cp">#define Int_SSysErrEn	       0x00000020 </span><span class="cm">/* 1:Signalled System Error Enable */</span><span class="cp"></span>
<span class="cp">#define Int_RMasAbtEn	       0x00000010 </span><span class="cm">/* 1:Received Master Abort Enable  */</span><span class="cp"></span>
<span class="cp">#define Int_RTargAbtEn	       0x00000008 </span><span class="cm">/* 1:Received Target Abort Enable  */</span><span class="cp"></span>
<span class="cp">#define Int_STargAbtEn	       0x00000004 </span><span class="cm">/* 1:Signalled Target Abort Enable */</span><span class="cp"></span>
<span class="cp">#define Int_BLExEn	       0x00000002 </span><span class="cm">/* 1:Buffer List Exhausted Enable  */</span><span class="cp"></span>
<span class="cp">#define Int_FDAExEn	       0x00000001 </span><span class="cm">/* 1:Free Descriptor Area	     */</span><span class="cp"></span>
					  <span class="cm">/*		   Exhausted Enable  */</span>

<span class="cm">/* Int_Src bit assign ------------------------------------------------------- */</span>
<span class="cp">#define Int_NRabt	       0x00004000 </span><span class="cm">/* 1:Non Recoverable error	     */</span><span class="cp"></span>
<span class="cp">#define Int_DmParErrStat       0x00002000 </span><span class="cm">/* 1:DMA Parity Error &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_BLEx	       0x00001000 </span><span class="cm">/* 1:Buffer List Empty &amp; Clear     */</span><span class="cp"></span>
<span class="cp">#define Int_FDAEx	       0x00000800 </span><span class="cm">/* 1:FDA Empty &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntNRAbt	       0x00000400 </span><span class="cm">/* 1:Non Recoverable Abort	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntCmp	       0x00000200 </span><span class="cm">/* 1:MAC control packet complete   */</span><span class="cp"></span>
<span class="cp">#define Int_IntExBD	       0x00000100 </span><span class="cm">/* 1:Interrupt Extra BD &amp; Clear    */</span><span class="cp"></span>
<span class="cp">#define Int_DmParErr	       0x00000080 </span><span class="cm">/* 1:DMA Parity Error &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntEarNot	       0x00000040 </span><span class="cm">/* 1:Receive Data write &amp; Clear    */</span><span class="cp"></span>
<span class="cp">#define Int_SWInt	       0x00000020 </span><span class="cm">/* 1:Software request &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntBLEx	       0x00000010 </span><span class="cm">/* 1:Buffer List Empty &amp; Clear     */</span><span class="cp"></span>
<span class="cp">#define Int_IntFDAEx	       0x00000008 </span><span class="cm">/* 1:FDA Empty &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntPCI	       0x00000004 </span><span class="cm">/* 1:PCI controller &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntMacRx	       0x00000002 </span><span class="cm">/* 1:Rx controller &amp; Clear	     */</span><span class="cp"></span>
<span class="cp">#define Int_IntMacTx	       0x00000001 </span><span class="cm">/* 1:Tx controller &amp; Clear	     */</span><span class="cp"></span>

<span class="cm">/* MD_CA bit assign --------------------------------------------------------- */</span>
<span class="cp">#define MD_CA_PreSup	       0x00001000 </span><span class="cm">/* 1:Preamble Suppress		     */</span><span class="cp"></span>
<span class="cp">#define MD_CA_Busy	       0x00000800 </span><span class="cm">/* 1:Busy (Start Operation)	     */</span><span class="cp"></span>
<span class="cp">#define MD_CA_Wr	       0x00000400 </span><span class="cm">/* 1:Write 0:Read		     */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * Descriptors</span>
<span class="cm"> */</span>

<span class="cm">/* Frame descripter */</span>
<span class="k">struct</span> <span class="n">FDesc</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">FDNext</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">FDSystem</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">FDStat</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">FDCtl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Buffer descripter */</span>
<span class="k">struct</span> <span class="n">BDesc</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">BuffData</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">BDCtl</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FD_ALIGN	16</span>

<span class="cm">/* Frame Descripter bit assign ---------------------------------------------- */</span>
<span class="cp">#define FD_FDLength_MASK       0x0000FFFF </span><span class="cm">/* Length MASK		     */</span><span class="cp"></span>
<span class="cp">#define FD_BDCnt_MASK	       0x001F0000 </span><span class="cm">/* BD count MASK in FD	     */</span><span class="cp"></span>
<span class="cp">#define FD_FrmOpt_MASK	       0x7C000000 </span><span class="cm">/* Frame option MASK		     */</span><span class="cp"></span>
<span class="cp">#define FD_FrmOpt_BigEndian    0x40000000 </span><span class="cm">/* Tx/Rx */</span><span class="cp"></span>
<span class="cp">#define FD_FrmOpt_IntTx	       0x20000000 </span><span class="cm">/* Tx only */</span><span class="cp"></span>
<span class="cp">#define FD_FrmOpt_NoCRC	       0x10000000 </span><span class="cm">/* Tx only */</span><span class="cp"></span>
<span class="cp">#define FD_FrmOpt_NoPadding    0x08000000 </span><span class="cm">/* Tx only */</span><span class="cp"></span>
<span class="cp">#define FD_FrmOpt_Packing      0x04000000 </span><span class="cm">/* Rx only */</span><span class="cp"></span>
<span class="cp">#define FD_CownsFD	       0x80000000 </span><span class="cm">/* FD Controller owner bit	     */</span><span class="cp"></span>
<span class="cp">#define FD_Next_EOL	       0x00000001 </span><span class="cm">/* FD EOL indicator		     */</span><span class="cp"></span>
<span class="cp">#define FD_BDCnt_SHIFT	       16</span>

<span class="cm">/* Buffer Descripter bit assign --------------------------------------------- */</span>
<span class="cp">#define BD_BuffLength_MASK     0x0000FFFF </span><span class="cm">/* Receive Data Size		     */</span><span class="cp"></span>
<span class="cp">#define BD_RxBDID_MASK	       0x00FF0000 </span><span class="cm">/* BD ID Number MASK		     */</span><span class="cp"></span>
<span class="cp">#define BD_RxBDSeqN_MASK       0x7F000000 </span><span class="cm">/* Rx BD Sequence Number	     */</span><span class="cp"></span>
<span class="cp">#define BD_CownsBD	       0x80000000 </span><span class="cm">/* BD Controller owner bit	     */</span><span class="cp"></span>
<span class="cp">#define BD_RxBDID_SHIFT	       16</span>
<span class="cp">#define BD_RxBDSeqN_SHIFT      24</span>


<span class="cm">/* Some useful constants. */</span>

<span class="cp">#define TX_CTL_CMD	(Tx_EnTxPar | Tx_EnLateColl | \</span>
<span class="cp">	Tx_EnExColl | Tx_EnLCarr | Tx_EnExDefer | Tx_EnUnder | \</span>
<span class="cp">	Tx_En)	</span><span class="cm">/* maybe  0x7b01 */</span><span class="cp"></span>
<span class="cm">/* Do not use Rx_StripCRC -- it causes trouble on BLEx/FDAEx condition */</span>
<span class="cp">#define RX_CTL_CMD	(Rx_EnGood | Rx_EnRxPar | Rx_EnLongErr | Rx_EnOver \</span>
<span class="cp">	| Rx_EnCRCErr | Rx_EnAlign | Rx_RxEn) </span><span class="cm">/* maybe 0x6f01 */</span><span class="cp"></span>
<span class="cp">#define INT_EN_CMD  (Int_NRAbtEn | \</span>
<span class="cp">	Int_DmParErrEn | Int_DParDEn | Int_DParErrEn | \</span>
<span class="cp">	Int_SSysErrEn  | Int_RMasAbtEn | Int_RTargAbtEn | \</span>
<span class="cp">	Int_STargAbtEn | \</span>
<span class="cp">	Int_BLExEn  | Int_FDAExEn) </span><span class="cm">/* maybe 0xb7f*/</span><span class="cp"></span>
<span class="cp">#define DMA_CTL_CMD	DMA_BURST_SIZE</span>
<span class="cp">#define HAVE_DMA_RXALIGN(lp)	likely((lp)-&gt;chiptype != TC35815CF)</span>

<span class="cm">/* Tuning parameters */</span>
<span class="cp">#define DMA_BURST_SIZE	32</span>
<span class="cp">#define TX_THRESHOLD	1024</span>
<span class="cm">/* used threshold with packet max byte for low pci transfer ability.*/</span>
<span class="cp">#define TX_THRESHOLD_MAX 1536</span>
<span class="cm">/* setting threshold max value when overrun error occurred this count. */</span>
<span class="cp">#define TX_THRESHOLD_KEEP_LIMIT 10</span>

<span class="cm">/* 16 + RX_BUF_NUM * 8 + RX_FD_NUM * 16 + TX_FD_NUM * 32 &lt;= PAGE_SIZE*FD_PAGE_NUM */</span>
<span class="cp">#define FD_PAGE_NUM 4</span>
<span class="cp">#define RX_BUF_NUM	128	</span><span class="cm">/* &lt; 256 */</span><span class="cp"></span>
<span class="cp">#define RX_FD_NUM	256	</span><span class="cm">/* &gt;= 32 */</span><span class="cp"></span>
<span class="cp">#define TX_FD_NUM	128</span>
<span class="cp">#if RX_CTL_CMD &amp; Rx_LongEn</span>
<span class="cp">#define RX_BUF_SIZE	PAGE_SIZE</span>
<span class="cp">#elif RX_CTL_CMD &amp; Rx_StripCRC</span>
<span class="cp">#define RX_BUF_SIZE	\</span>
<span class="cp">	L1_CACHE_ALIGN(ETH_FRAME_LEN + VLAN_HLEN + NET_IP_ALIGN)</span>
<span class="cp">#else</span>
<span class="cp">#define RX_BUF_SIZE	\</span>
<span class="cp">	L1_CACHE_ALIGN(ETH_FRAME_LEN + VLAN_HLEN + ETH_FCS_LEN + NET_IP_ALIGN)</span>
<span class="cp">#endif</span>
<span class="cp">#define RX_FD_RESERVE	(2 / 2)	</span><span class="cm">/* max 2 BD per RxFD */</span><span class="cp"></span>
<span class="cp">#define NAPI_WEIGHT	16</span>

<span class="k">struct</span> <span class="n">TxFD</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">FDesc</span> <span class="n">fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BDesc</span> <span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BDesc</span> <span class="n">unused</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">RxFD</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">FDesc</span> <span class="n">fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BDesc</span> <span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* variable length */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">FrFD</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">FDesc</span> <span class="n">fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BDesc</span> <span class="n">bd</span><span class="p">[</span><span class="n">RX_BUF_NUM</span><span class="p">];</span>
<span class="p">};</span>


<span class="cp">#define tc_readl(addr)	ioread32(addr)</span>
<span class="cp">#define tc_writel(d, addr)	iowrite32(d, addr)</span>

<span class="cp">#define TC35815_TX_TIMEOUT  msecs_to_jiffies(400)</span>

<span class="cm">/* Information that need to be kept for each controller. */</span>
<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>

	<span class="cm">/* statistics */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_tx_qlen</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tx_ints</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rx_ints</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tx_underrun</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">lstats</span><span class="p">;</span>

	<span class="cm">/* Tx control lock.  This protects the transmit buffer ring</span>
<span class="cm">	 * state along with the &quot;tx full&quot; state of the driver.  This</span>
<span class="cm">	 * means all netif_queue flow control actions are protected</span>
<span class="cm">	 * by this lock as well.</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">rx_lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">mii_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phy_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">restart_work</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Transmitting: Batch Mode.</span>
<span class="cm">	 *	1 BD in 1 TxFD.</span>
<span class="cm">	 * Receiving: Non-Packing Mode.</span>
<span class="cm">	 *	1 circular FD for Free Buffer List.</span>
<span class="cm">	 *	RX_BUF_NUM BD in Free Buffer FD.</span>
<span class="cm">	 *	One Free Buffer BD has ETH_FRAME_LEN data buffer.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fd_buf</span><span class="p">;</span>	<span class="cm">/* for TxFD, RxFD, FrFD */</span>
	<span class="n">dma_addr_t</span> <span class="n">fd_buf_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tfd_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tfd_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tfd_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rfd_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rfd_limit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rfd_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FrFD</span> <span class="o">*</span><span class="n">fbl_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fbl_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">skb_dma</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">tx_skbs</span><span class="p">[</span><span class="n">TX_FD_NUM</span><span class="p">],</span> <span class="n">rx_skbs</span><span class="p">[</span><span class="n">RX_BUF_NUM</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">msg_enable</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">tc35815_chiptype</span> <span class="n">chiptype</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span> <span class="nf">fd_virt_to_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf_dma</span> <span class="o">+</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">virt</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">fd_bus_to_virt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">bus</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf_dma</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">alloc_rxbuf_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">hwdev</span><span class="p">,</span>
				       <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RX_BUF_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">hwdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">RX_BUF_SIZE</span><span class="p">,</span>
				     <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">hwdev</span><span class="p">,</span> <span class="o">*</span><span class="n">dma_handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* make IP header 4byte aligned */</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_rxbuf_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">hwdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">hwdev</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="n">RX_BUF_SIZE</span><span class="p">,</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Index to functions, as function prototypes. */</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">tc35815_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tc35815_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>	<span class="n">tc35815_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tc35815_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tc35815_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tc35815_txdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tc35815_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span>	<span class="n">net_device_stats</span> <span class="o">*</span><span class="n">tc35815_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tc35815_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tc35815_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">tc35815_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tc35815_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">tc35815_ethtool_ops</span><span class="p">;</span>

<span class="cm">/* Example routines you must write ;-&gt;. */</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tc35815_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">tc35815_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">panic_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tc35815_restart_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc_mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">tc_writel</span><span class="p">(</span><span class="n">MD_CA_Busy</span> <span class="o">|</span> <span class="p">(</span><span class="n">mii_id</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MD_CA</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span> <span class="cm">/* it takes 32 x 400ns at least */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MD_CA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_CA_Busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MD_Data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc_mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mii_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">tc_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MD_Data</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">MD_CA_Busy</span> <span class="o">|</span> <span class="n">MD_CA_Wr</span> <span class="o">|</span> <span class="p">(</span><span class="n">mii_id</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">),</span>
		  <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MD_CA</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span> <span class="cm">/* it takes 32 x 400ns at least */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MD_CA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MD_CA_Busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc_handle_link_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">MAC_HaltReq</span><span class="p">;</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">MAC_FullDup</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_FullDup</span><span class="p">;</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAC_HaltReq</span><span class="p">;</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX4939 PCFG.SPEEDn bit will be changed on</span>
<span class="cm">		 * NETDEV_CHANGE event.</span>
<span class="cm">		 */</span>
		<span class="cm">/*</span>
<span class="cm">		 * WORKAROUND: enable LostCrS only if half duplex</span>
<span class="cm">		 * operation.</span>
<span class="cm">		 * (TX4939 does not have EnLCarr)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">!=</span> <span class="n">TC35815_TX4939</span><span class="p">)</span>
			<span class="n">tc_writel</span><span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Tx_Ctl</span><span class="p">)</span> <span class="o">|</span> <span class="n">Tx_EnLCarr</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Tx_Ctl</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">duplex</span><span class="p">;</span>
		<span class="n">status_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* delayed promiscuous enabling */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
				<span class="n">tc35815_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

		<span class="n">status_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_change</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_link</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy_print_status</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: MII BMCR %04x BMSR %04x LPA %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">phy_read</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">),</span>
			 <span class="n">phy_read</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">),</span>
			 <span class="n">phy_read</span><span class="p">(</span><span class="n">phydev</span><span class="p">,</span> <span class="n">MII_LPA</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc_mii_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">phy_device</span> <span class="o">*</span><span class="n">phydev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dropmask</span><span class="p">;</span>

	<span class="cm">/* find the first phy */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">phy_addr</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="n">phy_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">phy_addr</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phydev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: multiple PHYs found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">phydev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">phy_map</span><span class="p">[</span><span class="n">phy_addr</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phydev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no PHY found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* attach the mac to the phy */</span>
	<span class="n">phydev</span> <span class="o">=</span> <span class="n">phy_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">tc_handle_link_change</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">TC35815_TX4939</span> <span class="o">?</span>
			     <span class="n">PHY_INTERFACE_MODE_RMII</span> <span class="o">:</span> <span class="n">PHY_INTERFACE_MODE_MII</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Could not attach to PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">phydev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: attached PHY driver [%s] &quot;</span>
		<span class="s">&quot;(mii_bus:phy_addr=%s, id=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phydev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>

	<span class="cm">/* mask with MAC supported features */</span>
	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="n">PHY_BASIC_FEATURES</span><span class="p">;</span>
	<span class="n">dropmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">dropmask</span> <span class="o">|=</span> <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">dropmask</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_10baseT_Full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dropmask</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Full</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dropmask</span> <span class="o">|=</span> <span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span> <span class="n">SUPPORTED_100baseT_Half</span><span class="p">;</span>
	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dropmask</span><span class="p">;</span>
	<span class="n">phydev</span><span class="o">-&gt;</span><span class="n">advertising</span> <span class="o">=</span> <span class="n">phydev</span><span class="o">-&gt;</span><span class="n">supported</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span> <span class="o">=</span> <span class="n">phydev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc_mii_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span> <span class="o">=</span> <span class="n">mdiobus_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tc35815_mii_bus&quot;</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">tc_mdio_read</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">tc_mdio_write</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">MII_BUS_ID_SIZE</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">PHY_MAX_ADDR</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_mii_bus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PHY_MAX_ADDR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_POLL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mdiobus_register</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_mdio_irq</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">tc_mii_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unregister_bus</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unregister_bus:</span>
	<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
<span class="nl">err_out_free_mdio_irq:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="nl">err_out_free_mii_bus:</span>
	<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_CPU_TX49XX</span>
<span class="cm">/*</span>
<span class="cm"> * Find a platform_device providing a MAC address.  The platform code</span>
<span class="cm"> * should provide a &quot;tc35815-mac&quot; device with a MAC address in its</span>
<span class="cm"> * platform_data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tc35815_mac_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">plat_dev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;tc35815-mac&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">plat_dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tc35815_read_plat_dev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">bus_find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">tc35815_mac_match</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tc35815_read_plat_dev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tc35815_init_dev_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">PROM_Ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PROM_Busy</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">PROM_Busy</span> <span class="o">|</span> <span class="n">PROM_Read</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">PROM_Ctl</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">PROM_Ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PROM_Busy</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">PROM_Data</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tc35815_read_plat_dev_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">tc35815_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">tc35815_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">tc35815_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">tc35815_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">tc35815_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">tc35815_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">tc35815_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">tc35815_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">tc35815_poll_controller</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">tc35815_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;speed:%d duplex:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">options</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">duplex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no IRQ assigned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dev zeroed in alloc_etherdev */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* enable device (incl. PCI PM wakeup), and bus-mastering */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_iomap_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pcim_iomap_table</span><span class="p">(</span><span class="n">pdev</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Initialize the device structure. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tc35815_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tc35815_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TC35815_TX_TIMEOUT</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">tc35815_poll</span><span class="p">,</span> <span class="n">NAPI_WEIGHT</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">,</span> <span class="n">tc35815_restart_work</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">NETIF_MSG_TX_ERR</span> <span class="o">|</span> <span class="n">NETIF_MSG_HW</span> <span class="o">|</span> <span class="n">NETIF_MSG_DRV</span> <span class="o">|</span> <span class="n">NETIF_MSG_LINK</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Soft reset the chip. */</span>
	<span class="n">tc35815_chip_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Retrieve the ethernet address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc35815_init_dev_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not valid ether addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">eth_hw_addr_random</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s at 0x%lx, %pM, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">chip_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tc_mii_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_unregister</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_unregister:</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">tc35815_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">phy_disconnect</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="n">mdiobus_unregister</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">mdiobus_free</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">mii_bus</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tc35815_init_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fd_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">FDesc</span><span class="p">)</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">BDesc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_BUF_NUM</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">FDesc</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_FD_NUM</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_FD_NUM</span> <span class="o">&gt;</span>
		       <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">FD_PAGE_NUM</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						  <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">FD_PAGE_NUM</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BUF_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span>
				<span class="n">alloc_rxbuf_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">free_rxbuf_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span>
						       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						    <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">FD_PAGE_NUM</span><span class="p">,</span>
						    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">,</span>
						    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf_dma</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: FD buf %p DataBuf&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FD_PAGE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">clear_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span> <span class="o">+</span>
					    <span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">fd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">;</span>

	<span class="cm">/* Free Descriptors (for Receive) */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_addr</span><span class="p">;</span>
	<span class="n">fd_addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">)</span> <span class="o">*</span> <span class="n">RX_FD_NUM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_FD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_CownsFD</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_limit</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_addr</span> <span class="o">-</span> <span class="p">(</span><span class="n">RX_FD_RESERVE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Transmit Descriptors */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_addr</span><span class="p">;</span>
	<span class="n">fd_addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span><span class="p">)</span> <span class="o">*</span> <span class="n">TX_FD_NUM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_FD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">TX_FD_NUM</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Buffer List (for Receive) */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">FrFD</span> <span class="o">*</span><span class="p">)</span><span class="n">fd_addr</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="p">));</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RX_BUF_NUM</span> <span class="o">|</span> <span class="n">FD_CownsFD</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * move all allocated skbs to head of rx_skbs[] array.</span>
<span class="cm">	 * fbl_count mighe not be RX_BUF_NUM if alloc_rxbuf_skb() in</span>
<span class="cm">	 * tc35815_rx() had failed.</span>
<span class="cm">	 */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BUF_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="p">].</span><span class="n">skb_dma</span> <span class="o">=</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BUF_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BuffData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BDCtl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BuffData</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
		<span class="cm">/* BDID is index of FrFD.bd[] */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BDCtl</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BD_CownsBD</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">BD_RxBDID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				    <span class="n">RX_BUF_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TxFD %p RxFD %p FrFD %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tc35815_clear_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_FD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fdsystem</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
			<span class="n">fdsystem</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">?</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">fdsystem</span><span class="p">].</span><span class="n">skb</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: tx_skbs mismatch(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tc35815_init_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tc35815_free_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_FD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">fdsystem</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span>
				<span class="n">fdsystem</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">?</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">fdsystem</span><span class="p">].</span><span class="n">skb</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: tx_skbs mismatch(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_limit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BUF_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_rxbuf_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="n">FD_PAGE_NUM</span><span class="p">,</span>
				    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf_dma</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fd_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_txfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TxFD(%p): %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDStat</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BD: &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x %08x&quot;</span><span class="p">,</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">.</span><span class="n">BuffData</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">.</span><span class="n">BDCtl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dump_rxfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bd_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FD_BDCnt_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FD_BDCnt_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">bd_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RxFD(%p): %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDStat</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FD_CownsFD</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BD: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x %08x&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BuffData</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BDCtl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bd_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_frfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">FrFD</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FrFD(%p): %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDStat</span><span class="p">),</span>
	       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BD: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_BUF_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x %08x&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BuffData</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BDCtl</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">panic_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TxFD base %p, start %u, end %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RxFD base %p limit %p cur %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_limit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FrFD %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_FD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dump_txfd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_FD_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bd_count</span> <span class="o">=</span> <span class="n">dump_rxfd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* skip BDs */</span>
	<span class="p">}</span>
	<span class="n">dump_frfd</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="p">);</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: Illegal queue state.&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_eth</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;print_eth(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; %pM =&gt; %pM : %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">add</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">add</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">add</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_tx_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_FD_NUM</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

		<span class="n">phy_write</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_read</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BMCR_RESET</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: BMCR reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tc35815_chip_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tc35815_clear_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">tc35815_chip_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Reconfigure CAM again since tc35815_chip_init() initialize it. */</span>
	<span class="n">tc35815_set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_restart_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc35815_local</span><span class="p">,</span> <span class="n">restart_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">tc35815_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_schedule_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_En</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">)</span> <span class="o">|</span> <span class="n">DMA_IntMask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out, status %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Tx_Stat</span><span class="p">));</span>

	<span class="cm">/* Try to restart the adaptor. */</span>
	<span class="n">tc35815_schedule_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open/initialize the controller. This is called (in the current kernel)</span>
<span class="cm"> * sometime after booting when the &#39;ifconfig&#39; program is run.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should set everything up anew at each open, even</span>
<span class="cm"> * registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm"> * there is non-reboot way to recover if something goes wrong.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tc35815_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is used if the interrupt line can turned off (shared).</span>
<span class="cm">	 * See 3c503.c for an example of selecting the IRQ at config-time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tc35815_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">tc35815_chip_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tc35815_init_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="cm">/* Reset the hardware here. Don&#39;t forget to set the station address. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tc35815_chip_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* schedule a link state check */</span>
	<span class="n">phy_start</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>

	<span class="cm">/* We are now ready to accept transmit requeusts from</span>
<span class="cm">	 * the queueing layer of the networking.</span>
<span class="cm">	 */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This will only be invoked if your driver is _not_ in XOFF state.</span>
<span class="cm"> * What this means is that you need not check it, and that this</span>
<span class="cm"> * invariant will hold if you make sure that the netif_*_queue()</span>
<span class="cm"> * calls are done at the proper times.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">txfd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If some error occurs while trying to transmit this</span>
<span class="cm">	 * packet, you should return &#39;1&#39; from this function.</span>
<span class="cm">	 * In such a case you _may not_ do anything to the</span>
<span class="cm">	 * SKB, it is still owned by the network queueing</span>
<span class="cm">	 * layer when an error is returned.  This means you</span>
<span class="cm">	 * may not modify any SKB fields, you may not free</span>
<span class="cm">	 * the SKB, etc.</span>
<span class="cm">	 */</span>

	<span class="cm">/* This is the most common case for modern hardware.</span>
<span class="cm">	 * The spinlock protects this code from the TX complete</span>
<span class="cm">	 * hardware interrupt handler.  Queue flow control is</span>
<span class="cm">	 * thus managed under this lock as well.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* failsafe... (handle txdone now if half of FDs are used) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">+</span> <span class="n">TX_FD_NUM</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_FD_NUM</span> <span class="o">&gt;</span>
	    <span class="n">TX_FD_NUM</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">tc35815_txdone</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="n">print_eth</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: tx_skbs conflict.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">].</span><span class="n">skb_dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="cm">/*add to ring */</span>
	<span class="n">txfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">];</span>
	<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">.</span><span class="n">BuffData</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
	<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">.</span><span class="n">BDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">);</span>
	<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_CownsFD</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FD_BDCnt_SHIFT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
		<span class="cm">/* Start DMA Transmitter. */</span>
		<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_Next_EOL</span><span class="p">);</span>
		<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_FrmOpt_IntTx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: starting TxFD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dump_txfd</span><span class="p">(</span><span class="n">txfd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">txfd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxFrmPtr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">FD_Next_EOL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: queueing TxFD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dump_txfd</span><span class="p">(</span><span class="n">txfd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_FD_NUM</span><span class="p">;</span>

	<span class="cm">/* If we just used up the very last entry in the</span>
<span class="cm">	 * TX ring on this device, tell the queueing</span>
<span class="cm">	 * layer to send no more.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc35815_tx_full</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: TxFD Exhausted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* When the TX completion hw interrupt arrives, this</span>
<span class="cm">	 * is when the transmit statistics are updated.</span>
<span class="cm">	 */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FATAL_ERROR_INT \</span>
<span class="cp">	(Int_IntPCI | Int_DmParErr | Int_IntNRAbt)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_fatal_error_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Fatal Error Intterrupt (%#x):&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntPCI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; IntPCI&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_DmParErr</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; DmParErr&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntNRAbt</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; IntNRAbt&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: Too many fatal errors.&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Resetting ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* Try to restart the adaptor. */</span>
	<span class="n">tc35815_schedule_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_do_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fatal errors... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FATAL_ERROR_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tc35815_fatal_error_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* recoverable errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntFDAEx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Free Descriptor Area Exhausted (%#x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">status</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntBLEx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Buffer List Exhausted (%#x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">status</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntExBD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Excessive Buffer Descriptiors (%#x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">status</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* normal notification */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntMacRx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Got a packet(s). */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tc35815_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">rx_ints</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Int_IntMacTx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Transmit complete. */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">tx_ints</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">tc35815_txdone</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The typical workload of the driver:</span>
<span class="cm"> * Handle the network interface interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tc35815_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dmactl</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmactl</span> <span class="o">&amp;</span> <span class="n">DMA_IntMask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* disable interrupts */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">dmactl</span> <span class="o">|</span> <span class="n">DMA_IntMask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span>
			<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: interrupt taken in poll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_Src</span><span class="p">);</span>	<span class="cm">/* flush */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tc35815_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* We have a good packet(s), get it/them out of the buffers. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tc35815_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fdctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">fdctl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FD_CownsFD</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDStat</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">fdctl</span> <span class="o">&amp;</span> <span class="n">FD_FDLength_MASK</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bd_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">fdctl</span> <span class="o">&amp;</span> <span class="n">FD_BDCnt_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FD_BDCnt_SHIFT</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">next_rfd</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if (RX_CTL_CMD &amp; Rx_StripCRC) == 0</span>
		<span class="n">pkt_len</span> <span class="o">-=</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_status</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
			<span class="n">dump_rxfd</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_Good</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">cur_bd</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bd_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cur_bd</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BDCtl</span><span class="p">)</span>
				  <span class="o">&amp;</span> <span class="n">BD_RxBDID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BD_RxBDID_SHIFT</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_bd</span> <span class="o">&gt;=</span> <span class="n">RX_BUF_NUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: invalid BDID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">cur_bd</span><span class="p">].</span><span class="n">skb_dma</span> <span class="o">!=</span>
			       <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">BuffData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">cur_bd</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: NULL skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cur_bd</span> <span class="o">&gt;=</span> <span class="n">RX_BUF_NUM</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">cur_bd</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">cur_bd</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">cur_bd</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">,</span>
					 <span class="n">RX_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAVE_DMA_RXALIGN</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">NET_IP_ALIGN</span><span class="p">)</span>
				<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">,</span>
					<span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_pktdata</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
				<span class="n">print_eth</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">received</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
				<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx error (status %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_Stat_Mask</span><span class="p">);</span>
			<span class="cm">/* WORKAROUND: LongErr and CRCErr means Overflow. */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_LongErr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_CRCErr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">Rx_LongErr</span><span class="o">|</span><span class="n">Rx_CRCErr</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">Rx_Over</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_LongErr</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_Over</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_CRCErr</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_Align</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* put Free Buffer back to controller */</span>
			<span class="kt">int</span> <span class="n">bdctl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">bd_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">BDCtl</span><span class="p">);</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">bdctl</span> <span class="o">&amp;</span> <span class="n">BD_RxBDID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BD_RxBDID_SHIFT</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">RX_BUF_NUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: invalid BDID.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">RX_BUF_NUM</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* free old buffers */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="o">--</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span> <span class="o">&lt;</span> <span class="n">RX_BUF_NUM</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curid</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_BUF_NUM</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">BDesc</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">curid</span><span class="p">];</span>
<span class="cp">#ifdef DEBUG</span>
				<span class="n">bdctl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">BDCtl</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bdctl</span> <span class="o">&amp;</span> <span class="n">BD_CownsBD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Freeing invalid BD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="cm">/* pass BD to controller */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">curid</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">curid</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span>
						<span class="n">alloc_rxbuf_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">curid</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">curid</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span> <span class="cm">/* try on next reception */</span>
					<span class="n">bd</span><span class="o">-&gt;</span><span class="n">BuffData</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skbs</span><span class="p">[</span><span class="n">curid</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* Note: BDLength was modified by chip. */</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">BDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BD_CownsBD</span> <span class="o">|</span>
							<span class="p">(</span><span class="n">curid</span> <span class="o">&lt;&lt;</span> <span class="n">BD_RxBDID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
							<span class="n">RX_BUF_SIZE</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* put RxFD back to controller */</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">next_rfd</span> <span class="o">=</span> <span class="n">fd_bus_to_virt</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span>
					  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next_rfd</span> <span class="o">&lt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span> <span class="o">||</span> <span class="n">next_rfd</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_limit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: RxFD FDNext invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">bd_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* pass FD to controller */</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeaddead</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_Next_EOL</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_CownsFD</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_limit</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span> <span class="o">!=</span> <span class="n">next_rfd</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rfd_cur = %p, next_rfd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_cur</span><span class="p">,</span> <span class="n">next_rfd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tc35815_local</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">handled</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_Src</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* BLEx, FDAEx will be cleared later */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">Int_BLEx</span> <span class="o">|</span> <span class="n">Int_FDAEx</span><span class="p">),</span>
			  <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_Src</span><span class="p">);</span>	<span class="cm">/* write to clear */</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="n">tc35815_do_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">budget</span> <span class="o">-</span> <span class="n">received</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Int_BLEx</span> <span class="o">|</span> <span class="n">Int_FDAEx</span><span class="p">))</span>
			<span class="n">tc_writel</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Int_BLEx</span> <span class="o">|</span> <span class="n">Int_FDAEx</span><span class="p">),</span>
				  <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_Src</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handled</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">received</span> <span class="o">+=</span> <span class="n">handled</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">received</span> <span class="o">&gt;=</span> <span class="n">budget</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_Src</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">received</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="cm">/* enable interrupts */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_IntMask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">received</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TX_STA_ERR	(Tx_ExColl|Tx_Under|Tx_Defer|Tx_NCarr|Tx_LateColl|Tx_TxPar|Tx_SQErr)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tc35815_check_tx_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* count collisions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_ExColl</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_TxColl_MASK</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_TxColl_MASK</span><span class="p">;</span>

	<span class="cm">/* TX4939 does not have NCarr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">TC35815_TX4939</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Tx_NCarr</span><span class="p">;</span>
	<span class="cm">/* WORKAROUND: ignore LostCrS in full duplex operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Tx_NCarr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STA_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no error. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_ExColl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Excessive Collision.&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_Under</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Tx FIFO Underrun.&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">tx_underrun</span> <span class="o">&lt;</span> <span class="n">TX_THRESHOLD_KEEP_LIMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">tx_underrun</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">tx_underrun</span> <span class="o">&gt;=</span> <span class="n">TX_THRESHOLD_KEEP_LIMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
				<span class="n">tc_writel</span><span class="p">(</span><span class="n">TX_THRESHOLD_MAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxThrsh</span><span class="p">);</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Tx FIFO Underrun.Change Tx threshold to max.&quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_Defer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Excessive Deferral.&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_NCarr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Lost Carrier Sense.&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_LateColl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Late Collision.&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_TxPar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Transmit Parity Error.&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Tx_SQErr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Signal Quality Error.&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s (%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This handles TX complete events posted by the device</span>
<span class="cm"> * via interrupts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tc35815_txdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">txfd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fdctl</span><span class="p">;</span>

	<span class="n">txfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="p">((</span><span class="n">fdctl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FD_CownsFD</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDStat</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fdnext</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">fdsystem</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_done</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: complete TxFD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dump_txfd</span><span class="p">(</span><span class="n">txfd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tc35815_check_tx_stat</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">fdsystem</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">?</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">fdsystem</span><span class="p">].</span><span class="n">skb</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: tx_skbs mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">].</span><span class="n">skb_dma</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tx_skbs</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">].</span><span class="n">skb_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDSystem</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>

		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_FD_NUM</span><span class="p">;</span>
		<span class="n">txfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">];</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fdnext</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FD_Next_EOL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">txfd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TxFD FDNext invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdnext</span> <span class="o">&amp;</span> <span class="n">FD_Next_EOL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DMA Transmitter has been stopping... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">+</span> <span class="n">TX_FD_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_FD_NUM</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">txhead</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_base</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
				<span class="kt">int</span> <span class="n">qlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_start</span> <span class="o">+</span> <span class="n">TX_FD_NUM</span>
					    <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">tfd_end</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_FD_NUM</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txfd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FD_CownsFD</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TxFD FDCtl invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">panic_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="cm">/* log max queue length */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">max_tx_qlen</span> <span class="o">&lt;</span> <span class="n">qlen</span><span class="p">)</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">max_tx_qlen</span> <span class="o">=</span> <span class="n">qlen</span><span class="p">;</span>


				<span class="cm">/* start DMA Transmitter again */</span>
				<span class="n">txhead</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDNext</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_Next_EOL</span><span class="p">);</span>
				<span class="n">txhead</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">.</span><span class="n">FDCtl</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FD_FrmOpt_IntTx</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_queued</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: start TxFD on queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">dump_txfd</span><span class="p">(</span><span class="n">txfd</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">tc_writel</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">txfd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxFrmPtr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If we had stopped the queue due to a &quot;tx full&quot;</span>
<span class="cm">	 * condition, and space has now been made available,</span>
<span class="cm">	 * wake up the queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tc35815_tx_full</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The inverse routine to tc35815_open(). */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tc35815_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="n">phy_stop</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>

	<span class="cm">/* Flush the Tx and disable Rx here. */</span>
	<span class="n">tc35815_chip_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">tc35815_free_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the current statistics.</span>
<span class="cm"> * This may be called with the card open or closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">tc35815_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="cm">/* Update the statistics from the device registers. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Miss_Cnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_set_cam_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cam_index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cam_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saved_addr</span><span class="p">;</span>

	<span class="n">saved_addr</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_hw</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: CAM %d: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read modify write */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>
		<span class="n">cam_data</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">cam_data</span> <span class="o">|=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">);</span>
		<span class="cm">/* write whole word */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>
		<span class="n">cam_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* write whole word */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>
		<span class="n">cam_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">);</span>
		<span class="cm">/* read modify write */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>
		<span class="n">cam_data</span> <span class="o">=</span> <span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>
		<span class="n">cam_data</span> <span class="o">|=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">cam_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tc_writel</span><span class="p">(</span><span class="n">saved_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> * num_addrs == -1	Promiscuous mode, receive all packets</span>
<span class="cm"> * num_addrs == 0	Normal mode, clear multicast list</span>
<span class="cm"> * num_addrs &gt; 0	Multicast mode, receive normal and MC packets,</span>
<span class="cm"> *			and do best-effort filtering.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tc35815_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* With some (all?) 100MHalf HUB, controller will hang</span>
<span class="cm">		 * if we enabled promiscuous mode before linkup... */</span>
		<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="cm">/* Enable promiscuous mode */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_CompEn</span> <span class="o">|</span> <span class="n">CAM_BroadAcc</span> <span class="o">|</span> <span class="n">CAM_GroupAcc</span> <span class="o">|</span> <span class="n">CAM_StationAcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
		  <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CAM_ENTRY_MAX</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CAM 0, 1, 20 are reserved. */</span>
		<span class="cm">/* Disable promiscuous mode, use normal mode. */</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_CompEn</span> <span class="o">|</span> <span class="n">CAM_BroadAcc</span> <span class="o">|</span> <span class="n">CAM_GroupAcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ena_bits</span> <span class="o">=</span> <span class="n">CAM_Ena_Bit</span><span class="p">(</span><span class="n">CAM_ENTRY_SOURCE</span><span class="p">);</span>

		<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>
		<span class="cm">/* Walk the address list, and load the filter */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* entry 0,1 is reserved. */</span>
			<span class="n">tc35815_set_cam_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">ena_bits</span> <span class="o">|=</span> <span class="n">CAM_Ena_Bit</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">ena_bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ena</span><span class="p">);</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_CompEn</span> <span class="o">|</span> <span class="n">CAM_BroadAcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_Ena_Bit</span><span class="p">(</span><span class="n">CAM_ENTRY_SOURCE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ena</span><span class="p">);</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_CompEn</span> <span class="o">|</span> <span class="n">CAM_BroadAcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">MODNAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">phy_ethtool_gset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">phy_ethtool_sset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tc35815_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">datum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">max_tx_qlen</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">tx_ints</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">rx_ints</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lstats</span><span class="p">.</span><span class="n">tx_underrun</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ethtool_stats_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;max_tx_qlen&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_ints&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;rx_ints&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tx_underrun&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ethtool_stats_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ethtool_stats_keys</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">tc35815_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">tc35815_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">tc35815_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">tc35815_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">tc35815_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">tc35815_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">tc35815_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">tc35815_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">tc35815_get_ethtool_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">phy_mii_ioctl</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">,</span> <span class="n">rq</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* reset the controller */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">MAC_Reset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* 3200ns */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_Reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: MAC reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">MAC_Ctl</span><span class="p">);</span>

	<span class="cm">/* initialize registers to default value */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxThrsh</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxPollCtr</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">RxFragSize</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_En</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">FDA_Bas</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">FDA_Lim</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_Src</span><span class="p">);</span>	<span class="cm">/* Write 1 to clear */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Tx_Ctl</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Rx_Ctl</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ena</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">tc_readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Miss_Cnt</span><span class="p">);</span>	<span class="cm">/* Read to clear */</span>

	<span class="cm">/* initialize internal SRAM */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">DMA_TestMode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Adr</span><span class="p">);</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35815_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tr</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">tc35815_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">txctl</span> <span class="o">=</span> <span class="n">TX_CTL_CMD</span><span class="p">;</span>

	<span class="cm">/* load station address to CAM */</span>
	<span class="n">tc35815_set_cam_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CAM_ENTRY_SOURCE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* Enable CAM (broadcast and unicast) */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_Ena_Bit</span><span class="p">(</span><span class="n">CAM_ENTRY_SOURCE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ena</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">CAM_CompEn</span> <span class="o">|</span> <span class="n">CAM_BroadAcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">CAM_Ctl</span><span class="p">);</span>

	<span class="cm">/* Use DMA_RxAlign_2 to make IP header 4-byte aligned. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAVE_DMA_RXALIGN</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">DMA_BURST_SIZE</span> <span class="o">|</span> <span class="n">DMA_RxAlign_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tc_writel</span><span class="p">(</span><span class="n">DMA_BURST_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">DMA_Ctl</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxPollCtr</span><span class="p">);</span>	<span class="cm">/* Batch mode */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">TX_THRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">TxThrsh</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">INT_EN_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Int_En</span><span class="p">);</span>

	<span class="cm">/* set queues */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">FDA_Bas</span><span class="p">);</span>
	<span class="n">tc_writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_limit</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfd_base</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">FDA_Lim</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Activation method:</span>
<span class="cm">	 * First, enable the MAC Transmitter and the DMA Receive circuits.</span>
<span class="cm">	 * Then enable the DMA Transmitter and the MAC Receive circuits.</span>
<span class="cm">	 */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">fd_virt_to_bus</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">fbl_ptr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">BLFrmPtr</span><span class="p">);</span>	<span class="cm">/* start DMA receiver */</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">RX_CTL_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Rx_Ctl</span><span class="p">);</span>	<span class="cm">/* start MAC receiver */</span>

	<span class="cm">/* start MAC transmitter */</span>
	<span class="cm">/* TX4939 does not have EnLCarr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chiptype</span> <span class="o">==</span> <span class="n">TC35815_TX4939</span><span class="p">)</span>
		<span class="n">txctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Tx_EnLCarr</span><span class="p">;</span>
	<span class="cm">/* WORKAROUND: ignore LostCrS in full duplex operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
		<span class="n">txctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Tx_EnLCarr</span><span class="p">;</span>
	<span class="n">tc_writel</span><span class="p">(</span><span class="n">txctl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">Tx_Ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="n">phy_stop</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tc35815_chip_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35815_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tc35815_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">tc35815_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">)</span>
		<span class="n">phy_start</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phy_dev</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">tc35815_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tc35815_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tc35815_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tc35815_remove_one</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">tc35815_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">tc35815_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">speed</span><span class="p">,</span> <span class="s">&quot;0:auto, 10:10Mbps, 100:100Mbps&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">duplex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">duplex</span><span class="p">,</span> <span class="s">&quot;0:auto, 1:half, 2:full&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tc35815_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35815_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tc35815_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35815_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">tc35815_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tc35815_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TOSHIBA TC35815 PCI 10M/100M Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
