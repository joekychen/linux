<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › toshiba › spider_net.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>spider_net.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Network device driver for Cell Processor-Based Blade and Celleb platform</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright IBM Corp. 2005</span>
<span class="cm"> * (C) Copyright 2006 TOSHIBA CORPORATION</span>
<span class="cm"> *</span>
<span class="cm"> * Authors : Utz Bacher &lt;utz.bacher@de.ibm.com&gt;</span>
<span class="cm"> *           Jens Osterkamp &lt;Jens.Osterkamp@de.ibm.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;net/checksum.h&gt;</span>

<span class="cp">#include &quot;spider_net.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Utz Bacher &lt;utz.bacher@de.ibm.com&gt; and Jens Osterkamp &quot;</span> \
	      <span class="s">&quot;&lt;Jens.Osterkamp@de.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Spider Southbridge Gigabit Ethernet driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">SPIDER_NET_FIRMWARE_NAME</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_descriptors</span> <span class="o">=</span> <span class="n">SPIDER_NET_RX_DESCRIPTORS_DEFAULT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_descriptors</span> <span class="o">=</span> <span class="n">SPIDER_NET_TX_DESCRIPTORS_DEFAULT</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">rx_descriptors</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tx_descriptors</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_descriptors</span><span class="p">,</span> <span class="s">&quot;number of descriptors used &quot;</span> \
		 <span class="s">&quot;in rx chains&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tx_descriptors</span><span class="p">,</span> <span class="s">&quot;number of descriptors used &quot;</span> \
		 <span class="s">&quot;in tx chain&quot;</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">spider_net_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;spidernet&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">spider_net_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_TOSHIBA_2</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TOSHIBA_SPIDER_NET</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0UL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">spider_net_pci_tbl</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_read_reg - reads an SMMIO register of a card</span>
<span class="cm"> * @card: device structure</span>
<span class="cm"> * @reg: register to read from</span>
<span class="cm"> *</span>
<span class="cm"> * returns the content of the specified SMMIO register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">spider_net_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We use the powerpc specific variants instead of readl_be() because</span>
<span class="cm">	 * we know spidernet is not a real PCI device and we can thus avoid the</span>
<span class="cm">	 * performance hit caused by the PCI workarounds.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_write_reg - writes to an SMMIO register of a card</span>
<span class="cm"> * @card: device structure</span>
<span class="cm"> * @reg: register to write to</span>
<span class="cm"> * @value: value to write into the specified SMMIO register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">spider_net_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We use the powerpc specific variants instead of writel_be() because</span>
<span class="cm">	 * we know spidernet is not a real PCI device and we can thus avoid the</span>
<span class="cm">	 * performance hit caused by the PCI workarounds.</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** spider_net_write_phy - write to phy register</span>
<span class="cm"> * @netdev: adapter to be written to</span>
<span class="cm"> * @mii_id: id of MII</span>
<span class="cm"> * @reg: PHY register</span>
<span class="cm"> * @val: value to be written to phy register</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_write_phy_register writes to an arbitrary PHY</span>
<span class="cm"> * register via the spider GPCWOPCMD register. We assume the queue does</span>
<span class="cm"> * not run full (not more than 15 commands outstanding).</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_write_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">writevalue</span><span class="p">;</span>

	<span class="n">writevalue</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mii_id</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GPCWOPCMD</span><span class="p">,</span> <span class="n">writevalue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** spider_net_read_phy - read from phy register</span>
<span class="cm"> * @netdev: network device to be read from</span>
<span class="cm"> * @mii_id: id of MII</span>
<span class="cm"> * @reg: PHY register</span>
<span class="cm"> *</span>
<span class="cm"> * Returns value read from PHY register</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_write_phy reads from an arbitrary PHY</span>
<span class="cm"> * register via the spider GPCROPCMD register</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_read_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mii_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">readvalue</span><span class="p">;</span>

	<span class="n">readvalue</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mii_id</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GPCROPCMD</span><span class="p">,</span> <span class="n">readvalue</span><span class="p">);</span>

	<span class="cm">/* we don&#39;t use semaphores to wait for an SPIDER_NET_GPROPCMPINT</span>
<span class="cm">	 * interrupt, as we poll for the completion of the read operation</span>
<span class="cm">	 * in spider_net_read_phy. Should take about 50 us */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">readvalue</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GPCROPCMD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">readvalue</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_GPREXEC</span><span class="p">);</span>

	<span class="n">readvalue</span> <span class="o">&amp;=</span> <span class="n">SPIDER_NET_GPRDAT_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">readvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_setup_aneg - initial auto-negotiation setup</span>
<span class="cm"> * @card: device structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_setup_aneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">advertise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmsr</span><span class="p">,</span> <span class="n">estat</span><span class="p">;</span>

	<span class="n">bmsr</span>  <span class="o">=</span> <span class="n">spider_net_read_phy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="n">estat</span> <span class="o">=</span> <span class="n">spider_net_read_phy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span><span class="p">,</span> <span class="n">MII_ESTATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10HALF</span><span class="p">)</span>
		<span class="n">advertise</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_10FULL</span><span class="p">)</span>
		<span class="n">advertise</span> <span class="o">|=</span> <span class="n">ADVERTISED_10baseT_Full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100HALF</span><span class="p">)</span>
		<span class="n">advertise</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Half</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_100FULL</span><span class="p">)</span>
		<span class="n">advertise</span> <span class="o">|=</span> <span class="n">ADVERTISED_100baseT_Full</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_TFULL</span><span class="p">))</span>
		<span class="n">advertise</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bmsr</span> <span class="o">&amp;</span> <span class="n">BMSR_ESTATEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">estat</span> <span class="o">&amp;</span> <span class="n">ESTATUS_1000_THALF</span><span class="p">))</span>
		<span class="n">advertise</span> <span class="o">|=</span> <span class="n">SUPPORTED_1000baseT_Half</span><span class="p">;</span>

	<span class="n">sungem_phy_probe</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup_aneg</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">advertise</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_rx_irq_off - switch off rx irq on this spider card</span>
<span class="cm"> * @card: device structure</span>
<span class="cm"> *</span>
<span class="cm"> * switches off rx irq by masking them out in the GHIINTnMSK register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_rx_irq_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regvalue</span><span class="p">;</span>

	<span class="n">regvalue</span> <span class="o">=</span> <span class="n">SPIDER_NET_INT0_MASK_VALUE</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">SPIDER_NET_RXINT</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT0MSK</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_rx_irq_on - switch on rx irq on this spider card</span>
<span class="cm"> * @card: device structure</span>
<span class="cm"> *</span>
<span class="cm"> * switches on rx irq by enabling them in the GHIINTnMSK register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_rx_irq_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regvalue</span><span class="p">;</span>

	<span class="n">regvalue</span> <span class="o">=</span> <span class="n">SPIDER_NET_INT0_MASK_VALUE</span> <span class="o">|</span> <span class="n">SPIDER_NET_RXINT</span><span class="p">;</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT0MSK</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_set_promisc - sets the unicast address or the promiscuous mode</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_set_promisc sets the unicast destination address filter and</span>
<span class="cm"> * thus either allows for non-promisc mode or promisc mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_set_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macu</span><span class="p">,</span> <span class="n">macl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear destination entry 0 */</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUAFILnR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUAFILnR</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUA0FIL15R</span><span class="p">,</span>
				     <span class="n">SPIDER_NET_PROMISC_VALUE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">macu</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">macu</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">macu</span> <span class="o">|=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">macl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">macl</span><span class="p">));</span>

		<span class="n">macu</span> <span class="o">|=</span> <span class="n">SPIDER_NET_UA_DESCR_VALUE</span><span class="p">;</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUAFILnR</span><span class="p">,</span> <span class="n">macu</span><span class="p">);</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUAFILnR</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">macl</span><span class="p">);</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUA0FIL15R</span><span class="p">,</span>
				     <span class="n">SPIDER_NET_NONPROMISC_VALUE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_get_mac_address - read mac address from spider card</span>
<span class="cm"> * @card: device structure</span>
<span class="cm"> *</span>
<span class="cm"> * reads MAC address from GMACUNIMACU and GMACUNIMACL registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_get_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">macl</span><span class="p">,</span> <span class="n">macu</span><span class="p">;</span>

	<span class="n">macl</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACUNIMACL</span><span class="p">);</span>
	<span class="n">macu</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACUNIMACU</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">macu</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">macu</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">macu</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">macu</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">macl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">macl</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_get_descr_status -- returns the status of a descriptor</span>
<span class="cm"> * @descr: descriptor to look at</span>
<span class="cm"> *</span>
<span class="cm"> * returns the status as in the dmac_cmd_status field of the descriptor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">spider_net_get_descr_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_DESCR_IND_PROC_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_free_chain - free descriptor chain</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> * @chain: address of chain</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_free_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>

	<span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">descr</span> <span class="o">!=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">,</span>
	    <span class="n">chain</span><span class="o">-&gt;</span><span class="n">hwring</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_init_chain - alloc and link descriptor chain</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> * @chain: address of chain</span>
<span class="cm"> *</span>
<span class="cm"> * We manage a circular list that mirrors the hardware structure,</span>
<span class="cm"> * except that the hardware uses bus addresses.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_init_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">alloc_size</span><span class="p">;</span>

	<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_hw_descr</span><span class="p">);</span>

	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">hwring</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">alloc_size</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">hwring</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_descr</span><span class="p">));</span>

	<span class="cm">/* Set up the hardware pointers in each descriptor */</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">hwdescr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">hwring</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">descr</span><span class="o">++</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">;</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span> <span class="o">=</span> <span class="n">hwdescr</span><span class="p">;</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">descr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">descr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_hw_descr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* do actual circular list */</span>
	<span class="p">(</span><span class="n">descr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_free_rx_chain_contents - frees descr contents in rx chain</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_free_rx_chain_contents</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>

	<span class="n">descr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="p">,</span>
					 <span class="n">SPIDER_NET_MAX_FRAME</span><span class="p">,</span>
					 <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">descr</span> <span class="o">!=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_prepare_rx_descr - Reinitialize RX descriptor</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> * @descr: descriptor to re-init</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, &lt;0 on failure.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a new rx skb, iommu-maps it and attaches it to the</span>
<span class="cm"> * descriptor. Mark the descriptor as activated, ready-to-use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_prepare_rx_descr</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bufsize</span><span class="p">;</span>

	<span class="cm">/* we need to round up the buffer size to a multiple of 128 */</span>
	<span class="n">bufsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">SPIDER_NET_MAX_FRAME</span> <span class="o">+</span> <span class="n">SPIDER_NET_RXBUF_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">SPIDER_NET_RXBUF_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* and we need to have it 128 byte aligned, therefore we allocate a</span>
<span class="cm">	 * bit more */</span>
	<span class="cm">/* allocate an skb */</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				      <span class="n">bufsize</span> <span class="o">+</span> <span class="n">SPIDER_NET_RXBUF_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			        <span class="s">&quot;Not enough memory to allocate rx buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">spider_stats</span><span class="p">.</span><span class="n">alloc_rx_skb_error</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">result_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">valid_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SPIDER_NET_RXBUF_ALIGN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">SPIDER_NET_RXBUF_ALIGN</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
	<span class="cm">/* iommu-map the skb */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">SPIDER_NET_MAX_FRAME</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not iommu-map rx buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">spider_stats</span><span class="p">.</span><span class="n">rx_iommu_map_error</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span> <span class="n">SPIDER_NET_DESCR_CARDOWNED</span> <span class="o">|</span>
					 <span class="n">SPIDER_NET_DMAC_NOINTR_COMPLETE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_enable_rxchtails - sets RX dmac chain tail addresses</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_enable_rxchtails sets the RX DMAC chain tail addresses in the</span>
<span class="cm"> * chip by writing to the appropriate register. DMA is enabled in</span>
<span class="cm"> * spider_net_enable_rxdmac.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">spider_net_enable_rxchtails</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* assume chain is aligned correctly */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDADCHA</span> <span class="p">,</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">.</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_enable_rxdmac - enables a receive DMA controller</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_enable_rxdmac enables the DMA controller by setting RX_DMA_EN</span>
<span class="cm"> * in the GDADMACCNTR register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">spider_net_enable_rxdmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDADMACCNTR</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_DMA_RX_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_disable_rxdmac - disables the receive DMA controller</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_disable_rxdmac terminates processing on the DMA controller</span>
<span class="cm"> * by turing off the DMA controller, with the force-end flag set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">spider_net_disable_rxdmac</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDADMACCNTR</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_DMA_RX_FEND_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_refill_rx_chain - refills descriptors/skbs in the rx chains</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * refills descriptors in the rx chain: allocates skbs and iommu-maps them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_refill_rx_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* one context doing the refill (and a second context seeing that</span>
<span class="cm">	 * and omitting it) is ok. If called by NAPI, we&#39;ll be called again</span>
<span class="cm">	 * as spider_net_decode_one_descr is called several times. If some</span>
<span class="cm">	 * interrupt calls us, the NAPI is about to clean up anyway. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_prepare_rx_descr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_alloc_rx_skbs - Allocates rx skbs in rx descriptor chains</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_alloc_rx_skbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Link up the hardware chain pointers */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">descr</span> <span class="o">!=</span> <span class="n">start</span><span class="p">);</span>

	<span class="cm">/* Put at least one buffer into the chain. if this fails,</span>
<span class="cm">	 * we&#39;ve got a problem. If not, spider_net_refill_rx_chain</span>
<span class="cm">	 * will do the rest at the end of this function. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_prepare_rx_descr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* This will allocate the rest of the rx buffers;</span>
<span class="cm">	 * if not, it&#39;s business as usual later on. */</span>
	<span class="n">spider_net_refill_rx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spider_net_enable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">spider_net_free_rx_chain_contents</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_get_multicast_hash - generates hash for multicast filter table</span>
<span class="cm"> * @addr: multicast address</span>
<span class="cm"> *</span>
<span class="cm"> * returns the hash value.</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_get_multicast_hash calculates a hash value for a given multicast</span>
<span class="cm"> * address, that is used to set the multicast filter tables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">spider_net_get_multicast_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">addr_for_crc</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">addr_for_crc</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">+=</span> <span class="n">bit</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_be</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr_for_crc</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">);</span>
	<span class="n">hash</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">hash</span> <span class="o">|=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">hash</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_set_multi - sets multicast addresses and promisc flags</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_set_multi configures multicast addresses as needed for the</span>
<span class="cm"> * netdev interface. It also sets up multicast, allmulti and promisc</span>
<span class="cm"> * flags appropriately</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bitmask</span><span class="p">[</span><span class="n">SPIDER_NET_MULTICAST_HASHES</span> <span class="o">/</span> <span class="n">BITS_PER_LONG</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

	<span class="n">spider_net_set_promisc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_MULTICAST_HASHES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">write_hash</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* well, we know, what the broadcast hash value is: it&#39;s xfd</span>
<span class="cm">	hash = spider_net_get_multicast_hash(netdev, netdev-&gt;broadcast); */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mh">0xfd</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">);</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="n">spider_net_get_multicast_hash</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">write_hash:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_MULTICAST_HASHES</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">+=</span> <span class="mh">0x08</span><span class="p">;</span>

		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRMHFILnR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_prepare_tx_descr - fill tx descriptor with skb data</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> * @skb: packet to use</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure.</span>
<span class="cm"> *</span>
<span class="cm"> * fills out the descriptor structure with skb data and len. Copies data,</span>
<span class="cm"> * if needed (32bit DMA!)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_prepare_tx_descr</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not iommu-map packet (%p, %i). &quot;</span>
				  <span class="s">&quot;Dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">spider_stats</span><span class="p">.</span><span class="n">tx_iommu_map_error</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwdescr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span>
			<span class="n">SPIDER_NET_DESCR_CARDOWNED</span> <span class="o">|</span> <span class="n">SPIDER_NET_DMAC_TXFRMTL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IPPROTO_TCP</span>:
			<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">|=</span> <span class="n">SPIDER_NET_DMAC_TCP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IPPROTO_UDP</span>:
			<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">|=</span> <span class="n">SPIDER_NET_DMAC_UDP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* Chain the bus address, so that the DMA engine finds this descr. */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* set netdev watchdog timer */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_set_low_watermark</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Measure the length of the queue. Measurement does not</span>
<span class="cm">	 * need to be precise -- does not need a lock. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">descr</span> <span class="o">!=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If TX queue is short, don&#39;t even bother with interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">num_desc</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* Set low-watermark 3/4th&#39;s of the way into the queue. */</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cnt</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* Set the new watermark, clear the old watermark */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">|=</span> <span class="n">SPIDER_NET_DESCR_TXDESFLG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">low_watermark</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">low_watermark</span> <span class="o">!=</span> <span class="n">descr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwdescr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">low_watermark</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span>
		     <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SPIDER_NET_DESCR_TXDESFLG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">low_watermark</span> <span class="o">=</span> <span class="n">descr</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_release_tx_chain - processes sent tx descriptors</span>
<span class="cm"> * @card: adapter structure</span>
<span class="cm"> * @brutal: if set, don&#39;t care about whether descriptor seems to be in use</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if the tx ring is empty, otherwise 1.</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_release_tx_chain releases the tx descriptors that spider has</span>
<span class="cm"> * finished with (if non-brutal) or simply release tx descriptors (if brutal).</span>
<span class="cm"> * If some other context is calling this function, we return 1 so that we&#39;re</span>
<span class="cm"> * scheduled again (if we were scheduled) and will not lose initiative.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_release_tx_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">brutal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
		<span class="n">hwdescr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">hwdescr</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SPIDER_NET_DESCR_COMPLETE</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPIDER_NET_DESCR_CARDOWNED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brutal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* fallthrough, if we release the descriptors</span>
<span class="cm">			 * brutally (then we don&#39;t care about</span>
<span class="cm">			 * SPIDER_NET_DESCR_CARDOWNED) */</span>

		<span class="k">case</span> <span class="n">SPIDER_NET_DESCR_RESPONSE_ERROR</span>:
		<span class="k">case</span> <span class="n">SPIDER_NET_DESCR_PROTECTION_ERROR</span>:
		<span class="k">case</span> <span class="n">SPIDER_NET_DESCR_FORCE_END</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_tx_err</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forcing end of tx descriptor &quot;</span>
				       <span class="s">&quot;with status x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brutal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">|=</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">buf_addr</span> <span class="o">=</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* unmap the skb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_kick_tx_dma - enables TX DMA processing</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will start the transmit DMA running if</span>
<span class="cm"> * it is not already running. This routine ned only be</span>
<span class="cm"> * called when queueing a new packet to an empty tx queue.</span>
<span class="cm"> * Writes the current tx chain head as start address</span>
<span class="cm"> * of the tx descriptor chain and enables the transmission</span>
<span class="cm"> * DMA engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">spider_net_kick_tx_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDTDMACCNTR</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">SPIDER_NET_TX_DMA_EN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">descr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">SPIDER_NET_DESCR_CARDOWNED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDTDCHA</span><span class="p">,</span>
					<span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>
			<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDTDMACCNTR</span><span class="p">,</span>
					<span class="n">SPIDER_NET_DMA_TX_VALUE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SPIDER_NET_TX_TIMER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_xmit - transmits a frame over the device</span>
<span class="cm"> * @skb: packet to send out</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, !0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">spider_net_release_tx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_prepare_tx_descr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">spider_net_set_low_watermark</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">spider_net_kick_tx_dma</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_cleanup_tx_ring - cleans up the TX ring</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_cleanup_tx_ring is called by either the tx_timer</span>
<span class="cm"> * or from the NAPI polling routine.</span>
<span class="cm"> * This routine releases resources associted with transmitted</span>
<span class="cm"> * packets, including updating the queue tail pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_cleanup_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">spider_net_release_tx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spider_net_kick_tx_dma</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_do_ioctl - called for device ioctls</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> * @ifr: request parameter structure for ioctl</span>
<span class="cm"> * @cmd: command code for ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure. Currently, we have no special ioctls.</span>
<span class="cm"> * -EOPNOTSUPP is returned, if an unknown ioctl was requested</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_pass_skb_up - takes an skb from a descriptor and passes it on</span>
<span class="cm"> * @descr: descriptor to process</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * Fills out skb structure and passes the data to the stack.</span>
<span class="cm"> * The descriptor state is not changed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_pass_skb_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_status</span> <span class="o">=</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_error</span> <span class="o">=</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_error</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">valid_size</span><span class="p">);</span>

	<span class="cm">/* the card seems to add 2 bytes of junk in front</span>
<span class="cm">	 * of the ethernet frame */</span>
<span class="cp">#define SPIDER_MISALIGN		2</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SPIDER_MISALIGN</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* checksum offload */</span>
	<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">data_status</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_DATA_STATUS_CKSUM_MASK</span><span class="p">)</span> <span class="o">==</span>
		       <span class="n">SPIDER_NET_DATA_STATUS_CKSUM_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="p">(</span><span class="n">data_error</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_DATA_ERR_CKSUM_MASK</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_status</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_VLAN_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* further enhancements: HW-accel VLAN */</span>
	<span class="p">}</span>

	<span class="cm">/* update netdevice statistics */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* pass skb up to stack */</span>
	<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_rx_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">start</span><span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwd</span> <span class="o">=</span> <span class="n">start</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curr_desc</span><span class="p">,</span> <span class="n">next_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cstat</span> <span class="o">=</span> <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Total number of descrs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chain tail located at descr=%d, status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">off</span><span class="p">,</span> <span class="n">cstat</span><span class="p">);</span>

	<span class="n">curr_desc</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDACTDPA</span><span class="p">);</span>
	<span class="n">next_desc</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDACNEXTDA</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cstat</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">hwd</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">descr</span> <span class="o">-</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">==</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chain head is at %d, head status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			         <span class="n">off</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">curr_desc</span> <span class="o">==</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW curr desc (GDACTDPA) is at %d, status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			         <span class="n">off</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next_desc</span> <span class="o">==</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW next desc (GDACNEXTDA) is at %d, status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			         <span class="n">off</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hwd</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chain is cut at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cstat</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span> <span class="o">+</span> <span class="n">off</span> <span class="o">-</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">%</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span> <span class="o">+</span> <span class="n">off</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Have %d (from %d to %d) descrs &quot;</span>
			         <span class="s">&quot;with stat=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">cstat</span><span class="p">);</span>
			<span class="n">cstat</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cnt</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">tot</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">descr</span> <span class="o">!=</span> <span class="n">start</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Last %d descrs with stat=0x%08x &quot;</span>
	         <span class="s">&quot;for a total of %d descrs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">cstat</span><span class="p">,</span> <span class="n">tot</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/* Now dump the whole ring */</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwd</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">hwd</span><span class="p">);</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">descr</span> <span class="o">-</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Descr %d stat=0x%08x skb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		         <span class="n">cnt</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bus addr=%08x buf addr=%08x sz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		         <span class="n">descr</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="p">,</span> <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;next=%08x result sz=%d valid sz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		         <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span><span class="p">,</span> <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">result_size</span><span class="p">,</span>
		         <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">valid_size</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dmac=%08x data stat=%08x data err=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		         <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span><span class="p">,</span> <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">data_status</span><span class="p">,</span>
		         <span class="n">hwd</span><span class="o">-&gt;</span><span class="n">data_error</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">descr</span> <span class="o">!=</span> <span class="n">start</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_resync_head_ptr - Advance head ptr past empty descrs</span>
<span class="cm"> *</span>
<span class="cm"> * If the driver fails to keep up and empty the queue, then the</span>
<span class="cm"> * hardware wil run out of room to put incoming packets. This</span>
<span class="cm"> * will cause the hardware to skip descrs that are full (instead</span>
<span class="cm"> * of halting/retrying). Thus, once the driver runs, it wil need</span>
<span class="cm"> * to &quot;catch up&quot; to where the hardware chain pointer is at.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spider_net_resync_head_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Advance head pointer past any empty descrs */</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SPIDER_NET_DESCR_CARDOWNED</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">descr</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">spider_net_resync_tail_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Advance tail pointer past any empty and reaped descrs */</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SPIDER_NET_DESCR_CARDOWNED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">descr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">num_desc</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_decode_one_descr - processes an RX descriptor</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if a packet has been sent to the stack, otherwise 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Processes an RX descriptor by iommu-unmapping the data buffer</span>
<span class="cm"> * and passing the packet up to the stack. This function is called</span>
<span class="cm"> * in softirq context, e.g. either bottom half from interrupt or</span>
<span class="cm"> * NAPI polling context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_decode_one_descr</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_descr</span> <span class="o">*</span><span class="n">descr</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_hw_descr</span> <span class="o">*</span><span class="n">hwdescr</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">hwdescr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_buf_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">spider_net_get_descr_status</span><span class="p">(</span><span class="n">hwdescr</span><span class="p">);</span>

	<span class="cm">/* Nothing in the descriptor, or ring must be empty */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_CARDOWNED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* descriptor definitively used -- move on tail */</span>
	<span class="n">chain</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* unmap descriptor */</span>
	<span class="n">hw_buf_addr</span> <span class="o">=</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_addr</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw_buf_addr</span><span class="p">,</span>
			<span class="n">SPIDER_NET_MAX_FRAME</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_RESPONSE_ERROR</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_PROTECTION_ERROR</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SPIDER_NET_DESCR_FORCE_END</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;dropping RX descriptor with state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SPIDER_NET_DESCR_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SPIDER_NET_DESCR_FRAME_END</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;RX descriptor with unknown state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">spider_stats</span><span class="p">.</span><span class="n">rx_desc_unk_state</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The cases we&#39;ll throw away the packet immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_error</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_DESTROY_RX_FLAGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;error in received descriptor found, &quot;</span>
			       <span class="s">&quot;data_status=x%08x, data_error=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_status</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bad_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_DESCR_BAD_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad status, cmd_status=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;buf_addr=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_buf_addr</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;buf_size=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;next_descr_addr=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">next_descr_addr</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;result_size=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">result_size</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;valid_size=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">valid_size</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;data_status=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_status</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;data_error=x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">data_error</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;which=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">descr</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">.</span><span class="n">ring</span><span class="p">);</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">spider_stats</span><span class="p">.</span><span class="n">rx_desc_error</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bad_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ok, we&#39;ve got a packet in descr */</span>
	<span class="n">spider_net_pass_skb_up</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">bad_desc:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_rx_err</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">show_rx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hwdescr</span><span class="o">-&gt;</span><span class="n">dmac_cmd_status</span> <span class="o">=</span> <span class="n">SPIDER_NET_DESCR_NOT_IN_USE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_poll - NAPI poll function called by the stack to return packets</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> * @budget: number of packets we can pass to the stack at most</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if no more packets available to the driver/stack. Returns 1,</span>
<span class="cm"> * if the quota is exceeded, but the driver has still packets.</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_poll returns all packets from the rx descriptors to the stack</span>
<span class="cm"> * (using netif_receive_skb). If all/enough packets are up, the driver</span>
<span class="cm"> * reenables interrupts and returns 0. If not, 1 is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">spider_net_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spider_net_card</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">packets_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">packets_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spider_net_decode_one_descr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">packets_done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">packets_done</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spider_net_resync_tail_ptr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">packets_done</span> <span class="o">=</span> <span class="n">budget</span><span class="p">;</span>
		<span class="n">spider_net_resync_head_ptr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spider_net_refill_rx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spider_net_enable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">spider_net_cleanup_tx_ring</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* if all packets are in the stack, enable interrupts and return 0 */</span>
	<span class="cm">/* if not, return 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packets_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">spider_net_rx_irq_on</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">ignore_rx_ramfull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">packets_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_change_mtu - changes the MTU of an interface</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> * @new_mtu: new MTU value</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no need to re-alloc skbs or so -- the max mtu is about 2.3k</span>
<span class="cm">	 * and mtu is outbound only anyway */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_MIN_MTU</span> <span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">SPIDER_NET_MAX_MTU</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_set_mac - sets the MAC of an interface</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> * @ptr: pointer to new MAC address</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on failure. Currently, we don&#39;t support this</span>
<span class="cm"> * and will always return EOPNOTSUPP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">macl</span><span class="p">,</span> <span class="n">macu</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="cm">/* switch off GMACTPE and GMACRPE */</span>
	<span class="n">regvalue</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">);</span>
	<span class="n">regvalue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">);</span>

	<span class="cm">/* write mac */</span>
	<span class="n">macu</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">macl</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACUNIMACU</span><span class="p">,</span> <span class="n">macu</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACUNIMACL</span><span class="p">,</span> <span class="n">macl</span><span class="p">);</span>

	<span class="cm">/* switch GMACTPE and GMACRPE back on */</span>
	<span class="n">regvalue</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">);</span>
	<span class="n">regvalue</span> <span class="o">|=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">);</span>

	<span class="n">spider_net_set_promisc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* look up, whether we have been successful */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_get_mac_address</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_link_reset</span>
<span class="cm"> * @netdev: net device structure</span>
<span class="cm"> *</span>
<span class="cm"> * This is called when the PHY_LINK signal is asserted. For the blade this is</span>
<span class="cm"> * not connected so we should never get here.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_link_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">);</span>

	<span class="cm">/* clear interrupt, block further interrupts */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACST</span><span class="p">,</span>
			     <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACST</span><span class="p">));</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACINTEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* reset phy and setup aneg */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">medium</span> <span class="o">=</span> <span class="n">BCM54XX_COPPER</span><span class="p">;</span>
	<span class="n">spider_net_setup_aneg</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SPIDER_NET_ANEG_TIMER</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_handle_error_irq - handles errors raised by an interrupt</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> * @status_reg: interrupt status register 0 (GHIINT0STS)</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_handle_error_irq treats or ignores all error conditions</span>
<span class="cm"> * found when an interrupt is presented</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_handle_error_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status_reg</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">error_reg1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">error_reg2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">show_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check GHIINT0STS ************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="cm">/* let error_reg1 and error_reg2 evaluation decide, what to do</span>
<span class="cm">	case SPIDER_NET_PHYINT:</span>
<span class="cm">	case SPIDER_NET_GMAC2INT:</span>
<span class="cm">	case SPIDER_NET_GMAC1INT:</span>
<span class="cm">	case SPIDER_NET_GFIFOINT:</span>
<span class="cm">	case SPIDER_NET_DMACINT:</span>
<span class="cm">	case SPIDER_NET_GSYSINT:</span>
<span class="cm">		break; */</span>

	<span class="k">case</span> <span class="n">SPIDER_NET_GIPSINT</span>:
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPIDER_NET_GPWOPCMPINT</span>:
		<span class="cm">/* PHY write operation completed */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GPROPCMPINT</span>:
		<span class="cm">/* PHY read operation completed */</span>
		<span class="cm">/* we don&#39;t use semaphores, as we poll for the completion</span>
<span class="cm">		 * of the read operation in spider_net_read_phy. Should take</span>
<span class="cm">		 * about 50 us */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GPWFFINT</span>:
		<span class="cm">/* PHY command queue full */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY write queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* case SPIDER_NET_GRMDADRINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GRMARPINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GRMMPINT: not used. print a message */</span>

	<span class="k">case</span> <span class="n">SPIDER_NET_GDTDEN0INT</span>:
		<span class="cm">/* someone has set TX_DMA_EN to 0 */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPIDER_NET_GDDDEN0INT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDCDEN0INT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDBDEN0INT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDADEN0INT</span>:
		<span class="cm">/* someone has set RX_DMA_EN to 0 */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* RX interrupts */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDDFDCINT</span>:
	<span class="k">case</span> <span class="n">SPIDER_NET_GDCFDCINT</span>:
	<span class="k">case</span> <span class="n">SPIDER_NET_GDBFDCINT</span>:
	<span class="k">case</span> <span class="n">SPIDER_NET_GDAFDCINT</span>:
	<span class="cm">/* case SPIDER_NET_GDNMINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GCNMINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GBNMINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GANMINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GRFNMINT: not used. print a message */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* TX interrupts */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDTFDCINT</span>:
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GTTEDINT</span>:
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDTDCEINT</span>:
		<span class="cm">/* chain end. If a descriptor should be sent, kick off</span>
<span class="cm">		 * tx dma</span>
<span class="cm">		if (card-&gt;tx_chain.tail != card-&gt;tx_chain.head)</span>
<span class="cm">			spider_net_kick_tx_dma(card);</span>
<span class="cm">		*/</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* case SPIDER_NET_G1TMCNTINT: not used. print a message */</span>
	<span class="cm">/* case SPIDER_NET_GFREECNTINT: not used. print a message */</span>
	<span class="p">}</span>

	<span class="cm">/* check GHIINT1STS ************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_reg1</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error_reg1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GTMFLLINT</span>:
		<span class="cm">/* TX RAM full may happen on a usual case.</span>
<span class="cm">		 * Logging is not needed. */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GRFDFLLINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GRFCFLLINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GRFBFLLINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GRFAFLLINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GRMFLLINT</span>:
		<span class="cm">/* Could happen when rx chain is full */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ignore_rx_ramfull</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">ignore_rx_ramfull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">spider_net_resync_head_ptr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">spider_net_refill_rx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">spider_net_enable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">++</span><span class="p">;</span>
			<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* case SPIDER_NET_GTMSHTINT: problem, print a message */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDTINVDINT</span>:
		<span class="cm">/* allrighty. tx from previous descr ok */</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* chain end */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDDDCEINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDCDCEINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDBDCEINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDADCEINT</span>:
		<span class="n">spider_net_resync_head_ptr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">spider_net_refill_rx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">spider_net_enable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* invalid descriptor */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDDINVDINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDCINVDINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDBINVDINT</span>: <span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">SPIDER_NET_GDAINVDINT</span>:
		<span class="cm">/* Could happen when rx chain is full */</span>
		<span class="n">spider_net_resync_head_ptr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">spider_net_refill_rx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">spider_net_enable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* case SPIDER_NET_GDTRSERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDDRSERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDCRSERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDBRSERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDARSERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDSERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDTPTERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDDPTERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDCPTERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDBPTERINT: problem, print a message */</span>
	<span class="cm">/* case SPIDER_NET_GDAPTERINT: problem, print a message */</span>
	<span class="nl">default:</span>
		<span class="n">show_error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check GHIINT2STS ************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_reg2</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error_reg2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="cm">/* there is nothing we can (want  to) do at this time. Log a</span>
<span class="cm">	 * message, we can switch on and off the specific values later on</span>
<span class="cm">	case SPIDER_NET_GPROPERINT:</span>
<span class="cm">	case SPIDER_NET_GMCTCRSNGINT:</span>
<span class="cm">	case SPIDER_NET_GMCTLCOLINT:</span>
<span class="cm">	case SPIDER_NET_GMCTTMOTINT:</span>
<span class="cm">	case SPIDER_NET_GMCRCAERINT:</span>
<span class="cm">	case SPIDER_NET_GMCRCALERINT:</span>
<span class="cm">	case SPIDER_NET_GMCRALNERINT:</span>
<span class="cm">	case SPIDER_NET_GMCROVRINT:</span>
<span class="cm">	case SPIDER_NET_GMCRRNTINT:</span>
<span class="cm">	case SPIDER_NET_GMCRRXERINT:</span>
<span class="cm">	case SPIDER_NET_GTITCSERINT:</span>
<span class="cm">	case SPIDER_NET_GTIFMTERINT:</span>
<span class="cm">	case SPIDER_NET_GTIPKTRVKINT:</span>
<span class="cm">	case SPIDER_NET_GTISPINGINT:</span>
<span class="cm">	case SPIDER_NET_GTISADNGINT:</span>
<span class="cm">	case SPIDER_NET_GTISPDNGINT:</span>
<span class="cm">	case SPIDER_NET_GRIFMTERINT:</span>
<span class="cm">	case SPIDER_NET_GRIPKTRVKINT:</span>
<span class="cm">	case SPIDER_NET_GRISPINGINT:</span>
<span class="cm">	case SPIDER_NET_GRISADNGINT:</span>
<span class="cm">	case SPIDER_NET_GRISPDNGINT:</span>
<span class="cm">		break;</span>
<span class="cm">	*/</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">show_error</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">netif_msg_intr</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error interrupt, GHIINT0STS = 0x%08x, &quot;</span>
		       <span class="s">&quot;GHIINT1STS = 0x%08x, GHIINT2STS = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">status_reg</span><span class="p">,</span> <span class="n">error_reg1</span><span class="p">,</span> <span class="n">error_reg2</span><span class="p">);</span>

	<span class="cm">/* clear interrupt sources */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT1STS</span><span class="p">,</span> <span class="n">error_reg1</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT2STS</span><span class="p">,</span> <span class="n">error_reg2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_interrupt - interrupt handler for spider_net</span>
<span class="cm"> * @irq: interrupt number</span>
<span class="cm"> * @ptr: pointer to net_device</span>
<span class="cm"> *</span>
<span class="cm"> * returns IRQ_HANDLED, if interrupt was for driver, or IRQ_NONE, if no</span>
<span class="cm"> * interrupt found raised by card.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the interrupt handler, that turns off</span>
<span class="cm"> * interrupts for this device and makes the stack poll the driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">spider_net_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status_reg</span><span class="p">,</span> <span class="n">error_reg1</span><span class="p">,</span> <span class="n">error_reg2</span><span class="p">;</span>

	<span class="n">status_reg</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT0STS</span><span class="p">);</span>
	<span class="n">error_reg1</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT1STS</span><span class="p">);</span>
	<span class="n">error_reg2</span> <span class="o">=</span> <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT2STS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_INT0_MASK_VALUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">error_reg1</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_INT1_MASK_VALUE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">error_reg2</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_INT2_MASK_VALUE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_RXINT</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">spider_net_rx_irq_off</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_TXINT</span><span class="p">)</span>
		<span class="n">napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_LINKINT</span><span class="p">)</span>
		<span class="n">spider_net_link_reset</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">SPIDER_NET_ERRINT</span> <span class="p">)</span>
		<span class="n">spider_net_handle_error_irq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">,</span>
					    <span class="n">error_reg1</span><span class="p">,</span> <span class="n">error_reg2</span><span class="p">);</span>

	<span class="cm">/* clear interrupt sources */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT0STS</span><span class="p">,</span> <span class="n">status_reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/**</span>
<span class="cm"> * spider_net_poll_controller - artificial interrupt for netconsole etc.</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * see Documentation/networking/netconsole.txt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_poll_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">spider_net_interrupt</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NET_POLL_CONTROLLER */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_enable_interrupts - enable interrupts</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_enable_interrupt enables several interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT0MSK</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_INT0_MASK_VALUE</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT1MSK</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_INT1_MASK_VALUE</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT2MSK</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_INT2_MASK_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_disable_interrupts - disable interrupts</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_disable_interrupts disables all the interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT0MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT1MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GHIINT2MSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACINTEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_init_card - initializes the card</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_init_card initializes the card so that other registers can</span>
<span class="cm"> * be used</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_CKRCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_CKRCTRL_STOP_VALUE</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_CKRCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_CKRCTRL_RUN_VALUE</span><span class="p">);</span>

	<span class="cm">/* trigger ETOMOD signal */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">,</span>
		<span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x4</span><span class="p">);</span>

	<span class="n">spider_net_disable_interrupts</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_enable_card - enables the card by setting all kinds of regs</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_enable_card sets a lot of SMMIO registers to enable the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_enable_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* the following array consists of (register),(value) pairs</span>
<span class="cm">	 * that are set in this function. A register of 0 ends the list */</span>
	<span class="n">u32</span> <span class="n">regs</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GRESUMINTNUM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GREINTNUM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

		<span class="cm">/* set interrupt frame number registers */</span>
		<span class="cm">/* clear the single DMA engine registers first */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GFAFRMNUM</span><span class="p">,</span> <span class="n">SPIDER_NET_GFXFRAMES_VALUE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GFBFRMNUM</span><span class="p">,</span> <span class="n">SPIDER_NET_GFXFRAMES_VALUE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GFCFRMNUM</span><span class="p">,</span> <span class="n">SPIDER_NET_GFXFRAMES_VALUE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GFDFRMNUM</span><span class="p">,</span> <span class="n">SPIDER_NET_GFXFRAMES_VALUE</span> <span class="p">},</span>
		<span class="cm">/* then set, what we really need */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GFFRMNUM</span><span class="p">,</span> <span class="n">SPIDER_NET_FRAMENUM_VALUE</span> <span class="p">},</span>

		<span class="cm">/* timer counter registers and stuff */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GFREECNNUM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GONETIMENUM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GTOUTFRMNUM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

		<span class="cm">/* RX mode setting */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GRXMDSET</span><span class="p">,</span> <span class="n">SPIDER_NET_RXMODE_VALUE</span> <span class="p">},</span>
		<span class="cm">/* TX mode setting */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GTXMDSET</span><span class="p">,</span> <span class="n">SPIDER_NET_TXMODE_VALUE</span> <span class="p">},</span>
		<span class="cm">/* IPSEC mode setting */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GIPSECINIT</span><span class="p">,</span> <span class="n">SPIDER_NET_IPSECINIT_VALUE</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SPIDER_NET_GFTRESTRT</span><span class="p">,</span> <span class="n">SPIDER_NET_RESTART_VALUE</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SPIDER_NET_GMRWOLCTRL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GTESTMD</span><span class="p">,</span> <span class="mh">0x10000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GTTQMSK</span><span class="p">,</span> <span class="mh">0x00400040</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SPIDER_NET_GMACINTEN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

		<span class="cm">/* flow control stuff */</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GMACAPAUSE</span><span class="p">,</span> <span class="n">SPIDER_NET_MACAPAUSE_VALUE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SPIDER_NET_GMACTXPAUSE</span><span class="p">,</span> <span class="n">SPIDER_NET_TXPAUSE_VALUE</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SPIDER_NET_GMACBSTLMT</span><span class="p">,</span> <span class="n">SPIDER_NET_BURSTLMT_VALUE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear unicast filter table entries 1 to 14 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				     <span class="n">SPIDER_NET_GMRUAFILnR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
				     <span class="mh">0x00080000</span><span class="p">);</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				     <span class="n">SPIDER_NET_GMRUAFILnR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
				     <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMRUA0FIL15R</span><span class="p">,</span> <span class="mh">0x08080000</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_ECMODE</span><span class="p">,</span> <span class="n">SPIDER_NET_ECMODE_VALUE</span><span class="p">);</span>

	<span class="cm">/* set chain tail address for RX chains and</span>
<span class="cm">	 * enable DMA */</span>
	<span class="n">spider_net_enable_rxchtails</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spider_net_enable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GRXDMAEN</span><span class="p">,</span> <span class="n">SPIDER_NET_WOL_VALUE</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACLENLMT</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_LENLMT_VALUE</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACOPEMD</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_OPMODE_VALUE</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDTDMACCNTR</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_GDTBSTA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_download_firmware - loads firmware into the adapter</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> * @firmware_ptr: pointer to firmware data</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_download_firmware loads the firmware data into the</span>
<span class="cm"> * adapter. It assumes the length etc. to be allright.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">firmware_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sequencer</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fw_ptr</span> <span class="o">=</span> <span class="n">firmware_ptr</span><span class="p">;</span>

	<span class="cm">/* stop sequencers */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSINIT</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_STOP_SEQ_VALUE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sequencer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sequencer</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_FIRMWARE_SEQS</span><span class="p">;</span>
	     <span class="n">sequencer</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				     <span class="n">SPIDER_NET_GSnPRGADR</span> <span class="o">+</span> <span class="n">sequencer</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_FIRMWARE_SEQWORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSnPRGDAT</span> <span class="o">+</span>
					     <span class="n">sequencer</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="o">*</span><span class="n">fw_ptr</span><span class="p">);</span>
			<span class="n">fw_ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSINIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSINIT</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_RUN_SEQ_VALUE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_init_firmware - reads in firmware parts</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on failure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_init_firmware opens the sequencer firmware and does some basic</span>
<span class="cm"> * checks. This function opens and releases the firmware structure. A call</span>
<span class="cm"> * to download the firmware is performed before the release.</span>
<span class="cm"> *</span>
<span class="cm"> * Firmware format</span>
<span class="cm"> * ===============</span>
<span class="cm"> * spider_fw.bin is expected to be a file containing 6*1024*4 bytes, 4k being</span>
<span class="cm"> * the program for each sequencer. Use the command</span>
<span class="cm"> *    tail -q -n +2 Seq_code1_0x088.txt Seq_code2_0x090.txt              \</span>
<span class="cm"> *         Seq_code3_0x098.txt Seq_code4_0x0A0.txt Seq_code5_0x0A8.txt   \</span>
<span class="cm"> *         Seq_code6_0x0B0.txt | xxd -r -p -c4 &gt; spider_fw.bin</span>
<span class="cm"> *</span>
<span class="cm"> * to generate spider_fw.bin, if you have sequencer programs with something</span>
<span class="cm"> * like the following contents for each sequencer:</span>
<span class="cm"> *    &lt;ONE LINE COMMENT&gt;</span>
<span class="cm"> *    &lt;FIRST 4-BYTES-WORD FOR SEQUENCER&gt;</span>
<span class="cm"> *    &lt;SECOND 4-BYTES-WORD FOR SEQUENCER&gt;</span>
<span class="cm"> *     ...</span>
<span class="cm"> *    &lt;1024th 4-BYTES-WORD FOR SEQUENCER&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_init_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">fw_prop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">firmware</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_FIRMWARE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">SPIDER_NET_FIRMWARE_LEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="s">&quot;Incorrect size of spidernet firmware in &quot;</span> \
			       <span class="s">&quot;filesystem. Looking in host firmware...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try_host_fw</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">spider_net_download_firmware</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">release_firmware</span><span class="p">(</span><span class="n">firmware</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">try_host_fw</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">try_host_fw:</span>
	<span class="n">dn</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">fw_prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;firmware&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_prop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">fw_size</span> <span class="o">!=</span> <span class="n">SPIDER_NET_FIRMWARE_LEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;Incorrect size of spidernet firmware in host firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">spider_net_download_firmware</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">fw_prop</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">out_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		       <span class="s">&quot;Couldn&#39;t find spidernet firmware in filesystem &quot;</span> \
		       <span class="s">&quot;or host firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_open - called upon ifonfig up</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_open allocates all the descriptors and memory needed for</span>
<span class="cm"> * operation, sets up multicast list and enables interrupts</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">spider_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">spider_net_init_firmware</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_firmware_failed</span><span class="p">;</span>

	<span class="cm">/* start probing with copper */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">medium</span> <span class="o">=</span> <span class="n">BCM54XX_COPPER</span><span class="p">;</span>
	<span class="n">spider_net_setup_aneg</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SPIDER_NET_ANEG_TIMER</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">spider_net_init_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_tx_failed</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">low_watermark</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">spider_net_init_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">alloc_rx_failed</span><span class="p">;</span>

	<span class="cm">/* Allocate rx skbs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_alloc_rx_skbs</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">alloc_skbs_failed</span><span class="p">;</span>

	<span class="n">spider_net_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* further enhancement: setup hw vlan, if needed */</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">spider_net_interrupt</span><span class="p">,</span>
			     <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">register_int_failed</span><span class="p">;</span>

	<span class="n">spider_net_enable_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>

	<span class="n">spider_net_enable_interrupts</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">register_int_failed:</span>
	<span class="n">spider_net_free_rx_chain_contents</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="nl">alloc_skbs_failed:</span>
	<span class="n">spider_net_free_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">);</span>
<span class="nl">alloc_rx_failed:</span>
	<span class="n">spider_net_free_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">);</span>
<span class="nl">alloc_tx_failed:</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">);</span>
<span class="nl">init_firmware_failed:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_link_phy</span>
<span class="cm"> * @data: used for pointer to card structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">spider_net_link_phy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="cm">/* if link didn&#39;t come up after SPIDER_NET_ANEG_TIMEOUT tries, setup phy again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span> <span class="o">&gt;</span> <span class="n">SPIDER_NET_ANEG_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: link is down trying to bring it up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">medium</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BCM54XX_COPPER</span>:
			<span class="cm">/* enable fiber with autonegotiation first */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_fiber</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_fiber</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">medium</span> <span class="o">=</span> <span class="n">BCM54XX_FIBER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BCM54XX_FIBER</span>:
			<span class="cm">/* fiber didn&#39;t come up, try to disable fiber autoneg */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_fiber</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_fiber</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">medium</span> <span class="o">=</span> <span class="n">BCM54XX_UNKNOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BCM54XX_UNKNOWN</span>:
			<span class="cm">/* copper, fiber with and without failed,</span>
<span class="cm">			 * retry from beginning */</span>
			<span class="n">spider_net_setup_aneg</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">medium</span> <span class="o">=</span> <span class="n">BCM54XX_COPPER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SPIDER_NET_ANEG_TIMER</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* link still not up, try again later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">poll_link</span><span class="p">(</span><span class="n">phy</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SPIDER_NET_ANEG_TIMER</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* link came up, get abilities */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_link</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACST</span><span class="p">,</span>
			     <span class="n">spider_net_read_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACST</span><span class="p">));</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACINTEN</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACMODE</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GMACMODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: link up, %i Mbps, %s-duplex %sautoneg.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;Full&quot;</span> <span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">,</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;no &quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_setup_phy - setup PHY</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_setup_phy is used as part of spider_net_probe.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_setup_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDTDMASEL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_DMASEL_VALUE</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GPCCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_PHY_CTRL_VALUE</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">spider_net_read_phy</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">spider_net_write_phy</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">spider_net_read_phy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x0000</span> <span class="o">&amp;&amp;</span> <span class="n">id</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sungem_phy_probe</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mii_id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Found %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">def</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_workaround_rxramfull - work around firmware bug</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * no return value</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_workaround_rxramfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sequencer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* cancel reset */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_CKRCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_CKRCTRL_RUN_VALUE</span><span class="p">);</span>

	<span class="cm">/* empty sequencer data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sequencer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sequencer</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_FIRMWARE_SEQS</span><span class="p">;</span>
	     <span class="n">sequencer</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSnPRGADR</span> <span class="o">+</span>
				     <span class="n">sequencer</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_FIRMWARE_SEQWORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSnPRGDAT</span> <span class="o">+</span>
					     <span class="n">sequencer</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set sequencer operation */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GSINIT</span><span class="p">,</span> <span class="mh">0x000000fe</span><span class="p">);</span>

	<span class="cm">/* reset */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_CKRCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_CKRCTRL_STOP_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_stop - called upon ifconfig down</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * always returns 0</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">spider_net_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">);</span>

	<span class="n">spider_net_disable_interrupts</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_GDTDMACCNTR</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_DMA_TX_FEND_VALUE</span><span class="p">);</span>

	<span class="cm">/* turn off DMA, force end */</span>
	<span class="n">spider_net_disable_rxdmac</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* release chains */</span>
	<span class="n">spider_net_release_tx_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spider_net_free_rx_chain_contents</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">spider_net_free_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">);</span>
	<span class="n">spider_net_free_chain</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_tx_timeout_task - task scheduled by the watchdog timeout</span>
<span class="cm"> * function (to be called not under interrupt status)</span>
<span class="cm"> * @data: data, is interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * called as task when tx hangs, resets interface (if interface is up)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spider_net_card</span><span class="p">,</span> <span class="n">tx_timeout_task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">spider_net_stop</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">spider_net_workaround_rxramfull</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spider_net_init_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spider_net_setup_phy</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spider_net_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">spider_net_kick_tx_dma</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task_counter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_tx_timeout - called when the tx timeout watchdog kicks in.</span>
<span class="cm"> * @netdev: interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * called, if tx hangs. Schedules a task that resets the interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task_counter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task_counter</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">spider_stats</span><span class="p">.</span><span class="n">tx_timeouts</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">spider_net_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">spider_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">spider_net_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">spider_net_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">spider_net_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">spider_net_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">spider_net_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">spider_net_do_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">spider_net_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="cm">/* HW VLAN */</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="cm">/* poll controller */</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">spider_net_poll_controller</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_NET_POLL_CONTROLLER */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_setup_netdev_ops - initialization of net_device operations</span>
<span class="cm"> * @netdev: net_device structure</span>
<span class="cm"> *</span>
<span class="cm"> * fills out function pointers in the net_device structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_setup_netdev_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spider_net_ops</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">SPIDER_NET_WATCHDOG_TIMEOUT</span><span class="p">;</span>
	<span class="cm">/* ethtool ops */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spider_net_ethtool_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_setup_netdev - initialization of net_device</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or &lt;0 on failure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_setup_netdev initializes the net_device structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spider_net_setup_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">spider_net_cleanup_tx_ring</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">spider_net_link_phy</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">aneg_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span>
		       <span class="n">spider_net_poll</span><span class="p">,</span> <span class="n">SPIDER_NET_NAPI_WEIGHT</span><span class="p">);</span>

	<span class="n">spider_net_setup_netdev_ops</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_RXCSUM</span> <span class="o">|</span> <span class="n">NETIF_F_IP_CSUM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SPIDER_NET_RX_CSUM_DEFAULT</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_LLTX</span><span class="p">;</span>
	<span class="cm">/* some time: NETIF_F_HW_VLAN_TX | NETIF_F_HW_VLAN_RX |</span>
<span class="cm">	 *		NETIF_F_HW_VLAN_FILTER */</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">num_rx_ints</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ignore_rx_ramfull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mac</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;local-mac-address&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">spider_net_set_mac</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">card</span><span class="p">)))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;Failed to set MAC address: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			        <span class="s">&quot;Couldn&#39;t register net_device: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_msg_probe</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Initialized device %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_alloc_card - allocates net_device and card structure</span>
<span class="cm"> *</span>
<span class="cm"> * returns the card structure or NULL in case of errors</span>
<span class="cm"> *</span>
<span class="cm"> * the card and net_device structures are linked to each other</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span>
<span class="nf">spider_net_alloc_card</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">alloc_size</span><span class="p">;</span>

	<span class="n">alloc_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span><span class="p">)</span> <span class="o">+</span>
	   <span class="p">(</span><span class="n">tx_descriptors</span> <span class="o">+</span> <span class="n">rx_descriptors</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_descr</span><span class="p">);</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="n">alloc_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">SPIDER_NET_DEFAULT_MSG</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">,</span> <span class="n">spider_net_tx_timeout_task</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task_counter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">.</span><span class="n">num_desc</span> <span class="o">=</span> <span class="n">rx_descriptors</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">.</span><span class="n">ring</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">darray</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">num_desc</span> <span class="o">=</span> <span class="n">tx_descriptors</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_chain</span><span class="p">.</span><span class="n">ring</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">darray</span> <span class="o">+</span> <span class="n">rx_descriptors</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_undo_pci_setup - releases PCI ressources</span>
<span class="cm"> * @card: card structure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_undo_pci_setup releases the mapped regions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">spider_net_undo_pci_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_setup_pci_dev - sets up the device in terms of PCI operations</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the card structure or NULL if any errors occur</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_setup_pci_dev initializes pdev and together with the</span>
<span class="cm"> * functions called in spider_net_open configures the device so that</span>
<span class="cm"> * data can be transferred over it</span>
<span class="cm"> * The net_device structure is attached to the card structure, if the</span>
<span class="cm"> * function returns without error.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span>
<span class="nf">spider_net_setup_pci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;Couldn&#39;t find proper PCI device base address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">spider_net_driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;Couldn&#39;t obtain PCI resources, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">spider_net_alloc_card</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;Couldn&#39;t allocate net_device structure, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* fetch base address and length of first resource */</span>
	<span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">mmio_start</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">mmio_start</span> <span class="o">+</span> <span class="n">mmio_len</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		        <span class="s">&quot;Couldn&#39;t obtain PCI resources, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>

<span class="nl">out_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_disable_dev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_probe - initialization of a device</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> * @ent: entry in the device id list</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on failure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_probe initializes pdev and registers a net_device</span>
<span class="cm"> * structure for it. After that, the device can be ifconfig&#39;ed up</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">spider_net_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">spider_net_setup_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spider_net_workaround_rxramfull</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spider_net_init_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">spider_net_setup_phy</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_undo_pci</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">spider_net_setup_netdev</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_undo_pci</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_undo_pci:</span>
	<span class="n">spider_net_undo_pci_setup</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_remove - removal of a device</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, &lt;0 on failure</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_remove is called to remove the device and unregisters the</span>
<span class="cm"> * net_device</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">spider_net_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spider_net_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_timeout_task_counter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* switch off card */</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_CKRCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_CKRCTRL_STOP_VALUE</span><span class="p">);</span>
	<span class="n">spider_net_write_reg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SPIDER_NET_CKRCTRL</span><span class="p">,</span>
			     <span class="n">SPIDER_NET_CKRCTRL_RUN_VALUE</span><span class="p">);</span>

	<span class="n">spider_net_undo_pci_setup</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">spider_net_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">spider_net_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">spider_net_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">spider_net_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">spider_net_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_init - init function when the driver is loaded</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_init registers the device driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">spider_net_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Spidernet version %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_descriptors</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_RX_DESCRIPTORS_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_descriptors</span> <span class="o">=</span> <span class="n">SPIDER_NET_RX_DESCRIPTORS_MIN</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;adjusting rx descriptors to %i.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_descriptors</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_descriptors</span> <span class="o">&gt;</span> <span class="n">SPIDER_NET_RX_DESCRIPTORS_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_descriptors</span> <span class="o">=</span> <span class="n">SPIDER_NET_RX_DESCRIPTORS_MAX</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;adjusting rx descriptors to %i.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_descriptors</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_descriptors</span> <span class="o">&lt;</span> <span class="n">SPIDER_NET_TX_DESCRIPTORS_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_descriptors</span> <span class="o">=</span> <span class="n">SPIDER_NET_TX_DESCRIPTORS_MIN</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;adjusting tx descriptors to %i.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_descriptors</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_descriptors</span> <span class="o">&gt;</span> <span class="n">SPIDER_NET_TX_DESCRIPTORS_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_descriptors</span> <span class="o">=</span> <span class="n">SPIDER_NET_TX_DESCRIPTORS_MAX</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;adjusting tx descriptors to %i.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_descriptors</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spider_net_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * spider_net_cleanup - exit function when driver is unloaded</span>
<span class="cm"> *</span>
<span class="cm"> * spider_net_cleanup unregisters the device driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">spider_net_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spider_net_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">spider_net_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">spider_net_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
