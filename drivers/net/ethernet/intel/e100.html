<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › e100.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>e100.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel PRO/100 Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2006 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  Linux NICS &lt;linux.nics@intel.com&gt;</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *	e100.c: Intel(R) PRO/100 ethernet driver</span>
<span class="cm"> *</span>
<span class="cm"> *	(Re)written 2003 by scott.feldman@intel.com.  Based loosely on</span>
<span class="cm"> *	original e100 driver, but better described as a munging of</span>
<span class="cm"> *	e100, e1000, eepro100, tg3, 8139cp, and other drivers.</span>
<span class="cm"> *</span>
<span class="cm"> *	References:</span>
<span class="cm"> *		Intel 8255x 10/100 Mbps Ethernet Controller Family,</span>
<span class="cm"> *		Open Source Software Developers Manual,</span>
<span class="cm"> *		http://sourceforge.net/projects/e1000</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *	                      Theory of Operation</span>
<span class="cm"> *</span>
<span class="cm"> *	I.   General</span>
<span class="cm"> *</span>
<span class="cm"> *	The driver supports Intel(R) 10/100 Mbps PCI Fast Ethernet</span>
<span class="cm"> *	controller family, which includes the 82557, 82558, 82559, 82550,</span>
<span class="cm"> *	82551, and 82562 devices.  82558 and greater controllers</span>
<span class="cm"> *	integrate the Intel 82555 PHY.  The controllers are used in</span>
<span class="cm"> *	server and client network interface cards, as well as in</span>
<span class="cm"> *	LAN-On-Motherboard (LOM), CardBus, MiniPCI, and ICHx</span>
<span class="cm"> *	configurations.  8255x supports a 32-bit linear addressing</span>
<span class="cm"> *	mode and operates at 33Mhz PCI clock rate.</span>
<span class="cm"> *</span>
<span class="cm"> *	II.  Driver Operation</span>
<span class="cm"> *</span>
<span class="cm"> *	Memory-mapped mode is used exclusively to access the device&#39;s</span>
<span class="cm"> *	shared-memory structure, the Control/Status Registers (CSR). All</span>
<span class="cm"> *	setup, configuration, and control of the device, including queuing</span>
<span class="cm"> *	of Tx, Rx, and configuration commands is through the CSR.</span>
<span class="cm"> *	cmd_lock serializes accesses to the CSR command register.  cb_lock</span>
<span class="cm"> *	protects the shared Command Block List (CBL).</span>
<span class="cm"> *</span>
<span class="cm"> *	8255x is highly MII-compliant and all access to the PHY go</span>
<span class="cm"> *	through the Management Data Interface (MDI).  Consequently, the</span>
<span class="cm"> *	driver leverages the mii.c library shared with other MII-compliant</span>
<span class="cm"> *	devices.</span>
<span class="cm"> *</span>
<span class="cm"> *	Big- and Little-Endian byte order as well as 32- and 64-bit</span>
<span class="cm"> *	archs are supported.  Weak-ordered memory and non-cache-coherent</span>
<span class="cm"> *	archs are supported.</span>
<span class="cm"> *</span>
<span class="cm"> *	III. Transmit</span>
<span class="cm"> *</span>
<span class="cm"> *	A Tx skb is mapped and hangs off of a TCB.  TCBs are linked</span>
<span class="cm"> *	together in a fixed-size ring (CBL) thus forming the flexible mode</span>
<span class="cm"> *	memory structure.  A TCB marked with the suspend-bit indicates</span>
<span class="cm"> *	the end of the ring.  The last TCB processed suspends the</span>
<span class="cm"> *	controller, and the controller can be restarted by issue a CU</span>
<span class="cm"> *	resume command to continue from the suspend point, or a CU start</span>
<span class="cm"> *	command to start at a given position in the ring.</span>
<span class="cm"> *</span>
<span class="cm"> *	Non-Tx commands (config, multicast setup, etc) are linked</span>
<span class="cm"> *	into the CBL ring along with Tx commands.  The common structure</span>
<span class="cm"> *	used for both Tx and non-Tx commands is the Command Block (CB).</span>
<span class="cm"> *</span>
<span class="cm"> *	cb_to_use is the next CB to use for queuing a command; cb_to_clean</span>
<span class="cm"> *	is the next CB to check for completion; cb_to_send is the first</span>
<span class="cm"> *	CB to start on in case of a previous failure to resume.  CB clean</span>
<span class="cm"> *	up happens in interrupt context in response to a CU interrupt.</span>
<span class="cm"> *	cbs_avail keeps track of number of free CB resources available.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Hardware padding of short packets to minimum packet size is</span>
<span class="cm"> * 	enabled.  82557 pads with 7Eh, while the later controllers pad</span>
<span class="cm"> * 	with 00h.</span>
<span class="cm"> *</span>
<span class="cm"> *	IV.  Receive</span>
<span class="cm"> *</span>
<span class="cm"> *	The Receive Frame Area (RFA) comprises a ring of Receive Frame</span>
<span class="cm"> *	Descriptors (RFD) + data buffer, thus forming the simplified mode</span>
<span class="cm"> *	memory structure.  Rx skbs are allocated to contain both the RFD</span>
<span class="cm"> *	and the data buffer, but the RFD is pulled off before the skb is</span>
<span class="cm"> *	indicated.  The data buffer is aligned such that encapsulated</span>
<span class="cm"> *	protocol headers are u32-aligned.  Since the RFD is part of the</span>
<span class="cm"> *	mapped shared memory, and completion status is contained within</span>
<span class="cm"> *	the RFD, the RFD must be dma_sync&#39;ed to maintain a consistent</span>
<span class="cm"> *	view from software and hardware.</span>
<span class="cm"> *</span>
<span class="cm"> *	In order to keep updates to the RFD link field from colliding with</span>
<span class="cm"> *	hardware writes to mark packets complete, we use the feature that</span>
<span class="cm"> *	hardware will not write to a size 0 descriptor and mark the previous</span>
<span class="cm"> *	packet as end-of-list (EL).   After updating the link, we remove EL</span>
<span class="cm"> *	and only then restore the size such that hardware may use the</span>
<span class="cm"> *	previous-to-end RFD.</span>
<span class="cm"> *</span>
<span class="cm"> *	Under typical operation, the  receive unit (RU) is start once,</span>
<span class="cm"> *	and the controller happily fills RFDs as frames arrive.  If</span>
<span class="cm"> *	replacement RFDs cannot be allocated, or the RU goes non-active,</span>
<span class="cm"> *	the RU must be restarted.  Frame arrival generates an interrupt,</span>
<span class="cm"> *	and Rx indication and re-allocation happen in the same context,</span>
<span class="cm"> *	therefore no locking is required.  A software-generated interrupt</span>
<span class="cm"> *	is generated from the watchdog to recover from a failed allocation</span>
<span class="cm"> *	scenario where all Rx resources have been indicated and none re-</span>
<span class="cm"> *	placed.</span>
<span class="cm"> *</span>
<span class="cm"> *	V.   Miscellaneous</span>
<span class="cm"> *</span>
<span class="cm"> * 	VLAN offloading of tagging, stripping and filtering is not</span>
<span class="cm"> * 	supported, but driver will accommodate the extra 4-byte VLAN tag</span>
<span class="cm"> * 	for processing by upper layers.  Tx/Rx Checksum offloading is not</span>
<span class="cm"> * 	supported.  Tx Scatter/Gather is not supported.  Jumbo Frames is</span>
<span class="cm"> * 	not supported (hardware limitation).</span>
<span class="cm"> *</span>
<span class="cm"> * 	MagicPacket(tm) WoL support is enabled/disabled via ethtool.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Thanks to JC (jchapman@katalix.com) for helping with</span>
<span class="cm"> * 	testing/troubleshooting the development driver.</span>
<span class="cm"> *</span>
<span class="cm"> * 	TODO:</span>
<span class="cm"> * 	o several entry points race with dev-&gt;close</span>
<span class="cm"> * 	o check for tx-no-resources/stop Q races with tx clean/wake Q</span>
<span class="cm"> *</span>
<span class="cm"> *	FIXES:</span>
<span class="cm"> * 2005/12/02 - Michael O&#39;Donnell &lt;Michael.ODonnell at stratus dot com&gt;</span>
<span class="cm"> *	- Stratus87247: protect MDI control register manipulations</span>
<span class="cm"> * 2009/06/01 - Andreas Mohr &lt;andi at lisas dot de&gt;</span>
<span class="cm"> *      - add clean lowlevel I/O emulation for cards with MII-lacking PHYs</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/dmapool.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>


<span class="cp">#define DRV_NAME		&quot;e100&quot;</span>
<span class="cp">#define DRV_EXT			&quot;-NAPI&quot;</span>
<span class="cp">#define DRV_VERSION		&quot;3.5.24-k2&quot;DRV_EXT</span>
<span class="cp">#define DRV_DESCRIPTION		&quot;Intel(R) PRO/100 Network Driver&quot;</span>
<span class="cp">#define DRV_COPYRIGHT		&quot;Copyright(c) 1999-2006 Intel Corporation&quot;</span>

<span class="cp">#define E100_WATCHDOG_PERIOD	(2 * HZ)</span>
<span class="cp">#define E100_NAPI_WEIGHT	16</span>

<span class="cp">#define FIRMWARE_D101M		&quot;e100/d101m_ucode.bin&quot;</span>
<span class="cp">#define FIRMWARE_D101S		&quot;e100/d101s_ucode.bin&quot;</span>
<span class="cp">#define FIRMWARE_D102E		&quot;e100/d102e_ucode.bin&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_D101M</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_D101S</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_D102E</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eeprom_bad_csum_allow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">eeprom_bad_csum_allow</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">use_io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0=none,...,16=all)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">eeprom_bad_csum_allow</span><span class="p">,</span> <span class="s">&quot;Allow bad eeprom checksums&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_io</span><span class="p">,</span> <span class="s">&quot;Force use of i/o access mode&quot;</span><span class="p">);</span>

<span class="cp">#define INTEL_8255X_ETHERNET_DEVICE(device_id, ich) {\</span>
<span class="cp">	PCI_VENDOR_ID_INTEL, device_id, PCI_ANY_ID, PCI_ANY_ID, \</span>
<span class="cp">	PCI_CLASS_NETWORK_ETHERNET &lt;&lt; 8, 0xFFFF00, ich }</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">e100_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1029</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1030</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1031</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1032</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1033</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1034</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1038</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1039</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x103A</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x103B</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x103C</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x103D</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x103E</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1050</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1051</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1052</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1053</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1054</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1055</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1056</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1057</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1059</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1064</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1065</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1066</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1067</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1068</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1069</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x106A</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x106B</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1091</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1092</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1093</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1094</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1095</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x10fe</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1209</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x1229</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x2449</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x2459</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x245D</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">INTEL_8255X_ETHERNET_DEVICE</span><span class="p">(</span><span class="mh">0x27DC</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">e100_id_table</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">mac</span> <span class="p">{</span>
	<span class="n">mac_82557_D100_A</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">mac_82557_D100_B</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">mac_82557_D100_C</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">mac_82558_D101_A4</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">mac_82558_D101_B0</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">mac_82559_D101M</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="n">mac_82559_D101S</span>   <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">mac_82550_D102</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="n">mac_82550_D102_C</span>  <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
	<span class="n">mac_82551_E</span>       <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	<span class="n">mac_82551_F</span>       <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="n">mac_82551_10</span>      <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">mac_unknown</span>       <span class="o">=</span> <span class="mh">0xFF</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">phy</span> <span class="p">{</span>
	<span class="n">phy_100a</span>     <span class="o">=</span> <span class="mh">0x000003E0</span><span class="p">,</span>
	<span class="n">phy_100c</span>     <span class="o">=</span> <span class="mh">0x035002A8</span><span class="p">,</span>
	<span class="n">phy_82555_tx</span> <span class="o">=</span> <span class="mh">0x015002A8</span><span class="p">,</span>
	<span class="n">phy_nsc_tx</span>   <span class="o">=</span> <span class="mh">0x5C002000</span><span class="p">,</span>
	<span class="n">phy_82562_et</span> <span class="o">=</span> <span class="mh">0x033002A8</span><span class="p">,</span>
	<span class="n">phy_82562_em</span> <span class="o">=</span> <span class="mh">0x032002A8</span><span class="p">,</span>
	<span class="n">phy_82562_ek</span> <span class="o">=</span> <span class="mh">0x031002A8</span><span class="p">,</span>
	<span class="n">phy_82562_eh</span> <span class="o">=</span> <span class="mh">0x017002A8</span><span class="p">,</span>
	<span class="n">phy_82552_v</span>  <span class="o">=</span> <span class="mh">0xd061004d</span><span class="p">,</span>
	<span class="n">phy_unknown</span>  <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* CSR (Control/Status Registers) */</span>
<span class="k">struct</span> <span class="n">csr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">stat_ack</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cmd_lo</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cmd_hi</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">gen_ptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">scb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flash_ctrl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eeprom_ctrl_lo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eeprom_ctrl_hi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mdi_ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_dma_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">scb_status</span> <span class="p">{</span>
	<span class="n">rus_no_res</span>       <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">rus_ready</span>        <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">rus_mask</span>         <span class="o">=</span> <span class="mh">0x3C</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ru_state</span>  <span class="p">{</span>
	<span class="n">RU_SUSPENDED</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">RU_RUNNING</span>	 <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">RU_UNINITIALIZED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">scb_stat_ack</span> <span class="p">{</span>
	<span class="n">stat_ack_not_ours</span>    <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">stat_ack_sw_gen</span>      <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">stat_ack_rnr</span>         <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">stat_ack_cu_idle</span>     <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">stat_ack_frame_rx</span>    <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">stat_ack_cu_cmd_done</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">stat_ack_not_present</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">,</span>
	<span class="n">stat_ack_rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat_ack_sw_gen</span> <span class="o">|</span> <span class="n">stat_ack_rnr</span> <span class="o">|</span> <span class="n">stat_ack_frame_rx</span><span class="p">),</span>
	<span class="n">stat_ack_tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat_ack_cu_idle</span> <span class="o">|</span> <span class="n">stat_ack_cu_cmd_done</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">scb_cmd_hi</span> <span class="p">{</span>
	<span class="n">irq_mask_none</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">irq_mask_all</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">irq_sw_gen</span>    <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">scb_cmd_lo</span> <span class="p">{</span>
	<span class="n">cuc_nop</span>        <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">ruc_start</span>      <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">ruc_load_base</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">cuc_start</span>      <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">cuc_resume</span>     <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">cuc_dump_addr</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">cuc_dump_stats</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">cuc_load_base</span>  <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="n">cuc_dump_reset</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">cuc_dump</span> <span class="p">{</span>
	<span class="n">cuc_dump_complete</span>       <span class="o">=</span> <span class="mh">0x0000A005</span><span class="p">,</span>
	<span class="n">cuc_dump_reset_complete</span> <span class="o">=</span> <span class="mh">0x0000A007</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">port</span> <span class="p">{</span>
	<span class="n">software_reset</span>  <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="n">selftest</span>        <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
	<span class="n">selective_reset</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_ctrl_lo</span> <span class="p">{</span>
	<span class="n">eesk</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">eecs</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">eedi</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">eedo</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">mdi_ctrl</span> <span class="p">{</span>
	<span class="n">mdi_write</span> <span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>
	<span class="n">mdi_read</span>  <span class="o">=</span> <span class="mh">0x08000000</span><span class="p">,</span>
	<span class="n">mdi_ready</span> <span class="o">=</span> <span class="mh">0x10000000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_op</span> <span class="p">{</span>
	<span class="n">op_write</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">op_read</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">op_ewds</span>  <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">op_ewen</span>  <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_offsets</span> <span class="p">{</span>
	<span class="n">eeprom_cnfg_mdix</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">eeprom_phy_iface</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">eeprom_id</span>         <span class="o">=</span> <span class="mh">0x0A</span><span class="p">,</span>
	<span class="n">eeprom_config_asf</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">,</span>
	<span class="n">eeprom_smbus_addr</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_cnfg_mdix</span> <span class="p">{</span>
	<span class="n">eeprom_mdix_enabled</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_phy_iface</span> <span class="p">{</span>
	<span class="n">NoSuchPhy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">I82553AB</span><span class="p">,</span>
	<span class="n">I82553C</span><span class="p">,</span>
	<span class="n">I82503</span><span class="p">,</span>
	<span class="n">DP83840</span><span class="p">,</span>
	<span class="n">S80C240</span><span class="p">,</span>
	<span class="n">S80C24</span><span class="p">,</span>
	<span class="n">I82555</span><span class="p">,</span>
	<span class="n">DP83840A</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_id</span> <span class="p">{</span>
	<span class="n">eeprom_id_wol</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">eeprom_config_asf</span> <span class="p">{</span>
	<span class="n">eeprom_asf</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">eeprom_gcl</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">cb_status</span> <span class="p">{</span>
	<span class="n">cb_complete</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
	<span class="n">cb_ok</span>       <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cb_command - Command Block flags</span>
<span class="cm"> * @cb_tx_nc:  0: controler does CRC (normal),  1: CRC from skb memory</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">cb_command</span> <span class="p">{</span>
	<span class="n">cb_nop</span>    <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="n">cb_iaaddr</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
	<span class="n">cb_config</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>
	<span class="n">cb_multi</span>  <span class="o">=</span> <span class="mh">0x0003</span><span class="p">,</span>
	<span class="n">cb_tx</span>     <span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	<span class="n">cb_ucode</span>  <span class="o">=</span> <span class="mh">0x0005</span><span class="p">,</span>
	<span class="n">cb_dump</span>   <span class="o">=</span> <span class="mh">0x0006</span><span class="p">,</span>
	<span class="n">cb_tx_sf</span>  <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span>
	<span class="n">cb_tx_nc</span>  <span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span>
	<span class="n">cb_cid</span>    <span class="o">=</span> <span class="mh">0x1f00</span><span class="p">,</span>
	<span class="n">cb_i</span>      <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
	<span class="n">cb_s</span>      <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
	<span class="n">cb_el</span>     <span class="o">=</span> <span class="mh">0x8000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rfd</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rbd</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">actual_size</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#if defined(__BIG_ENDIAN_BITFIELD)</span>
<span class="cp">#define X(a,b)	b,a</span>
<span class="cp">#else</span>
<span class="cp">#define X(a,b)	a,b</span>
<span class="cp">#endif</span>
<span class="k">struct</span> <span class="n">config</span> <span class="p">{</span>
<span class="cm">/*0*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">byte_count</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span> <span class="n">pad0</span><span class="o">:</span><span class="mi">2</span><span class="p">);</span>
<span class="cm">/*1*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">rx_fifo_limit</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span> <span class="n">tx_fifo_limit</span><span class="o">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">pad1</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*2*/</span>	<span class="n">u8</span> <span class="n">adaptive_ifs</span><span class="p">;</span>
<span class="cm">/*3*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">mwi_enable</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">type_enable</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">read_align_enable</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">term_write_cache_line:</span><span class="mi">1</span><span class="p">),</span> <span class="n">pad3</span><span class="o">:</span><span class="mi">4</span><span class="p">);</span>
<span class="cm">/*4*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">rx_dma_max_count</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span> <span class="n">pad4</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*5*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">tx_dma_max_count</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span> <span class="n">dma_max_count_enable</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*6*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">late_scb_update</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">direct_rx_dma</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">tno_intr:</span><span class="mi">1</span><span class="p">),</span> <span class="n">cna_intr</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">standard_tcb</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">standard_stat_counter</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="n">rx_save_overruns</span> <span class="o">:</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rx_save_bad_frames</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="cm">/*7*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">rx_discard_short_frames</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">tx_underrun_retry</span><span class="o">:</span><span class="mi">2</span><span class="p">),</span>
	   <span class="nl">pad7:</span><span class="mi">2</span><span class="p">),</span> <span class="n">rx_extended_rfd</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">tx_two_frames_in_fifo</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">tx_dynamic_tbd:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*8*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">mii_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad8</span><span class="o">:</span><span class="mi">6</span><span class="p">),</span> <span class="n">csma_disabled</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*9*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">rx_tcpudp_checksum</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad9</span><span class="o">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">vlan_arp_tco</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">link_status_wake:</span><span class="mi">1</span><span class="p">),</span> <span class="n">arp_wake</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">mcmatch_wake</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*10*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">pad10</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">no_source_addr_insertion</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">preamble_length</span><span class="o">:</span><span class="mi">2</span><span class="p">),</span>
	   <span class="nl">loopback:</span><span class="mi">2</span><span class="p">);</span>
<span class="cm">/*11*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">linear_priority</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">pad11</span><span class="o">:</span><span class="mi">5</span><span class="p">);</span>
<span class="cm">/*12*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">linear_priority_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad12</span><span class="o">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">ifs</span><span class="o">:</span><span class="mi">4</span><span class="p">);</span>
<span class="cm">/*13*/</span>	<span class="n">u8</span> <span class="n">ip_addr_lo</span><span class="p">;</span>
<span class="cm">/*14*/</span>	<span class="n">u8</span> <span class="n">ip_addr_hi</span><span class="p">;</span>
<span class="cm">/*15*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">promiscuous_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">broadcast_disabled</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">wait_after_win:</span><span class="mi">1</span><span class="p">),</span> <span class="n">pad15_1</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">ignore_ul_bit</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">crc_16_bit</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">pad15_2:</span><span class="mi">1</span><span class="p">),</span> <span class="n">crs_or_cdt</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*16*/</span>	<span class="n">u8</span> <span class="n">fc_delay_lo</span><span class="p">;</span>
<span class="cm">/*17*/</span>	<span class="n">u8</span> <span class="n">fc_delay_hi</span><span class="p">;</span>
<span class="cm">/*18*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">rx_stripping</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">tx_padding</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">rx_crc_transfer</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">rx_long_ok:</span><span class="mi">1</span><span class="p">),</span> <span class="n">fc_priority_threshold</span><span class="o">:</span><span class="mi">3</span><span class="p">),</span> <span class="n">pad18</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*19*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">addr_wake</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">magic_packet_disable</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">fc_disable:</span><span class="mi">1</span><span class="p">),</span> <span class="n">fc_restop</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">fc_restart</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">fc_reject</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span>
	   <span class="nl">full_duplex_force:</span><span class="mi">1</span><span class="p">),</span> <span class="n">full_duplex_pin</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*20*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">pad20_1</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span> <span class="n">fc_priority_location</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">multi_ia</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">pad20_2</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span>
<span class="cm">/*21*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">pad21_1</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">multicast_all</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">pad21_2</span><span class="o">:</span><span class="mi">4</span><span class="p">);</span>
<span class="cm">/*22*/</span>	<span class="n">u8</span> <span class="n">X</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="n">rx_d102_mode</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="n">rx_vlan_drop</span><span class="o">:</span><span class="mi">1</span><span class="p">),</span> <span class="n">pad22</span><span class="o">:</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">pad_d102</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define E100_MAX_MULTICAST_ADDRS	64</span>
<span class="k">struct</span> <span class="n">multi</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">E100_MAX_MULTICAST_ADDRS</span> <span class="o">*</span> <span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="mi">2</span><span class="cm">/*pad*/</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Important: keep total struct u32-aligned */</span>
<span class="cp">#define UCODE_SIZE			134</span>
<span class="k">struct</span> <span class="n">cb</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">iaaddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
		<span class="n">__le32</span> <span class="n">ucode</span><span class="p">[</span><span class="n">UCODE_SIZE</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">config</span> <span class="n">config</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">multi</span> <span class="n">multi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tbd_array</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">tcb_byte_count</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">threshold</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">tbd_count</span><span class="p">;</span>
			<span class="k">struct</span> <span class="p">{</span>
				<span class="n">__le32</span> <span class="n">buf_addr</span><span class="p">;</span>
				<span class="n">__le16</span> <span class="n">size</span><span class="p">;</span>
				<span class="n">u16</span> <span class="n">eol</span><span class="p">;</span>
			<span class="p">}</span> <span class="n">tbd</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">tcb</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">dump_buffer_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">loopback</span> <span class="p">{</span>
	<span class="n">lb_none</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lb_mac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lb_phy</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">stats</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">tx_good_frames</span><span class="p">,</span> <span class="n">tx_max_collisions</span><span class="p">,</span> <span class="n">tx_late_collisions</span><span class="p">,</span>
		<span class="n">tx_underruns</span><span class="p">,</span> <span class="n">tx_lost_crs</span><span class="p">,</span> <span class="n">tx_deferred</span><span class="p">,</span> <span class="n">tx_single_collisions</span><span class="p">,</span>
		<span class="n">tx_multiple_collisions</span><span class="p">,</span> <span class="n">tx_total_collisions</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rx_good_frames</span><span class="p">,</span> <span class="n">rx_crc_errors</span><span class="p">,</span> <span class="n">rx_alignment_errors</span><span class="p">,</span>
		<span class="n">rx_resource_errors</span><span class="p">,</span> <span class="n">rx_overrun_errors</span><span class="p">,</span> <span class="n">rx_cdt_errors</span><span class="p">,</span>
		<span class="n">rx_short_frame_errors</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fc_xmt_pause</span><span class="p">,</span> <span class="n">fc_rcv_pause</span><span class="p">,</span> <span class="n">fc_rcv_unsupported</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">xmt_tco_frames</span><span class="p">,</span> <span class="n">rcv_tco_frames</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">complete</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mem</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">signature</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">selftest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dump_buf</span><span class="p">[</span><span class="mi">596</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">param_range</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">params</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="n">rfds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="n">cbs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nic</span> <span class="p">{</span>
	<span class="cm">/* Begin: frequently used values: keep adjacent for cache effect */</span>
	<span class="n">u32</span> <span class="n">msg_enable</span>				<span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="p">(</span><span class="o">*</span><span class="n">mdio_ctrl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rxs</span>				<span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx_to_use</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx_to_clean</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfd</span> <span class="n">blank_rfd</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ru_state</span> <span class="n">ru_running</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">cb_lock</span>			<span class="n">____cacheline_aligned</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">cmd_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">csr</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">csr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">scb_cmd_lo</span> <span class="n">cuc_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cbs_avail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">napi_struct</span> <span class="n">napi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cbs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb_to_use</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb_to_send</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb_to_clean</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">tx_command</span><span class="p">;</span>
	<span class="cm">/* End: frequently used values: keep adjacent for cache effect */</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">ich</span>                <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">promiscuous</span>        <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">multicast_all</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">wol_magic</span>          <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
		<span class="n">ich_10h_workaround</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="p">}</span> <span class="n">flags</span>					<span class="n">____cacheline_aligned</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">mac</span> <span class="n">mac</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">phy</span> <span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">params</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">watchdog</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">tx_timeout_task</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">loopback</span> <span class="n">loopback</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_pool</span> <span class="o">*</span><span class="n">cbs_pool</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cbs_dma_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adaptive_ifs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_threshold</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_frames</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_collisions</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_deferred</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_single_collisions</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_multiple_collisions</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_fc_pause</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_tco_frames</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">rx_fc_pause</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_fc_unsupported</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_tco_frames</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_short_frame_errors</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_over_length_errors</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">eeprom_wc</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">eeprom</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">spinlock_t</span> <span class="n">mdio_lock</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">e100_write_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Flush previous PCI writes through intermediate bridges</span>
<span class="cm">	 * by doing a benign read */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_enable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">irq_mask_none</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_hi</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_disable_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">irq_mask_all</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_hi</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Put CU and RU into idle with a selective reset to get</span>
<span class="cm">	 * device off of PCI bus */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">selective_reset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Now fully reset device */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">software_reset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Mask off our interrupt line - it&#39;s unmasked after reset */</span>
	<span class="n">e100_disable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_self_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem</span><span class="p">,</span> <span class="n">selftest</span><span class="p">);</span>

	<span class="cm">/* Passing the self-test is a pretty good indication</span>
<span class="cm">	 * that the device can DMA to/from host memory */</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">selftest</span><span class="p">.</span><span class="n">signature</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">selftest</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">selftest</span> <span class="o">|</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="cm">/* Wait 10 msec for self-test to complete */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Interrupts are enabled after self-test */</span>
	<span class="n">e100_disable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="cm">/* Check results of self-test */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">selftest</span><span class="p">.</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Self-test failed: result=0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">selftest</span><span class="p">.</span><span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">selftest</span><span class="p">.</span><span class="n">signature</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Self-test failed: timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_eeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd_addr_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Three cmds: write/erase enable, write data, write/erase disable */</span>
	<span class="n">cmd_addr_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_ewen</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cmd_addr_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">op_write</span> <span class="o">&lt;&lt;</span> <span class="n">addr_len</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">cmd_addr_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_ewds</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Bit-bang cmds to write word to eeprom */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Chip select */</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">eecs</span> <span class="o">|</span> <span class="n">eesk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
		<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_addr_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span>
				<span class="n">eecs</span> <span class="o">|</span> <span class="n">eedi</span> <span class="o">:</span> <span class="n">eecs</span><span class="p">;</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
			<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

			<span class="n">iowrite8</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">eesk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
			<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Wait 10 msec for cmd to complete */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="cm">/* Chip deselect */</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
		<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* General technique stolen from the eepro100 driver - very clever */</span>
<span class="k">static</span> <span class="n">__le16</span> <span class="nf">e100_eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">addr_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd_addr_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd_addr_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">op_read</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">addr_len</span><span class="p">)</span> <span class="o">|</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Chip select */</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">eecs</span> <span class="o">|</span> <span class="n">eesk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Bit-bang to read word from eeprom */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_addr_data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="n">eecs</span> <span class="o">|</span> <span class="n">eedi</span> <span class="o">:</span> <span class="n">eecs</span><span class="p">;</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
		<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

		<span class="n">iowrite8</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">eesk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
		<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* Eeprom drives a dummy zero to EEDO after receiving</span>
<span class="cm">		 * complete address.  Use this to adjust addr_len. */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">eedo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">addr_len</span> <span class="o">-=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">eedo</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Chip deselect */</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">eeprom_ctrl_lo</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* Load entire EEPROM image into driver cache and validate checksum */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_eeprom_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Try reading with an 8-bit addr len to discover actual addr len */</span>
	<span class="n">e100_eeprom_read</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">addr_len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">e100_eeprom_read</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_len</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">addr</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* The checksum, stored in the last word, is calculated such that</span>
<span class="cm">	 * the sum of words should be 0xBABA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xBABA</span> <span class="o">-</span> <span class="n">checksum</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;EEPROM corrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eeprom_bad_csum_allow</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Save (portion of) driver EEPROM cache to device and update checksum */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_eeprom_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u16</span> <span class="n">start</span><span class="p">,</span> <span class="n">u16</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr_len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Try reading with an 8-bit addr len to discover actual addr len */</span>
	<span class="n">e100_eeprom_read</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">addr_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">e100_eeprom_write</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">addr</span><span class="p">]);</span>

	<span class="cm">/* The checksum, stored in the last word, is calculated such that</span>
<span class="cm">	 * the sum of words should be 0xBABA */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">addr</span><span class="p">]);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xBABA</span> <span class="o">-</span> <span class="n">checksum</span><span class="p">);</span>
	<span class="n">e100_eeprom_write</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define E100_WAIT_SCB_TIMEOUT 20000 </span><span class="cm">/* we might have to wait 100ms!!! */</span><span class="cp"></span>
<span class="cp">#define E100_WAIT_SCB_FAST 20       </span><span class="cm">/* delay like the old code */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_exec_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Previous command is accepted when SCB clears */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E100_WAIT_SCB_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_lo</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">E100_WAIT_SCB_FAST</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">E100_WAIT_SCB_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">cuc_resume</span><span class="p">))</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">gen_ptr</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_lo</span><span class="p">);</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_exec_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cb_prepare</span><span class="p">)(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_use</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_use</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span><span class="o">--</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">cb_prepare</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Order is important otherwise we&#39;ll be in a race with h/w:</span>
<span class="cm">	 * set S-bit in current first, then clear S-bit in previous. */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_s</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">cb_s</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span> <span class="o">!=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cuc_cmd</span><span class="p">,</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* Ok, here&#39;s where things get sticky.  It&#39;s</span>
<span class="cm">			 * possible that we can&#39;t schedule the command</span>
<span class="cm">			 * because the controller is too busy, so</span>
<span class="cm">			 * let&#39;s just queue the command and try again</span>
<span class="cm">			 * when another command is scheduled. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>request a reset</p></td><td class="code"><div class="highlight"><pre>				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cuc_cmd</span> <span class="o">=</span> <span class="n">cuc_resume</span><span class="p">;</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mdi_read</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mdi_write</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* the standard mdio_ctrl() function for usual MII-compliant hardware */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">mdio_ctrl_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * Stratus87247: we shouldn&#39;t be writing the MDI control</span>
<span class="cm">	 * register until the Ready bit shows True.  Also, since</span>
<span class="cm">	 * manipulation of the MDI control registers is a multi-step</span>
<span class="cm">	 * procedure it should be done under lock.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">mdi_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mdi_ready</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;e100.mdio_ctrl won&#39;t go Ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* No way to indicate timeout error */</span>
	<span class="p">}</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="n">dir</span> <span class="o">|</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">mdi_ctrl</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data_out</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">mdi_ctrl</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mdi_ready</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;%s:addr=%d, reg=%d, data_in=0x%04X, data_out=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">dir</span> <span class="o">==</span> <span class="n">mdi_read</span> <span class="o">?</span> <span class="s">&quot;READ&quot;</span> <span class="o">:</span> <span class="s">&quot;WRITE&quot;</span><span class="p">,</span>
		     <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_out</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">data_out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* slightly tweaked mdio_ctrl() function for phy_82552_v specifics */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">mdio_ctrl_phy_82552_v</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">==</span> <span class="n">MII_BMCR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">mdi_write</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BMCR_ANRESTART</span> <span class="o">|</span> <span class="n">BMCR_ANENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">advert</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
							<span class="n">MII_ADVERTISE</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Workaround Si issue where sometimes the part will not</span>
<span class="cm">			 * autoneg to 100Mbps even when advertised.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span> <span class="o">|</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">advert</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100HALF</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mdio_ctrl_hw</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Fully software-emulated mdio_ctrl() function for cards without</span>
<span class="cm"> * MII-compliant PHYs.</span>
<span class="cm"> * For now, this is mainly geared towards 80c24 support; in case of further</span>
<span class="cm"> * requirements for other types (i82503, ...?) either extend this mechanism</span>
<span class="cm"> * or split it, whichever is cleaner.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">mdio_ctrl_phy_mii_emulated</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* might need to allocate a netdev_priv&#39;ed register array eventually</span>
<span class="cm">	 * to be able to record state changes, but for now</span>
<span class="cm">	 * some fully hardcoded register handling ought to be ok I guess. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">mdi_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MII_BMCR</span>:
			<span class="cm">/* Auto-negotiation, right? */</span>
			<span class="k">return</span>  <span class="n">BMCR_ANENABLE</span> <span class="o">|</span>
				<span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MII_BMSR</span>:
			<span class="k">return</span>	<span class="n">BMSR_LSTATUS</span> <span class="cm">/* for mii_link_ok() */</span> <span class="o">|</span>
				<span class="n">BMSR_ANEGCAPABLE</span> <span class="o">|</span>
				<span class="n">BMSR_10FULL</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MII_ADVERTISE</span>:
			<span class="cm">/* 80c24 is a &quot;combo card&quot; PHY, right? */</span>
			<span class="k">return</span>	<span class="n">ADVERTISE_10HALF</span> <span class="o">|</span>
				<span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				     <span class="s">&quot;%s:addr=%d, reg=%d, data=0x%04X: unimplemented emulation!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dir</span> <span class="o">==</span> <span class="n">mdi_read</span> <span class="o">?</span> <span class="s">&quot;READ&quot;</span> <span class="o">:</span> <span class="s">&quot;WRITE&quot;</span><span class="p">,</span>
				     <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				     <span class="s">&quot;%s:addr=%d, reg=%d, data=0x%04X: unimplemented emulation!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">dir</span> <span class="o">==</span> <span class="n">mdi_read</span> <span class="o">?</span> <span class="s">&quot;READ&quot;</span> <span class="o">:</span> <span class="s">&quot;WRITE&quot;</span><span class="p">,</span>
				     <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">e100_phy_supports_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* for now, just check it by comparing whether we</span>
<span class="cm">	   are using MII software emulation.</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">!=</span> <span class="n">mdio_ctrl_phy_mii_emulated</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="n">rfds</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">256</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="n">cbs</span>  <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">128</span> <span class="p">};</span>

	<span class="cm">/* MAC type is encoded as rev ID; exception: ICH is treated as 82559 */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ich</span><span class="p">)</span> <span class="o">?</span> <span class="n">mac_82559_D101M</span> <span class="o">:</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">==</span> <span class="n">mac_unknown</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">=</span> <span class="n">mac_82557_D100_A</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rfds</span> <span class="o">=</span> <span class="n">rfds</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="n">cbs</span><span class="p">;</span>

	<span class="cm">/* Quadwords to DMA into FIFO before starting frame transmit */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_threshold</span> <span class="o">=</span> <span class="mh">0xE0</span><span class="p">;</span>

	<span class="cm">/* no interrupt for every tx completion, delay = 256us if not 557 */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_tx</span> <span class="o">|</span> <span class="n">cb_tx_sf</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span> <span class="o">?</span> <span class="n">cb_cid</span> <span class="o">:</span> <span class="n">cb_i</span><span class="p">));</span>

	<span class="cm">/* Template for a freshly allocated RFD */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">blank_rfd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">blank_rfd</span><span class="p">.</span><span class="n">rbd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">blank_rfd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">VLAN_ETH_FRAME_LEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">);</span>

	<span class="cm">/* MII setup */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">mdio_write</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_config</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config</span><span class="p">));</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>		<span class="cm">/* bytes in this struct */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_fifo_limit</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>		<span class="cm">/* bytes in FIFO before DMA */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">direct_rx_dma</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* reserved */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">standard_tcb</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* 1=standard, 0=extended */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">standard_stat_counter</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=standard, 0=extended */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_discard_short_frames</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=discard, 0=pass */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_underrun_retry</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>	<span class="cm">/* # of underrun retries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e100_phy_supports_mii</span><span class="p">(</span><span class="n">nic</span><span class="p">))</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">mii_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>           <span class="cm">/* 1=MII mode, 0=i82503 mode */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">pad10</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">no_source_addr_insertion</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=no, 0=yes */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">preamble_length</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>		<span class="cm">/* 0=1, 1=3, 2=7, 3=15 bytes */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">ifs</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>			<span class="cm">/* x16 = inter frame spacing */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">ip_addr_hi</span> <span class="o">=</span> <span class="mh">0xF2</span><span class="p">;</span>		<span class="cm">/* ARP IP filter - not used */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">pad15_1</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">pad15_2</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">crs_or_cdt</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>		<span class="cm">/* 0=CRS only, 1=CRS or CDT */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">fc_delay_hi</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>		<span class="cm">/* time delay for fc frame */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">tx_padding</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* 1=pad short frames */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">fc_priority_threshold</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>	<span class="cm">/* 7=priority fc disabled */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">pad18</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">full_duplex_pin</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* 1=examine FDX# pin */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">pad20_1</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">fc_priority_location</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=byte#31, 0=byte#19 */</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">pad21_1</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>

	<span class="n">config</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span><span class="p">;</span>
	<span class="n">config</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">&amp;&amp;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">full_duplex</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">full_duplex_force</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=force, 0=auto */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">promiscuous</span> <span class="o">||</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_save_bad_frames</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=save, 0=discard */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_discard_short_frames</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* 1=discard, 0=save */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">promiscuous_mode</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* 1=on, 0=off */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXFCS</span><span class="p">))</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_crc_transfer</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=save, 0=discard */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">multicast_all</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">multicast_all</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* 1=accept, 0=no */</span>

	<span class="cm">/* disable WoL when up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">wol_magic</span><span class="p">))</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">magic_packet_disable</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=off, 0=on */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">fc_disable</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=Tx fc off, 0=Tx fc on */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">mwi_enable</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=enable, 0=disable */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">standard_tcb</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>	<span class="cm">/* 1=standard, 0=extended */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_long_ok</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* 1=VLANs ok, 0=standard */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82559_D101M</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">tno_intr</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>		<span class="cm">/* TCO stats enable */</span>
			<span class="cm">/* Enable TCO in extended config */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82551_10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* extended bytes */</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_d102_mode</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* GMRC for TCO */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">standard_stat_counter</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_save_overruns</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* 1=save, 0=discard */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_save_bad_frames</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>       <span class="cm">/* 1=save, 0=discard */</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">rx_discard_short_frames</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>  <span class="cm">/* 1=discard, 0=save */</span>
	<span class="p">}</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;[00-07]=%02X:%02X:%02X:%02X:%02X:%02X:%02X:%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;[08-15]=%02X:%02X:%02X:%02X:%02X:%02X:%02X:%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">c</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;[16-23]=%02X:%02X:%02X:%02X:%02X:%02X:%02X:%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">c</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">23</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm">*  CPUSaver parameters</span>
<span class="cm">*</span>
<span class="cm">*  All CPUSaver parameters are 16-bit literals that are part of a</span>
<span class="cm">*  &quot;move immediate value&quot; instruction.  By changing the value of</span>
<span class="cm">*  the literal in the instruction before the code is loaded, the</span>
<span class="cm">*  driver can change the algorithm.</span>
<span class="cm">*</span>
<span class="cm">*  INTDELAY - This loads the dead-man timer with its initial value.</span>
<span class="cm">*    When this timer expires the interrupt is asserted, and the</span>
<span class="cm">*    timer is reset each time a new packet is received.  (see</span>
<span class="cm">*    BUNDLEMAX below to set the limit on number of chained packets)</span>
<span class="cm">*    The current default is 0x600 or 1536.  Experiments show that</span>
<span class="cm">*    the value should probably stay within the 0x200 - 0x1000.</span>
<span class="cm">*</span>
<span class="cm">*  BUNDLEMAX -</span>
<span class="cm">*    This sets the maximum number of frames that will be bundled.  In</span>
<span class="cm">*    some situations, such as the TCP windowing algorithm, it may be</span>
<span class="cm">*    better to limit the growth of the bundle size than let it go as</span>
<span class="cm">*    high as it can, because that could cause too much added latency.</span>
<span class="cm">*    The default is six, because this is the number of packets in the</span>
<span class="cm">*    default TCP window size.  A value of 1 would make CPUSaver indicate</span>
<span class="cm">*    an interrupt for every frame received.  If you do not want to put</span>
<span class="cm">*    a limit on the bundle size, set this value to xFFFF.</span>
<span class="cm">*</span>
<span class="cm">*  BUNDLESMALL -</span>
<span class="cm">*    This contains a bit-mask describing the minimum size frame that</span>
<span class="cm">*    will be bundled.  The default masks the lower 7 bits, which means</span>
<span class="cm">*    that any frame less than 128 bytes in length will not be bundled,</span>
<span class="cm">*    but will instead immediately generate an interrupt.  This does</span>
<span class="cm">*    not affect the current bundle in any way.  Any frame that is 128</span>
<span class="cm">*    bytes or large will be bundled normally.  This feature is meant</span>
<span class="cm">*    to provide immediate indication of ACK frames in a TCP environment.</span>
<span class="cm">*    Customers were seeing poor performance when a machine with CPUSaver</span>
<span class="cm">*    enabled was sending but not receiving.  The delay introduced when</span>
<span class="cm">*    the ACKs were received was enough to reduce total throughput, because</span>
<span class="cm">*    the sender would sit idle until the ACK was finally seen.</span>
<span class="cm">*</span>
<span class="cm">*    The current default is 0xFF80, which masks out the lower 7 bits.</span>
<span class="cm">*    This means that any frame which is x7F (127) bytes or smaller</span>
<span class="cm">*    will cause an immediate interrupt.  Because this value must be a</span>
<span class="cm">*    bit mask, there are only a few valid values that can be used.  To</span>
<span class="cm">*    turn this feature off, the driver can write the value xFFFF to the</span>
<span class="cm">*    lower word of this instruction (in the same way that the other</span>
<span class="cm">*    parameters are used).  Likewise, a value of 0xF800 (2047) would</span>
<span class="cm">*    cause an interrupt to be generated for every frame, because all</span>
<span class="cm">*    standard Ethernet frames are &lt;= 2047 bytes in length.</span>
<span class="cm">*************************************************************************/</span>

<span class="cm">/* if you wish to disable the ucode functionality, while maintaining the</span>
<span class="cm"> * workarounds it provides, set the following defines to:</span>
<span class="cm"> * BUNDLESMALL 0</span>
<span class="cm"> * BUNDLEMAX 1</span>
<span class="cm"> * INTDELAY 1</span>
<span class="cm"> */</span>
<span class="cp">#define BUNDLESMALL 1</span>
<span class="cp">#define BUNDLEMAX (u16)6</span>
<span class="cp">#define INTDELAY (u16)1536 </span><span class="cm">/* 0x600 */</span><span class="cp"></span>

<span class="cm">/* Initialize firmware */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="nf">e100_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">timer</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">min_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* do not load u-code for ICH devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ich</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Search for ucode match against h/w revision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">==</span> <span class="n">mac_82559_D101M</span><span class="p">)</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_D101M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">==</span> <span class="n">mac_82559_D101S</span><span class="p">)</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_D101S</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">==</span> <span class="n">mac_82551_F</span> <span class="o">||</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">==</span> <span class="n">mac_82551_10</span><span class="p">)</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_D102E</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* No ucode on other devices */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If the firmware has not previously been loaded, request a pointer</span>
<span class="cm">	 * to it. If it was previously loaded, we are reinitializing the</span>
<span class="cm">	 * adapter, possibly in a resume from hibernate, in which case</span>
<span class="cm">	 * request_firmware() cannot be used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fw_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Firmware should be precisely UCODE_SIZE (words) plus three bytes</span>
<span class="cm">	   indicating the offsets for BUNDLESMALL, BUNDLEMAX, INTDELAY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> has wrong size %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fw_name</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Read timer, bundle and min_size from end of firmware blob */</span>
	<span class="n">timer</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">bundle</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">min_size</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&gt;=</span> <span class="n">UCODE_SIZE</span> <span class="o">||</span> <span class="n">bundle</span> <span class="o">&gt;=</span> <span class="n">UCODE_SIZE</span> <span class="o">||</span>
	    <span class="n">min_size</span> <span class="o">&gt;=</span> <span class="n">UCODE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> has bogus offset values (0x%x,0x%x,0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fw_name</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">min_size</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* OK, firmware is validated and ready to use. Save a pointer</span>
<span class="cm">	 * to it in the nic */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fw</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_setup_ucode</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">timer</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">min_size</span><span class="p">;</span>

	<span class="cm">/* It&#39;s not a real skb; we just abused the fact that e100_exec_cb</span>
<span class="cm">	   will pass it through to here... */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* firmware is stored as little endian already */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Read timer, bundle and min_size from end of firmware blob */</span>
	<span class="n">timer</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">bundle</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">min_size</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">UCODE_SIZE</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Insert user-tunable settings in cb-&gt;u.ucode */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFFFF0000</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">INTDELAY</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">[</span><span class="n">bundle</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFFFF0000</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">[</span><span class="n">bundle</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BUNDLEMAX</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">[</span><span class="n">min_size</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xFFFF0000</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ucode</span><span class="p">[</span><span class="n">min_size</span><span class="p">]</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">BUNDLESMALL</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xFFFF</span> <span class="o">:</span> <span class="mh">0xFF80</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_ucode</span> <span class="o">|</span> <span class="n">cb_el</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">e100_load_ucode_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span><span class="p">;</span>

	<span class="n">fw</span> <span class="o">=</span> <span class="n">e100_request_firmware</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="cm">/* If it&#39;s NULL, then no ucode is required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">fw</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="p">,</span> <span class="n">e100_setup_ucode</span><span class="p">)))</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;ucode cmd failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* must restart cuc */</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cuc_cmd</span> <span class="o">=</span> <span class="n">cuc_start</span><span class="p">;</span>

	<span class="cm">/* wait for completion */</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* wait for possibly (ouch) 500ms */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_complete</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">counter</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ack any interrupts, something could have been set */</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">stat_ack</span><span class="p">);</span>

	<span class="cm">/* if the command failed, or is not OK, notify and return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">counter</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_ok</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;ucode load failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_setup_iaaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_iaaddr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">iaaddr</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_dump</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">dump_buffer_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">+</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem</span><span class="p">,</span> <span class="n">dump_buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_phy_check_without_mii</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">phy_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">without_mii</span><span class="p">;</span>

	<span class="n">phy_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom_phy_iface</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NoSuchPhy</span>: <span class="cm">/* Non-MII PHY; UNTESTED! */</span>
	<span class="k">case</span> <span class="n">I82503</span>: <span class="cm">/* Non-MII PHY; UNTESTED! */</span>
	<span class="k">case</span> <span class="n">S80C24</span>: <span class="cm">/* Non-MII PHY; tested and working */</span>
		<span class="cm">/* paragraph from the FreeBSD driver, &quot;FXP_PHY_80C24&quot;:</span>
<span class="cm">		 * The Seeq 80c24 AutoDUPLEX(tm) Ethernet Interface Adapter</span>
<span class="cm">		 * doesn&#39;t have a programming interface of any sort.  The</span>
<span class="cm">		 * media is sensed automatically based on how the link partner</span>
<span class="cm">		 * is configured.  This is, in essence, manual configuration.</span>
<span class="cm">		 */</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="s">&quot;found MII-less i82503 or 80c24 or other PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">=</span> <span class="n">mdio_ctrl_phy_mii_emulated</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* is this ok for an MII-less PHY? */</span>

		<span class="cm">/* these might be needed for certain MII-less cards...</span>
<span class="cm">		 * nic-&gt;flags |= ich;</span>
<span class="cm">		 * nic-&gt;flags |= ich_10h_workaround; */</span>

		<span class="n">without_mii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">without_mii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">without_mii</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NCONFIG_AUTO_SWITCH	0x0080</span>
<span class="cp">#define MII_NSC_CONG		MII_RESV1</span>
<span class="cp">#define NSC_CONG_ENABLE		0x0100</span>
<span class="cp">#define NSC_CONG_TXREADY	0x0400</span>
<span class="cp">#define ADVERTISE_FC_SUPPORTED	0x0400</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmcr</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">id_lo</span><span class="p">,</span> <span class="n">id_hi</span><span class="p">,</span> <span class="n">cong</span><span class="p">;</span>

	<span class="cm">/* Discover phy addr by searching addrs in order {1,0,2,..., 31} */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">bmcr</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bmcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* uhoh, no PHY detected: check whether we seem to be some</span>
<span class="cm">		 * weird, rare variant which is *known* to not have any MII.</span>
<span class="cm">		 * But do this AFTER MII checking only, since this does</span>
<span class="cm">		 * lookup of EEPROM values which may easily be unreliable. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e100_phy_check_without_mii</span><span class="p">(</span><span class="n">nic</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* simply return and hope for the best */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* for unknown cases log a fatal error */</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="s">&quot;Failed to locate any known PHY, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="s">&quot;phy_addr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">);</span>

	<span class="cm">/* Get phy ID */</span>
	<span class="n">id_lo</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
	<span class="n">id_hi</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">id_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">id_lo</span><span class="p">;</span>
	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;phy ID = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* Select the phy and isolate the rest */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_ISOLATE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">!=</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
			<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
				<span class="n">bmcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BMCR_ISOLATE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Workaround for 82552:</span>
<span class="cm">	 * Clear the ISOLATE bit on selected phy_id last (mirrored on all</span>
<span class="cm">	 * other phy_id&#39;s) using bmcr value from addr discovery loop above.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
			<span class="n">bmcr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BMCR_ISOLATE</span><span class="p">);</span>

	<span class="cm">/* Handle National tx phys */</span>
<span class="cp">#define NCS_PHY_MODEL_MASK	0xFFF0FFFF</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;</span> <span class="n">NCS_PHY_MODEL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">phy_nsc_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable congestion control */</span>
		<span class="n">cong</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_NSC_CONG</span><span class="p">);</span>
		<span class="n">cong</span> <span class="o">|=</span> <span class="n">NSC_CONG_TXREADY</span><span class="p">;</span>
		<span class="n">cong</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NSC_CONG_ENABLE</span><span class="p">;</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_NSC_CONG</span><span class="p">,</span> <span class="n">cong</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">advert</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>

		<span class="cm">/* assign special tweaked mdio_ctrl() function */</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">=</span> <span class="n">mdio_ctrl_phy_82552_v</span><span class="p">;</span>

		<span class="cm">/* Workaround Si not advertising flow-control during autoneg */</span>
		<span class="n">advert</span> <span class="o">|=</span> <span class="n">ADVERTISE_PAUSE_CAP</span> <span class="o">|</span> <span class="n">ADVERTISE_PAUSE_ASYM</span><span class="p">;</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">advert</span><span class="p">);</span>

		<span class="cm">/* Reset for the above changes to take effect */</span>
		<span class="n">bmcr</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
		<span class="n">bmcr</span> <span class="o">|=</span> <span class="n">BMCR_RESET</span><span class="p">;</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">bmcr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82550_D102</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ich</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_TPISTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom_cnfg_mdix</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">eeprom_mdix_enabled</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* enable/disable MDI/MDI-X auto-switching. */</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_NCONFIG</span><span class="p">,</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">force_media</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">NCONFIG_AUTO_SWITCH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e100_hw_reset</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;e100_hw_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_self_test</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_phy_init</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">cuc_load_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ruc_load_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_load_ucode_wait</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_configure</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_setup_iaaddr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">cuc_dump_addr</span><span class="p">,</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem</span><span class="p">,</span> <span class="n">stats</span><span class="p">))))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">cuc_dump_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">e100_disable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">E100_MAX_MULTICAST_ADDRS</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_multi</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">multi</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">multi</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;mc_count=%d, flags=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">promiscuous</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">promiscuous</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span> <span class="o">||</span>
		<span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">E100_MAX_MULTICAST_ADDRS</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">multicast_all</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">multicast_all</span><span class="p">;</span>

	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_configure</span><span class="p">);</span>
	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_multi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ns</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stats</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">complete</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&lt;</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fc_xmt_pause</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&lt;</span> <span class="n">mac_82559_D101M</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">xmt_tco_frames</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">;</span>

	<span class="cm">/* Device&#39;s stats reporting may take several microseconds to</span>
<span class="cm">	 * complete, so we&#39;re always waiting for results of the</span>
<span class="cm">	 * previous command. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">complete</span> <span class="o">==</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cuc_dump_reset_complete</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_good_frames</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_collisions</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_total_collisions</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_aborted_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_max_collisions</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_window_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_late_collisions</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_carrier_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_lost_crs</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_fifo_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_underruns</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">+=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_collisions</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">tx_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_max_collisions</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_lost_crs</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_short_frame_errors</span> <span class="o">+=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_short_frame_errors</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_short_frame_errors</span> <span class="o">+</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_over_length_errors</span><span class="p">;</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_alignment_errors</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_overrun_errors</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_overrun_errors</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_missed_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_resource_errors</span><span class="p">);</span>
		<span class="n">ns</span><span class="o">-&gt;</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_alignment_errors</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_short_frame_errors</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rx_cdt_errors</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_deferred</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_deferred</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_single_collisions</span> <span class="o">+=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_single_collisions</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_multiple_collisions</span> <span class="o">+=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_multiple_collisions</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_fc_pause</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fc_xmt_pause</span><span class="p">);</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_fc_pause</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fc_rcv_pause</span><span class="p">);</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_fc_unsupported</span> <span class="o">+=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fc_rcv_unsupported</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82559_D101M</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_tco_frames</span> <span class="o">+=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">xmt_tco_frames</span><span class="p">);</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_tco_frames</span> <span class="o">+=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rcv_tco_frames</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">cuc_dump_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="s">&quot;exec cuc_dump_reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_adjust_adaptive_ifs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Adjust inter-frame-spacing (IFS) between two transmits if</span>
<span class="cm">	 * we&#39;re getting collisions on a half-duplex connection. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">min_frames</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span> <span class="mi">100</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">&lt;</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_collisions</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">&gt;</span> <span class="n">min_frames</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_frames</span> <span class="o">&lt;</span> <span class="n">min_frames</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">!=</span> <span class="n">prev</span><span class="p">)</span>
			<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_configure</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ETHTOOL_GSET</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;right now = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/* mii library handles link maintenance tasks */</span>

	<span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">ethtool_cmd_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;NIC Link is Up %u Mbps %s Duplex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_100</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
			    <span class="n">cmd</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span> <span class="o">?</span> <span class="s">&quot;Full&quot;</span> <span class="o">:</span> <span class="s">&quot;Half&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;NIC Link is Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mii_check_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>

	<span class="cm">/* Software generated interrupt to recover from (rare) Rx</span>
<span class="cm">	 * allocation failure.</span>
<span class="cm">	 * Unfortunately have to use a spinlock to not re-enable interrupts</span>
<span class="cm">	 * accidentally, due to hardware that shares a register between the</span>
<span class="cm">	 * interrupt mask bit and the SW Interrupt generation bit */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_hi</span><span class="p">)</span> <span class="o">|</span> <span class="n">irq_sw_gen</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_hi</span><span class="p">);</span>
	<span class="n">e100_write_flush</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>

	<span class="n">e100_update_stats</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">e100_adjust_adaptive_ifs</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">duplex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&lt;=</span> <span class="n">mac_82557_D100_C</span><span class="p">)</span>
		<span class="cm">/* Issue a multicast command to workaround a 557 lock up */</span>
		<span class="n">e100_set_multicast_list</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ich</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span><span class="p">)</span>
		<span class="cm">/* Need SW workaround for ICH[x] 10Mbps/half duplex Tx hang. */</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ich_10h_workaround</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ich_10h_workaround</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span>
		  <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="n">E100_WATCHDOG_PERIOD</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_xmit_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_command</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the last 4 bytes of the SKB payload packet as the CRC, used for</span>
<span class="cm">	 * testing, ie sending frames with bad CRC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">no_fcs</span><span class="p">))</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">cb_tx_nc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__constant_cpu_to_le16</span><span class="p">(</span><span class="n">cb_tx_nc</span><span class="p">);</span>

	<span class="cm">/* interrupt every 16 packets regardless of delay */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span><span class="p">)</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_i</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd_array</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tcb_byte_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_threshold</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">.</span><span class="n">buf_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
	<span class="cm">/* check for mapping failure? */</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">skb_tx_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">e100_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ich_10h_workaround</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SW workaround for ICH[x] 10Mbps/half duplex Tx hang.</span>
<span class="cm">		   Issue a NOP command followed by a 1us delay before</span>
<span class="cm">		   issuing the Tx command. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">cuc_nop</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				     <span class="s">&quot;exec cuc_nop failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">e100_xmit_prepare</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOSPC</span>:
		<span class="cm">/* We queued the skb, but now we&#39;re out of space. */</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="s">&quot;No space for CB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="cm">/* This is a hard error - log it. */</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="s">&quot;Out of Tx resources, returning skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_tx_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_cleaned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>

	<span class="cm">/* Clean CBs marked complete */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cb</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span><span class="p">;</span>
	    <span class="n">cb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_complete</span><span class="p">);</span>
	    <span class="n">cb</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmb</span><span class="p">();</span> <span class="cm">/* read skb after status */</span>
		<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">tx_done</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="s">&quot;cb[%d]-&gt;status = 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">int</span><span class="p">)(((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">cb</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb</span><span class="p">)),</span>
			     <span class="n">cb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">.</span><span class="n">buf_addr</span><span class="p">),</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">.</span><span class="n">size</span><span class="p">),</span>
				<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">tx_cleaned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>

	<span class="cm">/* Recover from running out of Tx resources in xmit_frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_cleaned</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tx_cleaned</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_clean_cbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span> <span class="o">!=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cbs</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">.</span><span class="n">buf_addr</span><span class="p">),</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">tcb</span><span class="p">.</span><span class="n">tbd</span><span class="p">.</span><span class="n">size</span><span class="p">),</span>
					<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_pool</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_dma_addr</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cuc_cmd</span> <span class="o">=</span> <span class="n">cuc_start</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_use</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span> <span class="o">=</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_alloc_cbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cb</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cbs</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cuc_cmd</span> <span class="o">=</span> <span class="n">cuc_start</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_use</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">cb</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">?</span> <span class="n">cb</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">;</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">cb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_dma_addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb</span><span class="p">);</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_dma_addr</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_use</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_send</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_to_clean</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_avail</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">e100_start_receiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RU_SUSPENDED</span> <span class="o">!=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="cm">/* handle init time starts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx</span><span class="p">)</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">;</span>

	<span class="cm">/* (Re)start RU if suspended or idle and RFA is non-NULL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e100_exec_cmd</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ruc_start</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define RFD_BUF_LEN (sizeof(struct rfd) + VLAN_ETH_FRAME_LEN + ETH_FCS_LEN)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_rx_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">RFD_BUF_LEN</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Init, and map the RFD. */</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">blank_rfd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">));</span>
	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		<span class="n">RFD_BUF_LEN</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Link the RFD to end of RFA by linking previous RFD to</span>
<span class="cm">	 * this one.  We are safe to touch the previous RFD because</span>
<span class="cm">	 * it is protected by the before last buffer&#39;s el bit being set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="n">prev_rfd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prev_rfd</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_rx_indicate</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">work_done</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="n">rfd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rfd_status</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fcs_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">work_done</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">work_to_do</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* Need to sync before taking a peek at cb_complete bit */</span>
	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">rfd_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;status=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfd_status</span><span class="p">);</span>
	<span class="n">rmb</span><span class="p">();</span> <span class="cm">/* read size after status bit */</span>

	<span class="cm">/* If data isn&#39;t ready, nothing to indicate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rfd_status</span> <span class="o">&amp;</span> <span class="n">cb_complete</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* If the next buffer has the el bit, but we think the receiver</span>
<span class="cm">		 * is still running, check to see if it really stopped while</span>
<span class="cm">		 * we had interrupts off.</span>
<span class="cm">		 * This allows for a fast restart without re-enabling</span>
<span class="cm">		 * interrupts */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cb_el</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">RU_RUNNING</span> <span class="o">==</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span><span class="p">))</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rus_no_res</span><span class="p">)</span>
				<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_SUSPENDED</span><span class="p">;</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span>
					       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get actual data size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXFCS</span><span class="p">))</span>
		<span class="n">fcs_pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">actual_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">actual_size</span> <span class="o">&gt;</span> <span class="n">RFD_BUF_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">)))</span>
		<span class="n">actual_size</span> <span class="o">=</span> <span class="n">RFD_BUF_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">);</span>

	<span class="cm">/* Get data */</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
		<span class="n">RFD_BUF_LEN</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="cm">/* If this buffer has the el bit, but we think the receiver</span>
<span class="cm">	 * is still running, check to see if it really stopped while</span>
<span class="cm">	 * we had interrupts off.</span>
<span class="cm">	 * This allows for a fast restart without re-enabling interrupts.</span>
<span class="cm">	 * This can happen when the RU sees the size change but also sees</span>
<span class="cm">	 * the el bit set. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rfd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cb_el</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">RU_RUNNING</span> <span class="o">==</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span><span class="p">))</span> <span class="p">{</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rus_no_res</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_SUSPENDED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pull off the RFD and put the actual data (minus eth hdr) */</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">));</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">actual_size</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* If we are receiving all frames, then don&#39;t bother</span>
<span class="cm">	 * checking for errors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXALL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">actual_size</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span> <span class="o">+</span> <span class="n">VLAN_ETH_HLEN</span> <span class="o">+</span> <span class="n">fcs_pad</span><span class="p">)</span>
			<span class="cm">/* Received oversized frame, but keep it. */</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_over_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">process_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rfd_status</span> <span class="o">&amp;</span> <span class="n">cb_ok</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t indicate if hardware indicates errors */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">actual_size</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span> <span class="o">+</span> <span class="n">VLAN_ETH_HLEN</span> <span class="o">+</span> <span class="n">fcs_pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t indicate oversized frames */</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_over_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">process_skb:</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">actual_size</span> <span class="o">-</span> <span class="n">fcs_pad</span><span class="p">);</span>
		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">work_done</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_rx_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">work_done</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">old_before_last_rx</span><span class="p">,</span> <span class="o">*</span><span class="n">new_before_last_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="n">old_before_last_rfd</span><span class="p">,</span> <span class="o">*</span><span class="n">new_before_last_rfd</span><span class="p">;</span>

	<span class="cm">/* Indicate newly arrived packets */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span><span class="p">;</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">e100_rx_indicate</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">work_done</span><span class="p">,</span> <span class="n">work_to_do</span><span class="p">);</span>
		<span class="cm">/* Hit quota or no more to clean */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span> <span class="o">==</span> <span class="n">err</span> <span class="o">||</span> <span class="o">-</span><span class="n">ENODATA</span> <span class="o">==</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* On EAGAIN, hit quota so have more work to do, restart once</span>
<span class="cm">	 * cleanup is complete.</span>
<span class="cm">	 * Else, are we already rnr? then pay attention!!! this ensures that</span>
<span class="cm">	 * the state machine progression never allows a start with a</span>
<span class="cm">	 * partially cleaned list, avoiding a race between hardware</span>
<span class="cm">	 * and rx_to_clean when in NAPI mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span> <span class="o">!=</span> <span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">RU_SUSPENDED</span> <span class="o">==</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span><span class="p">)</span>
		<span class="n">restart_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">old_before_last_rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">old_before_last_rfd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="p">)</span><span class="n">old_before_last_rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Alloc new skbs to refill list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span><span class="p">;</span> <span class="o">!</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">e100_rx_alloc_skb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">rx</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Better luck next time (see watchdog) */</span>
	<span class="p">}</span>

	<span class="n">new_before_last_rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_before_last_rx</span> <span class="o">!=</span> <span class="n">old_before_last_rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the el-bit on the buffer that is before the last buffer.</span>
<span class="cm">		 * This lets us update the next pointer on the last buffer</span>
<span class="cm">		 * without worrying about hardware touching it.</span>
<span class="cm">		 * We set the size to 0 to prevent hardware from touching this</span>
<span class="cm">		 * buffer.</span>
<span class="cm">		 * When the hardware hits the before last buffer with el-bit</span>
<span class="cm">		 * and size of 0, it will RNR interrupt, the RUS will go into</span>
<span class="cm">		 * the No Resources state.  It will not complete nor write to</span>
<span class="cm">		 * this buffer. */</span>
		<span class="n">new_before_last_rfd</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="p">)</span><span class="n">new_before_last_rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">new_before_last_rfd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">new_before_last_rfd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_el</span><span class="p">);</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">new_before_last_rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span>
			<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

		<span class="cm">/* Now that we have a new stopping point, we can clear the old</span>
<span class="cm">		 * stopping point.  We must sync twice to get the proper</span>
<span class="cm">		 * ordering on the hardware side of things. */</span>
		<span class="n">old_before_last_rfd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_el</span><span class="p">);</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">old_before_last_rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span>
			<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="n">old_before_last_rfd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">VLAN_ETH_FRAME_LEN</span>
							<span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">);</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">old_before_last_rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span>
			<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart_required</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>ack the rnr?</p></td><td class="code"><div class="highlight"><pre>		<span class="n">iowrite8</span><span class="p">(</span><span class="n">stat_ack_rnr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">stat_ack</span><span class="p">);</span>
		<span class="n">e100_start_receiver</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">work_done</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_rx_clean_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rfds</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_UNINITIALIZED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">rx</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
					<span class="n">RFD_BUF_LEN</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_rx_alloc_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rx</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rfds</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="n">before_last</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_UNINITIALIZED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">rx</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">?</span> <span class="n">rx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">;</span>
		<span class="n">rx</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">rx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e100_rx_alloc_skb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">rx</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">e100_rx_clean_list</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Set the el-bit on the buffer that is before the last buffer.</span>
<span class="cm">	 * This lets us update the next pointer on the last buffer without</span>
<span class="cm">	 * worrying about hardware touching it.</span>
<span class="cm">	 * We set the size to 0 to prevent hardware from touching this buffer.</span>
<span class="cm">	 * When the hardware hits the before last buffer with el-bit and size</span>
<span class="cm">	 * of 0, it will RNR interrupt, the RU will go into the No Resources</span>
<span class="cm">	 * state.  It will not complete nor write to this buffer. */</span>
	<span class="n">rx</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">before_last</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span> <span class="o">*</span><span class="p">)</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">before_last</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cb_el</span><span class="p">);</span>
	<span class="n">before_last</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rx</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_use</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_SUSPENDED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">e100_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">stat_ack</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">stat_ack</span><span class="p">);</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;stat_ack = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat_ack</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat_ack</span> <span class="o">==</span> <span class="n">stat_ack_not_ours</span> <span class="o">||</span>	<span class="cm">/* Not our interrupt */</span>
	   <span class="n">stat_ack</span> <span class="o">==</span> <span class="n">stat_ack_not_present</span><span class="p">)</span>	<span class="cm">/* Hardware is ejected */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* Ack interrupt(s) */</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">stat_ack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">stat_ack</span><span class="p">);</span>

	<span class="cm">/* We hit Receive No Resource (RNR); restart RU after cleaning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_ack</span> <span class="o">&amp;</span> <span class="n">stat_ack_rnr</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">ru_running</span> <span class="o">=</span> <span class="n">RU_SUSPENDED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">e100_disable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nic</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e100_rx_clean</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_done</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>
	<span class="n">e100_tx_clean</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="cm">/* If budget not fully consumed, exit the polling mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="n">e100_enable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">e100_disable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">e100_intr</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">e100_tx_clean</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">e100_enable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_setup_iaaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span> <span class="o">||</span> <span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="n">ETH_DATA_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_asf</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ASF can be enabled from eeprom */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="mh">0x1050</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&lt;=</span> <span class="mh">0x1057</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom_config_asf</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">eeprom_asf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom_config_asf</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">eeprom_gcl</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom_smbus_addr</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_rx_alloc_list</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_alloc_cbs</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_rx_clean_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_hw_init</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_clean_cbs</span><span class="p">;</span>
	<span class="n">e100_set_multicast_list</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">e100_start_receiver</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">e100_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_no_irq</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="cm">/* enable ints _after_ enabling poll, preventing a race between</span>
<span class="cm">	 * disable ints+schedule */</span>
	<span class="n">e100_enable_irq</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_no_irq:</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
<span class="nl">err_clean_cbs:</span>
	<span class="n">e100_clean_cbs</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
<span class="nl">err_rx_clean_list:</span>
	<span class="n">e100_rx_clean_list</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* wait here for poll to complete */</span>
	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">e100_hw_reset</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">e100_clean_cbs</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">e100_rx_clean_list</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Reset outside of interrupt context, to avoid request_irq</span>
<span class="cm">	 * in interrupt context */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nic</span><span class="p">,</span> <span class="n">tx_timeout_task</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">netif_printk</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">tx_err</span><span class="p">,</span> <span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		     <span class="s">&quot;scb.status=0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">));</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e100_down</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
		<span class="n">e100_up</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_loopback_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">,</span> <span class="k">enum</span> <span class="n">loopback</span> <span class="n">loopback_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Use driver resources to perform internal MAC or PHY</span>
<span class="cm">	 * loopback test.  A single packet is prepared and transmitted</span>
<span class="cm">	 * in loopback mode, and the test passes if the received</span>
<span class="cm">	 * packet compares byte-for-byte to the transmitted packet. */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_rx_alloc_list</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_alloc_cbs</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_clean_rx</span><span class="p">;</span>

	<span class="cm">/* ICH PHY loopback is broken so do MAC loopback instead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ich</span> <span class="o">&amp;&amp;</span> <span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">lb_phy</span><span class="p">)</span>
		<span class="n">loopback_mode</span> <span class="o">=</span> <span class="n">lb_mac</span><span class="p">;</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">loopback_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_hw_init</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_loopback_none</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loopback_mode</span> <span class="o">==</span> <span class="n">lb_phy</span><span class="p">)</span>
		<span class="n">mdio_write</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span>
			<span class="n">BMCR_LOOPBACK</span><span class="p">);</span>

	<span class="n">e100_start_receiver</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">ETH_DATA_LEN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_loopback_none</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_DATA_LEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">ETH_DATA_LEN</span><span class="p">);</span>
	<span class="n">e100_xmit_frame</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="n">RFD_BUF_LEN</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_to_clean</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfd</span><span class="p">),</span>
	   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ETH_DATA_LEN</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

<span class="nl">err_loopback_none:</span>
	<span class="n">mdio_write</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">=</span> <span class="n">lb_none</span><span class="p">;</span>
	<span class="n">e100_clean_cbs</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">e100_hw_reset</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
<span class="nl">err_clean_rx:</span>
	<span class="n">e100_rx_clean_list</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MII_LED_CONTROL	0x1B</span>
<span class="cp">#define E100_82552_LED_OVERRIDE 0x19</span>
<span class="cp">#define E100_82552_LED_ON       0x000F </span><span class="cm">/* LEDTX and LED_RX both on */</span><span class="cp"></span>
<span class="cp">#define E100_82552_LED_OFF      0x000A </span><span class="cm">/* LEDTX and LED_RX both off */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">BMCR_RESET</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_configure</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define E100_PHY_REGS 0x1C</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">E100_PHY_REGS</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dump_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_hi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
		<span class="n">ioread8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">cmd_lo</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">ioread16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="o">-&gt;</span><span class="n">scb</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">E100_PHY_REGS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">buff</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">E100_PHY_REGS</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dump_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dump_buf</span><span class="p">));</span>
	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_dump</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buff</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">E100_PHY_REGS</span><span class="p">],</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dump_buf</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">dump_buf</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span> <span class="o">?</span>  <span class="n">WAKE_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">wol_magic</span><span class="p">)</span> <span class="o">?</span> <span class="n">WAKE_MAGIC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_wol</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_wolinfo</span> <span class="o">*</span><span class="n">wol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">&amp;&amp;</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span> <span class="o">!=</span> <span class="n">WAKE_MAGIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">device_can_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">wol_magic</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">wol_magic</span><span class="p">;</span>

	<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">wol</span><span class="o">-&gt;</span><span class="n">wolopts</span><span class="p">);</span>

	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_configure</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">e100_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_nway_restart</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">e100_get_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_get_eeprom_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom_wc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define E100_EEPROM_MAGIC	0x1234</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_get_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">E100_EEPROM_MAGIC</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">)[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">E100_EEPROM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">)[</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">],</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">e100_eeprom_save</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="o">*</span><span class="n">rfds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rfds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="o">*</span><span class="n">cbs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cbs</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">rfds</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">rfds</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="o">*</span><span class="n">rfds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rfds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">param_range</span> <span class="o">*</span><span class="n">cbs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cbs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">e100_down</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">rfds</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">,</span> <span class="n">rfds</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">);</span>
	<span class="n">rfds</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rfds</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">rfds</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
	<span class="n">cbs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">);</span>
	<span class="n">cbs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cbs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">);</span>
	<span class="n">netif_info</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Ring Param settings: rx: %d, tx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rfds</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">e100_up</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">e100_gstrings_test</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Link test     (on/offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Eeprom test   (on/offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Self test        (offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Mac loopback     (offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Phy loopback     (offline)&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define E100_TEST_LEN	ARRAY_SIZE(e100_gstrings_test)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_diag_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_test</span> <span class="o">*</span><span class="n">test</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">E100_TEST_LEN</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">mii_link_ok</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e100_eeprom_load</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* save speed, duplex &amp; autoneg settings */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">e100_down</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">e100_self_test</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">e100_loopback_test</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">lb_mac</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">e100_loopback_test</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">lb_phy</span><span class="p">);</span>

		<span class="cm">/* restore speed, duplex &amp; autoneg settings */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mii_ethtool_sset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">e100_up</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E100_TEST_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">ETH_TEST_FL_FAILED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_phys_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ethtool_phys_id_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">led_state</span> <span class="p">{</span>
		<span class="n">led_on</span>     <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="n">led_off</span>    <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
		<span class="n">led_on_559</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
		<span class="n">led_on_557</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u16</span> <span class="n">led_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="o">?</span> <span class="n">E100_82552_LED_OVERRIDE</span> <span class="o">:</span>
		<span class="n">MII_LED_CONTROL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">leds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETHTOOL_ID_ACTIVE</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_ON</span>:
		<span class="n">leds</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="o">?</span> <span class="n">E100_82552_LED_ON</span> <span class="o">:</span>
		       <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&lt;</span> <span class="n">mac_82559_D101M</span><span class="p">)</span> <span class="o">?</span> <span class="n">led_on_557</span> <span class="o">:</span> <span class="n">led_on_559</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_OFF</span>:
		<span class="n">leds</span> <span class="o">=</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="o">?</span> <span class="n">E100_82552_LED_OFF</span> <span class="o">:</span> <span class="n">led_off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETHTOOL_ID_INACTIVE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">led_reg</span><span class="p">,</span> <span class="n">leds</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">e100_gstrings_stats</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;rx_packets&quot;</span><span class="p">,</span> <span class="s">&quot;tx_packets&quot;</span><span class="p">,</span> <span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span> <span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span> <span class="s">&quot;rx_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_dropped&quot;</span><span class="p">,</span> <span class="s">&quot;tx_dropped&quot;</span><span class="p">,</span> <span class="s">&quot;multicast&quot;</span><span class="p">,</span> <span class="s">&quot;collisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_length_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_over_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_crc_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_frame_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_fifo_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_missed_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_aborted_errors&quot;</span><span class="p">,</span> <span class="s">&quot;tx_carrier_errors&quot;</span><span class="p">,</span> <span class="s">&quot;tx_fifo_errors&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_heartbeat_errors&quot;</span><span class="p">,</span> <span class="s">&quot;tx_window_errors&quot;</span><span class="p">,</span>
	<span class="cm">/* device-specific stats */</span>
	<span class="s">&quot;tx_deferred&quot;</span><span class="p">,</span> <span class="s">&quot;tx_single_collisions&quot;</span><span class="p">,</span> <span class="s">&quot;tx_multi_collisions&quot;</span><span class="p">,</span>
	<span class="s">&quot;tx_flow_control_pause&quot;</span><span class="p">,</span> <span class="s">&quot;rx_flow_control_pause&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_flow_control_unsupported&quot;</span><span class="p">,</span> <span class="s">&quot;tx_tco_packets&quot;</span><span class="p">,</span> <span class="s">&quot;rx_tco_packets&quot;</span><span class="p">,</span>
	<span class="s">&quot;rx_short_frame_errors&quot;</span><span class="p">,</span> <span class="s">&quot;rx_over_length_errors&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define E100_NET_STATS_LEN	21</span>
<span class="cp">#define E100_STATS_LEN	ARRAY_SIZE(e100_gstrings_stats)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="k">return</span> <span class="n">E100_TEST_LEN</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">return</span> <span class="n">E100_STATS_LEN</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E100_NET_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_deferred</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_single_collisions</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_multiple_collisions</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_fc_pause</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_fc_pause</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_fc_unsupported</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_tco_frames</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_tco_frames</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_short_frame_errors</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">rx_over_length_errors</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">e100_gstrings_test</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e100_gstrings_test</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">e100_gstrings_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e100_gstrings_stats</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">e100_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>		<span class="o">=</span> <span class="n">e100_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>		<span class="o">=</span> <span class="n">e100_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>		<span class="o">=</span> <span class="n">e100_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>		<span class="o">=</span> <span class="n">e100_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>		<span class="o">=</span> <span class="n">e100_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wol</span>		<span class="o">=</span> <span class="n">e100_get_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wol</span>		<span class="o">=</span> <span class="n">e100_set_wol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>		<span class="o">=</span> <span class="n">e100_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>		<span class="o">=</span> <span class="n">e100_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>		<span class="o">=</span> <span class="n">e100_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>		<span class="o">=</span> <span class="n">e100_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom_len</span>		<span class="o">=</span> <span class="n">e100_get_eeprom_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_eeprom</span>		<span class="o">=</span> <span class="n">e100_get_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_eeprom</span>		<span class="o">=</span> <span class="n">e100_set_eeprom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">e100_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">e100_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">self_test</span>		<span class="o">=</span> <span class="n">e100_diag_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>		<span class="o">=</span> <span class="n">e100_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_phys_id</span>		<span class="o">=</span> <span class="n">e100_set_phys_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>	<span class="o">=</span> <span class="n">e100_get_ethtool_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>		<span class="o">=</span> <span class="n">e100_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ts_info</span>		<span class="o">=</span> <span class="n">ethtool_op_get_ts_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem</span><span class="p">),</span>
			<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_up</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">ifup</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot open interface, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">e100_down</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_RXFCS</span> <span class="o">|</span> <span class="n">NETIF_F_RXALL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">e100_exec_cb</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">e100_configure</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">e100_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">e100_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">e100_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">e100_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">e100_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">e100_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">e100_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">e100_do_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">e100_tx_timeout</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">e100_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>	<span class="o">=</span> <span class="n">e100_set_features</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">e100_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nic</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXFCS</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">|=</span> <span class="n">IFF_SUPP_NOFCS</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXALL</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e100_netdev_ops</span><span class="p">;</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e100_ethtool_ops</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">E100_WATCHDOG_PERIOD</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">e100_poll</span><span class="p">,</span> <span class="n">E100_NAPI_WEIGHT</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">debug</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_ctrl</span> <span class="o">=</span> <span class="n">mdio_ctrl_hw</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot enable PCI device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot find proper PCI device base address, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot obtain PCI resources, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_io</span><span class="p">)</span>
		<span class="n">netif_info</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;using i/o access mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="p">(</span><span class="n">use_io</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">csr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot map device registers, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ich</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ich</span><span class="p">;</span>

	<span class="n">e100_get_defaults</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="cm">/* D100 MAC doesn&#39;t allow rx of vlan packets with normal MTU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&lt;</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_VLAN_CHALLENGED</span><span class="p">;</span>

	<span class="cm">/* locks must be initialized before calling hw_reset */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cb_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mdio_lock</span><span class="p">);</span>

	<span class="cm">/* Reset the device before pci_set_master() in case device is in some</span>
<span class="cm">	 * funky state and has an interrupt pending - hint: we don&#39;t have the</span>
<span class="cm">	 * interrupt handler registered yet. */</span>
	<span class="n">e100_hw_reset</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">e100_watchdog</span><span class="p">;</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">nic</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">,</span> <span class="n">e100_tx_timeout_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_alloc</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot alloc driver memory, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">e100_eeprom_load</span><span class="p">(</span><span class="n">nic</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="n">e100_phy_init</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eeprom_bad_csum_allow</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid MAC address from EEPROM, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid MAC address from EEPROM, you MUST configure one.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Wol magic packet can be enabled from eeprom */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">mac</span> <span class="o">&gt;=</span> <span class="n">mac_82558_D101_A4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">eeprom_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">eeprom_id_wol</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">wol_magic</span><span class="p">;</span>
		<span class="n">device_set_wakeup_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ack any pending wake events, disable PME */</span>
	<span class="n">pci_pme_active</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">nic</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			   <span class="n">nic</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">cbs</span><span class="p">.</span><span class="n">max</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cb</span><span class="p">),</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			   <span class="mi">0</span><span class="p">);</span>
	<span class="n">netif_info</span><span class="p">(</span><span class="n">nic</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		   <span class="s">&quot;addr 0x%llx, irq %d, MAC addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">use_io</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free:</span>
	<span class="n">e100_free</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
<span class="nl">err_out_iounmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">);</span>
<span class="nl">err_out_free_res:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_free_dev:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">e100_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">e100_free</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">);</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">cbs_pool</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define E100_82552_SMARTSPEED   0x14   </span><span class="cm">/* SmartSpeed Ctrl register */</span><span class="cp"></span>
<span class="cp">#define E100_82552_REV_ANEG     0x0200 </span><span class="cm">/* Reverse auto-negotiation */</span><span class="cp"></span>
<span class="cp">#define E100_82552_ANEG_NOW     0x0400 </span><span class="cm">/* Auto-negotiate now */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__e100_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">enable_wake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">e100_down</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">wol_magic</span><span class="p">)</span> <span class="o">|</span> <span class="n">e100_asf</span><span class="p">(</span><span class="n">nic</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* enable reverse auto-negotiation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">smartspeed</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
			                           <span class="n">E100_82552_SMARTSPEED</span><span class="p">);</span>

			<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
			           <span class="n">E100_82552_SMARTSPEED</span><span class="p">,</span> <span class="n">smartspeed</span> <span class="o">|</span>
			           <span class="n">E100_82552_REV_ANEG</span> <span class="o">|</span> <span class="n">E100_82552_ANEG_NOW</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">enable_wake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">enable_wake</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__e100_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pci_prepare_to_sleep</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_wake_from_d3</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">wake</span><span class="p">;</span>
	<span class="n">__e100_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wake</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__e100_power_off</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">wake</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/* ack any pending wake events, disable PME */</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* disable reverse auto-negotiation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="n">phy_82552_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">smartspeed</span> <span class="o">=</span> <span class="n">mdio_read</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
		                           <span class="n">E100_82552_SMARTSPEED</span><span class="p">);</span>

		<span class="n">mdio_write</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">nic</span><span class="o">-&gt;</span><span class="n">mii</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
		           <span class="n">E100_82552_SMARTSPEED</span><span class="p">,</span>
		           <span class="n">smartspeed</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">E100_82552_REV_ANEG</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">e100_up</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">wake</span><span class="p">;</span>
	<span class="n">__e100_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wake</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">system_state</span> <span class="o">==</span> <span class="n">SYSTEM_POWER_OFF</span><span class="p">)</span>
		<span class="n">__e100_power_off</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">wake</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------ PCI Error Recovery infrastructure  -------------- */</span>
<span class="cm">/**</span>
<span class="cm"> * e100_io_error_detected - called when PCI error is detected.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> * @state: The current pci connection state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">e100_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_channel_state_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">e100_down</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Request a slot reset. */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * e100_io_slot_reset - called after the pci bus has been reset.</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Restart the card from scratch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">e100_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot re-enable PCI device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Only one device per card can do a reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
	<span class="n">e100_hw_reset</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>
	<span class="n">e100_phy_init</span><span class="p">(</span><span class="n">nic</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * e100_io_resume - resume normal operations</span>
<span class="cm"> * @pdev: Pointer to PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Resume normal operations after an error recovery</span>
<span class="cm"> * sequence has been completed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nic</span> <span class="o">*</span><span class="n">nic</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* ack any pending wake events, disable PME */</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e100_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nic</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">e100_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">e100_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">e100_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">e100_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">e100_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>     <span class="n">e100_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>        <span class="n">e100_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>       <span class="n">__devexit_p</span><span class="p">(</span><span class="n">e100_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* Power Management hooks */</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>      <span class="n">e100_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>       <span class="n">e100_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span>     <span class="n">e100_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e100_err_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">e100_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">debug</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NETIF_MSG_DRV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_DESCRIPTION</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_COPYRIGHT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e100_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">e100_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e100_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">e100_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">e100_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
