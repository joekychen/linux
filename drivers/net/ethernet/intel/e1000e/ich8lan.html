<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › e1000e › ich8lan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ich8lan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel PRO/1000 Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  Linux NICS &lt;linux.nics@intel.com&gt;</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * 82562G 10/100 Network Connection</span>
<span class="cm"> * 82562G-2 10/100 Network Connection</span>
<span class="cm"> * 82562GT 10/100 Network Connection</span>
<span class="cm"> * 82562GT-2 10/100 Network Connection</span>
<span class="cm"> * 82562V 10/100 Network Connection</span>
<span class="cm"> * 82562V-2 10/100 Network Connection</span>
<span class="cm"> * 82566DC-2 Gigabit Network Connection</span>
<span class="cm"> * 82566DC Gigabit Network Connection</span>
<span class="cm"> * 82566DM-2 Gigabit Network Connection</span>
<span class="cm"> * 82566DM Gigabit Network Connection</span>
<span class="cm"> * 82566MC Gigabit Network Connection</span>
<span class="cm"> * 82566MM Gigabit Network Connection</span>
<span class="cm"> * 82567LM Gigabit Network Connection</span>
<span class="cm"> * 82567LF Gigabit Network Connection</span>
<span class="cm"> * 82567V Gigabit Network Connection</span>
<span class="cm"> * 82567LM-2 Gigabit Network Connection</span>
<span class="cm"> * 82567LF-2 Gigabit Network Connection</span>
<span class="cm"> * 82567V-2 Gigabit Network Connection</span>
<span class="cm"> * 82567LF-3 Gigabit Network Connection</span>
<span class="cm"> * 82567LM-3 Gigabit Network Connection</span>
<span class="cm"> * 82567LM-4 Gigabit Network Connection</span>
<span class="cm"> * 82577LM Gigabit Network Connection</span>
<span class="cm"> * 82577LC Gigabit Network Connection</span>
<span class="cm"> * 82578DM Gigabit Network Connection</span>
<span class="cm"> * 82578DC Gigabit Network Connection</span>
<span class="cm"> * 82579LM Gigabit Network Connection</span>
<span class="cm"> * 82579V Gigabit Network Connection</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;e1000.h&quot;</span>

<span class="cp">#define ICH_FLASH_GFPREG		0x0000</span>
<span class="cp">#define ICH_FLASH_HSFSTS		0x0004</span>
<span class="cp">#define ICH_FLASH_HSFCTL		0x0006</span>
<span class="cp">#define ICH_FLASH_FADDR			0x0008</span>
<span class="cp">#define ICH_FLASH_FDATA0		0x0010</span>
<span class="cp">#define ICH_FLASH_PR0			0x0074</span>

<span class="cp">#define ICH_FLASH_READ_COMMAND_TIMEOUT	500</span>
<span class="cp">#define ICH_FLASH_WRITE_COMMAND_TIMEOUT	500</span>
<span class="cp">#define ICH_FLASH_ERASE_COMMAND_TIMEOUT	3000000</span>
<span class="cp">#define ICH_FLASH_LINEAR_ADDR_MASK	0x00FFFFFF</span>
<span class="cp">#define ICH_FLASH_CYCLE_REPEAT_COUNT	10</span>

<span class="cp">#define ICH_CYCLE_READ			0</span>
<span class="cp">#define ICH_CYCLE_WRITE			2</span>
<span class="cp">#define ICH_CYCLE_ERASE			3</span>

<span class="cp">#define FLASH_GFPREG_BASE_MASK		0x1FFF</span>
<span class="cp">#define FLASH_SECTOR_ADDR_SHIFT		12</span>

<span class="cp">#define ICH_FLASH_SEG_SIZE_256		256</span>
<span class="cp">#define ICH_FLASH_SEG_SIZE_4K		4096</span>
<span class="cp">#define ICH_FLASH_SEG_SIZE_8K		8192</span>
<span class="cp">#define ICH_FLASH_SEG_SIZE_64K		65536</span>


<span class="cp">#define E1000_ICH_FWSM_RSPCIPHY	0x00000040 </span><span class="cm">/* Reset PHY on PCI Reset */</span><span class="cp"></span>
<span class="cm">/* FW established a valid mode */</span>
<span class="cp">#define E1000_ICH_FWSM_FW_VALID		0x00008000</span>

<span class="cp">#define E1000_ICH_MNG_IAMT_MODE		0x2</span>

<span class="cp">#define ID_LED_DEFAULT_ICH8LAN  ((ID_LED_DEF1_DEF2 &lt;&lt; 12) | \</span>
<span class="cp">				 (ID_LED_DEF1_OFF2 &lt;&lt;  8) | \</span>
<span class="cp">				 (ID_LED_DEF1_ON2  &lt;&lt;  4) | \</span>
<span class="cp">				 (ID_LED_DEF1_DEF2))</span>

<span class="cp">#define E1000_ICH_NVM_SIG_WORD		0x13</span>
<span class="cp">#define E1000_ICH_NVM_SIG_MASK		0xC000</span>
<span class="cp">#define E1000_ICH_NVM_VALID_SIG_MASK    0xC0</span>
<span class="cp">#define E1000_ICH_NVM_SIG_VALUE         0x80</span>

<span class="cp">#define E1000_ICH8_LAN_INIT_TIMEOUT	1500</span>

<span class="cp">#define E1000_FEXTNVM_SW_CONFIG		1</span>
<span class="cp">#define E1000_FEXTNVM_SW_CONFIG_ICH8M (1 &lt;&lt; 27) </span><span class="cm">/* Bit redefined for ICH8M :/ */</span><span class="cp"></span>

<span class="cp">#define E1000_FEXTNVM3_PHY_CFG_COUNTER_MASK    0x0C000000</span>
<span class="cp">#define E1000_FEXTNVM3_PHY_CFG_COUNTER_50MSEC  0x08000000</span>

<span class="cp">#define E1000_FEXTNVM4_BEACON_DURATION_MASK    0x7</span>
<span class="cp">#define E1000_FEXTNVM4_BEACON_DURATION_8USEC   0x7</span>
<span class="cp">#define E1000_FEXTNVM4_BEACON_DURATION_16USEC  0x3</span>

<span class="cp">#define PCIE_ICH8_SNOOP_ALL		PCIE_NO_SNOOP_ALL</span>

<span class="cp">#define E1000_ICH_RAR_ENTRIES		7</span>
<span class="cp">#define E1000_PCH2_RAR_ENTRIES		5 </span><span class="cm">/* RAR[0], SHRA[0-3] */</span><span class="cp"></span>
<span class="cp">#define E1000_PCH_LPT_RAR_ENTRIES	12 </span><span class="cm">/* RAR[0], SHRA[0-10] */</span><span class="cp"></span>

<span class="cp">#define PHY_PAGE_SHIFT 5</span>
<span class="cp">#define PHY_REG(page, reg) (((page) &lt;&lt; PHY_PAGE_SHIFT) | \</span>
<span class="cp">			   ((reg) &amp; MAX_PHY_REG_ADDRESS))</span>
<span class="cp">#define IGP3_KMRN_DIAG  PHY_REG(770, 19) </span><span class="cm">/* KMRN Diagnostic */</span><span class="cp"></span>
<span class="cp">#define IGP3_VR_CTRL    PHY_REG(776, 18) </span><span class="cm">/* Voltage Regulator Control */</span><span class="cp"></span>

<span class="cp">#define IGP3_KMRN_DIAG_PCS_LOCK_LOSS	0x0002</span>
<span class="cp">#define IGP3_VR_CTRL_DEV_POWERDOWN_MODE_MASK 0x0300</span>
<span class="cp">#define IGP3_VR_CTRL_MODE_SHUTDOWN	0x0200</span>

<span class="cp">#define HV_LED_CONFIG		PHY_REG(768, 30) </span><span class="cm">/* LED Configuration */</span><span class="cp"></span>

<span class="cp">#define SW_FLAG_TIMEOUT    1000 </span><span class="cm">/* SW Semaphore flag timeout in milliseconds */</span><span class="cp"></span>

<span class="cm">/* SMBus Control Phy Register */</span>
<span class="cp">#define CV_SMB_CTRL		PHY_REG(769, 23)</span>
<span class="cp">#define CV_SMB_CTRL_FORCE_SMBUS	0x0001</span>

<span class="cm">/* SMBus Address Phy Register */</span>
<span class="cp">#define HV_SMB_ADDR            PHY_REG(768, 26)</span>
<span class="cp">#define HV_SMB_ADDR_MASK       0x007F</span>
<span class="cp">#define HV_SMB_ADDR_PEC_EN     0x0200</span>
<span class="cp">#define HV_SMB_ADDR_VALID      0x0080</span>
<span class="cp">#define HV_SMB_ADDR_FREQ_MASK           0x1100</span>
<span class="cp">#define HV_SMB_ADDR_FREQ_LOW_SHIFT      8</span>
<span class="cp">#define HV_SMB_ADDR_FREQ_HIGH_SHIFT     12</span>

<span class="cm">/* PHY Power Management Control */</span>
<span class="cp">#define HV_PM_CTRL		PHY_REG(770, 17)</span>
<span class="cp">#define HV_PM_CTRL_PLL_STOP_IN_K1_GIGA	0x100</span>

<span class="cm">/* PHY Low Power Idle Control */</span>
<span class="cp">#define I82579_LPI_CTRL				PHY_REG(772, 20)</span>
<span class="cp">#define I82579_LPI_CTRL_ENABLE_MASK		0x6000</span>
<span class="cp">#define I82579_LPI_CTRL_FORCE_PLL_LOCK_COUNT	0x80</span>

<span class="cm">/* EMI Registers */</span>
<span class="cp">#define I82579_EMI_ADDR         0x10</span>
<span class="cp">#define I82579_EMI_DATA         0x11</span>
<span class="cp">#define I82579_LPI_UPDATE_TIMER 0x4805	</span><span class="cm">/* in 40ns units + 40 ns base value */</span><span class="cp"></span>
<span class="cp">#define I82579_MSE_THRESHOLD    0x084F	</span><span class="cm">/* Mean Square Error Threshold */</span><span class="cp"></span>
<span class="cp">#define I82579_MSE_LINK_DOWN    0x2411	</span><span class="cm">/* MSE count before dropping link */</span><span class="cp"></span>
<span class="cp">#define I217_EEE_ADVERTISEMENT  0x8001	</span><span class="cm">/* IEEE MMD Register 7.60 */</span><span class="cp"></span>
<span class="cp">#define I217_EEE_LP_ABILITY     0x8002	</span><span class="cm">/* IEEE MMD Register 7.61 */</span><span class="cp"></span>
<span class="cp">#define I217_EEE_100_SUPPORTED  (1 &lt;&lt; 1)	</span><span class="cm">/* 100BaseTx EEE supported */</span><span class="cp"></span>

<span class="cm">/* Intel Rapid Start Technology Support */</span>
<span class="cp">#define I217_PROXY_CTRL                 BM_PHY_REG(BM_WUC_PAGE, 70)</span>
<span class="cp">#define I217_PROXY_CTRL_AUTO_DISABLE    0x0080</span>
<span class="cp">#define I217_SxCTRL                     PHY_REG(BM_PORT_CTRL_PAGE, 28)</span>
<span class="cp">#define I217_SxCTRL_ENABLE_LPI_RESET    0x1000</span>
<span class="cp">#define I217_CGFREG                     PHY_REG(772, 29)</span>
<span class="cp">#define I217_CGFREG_ENABLE_MTA_RESET    0x0002</span>
<span class="cp">#define I217_MEMPWR                     PHY_REG(772, 26)</span>
<span class="cp">#define I217_MEMPWR_DISABLE_SMB_RELEASE 0x0010</span>

<span class="cm">/* Strapping Option Register - RO */</span>
<span class="cp">#define E1000_STRAP                     0x0000C</span>
<span class="cp">#define E1000_STRAP_SMBUS_ADDRESS_MASK  0x00FE0000</span>
<span class="cp">#define E1000_STRAP_SMBUS_ADDRESS_SHIFT 17</span>
<span class="cp">#define E1000_STRAP_SMT_FREQ_MASK       0x00003000</span>
<span class="cp">#define E1000_STRAP_SMT_FREQ_SHIFT      12</span>

<span class="cm">/* OEM Bits Phy Register */</span>
<span class="cp">#define HV_OEM_BITS            PHY_REG(768, 25)</span>
<span class="cp">#define HV_OEM_BITS_LPLU       0x0004 </span><span class="cm">/* Low Power Link Up */</span><span class="cp"></span>
<span class="cp">#define HV_OEM_BITS_GBE_DIS    0x0040 </span><span class="cm">/* Gigabit Disable */</span><span class="cp"></span>
<span class="cp">#define HV_OEM_BITS_RESTART_AN 0x0400 </span><span class="cm">/* Restart Auto-negotiation */</span><span class="cp"></span>

<span class="cp">#define E1000_NVM_K1_CONFIG 0x1B </span><span class="cm">/* NVM K1 Config Word */</span><span class="cp"></span>
<span class="cp">#define E1000_NVM_K1_ENABLE 0x1  </span><span class="cm">/* NVM Enable K1 bit */</span><span class="cp"></span>

<span class="cm">/* KMRN Mode Control */</span>
<span class="cp">#define HV_KMRN_MODE_CTRL      PHY_REG(769, 16)</span>
<span class="cp">#define HV_KMRN_MDIO_SLOW      0x0400</span>

<span class="cm">/* KMRN FIFO Control and Status */</span>
<span class="cp">#define HV_KMRN_FIFO_CTRLSTA                  PHY_REG(770, 16)</span>
<span class="cp">#define HV_KMRN_FIFO_CTRLSTA_PREAMBLE_MASK    0x7000</span>
<span class="cp">#define HV_KMRN_FIFO_CTRLSTA_PREAMBLE_SHIFT   12</span>

<span class="cm">/* ICH GbE Flash Hardware Sequencing Flash Status Register bit breakdown */</span>
<span class="cm">/* Offset 04h HSFSTS */</span>
<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ich8_hsfsts</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">flcdone</span>    <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* bit 0 Flash Cycle Done */</span>
		<span class="n">u16</span> <span class="n">flcerr</span>     <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* bit 1 Flash Cycle Error */</span>
		<span class="n">u16</span> <span class="n">dael</span>       <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* bit 2 Direct Access error Log */</span>
		<span class="n">u16</span> <span class="n">berasesz</span>   <span class="o">:</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* bit 4:3 Sector Erase Size */</span>
		<span class="n">u16</span> <span class="n">flcinprog</span>  <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* bit 5 flash cycle in Progress */</span>
		<span class="n">u16</span> <span class="n">reserved1</span>  <span class="o">:</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* bit 13:6 Reserved */</span>
		<span class="n">u16</span> <span class="n">reserved2</span>  <span class="o">:</span><span class="mi">6</span><span class="p">;</span> <span class="cm">/* bit 13:6 Reserved */</span>
		<span class="n">u16</span> <span class="n">fldesvalid</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* bit 14 Flash Descriptor Valid */</span>
		<span class="n">u16</span> <span class="n">flockdn</span>    <span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* bit 15 Flash Config Lock-Down */</span>
	<span class="p">}</span> <span class="n">hsf_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regval</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ICH GbE Flash Hardware Sequencing Flash control Register bit breakdown */</span>
<span class="cm">/* Offset 06h FLCTL */</span>
<span class="k">union</span> <span class="n">ich8_hws_flash_ctrl</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ich8_hsflctl</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">flcgo</span>      <span class="o">:</span><span class="mi">1</span><span class="p">;</span>   <span class="cm">/* 0 Flash Cycle Go */</span>
		<span class="n">u16</span> <span class="n">flcycle</span>    <span class="o">:</span><span class="mi">2</span><span class="p">;</span>   <span class="cm">/* 2:1 Flash Cycle */</span>
		<span class="n">u16</span> <span class="n">reserved</span>   <span class="o">:</span><span class="mi">5</span><span class="p">;</span>   <span class="cm">/* 7:3 Reserved  */</span>
		<span class="n">u16</span> <span class="n">fldbcount</span>  <span class="o">:</span><span class="mi">2</span><span class="p">;</span>   <span class="cm">/* 9:8 Flash Data Byte Count */</span>
		<span class="n">u16</span> <span class="n">flockdn</span>    <span class="o">:</span><span class="mi">6</span><span class="p">;</span>   <span class="cm">/* 15:10 Reserved */</span>
	<span class="p">}</span> <span class="n">hsf_ctrl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regval</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ICH Flash Region Access Permissions */</span>
<span class="k">union</span> <span class="n">ich8_hws_flash_regacc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ich8_flracc</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">grra</span>      <span class="o">:</span><span class="mi">8</span><span class="p">;</span> <span class="cm">/* 0:7 GbE region Read Access */</span>
		<span class="n">u32</span> <span class="n">grwa</span>      <span class="o">:</span><span class="mi">8</span><span class="p">;</span> <span class="cm">/* 8:15 GbE region Write Access */</span>
		<span class="n">u32</span> <span class="n">gmrag</span>     <span class="o">:</span><span class="mi">8</span><span class="p">;</span> <span class="cm">/* 23:16 GbE Master Read Access Grant */</span>
		<span class="n">u32</span> <span class="n">gmwag</span>     <span class="o">:</span><span class="mi">8</span><span class="p">;</span> <span class="cm">/* 31:24 GbE Master Write Access Grant */</span>
	<span class="p">}</span> <span class="n">hsf_flregacc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">regval</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ICH Flash Protected Region */</span>
<span class="k">union</span> <span class="n">ich8_flash_protected_range</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ich8_pr</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">base</span><span class="o">:</span><span class="mi">13</span><span class="p">;</span>     <span class="cm">/* 0:12 Protected Range Base */</span>
		<span class="n">u32</span> <span class="n">reserved1</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* 13:14 Reserved */</span>
		<span class="n">u32</span> <span class="n">rpe</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>       <span class="cm">/* 15 Read Protection Enable */</span>
		<span class="n">u32</span> <span class="n">limit</span><span class="o">:</span><span class="mi">13</span><span class="p">;</span>    <span class="cm">/* 16:28 Protected Range Limit */</span>
		<span class="n">u32</span> <span class="n">reserved2</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* 29:30 Reserved */</span>
		<span class="n">u32</span> <span class="n">wpe</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>       <span class="cm">/* 31 Write Protection Enable */</span>
	<span class="p">}</span> <span class="n">range</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_setup_link_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_clear_hw_cntrs_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_initialize_hw_bits_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_erase_flash_bank_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bank</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_retry_write_flash_byte_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_read_flash_byte_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_read_flash_word_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_read_flash_data_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_setup_copper_link_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_kmrn_lock_loss_workaround_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_get_cfg_done_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_cleanup_led_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_led_on_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_led_off_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_id_led_init_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_setup_led_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_cleanup_led_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_led_on_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_led_off_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_set_lplu_state_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_power_down_phy_copper_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_lan_init_done_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span>  <span class="n">e1000_k1_gig_workaround_hv</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_set_mdio_slow_mode_hv</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">e1000_check_mng_mode_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">e1000_check_mng_mode_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_rar_set_pch2lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_rar_set_pch_lpt</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">e1000_k1_workaround_lv</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gate</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">__er16flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_address</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">__er32flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_address</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__ew16flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_address</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__ew32flash</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_address</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define er16flash(reg)		__er16flash(hw, (reg))</span>
<span class="cp">#define er32flash(reg)		__er32flash(hw, (reg))</span>
<span class="cp">#define ew16flash(reg, val)	__ew16flash(hw, (reg), (val))</span>
<span class="cp">#define ew32flash(reg, val)	__ew32flash(hw, (reg), (val))</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_phy_is_accessible_pchlan - Check if able to access PHY registers</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Test access to the PHY registers by reading the PHY ID registers.  If</span>
<span class="cm"> *  the PHY ID is already known (e.g. resume path) compare it with known ID,</span>
<span class="cm"> *  otherwise assume the read PHY ID is correct if it is valid.</span>
<span class="cm"> *</span>
<span class="cm"> *  Assumes the sw/fw/hw semaphore is already acquired.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">e1000_phy_is_accessible_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_id</span><span class="p">;</span>

	<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_ID1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
	<span class="n">phy_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">phy_reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_ID2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
	<span class="n">phy_id</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">phy_reg</span> <span class="o">&amp;</span> <span class="n">PHY_REVISION_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">phy_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">phy_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">!=</span> <span class="n">PHY_REVISION_MASK</span><span class="p">))</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">phy_id</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_init_phy_workarounds_pchlan - PHY initialization workarounds</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Workarounds/flow necessary for PHY initialization during driver load</span>
<span class="cm"> *  and resume paths.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_init_phy_workarounds_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mac_reg</span><span class="p">,</span> <span class="n">fwsm</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Failed to initialize PHY flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The MAC-PHY interconnect may be in SMBus mode.  If the PHY is</span>
<span class="cm">	 * inaccessible and resetting the PHY is not blocked, toggle the</span>
<span class="cm">	 * LANPHYPC Value bit to force the interconnect to PCIe mode.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_pch_lpt</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">e1000_phy_is_accessible_pchlan</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Before toggling LANPHYPC, see if PHY is accessible by</span>
<span class="cm">		 * forcing MAC to SMBus mode first.</span>
<span class="cm">		 */</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">|=</span> <span class="n">E1000_CTRL_EXT_FORCE_SMBUS</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>

		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Gate automatic PHY configuration by hardware on</span>
<span class="cm">		 * non-managed 82579</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span>
			<span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">e1000_phy_is_accessible_pchlan</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch_lpt</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Unforce SMBus mode in PHY */</span>
				<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CV_SMB_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
				<span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CV_SMB_CTRL_FORCE_SMBUS</span><span class="p">;</span>
				<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CV_SMB_CTRL</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>

				<span class="cm">/* Unforce SMBus mode in MAC */</span>
				<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">);</span>
				<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_CTRL_EXT_FORCE_SMBUS</span><span class="p">;</span>
				<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">e1000_pchlan</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Required LANPHYPC toggle blocked by ME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Toggling LANPHYPC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Set Phy Config Counter to 50msec */</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FEXTNVM3</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_FEXTNVM3_PHY_CFG_COUNTER_MASK</span><span class="p">;</span>
		<span class="n">mac_reg</span> <span class="o">|=</span> <span class="n">E1000_FEXTNVM3_PHY_CFG_COUNTER_50MSEC</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">FEXTNVM3</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>

		<span class="cm">/* Toggle LANPHYPC Value bit */</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">|=</span> <span class="n">E1000_CTRL_LANPHYPC_OVERRIDE</span><span class="p">;</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_CTRL_LANPHYPC_VALUE</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_CTRL_LANPHYPC_OVERRIDE</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">e1000_pch_lpt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">)</span> <span class="o">&amp;</span>
				   <span class="n">E1000_CTRL_EXT_LPCD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">--</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the PHY before any access to it.  Doing so, ensures</span>
<span class="cm">	 * that the PHY is in a known good state before we read/write</span>
<span class="cm">	 * PHY registers.  The generic reset is sufficient here,</span>
<span class="cm">	 * because we haven&#39;t determined the PHY type yet.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_phy_hw_reset_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Ungate automatic PHY configuration on non-managed 82579 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
		<span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_init_phy_params_pchlan - Initialize PHY function pointers</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Initialize family-specific PHY parameters and function pointers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_init_phy_params_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_phy_info</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span>                     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">reset_delay_us</span>           <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_page</span>             <span class="o">=</span> <span class="n">e1000_set_page_igp</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span>             <span class="o">=</span> <span class="n">e1000_read_phy_reg_hv</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_locked</span>      <span class="o">=</span> <span class="n">e1000_read_phy_reg_hv_locked</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span>        <span class="o">=</span> <span class="n">e1000_read_phy_reg_page_hv</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_d0_lplu_state</span>    <span class="o">=</span> <span class="n">e1000_set_lplu_state_pchlan</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">set_d3_lplu_state</span>    <span class="o">=</span> <span class="n">e1000_set_lplu_state_pchlan</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg</span>            <span class="o">=</span> <span class="n">e1000_write_phy_reg_hv</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_locked</span>     <span class="o">=</span> <span class="n">e1000_write_phy_reg_hv_locked</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_page</span>       <span class="o">=</span> <span class="n">e1000_write_phy_reg_page_hv</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">power_up</span>             <span class="o">=</span> <span class="n">e1000_power_up_phy_copper</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">power_down</span>           <span class="o">=</span> <span class="n">e1000_power_down_phy_copper_ich8lan</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_mask</span>             <span class="o">=</span> <span class="n">AUTONEG_ADVERTISE_SPEED_DEFAULT</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">e1000_phy_unknown</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_init_phy_workarounds_pchlan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">e1000_phy_unknown</span><span class="p">)</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_get_phy_id</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PHY_REVISION_MASK</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* fall-through */</span>
		<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
		<span class="k">case</span> <span class="n">e1000_pch_lpt</span>:
			<span class="cm">/*</span>
<span class="cm">			 * In case the PHY needs to be in mdio slow mode,</span>
<span class="cm">			 * set slow mode and try to get the PHY id again.</span>
<span class="cm">			 */</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_set_mdio_slow_mode_hv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_get_phy_id</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">e1000e_get_phy_type_from_id</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_phy_82577</span>:
	<span class="k">case</span> <span class="n">e1000_phy_82579</span>:
	<span class="k">case</span> <span class="n">e1000_phy_i217</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_polarity</span> <span class="o">=</span> <span class="n">e1000_check_polarity_82577</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">force_speed_duplex</span> <span class="o">=</span>
		    <span class="n">e1000_phy_force_speed_duplex_82577</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_cable_length</span> <span class="o">=</span> <span class="n">e1000_get_cable_length_82577</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_info</span> <span class="o">=</span> <span class="n">e1000_get_phy_info_82577</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">e1000e_phy_sw_reset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_phy_82578</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_polarity</span> <span class="o">=</span> <span class="n">e1000_check_polarity_m88</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">force_speed_duplex</span> <span class="o">=</span> <span class="n">e1000e_phy_force_speed_duplex_m88</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_cable_length</span> <span class="o">=</span> <span class="n">e1000e_get_cable_length_m88</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_info</span> <span class="o">=</span> <span class="n">e1000e_get_phy_info_m88</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_PHY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_init_phy_params_ich8lan - Initialize PHY function pointers</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Initialize family-specific PHY parameters and function pointers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_init_phy_params_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_phy_info</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">addr</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">reset_delay_us</span>		<span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">power_up</span>               <span class="o">=</span> <span class="n">e1000_power_up_phy_copper</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">power_down</span>             <span class="o">=</span> <span class="n">e1000_power_down_phy_copper_ich8lan</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We may need to do this twice - once for IGP and if that fails,</span>
<span class="cm">	 * we&#39;ll set BM func pointers and try again</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_determine_phy_address</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg</span> <span class="o">=</span> <span class="n">e1000e_write_phy_reg_bm</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span>  <span class="o">=</span> <span class="n">e1000e_read_phy_reg_bm</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_determine_phy_address</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Cannot determine PHY addr. Erroring out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">e1000_phy_unknown</span> <span class="o">==</span> <span class="n">e1000e_get_phy_type_from_id</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_get_phy_id</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify phy id */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IGP03E1000_E_PHY_ID</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">e1000_phy_igp_3</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_mask</span> <span class="o">=</span> <span class="n">AUTONEG_ADVERTISE_SPEED_DEFAULT</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_locked</span> <span class="o">=</span> <span class="n">e1000e_read_phy_reg_igp_locked</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_locked</span> <span class="o">=</span> <span class="n">e1000e_write_phy_reg_igp_locked</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_info</span> <span class="o">=</span> <span class="n">e1000e_get_phy_info_igp</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_polarity</span> <span class="o">=</span> <span class="n">e1000_check_polarity_igp</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">force_speed_duplex</span> <span class="o">=</span> <span class="n">e1000e_phy_force_speed_duplex_igp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IFE_E_PHY_ID</span>:
	<span class="k">case</span> <span class="n">IFE_PLUS_E_PHY_ID</span>:
	<span class="k">case</span> <span class="n">IFE_C_E_PHY_ID</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">e1000_phy_ife</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_mask</span> <span class="o">=</span> <span class="n">E1000_ALL_NOT_GIG</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_info</span> <span class="o">=</span> <span class="n">e1000_get_phy_info_ife</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_polarity</span> <span class="o">=</span> <span class="n">e1000_check_polarity_ife</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">force_speed_duplex</span> <span class="o">=</span> <span class="n">e1000_phy_force_speed_duplex_ife</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BME1000_E_PHY_ID</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">e1000_phy_bm</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_mask</span> <span class="o">=</span> <span class="n">AUTONEG_ADVERTISE_SPEED_DEFAULT</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span> <span class="o">=</span> <span class="n">e1000e_read_phy_reg_bm</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg</span> <span class="o">=</span> <span class="n">e1000e_write_phy_reg_bm</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">e1000e_phy_sw_reset</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">get_info</span> <span class="o">=</span> <span class="n">e1000e_get_phy_info_m88</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_polarity</span> <span class="o">=</span> <span class="n">e1000_check_polarity_m88</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">force_speed_duplex</span> <span class="o">=</span> <span class="n">e1000e_phy_force_speed_duplex_m88</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_PHY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_init_nvm_params_ich8lan - Initialize NVM function pointers</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Initialize family-specific NVM parameters and function</span>
<span class="cm"> *  pointers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_init_nvm_params_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gfpreg</span><span class="p">,</span> <span class="n">sector_base_addr</span><span class="p">,</span> <span class="n">sector_end_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t read flash registers if the register set isn&#39;t mapped. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flash_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;ERROR: Flash registers not mapped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_CONFIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">e1000_nvm_flash_sw</span><span class="p">;</span>

	<span class="n">gfpreg</span> <span class="o">=</span> <span class="n">er32flash</span><span class="p">(</span><span class="n">ICH_FLASH_GFPREG</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * sector_X_addr is a &quot;sector&quot;-aligned address (4096 bytes)</span>
<span class="cm">	 * Add 1 to sector_end_addr since this sector is included in</span>
<span class="cm">	 * the overall size.</span>
<span class="cm">	 */</span>
	<span class="n">sector_base_addr</span> <span class="o">=</span> <span class="n">gfpreg</span> <span class="o">&amp;</span> <span class="n">FLASH_GFPREG_BASE_MASK</span><span class="p">;</span>
	<span class="n">sector_end_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">gfpreg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FLASH_GFPREG_BASE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* flash_base_addr is byte-aligned */</span>
	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_base_addr</span> <span class="o">=</span> <span class="n">sector_base_addr</span> <span class="o">&lt;&lt;</span> <span class="n">FLASH_SECTOR_ADDR_SHIFT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * find total size of the NVM, then cut in half since the total</span>
<span class="cm">	 * size represents two separate NVM banks.</span>
<span class="cm">	 */</span>
	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_end_addr</span> <span class="o">-</span> <span class="n">sector_base_addr</span><span class="p">)</span>
				<span class="o">&lt;&lt;</span> <span class="n">FLASH_SECTOR_ADDR_SHIFT</span><span class="p">;</span>
	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Adjust to word count */</span>
	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="n">E1000_ICH8_SHADOW_RAM_WORDS</span><span class="p">;</span>

	<span class="cm">/* Clear shadow ram */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span>    <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_init_mac_params_ich8lan - Initialize MAC function pointers</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Initialize family-specific MAC parameters and function</span>
<span class="cm"> *  pointers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_init_mac_params_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>

	<span class="cm">/* Set media type function pointer */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">media_type</span> <span class="o">=</span> <span class="n">e1000_media_type_copper</span><span class="p">;</span>

	<span class="cm">/* Set mta register count */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mta_reg_count</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="cm">/* Set rar entry count */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rar_entry_count</span> <span class="o">=</span> <span class="n">E1000_ICH_RAR_ENTRIES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rar_entry_count</span><span class="o">--</span><span class="p">;</span>
	<span class="cm">/* FWSM register */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">has_fwsm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* ARC subsystem not supported */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">arc_subsystem_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="cm">/* Adaptive IFS supported */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">adaptive_ifs</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* LED and other operations */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_ich8lan</span>:
	<span class="k">case</span> <span class="n">e1000_ich9lan</span>:
	<span class="k">case</span> <span class="n">e1000_ich10lan</span>:
		<span class="cm">/* check management mode */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_mng_mode</span> <span class="o">=</span> <span class="n">e1000_check_mng_mode_ich8lan</span><span class="p">;</span>
		<span class="cm">/* ID LED init */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">id_led_init</span> <span class="o">=</span> <span class="n">e1000e_id_led_init_generic</span><span class="p">;</span>
		<span class="cm">/* blink LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">blink_led</span> <span class="o">=</span> <span class="n">e1000e_blink_led_generic</span><span class="p">;</span>
		<span class="cm">/* setup LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_led</span> <span class="o">=</span> <span class="n">e1000e_setup_led_generic</span><span class="p">;</span>
		<span class="cm">/* cleanup LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">cleanup_led</span> <span class="o">=</span> <span class="n">e1000_cleanup_led_ich8lan</span><span class="p">;</span>
		<span class="cm">/* turn on/off LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">led_on</span> <span class="o">=</span> <span class="n">e1000_led_on_ich8lan</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">led_off</span> <span class="o">=</span> <span class="n">e1000_led_off_ich8lan</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rar_entry_count</span> <span class="o">=</span> <span class="n">E1000_PCH2_RAR_ENTRIES</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">rar_set</span> <span class="o">=</span> <span class="n">e1000_rar_set_pch2lan</span><span class="p">;</span>
		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">e1000_pch_lpt</span>:
	<span class="k">case</span> <span class="n">e1000_pchlan</span>:
		<span class="cm">/* check management mode */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">check_mng_mode</span> <span class="o">=</span> <span class="n">e1000_check_mng_mode_pchlan</span><span class="p">;</span>
		<span class="cm">/* ID LED init */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">id_led_init</span> <span class="o">=</span> <span class="n">e1000_id_led_init_pchlan</span><span class="p">;</span>
		<span class="cm">/* setup LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_led</span> <span class="o">=</span> <span class="n">e1000_setup_led_pchlan</span><span class="p">;</span>
		<span class="cm">/* cleanup LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">cleanup_led</span> <span class="o">=</span> <span class="n">e1000_cleanup_led_pchlan</span><span class="p">;</span>
		<span class="cm">/* turn on/off LED */</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">led_on</span> <span class="o">=</span> <span class="n">e1000_led_on_pchlan</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">led_off</span> <span class="o">=</span> <span class="n">e1000_led_off_pchlan</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch_lpt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">rar_entry_count</span> <span class="o">=</span> <span class="n">E1000_PCH_LPT_RAR_ENTRIES</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">rar_set</span> <span class="o">=</span> <span class="n">e1000_rar_set_pch_lpt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable PCS Lock-loss workaround for ICH8 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
		<span class="n">e1000e_set_kmrn_lock_loss_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Gate automatic PHY configuration by hardware on managed</span>
<span class="cm">	 * 82579 and i217</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span> <span class="o">||</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch_lpt</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span>
		<span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_set_eee_pchlan - Enable/disable EEE support</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Enable/disable EEE based on setting in dev_spec structure.  The bits in</span>
<span class="cm"> *  the LPI Control register will remain set only if/when link is up.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_set_eee_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_82579</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_i217</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_LPI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">eee_disable</span><span class="p">)</span>
		<span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I82579_LPI_CTRL_ENABLE_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">I82579_LPI_CTRL_ENABLE_MASK</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_LPI_CTRL</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_i217</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">eee_disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save off link partner&#39;s EEE ability */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_ADDR</span><span class="p">,</span>
					  <span class="n">I217_EEE_LP_ABILITY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">eee_lp_ability</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * EEE is not supported in 100Half, so ignore partner&#39;s EEE</span>
<span class="cm">		 * in 100 ability if full-duplex is not advertised.</span>
<span class="cm">		 */</span>
		<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_LP_ABILITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">phy_reg</span> <span class="o">&amp;</span> <span class="n">NWAY_LPAR_100TX_FD_CAPS</span><span class="p">))</span>
			<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">eee_lp_ability</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I217_EEE_100_SUPPORTED</span><span class="p">;</span>
<span class="nl">release:</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_check_for_copper_link_ich8lan - Check for link (Copper)</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Checks to see of the link status of the hardware has changed.  If a</span>
<span class="cm"> *  change in link status has been detected, then we read the PHY registers</span>
<span class="cm"> *  to get the current speed/duplex if link exists.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_check_for_copper_link_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only want to go out to the PHY registers to see if Auto-Neg</span>
<span class="cm">	 * has completed and/or if our link status has changed.  The</span>
<span class="cm">	 * get_link_status flag is set upon receiving a Link Status</span>
<span class="cm">	 * Change or Rx Sequence Error interrupt.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">get_link_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First we want to see if the MII Status Register reports</span>
<span class="cm">	 * link.  If so, then we want to get the current speed/duplex</span>
<span class="cm">	 * of the PHY.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_phy_has_link_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_k1_gig_workaround_hv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear link partner&#39;s EEE ability */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">.</span><span class="n">eee_lp_ability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No link detected */</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">get_link_status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_k1_workaround_lv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="cm">/* fall-thru */</span>
	<span class="k">case</span> <span class="n">e1000_pchlan</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_link_stall_workaround_hv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Workaround for PCHx parts in half-duplex:</span>
<span class="cm">		 * Set the number of preambles removed from the packet</span>
<span class="cm">		 * when it is passed from the PHY to the MAC to prevent</span>
<span class="cm">		 * the MAC from misinterpreting the packet type.</span>
<span class="cm">		 */</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_KMRN_FIFO_CTRLSTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
		<span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HV_KMRN_FIFO_CTRLSTA_PREAMBLE_MASK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_STATUS_FD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">E1000_STATUS_FD</span><span class="p">)</span>
			<span class="n">phy_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">HV_KMRN_FIFO_CTRLSTA_PREAMBLE_SHIFT</span><span class="p">);</span>

		<span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_KMRN_FIFO_CTRLSTA</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if there was DownShift, must be checked</span>
<span class="cm">	 * immediately after link-up</span>
<span class="cm">	 */</span>
	<span class="n">e1000e_check_downshift</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable EEE after link up */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_set_eee_pchlan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are forcing speed/duplex, then we simply return since</span>
<span class="cm">	 * we have already determined whether we have link or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">autoneg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_CONFIG</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Auto-Neg is enabled.  Auto Speed Detection takes care</span>
<span class="cm">	 * of MAC speed/duplex configuration.  So we only need to</span>
<span class="cm">	 * configure Collision Distance in the MAC.</span>
<span class="cm">	 */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">config_collision_dist</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure Flow Control now that Auto-Neg has completed.</span>
<span class="cm">	 * First, we need to restore the desired flow control</span>
<span class="cm">	 * settings because we may have had to re-autoneg with a</span>
<span class="cm">	 * different link partner.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_config_fc_after_link_up</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Error configuring flow control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_get_variants_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">e1000_init_mac_params_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">e1000_init_nvm_params_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_ich8lan</span>:
	<span class="k">case</span> <span class="n">e1000_ich9lan</span>:
	<span class="k">case</span> <span class="n">e1000_ich10lan</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">e1000_init_phy_params_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_pchlan</span>:
	<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
	<span class="k">case</span> <span class="n">e1000_pch_lpt</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">e1000_init_phy_params_pchlan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable Jumbo Frame support on parts with Intel 10/100 PHY or</span>
<span class="cm">	 * on parts with MACsec enabled in NVM (reflected in CTRL_EXT).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_ife</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_CTRL_EXT_LSECCK</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_HAS_JUMBO_FRAMES</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_hw_frame_size</span> <span class="o">=</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">;</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">blink_led</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_ife</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_LSC_GIG_SPEED_DROP</span><span class="p">;</span>

	<span class="cm">/* Enable workaround for 82579 w/ ME enabled */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">|=</span> <span class="n">FLAG2_PCIM2PCI_ARBITER_WA</span><span class="p">;</span>

	<span class="cm">/* Disable EEE by default until IEEE802.3az spec is finalized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags2</span> <span class="o">&amp;</span> <span class="n">FLAG2_HAS_EEE</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">.</span><span class="n">eee_disable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">nvm_mutex</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_acquire_nvm_ich8lan - Acquire NVM mutex</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Acquires the mutex for performing NVM operations.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_acquire_nvm_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_release_nvm_ich8lan - Release NVM mutex</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Releases the mutex used while performing NVM operations.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_release_nvm_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nvm_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_acquire_swflag_ich8lan - Acquire software control flag</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Acquires the software control flag for performing PHY and select</span>
<span class="cm"> *  MAC CSR accesses.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_acquire_swflag_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">extcnf_ctrl</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">PHY_CFG_TIMEOUT</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__E1000_ACCESS_SHARED_RESOURCE</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;contention for Phy access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_PHY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extcnf_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">extcnf_ctrl</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_SWFLAG</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;SW has already locked the resource.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_CONFIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">SW_FLAG_TIMEOUT</span><span class="p">;</span>

	<span class="n">extcnf_ctrl</span> <span class="o">|=</span> <span class="n">E1000_EXTCNF_CTRL_SWFLAG</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">,</span> <span class="n">extcnf_ctrl</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extcnf_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extcnf_ctrl</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_SWFLAG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Failed to acquire the semaphore, FW or HW has it: FWSM=0x%8.8x EXTCNF_CTRL=0x%8.8x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">),</span> <span class="n">extcnf_ctrl</span><span class="p">);</span>
		<span class="n">extcnf_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_EXTCNF_CTRL_SWFLAG</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">,</span> <span class="n">extcnf_ctrl</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_CONFIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__E1000_ACCESS_SHARED_RESOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_release_swflag_ich8lan - Release software control flag</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Releases the software control flag for performing PHY and select</span>
<span class="cm"> *  MAC CSR accesses.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_release_swflag_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">extcnf_ctrl</span><span class="p">;</span>

	<span class="n">extcnf_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extcnf_ctrl</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_SWFLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">extcnf_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_EXTCNF_CTRL_SWFLAG</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">,</span> <span class="n">extcnf_ctrl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Semaphore unexpectedly released by sw/fw/hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__E1000_ACCESS_SHARED_RESOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_check_mng_mode_ich8lan - Checks management mode</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  This checks if the adapter has any manageability enabled.</span>
<span class="cm"> *  This is a function pointer entry point only called by read/write</span>
<span class="cm"> *  routines for the PHY and NVM parts.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">e1000_check_mng_mode_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fwsm</span><span class="p">;</span>

	<span class="n">fwsm</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">((</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_FWSM_MODE_MASK</span><span class="p">)</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">E1000_ICH_MNG_IAMT_MODE</span> <span class="o">&lt;&lt;</span> <span class="n">E1000_FWSM_MODE_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_check_mng_mode_pchlan - Checks management mode</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  This checks if the adapter has iAMT enabled.</span>
<span class="cm"> *  This is a function pointer entry point only called by read/write</span>
<span class="cm"> *  routines for the PHY and NVM parts.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">e1000_check_mng_mode_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fwsm</span><span class="p">;</span>

	<span class="n">fwsm</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">E1000_ICH_MNG_IAMT_MODE</span> <span class="o">&lt;&lt;</span> <span class="n">E1000_FWSM_MODE_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_rar_set_pch2lan - Set receive address register</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @addr: pointer to the receive address</span>
<span class="cm"> *  @index: receive address array register</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets the receive address array register at index to the address passed</span>
<span class="cm"> *  in by addr.  For 82579, RAR[0] is the base address register that is to</span>
<span class="cm"> *  contain the MAC address but RAR[1-6] are reserved for manageability (ME).</span>
<span class="cm"> *  Use SHRA[0-3] in place of those reserved for ME.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_rar_set_pch2lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rar_low</span><span class="p">,</span> <span class="n">rar_high</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HW expects these in little endian so we reverse the byte order</span>
<span class="cm">	 * from network order (big endian) to little endian</span>
<span class="cm">	 */</span>
	<span class="n">rar_low</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>

	<span class="n">rar_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* If MAC address zero, no need to set the AV bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rar_low</span> <span class="o">||</span> <span class="n">rar_high</span><span class="p">)</span>
		<span class="n">rar_high</span> <span class="o">|=</span> <span class="n">E1000_RAH_AV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">RAL</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">rar_low</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">RAH</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">rar_high</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">rar_entry_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_acquire_swflag_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">ew32</span><span class="p">(</span><span class="n">SHRAL</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rar_low</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">SHRAH</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rar_high</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>

		<span class="n">e1000_release_swflag_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/* verify the register updates */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">er32</span><span class="p">(</span><span class="n">SHRAL</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">rar_low</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">SHRAH</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">rar_high</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;SHRA[%d] might be locked by ME - FWSM=0x%8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Failed to write receive address at index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_rar_set_pch_lpt - Set receive address registers</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @addr: pointer to the receive address</span>
<span class="cm"> *  @index: receive address array register</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets the receive address register array at index to the address passed</span>
<span class="cm"> *  in by addr. For LPT, RAR[0] is the base address register that is to</span>
<span class="cm"> *  contain the MAC address. SHRA[0-10] are the shared receive address</span>
<span class="cm"> *  registers that are shared between the Host and manageability engine (ME).</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_rar_set_pch_lpt</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rar_low</span><span class="p">,</span> <span class="n">rar_high</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wlock_mac</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * HW expects these in little endian so we reverse the byte order</span>
<span class="cm">	 * from network order (big endian) to little endian</span>
<span class="cm">	 */</span>
	<span class="n">rar_low</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>

	<span class="n">rar_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* If MAC address zero, no need to set the AV bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rar_low</span> <span class="o">||</span> <span class="n">rar_high</span><span class="p">)</span>
		<span class="n">rar_high</span> <span class="o">|=</span> <span class="n">E1000_RAH_AV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">RAL</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">rar_low</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">RAH</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">rar_high</span><span class="p">);</span>
		<span class="n">e1e_flush</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The manageability engine (ME) can lock certain SHRAR registers that</span>
<span class="cm">	 * it is using - those registers are unavailable for use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">rar_entry_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlock_mac</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_FWSM_WLOCK_MAC_MASK</span><span class="p">;</span>
		<span class="n">wlock_mac</span> <span class="o">&gt;&gt;=</span> <span class="n">E1000_FWSM_WLOCK_MAC_SHIFT</span><span class="p">;</span>

		<span class="cm">/* Check if all SHRAR registers are locked */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlock_mac</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">wlock_mac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">wlock_mac</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_acquire_swflag_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">ew32</span><span class="p">(</span><span class="n">SHRAL_PCH_LPT</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rar_low</span><span class="p">);</span>
			<span class="n">e1e_flush</span><span class="p">();</span>
			<span class="n">ew32</span><span class="p">(</span><span class="n">SHRAH_PCH_LPT</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rar_high</span><span class="p">);</span>
			<span class="n">e1e_flush</span><span class="p">();</span>

			<span class="n">e1000_release_swflag_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="cm">/* verify the register updates */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">er32</span><span class="p">(</span><span class="n">SHRAL_PCH_LPT</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">rar_low</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">SHRAH_PCH_LPT</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">rar_high</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Failed to write receive address at index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_check_reset_block_ich8lan - Check if PHY reset is blocked</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Checks if firmware is blocking the reset of the PHY.</span>
<span class="cm"> *  This is a function pointer entry point only called by</span>
<span class="cm"> *  reset routines.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_check_reset_block_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">fwsm</span><span class="p">;</span>

	<span class="n">fwsm</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">fwsm</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_RSPCIPHY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">E1000_BLK_PHY_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_write_smbus_addr - Write SMBus address to PHY needed during Sx states</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Assumes semaphore already acquired.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_write_smbus_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">strap</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">STRAP</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">strap</span> <span class="o">&amp;</span> <span class="n">E1000_STRAP_SMT_FREQ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">E1000_STRAP_SMT_FREQ_SHIFT</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">strap</span> <span class="o">&amp;=</span> <span class="n">E1000_STRAP_SMBUS_ADDRESS_MASK</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_phy_reg_hv_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_SMB_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">phy_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HV_SMB_ADDR_MASK</span><span class="p">;</span>
	<span class="n">phy_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">strap</span> <span class="o">&gt;&gt;</span> <span class="n">E1000_STRAP_SMBUS_ADDRESS_SHIFT</span><span class="p">);</span>
	<span class="n">phy_data</span> <span class="o">|=</span> <span class="n">HV_SMB_ADDR_PEC_EN</span> <span class="o">|</span> <span class="n">HV_SMB_ADDR_VALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_i217</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restore SMBus frequency */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HV_SMB_ADDR_FREQ_MASK</span><span class="p">;</span>
			<span class="n">phy_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
			    <span class="n">HV_SMB_ADDR_FREQ_LOW_SHIFT</span><span class="p">;</span>
			<span class="n">phy_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
			    <span class="p">(</span><span class="n">HV_SMB_ADDR_FREQ_HIGH_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Unsupported SMB frequency in PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">e1000_write_phy_reg_hv_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_SMB_ADDR</span><span class="p">,</span> <span class="n">phy_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_sw_lcd_config_ich8lan - SW-based LCD Configuration</span>
<span class="cm"> *  @hw:   pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  SW should configure the LCD from the NVM extended configuration region</span>
<span class="cm"> *  as a workaround for certain parts.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_sw_lcd_config_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_phy_info</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cnf_size</span><span class="p">,</span> <span class="n">cnf_base_addr</span><span class="p">,</span> <span class="n">sw_cfg_mask</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word_addr</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">phy_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the PHY from the NVM on ICH platforms.  This</span>
<span class="cm">	 * is needed due to an issue where the NVM configuration is</span>
<span class="cm">	 * not properly autoloaded after power transitions.</span>
<span class="cm">	 * Therefore, after each PHY reset, we will load the</span>
<span class="cm">	 * configuration data out of the NVM manually.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_ich8lan</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">E1000_DEV_ID_ICH8_IGP_AMT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">E1000_DEV_ID_ICH8_IGP_C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sw_cfg_mask</span> <span class="o">=</span> <span class="n">E1000_FEXTNVM_SW_CONFIG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fall-thru */</span>
	<span class="k">case</span> <span class="n">e1000_pchlan</span>:
	<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
	<span class="k">case</span> <span class="n">e1000_pch_lpt</span>:
		<span class="n">sw_cfg_mask</span> <span class="o">=</span> <span class="n">E1000_FEXTNVM_SW_CONFIG_ICH8M</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FEXTNVM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">sw_cfg_mask</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure HW does not configure LCD from PHY</span>
<span class="cm">	 * extended configuration before SW configuration</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_LCD_WRITE_ENABLE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">cnf_size</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_SIZE</span><span class="p">);</span>
	<span class="n">cnf_size</span> <span class="o">&amp;=</span> <span class="n">E1000_EXTCNF_SIZE_EXT_PCIE_LENGTH_MASK</span><span class="p">;</span>
	<span class="n">cnf_size</span> <span class="o">&gt;&gt;=</span> <span class="n">E1000_EXTCNF_SIZE_EXT_PCIE_LENGTH_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnf_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">cnf_base_addr</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_EXT_CNF_POINTER_MASK</span><span class="p">;</span>
	<span class="n">cnf_base_addr</span> <span class="o">&gt;&gt;=</span> <span class="n">E1000_EXTCNF_CTRL_EXT_CNF_POINTER_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_OEM_WRITE_ENABLE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">e1000_pchlan</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * HW configures the SMBus address and LEDs when the</span>
<span class="cm">		 * OEM and LCD Write Enable bits are set in the NVM.</span>
<span class="cm">		 * When both NVM bits are cleared, SW will configure</span>
<span class="cm">		 * them instead.</span>
<span class="cm">		 */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_write_smbus_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">LEDCTL</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_write_phy_reg_hv_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LED_CONFIG</span><span class="p">,</span>
							<span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure LCD from extended configuration region. */</span>

	<span class="cm">/* cnf_base_addr is in DWORD */</span>
	<span class="n">word_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">cnf_base_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnf_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_nvm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">word_addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">reg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_nvm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">word_addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
					 <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

		<span class="cm">/* Save off the PHY page for future writes. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">==</span> <span class="n">IGP01E1000_PHY_PAGE_SELECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_page</span> <span class="o">=</span> <span class="n">reg_data</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">reg_addr</span> <span class="o">&amp;=</span> <span class="n">PHY_REG_MASK</span><span class="p">;</span>
		<span class="n">reg_addr</span> <span class="o">|=</span> <span class="n">phy_page</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">reg_addr</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">release:</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_k1_gig_workaround_hv - K1 Si workaround</span>
<span class="cm"> *  @hw:   pointer to the HW structure</span>
<span class="cm"> *  @link: link up bool flag</span>
<span class="cm"> *</span>
<span class="cm"> *  If K1 is enabled for 1Gbps, the MAC might stall when transitioning</span>
<span class="cm"> *  from a lower speed.  This workaround disables K1 whenever link is at 1Gig</span>
<span class="cm"> *  If link is down, the function will restore the default K1 setting located</span>
<span class="cm"> *  in the NVM.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_k1_gig_workaround_hv</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">k1_enable</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">.</span><span class="n">nvm_k1_enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Wrap the whole flow with the sw flag */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* Disable K1 when link is 1Gbps, otherwise use the NVM setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_CS_STATUS</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">status_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

			<span class="n">status_reg</span> <span class="o">&amp;=</span> <span class="n">BM_CS_STATUS_LINK_UP</span> <span class="o">|</span>
			              <span class="n">BM_CS_STATUS_RESOLVED</span> <span class="o">|</span>
			              <span class="n">BM_CS_STATUS_SPEED_MASK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">==</span> <span class="p">(</span><span class="n">BM_CS_STATUS_LINK_UP</span> <span class="o">|</span>
			                   <span class="n">BM_CS_STATUS_RESOLVED</span> <span class="o">|</span>
			                   <span class="n">BM_CS_STATUS_SPEED_1000</span><span class="p">))</span>
				<span class="n">k1_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82577</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_M_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

			<span class="n">status_reg</span> <span class="o">&amp;=</span> <span class="n">HV_M_STATUS_LINK_UP</span> <span class="o">|</span>
			              <span class="n">HV_M_STATUS_AUTONEG_COMPLETE</span> <span class="o">|</span>
			              <span class="n">HV_M_STATUS_SPEED_MASK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">==</span> <span class="p">(</span><span class="n">HV_M_STATUS_LINK_UP</span> <span class="o">|</span>
			                   <span class="n">HV_M_STATUS_AUTONEG_COMPLETE</span> <span class="o">|</span>
			                   <span class="n">HV_M_STATUS_SPEED_1000</span><span class="p">))</span>
				<span class="n">k1_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Link stall fix for link up */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">770</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Link stall fix for link down */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">770</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="mh">0x4100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_configure_k1_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">k1_enable</span><span class="p">);</span>

<span class="nl">release:</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_configure_k1_ich8lan - Configure K1 power state</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @enable: K1 state to configure</span>
<span class="cm"> *</span>
<span class="cm"> *  Configure the K1 power state based on the provided parameter.</span>
<span class="cm"> *  Assumes semaphore already acquired.</span>
<span class="cm"> *</span>
<span class="cm"> *  Success returns 0, Failure returns -E1000_ERR_PHY (-2)</span>
<span class="cm"> **/</span>
<span class="n">s32</span> <span class="nf">e1000_configure_k1_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">k1_enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">kmrn_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_K1_CONFIG</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">kmrn_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">k1_enable</span><span class="p">)</span>
		<span class="n">kmrn_reg</span> <span class="o">|=</span> <span class="n">E1000_KMRNCTRLSTA_K1_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">kmrn_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_KMRNCTRLSTA_K1_ENABLE</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_K1_CONFIG</span><span class="p">,</span>
					       <span class="n">kmrn_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">ctrl_ext</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">);</span>
	<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ctrl_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_CTRL_SPD_1000</span> <span class="o">|</span> <span class="n">E1000_CTRL_SPD_100</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">E1000_CTRL_FRCSPD</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">,</span> <span class="n">ctrl_ext</span> <span class="o">|</span> <span class="n">E1000_CTRL_EXT_SPD_BYPS</span><span class="p">);</span>
	<span class="n">e1e_flush</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="n">ctrl_reg</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">,</span> <span class="n">ctrl_ext</span><span class="p">);</span>
	<span class="n">e1e_flush</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_oem_bits_config_ich8lan - SW-based LCD Configuration</span>
<span class="cm"> *  @hw:       pointer to the HW structure</span>
<span class="cm"> *  @d0_state: boolean if entering d0 or d3 device state</span>
<span class="cm"> *</span>
<span class="cm"> *  SW will configure Gbe Disable and LPLU based on the NVM. The four bits are</span>
<span class="cm"> *  collectively called OEM bits.  The OEM Write Enable bit and SW Config bit</span>
<span class="cm"> *  in NVM determines whether HW should configure LPLU and Gbe Disable.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_oem_bits_config_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">d0_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">oem_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="n">E1000_EXTCNF_CTRL_OEM_WRITE_ENABLE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FEXTNVM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="n">E1000_FEXTNVM_SW_CONFIG_ICH8M</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_OEM_BITS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oem_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">oem_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HV_OEM_BITS_GBE_DIS</span> <span class="o">|</span> <span class="n">HV_OEM_BITS_LPLU</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d0_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_CTRL_GBE_DISABLE</span><span class="p">)</span>
			<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_GBE_DIS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_CTRL_D0A_LPLU</span><span class="p">)</span>
			<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_LPLU</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">E1000_PHY_CTRL_GBE_DISABLE</span> <span class="o">|</span>
			       <span class="n">E1000_PHY_CTRL_NOND0A_GBE_DISABLE</span><span class="p">))</span>
			<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_GBE_DIS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">E1000_PHY_CTRL_D0A_LPLU</span> <span class="o">|</span>
			       <span class="n">E1000_PHY_CTRL_NOND0A_LPLU</span><span class="p">))</span>
			<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_LPLU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set Restart auto-neg to activate the bits */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">d0_state</span> <span class="o">||</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_pchlan</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_RESTART_AN</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_OEM_BITS</span><span class="p">,</span> <span class="n">oem_reg</span><span class="p">);</span>

<span class="nl">release:</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *  e1000_set_mdio_slow_mode_hv - Set slow MDIO access mode</span>
<span class="cm"> *  @hw:   pointer to the HW structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_set_mdio_slow_mode_hv</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_KMRN_MODE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">|=</span> <span class="n">HV_KMRN_MDIO_SLOW</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_KMRN_MODE_CTRL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_hv_phy_workarounds_ich8lan - A series of Phy workarounds to be</span>
<span class="cm"> *  done after every PHY reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_hv_phy_workarounds_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set MDIO slow mode before any other MDIO access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82577</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_set_mdio_slow_mode_hv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82577</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Disable generation of early preamble */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="mh">0x4431</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="cm">/* Preamble tuning for SSC */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_KMRN_FIFO_CTRLSTA</span><span class="p">,</span> <span class="mh">0xA204</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Return registers to default by doing a soft reset then</span>
<span class="cm">		 * writing 0x3140 to the control register.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e1000e_phy_sw_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_CONTROL</span><span class="p">,</span> <span class="mh">0x3140</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Select page 0 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_phy_reg_mdic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PAGE_SELECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure the K1 Si workaround during phy reset assuming there is</span>
<span class="cm">	 * link so that it disables K1 if link is in 1Gbps.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_k1_gig_workaround_hv</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* Workaround for link disconnects on a busy hub in half duplex */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_PORT_GEN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_PORT_GEN_CFG</span><span class="p">,</span> <span class="n">phy_data</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
<span class="nl">release:</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_copy_rx_addrs_to_phy_ich8lan - Copy Rx addresses from MAC to PHY</span>
<span class="cm"> *  @hw:   pointer to the HW structure</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000_copy_rx_addrs_to_phy_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mac_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">phy_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_enable_phy_wakeup_reg_access_bm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="cm">/* Copy both RAL/H (rar_entry_count) and SHRAL/H (+4) to PHY */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">rar_entry_count</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_RAR_L</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_RAR_M</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">mac_reg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>

		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_RAR_H</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">write_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_RAR_CTRL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">mac_reg</span> <span class="o">&amp;</span> <span class="n">E1000_RAH_AV</span><span class="p">)</span>
						 <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">e1000_disable_phy_wakeup_reg_access_bm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>

<span class="nl">release:</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_lv_jumbo_workaround_ich8lan - required for jumbo frame operation</span>
<span class="cm"> *  with 82579 PHY</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @enable: flag to enable/disable workaround when enabling/disabling jumbos</span>
<span class="cm"> **/</span>
<span class="n">s32</span> <span class="nf">e1000_lv_jumbo_workaround_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">e1000_pch2lan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable Rx path while enabling/disabling workaround */</span>
	<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">phy_reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Write Rx addresses (rar_entry_count for RAL/H, +4 for</span>
<span class="cm">		 * SHRAL/H) and initial CRC values to the MAC</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">rar_entry_count</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
			<span class="n">u32</span> <span class="n">addr_high</span><span class="p">,</span> <span class="n">addr_low</span><span class="p">;</span>

			<span class="n">addr_high</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">addr_high</span> <span class="o">&amp;</span> <span class="n">E1000_RAH_AV</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">addr_low</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr_low</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr_low</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr_low</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr_low</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr_high</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr_high</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

			<span class="n">ew32</span><span class="p">(</span><span class="n">PCH_RAICC</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">~</span><span class="n">ether_crc_le</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Write Rx addresses to the PHY */</span>
		<span class="n">e1000_copy_rx_addrs_to_phy_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/* Enable jumbo frame workaround in the MAC */</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FFLT_DBG</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">FFLT_DBG</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>

		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RCTL</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">|=</span> <span class="n">E1000_RCTL_SECRC</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">RCTL</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_CTRL_OFFSET</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_CTRL_OFFSET</span><span class="p">,</span>
						<span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_HD_CTRL</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0xB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_HD_CTRL</span><span class="p">,</span>
						<span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="cm">/* Enable jumbo frame workaround in the PHY */</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7F</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x37</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">776</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3FF</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1A</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">776</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">776</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="mh">0xF100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_PM_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_PM_CTRL</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Write MAC register values back to h/w defaults */</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FFLT_DBG</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">FFLT_DBG</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>

		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RCTL</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_RCTL_SECRC</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">RCTL</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_CTRL_OFFSET</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_CTRL_OFFSET</span><span class="p">,</span>
						<span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_HD_CTRL</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0xB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">E1000_KMRNCTRLSTA_HD_CTRL</span><span class="p">,</span>
						<span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="cm">/* Write PHY register values back to h/w defaults */</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7F</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">776</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3FF</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">776</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">776</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="mh">0x7E00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_PM_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_PM_CTRL</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* re-enable Rx path after enabling/disabling workaround */</span>
	<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="mi">769</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">phy_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_lv_phy_workarounds_ich8lan - A series of Phy workarounds to be</span>
<span class="cm"> *  done after every PHY reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_lv_phy_workarounds_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_pch2lan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set MDIO slow mode before any other MDIO access */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_set_mdio_slow_mode_hv</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_ADDR</span><span class="p">,</span> <span class="n">I82579_MSE_THRESHOLD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="cm">/* set MSE higher to enable link to stay up when noise is high */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_DATA</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_ADDR</span><span class="p">,</span> <span class="n">I82579_MSE_LINK_DOWN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="cm">/* drop link after 5 times MSE threshold was reached */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_DATA</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
<span class="nl">release:</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_k1_gig_workaround_lv - K1 Si workaround</span>
<span class="cm"> *  @hw:   pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Workaround to set the K1 beacon duration for 82579 parts</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_k1_workaround_lv</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mac_reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_pch2lan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set K1 beacon duration based on 1Gbps speed or otherwise */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_M_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HV_M_STATUS_LINK_UP</span> <span class="o">|</span> <span class="n">HV_M_STATUS_AUTONEG_COMPLETE</span><span class="p">))</span>
	    <span class="o">==</span> <span class="p">(</span><span class="n">HV_M_STATUS_LINK_UP</span> <span class="o">|</span> <span class="n">HV_M_STATUS_AUTONEG_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FEXTNVM4</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_FEXTNVM4_BEACON_DURATION_MASK</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_LPI_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status_reg</span> <span class="o">&amp;</span> <span class="n">HV_M_STATUS_SPEED_1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">pm_phy_reg</span><span class="p">;</span>

			<span class="n">mac_reg</span> <span class="o">|=</span> <span class="n">E1000_FEXTNVM4_BEACON_DURATION_8USEC</span><span class="p">;</span>
			<span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I82579_LPI_CTRL_FORCE_PLL_LOCK_COUNT</span><span class="p">;</span>
			<span class="cm">/* LV 1G Packet drop issue wa  */</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_PM_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pm_phy_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
			<span class="n">pm_phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HV_PM_CTRL_PLL_STOP_IN_K1_GIGA</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_PM_CTRL</span><span class="p">,</span> <span class="n">pm_phy_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mac_reg</span> <span class="o">|=</span> <span class="n">E1000_FEXTNVM4_BEACON_DURATION_16USEC</span><span class="p">;</span>
			<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">I82579_LPI_CTRL_FORCE_PLL_LOCK_COUNT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">FEXTNVM4</span><span class="p">,</span> <span class="n">mac_reg</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_LPI_CTRL</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_gate_hw_phy_config_ich8lan - disable PHY config via hardware</span>
<span class="cm"> *  @hw:   pointer to the HW structure</span>
<span class="cm"> *  @gate: boolean set to true to gate, false to ungate</span>
<span class="cm"> *</span>
<span class="cm"> *  Gate/ungate the automatic PHY configuration via hardware; perform</span>
<span class="cm"> *  the configuration via software instead.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">extcnf_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">e1000_pch2lan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">extcnf_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gate</span><span class="p">)</span>
		<span class="n">extcnf_ctrl</span> <span class="o">|=</span> <span class="n">E1000_EXTCNF_CTRL_GATE_PHY_CFG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">extcnf_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_EXTCNF_CTRL_GATE_PHY_CFG</span><span class="p">;</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">EXTCNF_CTRL</span><span class="p">,</span> <span class="n">extcnf_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_lan_init_done_ich8lan - Check for PHY config completion</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Check the appropriate indication the MAC has finished configuring the</span>
<span class="cm"> *  PHY after a software reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_lan_init_done_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">E1000_ICH8_LAN_INIT_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* Wait for basic configuration completes before proceeding */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="n">E1000_STATUS_LAN_INIT_DONE</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loop</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If basic configuration is incomplete before the above loop</span>
<span class="cm">	 * count reaches 0, loading the configuration from NVM will</span>
<span class="cm">	 * leave the PHY in a bad state possibly resulting in no link.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;LAN_INIT_DONE not set, increase timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Clear the Init Done bit for the next init event */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_STATUS_LAN_INIT_DONE</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_post_phy_reset_ich8lan - Perform steps required after a PHY reset</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_post_phy_reset_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allow time for h/w to get to quiescent state after reset */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>

	<span class="cm">/* Perform any necessary post-reset workarounds */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_pchlan</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_hv_phy_workarounds_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_pch2lan</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_lv_phy_workarounds_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the host wakeup bit after lcd reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_PORT_GEN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BM_WUC_HOST_WU_BIT</span><span class="p">;</span>
		<span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_PORT_GEN_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Configure the LCD with the extended configuration region in NVM */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_sw_lcd_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* Configure the LCD with the OEM bits in NVM */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_oem_bits_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ungate automatic PHY configuration on non-managed 82579 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
			<span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Set EEE LPI Update Timer to 200usec */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_ADDR</span><span class="p">,</span>
					  <span class="n">I82579_LPI_UPDATE_TIMER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_DATA</span><span class="p">,</span> <span class="mh">0x1387</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_phy_hw_reset_ich8lan - Performs a PHY reset</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Resets the PHY</span>
<span class="cm"> *  This is a function pointer entry point called by drivers</span>
<span class="cm"> *  or other shared routines.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_phy_hw_reset_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Gate automatic PHY configuration by hardware on non-managed 82579 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span>
		<span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_phy_hw_reset_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">e1000_post_phy_reset_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_set_lplu_state_pchlan - Set Low Power Link Up state</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @active: true to enable LPLU, false to disable</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets the LPLU state according to the active flag.  For PCH, if OEM write</span>
<span class="cm"> *  bit are disabled in the NVM, writing the LPLU bits in the MAC will not set</span>
<span class="cm"> *  the phy speed. This function will manually set the LPLU bit and restart</span>
<span class="cm"> *  auto-neg as hw would do. D3 and D0 LPLU will call the same function</span>
<span class="cm"> *  since it configures the same bit.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_set_lplu_state_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">oem_reg</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_OEM_BITS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oem_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span>
		<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_LPLU</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">oem_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HV_OEM_BITS_LPLU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">oem_reg</span> <span class="o">|=</span> <span class="n">HV_OEM_BITS_RESTART_AN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_OEM_BITS</span><span class="p">,</span> <span class="n">oem_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_set_d0_lplu_state_ich8lan - Set Low Power Linkup D0 state</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @active: true to enable LPLU, false to disable</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets the LPLU D0 state according to the active flag.  When</span>
<span class="cm"> *  activating LPLU this function also disables smart speed</span>
<span class="cm"> *  and vice versa.  LPLU will not be activated unless the</span>
<span class="cm"> *  device autonegotiation advertisement meets standards of</span>
<span class="cm"> *  either 10 or 10/100 or 10/100/1000 at all duplexes.</span>
<span class="cm"> *  This is a function pointer entry point only called by</span>
<span class="cm"> *  PHY setup routines.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_set_d0_lplu_state_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_phy_info</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_ctrl</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_ife</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phy_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_ctrl</span> <span class="o">|=</span> <span class="n">E1000_PHY_CTRL_D0A_LPLU</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">phy_ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call gig speed drop workaround on LPLU before accessing</span>
<span class="cm">		 * any PHY registers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
			<span class="n">e1000e_gig_downshift_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/* When LPLU is enabled, we should disable SmartSpeed */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGP01E1000_PSCFR_SMART_SPEED</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_PHY_CTRL_D0A_LPLU</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">phy_ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * LPLU and SmartSpeed are mutually exclusive.  LPLU is used</span>
<span class="cm">		 * during Dx states where the power conservation is most</span>
<span class="cm">		 * important.  During driver activity we should enable</span>
<span class="cm">		 * SmartSpeed, so performance is maintained.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">smart_speed</span> <span class="o">==</span> <span class="n">e1000_smart_speed_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">|=</span> <span class="n">IGP01E1000_PSCFR_SMART_SPEED</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">smart_speed</span> <span class="o">==</span> <span class="n">e1000_smart_speed_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGP01E1000_PSCFR_SMART_SPEED</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_set_d3_lplu_state_ich8lan - Set Low Power Linkup D3 state</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @active: true to enable LPLU, false to disable</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets the LPLU D3 state according to the active flag.  When</span>
<span class="cm"> *  activating LPLU this function also disables smart speed</span>
<span class="cm"> *  and vice versa.  LPLU will not be activated unless the</span>
<span class="cm"> *  device autonegotiation advertisement meets standards of</span>
<span class="cm"> *  either 10 or 10/100 or 10/100/1000 at all duplexes.</span>
<span class="cm"> *  This is a function pointer entry point only called by</span>
<span class="cm"> *  PHY setup routines.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_set_d3_lplu_state_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_phy_info</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_ctrl</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">phy_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_PHY_CTRL_NOND0A_LPLU</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">phy_ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * LPLU and SmartSpeed are mutually exclusive.  LPLU is used</span>
<span class="cm">		 * during Dx states where the power conservation is most</span>
<span class="cm">		 * important.  During driver activity we should enable</span>
<span class="cm">		 * SmartSpeed, so performance is maintained.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">smart_speed</span> <span class="o">==</span> <span class="n">e1000_smart_speed_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">|=</span> <span class="n">IGP01E1000_PSCFR_SMART_SPEED</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">smart_speed</span> <span class="o">==</span> <span class="n">e1000_smart_speed_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGP01E1000_PSCFR_SMART_SPEED</span><span class="p">;</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span>
					   <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">==</span> <span class="n">E1000_ALL_SPEED_DUPLEX</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">==</span> <span class="n">E1000_ALL_NOT_GIG</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">autoneg_advertised</span> <span class="o">==</span> <span class="n">E1000_ALL_10_SPEED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy_ctrl</span> <span class="o">|=</span> <span class="n">E1000_PHY_CTRL_NOND0A_LPLU</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">phy_ctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call gig speed drop workaround on LPLU before accessing</span>
<span class="cm">		 * any PHY registers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
			<span class="n">e1000e_gig_downshift_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/* When LPLU is enabled, we should disable SmartSpeed */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGP01E1000_PSCFR_SMART_SPEED</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP01E1000_PHY_PORT_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_valid_nvm_bank_detect_ich8lan - finds out the valid bank 0 or 1</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @bank:  pointer to the variable that returns the active bank</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads signature byte from the NVM using the flash access registers.</span>
<span class="cm"> *  Word 0x13 bits 15:14 = 10b indicate a valid signature for that bank.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_valid_nvm_bank_detect_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eecd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bank1_offset</span> <span class="o">=</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">act_offset</span> <span class="o">=</span> <span class="n">E1000_ICH_NVM_SIG_WORD</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sig_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_ich8lan</span>:
	<span class="k">case</span> <span class="n">e1000_ich9lan</span>:
		<span class="n">eecd</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">EECD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">eecd</span> <span class="o">&amp;</span> <span class="n">E1000_EECD_SEC1VAL_VALID_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">E1000_EECD_SEC1VAL_VALID_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">eecd</span> <span class="o">&amp;</span> <span class="n">E1000_EECD_SEC1VAL</span><span class="p">)</span>
				<span class="o">*</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Unable to determine valid NVM bank via EEC - reading flash signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* fall-thru */</span>
	<span class="nl">default:</span>
		<span class="cm">/* set bank to 0 in case flash read fails */</span>
		<span class="o">*</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check bank 0 */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">act_offset</span><span class="p">,</span>
		                                        <span class="o">&amp;</span><span class="n">sig_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sig_byte</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_NVM_VALID_SIG_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">E1000_ICH_NVM_SIG_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check bank 1 */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">act_offset</span> <span class="o">+</span>
		                                        <span class="n">bank1_offset</span><span class="p">,</span>
		                                        <span class="o">&amp;</span><span class="n">sig_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sig_byte</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_NVM_VALID_SIG_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">E1000_ICH_NVM_SIG_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;ERROR: No valid NVM bank present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_read_nvm_ich8lan - Read word(s) from the NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The offset (in bytes) of the word(s) to read.</span>
<span class="cm"> *  @words: Size of data to read in words</span>
<span class="cm"> *  @data: Pointer to the word(s) to read at offset.</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads a word(s) from the NVM using the flash access registers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_read_nvm_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">words</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">act_offset</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">words</span> <span class="o">&gt;</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">words</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;nvm parameter(s) out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_valid_nvm_bank_detect_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bank</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Could not detect valid bank, assuming bank 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">act_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">bank</span><span class="p">)</span> <span class="o">?</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">act_offset</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">].</span><span class="n">modified</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_flash_word_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
								<span class="n">act_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">word</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;NVM read error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_flash_cycle_init_ich8lan - Initialize flash</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  This function does initial flash setup so that a new read/write/erase cycle</span>
<span class="cm"> *  can be started.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_flash_cycle_init_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="n">hsfsts</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>

	<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>

	<span class="cm">/* Check if the flash descriptor is valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">fldesvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Flash descriptor invalid.  SW Sequencing must be used.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear FCERR and DAEL in hw status by writing 1 */</span>
	<span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcerr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">dael</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">,</span> <span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Either we should have a hardware SPI cycle in progress</span>
<span class="cm">	 * bit to check against, in order to start a new cycle or</span>
<span class="cm">	 * FDONE bit should be changed in the hardware so that it</span>
<span class="cm">	 * is 1 after hardware reset, which can then be used as an</span>
<span class="cm">	 * indication whether a cycle is in progress or has been</span>
<span class="cm">	 * completed.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcinprog</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * There is no cycle running at present,</span>
<span class="cm">		 * so we can start a cycle.</span>
<span class="cm">		 * Begin by setting Flash Cycle Done.</span>
<span class="cm">		 */</span>
		<span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">,</span> <span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Otherwise poll for sometime so the current</span>
<span class="cm">		 * cycle has a chance to end before giving up.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ICH_FLASH_READ_COMMAND_TIMEOUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcinprog</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Successful in waiting for previous cycle to timeout,</span>
<span class="cm">			 * now set the Flash Cycle Done.</span>
<span class="cm">			 */</span>
			<span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">,</span> <span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Flash controller busy, cannot get access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_flash_cycle_ich8lan - Starts flash cycle (read/write/erase)</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @timeout: maximum time to wait for completion</span>
<span class="cm"> *</span>
<span class="cm"> *  This function starts a flash cycle and waits for its completion.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_flash_cycle_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_ctrl</span> <span class="n">hsflctl</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="n">hsfsts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Start a cycle by writing 1 in Flash Cycle Go in Hw Flash Control */</span>
	<span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">);</span>
	<span class="n">hsflctl</span><span class="p">.</span><span class="n">hsf_ctrl</span><span class="p">.</span><span class="n">flcgo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">,</span> <span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

	<span class="cm">/* wait till FDONE bit is set to 1 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcerr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_read_flash_word_ich8lan - Read word from flash</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: offset to data location</span>
<span class="cm"> *  @data: pointer to the location for storing the data</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads the flash word at offset into data.  Offset is converted</span>
<span class="cm"> *  to bytes before read.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_read_flash_word_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Must convert offset into bytes. */</span>
	<span class="n">offset</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">e1000_read_flash_data_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_read_flash_byte_ich8lan - Read byte from flash</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The offset of the byte to read.</span>
<span class="cm"> *  @data: Pointer to a byte to store the value read.</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads a single byte from the NVM using the flash access registers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_read_flash_byte_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_flash_data_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">word</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_read_flash_data_ich8lan - Read byte or word from NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The offset (in bytes) of the byte or word to read.</span>
<span class="cm"> *  @size: Size of data to read, 1=byte 2=word</span>
<span class="cm"> *  @data: Pointer to the word to store the value read.</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads a byte or word from the NVM using the flash access registers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_read_flash_data_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="n">hsfsts</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_ctrl</span> <span class="n">hsflctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_linear_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span>  <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">ICH_FLASH_LINEAR_ADDR_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>

	<span class="n">flash_linear_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ICH_FLASH_LINEAR_ADDR_MASK</span> <span class="o">&amp;</span> <span class="n">offset</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">.</span><span class="n">flash_base_addr</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Steps */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_flash_cycle_init_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">);</span>
		<span class="cm">/* 0b/1b corresponds to 1 or 2 byte size, respectively. */</span>
		<span class="n">hsflctl</span><span class="p">.</span><span class="n">hsf_ctrl</span><span class="p">.</span><span class="n">fldbcount</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hsflctl</span><span class="p">.</span><span class="n">hsf_ctrl</span><span class="p">.</span><span class="n">flcycle</span> <span class="o">=</span> <span class="n">ICH_CYCLE_READ</span><span class="p">;</span>
		<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">,</span> <span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

		<span class="n">ew32flash</span><span class="p">(</span><span class="n">ICH_FLASH_FADDR</span><span class="p">,</span> <span class="n">flash_linear_addr</span><span class="p">);</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_flash_cycle_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">ICH_FLASH_READ_COMMAND_TIMEOUT</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if FCERR is set to 1, if set to 1, clear it</span>
<span class="cm">		 * and try the whole sequence a few more times, else</span>
<span class="cm">		 * read in (shift in) the Flash Data0, the order is</span>
<span class="cm">		 * least significant byte first msb to lsb</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flash_data</span> <span class="o">=</span> <span class="n">er32flash</span><span class="p">(</span><span class="n">ICH_FLASH_FDATA0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">flash_data</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">flash_data</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we&#39;ve gotten here, then things are probably</span>
<span class="cm">			 * completely hosed, but if the error condition is</span>
<span class="cm">			 * detected, it won&#39;t hurt to give it another try...</span>
<span class="cm">			 * ICH_FLASH_CYCLE_REPEAT_COUNT times.</span>
<span class="cm">			 */</span>
			<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcerr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Repeat for some time before giving up. */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Timeout error - flash cycle did not complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">ICH_FLASH_CYCLE_REPEAT_COUNT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_write_nvm_ich8lan - Write word(s) to the NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The offset (in bytes) of the word(s) to write.</span>
<span class="cm"> *  @words: Size of data to write in words</span>
<span class="cm"> *  @data: Pointer to the word(s) to write at offset.</span>
<span class="cm"> *</span>
<span class="cm"> *  Writes a byte or word to the NVM using the flash access registers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_write_nvm_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">words</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">words</span> <span class="o">&gt;</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">words</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;nvm parameter(s) out of bounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">].</span><span class="n">modified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_update_nvm_checksum_ich8lan - Update the checksum for NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  The NVM checksum is updated by calling the generic update_nvm_checksum,</span>
<span class="cm"> *  which writes the checksum to the shadow ram.  The changes in the shadow</span>
<span class="cm"> *  ram are then committed to the EEPROM by processing each bank at a time</span>
<span class="cm"> *  checking for the modified bit and writing only the pending changes.</span>
<span class="cm"> *  After a successful commit, the shadow ram is cleared and is ready for</span>
<span class="cm"> *  future writes.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_update_nvm_checksum_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">act_offset</span><span class="p">,</span> <span class="n">new_bank_offset</span><span class="p">,</span> <span class="n">old_bank_offset</span><span class="p">,</span> <span class="n">bank</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_update_nvm_checksum_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_nvm_flash_sw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re writing to the opposite bank so if we&#39;re on bank 1,</span>
<span class="cm">	 * write to bank 0 etc.  We also need to erase the segment that</span>
<span class="cm">	 * is going to be written</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span>  <span class="n">e1000_valid_nvm_bank_detect_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bank</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Could not detect valid bank, assuming bank 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_bank_offset</span> <span class="o">=</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span><span class="p">;</span>
		<span class="n">old_bank_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_erase_flash_bank_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">old_bank_offset</span> <span class="o">=</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span><span class="p">;</span>
		<span class="n">new_bank_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_erase_flash_bank_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E1000_ICH8_SHADOW_RAM_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Determine whether to write the value stored</span>
<span class="cm">		 * in the other NVM bank or a modified value stored</span>
<span class="cm">		 * in the shadow RAM</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modified</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_flash_word_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span>
			                                        <span class="n">old_bank_offset</span><span class="p">,</span>
			                                        <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the word is 0x13, then make sure the signature bits</span>
<span class="cm">		 * (15:14) are 11b until the commit has completed.</span>
<span class="cm">		 * This will allow us to write 10b which indicates the</span>
<span class="cm">		 * signature is valid.  We want to do this after the write</span>
<span class="cm">		 * has completed so that we don&#39;t mark the segment valid</span>
<span class="cm">		 * while the write is still in progress</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">E1000_ICH_NVM_SIG_WORD</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">E1000_ICH_NVM_SIG_MASK</span><span class="p">;</span>

		<span class="cm">/* Convert offset to bytes. */</span>
		<span class="n">act_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">new_bank_offset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* Write the bytes to the new bank. */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_retry_write_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							       <span class="n">act_offset</span><span class="p">,</span>
							       <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_retry_write_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							  <span class="n">act_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
							  <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t bother writing the segment valid bits if sector</span>
<span class="cm">	 * programming failed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Possibly read-only, see e1000e_write_protect_nvm_ich8lan() */</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Flash commit failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally validate the new segment by setting bit 15:14</span>
<span class="cm">	 * to 10b in word 0x13 , this can be done without an</span>
<span class="cm">	 * erase as well since these bits are 11 to start with</span>
<span class="cm">	 * and we need to change bit 14 to 0b</span>
<span class="cm">	 */</span>
	<span class="n">act_offset</span> <span class="o">=</span> <span class="n">new_bank_offset</span> <span class="o">+</span> <span class="n">E1000_ICH_NVM_SIG_WORD</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_flash_word_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">act_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xBFFF</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_retry_write_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						       <span class="n">act_offset</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						       <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * And invalidate the previously valid segment by setting</span>
<span class="cm">	 * its signature word (0x13) high_byte to 0b. This can be</span>
<span class="cm">	 * done without an erase because flash erase sets all bits</span>
<span class="cm">	 * to 1&#39;s. We can write 1&#39;s to 0&#39;s without an erase</span>
<span class="cm">	 */</span>
	<span class="n">act_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_bank_offset</span> <span class="o">+</span> <span class="n">E1000_ICH_NVM_SIG_WORD</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_retry_write_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">act_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>

	<span class="cm">/* Great!  Everything worked, we can now clear the cached entries. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E1000_ICH8_SHADOW_RAM_WORDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">modified</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">shadow_ram</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">release:</span>
	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reload the EEPROM, or else modifications will not appear</span>
<span class="cm">	 * until after the next adapter reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">reload</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;NVM update error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_validate_nvm_checksum_ich8lan - Validate EEPROM checksum</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Check to see if checksum needs to be fixed by reading bit 6 in word 0x19.</span>
<span class="cm"> *  If the bit is 0, that the EEPROM had been modified, but the checksum was not</span>
<span class="cm"> *  calculated, in which case we need to calculate the checksum and set bit 6.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_validate_nvm_checksum_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read 0x19 and check bit 6.  If this bit is 0, the checksum</span>
<span class="cm">	 * needs to be fixed.  This bit is an indication that the NVM</span>
<span class="cm">	 * was prepared by OEM software and did not calculate the</span>
<span class="cm">	 * checksum...a likely scenario.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_nvm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_write_nvm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_update_nvm_checksum</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">e1000e_validate_nvm_checksum_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000e_write_protect_nvm_ich8lan - Make the NVM read-only</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  To prevent malicious write/erase of the NVM, set it to be read-only</span>
<span class="cm"> *  so that the hardware ignores all write/erase cycles of the NVM via</span>
<span class="cm"> *  the flash control registers.  The shadow-ram copy of the NVM will</span>
<span class="cm"> *  still be updated, however any updates to this copy will not stick</span>
<span class="cm"> *  across driver reloads.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000e_write_protect_nvm_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_flash_protected_range</span> <span class="n">pr0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="n">hsfsts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gfpreg</span><span class="p">;</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">gfpreg</span> <span class="o">=</span> <span class="n">er32flash</span><span class="p">(</span><span class="n">ICH_FLASH_GFPREG</span><span class="p">);</span>

	<span class="cm">/* Write-protect GbE Sector of NVM */</span>
	<span class="n">pr0</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er32flash</span><span class="p">(</span><span class="n">ICH_FLASH_PR0</span><span class="p">);</span>
	<span class="n">pr0</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">gfpreg</span> <span class="o">&amp;</span> <span class="n">FLASH_GFPREG_BASE_MASK</span><span class="p">;</span>
	<span class="n">pr0</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">gfpreg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FLASH_GFPREG_BASE_MASK</span><span class="p">);</span>
	<span class="n">pr0</span><span class="p">.</span><span class="n">range</span><span class="p">.</span><span class="n">wpe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ew32flash</span><span class="p">(</span><span class="n">ICH_FLASH_PR0</span><span class="p">,</span> <span class="n">pr0</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lock down a subset of GbE Flash Control Registers, e.g.</span>
<span class="cm">	 * PR0 to prevent the write-protection from being lifted.</span>
<span class="cm">	 * Once FLOCKDN is set, the registers protected by it cannot</span>
<span class="cm">	 * be written until FLOCKDN is cleared by a hardware reset.</span>
<span class="cm">	 */</span>
	<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>
	<span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flockdn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ew32flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">,</span> <span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

	<span class="n">nvm</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_write_flash_data_ich8lan - Writes bytes to the NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The offset (in bytes) of the byte/word to read.</span>
<span class="cm"> *  @size: Size of data to read, 1=byte 2=word</span>
<span class="cm"> *  @data: The byte(s) to write to the NVM.</span>
<span class="cm"> *</span>
<span class="cm"> *  Writes one/two bytes to the NVM using the flash access registers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_write_flash_data_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="n">hsfsts</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_ctrl</span> <span class="n">hsflctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_linear_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">*</span> <span class="mh">0xff</span> <span class="o">||</span>
	    <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">ICH_FLASH_LINEAR_ADDR_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>

	<span class="n">flash_linear_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ICH_FLASH_LINEAR_ADDR_MASK</span> <span class="o">&amp;</span> <span class="n">offset</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">.</span><span class="n">flash_base_addr</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Steps */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_flash_cycle_init_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">);</span>
		<span class="cm">/* 0b/1b corresponds to 1 or 2 byte size, respectively. */</span>
		<span class="n">hsflctl</span><span class="p">.</span><span class="n">hsf_ctrl</span><span class="p">.</span><span class="n">fldbcount</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hsflctl</span><span class="p">.</span><span class="n">hsf_ctrl</span><span class="p">.</span><span class="n">flcycle</span> <span class="o">=</span> <span class="n">ICH_CYCLE_WRITE</span><span class="p">;</span>
		<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">,</span> <span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

		<span class="n">ew32flash</span><span class="p">(</span><span class="n">ICH_FLASH_FADDR</span><span class="p">,</span> <span class="n">flash_linear_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">flash_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">flash_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

		<span class="n">ew32flash</span><span class="p">(</span><span class="n">ICH_FLASH_FDATA0</span><span class="p">,</span> <span class="n">flash_data</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * check if FCERR is set to 1 , if set to 1, clear it</span>
<span class="cm">		 * and try the whole sequence a few more times else done</span>
<span class="cm">		 */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_flash_cycle_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">ICH_FLASH_WRITE_COMMAND_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re here, then things are most likely</span>
<span class="cm">		 * completely hosed, but if the error condition</span>
<span class="cm">		 * is detected, it won&#39;t hurt to give it another</span>
<span class="cm">		 * try...ICH_FLASH_CYCLE_REPEAT_COUNT times.</span>
<span class="cm">		 */</span>
		<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcerr</span><span class="p">)</span>
			<span class="cm">/* Repeat for some time before giving up. */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Timeout error - flash cycle did not complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">ICH_FLASH_CYCLE_REPEAT_COUNT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_write_flash_byte_ich8lan - Write a single byte to NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The index of the byte to read.</span>
<span class="cm"> *  @data: The byte to write to the NVM.</span>
<span class="cm"> *</span>
<span class="cm"> *  Writes a single byte to the NVM using the flash access registers.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_write_flash_byte_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">e1000_write_flash_data_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_retry_write_flash_byte_ich8lan - Writes a single byte to NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @offset: The offset of the byte to write.</span>
<span class="cm"> *  @byte: The byte to write to the NVM.</span>
<span class="cm"> *</span>
<span class="cm"> *  Writes a single byte to the NVM using the flash access registers.</span>
<span class="cm"> *  Goes through a retry algorithm before giving up.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_retry_write_flash_byte_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">program_retries</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_write_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">program_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">program_retries</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">program_retries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Retrying Byte %2.2X at offset %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_write_flash_byte_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_retries</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_erase_flash_bank_ich8lan - Erase a bank (4k) from NVM</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @bank: 0 for first bank, 1 for second bank, etc.</span>
<span class="cm"> *</span>
<span class="cm"> *  Erases the bank specified. Each bank is a 4k block. Banks are 0 based.</span>
<span class="cm"> *  bank N is 4096 * N + flash_reg_addr.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_erase_flash_bank_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_nvm_info</span> <span class="o">*</span><span class="n">nvm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_status</span> <span class="n">hsfsts</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ich8_hws_flash_ctrl</span> <span class="n">hsflctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flash_linear_addr</span><span class="p">;</span>
	<span class="cm">/* bank size is in 16bit words - adjust to bytes */</span>
	<span class="n">u32</span> <span class="n">flash_bank_size</span> <span class="o">=</span> <span class="n">nvm</span><span class="o">-&gt;</span><span class="n">flash_bank_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">j</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">sector_size</span><span class="p">;</span>

	<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine HW Sector size: Read BERASE bits of hw flash status</span>
<span class="cm">	 * register</span>
<span class="cm">	 * 00: The Hw sector is 256 bytes, hence we need to erase 16</span>
<span class="cm">	 *     consecutive sectors.  The start index for the nth Hw sector</span>
<span class="cm">	 *     can be calculated as = bank * 4096 + n * 256</span>
<span class="cm">	 * 01: The Hw sector is 4K bytes, hence we need to erase 1 sector.</span>
<span class="cm">	 *     The start index for the nth Hw sector can be calculated</span>
<span class="cm">	 *     as = bank * 4096</span>
<span class="cm">	 * 10: The Hw sector is 8K bytes, nth sector = bank * 8192</span>
<span class="cm">	 *     (ich9 only, otherwise error condition)</span>
<span class="cm">	 * 11: The Hw sector is 64K bytes, nth sector = bank * 65536</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">berasesz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Hw sector size 256 */</span>
		<span class="n">sector_size</span> <span class="o">=</span> <span class="n">ICH_FLASH_SEG_SIZE_256</span><span class="p">;</span>
		<span class="n">iteration</span> <span class="o">=</span> <span class="n">flash_bank_size</span> <span class="o">/</span> <span class="n">ICH_FLASH_SEG_SIZE_256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sector_size</span> <span class="o">=</span> <span class="n">ICH_FLASH_SEG_SIZE_4K</span><span class="p">;</span>
		<span class="n">iteration</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">sector_size</span> <span class="o">=</span> <span class="n">ICH_FLASH_SEG_SIZE_8K</span><span class="p">;</span>
		<span class="n">iteration</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">sector_size</span> <span class="o">=</span> <span class="n">ICH_FLASH_SEG_SIZE_64K</span><span class="p">;</span>
		<span class="n">iteration</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_NVM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start with the base address, then add the sector offset. */</span>
	<span class="n">flash_linear_addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">.</span><span class="n">flash_base_addr</span><span class="p">;</span>
	<span class="n">flash_linear_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bank</span><span class="p">)</span> <span class="o">?</span> <span class="n">flash_bank_size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">iteration</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* Steps */</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_flash_cycle_init_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Write a value 11 (block Erase) in Flash</span>
<span class="cm">			 * Cycle field in hw flash control</span>
<span class="cm">			 */</span>
			<span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">);</span>
			<span class="n">hsflctl</span><span class="p">.</span><span class="n">hsf_ctrl</span><span class="p">.</span><span class="n">flcycle</span> <span class="o">=</span> <span class="n">ICH_CYCLE_ERASE</span><span class="p">;</span>
			<span class="n">ew16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFCTL</span><span class="p">,</span> <span class="n">hsflctl</span><span class="p">.</span><span class="n">regval</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Write the last 24 bits of an index within the</span>
<span class="cm">			 * block into Flash Linear address field in Flash</span>
<span class="cm">			 * Address.</span>
<span class="cm">			 */</span>
			<span class="n">flash_linear_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">sector_size</span><span class="p">);</span>
			<span class="n">ew32flash</span><span class="p">(</span><span class="n">ICH_FLASH_FADDR</span><span class="p">,</span> <span class="n">flash_linear_addr</span><span class="p">);</span>

			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_flash_cycle_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">ICH_FLASH_ERASE_COMMAND_TIMEOUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Check if FCERR is set to 1.  If 1,</span>
<span class="cm">			 * clear it and try the whole sequence</span>
<span class="cm">			 * a few more times else Done</span>
<span class="cm">			 */</span>
			<span class="n">hsfsts</span><span class="p">.</span><span class="n">regval</span> <span class="o">=</span> <span class="n">er16flash</span><span class="p">(</span><span class="n">ICH_FLASH_HSFSTS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcerr</span><span class="p">)</span>
				<span class="cm">/* repeat for some time before giving up */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hsfsts</span><span class="p">.</span><span class="n">hsf_status</span><span class="p">.</span><span class="n">flcdone</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">ICH_FLASH_CYCLE_REPEAT_COUNT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_valid_led_default_ich8lan - Set the default LED settings</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @data: Pointer to the LED settings</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads the LED default settings from the NVM to data.  If the NVM LED</span>
<span class="cm"> *  settings is all 0&#39;s or F&#39;s, set the LED default to a valid LED default</span>
<span class="cm"> *  setting.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_valid_led_default_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_nvm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">NVM_ID_LED_SETTINGS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;NVM Read Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">ID_LED_RESERVED_0000</span> <span class="o">||</span>
	    <span class="o">*</span><span class="n">data</span> <span class="o">==</span> <span class="n">ID_LED_RESERVED_FFFF</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">ID_LED_DEFAULT_ICH8LAN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_id_led_init_pchlan - store LED configurations</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  PCH does not control LEDs via the LEDCTL register, rather it uses</span>
<span class="cm"> *  the PHY LED configuration register.</span>
<span class="cm"> *</span>
<span class="cm"> *  PCH also does not have an &quot;always on&quot; or &quot;always off&quot; mode which</span>
<span class="cm"> *  complicates the ID feature.  Instead of using the &quot;on&quot; mode to indicate</span>
<span class="cm"> *  in ledctl_mode2 the LEDs to use for ID (see e1000e_id_led_init_generic()),</span>
<span class="cm"> *  use &quot;link_up&quot; mode.  The LEDs will still ID on request if there is no</span>
<span class="cm"> *  link based on logic in e1000_led_[on|off]_pchlan().</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_id_led_init_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">ledctl_on</span> <span class="o">=</span> <span class="n">E1000_LEDCTL_MODE_LINK_UP</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">ledctl_off</span> <span class="o">=</span> <span class="n">E1000_LEDCTL_MODE_LINK_UP</span> <span class="o">|</span> <span class="n">E1000_PHY_LED0_IVRT</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>

	<span class="cm">/* Get default ID LED modes */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">valid_led_default</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_default</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">LEDCTL</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode1</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_default</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode2</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_default</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">E1000_LEDCTL_LED0_MODE_MASK</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ID_LED_ON1_DEF2</span>:
		<span class="k">case</span> <span class="n">ID_LED_ON1_ON2</span>:
		<span class="k">case</span> <span class="n">ID_LED_ON1_OFF2</span>:
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_LED0_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ledctl_on</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ID_LED_OFF1_DEF2</span>:
		<span class="k">case</span> <span class="n">ID_LED_OFF1_ON2</span>:
		<span class="k">case</span> <span class="n">ID_LED_OFF1_OFF2</span>:
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_LED0_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ledctl_off</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Do nothing */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ID_LED_DEF1_ON2</span>:
		<span class="k">case</span> <span class="n">ID_LED_ON1_ON2</span>:
		<span class="k">case</span> <span class="n">ID_LED_OFF1_ON2</span>:
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_LED0_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ledctl_on</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ID_LED_DEF1_OFF2</span>:
		<span class="k">case</span> <span class="n">ID_LED_ON1_OFF2</span>:
		<span class="k">case</span> <span class="n">ID_LED_OFF1_OFF2</span>:
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_LED0_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ledctl_mode2</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ledctl_off</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Do nothing */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_get_bus_info_ich8lan - Get/Set the bus type and width</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  ICH8 use the PCI Express bus, but does not contain a PCI Express Capability</span>
<span class="cm"> *  register, so the the bus width is hard coded.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_get_bus_info_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_bus_info</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_get_bus_info_pcie</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ICH devices are &quot;PCI Express&quot;-ish.  They have</span>
<span class="cm">	 * a configuration space, but do not contain</span>
<span class="cm">	 * PCI Express Capability registers, so bus width</span>
<span class="cm">	 * must be hardcoded.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="n">e1000_bus_width_unknown</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">e1000_bus_width_pcie_x1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_reset_hw_ich8lan - Reset the hardware</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Does a full reset of the hardware which includes a reset of the PHY and</span>
<span class="cm"> *  MAC.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_reset_hw_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">kum_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prevent the PCI-E bus from sticking if there is no TLP connection</span>
<span class="cm">	 * on the last TLP read/write transaction when MAC is reset.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_disable_pcie_master</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;PCI-E Master disable polling has failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Masking off all interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">IMC</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the Transmit and Receive units.  Then delay to allow</span>
<span class="cm">	 * any pending transactions to complete before we hit the MAC</span>
<span class="cm">	 * with the global reset.</span>
<span class="cm">	 */</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">RCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TCTL</span><span class="p">,</span> <span class="n">E1000_TCTL_PSP</span><span class="p">);</span>
	<span class="n">e1e_flush</span><span class="p">();</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">);</span>

	<span class="cm">/* Workaround for ICH8 bit corruption issue in FIFO memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set Tx and Rx buffer allocation to 8k apiece. */</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PBA</span><span class="p">,</span> <span class="n">E1000_PBA_8K</span><span class="p">);</span>
		<span class="cm">/* Set Packet Buffer Size to 16k. */</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PBS</span><span class="p">,</span> <span class="n">E1000_PBS_16K</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save the NVM K1 bit setting */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_read_nvm</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_NVM_K1_CONFIG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kum_cfg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kum_cfg</span> <span class="o">&amp;</span> <span class="n">E1000_NVM_K1_ENABLE</span><span class="p">)</span>
			<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">nvm_k1_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">nvm_k1_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Full-chip reset requires MAC and PHY reset at the same</span>
<span class="cm">		 * time to make sure the interface between MAC and the</span>
<span class="cm">		 * external PHY is reset.</span>
<span class="cm">		 */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">E1000_CTRL_PHY_RST</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Gate automatic PHY configuration by hardware on</span>
<span class="cm">		 * non-managed 82579</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span>
			<span class="n">e1000_gate_hw_phy_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_acquire_swflag_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Issuing a global reset to ich8lan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">|</span> <span class="n">E1000_CTRL_RST</span><span class="p">));</span>
	<span class="cm">/* cannot issue a flush here because it hangs the hardware */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Set Phy Config Counter to 50msec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pch2lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">FEXTNVM3</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_FEXTNVM3_PHY_CFG_COUNTER_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">E1000_FEXTNVM3_PHY_CFG_COUNTER_50MSEC</span><span class="p">;</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">FEXTNVM3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__E1000_ACCESS_SHARED_RESOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">E1000_CTRL_PHY_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_cfg_done</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_post_phy_reset_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For PCH, this write will make sure that any noise</span>
<span class="cm">	 * will be detected as a CRC error and be dropped rather than show up</span>
<span class="cm">	 * as a bad packet to the DMA engine.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">CRC_OFFSET</span><span class="p">,</span> <span class="mh">0x65656565</span><span class="p">);</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">IMC</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">ICR</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">KABGTXD</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">E1000_KABGTXD_BGSQLBIAS</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">KABGTXD</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_init_hw_ich8lan - Initialize the hardware</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Prepares the hardware for transmit and receive by doing the following:</span>
<span class="cm"> *   - initialize hardware bits</span>
<span class="cm"> *   - initialize LED identification</span>
<span class="cm"> *   - setup receive address registers</span>
<span class="cm"> *   - setup flow control</span>
<span class="cm"> *   - setup transmit descriptors</span>
<span class="cm"> *   - clear statistics</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_init_hw_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl_ext</span><span class="p">,</span> <span class="n">txdctl</span><span class="p">,</span> <span class="n">snoop</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">e1000_initialize_hw_bits_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Initialize identification LED */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">id_led_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Error initializing identification LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* This is not fatal and we should not stop init due to this */</span>

	<span class="cm">/* Setup the receive address. */</span>
	<span class="n">e1000e_init_rx_addrs</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">rar_entry_count</span><span class="p">);</span>

	<span class="cm">/* Zero out the Multicast HASH table */</span>
	<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Zeroing the MTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mta_reg_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">E1000_WRITE_REG_ARRAY</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_MTA</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The 82578 Rx buffer will stall if wakeup is enabled in host and</span>
<span class="cm">	 * the ME.  Disable wakeup by clearing the host wakeup bit.</span>
<span class="cm">	 * Reset the phy after disabling host wakeup to reset the Rx buffer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_PORT_GEN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BM_WUC_HOST_WU_BIT</span><span class="p">;</span>
		<span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">BM_PORT_GEN_CFG</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_phy_hw_reset_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup link and flow control */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Set the transmit descriptor write-back policy for both queues */</span>
	<span class="n">txdctl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">txdctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">txdctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">E1000_TXDCTL_WTHRESH</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">E1000_TXDCTL_FULL_TX_DESC_WB</span><span class="p">;</span>
	<span class="n">txdctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">txdctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">E1000_TXDCTL_PTHRESH</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">E1000_TXDCTL_MAX_TX_DESC_PREFETCH</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">txdctl</span><span class="p">);</span>
	<span class="n">txdctl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">txdctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">txdctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">E1000_TXDCTL_WTHRESH</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">E1000_TXDCTL_FULL_TX_DESC_WB</span><span class="p">;</span>
	<span class="n">txdctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">txdctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">E1000_TXDCTL_PTHRESH</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">E1000_TXDCTL_MAX_TX_DESC_PREFETCH</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">txdctl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ICH8 has opposite polarity of no_snoop bits.</span>
<span class="cm">	 * By default, we should use snoop behavior.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
		<span class="n">snoop</span> <span class="o">=</span> <span class="n">PCIE_ICH8_SNOOP_ALL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">snoop</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="n">PCIE_NO_SNOOP_ALL</span><span class="p">);</span>
	<span class="n">e1000e_set_pcie_no_snoop</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">snoop</span><span class="p">);</span>

	<span class="n">ctrl_ext</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">);</span>
	<span class="n">ctrl_ext</span> <span class="o">|=</span> <span class="n">E1000_CTRL_EXT_RO_DIS</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">,</span> <span class="n">ctrl_ext</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear all of the statistics registers (clear on read).  It is</span>
<span class="cm">	 * important that we do this after we have tried to establish link</span>
<span class="cm">	 * because the symbol error count will increment wildly if there</span>
<span class="cm">	 * is no link.</span>
<span class="cm">	 */</span>
	<span class="n">e1000_clear_hw_cntrs_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> *  e1000_initialize_hw_bits_ich8lan - Initialize required hardware bits</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Sets/Clears required hardware bits necessary for correctly setting up the</span>
<span class="cm"> *  hardware for transmit and receive.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_initialize_hw_bits_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Extended Device Control */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="cm">/* Enable PHY low-power state when MAC is at D3 w/o WoL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">E1000_CTRL_EXT_PHYPDEN</span><span class="p">;</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL_EXT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Transmit Descriptor Control 0 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Transmit Descriptor Control 1 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TXDCTL</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Transmit Arbitration Control 0 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">TARC</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TARC</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Transmit Arbitration Control 1 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">TARC</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">TCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_TCTL_MULR</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">TARC</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Device Status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * work-around descriptor data corruption issue during nfs v2 udp</span>
<span class="cm">	 * traffic, just disable the nfs filtering capability</span>
<span class="cm">	 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">RFCTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">E1000_RFCTL_NFSW_DIS</span> <span class="o">|</span> <span class="n">E1000_RFCTL_NFSR_DIS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable IPv6 extension header parsing because some malformed</span>
<span class="cm">	 * IPv6 headers can hang the Rx.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">E1000_RFCTL_IPV6_EX_DIS</span> <span class="o">|</span> <span class="n">E1000_RFCTL_NEW_IPV6_EXT_DIS</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">RFCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_setup_link_ich8lan - Setup flow control and link settings</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Determines which flow control settings to use, then configures flow</span>
<span class="cm"> *  control.  Calls the appropriate media-specific link configuration</span>
<span class="cm"> *  function.  Assuming the adapter has a valid link partner, a valid link</span>
<span class="cm"> *  should be established.  Assumes the hardware has previously been reset</span>
<span class="cm"> *  and the transmitter and receiver are not enabled.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_setup_link_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ICH parts do not have a word in the NVM to determine</span>
<span class="cm">	 * the default flow control setting, so we explicitly</span>
<span class="cm">	 * set it to full.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">==</span> <span class="n">e1000_fc_default</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Workaround h/w hang when Tx flow control enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">e1000_fc_rx_pause</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span> <span class="o">=</span> <span class="n">e1000_fc_full</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save off the requested flow control mode for use later.  Depending</span>
<span class="cm">	 * on the link partner&#39;s capabilities, we may or may not use this mode.</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">requested_mode</span><span class="p">;</span>

	<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;After fix-ups FlowControl is now = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">current_mode</span><span class="p">);</span>

	<span class="cm">/* Continue to configure the copper link. */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_physical_interface</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">FCTTV</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">pause_time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82579</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_i217</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82577</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">FCRTV_PCH</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">refresh_time</span><span class="p">);</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PHY_REG</span><span class="p">(</span><span class="n">BM_PORT_CTRL_PAGE</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
				   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">pause_time</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">e1000e_set_fc_watermarks</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_setup_copper_link_ich8lan - Configure MAC/PHY interface</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Configures the kumeran interface to the PHY to wait the appropriate time</span>
<span class="cm"> *  when polling the PHY, then call the generic setup_copper_link to finish</span>
<span class="cm"> *  configuring the copper link.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_setup_copper_link_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_data</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">E1000_CTRL_SLU</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_CTRL_FRCSPD</span> <span class="o">|</span> <span class="n">E1000_CTRL_FRCDPX</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the mac to wait the maximum time between each iteration</span>
<span class="cm">	 * and increase the max iterations when polling the phy;</span>
<span class="cm">	 * this fixes erroneous timeouts at 10Mbps.</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_TIMEOUTS</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_INBAND_PARAM</span><span class="p">,</span>
	                               <span class="o">&amp;</span><span class="n">reg_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">reg_data</span> <span class="o">|=</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_INBAND_PARAM</span><span class="p">,</span>
	                                <span class="n">reg_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">e1000_phy_igp_3</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_copper_link_setup_igp</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_phy_bm</span>:
	<span class="k">case</span> <span class="n">e1000_phy_82578</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_copper_link_setup_m88</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_phy_82577</span>:
	<span class="k">case</span> <span class="n">e1000_phy_82579</span>:
	<span class="k">case</span> <span class="n">e1000_phy_i217</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_copper_link_setup_82577</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">e1000_phy_ife</span>:
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IFE_PHY_MDIX_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="n">reg_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFE_PMC_AUTO_MDIX</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">mdix</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">reg_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFE_PMC_FORCE_MDIX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">reg_data</span> <span class="o">|=</span> <span class="n">IFE_PMC_FORCE_MDIX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="nl">default:</span>
			<span class="n">reg_data</span> <span class="o">|=</span> <span class="n">IFE_PMC_AUTO_MDIX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IFE_PHY_MDIX_CONTROL</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">e1000e_setup_copper_link</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_get_link_up_info_ich8lan - Get current link speed and duplex</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @speed: pointer to store current link speed</span>
<span class="cm"> *  @duplex: pointer to store the current link duplex</span>
<span class="cm"> *</span>
<span class="cm"> *  Calls the generic get_speed_and_duplex to retrieve the current link</span>
<span class="cm"> *  information and then calls the Kumeran lock loss workaround for links at</span>
<span class="cm"> *  gigabit speeds.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_get_link_up_info_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">speed</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="o">*</span><span class="n">duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_get_speed_and_duplex_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_kmrn_lock_loss_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_kmrn_lock_loss_workaround_ich8lan - Kumeran workaround</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Work-around for 82566 Kumeran PCS lock loss:</span>
<span class="cm"> *  On link status change (i.e. PCI reset, speed change) and link is up and</span>
<span class="cm"> *  speed is gigabit-</span>
<span class="cm"> *    0) if workaround is optionally disabled do nothing</span>
<span class="cm"> *    1) wait 1ms for Kumeran link to come up</span>
<span class="cm"> *    2) check Kumeran Diagnostic register PCS lock loss bit</span>
<span class="cm"> *    3) if not set the link is locked (all is good), otherwise...</span>
<span class="cm"> *    4) reset the PHY</span>
<span class="cm"> *    5) repeat up to 10 times</span>
<span class="cm"> *  Note: this is only called for IGP3 copper when speed is 1gb.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_kmrn_lock_loss_workaround_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_ctrl</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">kmrn_lock_loss_workaround_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure link is up before proceeding.  If not just return.</span>
<span class="cm">	 * Attempting this while link is negotiating fouled up link</span>
<span class="cm">	 * stability</span>
<span class="cm">	 */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_phy_has_link_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read once to clear */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP3_KMRN_DIAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
		<span class="cm">/* and again to get new status */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP3_KMRN_DIAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>

		<span class="cm">/* check for PCS lock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">IGP3_KMRN_DIAG_PCS_LOCK_LOSS</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Issue PHY reset */</span>
		<span class="n">e1000_phy_hw_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Disable GigE link negotiation */</span>
	<span class="n">phy_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">);</span>
	<span class="n">phy_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">E1000_PHY_CTRL_GBE_DISABLE</span> <span class="o">|</span>
		     <span class="n">E1000_PHY_CTRL_NOND0A_GBE_DISABLE</span><span class="p">);</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">phy_ctrl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call gig speed drop workaround on Gig disable before accessing</span>
<span class="cm">	 * any PHY registers</span>
<span class="cm">	 */</span>
	<span class="n">e1000e_gig_downshift_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* unable to acquire PCS lock */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">E1000_ERR_PHY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000e_set_kmrn_lock_loss_workaround_ich8lan - Set Kumeran workaround state</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *  @state: boolean value used to set the current Kumeran workaround state</span>
<span class="cm"> *</span>
<span class="cm"> *  If ICH8, set the current Kumeran workaround state (enabled - true</span>
<span class="cm"> *  /disabled - false).</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000e_set_kmrn_lock_loss_workaround_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						 <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_ich8lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Workaround applies to ICH8 only.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">kmrn_lock_loss_workaround_enabled</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_ipg3_phy_powerdown_workaround_ich8lan - Power down workaround on D3</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Workaround for 82566 power-down on D3 entry:</span>
<span class="cm"> *    1) disable gigabit link</span>
<span class="cm"> *    2) write VR power-down enable</span>
<span class="cm"> *    3) read it back</span>
<span class="cm"> *  Continue if successful, else issue LCD reset and repeat</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000e_igp3_phy_powerdown_workaround_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_phy_igp_3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Try the workaround twice (if needed) */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Disable link */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">E1000_PHY_CTRL_GBE_DISABLE</span> <span class="o">|</span>
			<span class="n">E1000_PHY_CTRL_NOND0A_GBE_DISABLE</span><span class="p">);</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call gig speed drop workaround on Gig disable before</span>
<span class="cm">		 * accessing any PHY registers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
			<span class="n">e1000e_gig_downshift_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/* Write VR power-down enable */</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP3_VR_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGP3_VR_CTRL_DEV_POWERDOWN_MODE_MASK</span><span class="p">;</span>
		<span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP3_VR_CTRL</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">IGP3_VR_CTRL_MODE_SHUTDOWN</span><span class="p">);</span>

		<span class="cm">/* Read it back and test */</span>
		<span class="n">e1e_rphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IGP3_VR_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="n">IGP3_VR_CTRL_DEV_POWERDOWN_MODE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">==</span> <span class="n">IGP3_VR_CTRL_MODE_SHUTDOWN</span><span class="p">)</span> <span class="o">||</span> <span class="n">retry</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Issue PHY reset and repeat at most one more time */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">);</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">CTRL</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">E1000_CTRL_PHY_RST</span><span class="p">);</span>
		<span class="n">retry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000e_gig_downshift_workaround_ich8lan - WoL from S5 stops working</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Steps to take when dropping from 1Gb/s (eg. link cable removal (LSC),</span>
<span class="cm"> *  LPLU, Gig disable, MDIC PHY reset):</span>
<span class="cm"> *    1) Set Kumeran Near-end loopback</span>
<span class="cm"> *    2) Clear Kumeran Near-end loopback</span>
<span class="cm"> *  Should only be called for ICH8[m] devices with any 1G Phy.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000e_gig_downshift_workaround_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">e1000_ich8lan</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_ife</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_read_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_DIAG_OFFSET</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">reg_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">reg_data</span> <span class="o">|=</span> <span class="n">E1000_KMRNCTRLSTA_DIAG_NELPBK</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_DIAG_OFFSET</span><span class="p">,</span>
				       <span class="n">reg_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">reg_data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E1000_KMRNCTRLSTA_DIAG_NELPBK</span><span class="p">;</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_write_kmrn_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">E1000_KMRNCTRLSTA_DIAG_OFFSET</span><span class="p">,</span>
				       <span class="n">reg_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_suspend_workarounds_ich8lan - workarounds needed during S0-&gt;Sx</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  During S0 to Sx transition, it is possible the link remains at gig</span>
<span class="cm"> *  instead of negotiating to a lower speed.  Before going to Sx, set</span>
<span class="cm"> *  &#39;Gig Disable&#39; to force link speed negotiation to a lower speed based on</span>
<span class="cm"> *  the LPLU setting in the NVM or custom setting.  For PCH and newer parts,</span>
<span class="cm"> *  the OEM bits PHY register (LED, GbE disable and LPLU configurations) also</span>
<span class="cm"> *  needs to be written.</span>
<span class="cm"> *  Parts that support (and are linked to a partner which support) EEE in</span>
<span class="cm"> *  100Mbps should disable LPLU since 100Mbps w/ EEE requires less power</span>
<span class="cm"> *  than 10Mbps w/o EEE.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000_suspend_workarounds_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">e1000_dev_spec_ich8lan</span> <span class="o">*</span><span class="n">dev_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_spec</span><span class="p">.</span><span class="n">ich8lan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_ctrl</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">phy_ctrl</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">);</span>
	<span class="n">phy_ctrl</span> <span class="o">|=</span> <span class="n">E1000_PHY_CTRL_GBE_DISABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_i217</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">eee_disable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">eee_advert</span><span class="p">;</span>

			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_ADDR</span><span class="p">,</span>
						  <span class="n">I217_EEE_ADVERTISEMENT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
			<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I82579_EMI_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eee_advert</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Disable LPLU if both link partners support 100BaseT</span>
<span class="cm">			 * EEE and 100Full is advertised on both ends of the</span>
<span class="cm">			 * link.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">eee_advert</span> <span class="o">&amp;</span> <span class="n">I217_EEE_100_SUPPORTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">dev_spec</span><span class="o">-&gt;</span><span class="n">eee_lp_ability</span> <span class="o">&amp;</span>
			     <span class="n">I217_EEE_100_SUPPORTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">autoneg_advertised</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100_FULL</span><span class="p">))</span>
				<span class="n">phy_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_CTRL_D0A_LPLU</span> <span class="o">|</span>
					      <span class="n">E1000_PHY_CTRL_NOND0A_LPLU</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For i217 Intel Rapid Start Technology support,</span>
<span class="cm">		 * when the system is going into Sx and no manageability engine</span>
<span class="cm">		 * is present, the driver must configure proxy to reset only on</span>
<span class="cm">		 * power good.  LPI (Low Power Idle) state must also reset only</span>
<span class="cm">		 * on power good, as well as the MTA (Multicast table array).</span>
<span class="cm">		 * The SMBus release must also be disabled on LCD reset.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* Enable proxy to reset only on power good. */</span>
			<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_PROXY_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
			<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">I217_PROXY_CTRL_AUTO_DISABLE</span><span class="p">;</span>
			<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_PROXY_CTRL</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set bit enable LPI (EEE) to reset only on</span>
<span class="cm">			 * power good.</span>
<span class="cm">			 */</span>
			<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_SxCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
			<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">I217_SxCTRL_ENABLE_LPI_RESET</span><span class="p">;</span>
			<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_SxCTRL</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>

			<span class="cm">/* Disable the SMB release on LCD reset. */</span>
			<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_MEMPWR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
			<span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I217_MEMPWR_DISABLE_SMB_RELEASE</span><span class="p">;</span>
			<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_MEMPWR</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Enable MTA to reset for Intel Rapid Start Technology</span>
<span class="cm">		 * Support</span>
<span class="cm">		 */</span>
		<span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_CGFREG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
		<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">I217_CGFREG_ENABLE_MTA_RESET</span><span class="p">;</span>
		<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_CGFREG</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>

<span class="nl">release:</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">ew32</span><span class="p">(</span><span class="n">PHY_CTRL</span><span class="p">,</span> <span class="n">phy_ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_ich8lan</span><span class="p">)</span>
		<span class="n">e1000e_gig_downshift_workaround_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">e1000_pchlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e1000_oem_bits_config_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Reset PHY to activate OEM bits on 82577/8 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_pchlan</span><span class="p">)</span>
			<span class="n">e1000e_phy_hw_reset_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">e1000_write_smbus_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_resume_workarounds_pchlan - workarounds needed during Sx-&gt;S0</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  During Sx to S0 transitions on non-managed devices or managed devices</span>
<span class="cm"> *  on which PHY resets are not blocked, if the PHY registers cannot be</span>
<span class="cm"> *  accessed properly by the s/w toggle the LANPHYPC value to power cycle</span>
<span class="cm"> *  the PHY.</span>
<span class="cm"> *  On i217, setup Intel Rapid Start Technology.</span>
<span class="cm"> **/</span>
<span class="kt">void</span> <span class="nf">e1000_resume_workarounds_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">e1000_pch2lan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000_init_phy_workarounds_pchlan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Failed to init PHY flow ret_val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For i217 Intel Rapid Start Technology support when the system</span>
<span class="cm">	 * is transitioning from Sx and no manageability engine is present</span>
<span class="cm">	 * configure SMBus to restore on reset, disable proxy, and enable</span>
<span class="cm">	 * the reset on MTA (Multicast table array).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_i217</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">phy_reg</span><span class="p">;</span>

		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Failed to setup iRST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">FWSM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_ICH_FWSM_FW_VALID</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Restore clear on SMB if no manageability engine</span>
<span class="cm">			 * is present</span>
<span class="cm">			 */</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_MEMPWR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
			<span class="n">phy_reg</span> <span class="o">|=</span> <span class="n">I217_MEMPWR_DISABLE_SMB_RELEASE</span><span class="p">;</span>
			<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_MEMPWR</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>

			<span class="cm">/* Disable Proxy */</span>
			<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_PROXY_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Enable reset on MTA */</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1e_rphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_CGFREG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="n">phy_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I217_CGFREG_ENABLE_MTA_RESET</span><span class="p">;</span>
		<span class="n">e1e_wphy_locked</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I217_CGFREG</span><span class="p">,</span> <span class="n">phy_reg</span><span class="p">);</span>
<span class="nl">release:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Error %d in resume workarounds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret_val</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_cleanup_led_ich8lan - Restore the default LED operation</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Return the LED back to the default configuration.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_cleanup_led_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_ife</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IFE_PHY_SPECIAL_CONTROL_LED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">LEDCTL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_default</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_led_on_ich8lan - Turn LEDs on</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Turn on the LEDs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_led_on_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_ife</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IFE_PHY_SPECIAL_CONTROL_LED</span><span class="p">,</span>
				<span class="p">(</span><span class="n">IFE_PSCL_PROBE_MODE</span> <span class="o">|</span> <span class="n">IFE_PSCL_PROBE_LEDS_ON</span><span class="p">));</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">LEDCTL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_mode2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_led_off_ich8lan - Turn LEDs off</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Turn off the LEDs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_led_off_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_ife</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IFE_PHY_SPECIAL_CONTROL_LED</span><span class="p">,</span>
				<span class="p">(</span><span class="n">IFE_PSCL_PROBE_MODE</span> <span class="o">|</span>
				 <span class="n">IFE_PSCL_PROBE_LEDS_OFF</span><span class="p">));</span>

	<span class="n">ew32</span><span class="p">(</span><span class="n">LEDCTL</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_mode1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_setup_led_pchlan - Configures SW controllable LED</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  This prepares the SW controllable LED for use.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_setup_led_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LED_CONFIG</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_mode1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_cleanup_led_pchlan - Restore the default LED operation</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Return the LED back to the default configuration.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_cleanup_led_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LED_CONFIG</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_default</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_led_on_pchlan - Turn LEDs on</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Turn on the LEDs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_led_on_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_mode2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no link, then turn LED on by setting the invert bit</span>
<span class="cm">	 * for each LED that&#39;s mode is &quot;link_up&quot; in ledctl_mode2.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_STATUS_LU</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_LED0_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">led</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_LED0_MODE_MASK</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">E1000_LEDCTL_MODE_LINK_UP</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">led</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_LED0_IVRT</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_LED0_IVRT</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">E1000_PHY_LED0_IVRT</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LED_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_led_off_pchlan - Turn LEDs off</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Turn off the LEDs.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_led_off_pchlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ledctl_mode1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no link, then turn LED off by clearing the invert bit</span>
<span class="cm">	 * for each LED that&#39;s mode is &quot;link_up&quot; in ledctl_mode1.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_STATUS_LU</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_LED0_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">led</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_LED0_MODE_MASK</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">E1000_LEDCTL_MODE_LINK_UP</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">led</span> <span class="o">&amp;</span> <span class="n">E1000_PHY_LED0_IVRT</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">E1000_PHY_LED0_IVRT</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">E1000_PHY_LED0_IVRT</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">e1e_wphy</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LED_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_get_cfg_done_ich8lan - Read config done bit after Full or PHY reset</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Read appropriate register for the config done bit for completion status</span>
<span class="cm"> *  and configure the PHY through s/w for EEPROM-less parts.</span>
<span class="cm"> *</span>
<span class="cm"> *  NOTE: some silicon which is EEPROM-less will fail trying to read the</span>
<span class="cm"> *  config done bit, so only an error is logged and continues.  If we were</span>
<span class="cm"> *  to return with error, EEPROM-less silicon would not be able to be reset</span>
<span class="cm"> *  or change link.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">e1000_get_cfg_done_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">e1000e_get_cfg_done</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Wait for indication from h/w that it has completed basic config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">e1000_ich10lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e1000_lan_init_done_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">e1000e_get_auto_rd_done</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * When auto config read does not complete, do not</span>
<span class="cm">			 * return with an error. This can happen in situations</span>
<span class="cm">			 * where there is no eeprom and prevents getting link.</span>
<span class="cm">			 */</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;Auto Read Done did not complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Clear PHY Reset Asserted bit */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">er32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">E1000_STATUS_PHYRA</span><span class="p">)</span>
		<span class="n">ew32</span><span class="p">(</span><span class="n">STATUS</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">E1000_STATUS_PHYRA</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;PHY Reset Asserted not set - needs delay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If EEPROM is not marked present, init the IGP 3 PHY manually */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">type</span> <span class="o">&lt;=</span> <span class="n">e1000_ich9lan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">er32</span><span class="p">(</span><span class="n">EECD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">E1000_EECD_PRES</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_igp_3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">e1000e_phy_init_script_igp3</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e1000_valid_nvm_bank_detect_ich8lan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bank</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Maybe we should do a basic PHY config */</span>
			<span class="n">e_dbg</span><span class="p">(</span><span class="s">&quot;EEPROM not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">E1000_ERR_CONFIG</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * e1000_power_down_phy_copper_ich8lan - Remove link during PHY power down</span>
<span class="cm"> * @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> * In the case of a PHY power down to save power, or to turn off link during a</span>
<span class="cm"> * driver unload, or wake on lan is not enabled, remove the link.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_power_down_phy_copper_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If the management interface is not enabled, then power down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_mng_mode</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">||</span>
	      <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_reset_block</span><span class="p">(</span><span class="n">hw</span><span class="p">)))</span>
		<span class="n">e1000_power_down_phy_copper</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  e1000_clear_hw_cntrs_ich8lan - Clear statistical counters</span>
<span class="cm"> *  @hw: pointer to the HW structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Clears hardware counters specific to the silicon family and calls</span>
<span class="cm"> *  clear_hw_cntrs_generic to clear all general purpose counters.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">e1000_clear_hw_cntrs_ich8lan</span><span class="p">(</span><span class="k">struct</span> <span class="n">e1000_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">phy_data</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="n">e1000e_clear_hw_cntrs_base</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">er32</span><span class="p">(</span><span class="n">ALGNERRC</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">RXERRC</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">TNCRS</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">CEXTERR</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">TSCTC</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">TSCTFC</span><span class="p">);</span>

	<span class="n">er32</span><span class="p">(</span><span class="n">MGTPRC</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">MGTPDC</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">MGTPTC</span><span class="p">);</span>

	<span class="n">er32</span><span class="p">(</span><span class="n">IAC</span><span class="p">);</span>
	<span class="n">er32</span><span class="p">(</span><span class="n">ICRXOC</span><span class="p">);</span>

	<span class="cm">/* Clear PHY statistics registers */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82578</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82579</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_i217</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">e1000_phy_82577</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">HV_STATS_PAGE</span> <span class="o">&lt;&lt;</span> <span class="n">IGP_PAGE_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_SCC_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_SCC_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_ECOL_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_ECOL_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_MCC_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_MCC_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LATECOL_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_LATECOL_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_COLC_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_COLC_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_DC_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_DC_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_TNCRS_UPPER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg_page</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HV_TNCRS_LOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_data</span><span class="p">);</span>
<span class="nl">release:</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_mac_operations</span> <span class="n">ich8_mac_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* check_mng_mode dependent on mac type */</span>
	<span class="p">.</span><span class="n">check_for_link</span>		<span class="o">=</span> <span class="n">e1000_check_for_copper_link_ich8lan</span><span class="p">,</span>
	<span class="cm">/* cleanup_led dependent on mac type */</span>
	<span class="p">.</span><span class="n">clear_hw_cntrs</span>		<span class="o">=</span> <span class="n">e1000_clear_hw_cntrs_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bus_info</span>		<span class="o">=</span> <span class="n">e1000_get_bus_info_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_lan_id</span>		<span class="o">=</span> <span class="n">e1000_set_lan_id_single_port</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_up_info</span>	<span class="o">=</span> <span class="n">e1000_get_link_up_info_ich8lan</span><span class="p">,</span>
	<span class="cm">/* led_on dependent on mac type */</span>
	<span class="cm">/* led_off dependent on mac type */</span>
	<span class="p">.</span><span class="n">update_mc_addr_list</span>	<span class="o">=</span> <span class="n">e1000e_update_mc_addr_list_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_hw</span>		<span class="o">=</span> <span class="n">e1000_reset_hw_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_hw</span>		<span class="o">=</span> <span class="n">e1000_init_hw_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link</span>		<span class="o">=</span> <span class="n">e1000_setup_link_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_physical_interface</span><span class="o">=</span> <span class="n">e1000_setup_copper_link_ich8lan</span><span class="p">,</span>
	<span class="cm">/* id_led_init dependent on mac type */</span>
	<span class="p">.</span><span class="n">config_collision_dist</span>	<span class="o">=</span> <span class="n">e1000e_config_collision_dist_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rar_set</span>		<span class="o">=</span> <span class="n">e1000e_rar_set_generic</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_phy_operations</span> <span class="n">ich8_phy_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">acquire</span>		<span class="o">=</span> <span class="n">e1000_acquire_swflag_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_reset_block</span>	<span class="o">=</span> <span class="n">e1000_check_reset_block_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cfg_done</span>		<span class="o">=</span> <span class="n">e1000_get_cfg_done_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cable_length</span>	<span class="o">=</span> <span class="n">e1000e_get_cable_length_igp_2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_reg</span>		<span class="o">=</span> <span class="n">e1000e_read_phy_reg_igp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">e1000_release_swflag_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>			<span class="o">=</span> <span class="n">e1000_phy_hw_reset_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_d0_lplu_state</span>	<span class="o">=</span> <span class="n">e1000_set_d0_lplu_state_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_d3_lplu_state</span>	<span class="o">=</span> <span class="n">e1000_set_d3_lplu_state_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_reg</span>		<span class="o">=</span> <span class="n">e1000e_write_phy_reg_igp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_nvm_operations</span> <span class="n">ich8_nvm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">acquire</span>		<span class="o">=</span> <span class="n">e1000_acquire_nvm_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		 	<span class="o">=</span> <span class="n">e1000_read_nvm_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>		<span class="o">=</span> <span class="n">e1000_release_nvm_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reload</span>			<span class="o">=</span> <span class="n">e1000e_reload_nvm_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update</span>			<span class="o">=</span> <span class="n">e1000_update_nvm_checksum_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">valid_led_default</span>	<span class="o">=</span> <span class="n">e1000_valid_led_default_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">validate</span>		<span class="o">=</span> <span class="n">e1000_validate_nvm_checksum_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>			<span class="o">=</span> <span class="n">e1000_write_nvm_ich8lan</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_info</span> <span class="n">e1000_ich8_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">e1000_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FLAG_HAS_WOL</span>
				  <span class="o">|</span> <span class="n">FLAG_IS_ICH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_CTRLEXT_ON_LOAD</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_AMT</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_FLASH</span>
				  <span class="o">|</span> <span class="n">FLAG_APME_IN_WUC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pba</span>			<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_hw_frame_size</span>	<span class="o">=</span> <span class="n">ETH_FRAME_LEN</span> <span class="o">+</span> <span class="n">ETH_FCS_LEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_variants</span>		<span class="o">=</span> <span class="n">e1000_get_variants_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_mac_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_phy_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvm_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_nvm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_info</span> <span class="n">e1000_ich9_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">e1000_ich9lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FLAG_HAS_JUMBO_FRAMES</span>
				  <span class="o">|</span> <span class="n">FLAG_IS_ICH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_WOL</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_CTRLEXT_ON_LOAD</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_AMT</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_FLASH</span>
				  <span class="o">|</span> <span class="n">FLAG_APME_IN_WUC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pba</span>			<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_hw_frame_size</span>	<span class="o">=</span> <span class="n">DEFAULT_JUMBO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_variants</span>		<span class="o">=</span> <span class="n">e1000_get_variants_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_mac_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_phy_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvm_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_nvm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_info</span> <span class="n">e1000_ich10_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">e1000_ich10lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FLAG_HAS_JUMBO_FRAMES</span>
				  <span class="o">|</span> <span class="n">FLAG_IS_ICH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_WOL</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_CTRLEXT_ON_LOAD</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_AMT</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_FLASH</span>
				  <span class="o">|</span> <span class="n">FLAG_APME_IN_WUC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pba</span>			<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_hw_frame_size</span>	<span class="o">=</span> <span class="n">DEFAULT_JUMBO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_variants</span>		<span class="o">=</span> <span class="n">e1000_get_variants_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_mac_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_phy_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvm_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_nvm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_info</span> <span class="n">e1000_pch_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">e1000_pchlan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FLAG_IS_ICH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_WOL</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_CTRLEXT_ON_LOAD</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_AMT</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_FLASH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_JUMBO_FRAMES</span>
				  <span class="o">|</span> <span class="n">FLAG_DISABLE_FC_PAUSE_TIME</span> <span class="cm">/* errata */</span>
				  <span class="o">|</span> <span class="n">FLAG_APME_IN_WUC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags2</span>			<span class="o">=</span> <span class="n">FLAG2_HAS_PHY_STATS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pba</span>			<span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_hw_frame_size</span>	<span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_variants</span>		<span class="o">=</span> <span class="n">e1000_get_variants_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_mac_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_phy_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvm_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_nvm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_info</span> <span class="n">e1000_pch2_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">e1000_pch2lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FLAG_IS_ICH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_WOL</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_CTRLEXT_ON_LOAD</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_AMT</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_FLASH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_JUMBO_FRAMES</span>
				  <span class="o">|</span> <span class="n">FLAG_APME_IN_WUC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags2</span>			<span class="o">=</span> <span class="n">FLAG2_HAS_PHY_STATS</span>
				  <span class="o">|</span> <span class="n">FLAG2_HAS_EEE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pba</span>			<span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_hw_frame_size</span>	<span class="o">=</span> <span class="n">DEFAULT_JUMBO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_variants</span>		<span class="o">=</span> <span class="n">e1000_get_variants_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_mac_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_phy_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvm_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_nvm_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">e1000_info</span> <span class="n">e1000_pch_lpt_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>			<span class="o">=</span> <span class="n">e1000_pch_lpt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">FLAG_IS_ICH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_WOL</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_CTRLEXT_ON_LOAD</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_AMT</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_FLASH</span>
				  <span class="o">|</span> <span class="n">FLAG_HAS_JUMBO_FRAMES</span>
				  <span class="o">|</span> <span class="n">FLAG_APME_IN_WUC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags2</span>			<span class="o">=</span> <span class="n">FLAG2_HAS_PHY_STATS</span>
				  <span class="o">|</span> <span class="n">FLAG2_HAS_EEE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pba</span>			<span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_hw_frame_size</span>	<span class="o">=</span> <span class="n">DEFAULT_JUMBO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_variants</span>		<span class="o">=</span> <span class="n">e1000_get_variants_ich8lan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_mac_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_phy_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nvm_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_nvm_ops</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
