<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgbevf › ethtool.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ethtool.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel 82599 Virtual Function driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cm">/* ethtool support for ixgbevf */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &quot;ixgbevf.h&quot;</span>

<span class="cp">#define IXGBE_ALL_RAR_ENTRIES 16</span>

<span class="cp">#ifdef ETHTOOL_GSTATS</span>
<span class="k">struct</span> <span class="n">ixgbe_stats</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">stat_string</span><span class="p">[</span><span class="n">ETH_GSTRING_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">sizeof_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base_stat_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_reset_offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define IXGBEVF_STAT(m, b, r)  sizeof(((struct ixgbevf_adapter *)0)-&gt;m), \</span>
<span class="cp">			    offsetof(struct ixgbevf_adapter, m),         \</span>
<span class="cp">			    offsetof(struct ixgbevf_adapter, b),         \</span>
<span class="cp">			    offsetof(struct ixgbevf_adapter, r)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbe_stats</span> <span class="n">ixgbe_gstrings_stats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;rx_packets&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">vfgprc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">base_vfgprc</span><span class="p">,</span>
				    <span class="n">stats</span><span class="p">.</span><span class="n">saved_reset_vfgprc</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;tx_packets&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">vfgptc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">base_vfgptc</span><span class="p">,</span>
				    <span class="n">stats</span><span class="p">.</span><span class="n">saved_reset_vfgptc</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;rx_bytes&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">vfgorc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">base_vfgorc</span><span class="p">,</span>
				  <span class="n">stats</span><span class="p">.</span><span class="n">saved_reset_vfgorc</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;tx_bytes&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">vfgotc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">base_vfgotc</span><span class="p">,</span>
				  <span class="n">stats</span><span class="p">.</span><span class="n">saved_reset_vfgotc</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;tx_busy&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">tx_busy</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;multicast&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">vfmprc</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">base_vfmprc</span><span class="p">,</span>
				   <span class="n">stats</span><span class="p">.</span><span class="n">saved_reset_vfmprc</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;rx_csum_offload_good&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">hw_csum_rx_good</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">,</span>
					      <span class="n">zero_base</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;rx_csum_offload_errors&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">hw_csum_rx_error</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">,</span>
						<span class="n">zero_base</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;tx_csum_offload_ctxt&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">hw_csum_tx_good</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">,</span>
					      <span class="n">zero_base</span><span class="p">)},</span>
	<span class="p">{</span><span class="s">&quot;rx_header_split&quot;</span><span class="p">,</span> <span class="n">IXGBEVF_STAT</span><span class="p">(</span><span class="n">rx_hdr_split</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">,</span> <span class="n">zero_base</span><span class="p">)},</span>
<span class="p">};</span>

<span class="cp">#define IXGBE_QUEUE_STATS_LEN 0</span>
<span class="cp">#define IXGBE_GLOBAL_STATS_LEN	ARRAY_SIZE(ixgbe_gstrings_stats)</span>

<span class="cp">#define IXGBEVF_STATS_LEN (IXGBE_GLOBAL_STATS_LEN + IXGBE_QUEUE_STATS_LEN)</span>
<span class="cp">#endif </span><span class="cm">/* ETHTOOL_GSTATS */</span><span class="cp"></span>
<span class="cp">#ifdef ETHTOOL_TEST</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ixgbe_gstrings_test</span><span class="p">[][</span><span class="n">ETH_GSTRING_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Register test  (offline)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Link test   (on/offline)&quot;</span>
<span class="p">};</span>
<span class="cp">#define IXGBE_TEST_LEN (sizeof(ixgbe_gstrings_test) / ETH_GSTRING_LEN)</span>
<span class="cp">#endif </span><span class="cm">/* ETHTOOL_TEST */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link_up</span><span class="p">;</span>

	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">=</span> <span class="n">SUPPORTED_10000baseT_Full</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_DISABLE</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_DUMMY1</span><span class="p">;</span>
	<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">link_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IXGBE_LINK_SPEED_10GB_FULL</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IXGBE_LINK_SPEED_1GB_FULL</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_1000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IXGBE_LINK_SPEED_100_FULL</span>:
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ethtool_cmd_speed_set</span><span class="p">(</span><span class="n">ecmd</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ixgbevf_get_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_set_msglevel</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IXGBE_GET_STAT(_A_, _R_) (_A_-&gt;stats._R_)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ixgbevf_reg_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;IXGBE_VFCTRL&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFSTATUS&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFLINKS&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRXMEMWRAP&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFFRTIMER&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEICR&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEICS&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEIMS&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEIMC&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEIAC&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEIAM&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTEITR&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTIVAR&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VTIVAR_MISC&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDBAL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDBAL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDBAH0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDBAH1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDLEN0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDLEN1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDH0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDH1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDT0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRDT1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRXDCTL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFRXDCTL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFSRRCTL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFSRRCTL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFPSRTYPE&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDBAL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDBAL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDBAH0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDBAH1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDLEN0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDLEN1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDH0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDH1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDT0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDT1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTXDCTL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTXDCTL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDWBAL0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDWBAL1&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDWBAH0&quot;</span><span class="p">,</span>
	<span class="s">&quot;IXGBE_VFTDWBAH1&quot;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_get_regs_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ixgbevf_reg_names</span><span class="p">))</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">regs_buff</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regs_len</span> <span class="o">=</span> <span class="n">ixgbevf_get_regs_len</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regs_len</span><span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">;</span>

	<span class="cm">/* General Registers */</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFCTRL</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFSTATUS</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFLINKS</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRXMEMWRAP</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFFRTIMER</span><span class="p">);</span>

	<span class="cm">/* Interrupt */</span>
	<span class="cm">/* don&#39;t read EICR because it can clear interrupt causes, instead</span>
<span class="cm">	 * read EICS which is a shadow but doesn&#39;t clear EICR */</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEICS</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEICS</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEIMS</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEIMC</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEIAC</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEIAM</span><span class="p">);</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTEITR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTIVAR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VTIVAR_MISC</span><span class="p">);</span>

	<span class="cm">/* Receive DMA */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">14</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRDBAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRDBAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">18</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRDLEN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">20</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRDH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">22</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRDT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">24</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFRXDCTL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">26</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFSRRCTL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/* Receive */</span>
	<span class="n">regs_buff</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFPSRTYPE</span><span class="p">);</span>

	<span class="cm">/* Transmit */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">29</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDBAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">31</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDBAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">33</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDLEN</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">35</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">37</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">39</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTXDCTL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">41</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDWBAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs_buff</span><span class="p">[</span><span class="mi">43</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_VFTDWBAH</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ixgbevf_reg_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">%8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ixgbevf_reg_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">regs_buff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">drvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">ixgbevf_driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">ixgbevf_driver_version</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">drvinfo</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbevf_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgbevf_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_max_pending</span> <span class="o">=</span> <span class="n">IXGBEVF_MAX_RXD</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_max_pending</span> <span class="o">=</span> <span class="n">IXGBEVF_MAX_TXD</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ethtool_ringparam</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgbevf_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_rx_count</span><span class="p">,</span> <span class="n">new_tx_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_mini_pending</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_jumbo_pending</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">new_rx_count</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IXGBEVF_MIN_RXD</span><span class="p">);</span>
	<span class="n">new_rx_count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">new_rx_count</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IXGBEVF_MAX_RXD</span><span class="p">);</span>
	<span class="n">new_rx_count</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">new_rx_count</span><span class="p">,</span> <span class="n">IXGBE_REQ_RX_DESCRIPTOR_MULTIPLE</span><span class="p">);</span>

	<span class="n">new_tx_count</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IXGBEVF_MIN_TXD</span><span class="p">);</span>
	<span class="n">new_tx_count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">new_tx_count</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">IXGBEVF_MAX_TXD</span><span class="p">);</span>
	<span class="n">new_tx_count</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">new_tx_count</span><span class="p">,</span> <span class="n">IXGBE_REQ_TX_DESCRIPTOR_MULTIPLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_tx_count</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">new_rx_count</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing to do */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">__IXGBEVF_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the adapter isn&#39;t up and running then just set the</span>
<span class="cm">	 * new parameters and scurry for the exits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">new_tx_count</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">new_rx_count</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">=</span> <span class="n">new_tx_count</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span> <span class="o">=</span> <span class="n">new_rx_count</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clear_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbevf_ring</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">clear_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_ring</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbevf_ring</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_rx_setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbevf_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
	       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbevf_ring</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">new_tx_count</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbevf_setup_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ixgbevf_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">err_tx_ring_setup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v_idx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
	       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbevf_ring</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_rx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">new_rx_count</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ixgbevf_setup_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ixgbevf_free_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
				<span class="k">goto</span> <span class="n">err_rx_ring_setup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v_idx</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only switch to new rings if all the prior allocations</span>
<span class="cm">	 * and ring setups have succeeded.</span>
<span class="cm">	 */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring_count</span> <span class="o">=</span> <span class="n">new_tx_count</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring_count</span> <span class="o">=</span> <span class="n">new_rx_count</span><span class="p">;</span>

	<span class="cm">/* success! */</span>
	<span class="n">ixgbevf_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">clear_reset</span><span class="p">;</span>

<span class="nl">err_rx_ring_setup:</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ixgbevf_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">err_tx_ring_setup:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>

<span class="nl">err_rx_setup:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">);</span>

<span class="nl">clear_reset:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBEVF_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_get_sset_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stringset</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
	       <span class="k">return</span> <span class="n">IXGBE_TEST_LEN</span><span class="p">;</span>
       <span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
	       <span class="k">return</span> <span class="n">IXGBE_GLOBAL_STATS_LEN</span><span class="p">;</span>
       <span class="nl">default:</span>
	       <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
       <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_get_ethtool_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ethtool_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ixgbevf_update_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_GLOBAL_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span> <span class="o">+</span>
			<span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_offset</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span> <span class="o">+</span>
			<span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base_stat_offset</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span> <span class="o">+</span>
			<span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">saved_reset_offset</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeof_stat</span> <span class="o">==</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">?</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">:</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span>
			  <span class="p">((</span><span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeof_stat</span> <span class="o">==</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">?</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span> <span class="o">:</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span>
			  <span class="p">((</span><span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sizeof_stat</span> <span class="o">==</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="o">?</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span> <span class="o">:</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_get_strings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">stringset</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stringset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_SS_TEST</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">ixgbe_gstrings_test</span><span class="p">,</span>
		       <span class="n">IXGBE_TEST_LEN</span> <span class="o">*</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_SS_STATS</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_GLOBAL_STATS_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ixgbe_gstrings_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stat_string</span><span class="p">,</span>
			       <span class="n">ETH_GSTRING_LEN</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">ETH_GSTRING_LEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_link_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link_up</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_up</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ethtool register test data */</span>
<span class="k">struct</span> <span class="n">ixgbevf_reg_test</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">array_len</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">test_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">write</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* In the hardware, registers are laid out either singly, in arrays</span>
<span class="cm"> * spaced 0x40 bytes apart, or in contiguous tables.  We assume</span>
<span class="cm"> * most tests take place on arrays or single registers (handled</span>
<span class="cm"> * as a single-element array) and special-case the tables.</span>
<span class="cm"> * Table tests are always pattern tests.</span>
<span class="cm"> *</span>
<span class="cm"> * We also make provision for some required setup steps by specifying</span>
<span class="cm"> * registers to be written without any read-back testing.</span>
<span class="cm"> */</span>

<span class="cp">#define PATTERN_TEST	1</span>
<span class="cp">#define SET_READ_TEST	2</span>
<span class="cp">#define WRITE_NO_TEST	3</span>
<span class="cp">#define TABLE32_TEST	4</span>
<span class="cp">#define TABLE64_TEST_LO	5</span>
<span class="cp">#define TABLE64_TEST_HI	6</span>

<span class="cm">/* default VF register test */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbevf_reg_test</span> <span class="n">reg_test_vf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">IXGBE_VFRDBAL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0xFFFFFF80</span><span class="p">,</span> <span class="mh">0xFFFFFF80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFRDBAH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFRDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0x000FFF80</span><span class="p">,</span> <span class="mh">0x000FFFFF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFRXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">WRITE_NO_TEST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IXGBE_RXDCTL_ENABLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFRDT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0x0000FFFF</span><span class="p">,</span> <span class="mh">0x0000FFFF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFRXDCTL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">WRITE_NO_TEST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFTDBAL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0xFFFFFF80</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFTDBAH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">IXGBE_VFTDLEN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">PATTERN_TEST</span><span class="p">,</span> <span class="mh">0x000FFF80</span><span class="p">,</span> <span class="mh">0x000FFF80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">register_test_patterns</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x5A5A5A5A</span><span class="p">,</span> <span class="mh">0xA5A5A5A5</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span>
<span class="p">};</span>

<span class="cp">#define REG_PATTERN_TEST(R, M, W)                                             \</span>
<span class="cp">{                                                                             \</span>
<span class="cp">	u32 pat, val, before;                                                 \</span>
<span class="cp">	for (pat = 0; pat &lt; ARRAY_SIZE(register_test_patterns); pat++) {      \</span>
<span class="cp">		before = readl(adapter-&gt;hw.hw_addr + R);                      \</span>
<span class="cp">		writel((register_test_patterns[pat] &amp; W),                     \</span>
<span class="cp">		       (adapter-&gt;hw.hw_addr + R));                            \</span>
<span class="cp">		val = readl(adapter-&gt;hw.hw_addr + R);                         \</span>
<span class="cp">		if (val != (register_test_patterns[pat] &amp; W &amp; M)) {           \</span>
<span class="cp">			hw_dbg(&amp;adapter-&gt;hw,                                  \</span>
<span class="cp">			&quot;pattern test reg %04X failed: got &quot;                  \</span>
<span class="cp">			&quot;0x%08X expected 0x%08X\n&quot;,                           \</span>
<span class="cp">			R, val, (register_test_patterns[pat] &amp; W &amp; M));       \</span>
<span class="cp">			*data = R;                                            \</span>
<span class="cp">			writel(before, adapter-&gt;hw.hw_addr + R);              \</span>
<span class="cp">			return 1;                                             \</span>
<span class="cp">		}                                                             \</span>
<span class="cp">		writel(before, adapter-&gt;hw.hw_addr + R);                      \</span>
<span class="cp">	}                                                                     \</span>
<span class="cp">}</span>

<span class="cp">#define REG_SET_AND_CHECK(R, M, W)                                            \</span>
<span class="cp">{                                                                             \</span>
<span class="cp">	u32 val, before;                                                      \</span>
<span class="cp">	before = readl(adapter-&gt;hw.hw_addr + R);                              \</span>
<span class="cp">	writel((W &amp; M), (adapter-&gt;hw.hw_addr + R));                           \</span>
<span class="cp">	val = readl(adapter-&gt;hw.hw_addr + R);                                 \</span>
<span class="cp">	if ((W &amp; M) != (val &amp; M)) {                                           \</span>
<span class="cp">		pr_err(&quot;set/check reg %04X test failed: got 0x%08X expected &quot; \</span>
<span class="cp">		       &quot;0x%08X\n&quot;, R, (val &amp; M), (W &amp; M));                    \</span>
<span class="cp">		*data = R;                                                    \</span>
<span class="cp">		writel(before, (adapter-&gt;hw.hw_addr + R));                    \</span>
<span class="cp">		return 1;                                                     \</span>
<span class="cp">	}                                                                     \</span>
<span class="cp">	writel(before, (adapter-&gt;hw.hw_addr + R));                            \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_reg_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ixgbevf_reg_test</span> <span class="o">*</span><span class="n">test</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">test</span> <span class="o">=</span> <span class="n">reg_test_vf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Perform the register test, looping through the test table</span>
<span class="cm">	 * until we either fail or reach the null entry.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">array_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">test_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PATTERN_TEST</span>:
				<span class="n">REG_PATTERN_TEST</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x40</span><span class="p">),</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SET_READ_TEST</span>:
				<span class="n">REG_SET_AND_CHECK</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x40</span><span class="p">),</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WRITE_NO_TEST</span>:
				<span class="n">writel</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span> <span class="o">+</span> <span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span>
				       <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mh">0x40</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TABLE32_TEST</span>:
				<span class="n">REG_PATTERN_TEST</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TABLE64_TEST_LO</span>:
				<span class="n">REG_PATTERN_TEST</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TABLE64_TEST_HI</span>:
				<span class="n">REG_PATTERN_TEST</span><span class="p">((</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span>
						<span class="n">test</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">test</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbevf_diag_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ethtool_test</span> <span class="o">*</span><span class="n">eth_test</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">if_running</span> <span class="o">=</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGBEVF_TESTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eth_test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">ETH_TEST_FL_OFFLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Offline tests */</span>

		<span class="n">hw_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;offline testing starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Link test performed before hardware reset so autoneg doesn&#39;t</span>
<span class="cm">		 * interfere with test result */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbevf_link_test</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="n">eth_test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">if_running</span><span class="p">)</span>
			<span class="cm">/* indicate we&#39;re in test mode */</span>
			<span class="n">dev_close</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ixgbevf_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">hw_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;register testing starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbevf_reg_test</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="n">eth_test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="n">ixgbevf_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBEVF_TESTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">if_running</span><span class="p">)</span>
			<span class="n">dev_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;online testing starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Online tests */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbevf_link_test</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="n">eth_test</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ETH_TEST_FL_FAILED</span><span class="p">;</span>

		<span class="cm">/* Online tests aren&#39;t run; pass by default */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGBEVF_TESTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbevf_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbevf_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev_closed</span><span class="p">)</span>
			<span class="n">ixgbevf_reinit_locked</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">ixgbevf_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>           <span class="o">=</span> <span class="n">ixgbevf_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>            <span class="o">=</span> <span class="n">ixgbevf_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs_len</span>           <span class="o">=</span> <span class="n">ixgbevf_get_regs_len</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_regs</span>               <span class="o">=</span> <span class="n">ixgbevf_get_regs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>             <span class="o">=</span> <span class="n">ixgbevf_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>               <span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>          <span class="o">=</span> <span class="n">ixgbevf_get_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>          <span class="o">=</span> <span class="n">ixgbevf_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span>           <span class="o">=</span> <span class="n">ixgbevf_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span>           <span class="o">=</span> <span class="n">ixgbevf_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">self_test</span>              <span class="o">=</span> <span class="n">ixgbevf_diag_test</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_sset_count</span>         <span class="o">=</span> <span class="n">ixgbevf_get_sset_count</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_strings</span>            <span class="o">=</span> <span class="n">ixgbevf_get_strings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ethtool_stats</span>      <span class="o">=</span> <span class="n">ixgbevf_get_ethtool_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ixgbevf_set_ethtool_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SET_ETHTOOL_OPS</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ixgbevf_ethtool_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
