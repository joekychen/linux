<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgb › ixgb_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ixgb_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel PRO/10GbE Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2008 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  Linux NICS &lt;linux.nics@intel.com&gt;</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/prefetch.h&gt;</span>
<span class="cp">#include &quot;ixgb.h&quot;</span>

<span class="kt">char</span> <span class="n">ixgb_driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ixgb&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">ixgb_driver_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Intel(R) PRO/10GbE Network Driver&quot;</span><span class="p">;</span>

<span class="cp">#define DRIVERNAPI &quot;-NAPI&quot;</span>
<span class="cp">#define DRV_VERSION &quot;1.0.135-k2&quot; DRIVERNAPI</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">ixgb_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRV_VERSION</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ixgb_copyright</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Copyright (c) 1999-2008 Intel Corporation.&quot;</span><span class="p">;</span>

<span class="cp">#define IXGB_CB_LENGTH 256</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">copybreak</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">IXGB_CB_LENGTH</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">copybreak</span><span class="p">,</span>
	<span class="s">&quot;Maximum size of packet that is copied to a new buffer on receive&quot;</span><span class="p">);</span>

<span class="cm">/* ixgb_pci_tbl - PCI Device ID Table</span>
<span class="cm"> *</span>
<span class="cm"> * Wildcard entries (PCI_ANY_ID) should come last</span>
<span class="cm"> * Last entry must be all 0s</span>
<span class="cm"> *</span>
<span class="cm"> * { Vendor ID, Device ID, SubVendor ID, SubDevice ID,</span>
<span class="cm"> *   Class, Class Mask, private data (not used) }</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ixgb_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">INTEL_VENDOR_ID</span><span class="p">,</span> <span class="n">IXGB_DEVICE_ID_82597EX</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTEL_VENDOR_ID</span><span class="p">,</span> <span class="n">IXGB_DEVICE_ID_82597EX_CX4</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTEL_VENDOR_ID</span><span class="p">,</span> <span class="n">IXGB_DEVICE_ID_82597EX_SR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTEL_VENDOR_ID</span><span class="p">,</span> <span class="n">IXGB_DEVICE_ID_82597EX_LR</span><span class="p">,</span>
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/* required last entry */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ixgb_pci_tbl</span><span class="p">);</span>

<span class="cm">/* Local Function Prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">ixgb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_sw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_configure_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_configure_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_setup_rctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_clean_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_clean_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ixgb_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ixgb_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ixgb_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ixgb_clean_tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ixgb_clean_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_alloc_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_vlan_strip_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_vlan_strip_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ixgb_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_restore_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/* for netdump / net console */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="n">ixgb_io_error_detected</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
                             <span class="k">enum</span> <span class="n">pci_channel_state</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="n">ixgb_io_slot_reset</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgb_io_resume</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_error_handlers</span> <span class="n">ixgb_err_handler</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">error_detected</span> <span class="o">=</span> <span class="n">ixgb_io_error_detected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slot_reset</span> <span class="o">=</span> <span class="n">ixgb_io_slot_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ixgb_io_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ixgb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">ixgb_driver_name</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ixgb_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">ixgb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ixgb_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">err_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgb_err_handler</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Intel Corporation, &lt;linux.nics@intel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel(R) PRO/10GbE Network Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="cp">#define DEFAULT_MSG_ENABLE (NETIF_MSG_DRV|NETIF_MSG_PROBE|NETIF_MSG_LINK)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0=none,...,16=all)&quot;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_init_module - Driver Registration Routine</span>
<span class="cm"> *</span>
<span class="cm"> * ixgb_init_module is the first routine called when the driver is</span>
<span class="cm"> * loaded. All it does is register with the PCI subsystem.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">ixgb_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s - version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ixgb_driver_string</span><span class="p">,</span> <span class="n">ixgb_driver_version</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ixgb_copyright</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ixgb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ixgb_init_module</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_exit_module - Driver Exit Cleanup Routine</span>
<span class="cm"> *</span>
<span class="cm"> * ixgb_exit_module is called just before the driver is removed</span>
<span class="cm"> * from memory.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">ixgb_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ixgb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">ixgb_exit_module</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_irq_disable - Mask off interrupt generation on the NIC</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IMC</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_irq_enable - Enable default interrupt generation settings</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">IXGB_INT_RXT0</span> <span class="o">|</span> <span class="n">IXGB_INT_RXDMT0</span> <span class="o">|</span>
		  <span class="n">IXGB_INT_TXDW</span> <span class="o">|</span> <span class="n">IXGB_INT_LSC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">subsystem_vendor_id</span> <span class="o">==</span> <span class="n">SUN_SUBVENDOR_ID</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">IXGB_INT_GPI0</span><span class="p">;</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IMS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ixgb_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">irq_flags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* hardware has been reset, we need to reload some things */</span>

	<span class="n">ixgb_rar_set</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ixgb_set_multi</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ixgb_restore_vlan</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">ixgb_configure_tx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_setup_rctl</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_configure_rx</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_alloc_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">));</span>

	<span class="cm">/* disable interrupts and get the hardware into a known state */</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IMC</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="cm">/* only enable MSI if bus is in PCI-X mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IXGB_STATUS_PCIX_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* proceed to try to request regular interrupt */</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ixgb_intr</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span>
	                  <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span><span class="p">)</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Unable to allocate interrupt Error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">!=</span> <span class="n">max_frame</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">!=</span>
		<span class="p">(</span><span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MFS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IXGB_MFS_SHIFT</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">max_frame</span><span class="p">;</span>

		<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MFS</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&lt;&lt;</span> <span class="n">IXGB_MFS_SHIFT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&gt;</span>
		   <span class="n">IXGB_MAX_ENET_FRAME_SIZE_WITHOUT_FCS</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ctrl0</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl0</span> <span class="o">&amp;</span> <span class="n">IXGB_CTRL0_JFE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ctrl0</span> <span class="o">|=</span> <span class="n">IXGB_CTRL0_JFE</span><span class="p">;</span>
				<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">,</span> <span class="n">ctrl0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">napi_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="n">ixgb_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ixgb_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">kill_watchdog</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* prevent the interrupt handler from restarting watchdog */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">napi_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="cm">/* waiting for NAPI to complete can re-enable interrupts */</span>
	<span class="n">ixgb_irq_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">have_msi</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kill_watchdog</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ixgb_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_clean_tx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_clean_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ixgb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ixgb_adapter_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgb_init_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;ixgb_init_hw failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* restore frame size information */</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MFS</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&lt;&lt;</span> <span class="n">IXGB_MFS_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">&gt;</span>
	    <span class="n">IXGB_MAX_ENET_FRAME_SIZE_WITHOUT_FCS</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ctrl0</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl0</span> <span class="o">&amp;</span> <span class="n">IXGB_CTRL0_JFE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ctrl0</span> <span class="o">|=</span> <span class="n">IXGB_CTRL0_JFE</span><span class="p">;</span>
			<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">,</span> <span class="n">ctrl0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_features_t</span>
<span class="nf">ixgb_fix_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Tx VLAN insertion does not work per HW design when Rx stripping is</span>
<span class="cm">	 * disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">))</span>
		<span class="n">features</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NETIF_F_HW_VLAN_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">features</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev_features_t</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">features</span> <span class="o">^</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NETIF_F_RXCSUM</span><span class="o">|</span><span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_csum</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ixgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ixgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">ixgb_set_speed_duplex</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ixgb_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ixgb_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">ixgb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">ixgb_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ixgb_xmit_frame</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">ixgb_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ixgb_set_multi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">ixgb_set_mac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">ixgb_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">ixgb_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_add_vid</span>	<span class="o">=</span> <span class="n">ixgb_vlan_rx_add_vid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_vlan_rx_kill_vid</span>	<span class="o">=</span> <span class="n">ixgb_vlan_rx_kill_vid</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">ixgb_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">ndo_fix_features</span>       <span class="o">=</span> <span class="n">ixgb_fix_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>       <span class="o">=</span> <span class="n">ixgb_set_features</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_probe - Device Initialization Routine</span>
<span class="cm"> * @pdev: PCI device information struct</span>
<span class="cm"> * @ent: entry in ixgb_pci_tbl</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> *</span>
<span class="cm"> * ixgb_probe initializes an adapter identified by a pci_dev structure.</span>
<span class="cm"> * The OS initialization, configuring of the adapter private structure,</span>
<span class="cm"> * and a hardware reset occur.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ixgb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_using_dac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dma_set_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No usable DMA configuration, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err_dma_mask</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ixgb_driver_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_request_regions</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_etherdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">back</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">msg_enable</span> <span class="o">=</span> <span class="n">netif_msg_init</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">DEFAULT_MSG_ENABLE</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BAR_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">BAR_1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">BAR_5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgb_netdev_ops</span><span class="p">;</span>
	<span class="n">ixgb_set_ethtool_ops</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">netif_napi_add</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">,</span> <span class="n">ixgb_clean</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bd_number</span> <span class="o">=</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setup the private structure */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgb_sw_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sw_init</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">=</span> <span class="n">NETIF_F_SG</span> <span class="o">|</span>
			   <span class="n">NETIF_F_TSO</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_CSUM</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_VLAN_TX</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|</span>
			   <span class="n">NETIF_F_HW_VLAN_FILTER</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">vlan_features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure the EEPROM is good */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgb_validate_eeprom_checksum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;The EEPROM Checksum Is Not Valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_eeprom</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgb_get_ee_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;Invalid MAC Address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_eeprom</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">part_num</span> <span class="o">=</span> <span class="n">ixgb_get_ee_pba_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ixgb_watchdog</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">,</span> <span class="n">ixgb_tx_timeout_task</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>

	<span class="cm">/* carrier off reporting is important to ethtool even BEFORE open */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_info</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
		   <span class="s">&quot;Intel(R) PRO/10GbE Network Connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ixgb_check_options</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="cm">/* reset the hardware with the new settings */</span>

	<span class="n">ixgb_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_register:</span>
<span class="nl">err_sw_init:</span>
<span class="nl">err_eeprom:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_alloc_etherdev:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_request_regions:</span>
<span class="nl">err_dma_mask:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_remove - Device Removal Routine</span>
<span class="cm"> * @pdev: PCI device information struct</span>
<span class="cm"> *</span>
<span class="cm"> * ixgb_remove is called by the PCI subsystem to alert the driver</span>
<span class="cm"> * that it should release a PCI device.  The could be caused by a</span>
<span class="cm"> * Hot-Plug event, or because the driver is going to be removed from</span>
<span class="cm"> * memory.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">ixgb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_addr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_sw_init - Initialize general software structures (struct ixgb_adapter)</span>
<span class="cm"> * @adapter: board private structure to initialize</span>
<span class="cm"> *</span>
<span class="cm"> * ixgb_sw_init initializes the Adapter private data structure.</span>
<span class="cm"> * Fields are initialized based on PCI device information and</span>
<span class="cm"> * OS network device settings (MTU size).</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ixgb_sw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* PCI config space info */</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">subsystem_vendor_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">subsystem_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* + 8 for errata */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGB_DEVICE_ID_82597EX</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGB_DEVICE_ID_82597EX_CX4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGB_DEVICE_ID_82597EX_LR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">IXGB_DEVICE_ID_82597EX_SR</span><span class="p">))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">ixgb_82597</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* should never have loaded on this device */</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;unsupported device id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* enable flow control to be programmed */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fc</span><span class="p">.</span><span class="n">send_xon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_open - Called when a network interface is made active</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative value on failure</span>
<span class="cm"> *</span>
<span class="cm"> * The open entry point is called when a network interface is made</span>
<span class="cm"> * active by the system (IFF_UP).  At this point all resources needed</span>
<span class="cm"> * for transmit and receive operations are allocated, the interrupt</span>
<span class="cm"> * handler is registered with the OS, the watchdog timer is started,</span>
<span class="cm"> * and the stack is notified that the interface is ready.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* allocate transmit descriptors */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgb_setup_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_tx</span><span class="p">;</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* allocate receive descriptors */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgb_setup_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_rx</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ixgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_up</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_up:</span>
	<span class="n">ixgb_free_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_setup_rx:</span>
	<span class="n">ixgb_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_setup_tx:</span>
	<span class="n">ixgb_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_close - Disables a network interface</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0, this is not allowed to fail</span>
<span class="cm"> *</span>
<span class="cm"> * The close entry point is called when an interface is de-activated</span>
<span class="cm"> * by the OS.  The hardware is still under the drivers control, but</span>
<span class="cm"> * needs to be disabled.  A global MAC reset is issued to stop the</span>
<span class="cm"> * hardware, and all transmit and receive resources are freed.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">ixgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">ixgb_free_tx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_free_rx_resources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_setup_tx_resources - allocate Tx resources (Descriptors)</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success, negative on failure</span>
<span class="cm"> **/</span>

<span class="kt">int</span>
<span class="nf">ixgb_setup_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">txdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">txdr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">txdr</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txdr</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Unable to allocate transmit descriptor ring memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* round up to nearest 4K */</span>

	<span class="n">txdr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">txdr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_tx_desc</span><span class="p">);</span>
	<span class="n">txdr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">txdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="n">txdr</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">txdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdr</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txdr</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">txdr</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Unable to allocate transmit descriptor memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txdr</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">txdr</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdr</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_configure_tx - Configure 82597 Transmit Unit after Reset.</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the Tx unit of the MAC after a reset.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_configure_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tdba</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tdlen</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_tx_desc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Setup the Base and Length of the Tx Descriptor Ring</span>
<span class="cm">	 * tx_ring.dma can be either a 32 or 64 bit value</span>
<span class="cm">	 */</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDBAL</span><span class="p">,</span> <span class="p">(</span><span class="n">tdba</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffULL</span><span class="p">));</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDBAH</span><span class="p">,</span> <span class="p">(</span><span class="n">tdba</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDLEN</span><span class="p">,</span> <span class="n">tdlen</span><span class="p">);</span>

	<span class="cm">/* Setup the HW Tx Head and Tail descriptor pointers */</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* don&#39;t set up txdctl, it induces performance problems if configured</span>
<span class="cm">	 * incorrectly */</span>
	<span class="cm">/* Set the Tx Interrupt Delay register */</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TIDV</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_int_delay</span><span class="p">);</span>

	<span class="cm">/* Program the Transmit Control Register */</span>

	<span class="n">tctl</span> <span class="o">=</span> <span class="n">IXGB_TCTL_TCE</span> <span class="o">|</span> <span class="n">IXGB_TCTL_TXEN</span> <span class="o">|</span> <span class="n">IXGB_TCTL_TPDE</span><span class="p">;</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TCTL</span><span class="p">,</span> <span class="n">tctl</span><span class="p">);</span>

	<span class="cm">/* Setup Transmit Descriptor Settings for this adapter */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_cmd_type</span> <span class="o">=</span>
		<span class="n">IXGB_TX_DESC_TYPE</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_int_delay_enable</span> <span class="o">?</span> <span class="n">IXGB_TX_DESC_CMD_IDE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_setup_rx_resources - allocate Rx resources (Descriptors)</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>

<span class="kt">int</span>
<span class="nf">ixgb_setup_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">rxdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Unable to allocate receive descriptor ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Round up to nearest 4K */</span>

	<span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_rx_desc</span><span class="p">);</span>
	<span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>

	<span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Unable to allocate receive descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxdr</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_setup_rctl - configure the receive control register</span>
<span class="cm"> * @adapter: Board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_setup_rctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rctl</span><span class="p">;</span>

	<span class="n">rctl</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">);</span>

	<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">IXGB_RCTL_MO_SHIFT</span><span class="p">);</span>

	<span class="n">rctl</span> <span class="o">|=</span>
		<span class="n">IXGB_RCTL_BAM</span> <span class="o">|</span> <span class="n">IXGB_RCTL_RDMTS_1_2</span> <span class="o">|</span>
		<span class="n">IXGB_RCTL_RXEN</span> <span class="o">|</span> <span class="n">IXGB_RCTL_CFF</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mc_filter_type</span> <span class="o">&lt;&lt;</span> <span class="n">IXGB_RCTL_MO_SHIFT</span><span class="p">);</span>

	<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_SECRC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">&lt;=</span> <span class="n">IXGB_RXBUFFER_2048</span><span class="p">)</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_BSIZE_2048</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">&lt;=</span> <span class="n">IXGB_RXBUFFER_4096</span><span class="p">)</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_BSIZE_4096</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">&lt;=</span> <span class="n">IXGB_RXBUFFER_8192</span><span class="p">)</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_BSIZE_8192</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">&lt;=</span> <span class="n">IXGB_RXBUFFER_16384</span><span class="p">)</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_BSIZE_16384</span><span class="p">;</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">,</span> <span class="n">rctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_configure_rx - Configure 82597 Receive Unit after Reset.</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the Rx unit of the MAC after a reset.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_configure_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">rdba</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rdlen</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">.</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_rx_desc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxcsum</span><span class="p">;</span>

	<span class="cm">/* make sure receives are disabled while setting up the descriptors */</span>

	<span class="n">rctl</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">,</span> <span class="n">rctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IXGB_RCTL_RXEN</span><span class="p">);</span>

	<span class="cm">/* set the Receive Delay Timer Register */</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDTR</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_int_delay</span><span class="p">);</span>

	<span class="cm">/* Setup the Base and Length of the Rx Descriptor Ring */</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDBAL</span><span class="p">,</span> <span class="p">(</span><span class="n">rdba</span> <span class="o">&amp;</span> <span class="mh">0x00000000ffffffffULL</span><span class="p">));</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDBAH</span><span class="p">,</span> <span class="p">(</span><span class="n">rdba</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDLEN</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">);</span>

	<span class="cm">/* Setup the HW Rx Head and Tail Descriptor Pointers */</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* due to the hardware errata with RXDCTL, we are unable to use any of</span>
<span class="cm">	 * the performance enhancing features of it without causing other</span>
<span class="cm">	 * subtle bugs, some of the bugs could include receive length</span>
<span class="cm">	 * corruption at high data rates (WTHRESH &gt; 0) and/or receive</span>
<span class="cm">	 * descriptor ring irregularites (particularly in hardware cache) */</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RXDCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable Receive Checksum Offload for TCP and UDP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_csum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcsum</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RXCSUM</span><span class="p">);</span>
		<span class="n">rxcsum</span> <span class="o">|=</span> <span class="n">IXGB_RXCSUM_TUOFL</span><span class="p">;</span>
		<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RXCSUM</span><span class="p">,</span> <span class="n">rxcsum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable Receives */</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">,</span> <span class="n">rctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_free_tx_resources - Free Tx Resources</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Free all transmit software resources</span>
<span class="cm"> **/</span>

<span class="kt">void</span>
<span class="nf">ixgb_free_tx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">ixgb_clean_tx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">buffer_info</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_unmap_and_free_tx_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped_as_page</span><span class="p">)</span>
			<span class="n">dma_unmap_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				       <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* these fields must always be initialized in tx</span>
<span class="cm">	 * buffer_info-&gt;length = 0;</span>
<span class="cm">	 * buffer_info-&gt;next_to_watch = 0; */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_clean_tx_ring - Free Tx Buffers</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_clean_tx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Free all the Tx ring sk_buffs */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ixgb_unmap_and_free_tx_resource</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Zero out the descriptor ring */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_free_rx_resources - Free Rx Resources</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> *</span>
<span class="cm"> * Free all receive software resources</span>
<span class="cm"> **/</span>

<span class="kt">void</span>
<span class="nf">ixgb_free_rx_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">ixgb_clean_rx_ring</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">);</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span>
			  <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_clean_rx_ring - Free Rx Buffers</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_clean_rx_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Free all the Rx ring sk_buffs */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_buffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Zero out the descriptor ring */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_set_mac - Change the Ethernet Address of the NIC</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> * @p: pointer to an address structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_set_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">ixgb_rar_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_set_multi - Multicast and Promiscuous mode set</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * The set_multi entry point is called whenever the multicast address</span>
<span class="cm"> * list or the network interface flags are updated.  This routine is</span>
<span class="cm"> * responsible for configuring the hardware for proper multicast,</span>
<span class="cm"> * promiscuous mode, and all-multi behavior.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_set_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rctl</span><span class="p">;</span>

	<span class="cm">/* Check for Promiscuous and All Multicast modes */</span>

	<span class="n">rctl</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGB_RCTL_UPE</span> <span class="o">|</span> <span class="n">IXGB_RCTL_MPE</span><span class="p">);</span>
		<span class="cm">/* disable VLAN filtering */</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGB_RCTL_CFIEN</span><span class="p">;</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGB_RCTL_VFE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_MPE</span><span class="p">;</span>
			<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGB_RCTL_UPE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGB_RCTL_UPE</span> <span class="o">|</span> <span class="n">IXGB_RCTL_MPE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* enable VLAN filtering */</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_VFE</span><span class="p">;</span>
		<span class="n">rctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGB_RCTL_CFIEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IXGB_MAX_NUM_MULTICAST_ADDRESSES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rctl</span> <span class="o">|=</span> <span class="n">IXGB_RCTL_MPE</span><span class="p">;</span>
		<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">,</span> <span class="n">rctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">mta</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">IXGB_MAX_NUM_MULTICAST_ADDRESSES</span> <span class="o">*</span>
			      <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mta</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">alloc_failed</span><span class="p">;</span>

		<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RCTL</span><span class="p">,</span> <span class="n">rctl</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">mta</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ixgb_mc_addr_list_update</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mta</span><span class="p">,</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mta</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">alloc_failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_HW_VLAN_RX</span><span class="p">)</span>
		<span class="n">ixgb_vlan_strip_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ixgb_vlan_strip_disable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_watchdog - Timer Call-back</span>
<span class="cm"> * @data: pointer to netdev cast into an unsigned long</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_watchdog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">txdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="n">ixgb_check_for_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ixgb_check_for_bad_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* force the reset path */</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
				    <span class="s">&quot;NIC Link is Up 10 Gbps Full Duplex, Flow Control: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgb_fc_full</span><span class="p">)</span> <span class="o">?</span>
				    <span class="s">&quot;RX/TX&quot;</span> <span class="o">:</span>
				    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgb_fc_rx_pause</span><span class="p">)</span> <span class="o">?</span>
				     <span class="s">&quot;RX&quot;</span> <span class="o">:</span>
				    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fc</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgb_fc_tx_pause</span><span class="p">)</span> <span class="o">?</span>
				    <span class="s">&quot;TX&quot;</span> <span class="o">:</span> <span class="s">&quot;None&quot;</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="n">FULL_DUPLEX</span><span class="p">;</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">link_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;NIC Link is Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ixgb_update_stats</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="n">txdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">txdr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We&#39;ve lost link, so the controller stops DMA,</span>
<span class="cm">			 * but we&#39;ve got queued Tx work that&#39;s never going</span>
<span class="cm">			 * to get done, so reset controller to flush Tx.</span>
<span class="cm">			 * (Do the reset outside of interrupt context). */</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
			<span class="cm">/* return immediately since reset is imminent */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Force detection of hung controller every watchdog period */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">detect_tx_hung</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* generate an interrupt to force clean up of any stragglers */</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ICS</span><span class="p">,</span> <span class="n">IXGB_INT_TXDW</span><span class="p">);</span>

	<span class="cm">/* Reset the timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IXGB_TX_FLAGS_CSUM		0x00000001</span>
<span class="cp">#define IXGB_TX_FLAGS_VLAN		0x00000002</span>
<span class="cp">#define IXGB_TX_FLAGS_TSO		0x00000004</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_tso</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_context_desc</span> <span class="o">*</span><span class="n">context_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ipcss</span><span class="p">,</span> <span class="n">ipcso</span><span class="p">,</span> <span class="n">tucss</span><span class="p">,</span> <span class="n">tucso</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ipcse</span><span class="p">,</span> <span class="n">tucse</span><span class="p">,</span> <span class="n">mss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb_is_gso</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iphdr</span> <span class="o">*</span><span class="n">iph</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_header_cloned</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">tcp_hdrlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
		<span class="n">iph</span> <span class="o">=</span> <span class="n">ip_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">tot_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">=</span> <span class="o">~</span><span class="n">csum_tcpudp_magic</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">saddr</span><span class="p">,</span>
							 <span class="n">iph</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							 <span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ipcss</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">ipcso</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">iph</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ipcse</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tucss</span> <span class="o">=</span> <span class="n">skb_transport_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">tucso</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tcp_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">tucse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">next_to_use</span><span class="p">;</span>
		<span class="n">context_desc</span> <span class="o">=</span> <span class="n">IXGB_CONTEXT_DESC</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">ipcss</span> <span class="o">=</span> <span class="n">ipcss</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">ipcso</span> <span class="o">=</span> <span class="n">ipcso</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">ipcse</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ipcse</span><span class="p">);</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">tucss</span> <span class="o">=</span> <span class="n">tucss</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">tucso</span> <span class="o">=</span> <span class="n">tucso</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">tucse</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tucse</span><span class="p">);</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mss</span><span class="p">);</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="n">hdr_len</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">cmd_type_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
						  <span class="n">IXGB_CONTEXT_DESC_TYPE</span>
						<span class="o">|</span> <span class="n">IXGB_CONTEXT_DESC_CMD_TSE</span>
						<span class="o">|</span> <span class="n">IXGB_CONTEXT_DESC_CMD_IP</span>
						<span class="o">|</span> <span class="n">IXGB_CONTEXT_DESC_CMD_TCP</span>
						<span class="o">|</span> <span class="n">IXGB_CONTEXT_DESC_CMD_IDE</span>
						<span class="o">|</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">hdr_len</span><span class="p">)));</span>


		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">ixgb_tx_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_context_desc</span> <span class="o">*</span><span class="n">context_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">css</span><span class="p">,</span> <span class="n">cso</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">==</span> <span class="n">CHECKSUM_PARTIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
		<span class="n">css</span> <span class="o">=</span> <span class="n">skb_checksum_start_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">cso</span> <span class="o">=</span> <span class="n">css</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum_offset</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">next_to_use</span><span class="p">;</span>
		<span class="n">context_desc</span> <span class="o">=</span> <span class="n">IXGB_CONTEXT_DESC</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">tucss</span> <span class="o">=</span> <span class="n">css</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">tucso</span> <span class="o">=</span> <span class="n">cso</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">tucse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* zero out any previously existing data in one instruction */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">ipcss</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">mss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">context_desc</span><span class="o">-&gt;</span><span class="n">cmd_type_len</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGB_CONTEXT_DESC_TYPE</span>
				    <span class="o">|</span> <span class="n">IXGB_TX_DESC_CMD_IDE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IXGB_MAX_TXD_PWR	14</span>
<span class="cp">#define IXGB_MAX_DATA_PER_TXD	(1&lt;&lt;IXGB_MAX_TXD_PWR)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_tx_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mss</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gso_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nr_frags</span> <span class="o">=</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">IXGB_MAX_DATA_PER_TXD</span><span class="p">);</span>
		<span class="cm">/* Workaround for premature desc write-backs</span>
<span class="cm">		 * in TSO mode.  Append 4-byte sentinel desc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mss</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nr_frags</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">))</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped_as_page</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
						  <span class="n">size</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">dma_error</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">next_to_watch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">nr_frags</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">skb_frag_struct</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>

		<span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">f</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">IXGB_MAX_DATA_PER_TXD</span><span class="p">);</span>

			<span class="cm">/* Workaround for premature desc write-backs</span>
<span class="cm">			 * in TSO mode.  Append 4-byte sentinel desc */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mss</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="p">(</span><span class="n">nr_frags</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				     <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">==</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">))</span>
				<span class="n">size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">mapped_as_page</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span>
				<span class="n">skb_frag_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
						 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">dma_error</span><span class="p">;</span>
			<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">next_to_watch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">len</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">first</span><span class="p">].</span><span class="n">next_to_watch</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">dma_error:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX DMA map failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ixgb_unmap_and_free_tx_resource</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vlan_id</span><span class="p">,</span><span class="kt">int</span> <span class="n">tx_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_type_len</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_cmd_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">popts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGB_TX_FLAGS_TSO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_type_len</span> <span class="o">|=</span> <span class="n">IXGB_TX_DESC_CMD_TSE</span><span class="p">;</span>
		<span class="n">popts</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IXGB_TX_DESC_POPTS_IXSM</span> <span class="o">|</span> <span class="n">IXGB_TX_DESC_POPTS_TXSM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGB_TX_FLAGS_CSUM</span><span class="p">)</span>
		<span class="n">popts</span> <span class="o">|=</span> <span class="n">IXGB_TX_DESC_POPTS_TXSM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">IXGB_TX_FLAGS_VLAN</span><span class="p">)</span>
		<span class="n">cmd_type_len</span> <span class="o">|=</span> <span class="n">IXGB_TX_DESC_CMD_VLE</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGB_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">buff_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">cmd_type_len</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_type_len</span> <span class="o">|</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">popts</span> <span class="o">=</span> <span class="n">popts</span><span class="p">;</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">vlan</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vlan_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">cmd_type_len</span> <span class="o">|=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IXGB_TX_DESC_CMD_EOP</span> <span class="o">|</span> <span class="n">IXGB_TX_DESC_CMD_RS</span><span class="p">);</span>

	<span class="cm">/* Force memory writes to complete before letting h/w</span>
<span class="cm">	 * know there are new descriptors to fetch.  (Only</span>
<span class="cm">	 * applicable for weak-ordered memory model archs,</span>
<span class="cm">	 * such as IA-64). */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ixgb_maybe_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="cm">/* Herbert&#39;s original patch had:</span>
<span class="cm">	 *  smp_mb__after_netif_stop_queue();</span>
<span class="cm">	 * but since that doesn&#39;t exist yet, just open code it. */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/* We need to check again in a case another CPU has just</span>
<span class="cm">	 * made room available. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* A reprieve! */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">restart_queue</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgb_maybe_stop_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
                              <span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__ixgb_maybe_stop_tx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Tx Descriptors needed, worst case */</span>
<span class="cp">#define TXD_USE_COUNT(S) (((S) &gt;&gt; IXGB_MAX_TXD_PWR) + \</span>
<span class="cp">			 (((S) &amp; (IXGB_MAX_DATA_PER_TXD - 1)) ? 1 : 0))</span>
<span class="cp">#define DESC_NEEDED TXD_USE_COUNT(IXGB_MAX_DATA_PER_TXD) </span><span class="cm">/* skb-&gt;date */</span><span class="cp"> + \</span>
<span class="cp">	MAX_SKB_FRAGS * TXD_USE_COUNT(PAGE_SIZE) + 1 </span><span class="cm">/* for context */</span><span class="cp"> \</span>
<span class="cp">	+ 1 </span><span class="cm">/* one more needed for sentinel TSO workaround */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">ixgb_xmit_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vlan_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tso</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ixgb_maybe_stop_tx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
                     <span class="n">DESC_NEEDED</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlan_tx_tag_present</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGB_TX_FLAGS_VLAN</span><span class="p">;</span>
		<span class="n">vlan_id</span> <span class="o">=</span> <span class="n">vlan_tx_tag_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">first</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">next_to_use</span><span class="p">;</span>

	<span class="n">tso</span> <span class="o">=</span> <span class="n">ixgb_tso</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tso</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tso</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGB_TX_FLAGS_TSO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ixgb_tx_csum</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">IXGB_TX_FLAGS_CSUM</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">ixgb_tx_map</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ixgb_tx_queue</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">vlan_id</span><span class="p">,</span> <span class="n">tx_flags</span><span class="p">);</span>
		<span class="cm">/* Make sure there is space in the ring for the next send. */</span>
		<span class="n">ixgb_maybe_stop_tx</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">DESC_NEEDED</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">first</span><span class="p">].</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">.</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_tx_timeout - Respond to a Tx Hang</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Do the reset outside of interrupt context */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_task</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_tx_timeout_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ixgb_adapter</span><span class="p">,</span> <span class="n">tx_timeout_task</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_timeout_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ixgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">ixgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_get_stats - Get System Network Statistics</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the address of the device statistics structure.</span>
<span class="cm"> * The statistics are actually updated from the timer callback.</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">ixgb_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_change_mtu - Change the Maximum Transfer Unit</span>
<span class="cm"> * @netdev: network interface device structure</span>
<span class="cm"> * @new_mtu: new value for maximum frame size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, negative on failure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_frame</span> <span class="o">=</span> <span class="n">new_mtu</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_max_frame</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">ENET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">;</span>

	<span class="cm">/* MTU &lt; 68 is an error for IPv4 traffic, just don&#39;t allow it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">max_frame</span> <span class="o">&gt;</span> <span class="n">IXGB_MAX_JUMBO_FRAME_SIZE</span> <span class="o">+</span> <span class="n">ENET_FCS_LENGTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Invalid MTU setting %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_mtu</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_max_frame</span> <span class="o">==</span> <span class="n">max_frame</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span> <span class="o">=</span> <span class="n">max_frame</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* + 8 for errata */</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_update_stats - Update the board statistics counters.</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="kt">void</span>
<span class="nf">ixgb_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* Prevent stats update while adapter is being reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_channel_offline</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IXGB_MAX_NUM_MULTICAST_ADDRESSES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">multi</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPRCL</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">bcast_l</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">BPRCL</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">bcast_h</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">BPRCH</span><span class="p">);</span>
		<span class="n">u64</span> <span class="n">bcast</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">bcast_h</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">bcast_l</span><span class="p">;</span>

		<span class="n">multi</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPRCH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="cm">/* fix up multicast stats by removing broadcasts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">multi</span> <span class="o">&gt;=</span> <span class="n">bcast</span><span class="p">)</span>
			<span class="n">multi</span> <span class="o">-=</span> <span class="n">bcast</span><span class="p">;</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mprcl</span> <span class="o">+=</span> <span class="p">(</span><span class="n">multi</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mprch</span> <span class="o">+=</span> <span class="p">(</span><span class="n">multi</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bprcl</span> <span class="o">+=</span> <span class="n">bcast_l</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bprch</span> <span class="o">+=</span> <span class="n">bcast_h</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mprcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPRCL</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mprch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPRCH</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bprcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">BPRCL</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bprch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">BPRCH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tprl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TPRL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tprh</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TPRH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gprcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPRCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gprch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPRCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">uprcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">UPRCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">uprch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">UPRCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vprcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">VPRCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vprch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">VPRCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">jprcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">JPRCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">jprch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">JPRCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gorcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GORCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gorch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GORCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">torl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TORL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">torh</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TORH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rnbc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RNBC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ruc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RUC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">roc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ROC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rlec</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RLEC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">crcerrs</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">CRCERRS</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">icbc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ICBC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ecbc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ECBC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mpc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tptl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TPTL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tpth</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TPTH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gptcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gptch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bptcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">BPTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">bptch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">BPTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mptcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mptch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MPTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">uptcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">UPTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">uptch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">UPTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vptcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">VPTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vptch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">VPTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">jptcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">JPTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">jptch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">JPTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gotcl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GOTCL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gotch</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">GOTCH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">totl</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TOTL</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">toth</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TOTH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">DC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">plt64c</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLT64C</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tsctc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TSCTC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tsctfc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TSCTFC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ibic</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IBIC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rfc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RFC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">lfc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">LFC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pfrc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">PFRC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pftc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">PFTC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mcfrc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MCFRC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mcftc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">MCFTC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xonrxc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">XONRXC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xontxc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">XONTXC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xoffrxc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">XOFFRXC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">xofftxc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">XOFFTXC</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rjc</span> <span class="o">+=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RJC</span><span class="p">);</span>

	<span class="cm">/* Fill out the OS statistics structure */</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gprcl</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gptcl</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gorcl</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">gotcl</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mprcl</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ignore RLEC as it reports errors for padded (&lt;64bytes) frames</span>
<span class="cm">	 * with a length in the type/len field */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span>
	    <span class="cm">/* adapter-&gt;stats.rnbc + */</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">crcerrs</span> <span class="o">+</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ruc</span> <span class="o">+</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">roc</span> <span class="cm">/*+ adapter-&gt;stats.rlec */</span>  <span class="o">+</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">icbc</span> <span class="o">+</span>
	    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ecbc</span> <span class="o">+</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mpc</span><span class="p">;</span>

	<span class="cm">/* see above</span>
<span class="cm">	 * netdev-&gt;stats.rx_length_errors = adapter-&gt;stats.rlec;</span>
<span class="cm">	 */</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">crcerrs</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mpc</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mpc</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mpc</span><span class="p">;</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IXGB_MAX_INTR 10</span>
<span class="cm">/**</span>
<span class="cm"> * ixgb_intr - Interrupt Handler</span>
<span class="cm"> * @irq: interrupt number</span>
<span class="cm"> * @data: pointer to a network interface device structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ixgb_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">icr</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ICR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">icr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>  <span class="cm">/* Not our interrupt */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">icr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IXGB_INT_RXSEQ</span> <span class="o">|</span> <span class="n">IXGB_INT_LSC</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">napi_schedule_prep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Disable interrupts and register for poll. The flush</span>
<span class="cm">		  of the posted write is intentionally left out.</span>
<span class="cm">		*/</span>

		<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IMC</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">__napi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">napi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_clean - NAPI Rx polling callback</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">napi_struct</span> <span class="o">*</span><span class="n">napi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">budget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">napi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ixgb_adapter</span><span class="p">,</span> <span class="n">napi</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">work_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ixgb_clean_tx_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ixgb_clean_rx_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work_done</span><span class="p">,</span> <span class="n">budget</span><span class="p">);</span>

	<span class="cm">/* If budget not fully consumed, exit the polling mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work_done</span> <span class="o">&lt;</span> <span class="n">budget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">napi_complete</span><span class="p">(</span><span class="n">napi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">ixgb_irq_enable</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">work_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_clean_tx_irq - Reclaim resources after transmit completes</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">ixgb_clean_tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">eop_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">eop</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">;</span>
	<span class="n">eop</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_to_watch</span><span class="p">;</span>
	<span class="n">eop_desc</span> <span class="o">=</span> <span class="n">IXGB_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">eop</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">eop_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IXGB_TX_DESC_STATUS_DD</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rmb</span><span class="p">();</span> <span class="cm">/* read buffer_info after eop_desc */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cleaned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="o">!</span><span class="n">cleaned</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">IXGB_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">popts</span> <span class="o">&amp;</span>
			   <span class="p">(</span><span class="n">IXGB_TX_DESC_POPTS_TXSM</span> <span class="o">|</span>
			    <span class="n">IXGB_TX_DESC_POPTS_IXSM</span><span class="p">))</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_csum_tx_good</span><span class="o">++</span><span class="p">;</span>

			<span class="n">ixgb_unmap_and_free_tx_resource</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">);</span>

			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">cleaned</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">eop</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">eop</span> <span class="o">=</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next_to_watch</span><span class="p">;</span>
		<span class="n">eop_desc</span> <span class="o">=</span> <span class="n">IXGB_TX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ring</span><span class="p">,</span> <span class="n">eop</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cleaned</span> <span class="o">&amp;&amp;</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">DESC_NEEDED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Make sure that anybody stopping the queue after this</span>
<span class="cm">		 * sees the new next_to_clean. */</span>
		<span class="n">smp_mb</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">netdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">__IXGB_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">restart_queue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">detect_tx_hung</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* detect a transmit hang in hardware, this serializes the</span>
<span class="cm">		 * check with the clearing of time_stamp and movement of i */</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">detect_tx_hung</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">eop</span><span class="p">].</span><span class="n">time_stamp</span> <span class="o">&amp;&amp;</span>
		   <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">eop</span><span class="p">].</span><span class="n">time_stamp</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
		        <span class="n">IXGB_STATUS_TXOFF</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* detected Tx unit hang */</span>
			<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
				  <span class="s">&quot;Detected Tx Unit Hang</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  TDH                  &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  TDT                  &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  next_to_use          &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  next_to_clean        &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;buffer_info[next_to_clean]</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  time_stamp           &lt;%lx&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  next_to_watch        &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  jiffies              &lt;%lx&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
				  <span class="s">&quot;  next_to_watch.status &lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDH</span><span class="p">),</span>
				  <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">TDT</span><span class="p">),</span>
				  <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">,</span>
				  <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">,</span>
				  <span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">eop</span><span class="p">].</span><span class="n">time_stamp</span><span class="p">,</span>
				  <span class="n">eop</span><span class="p">,</span>
				  <span class="n">jiffies</span><span class="p">,</span>
				  <span class="n">eop_desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cleaned</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_rx_checksum - Receive Checksum Offload for 82597.</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> * @rx_desc: receive descriptor</span>
<span class="cm"> * @sk_buff: socket buffer with received data</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_rx_checksum</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
                 <span class="k">struct</span> <span class="n">ixgb_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span>
                 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Ignore Checksum bit is set OR</span>
<span class="cm">	 * TCP Checksum has not been calculated</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IXGB_RX_DESC_STATUS_IXSM</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IXGB_RX_DESC_STATUS_TCPCS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* At this point we know the hardware did the TCP checksum */</span>
	<span class="cm">/* now look at the TCP checksum error bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&amp;</span> <span class="n">IXGB_RX_DESC_ERRORS_TCPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* let the stack verify checksum errors */</span>
		<span class="n">skb_checksum_none_assert</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_csum_rx_error</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TCP checksum is good */</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_csum_rx_good</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this should improve performance for small packets with large amounts</span>
<span class="cm"> * of reassembly being done in the stack</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgb_check_copybreak</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">length</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">copybreak</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">new_skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb_copy_to_linear_data_offset</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="o">-</span><span class="n">NET_IP_ALIGN</span><span class="p">,</span>
				       <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">,</span>
				       <span class="n">length</span> <span class="o">+</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>
	<span class="cm">/* save the skb in buffer_info as good */</span>
	<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_clean_rx_irq - Send received data up the network stack,</span>
<span class="cm"> * @adapter: board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">ixgb_clean_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">work_done</span><span class="p">,</span> <span class="kt">int</span> <span class="n">work_to_do</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">,</span> <span class="o">*</span><span class="n">next_rxd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">,</span> <span class="o">*</span><span class="n">next_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">next2_buffer</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cleaned_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cleaned</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span><span class="p">;</span>
	<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">IXGB_RX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IXGB_RX_DESC_STATUS_DD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">work_done</span> <span class="o">&gt;=</span> <span class="n">work_to_do</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">work_done</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rmb</span><span class="p">();</span>	<span class="cm">/* read descriptor and rx_buffer_info after status DD */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">prefetch</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">next_rxd</span> <span class="o">=</span> <span class="n">IXGB_RX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">next_rxd</span><span class="p">);</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">next2_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">prefetch</span><span class="p">(</span><span class="n">next2_buffer</span><span class="p">);</span>

		<span class="n">next_buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">cleaned</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">cleaned_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
				 <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IXGB_RX_DESC_STATUS_EOP</span><span class="p">)))</span> <span class="p">{</span>

			<span class="cm">/* All receives must fit into a single buffer */</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Receive packet consumed multiple buffers length&lt;%x&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">length</span><span class="p">);</span>

			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rxdesc_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">IXGB_RX_DESC_ERRORS_CE</span> <span class="o">|</span> <span class="n">IXGB_RX_DESC_ERRORS_SE</span> <span class="o">|</span>
		     <span class="n">IXGB_RX_DESC_ERRORS_P</span> <span class="o">|</span> <span class="n">IXGB_RX_DESC_ERRORS_RXE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rxdesc_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ixgb_check_copybreak</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">buffer_info</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skb</span><span class="p">);</span>

		<span class="cm">/* Good Receive */</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

		<span class="cm">/* Receive Checksum Offload */</span>
		<span class="n">ixgb_rx_checksum</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_desc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IXGB_RX_DESC_STATUS_VP</span><span class="p">)</span>
			<span class="n">__vlan_hwaccel_put_tag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">));</span>

		<span class="n">netif_receive_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="nl">rxdesc_done:</span>
		<span class="cm">/* clean up descriptor, might be written over by hw */</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* return some buffers to hardware, one at a time is too slow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cleaned_count</span> <span class="o">&gt;=</span> <span class="n">IXGB_RX_BUFFER_WRITE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ixgb_alloc_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cleaned_count</span><span class="p">);</span>
			<span class="n">cleaned_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* use prefetched values */</span>
		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">next_rxd</span><span class="p">;</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="n">next_buffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_clean</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cleaned_count</span> <span class="o">=</span> <span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cleaned_count</span><span class="p">)</span>
		<span class="n">ixgb_alloc_rx_buffers</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cleaned_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cleaned</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_alloc_rx_buffers - Replace used receive buffers</span>
<span class="cm"> * @adapter: address of board private structure</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_alloc_rx_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cleaned_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_desc_ring</span> <span class="o">*</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_rx_desc</span> <span class="o">*</span><span class="n">rx_desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ixgb_buffer</span> <span class="o">*</span><span class="n">buffer_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">cleancount</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span><span class="p">;</span>
	<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">cleancount</span> <span class="o">=</span> <span class="n">IXGB_DESC_UNUSED</span><span class="p">(</span><span class="n">rx_ring</span><span class="p">);</span>


	<span class="cm">/* leave three descriptors unused */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cleancount</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">cleaned_count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* recycle! its good for you */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">map_skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">netdev_alloc_skb_ip_align</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Better luck next round */</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">alloc_rx_buff_failed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">;</span>
<span class="nl">map_skb:</span>
		<span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		                                  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		                                  <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_buffer_len</span><span class="p">,</span>
						  <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="n">rx_desc</span> <span class="o">=</span> <span class="n">IXGB_RX_DESC</span><span class="p">(</span><span class="o">*</span><span class="n">rx_ring</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">buff_addr</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">buffer_info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="cm">/* guarantee DD bit not set now before h/w gets descriptor</span>
<span class="cm">		 * this is the rest of the workaround for h/w double</span>
<span class="cm">		 * writeback. */</span>
		<span class="n">rx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">buffer_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">!=</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">next_to_use</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Force memory writes to complete before letting h/w</span>
<span class="cm">		 * know there are new descriptors to fetch.  (Only</span>
<span class="cm">		 * applicable for weak-ordered memory model archs, such</span>
<span class="cm">		 * as IA-64). */</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">RDT</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_vlan_strip_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* enable VLAN tag insert/strip */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">IXGB_CTRL0_VME</span><span class="p">;</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_vlan_strip_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* disable VLAN tag insert/strip */</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGB_READ_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGB_CTRL0_VME</span><span class="p">;</span>
	<span class="n">IXGB_WRITE_REG</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">CTRL0</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_vlan_rx_add_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">vfta</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* add VID to filter table */</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">vfta</span> <span class="o">=</span> <span class="n">IXGB_READ_REG_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">VFTA</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">vfta</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">));</span>
	<span class="n">ixgb_write_vfta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vfta</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ixgb_vlan_rx_kill_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">vid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">vfta</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* remove VID from filter table */</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">vfta</span> <span class="o">=</span> <span class="n">IXGB_READ_REG_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">VFTA</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">vfta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vid</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">));</span>
	<span class="n">ixgb_write_vfta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vfta</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ixgb_restore_vlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vid</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_vlans</span><span class="p">,</span> <span class="n">VLAN_N_VID</span><span class="p">)</span>
		<span class="n">ixgb_vlan_rx_add_vid</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">vid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="cm">/*</span>
<span class="cm"> * Polling &#39;interrupt&#39; - used by things like netconsole to send skbs</span>
<span class="cm"> * without having to re-enable interrupts. It&#39;s not called while</span>
<span class="cm"> * the interrupt routine is executing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgb_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">ixgb_intr</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_io_error_detected() - called when PCI error is detected</span>
<span class="cm"> * @pdev    pointer to pci device with error</span>
<span class="cm"> * @state   pci channel state after error</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called by the PCI subsystem whenever</span>
<span class="cm"> * a PCI bus error is detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">ixgb_io_error_detected</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
                                               <span class="k">enum</span> <span class="n">pci_channel_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">pci_channel_io_perm_failure</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">ixgb_down</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Request a slot reset. */</span>
	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_NEED_RESET</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_io_slot_reset - called after the pci bus has been reset.</span>
<span class="cm"> * @pdev    pointer to pci device with error</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is called after the PCI bus has been reset.</span>
<span class="cm"> * Basically, this tries to restart the card from scratch.</span>
<span class="cm"> * This is a shortened version of the device probe/discovery code,</span>
<span class="cm"> * it resembles the first-half of the ixgb_probe() routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">pci_ers_result_t</span> <span class="nf">ixgb_io_slot_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;Cannot re-enable PCI device after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Perform card reset only on one instance of the card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">PCI_FUNC</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">ixgb_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Make sure the EEPROM is good */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgb_validate_eeprom_checksum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;After reset, the EEPROM checksum is not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ixgb_get_ee_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_err</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">probe</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="s">&quot;After reset, invalid MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PCI_ERS_RESULT_DISCONNECT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCI_ERS_RESULT_RECOVERED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgb_io_resume - called when its OK to resume normal operations</span>
<span class="cm"> * @pdev    pointer to pci device with error</span>
<span class="cm"> *</span>
<span class="cm"> * The error recovery driver tells us that its OK to resume</span>
<span class="cm"> * normal operation. Implementation resembles the second-half</span>
<span class="cm"> * of the ixgb_probe() routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgb_io_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ixgb_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgb_up</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t bring device back up after reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">watchdog_timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ixgb_main.c */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
