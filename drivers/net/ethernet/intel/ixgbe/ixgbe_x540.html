<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgbe › ixgbe_x540.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ixgbe_x540.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel 10 Gigabit PCI Express Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &quot;ixgbe.h&quot;</span>
<span class="cp">#include &quot;ixgbe_phy.h&quot;</span>

<span class="cp">#define IXGBE_X540_MAX_TX_QUEUES 128</span>
<span class="cp">#define IXGBE_X540_MAX_RX_QUEUES 128</span>
<span class="cp">#define IXGBE_X540_RAR_ENTRIES   128</span>
<span class="cp">#define IXGBE_X540_MC_TBL_SIZE   128</span>
<span class="cp">#define IXGBE_X540_VFT_TBL_SIZE  128</span>
<span class="cp">#define IXGBE_X540_RX_PB_SIZE	 384</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">ixgbe_update_flash_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">ixgbe_poll_flash_update_done_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">ixgbe_acquire_swfw_sync_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_release_swfw_sync_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">ixgbe_get_swfw_sync_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ixgbe_release_swfw_sync_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ixgbe_media_type</span> <span class="nf">ixgbe_get_media_type_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ixgbe_media_type_copper</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_get_invariants_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_mac_info</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">;</span>

	<span class="cm">/* Call PHY identify routine to get the phy type */</span>
	<span class="n">ixgbe_identify_phy_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mcft_size</span> <span class="o">=</span> <span class="n">IXGBE_X540_MC_TBL_SIZE</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vft_size</span> <span class="o">=</span> <span class="n">IXGBE_X540_VFT_TBL_SIZE</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">num_rar_entries</span> <span class="o">=</span> <span class="n">IXGBE_X540_RAR_ENTRIES</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_rx_queues</span> <span class="o">=</span> <span class="n">IXGBE_X540_MAX_RX_QUEUES</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_tx_queues</span> <span class="o">=</span> <span class="n">IXGBE_X540_MAX_TX_QUEUES</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">max_msix_vectors</span> <span class="o">=</span> <span class="n">ixgbe_get_pcie_msix_count_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_setup_mac_link_X540 - Set the auto advertised capabilitires</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @speed: new link speed</span>
<span class="cm"> *  @autoneg: true if autonegotiation enabled</span>
<span class="cm"> *  @autoneg_wait_to_complete: true when waiting for completion is needed</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_setup_mac_link_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
                                     <span class="n">ixgbe_link_speed</span> <span class="n">speed</span><span class="p">,</span> <span class="n">bool</span> <span class="n">autoneg</span><span class="p">,</span>
                                     <span class="n">bool</span> <span class="n">autoneg_wait_to_complete</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_link_speed</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">,</span>
	                                    <span class="n">autoneg_wait_to_complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_reset_hw_X540 - Perform hardware reset</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Resets the hardware by resetting the transmit and receive units, masks</span>
<span class="cm"> *  and clears all interrupts, perform a PHY reset, and perform a link (MAC)</span>
<span class="cm"> *  reset.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_reset_hw_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Call adapter stop to disable tx/rx and clear interrupts */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">stop_adapter</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">reset_hw_out</span><span class="p">;</span>

	<span class="cm">/* flush pending Tx transactions */</span>
	<span class="n">ixgbe_clear_tx_pending</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="nl">mac_reset_top:</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGBE_CTRL_RST</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Poll for reset bit to self-clear indicating reset is complete */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">IXGBE_CTRL_RST_MASK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">IXGBE_CTRL_RST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_RESET_FAILED</span><span class="p">;</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Reset polling failed to complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Double resets are required for recovery from certain error</span>
<span class="cm">	 * conditions.  Between resets, it is necessary to stall to allow time</span>
<span class="cm">	 * for any pending HW events to complete.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IXGBE_FLAGS_DOUBLE_RESET_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_FLAGS_DOUBLE_RESET_REQUIRED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">mac_reset_top</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the Rx packet buffer size. */</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_RXPBSIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">384</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_RXPBSIZE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Store the permanent mac address */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">perm_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store MAC address from RAR0, clear receive address registers, and</span>
<span class="cm">	 * clear the multicast table.  Also reset num_rar_entries to 128,</span>
<span class="cm">	 * since we modify this value when programming the SAN MAC address.</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">num_rar_entries</span> <span class="o">=</span> <span class="n">IXGBE_X540_MAX_TX_QUEUES</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">init_rx_addrs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Store the permanent SAN mac address */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_san_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">san_addr</span><span class="p">);</span>

	<span class="cm">/* Add the SAN MAC address to the RAR only if it&#39;s a valid address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_validate_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">san_addr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rar</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">num_rar_entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		                    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">san_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IXGBE_RAH_AV</span><span class="p">);</span>

		<span class="cm">/* Reserve the last RAR for the SAN MAC address */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">num_rar_entries</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Store the alternative WWNN/WWPN prefix */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_wwn_prefix</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">wwnn_prefix</span><span class="p">,</span>
	                           <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">wwpn_prefix</span><span class="p">);</span>

<span class="nl">reset_hw_out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_start_hw_X540 - Prepare hardware for Tx/Rx</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Starts the hardware using the generic start_hw function</span>
<span class="cm"> *  and the generation start_hw function.</span>
<span class="cm"> *  Then performs revision-specific operations, if any.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_start_hw_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">ixgbe_start_hw_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">ixgbe_start_hw_gen2</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">rx_pb_size</span> <span class="o">=</span> <span class="n">IXGBE_X540_RX_PB_SIZE</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_get_supported_physical_layer_X540 - Returns physical layer type</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Determines physical layer capabilities of the current configuration.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ixgbe_get_supported_physical_layer_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">physical_layer</span> <span class="o">=</span> <span class="n">IXGBE_PHYSICAL_LAYER_UNKNOWN</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ext_ability</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">identify</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read_reg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MDIO_PMA_EXTABLE</span><span class="p">,</span> <span class="n">MDIO_MMD_PMAPMD</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">ext_ability</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_ability</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_EXTABLE_10GBT</span><span class="p">)</span>
		<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_10GBASE_T</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_ability</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_EXTABLE_1000BT</span><span class="p">)</span>
		<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_1000BASE_T</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ext_ability</span> <span class="o">&amp;</span> <span class="n">MDIO_PMA_EXTABLE_100BTX</span><span class="p">)</span>
		<span class="n">physical_layer</span> <span class="o">|=</span> <span class="n">IXGBE_PHYSICAL_LAYER_100BASE_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">physical_layer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_init_eeprom_params_X540 - Initialize EEPROM params</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Initializes the EEPROM parameters ixgbe_eeprom_info within the</span>
<span class="cm"> *  ixgbe_hw struct in order to set up EEPROM access.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_init_eeprom_params_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ixgbe_eeprom_info</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eec</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ixgbe_eeprom_uninitialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">semaphore_delay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ixgbe_flash</span><span class="p">;</span>

		<span class="n">eec</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">);</span>
		<span class="n">eeprom_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)((</span><span class="n">eec</span> <span class="o">&amp;</span> <span class="n">IXGBE_EEC_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		                    <span class="n">IXGBE_EEC_SIZE_SHIFT</span><span class="p">);</span>
		<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">eeprom_size</span> <span class="o">+</span>
		                          <span class="n">IXGBE_EEPROM_WORD_SIZE_SHIFT</span><span class="p">);</span>

		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Eeprom params: type = %d, size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">word_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_read_eerd_X540- Read EEPROM word using EERD</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @offset: offset of  word in the EEPROM to read</span>
<span class="cm"> *  @data: word read from the EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads a 16 bit word from the EEPROM using the EERD register.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_read_eerd_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span> <span class="o">==</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_read_eerd_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_read_eerd_buffer_X540 - Read EEPROM word(s) using EERD</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @offset: offset of  word in the EEPROM to read</span>
<span class="cm"> *  @words: number of words</span>
<span class="cm"> *  @data: word(s) read from the EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> *  Reads a 16 bit word(s) from the EEPROM using the EERD register.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_read_eerd_buffer_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">words</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span> <span class="o">==</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_read_eerd_buffer_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							<span class="n">words</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_write_eewr_X540 - Write EEPROM word using EEWR</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @offset: offset of  word in the EEPROM to write</span>
<span class="cm"> *  @data: word write to the EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> *  Write a 16 bit word to the EEPROM using the EEWR register.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_write_eewr_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_write_eewr_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_write_eewr_buffer_X540 - Write EEPROM word(s) using EEWR</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @offset: offset of  word in the EEPROM to write</span>
<span class="cm"> *  @words: number of words</span>
<span class="cm"> *  @data: word(s) write to the EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> *  Write a 16 bit word(s) to the EEPROM using the EEWR register.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_write_eewr_buffer_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">words</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span> <span class="o">==</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_write_eewr_buffer_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							 <span class="n">words</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_calc_eeprom_checksum_X540 - Calculates and returns the checksum</span>
<span class="cm"> *</span>
<span class="cm"> *  This function does not use synchronization for EERD and EEWR. It can</span>
<span class="cm"> *  be used internally by function which utilize ixgbe_acquire_swfw_sync_X540.</span>
<span class="cm"> *</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">ixgbe_calc_eeprom_checksum_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not use hw-&gt;eeprom.ops.read because we do not want to take</span>
<span class="cm">	 * the synchronization semaphores here. Instead use</span>
<span class="cm">	 * ixgbe_read_eerd_generic</span>
<span class="cm">	 */</span>

	<span class="cm">/* Include 0x0-0x3F in the checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_EEPROM_CHECKSUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_read_eerd_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">word</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Include all data from pointers 0x3, 0x6-0xE.  This excludes the</span>
<span class="cm">	 * FW, PHY module, and PCIe Expansion/Option ROM pointers.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">IXGBE_PCIE_ANALOG_PTR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_FW_PTR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IXGBE_PHY_PTR</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">IXGBE_OPTION_ROM_PTR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_read_eerd_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pointer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Skip pointer section if the pointer is invalid. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pointer</span> <span class="o">==</span> <span class="mh">0xFFFF</span> <span class="o">||</span> <span class="n">pointer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">pointer</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">word_size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_read_eerd_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Skip pointer section if length is invalid. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mh">0xFFFF</span> <span class="o">||</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">pointer</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">word_size</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">pointer</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">pointer</span><span class="o">+</span><span class="n">length</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_read_eerd_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">checksum</span> <span class="o">+=</span> <span class="n">word</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">IXGBE_EEPROM_SUM</span> <span class="o">-</span> <span class="n">checksum</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">checksum</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  ixgbe_validate_eeprom_checksum_X540 - Validate EEPROM checksum</span>
<span class="cm"> *  @hw: pointer to hardware structure</span>
<span class="cm"> *  @checksum_val: calculated checksum</span>
<span class="cm"> *</span>
<span class="cm"> *  Performs checksum calculation and validates the EEPROM checksum.  If the</span>
<span class="cm"> *  caller does not need checksum_val, the value can be NULL.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_validate_eeprom_checksum_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">u16</span> <span class="o">*</span><span class="n">checksum_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">read_checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the first word from the EEPROM. If this times out or fails, do</span>
<span class="cm">	 * not continue or we could be in for a very long wait while every</span>
<span class="cm">	 * EEPROM read fails</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">checksum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">calc_checksum</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Do not use hw-&gt;eeprom.ops.read because we do not want to take</span>
<span class="cm">		 * the synchronization semaphores twice here.</span>
<span class="cm">		 */</span>
		<span class="n">ixgbe_read_eerd_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEPROM_CHECKSUM</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">read_checksum</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Verify read checksum from EEPROM is the same as</span>
<span class="cm">		 * calculated checksum</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_checksum</span> <span class="o">!=</span> <span class="n">checksum</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_EEPROM_CHECKSUM</span><span class="p">;</span>

		<span class="cm">/* If the user cares, return the calculated checksum */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">checksum_val</span><span class="p">)</span>
			<span class="o">*</span><span class="n">checksum_val</span> <span class="o">=</span> <span class="n">checksum</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_update_eeprom_checksum_X540 - Updates the EEPROM checksum and flash</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> * After writing EEPROM to shadow RAM using EEWR register, software calculates</span>
<span class="cm"> * checksum and updates the EEPROM and instructs the hardware to update</span>
<span class="cm"> * the flash.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_update_eeprom_checksum_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">checksum</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the first word from the EEPROM. If this times out or fails, do</span>
<span class="cm">	 * not continue or we could be in for a very long wait while every</span>
<span class="cm">	 * EEPROM read fails</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">checksum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;EEPROM read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">acquire_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">calc_checksum</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Do not use hw-&gt;eeprom.ops.write because we do not want to</span>
<span class="cm">		 * take the synchronization semaphores twice here.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_write_eewr_generic</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEPROM_CHECKSUM</span><span class="p">,</span>
						  <span class="n">checksum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_update_flash_X540</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">release_swfw_sync</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_update_flash_X540 - Instruct HW to copy EEPROM to Flash device</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> * Set FLUP (bit 23) of the EEC register to instruct Hardware to copy</span>
<span class="cm"> * EEPROM from shadow RAM to the flash device.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_update_flash_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flup</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_EEPROM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_poll_flash_update_done_X540</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">IXGBE_ERR_EEPROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Flash update time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flup</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">)</span> <span class="o">|</span> <span class="n">IXGBE_EEC_FLUP</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">,</span> <span class="n">flup</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_poll_flash_update_done_X540</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Flash update complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Flash update time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">revision_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flup</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flup</span> <span class="o">&amp;</span> <span class="n">IXGBE_EEC_SEC1VAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flup</span> <span class="o">|=</span> <span class="n">IXGBE_EEC_FLUP</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">,</span> <span class="n">flup</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ixgbe_poll_flash_update_done_X540</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Flash update complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Flash update time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_poll_flash_update_done_X540 - Poll flash update status</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> * Polls the FLUDONE (bit 26) of the EEC Register to determine when the</span>
<span class="cm"> * flash update is done.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_poll_flash_update_done_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_EEPROM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_FLUDONE_ATTEMPTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_EEC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">IXGBE_EEC_FLUDONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_acquire_swfw_sync_X540 - Acquire SWFW semaphore</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> * @mask: Mask to specify which semaphore to acquire</span>
<span class="cm"> *</span>
<span class="cm"> * Acquires the SWFW semaphore thought the SW_FW_SYNC register for</span>
<span class="cm"> * the specified function (CSR, PHY0, PHY1, NVM, Flash)</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_acquire_swfw_sync_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">swfw_sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fwmask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hwmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swmask</span> <span class="o">==</span> <span class="n">IXGBE_GSSR_EEP_SM</span><span class="p">)</span>
		<span class="n">hwmask</span> <span class="o">=</span> <span class="n">IXGBE_GSSR_FLASH_SM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * SW NVM semaphore bit is used for access to all</span>
<span class="cm">		 * SW_FW_SYNC bits (not just NVM)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_get_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>

		<span class="n">swfw_sync</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">swfw_sync</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fwmask</span> <span class="o">|</span> <span class="n">swmask</span> <span class="o">|</span> <span class="n">hwmask</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">swfw_sync</span> <span class="o">|=</span> <span class="n">swmask</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">,</span> <span class="n">swfw_sync</span><span class="p">);</span>
			<span class="n">ixgbe_release_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Firmware currently using resource (fwmask),</span>
<span class="cm">			 * hardware currently using resource (hwmask),</span>
<span class="cm">			 * or other software thread currently using</span>
<span class="cm">			 * resource (swmask)</span>
<span class="cm">			 */</span>
			<span class="n">ixgbe_release_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the resource is not released by the FW/HW the SW can assume that</span>
<span class="cm">	 * the FW/HW malfunctions. In that case the SW should sets the</span>
<span class="cm">	 * SW bit(s) of the requested resource(s) while ignoring the</span>
<span class="cm">	 * corresponding FW/HW bits in the SW_FW_SYNC register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swfw_sync</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">swfw_sync</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fwmask</span> <span class="o">|</span> <span class="n">hwmask</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ixgbe_get_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">IXGBE_ERR_SWFW_SYNC</span><span class="p">;</span>

			<span class="n">swfw_sync</span> <span class="o">|=</span> <span class="n">swmask</span><span class="p">;</span>
			<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">,</span> <span class="n">swfw_sync</span><span class="p">);</span>
			<span class="n">ixgbe_release_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_release_swfw_sync_X540 - Release SWFW semaphore</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> * @mask: Mask to specify which semaphore to release</span>
<span class="cm"> *</span>
<span class="cm"> * Releases the SWFW semaphore through the SW_FW_SYNC register</span>
<span class="cm"> * for the specified function (CSR, PHY0, PHY1, EVM, Flash)</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_release_swfw_sync_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">swfw_sync</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">ixgbe_get_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">swfw_sync</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">);</span>
	<span class="n">swfw_sync</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">swmask</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">,</span> <span class="n">swfw_sync</span><span class="p">);</span>

	<span class="n">ixgbe_release_swfw_sync_semaphore</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_get_nvm_semaphore - Get hardware semaphore</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the hardware semaphores so SW/FW can gain control of shared resources</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_get_swfw_sync_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IXGBE_ERR_EEPROM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swsm</span><span class="p">;</span>

	<span class="cm">/* Get SMBI software semaphore between device drivers first */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the SMBI bit is 0 when we read it, then the bit will be</span>
<span class="cm">		 * set and we have the semaphore</span>
<span class="cm">		 */</span>
		<span class="n">swsm</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWSM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">swsm</span> <span class="o">&amp;</span> <span class="n">IXGBE_SWSM_SMBI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now get the semaphore between SW/FW through the REGSMP bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">swsm</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">swsm</span> <span class="o">&amp;</span> <span class="n">IXGBE_SWFW_REGSMP</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_dbg</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="s">&quot;Software semaphore SMBI between device drivers &quot;</span>
		           <span class="s">&quot;not granted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_release_nvm_semaphore - Release hardware semaphore</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function clears hardware semaphore bits.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_release_swfw_sync_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	 <span class="n">u32</span> <span class="n">swsm</span><span class="p">;</span>

	<span class="cm">/* Release both semaphores by writing 0 to the bits REGSMP and SMBI */</span>

	<span class="n">swsm</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWSM</span><span class="p">);</span>
	<span class="n">swsm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_SWSM_SMBI</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWSM</span><span class="p">,</span> <span class="n">swsm</span><span class="p">);</span>

	<span class="n">swsm</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">);</span>
	<span class="n">swsm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_SWFW_REGSMP</span><span class="p">;</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_SWFW_SYNC</span><span class="p">,</span> <span class="n">swsm</span><span class="p">);</span>

	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_blink_led_start_X540 - Blink LED based on index.</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> * @index: led number to blink</span>
<span class="cm"> *</span>
<span class="cm"> * Devices that implement the version 2 interface:</span>
<span class="cm"> *   X540</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_blink_led_start_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macc_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ledctl_reg</span><span class="p">;</span>
	<span class="n">ixgbe_link_speed</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">link_up</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Link should be up in order for the blink bit in the LED control</span>
<span class="cm">	 * register to work. Force link and speed in the MAC if link is down.</span>
<span class="cm">	 * This will be reversed when we stop the blinking.</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">check_link</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_up</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">macc_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MACC</span><span class="p">);</span>
		<span class="n">macc_reg</span> <span class="o">|=</span> <span class="n">IXGBE_MACC_FLU</span> <span class="o">|</span> <span class="n">IXGBE_MACC_FSV_10G</span> <span class="o">|</span> <span class="n">IXGBE_MACC_FS</span><span class="p">;</span>
		<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MACC</span><span class="p">,</span> <span class="n">macc_reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Set the LED to LINK_UP + BLINK. */</span>
	<span class="n">ledctl_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LEDCTL</span><span class="p">);</span>
	<span class="n">ledctl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_LED_MODE_MASK</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">ledctl_reg</span> <span class="o">|=</span> <span class="n">IXGBE_LED_BLINK</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LEDCTL</span><span class="p">,</span> <span class="n">ledctl_reg</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ixgbe_blink_led_stop_X540 - Stop blinking LED based on index.</span>
<span class="cm"> * @hw: pointer to hardware structure</span>
<span class="cm"> * @index: led number to stop blinking</span>
<span class="cm"> *</span>
<span class="cm"> * Devices that implement the version 2 interface:</span>
<span class="cm"> *   X540</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">ixgbe_blink_led_stop_X540</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macc_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ledctl_reg</span><span class="p">;</span>

	<span class="cm">/* Restore the LED to its default value. */</span>
	<span class="n">ledctl_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LEDCTL</span><span class="p">);</span>
	<span class="n">ledctl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_LED_MODE_MASK</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">ledctl_reg</span> <span class="o">|=</span> <span class="n">IXGBE_LED_LINK_ACTIVE</span> <span class="o">&lt;&lt;</span> <span class="n">IXGBE_LED_MODE_SHIFT</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">ledctl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IXGBE_LED_BLINK</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_LEDCTL</span><span class="p">,</span> <span class="n">ledctl_reg</span><span class="p">);</span>

	<span class="cm">/* Unforce link and speed in the MAC. */</span>
	<span class="n">macc_reg</span> <span class="o">=</span> <span class="n">IXGBE_READ_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MACC</span><span class="p">);</span>
	<span class="n">macc_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXGBE_MACC_FLU</span> <span class="o">|</span> <span class="n">IXGBE_MACC_FSV_10G</span> <span class="o">|</span> <span class="n">IXGBE_MACC_FS</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_REG</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IXGBE_MACC</span><span class="p">,</span> <span class="n">macc_reg</span><span class="p">);</span>
	<span class="n">IXGBE_WRITE_FLUSH</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ixgbe_mac_operations</span> <span class="n">mac_ops_X540</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_hw</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_hw_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_hw</span>               <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_reset_hw_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_hw</span>               <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_start_hw_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_hw_cntrs</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_hw_cntrs_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_media_type</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_media_type_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_supported_physical_layer</span> <span class="o">=</span>
                                  <span class="o">&amp;</span><span class="n">ixgbe_get_supported_physical_layer_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_rx_dma</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_enable_rx_dma_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mac_addr</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_mac_addr_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_san_mac_addr</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_san_mac_addr_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_device_caps</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_device_caps_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wwn_prefix</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_wwn_prefix_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_adapter</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_stop_adapter_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bus_info</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_bus_info_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_lan_id</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_lan_id_multi_port_pcie</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_analog_reg8</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_analog_reg8</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_mac_link_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rxpba</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_rxpba_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_check_mac_link_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link_capabilities</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_copper_link_capabilities_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">led_on</span>                 <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_led_on_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">led_off</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_led_off_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blink_led_start</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_blink_led_start_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">blink_led_stop</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_blink_led_stop_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rar</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_rar_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_rar</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_rar_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_vmdq</span>               <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_vmdq_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_vmdq</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_vmdq_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_rx_addrs</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_rx_addrs_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_mc_addr_list</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_update_mc_addr_list_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_mc</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_enable_mc_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_mc</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_disable_mc_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clear_vfta</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_clear_vfta_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_vfta</span>               <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_vfta_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fc_enable</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_fc_enable_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fw_drv_ver</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_fw_drv_ver_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_uta_tables</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_uta_tables_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_sfp</span>              <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mac_anti_spoofing</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_mac_anti_spoofing</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_vlan_anti_spoofing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_set_vlan_anti_spoofing</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acquire_swfw_sync</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_acquire_swfw_sync_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release_swfw_sync</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_release_swfw_sync_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_rx_buff</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_disable_rx_buff_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_rx_buff</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_enable_rx_buff_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_thermal_sensor_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_thermal_sensor_thresh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ixgbe_eeprom_operations</span> <span class="n">eeprom_ops_X540</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init_params</span>            <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_init_eeprom_params_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>                   <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_eerd_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_buffer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_eerd_buffer_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>                  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_eewr_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_buffer</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_eewr_buffer_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calc_checksum</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_calc_eeprom_checksum_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">validate_checksum</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_validate_eeprom_checksum_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_checksum</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_update_eeprom_checksum_X540</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ixgbe_phy_operations</span> <span class="n">phy_ops_X540</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">identify</span>               <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_identify_phy_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">identify_sfp</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_identify_sfp_module_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>                  <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_reg</span>               <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_phy_reg_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_reg</span>              <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_phy_reg_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_phy_link_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_link_speed</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_setup_phy_link_speed_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_i2c_byte</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_i2c_byte_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_i2c_byte</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_i2c_byte_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_i2c_eeprom</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_read_i2c_eeprom_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_i2c_eeprom</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_write_i2c_eeprom_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_overtemp</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_tn_check_overtemp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_firmware_version</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_phy_firmware_version_generic</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ixgbe_info</span> <span class="n">ixgbe_X540_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mac</span>                    <span class="o">=</span> <span class="n">ixgbe_mac_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_invariants</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">ixgbe_get_invariants_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mac_ops</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac_ops_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eeprom_ops</span>             <span class="o">=</span> <span class="o">&amp;</span><span class="n">eeprom_ops_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_ops</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy_ops_X540</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mbx_ops</span>                <span class="o">=</span> <span class="o">&amp;</span><span class="n">mbx_ops_generic</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
