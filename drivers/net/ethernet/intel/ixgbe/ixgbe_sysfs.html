<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › ethernet › intel › ixgbe › ixgbe_sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ixgbe_sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>

<span class="cm">  Intel 10 Gigabit PCI Express Linux driver</span>
<span class="cm">  Copyright(c) 1999 - 2012 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify it</span>
<span class="cm">  under the terms and conditions of the GNU General Public License,</span>
<span class="cm">  version 2, as published by the Free Software Foundation.</span>

<span class="cm">  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm">  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm">  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm">  more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License along with</span>
<span class="cm">  this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">  51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>

<span class="cm">  The full GNU General Public License is included in this distribution in</span>
<span class="cm">  the file called &quot;COPYING&quot;.</span>

<span class="cm">  Contact Information:</span>
<span class="cm">  e1000-devel Mailing List &lt;e1000-devel@lists.sourceforge.net&gt;</span>
<span class="cm">  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &quot;ixgbe.h&quot;</span>
<span class="cp">#include &quot;ixgbe_common.h&quot;</span>
<span class="cp">#include &quot;ixgbe_type.h&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>

<span class="cp">#ifdef CONFIG_IXGBE_HWMON</span>
<span class="cm">/* hwmon callback functions */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ixgbe_hwmon_show_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwmon_attr</span> <span class="o">*</span><span class="n">ixgbe_attr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwmon_attr</span><span class="p">,</span>
						     <span class="n">dev_attr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;loc%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">location</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ixgbe_hwmon_show_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwmon_attr</span> <span class="o">*</span><span class="n">ixgbe_attr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwmon_attr</span><span class="p">,</span>
						     <span class="n">dev_attr</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/* reset the temp field */</span>
	<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">get_thermal_sensor_data</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* display millidegree */</span>
	<span class="n">value</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ixgbe_hwmon_show_cautionthresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwmon_attr</span> <span class="o">*</span><span class="n">ixgbe_attr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwmon_attr</span><span class="p">,</span>
						     <span class="n">dev_attr</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">caution_thresh</span><span class="p">;</span>

	<span class="cm">/* display millidegree */</span>
	<span class="n">value</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ixgbe_hwmon_show_maxopthresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwmon_attr</span> <span class="o">*</span><span class="n">ixgbe_attr</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hwmon_attr</span><span class="p">,</span>
						     <span class="n">dev_attr</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">max_op_thresh</span><span class="p">;</span>

	<span class="cm">/* display millidegree */</span>
	<span class="n">value</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ixgbe_add_hwmon_attr - Create hwmon attr table for a hwmon sysfs file.</span>
<span class="cm"> * @ adapter: pointer to the adapter structure</span>
<span class="cm"> * @ offset: offset in the eeprom sensor data table</span>
<span class="cm"> * @ type: type of sensor data to display</span>
<span class="cm"> *</span>
<span class="cm"> * For each file we want in hwmon&#39;s sysfs interface we need a device_attribute</span>
<span class="cm"> * This is included in our hwmon_attr struct that contains the references to</span>
<span class="cm"> * the data structures we need to get the data to display.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ixgbe_add_hwmon_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hwmon_attr</span> <span class="o">*</span><span class="n">ixgbe_attr</span><span class="p">;</span>

	<span class="n">n_attr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">n_hwmon</span><span class="p">;</span>
	<span class="n">ixgbe_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">hwmon_list</span><span class="p">[</span><span class="n">n_attr</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IXGBE_HWMON_TYPE_LOC</span>:
		<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ixgbe_hwmon_show_location</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;temp%u_label&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_HWMON_TYPE_TEMP</span>:
		<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ixgbe_hwmon_show_temp</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;temp%u_input&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_HWMON_TYPE_CAUTION</span>:
		<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ixgbe_hwmon_show_cautionthresh</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;temp%u_max&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IXGBE_HWMON_TYPE_MAX</span>:
		<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ixgbe_hwmon_show_maxopthresh</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;temp%u_crit&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* These always the same regardless of type */</span>
	<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">thermal_sensor_data</span><span class="p">.</span><span class="n">sensor</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
	<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
	<span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ixgbe_attr</span><span class="o">-&gt;</span><span class="n">dev_attr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">++</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">n_hwmon</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ixgbe_sysfs_del_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">n_hwmon</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">hwmon_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">hwmon_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
		<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">.</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called from ixgbe_main.c */</span>
<span class="kt">void</span> <span class="nf">ixgbe_sysfs_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ixgbe_sysfs_del_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called from ixgbe_main.c */</span>
<span class="kt">int</span> <span class="nf">ixgbe_sysfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ixgbe_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hwmon_buff</span> <span class="o">*</span><span class="n">ixgbe_hwmon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ixgbe_hwmon_buff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If this method isn&#39;t defined we don&#39;t support thermals */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">init_thermal_sensor_thresh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t create thermal hwmon interface if no sensors present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">init_thermal_sensor_thresh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocation space for max attributs</span>
<span class="cm">	 * max num sensors * values (loc, temp, max, caution)</span>
<span class="cm">	 */</span>
	<span class="n">n_attrs</span> <span class="o">=</span> <span class="n">IXGBE_MAX_SENSORS</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ixgbe_hwmon</span><span class="o">-&gt;</span><span class="n">hwmon_list</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">n_attrs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwmon_attr</span><span class="p">),</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ixgbe_hwmon</span><span class="o">-&gt;</span><span class="n">hwmon_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ixgbe_hwmon</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ixgbe_hwmon</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ixgbe_hwmon</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IXGBE_MAX_SENSORS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Only create hwmon sysfs entries for sensors that have</span>
<span class="cm">		 * meaningful data for.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">thermal_sensor_data</span><span class="p">.</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Bail if any hwmon attr struct fails to initialize */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ixgbe_add_hwmon_attr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">IXGBE_HWMON_TYPE_CAUTION</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">ixgbe_add_hwmon_attr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">IXGBE_HWMON_TYPE_LOC</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">ixgbe_add_hwmon_attr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">IXGBE_HWMON_TYPE_TEMP</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">ixgbe_add_hwmon_attr</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">IXGBE_HWMON_TYPE_MAX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">ixgbe_sysfs_del_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IXGBE_HWMON */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
